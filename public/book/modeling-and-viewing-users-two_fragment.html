<!--
	Chapitre : 7 Modéliser et afficher les utilisateurs, partie II
	Fichier  : modeling-and-viewing-users-two_fragment.html
-->

<h1 class="title">Tutoriel Ruby on Rails </h1>


<h1 class="subtitle">  Apprendre Rails par l'exemple</h1>


<h2 class="author">Michael Hartl</h2>



<h1 class="contents">Contenu</h1>


<div id="table_of_contents"><ol>
<li class="chapter"><a href="beginning#top"><span class="number">Chapitre 1</span> De zéro au déploiement</a></li>
<li><ol>
<li class="section"><a href="beginning#sec:introduction"><span class="number">1.1</span> Introduction</a></li>
<li><ol>
<li class="subsection"><a href="beginning#sec:comments_for_various_readers"><span class="number">1.1.1</span> Commentaires pour les lecteurs différents</a></li>
<li class="subsection"><a href="beginning#sec:1.1.2"><span class="number">1.1.2</span> «&nbsp;Dimensionner&nbsp;» Rails</a></li>
<li class="subsection"><a href="beginning#sec:conventions"><span class="number">1.1.3</span> Conventions utilisées dans ce livre</a></li></ol></li>
<li class="section"><a href="beginning#sec:up_and_running"><span class="number">1.2</span> [(Up and running)(En route pour le démarrage)]</a></li>
<li><ol>
<li class="subsection"><a href="beginning#sec:development_tools"><span class="number">1.2.1</span> Environnements de développement</a></li>
<li><ol>
<li class="subsubsection"><a href="beginning#sec:1.2.1.1">IDEs</a></li>
<li class="subsubsection"><a href="beginning#sec:1.2.1.2">Éditeurs de texte et lignes de commande</a></li>
<li class="subsubsection"><a href="beginning#sec:1.2.1.3">Navigateurs</a></li>
<li class="subsubsection"><a href="beginning#sec:1.2.1.4">Note à propos des outils</a></li></ol></li>
<li class="subsection"><a href="beginning#sec:rubygems"><span class="number">1.2.2</span> Ruby, RubyGems, Rails, et Git</a></li>
<li><ol>
<li class="subsubsection"><a href="beginning#sec:rails_installer_windows">Installation de Rails (Windows)</a></li>
<li class="subsubsection"><a href="beginning#sec:install_git">Installer Git</a></li>
<li class="subsubsection"><a href="beginning#sec:install_ruby">Installer Ruby</a></li>
<li class="subsubsection"><a href="beginning#sec:install_rubygems">Installer RubyGems</a></li>
<li class="subsubsection"><a href="beginning#sec:install_rails">Installer Rails</a></li></ol></li>
<li class="subsection"><a href="beginning#sec:the_first_application"><span class="number">1.2.3</span> La première application</a></li>
<li class="subsection"><a href="beginning#sec:bundler"><span class="number">1.2.4</span> Bundler</a></li>
<li class="subsection"><a href="beginning#sec:rails_server"><span class="number">1.2.5</span> <code>Le serveur rails (rails server)</code></a></li>
<li class="subsection"><a href="beginning#sec:mvc"><span class="number">1.2.6</span> Modèles-Vue-Contrôleur (MVC)</a></li></ol></li>
<li class="section"><a href="beginning#sec:version_control"><span class="number">1.3</span> Contrôle de versions avec Git</a></li>
<li><ol>
<li class="subsection"><a href="beginning#sec:git_setup"><span class="number">1.3.1</span> Installation et réglages</a></li>
<li><ol>
<li class="subsubsection"><a href="beginning#sec:1.3.1.1">Initialisation des réglages système</a></li>
<li class="subsubsection"><a href="beginning#sec:1.3.1.2">Initialisation des réglages du dépôt (repository)</a></li></ol></li>
<li class="subsection"><a href="beginning#sec:adding_and_committing"><span class="number">1.3.2</span> Ajout et mandat de dépôt</a></li>
<li class="subsection"><a href="beginning#sec:1.3.3"><span class="number">1.3.3</span> Qu'est-ce que Git peut faire de bien pour vous&nbsp;?</a></li>
<li class="subsection"><a href="beginning#sec:github"><span class="number">1.3.4</span> GitHub</a></li>
<li class="subsection"><a href="beginning#sec:git_commands"><span class="number">1.3.5</span> Branch, edit, commit, merge</a></li>
<li><ol>
<li class="subsubsection"><a href="beginning#sec:git_branch">Branch</a></li>
<li class="subsubsection"><a href="beginning#sec:git_edit">Edit</a></li>
<li class="subsubsection"><a href="beginning#sec:git_commit">Commit</a></li>
<li class="subsubsection"><a href="beginning#sec:git_merge">Merge</a></li>
<li class="subsubsection"><a href="beginning#sec:git_push">Push</a></li></ol></li></ol></li>
<li class="section"><a href="beginning#sec:deploying"><span class="number">1.4</span> Déploiement</a></li>
<li><ol>
<li class="subsection"><a href="beginning#sec:1.4.1"><span class="number">1.4.1</span> Réglages Heroku</a></li>
<li class="subsection"><a href="beginning#sec:heroku_step_one"><span class="number">1.4.2</span> déploiement Heroku, première étape</a></li>
<li class="subsection"><a href="beginning#sec:1.4.3"><span class="number">1.4.3</span> Déploiement Heroku deployment, seconde étape</a></li>
<li class="subsection"><a href="beginning#sec:heroku_commands"><span class="number">1.4.4</span> Commandes Heroku</a></li></ol></li>
<li class="section"><a href="beginning#sec:beginning_conclusion"><span class="number">1.5</span> Conclusion</a></li></ol></li>
<li class="chapter"><a href="a-demo-app#top"><span class="number">Chapitre 2</span> Une application démo</a></li>
<li><ol>
<li class="section"><a href="a-demo-app#sec:planning_the_application"><span class="number">2.1</span> Planifier l'application</a></li>
<li><ol>
<li class="subsection"><a href="a-demo-app#sec:modeling_users"><span class="number">2.1.1</span> Modéliser les utilisateurs</a></li>
<li class="subsection"><a href="a-demo-app#sec:modeling_microposts"><span class="number">2.1.2</span> Modéliser les micro-messages</a></li></ol></li>
<li class="section"><a href="a-demo-app#sec:demo_users_resource"><span class="number">2.2</span> La ressource Utilisateurs (Users)</a></li>
<li><ol>
<li class="subsection"><a href="a-demo-app#sec:a_user_tour"><span class="number">2.2.1</span> Un tour de l'utilisateur</a></li>
<li class="subsection"><a href="a-demo-app#sec:mvc_in_action"><span class="number">2.2.2</span> MVC en action</a></li>
<li class="subsection"><a href="a-demo-app#sec:weaknesses_of_this_users_resource"><span class="number">2.2.3</span> Faiblesses de la ressource Utilisateurs (Users)</a></li></ol></li>
<li class="section"><a href="a-demo-app#sec:microposts_resource"><span class="number">2.3</span> La ressource Micro-messages (Microposts)</a></li>
<li><ol>
<li class="subsection"><a href="a-demo-app#sec:a_micropost_microtour"><span class="number">2.3.1</span> Un petit tour du micro-message</a></li>
<li class="subsection"><a href="a-demo-app#sec:putting_the_micro_in_microposts"><span class="number">2.3.2</span> Appliquer le <em>micro</em> aux micro-messages</a></li>
<li class="subsection"><a href="a-demo-app#sec:demo_user_has_many_microposts"><span class="number">2.3.3</span> Un utilisateur <code>has_many</code> (<code>possède plusieurs</code>) micro-messages</a></li>
<li class="subsection"><a href="a-demo-app#sec:inheritance_hierarchies"><span class="number">2.3.4</span> Hiérarchie des héritages</a></li>
<li class="subsection"><a href="a-demo-app#sec:deploying_the_demo_app"><span class="number">2.3.5</span> Déployer l'application Démo</a></li></ol></li>
<li class="section"><a href="a-demo-app#sec:2.4"><span class="number">2.4</span> Conclusion</a></li></ol></li>
<li class="chapter"><a href="static-pages#top"><span class="number">Chapitre 3</span> Pages statiques courantes</a></li>
<li><ol>
<li class="section"><a href="static-pages#sec:static_pages"><span class="number">3.1</span> Pages statiques</a></li>
<li><ol>
<li class="subsection"><a href="static-pages#sec:truly_static_pages"><span class="number">3.1.1</span> Pages HTML statiques</a></li>
<li class="subsection"><a href="static-pages#sec:static_pages_with_rails"><span class="number">3.1.2</span> Les pages statiques avec Rails</a></li></ol></li>
<li class="section"><a href="static-pages#sec:first_tests"><span class="number">3.2</span> Premiers tests</a></li>
<li><ol>
<li class="subsection"><a href="static-pages#sec:testing_tools"><span class="number">3.2.1</span> Outils de test</a></li>
<li><ol>
<li class="subsubsection"><a href="static-pages#sec:autotest">Auto-test</a></li></ol></li>
<li class="subsection"><a href="static-pages#sec:TDD"><span class="number">3.2.2</span> TDD : Rouge, Vert, Refactor</a></li>
<li><ol>
<li class="subsubsection"><a href="static-pages#sec:spork">Spork</a></li>
<li class="subsubsection"><a href="static-pages#sec:red">Rouge</a></li>
<li class="subsubsection"><a href="static-pages#sec:green">Vert</a></li>
<li class="subsubsection"><a href="static-pages#sec:refactor">Refactor</a></li></ol></li></ol></li>
<li class="section"><a href="static-pages#sec:slightly_dynamic_pages"><span class="number">3.3</span> Pages (un peu) dynamiques</a></li>
<li><ol>
<li class="subsection"><a href="static-pages#sec:testing_a_title_change"><span class="number">3.3.1</span> Test d'un changement de titre</a></li>
<li class="subsection"><a href="static-pages#sec:passing_title_tests"><span class="number">3.3.2</span> Réussir les tests de titre</a></li>
<li class="subsection"><a href="static-pages#sec:instance_variables_embedded_ruby"><span class="number">3.3.3</span> Variables d'instance et Ruby embarqué</a></li>
<li class="subsection"><a href="static-pages#sec:layouts"><span class="number">3.3.4</span> Supprimer les répétitions avec les <em>layouts</em></a></li></ol></li>
<li class="section"><a href="static-pages#sec:static_pages_conclusion"><span class="number">3.4</span> Conclusion</a></li>
<li class="section"><a href="static-pages#sec:static_pages_Exercices"><span class="number">3.5</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="rails-flavored-ruby#top"><span class="number">Chapitre 4</span> [(Rails-flavored Ruby)(Rails au goût Ruby)]</a></li>
<li><ol>
<li class="section"><a href="rails-flavored-ruby#sec:motivation"><span class="number">4.1</span> Motivation</a></li>
<li><ol>
<li class="subsection"><a href="rails-flavored-ruby#sec:title_helper"><span class="number">4.1.1</span> Un « helper » (« aideur ») pour le titre (<code>title</code>)</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:cascading_style_sheets"><span class="number">4.1.2</span> Feuilles de styles (CSS — Cascading Style Sheets)</a></li></ol></li>
<li class="section"><a href="rails-flavored-ruby#sec:strings_and_methods"><span class="number">4.2</span> Chaines de caractères et méthodes</a></li>
<li><ol>
<li class="subsection"><a href="rails-flavored-ruby#sec:comments"><span class="number">4.2.1</span> Commentaires</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:strings"><span class="number">4.2.2</span> Chaines de caractères</a></li>
<li><ol>
<li class="subsubsection"><a href="rails-flavored-ruby#sec:printing">Impression</a></li>
<li class="subsubsection"><a href="rails-flavored-ruby#sec:single_quoted_strings">Chaines de caractères « single-quoté »</a></li></ol></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:objects_and_message_passing"><span class="number">4.2.3</span> Objets et passage de message</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:method_definitions"><span class="number">4.2.4</span> Définition de méthode</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:back_to_the_title_helper"><span class="number">4.2.5</span> Retour à l'« helper » de titre</a></li></ol></li>
<li class="section"><a href="rails-flavored-ruby#sec:other_data_structures"><span class="number">4.3</span> Autres structures de données</a></li>
<li><ol>
<li class="subsection"><a href="rails-flavored-ruby#sec:arrays_and_ranges"><span class="number">4.3.1</span> Tableaux et rangs</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:blocks"><span class="number">4.3.2</span> Blocs</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:hashes_and_symbols"><span class="number">4.3.3</span> Tables de hachage et symboles</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:css_revisited"><span class="number">4.3.4</span> CSS revisitées</a></li></ol></li>
<li class="section"><a href="rails-flavored-ruby#sec:ruby_classes"><span class="number">4.4</span> Classes Ruby</a></li>
<li><ol>
<li class="subsection"><a href="rails-flavored-ruby#sec:constructors"><span class="number">4.4.1</span> Constructeurs</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:a_class_of_our_own"><span class="number">4.4.2</span> Héritages de classes</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:modifying_built_in_classes"><span class="number">4.4.3</span> Modifier les classes d'origine</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:a_controller_class"><span class="number">4.4.4</span> Classe de contrôleur</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:a_user_class"><span class="number">4.4.5</span> Classe utiliateur</a></li></ol></li>
<li class="section"><a href="rails-flavored-ruby#sec:Exercices"><span class="number">4.5</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="filling-in-the-layout#top"><span class="number">Chapitre 5</span> Poursuivre la mise en page</a></li>
<li><ol>
<li class="section"><a href="filling-in-the-layout#sec:structure"><span class="number">5.1</span> Ajout de structure</a></li>
<li><ol>
<li class="subsection"><a href="filling-in-the-layout#sec:adding_to_the_layout"><span class="number">5.1.1</span> Navigation du site</a></li>
<li class="subsection"><a href="filling-in-the-layout#sec:custom_css"><span class="number">5.1.2</span> Personnalisation CSS</a></li>
<li class="subsection"><a href="filling-in-the-layout#sec:partials"><span class="number">5.1.3</span> Partiels (Partials)</a></li></ol></li>
<li class="section"><a href="filling-in-the-layout#sec:layout_links"><span class="number">5.2</span> Liens pour la mise en page</a></li>
<li><ol>
<li class="subsection"><a href="filling-in-the-layout#sec:integration_tests"><span class="number">5.2.1</span> Test d'intégration</a></li>
<li class="subsection"><a href="filling-in-the-layout#sec:rails_routes"><span class="number">5.2.2</span> Routes Rails</a></li>
<li class="subsection"><a href="filling-in-the-layout#sec:nomd_routes"><span class="number">5.2.3</span> Nommer les routes</a></li></ol></li>
<li class="section"><a href="filling-in-the-layout#sec:user_signup"><span class="number">5.3</span> Inscription de l'utilisateur : une première étape</a></li>
<li><ol>
<li class="subsection"><a href="filling-in-the-layout#sec:users_controller"><span class="number">5.3.1</span> Contrôleur Utilisateur (Users controller)</a></li>
<li class="subsection"><a href="filling-in-the-layout#sec:signup_url"><span class="number">5.3.2</span> URL d'inscription</a></li></ol></li>
<li class="section"><a href="filling-in-the-layout#sec:layout_conclusion"><span class="number">5.4</span> Conclusion</a></li>
<li class="section"><a href="filling-in-the-layout#sec:layout_Exercices"><span class="number">5.5</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="modeling-and-viewing-users-one#top"><span class="number">Chapitre 6</span> Modéliser et afficher les utilisateurs, partie I</a></li>
<li><ol>
<li class="section"><a href="modeling-and-viewing-users-one#sec:user_model"><span class="number">6.1</span> Modèle utilisateur (User model)</a></li>
<li><ol>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:base de données_migrations"><span class="number">6.1.1</span> Migrations de la base de données</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:the_model_file"><span class="number">6.1.2</span> Le fichier modèle</a></li>
<li><ol>
<li class="subsubsection"><a href="modeling-and-viewing-users-one#sec:model_annotation">[(Model annotation)]</a></li>
<li class="subsubsection"><a href="modeling-and-viewing-users-one#sec:accessible_attributes">Attributs accessibles</a></li></ol></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:creating_user_objects"><span class="number">6.1.3</span> Créer des objets Utilisateur</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:finding_user_objects"><span class="number">6.1.4</span> Recherche dans les objets Utilisateurs (Users)</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:updating_user_objects"><span class="number">6.1.5</span> Actualisation des objets Utilisateurs (Users)</a></li></ol></li>
<li class="section"><a href="modeling-and-viewing-users-one#sec:user_validations"><span class="number">6.2</span> Validations utilisateur</a></li>
<li><ol>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:presence_validation"><span class="number">6.2.1</span> Valider l'existence</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:length_validation"><span class="number">6.2.2</span> Valider la longueur</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:format_validation"><span class="number">6.2.3</span> Valider le format</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:uniqueness_validation"><span class="number">6.2.4</span> Valider l'unicité</a></li>
<li><ol>
<li class="subsubsection"><a href="modeling-and-viewing-users-one#sec:the_caveat">L'avertissement d'unicité</a></li></ol></li></ol></li>
<li class="section"><a href="modeling-and-viewing-users-one#sec:viewing_users"><span class="number">6.3</span> Afficher les utilisateurs</a></li>
<li><ol>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:rails_environments"><span class="number">6.3.1</span> Débuggage et environnements Rails</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:users_show"><span class="number">6.3.2</span> Modèle, Vue et Contrôleur Utilisateur</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:a_users_resource"><span class="number">6.3.3</span> Ressource Utilisateurs</a></li>
<li><ol>
<li class="subsubsection"><a href="modeling-and-viewing-users-one#sec:params_in_debug">[(<code>params</code> in <code>debug</code>)]</a></li></ol></li></ol></li>
<li class="section"><a href="modeling-and-viewing-users-one#sec:6.4"><span class="number">6.4</span> Conclusion</a></li>
<li class="section"><a href="modeling-and-viewing-users-one#sec:6.5"><span class="number">6.5</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="modeling-and-viewing-users-two#top"><span class="number">Chapitre 7</span> Modéliser et afficher les utilisateurs, partie II</a></li>
<li><ol>
<li class="section"><a href="modeling-and-viewing-users-two#sec:insecure_passwords"><span class="number">7.1</span> Mots de passe non sûrs</a></li>
<li><ol>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:password_validations"><span class="number">7.1.1</span> Valider le mot de passe</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:password_migration"><span class="number">7.1.2</span> Migrer un mot de passe</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:an_active_record_callback"><span class="number">7.1.3</span> Un <em>callback</em> de l'Active Record</a></li></ol></li>
<li class="section"><a href="modeling-and-viewing-users-two#sec:secure_passwords"><span class="number">7.2</span> Sécuriser les mots de passe</a></li>
<li><ol>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:a_secure_password_test"><span class="number">7.2.1</span> Test de mot de passe sûr</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:secure_password_theory"><span class="number">7.2.2</span> Un peu de théorie sur les mots de passe sécurisés</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:implementing_has_password"><span class="number">7.2.3</span> Implémenter la méthode <code>has_password?</code></a></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:an_authenticate_method"><span class="number">7.2.4</span> Méthode d'authentification</a></li></ol></li>
<li class="section"><a href="modeling-and-viewing-users-two#sec:better_user_views"><span class="number">7.3</span> Meilleures vues d'utilisateurs</a></li>
<li><ol>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:tests_with_factories"><span class="number">7.3.1</span> Tester la page de l'utilisateur (avec factories)</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:a_name_and_a_gravatar"><span class="number">7.3.2</span> Un nom et un Gravatar</a></li>
<li><ol>
<li class="subsubsection"><a href="modeling-and-viewing-users-two#sec:a_gravatar_helper">Un « helper » de Gravatar</a></li></ol></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:a_user_sidebar"><span class="number">7.3.3</span> Une barre utilisateur latérale</a></li></ol></li>
<li class="section"><a href="modeling-and-viewing-users-two#sec:7.4"><span class="number">7.4</span> Conclusion</a></li>
<li><ol>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:7.4.1"><span class="number">7.4.1</span> Commit Git</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:heroku_deploy"><span class="number">7.4.2</span> Déploiement Heroku</a></li></ol></li>
<li class="section"><a href="modeling-and-viewing-users-two#sec:more_modeling_users_Exercices"><span class="number">7.5</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="sign-up#top"><span class="number">Chapitre 8</span> Inscription</a></li>
<li><ol>
<li class="section"><a href="sign-up#sec:signup_form"><span class="number">8.1</span> Formulaire d'inscription</a></li>
<li><ol>
<li class="subsection"><a href="sign-up#sec:using_form_for"><span class="number">8.1.1</span> Utiliser  <code>form_for</code></a></li>
<li class="subsection"><a href="sign-up#sec:the_form_html"><span class="number">8.1.2</span> Le formulaire HTML</a></li></ol></li>
<li class="section"><a href="sign-up#sec:signup_failure"><span class="number">8.2</span> Échec de l'inscription</a></li>
<li><ol>
<li class="subsection"><a href="sign-up#sec:testing_failure"><span class="number">8.2.1</span> Test de l'échec</a></li>
<li class="subsection"><a href="sign-up#sec:a_working_form"><span class="number">8.2.2</span> Un formulaire fonctionnel</a></li>
<li class="subsection"><a href="sign-up#sec:signup_error_messages"><span class="number">8.2.3</span> Inscription&nbsp;: messages d'erreur</a></li>
<li class="subsection"><a href="sign-up#sec:filtering_parameter_logging"><span class="number">8.2.4</span> Filtrage des paramètres d'identification</a></li></ol></li>
<li class="section"><a href="sign-up#sec:signup_success"><span class="number">8.3</span> Succès de l'inscription</a></li>
<li><ol>
<li class="subsection"><a href="sign-up#sec:testing_success"><span class="number">8.3.1</span> Tester le succès de l'inscription</a></li>
<li class="subsection"><a href="sign-up#sec:the_finished_signup_form"><span class="number">8.3.2</span> Le formulaire d'inscription finalisé</a></li>
<li class="subsection"><a href="sign-up#sec:the_flash"><span class="number">8.3.3</span> Le message «&nbsp;flash&nbsp;»</a</a></li>
<li class="subsection"><a href="sign-up#sec:the_first_signup"><span class="number">8.3.4</span> La première inscription</a></li></ol></li>
<li class="section"><a href="sign-up#sec:rspec_integration_tests"><span class="number">8.4</span> Test d'intégration RSpec</a></li>
<li><ol>
<li class="subsection"><a href="sign-up#sec:integration_tests_with_style"><span class="number">8.4.1</span> Tests d'intégration avec les styles</a></li>
<li class="subsection"><a href="sign-up#sec:failed_signup"><span class="number">8.4.2</span> Un échec d'inscription ne devrait pas créer un nouvel utilisateur</a></li>
<li class="subsection"><a href="sign-up#sec:successful_signup"><span class="number">8.4.3</span> Le succès d'une inscription devrait créer un nouvel utilisateur</a></li></ol></li>
<li class="section"><a href="sign-up#sec:8.5"><span class="number">8.5</span> Conclusion</a></li>
<li class="section"><a href="sign-up#sec:signup_Exercices"><span class="number">8.6</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="sign-in-sign-out#top"><span class="number">Chapitre 9</span> Connexion, déconnexion</a></li>
<li><ol>
<li class="section"><a href="sign-in-sign-out#sec:sessions"><span class="number">9.1</span> Les sessions</a></li>
<li><ol>
<li class="subsection"><a href="sign-in-sign-out#sec:sessions_controller"><span class="number">9.1.1</span> Le contrôleur de session</a></li>
<li class="subsection"><a href="sign-in-sign-out#sec:signin_form"><span class="number">9.1.2</span> Formulaire d'identification</a></li></ol></li>
<li class="section"><a href="sign-in-sign-out#sec:signin_failure"><span class="number">9.2</span> Échec de l'identification</a></li>
<li><ol>
<li class="subsection"><a href="sign-in-sign-out#sec:reviewing_form_submission"><span class="number">9.2.1</span> Examen de la soumission du formulaire</a></li>
<li class="subsection"><a href="sign-in-sign-out#sec:failed_signin"><span class="number">9.2.2</span> Échec de l'identification (test et code)</a></li></ol></li>
<li class="section"><a href="sign-in-sign-out#sec:signin_success"><span class="number">9.3</span> Succès de l'identification</a></li>
<li><ol>
<li class="subsection"><a href="sign-in-sign-out#sec:the_completed_create_action"><span class="number">9.3.1</span> L'action <code>create</code> («&nbsp;créer&nbsp;») finalisée</a></li>
<li class="subsection"><a href="sign-in-sign-out#sec:remember_me"><span class="number">9.3.2</span> Se souvenir de moi</a></li>
<li class="subsection"><a href="sign-in-sign-out#sec:current_user"><span class="number">9.3.3</span> Utilisateur courant</a></li></ol></li>
<li class="section"><a href="sign-in-sign-out#sec:signing_out"><span class="number">9.4</span> Déconnexion</a></li>
<li><ol>
<li class="subsection"><a href="sign-in-sign-out#sec:destroying_sessions"><span class="number">9.4.1</span> Détruire la session</a></li>
<li class="subsection"><a href="sign-in-sign-out#sec:signin_upon_signup"><span class="number">9.4.2</span> Connection à l'inscription</a></li>
<li class="subsection"><a href="sign-in-sign-out#sec:changing_the_layout_links"><span class="number">9.4.3</span> Changement des liens de la mise en plage</a></li>
<li class="subsection"><a href="sign-in-sign-out#sec:signin_out_integration_tests"><span class="number">9.4.4</span> Test d'intégration de l'identification/déconnexion</a></li></ol></li>
<li class="section"><a href="sign-in-sign-out#sec:9.5"><span class="number">9.5</span> Conclusion</a></li>
<li class="section"><a href="sign-in-sign-out#sec:sign_in_out_Exercices"><span class="number">9.6</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="updating-showing-and-deleting-users#top"><span class="number">Chapitre 10</span> Actualiser, afficher et supprimer de l'utilisateur</a></li>
<li><ol>
<li class="section"><a href="updating-showing-and-deleting-users#sec:updating_users"><span class="number">10.1</span> Actualiser l'utilisateur</a></li>
<li><ol>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:edit_form"><span class="number">10.1.1</span> Formulaire de modification</a></li>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:enabling_edits"><span class="number">10.1.2</span> Permettre les modifications</a></li></ol></li>
<li class="section"><a href="updating-showing-and-deleting-users#sec:protecting_pages"><span class="number">10.2</span> Protéger les pages</a></li>
<li><ol>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:requiring_signed_in_users"><span class="number">10.2.1</span> Utilisateurs identifiés requis</a></li>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:requiring_the_right_user"><span class="number">10.2.2</span> Nécessité du bon utilisateur</a></li>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:friendly_forwarding"><span class="number">10.2.3</span> Redirection conviviale</a></li></ol></li>
<li class="section"><a href="updating-showing-and-deleting-users#sec:showing_users"><span class="number">10.3</span> Afficher les utilisateurs</a></li>
<li><ol>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:user_index"><span class="number">10.3.1</span> Liste des utilisateurs</a></li>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:sample_users"><span class="number">10.3.2</span> Exemples d'utilisateurs</a></li>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:pagination"><span class="number">10.3.3</span> Pagination</a></li>
<li><ol>
<li class="subsubsection"><a href="updating-showing-and-deleting-users#sec:testing_pagination">Test de la pagination</a></li></ol></li>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:partial_refactoring"><span class="number">10.3.4</span> Restructuration des partielles</a></li></ol></li>
<li class="section"><a href="updating-showing-and-deleting-users#sec:destroying_users"><span class="number">10.4</span> Supprimer des utilisateurs</a></li>
<li><ol>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:administrative_users"><span class="number">10.4.1</span> Utilisateurs administrateurs</a></li>
<li><ol>
<li class="subsubsection"><a href="updating-showing-and-deleting-users#sec:revisiting_attr_accessible">Révision de <code>attr_accessible</code></a></li></ol></li>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:the_destroy_action"><span class="number">10.4.2</span> L'action <code>destroy</code> («&nbsp;supprimer&nbsp;»)</a></li></ol></li>
<li class="section"><a href="updating-showing-and-deleting-users#sec:10.5"><span class="number">10.5</span> Conclusion</a></li>
<li class="section"><a href="updating-showing-and-deleting-users#sec:updating_deleting_Exercices"><span class="number">10.6</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="user-microposts#top"><span class="number">Chapitre 11</span> Micro-messages d'utilisateur</a></li>
<li><ol>
<li class="section"><a href="user-microposts#sec:a_micropost_model"><span class="number">11.1</span> Le modèle Micropost («&nbsp;Micro-message&nbsp;»)</a></li>
<li><ol>
<li class="subsection"><a href="user-microposts#sec:the_basic_model"><span class="number">11.1.1</span> Le modèle initial</a></li>
<li><ol>
<li class="subsubsection"><a href="user-microposts#sec:accessible_attribute">Attributs accessibles</a></li></ol></li>
<li class="subsection"><a href="user-microposts#sec:user_micropost_associations"><span class="number">11.1.2</span> Associations Utilisateur/micro-messages</a></li>
<li class="subsection"><a href="user-microposts#sec:ordering_and_dependency"><span class="number">11.1.3</span> Affinements du micro-message</a></li>
<li><ol>
<li class="subsubsection"><a href="user-microposts#sec:default_scope">Portée par défaut</a></li>
<li class="subsubsection"><a href="user-microposts#sec:dependent_destroy">Dependent: destroy (dépendances de la suppression)</a></li></ol></li>
<li class="subsection"><a href="user-microposts#sec:micropost_validations"><span class="number">11.1.4</span> Validations du micro-message</a></li></ol></li>
<li class="section"><a href="user-microposts#sec:showing_microposts"><span class="number">11.2</span> Afficher les micro-messages</a></li>
<li><ol>
<li class="subsection"><a href="user-microposts#sec:augmenting_the_user_show_page"><span class="number">11.2.1</span> Etoffement de la page de l'utilisateur</a></li>
<li class="subsection"><a href="user-microposts#sec:sample_microposts"><span class="number">11.2.2</span> Exemples de micro-messages</a></li></ol></li>
<li class="section"><a href="user-microposts#sec:manipulating_microposts"><span class="number">11.3</span> Manipuler les micro-messages</a></li>
<li><ol>
<li class="subsection"><a href="user-microposts#sec:access_control"><span class="number">11.3.1</span> Contrôle de l'accès</a></li>
<li class="subsection"><a href="user-microposts#sec:creating_microposts"><span class="number">11.3.2</span> Créer des micro-messages</a></li>
<li class="subsection"><a href="user-microposts#sec:a_proto_feed"><span class="number">11.3.3</span> Une proto-alimentation</a></li>
<li class="subsection"><a href="user-microposts#sec:destroying_microposts"><span class="number">11.3.4</span> Supprimer des micro-messages</a></li>
<li class="subsection"><a href="user-microposts#sec:testing_the_new_home_page"><span class="number">11.3.5</span> Test de la nouvelle page d'accueil</a></li></ol></li>
<li class="section"><a href="user-microposts#sec:11.4"><span class="number">11.4</span> Conclusion</a></li>
<li class="section"><a href="user-microposts#sec:micropost_Exercices"><span class="number">11.5</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="following-users#top"><span class="number">Chapitre 12</span> Suivi des utilisateurs</a></li>
<li><ol>
<li class="section"><a href="following-users#sec:the_relationship_model"><span class="number">12.1</span> Le modèle Relation (Relationship model)</a></li>
<li><ol>
<li class="subsection"><a href="following-users#sec:a_problem_with_the_data_model"><span class="number">12.1.1</span> Un problème du modèle de données (et sa solution)</a></li>
<li class="subsection"><a href="following-users#sec:relationship_user_associations"><span class="number">12.1.2</span> Associations Utilisateur/Relations</a></li>
<li class="subsection"><a href="following-users#sec:relationship_validations"><span class="number">12.1.3</span> Validations</a></li>
<li class="subsection"><a href="following-users#sec:following"><span class="number">12.1.4</span> Auteurs suivis</a></li>
<li class="subsection"><a href="following-users#sec:followers"><span class="number">12.1.5</span> Lecteurs</a></li></ol></li>
<li class="section"><a href="following-users#sec:a_web_interface_for_following_and_followers"><span class="number">12.2</span> Une interface web pour les auteurs suivis et les lecteurs</a></li>
<li><ol>
<li class="subsection"><a href="following-users#sec:sample_following_data"><span class="number">12.2.1</span> Exemple de donnée de suivi</a></li>
<li class="subsection"><a href="following-users#sec:stats_and_a_follow_form"><span class="number">12.2.2</span> Statistiques et formulaire de suivi</a></li>
<li class="subsection"><a href="following-users#sec:following_and_followers_pages"><span class="number">12.2.3</span> Pages d'auteurs suivis et de lecteurs</a></li>
<li class="subsection"><a href="following-users#sec:a_working_follow_button_the_standard_way"><span class="number">12.2.4</span> Un bouton de suivi fonctionnant de façon standard</a></li>
<li class="subsection"><a href="following-users#sec:a_working_follow_button_with_ajax"><span class="number">12.2.5</span> Un bouton fonctionnant avec Ajax</a></li></ol></li>
<li class="section"><a href="following-users#sec:the_status_feed"><span class="number">12.3</span> L'état de l'alimention</a></li>
<li><ol>
<li class="subsection"><a href="following-users#sec:motivation_and_strategy"><span class="number">12.3.1</span> Motivation et stratégie</a></li>
<li class="subsection"><a href="following-users#sec:a_first_feed_implementation"><span class="number">12.3.2</span> Une première implémentation de peuplement</a></li>
<li class="subsection"><a href="following-users#sec:scopes_subselects_and_a_lambda"><span class="number">12.3.3</span> Portées, sous-requêtes et fonction <em>lambda</em></a></li>
<li class="subsection"><a href="following-users#sec:the_new_status_feed"><span class="number">12.3.4</span> Nouvel état de l'alimentation</a></li></ol></li>
<li class="section"><a href="following-users#sec:following_conclusion"><span class="number">12.4</span> Conclusion</a></li>
<li><ol>
<li class="subsection"><a href="following-users#sec:extensions_to_the_sample_application"><span class="number">12.4.1</span> Extensions de l'application exemple</a></li>
<li><ol>
<li class="subsubsection"><a href="following-users#sec:replies">Réponses</a></li>
<li class="subsubsection"><a href="following-users#sec:messaging">Notification</a></li>
<li class="subsubsection"><a href="following-users#sec:follower_notifications">Notifications aux lecteurs</a></li>
<li class="subsubsection"><a href="following-users#sec:password_reminders">Rappel du mot de passe</a></li>
<li class="subsubsection"><a href="following-users#sec:signup_confirmation">Confirmation d'inscription</a></li>
<li class="subsubsection"><a href="following-users#sec:rss_feed">Alimentation RSS</a></li>
<li class="subsubsection"><a href="following-users#sec:rest_api">REST API</a></li>
<li class="subsubsection"><a href="following-users#sec:search">Recherche</a></li></ol></li>
<li class="subsection"><a href="following-users#sec:guide_to_further_resources"><span class="number">12.4.2</span> Guide vers d'autres ressources</a></li></ol></li>
<li class="section"><a href="following-users#sec:following_Exercices"><span class="number">12.5</span> Exercices</a></li></ol></li></ol></div>




<div id="main_content"></div>

<p> <span class="preamble">
 <span id="foreword">
<strong> Avant-propos</strong> <br />
 </span>
 </span></p>

<p>Ma précédente compagnie (CD Baby) fut une des premières à basculer intégralement vers Ruby on Rails, et à rebasculer aussi intégralement vers PHP (googlez-moi si vous voulez prendre la mesure du drame). On m'a tellement recommandé ce livre Michael Hartl que je n'ai pu faire autrement que de le lire. C'est ainsi que le <em>Tutoriel Ruby on Rails</em> m'a fait revenir à nouveau à Rails.</p>
<p>Bien qu'ayant parcouru de nombreux livres sur Rails, c'est ce tutoriel-là qui m'a véritablement «&nbsp;mis en possession&nbsp;» de Rails. Tout est fait ici «&nbsp;à la manière de Rails&nbsp;» —&nbsp;une manière qui ne m'avait jamais semblé naturelle avant que je ne lise ce livre. C'est aussi le seul ouvrage sur Rails qui met en place, d'un bout à l'autre, un <em>Développement Dirigé par les Tests</em> (<em>Test-Driven Development</em>), une approche que je savais hautement recommandée par les experts mais dont je n'avais jamais compris aussi bien la pertinence que dans ce livre. Enfin, en incluant Git, GitHub et Heroku dans les exemples de la démonstration, l'auteur vous donne vraiment le goût de ce qu'est le développement d'un projet dans la vie réelle. Et le exemples de code ne sont pas en reste.</p> 
	
<p>La narration linéaire adoptée par ce tutoriel est vraiment un bon format. Personnellement, j'ai étudié <em>Le Tutoriel Rails</em> en trois longues journées, en faisant tous les exemples et les exercices proposés à la fin de chaque chapitre. C'est en lisant ce livre du début à la fin, sans sauter la moindre partie, qu'on en tire tout le bénéfice.</p>

<p>Régalez-vous&nbsp;!</p>

<p><a href="http://sivers.org/">Derek Sivers</a> (<a href="http://sivers.org/">sivers.org</a>) <br />
<em>Précédemment&nbsp;: Fondateur de </em> <a href="http://www.cdbaby.com/"><em>CD Baby</em></a> <br />
<em>Actuellement&nbsp;: Fondateur de </em> <a href="http://thoughts.pro/"><em>Thoughts Ltd.</em></a> <br /></p>

<p> <span class="preamble">
<strong> Remerciements</strong> <br />
 </span></p>

<p>Ce <em>Tutoriel Ruby on Rails</em> doit beaucoup à mon livre précédent sur Rails, <em>RailsSpace</em>, et donc à mon co-auteur <a href="http://aure.com/">Aurelius Prochazka</a>. J'aimerais remercier Aure à la fois pour le travail qu'il a accompli sur ce précédent livre et pour son soutien pour le présent ouvrage. J'aimerais aussi remercier Debra Williams Cauley, mon éditeur pour les deux ouvrages&nbsp;; aussi longtemps qu'elle jouera avec moi au baseball, je continuerai d'écrire des livres pour elle.</p>

<p>J'aimerais remercier une longue liste de Rubyistes qui m'ont parlé et inspiré au cours des années&nbsp;: David Heinemeier Hansson, Yehuda Katz, Carl Lerche, Jeremy Kemper, Xavier Noria, Ryan Bates, Geoffrey Grosenbach, Peter Cooper, Matt Aimonetti, Gregg Pollack, Wayne&nbsp;E. Seguin, Amy Hoy, Dave Chelimsky, Pat Maddox, Tom Preston-Werner, Chris Wanstrath, Chad Fowler, Josh Susser, Obie Fernandez, Ian McFarland, Steven Bristol, Giles Bowkett, Evan Dorn, Long Nguyen, James Lindenbaum, Adam Wiggins, Tikhon Bernstam, Ron Evans, Wyatt Greene, Miles Forrest, les gens bien de Pivotal Labs, le gang Heroku, les mecs de thoughtbot et l'équipe de GitHub. Enfin, tellement, tellement, tellement de lecteurs —&nbsp;beaucoup trop pour les citer tous&nbsp;— qui ont contribué par leur rapport de bogues et leurs suggestions durant l'écriture de ce livre, et je tiens à saluer leur aide sans laquelle ce livre ne serait pas ce qu'il est. <br /></p>

<p> <span class="preamble">
 <span id="author">
<strong> À propos de l'auteur</strong> <br />
 </span>
 </span></p>

<p><a href="http://michaelhartl.com/">Michael Hartl</a> est programmeur, éducateur et entrepreneur. Il est le co-auteur de <em>RailsSpace</em>, un tutoriel Rails publié en 2007, et a été co-fondateur et développeur en chef de <a href="http://insoshi.com/">Insoshi</a>, une plateforme de réseau social <a href="http://github.com/popular/forked">populaire</a> en Ruby on Rails. Précédement, il a enseigné la théorie et la physique informatique au <a href="http://www.caltech.edu/">California Institute of Technology</a> (Caltech), où il a reçu le Lifetime Achievement Award for Excellence en enseignement. Michael est diplômé du <a href="http://college.harvard.edu/">Harvard College</a>, a un <a href="http://resolver.caltech.edu/CaltechETD:etd-05222003-161626">Ph.D. en physique</a> (un doctorat. NdT) de <a href="http://www.caltech.edu/">Caltech</a>, et il est ancien élève du programme des entrepreneurs <a href="http://ycombinator.com/">Y&nbsp;Combinator</a>. <br /></p>

<p> <span id="license" class="preamble">
<strong> Copyright et license</strong> <br />
 </span></p>

<p><em>Le Tutoriel Ruby on Rails&nbsp;: apprendre Rails par l'exemple</em>. Copyright &copy; 2010 par Michael Hartl. Tout le code source du <em>Tutoriel Ruby on Rails</em> est disponible sous la license <a href="http://www.opensource.org/licenses/mit-license.php">MIT License</a> et la licence <a href="http://en.wikipedia.org/wiki/Beerware">Beerware License</a>.</p>

<pre class="verbatim">   Copyright (c) 2010 Michael Hartl

   Permission est accordée, à titre gratuit, à toute personne obtenant
   une copie de ce logiciel et la documentation associée, pour faire des 
   modification dans le logiciel sans restriction et sans limitation des
   droits d’utiliser, copier, modifier, fusionner, publier, distribuer,
   concéder sous licence, et / ou de vendre les copies du Logiciel, et à
   autoriser les personnes auxquelles le Logiciel est meublé de le faire, 
   sous réserve des conditions suivantes:

   L’avis de copyright ci-dessus et cette autorisation doit être inclus
   dans toutes les copies ou parties substantielles du Logiciel.

   LE LOGICIEL EST FOURNI «TEL QUEL», SANS GARANTIE D’AUCUNE SORTE, 
   EXPLICITE OU IMPLICITE, Y COMPRIS, MAIS SANS S’Y LIMITER, LES 
   GARANTIES DE QUALITÉ MARCHANDE, ADAPTATION À UN USAGE PARTICULIER ET
   D’ABSENCE DE CONTREFAÇON. EN AUCUN CAS LES AUTEURS OU TITULAIRES DU
   ETRE TENU RESPONSABLE DE TOUT DOMMAGE, RÉCLAMATION OU AUTRES
   RESPONSABILITÉ, SOIT DANS UNE ACTION DE CONTRAT, UN TORT OU AUTRE,
   PROVENANT DE, DE OU EN RELATION AVEC LE LOGICIEL OU L’UTILISATION OU
   DE TRANSACTIONS AUTRES LE LOGICIEL.
	
</pre>




<pre class="verbatim">/*
 * ------------------------------------------------------------
 * &quot;LA LICENCE BEERWARE&quot; (Révision 42)&nbsp;:
 * Michael Hartl a écrit ce code. Aussi longtemps que vous
 * conservez cette note, vous pouvez faire ce que vous voulez
 * de ce travail. Si nous nous rencontrons un jour, et que vous
 * pensez que ce travail en vaut la peine, vous pourrez me
 * payer une bière en retour.
 * ------------------------------------------------------------
 */</pre>



<div id="top"></div>


<h1 class="chapter"><a id="sec:7" href="modeling-and-viewing-users-two#top" class="heading"><span class="number">chapitre 7</span> Modéliser et afficher les utilisateurs, partie II</a></h1>


<p>Au <a class="ref" href="modeling-and-viewing-users-one#top">chapitre&nbsp;6</a>, nous avons créé la première itération d'un modèle User (<em>Utilisateur</em>) pour représenter les utilisateurs de notre application, mais le job a été à moitié accompli. Virtuellement n'importe quel site avec des utilisateurs, incluant le nôtre, a besoin d'un <em>système d'authentification</em>, mais pour le moment n'importe quel utilisateur qui peut s'inscrire au site possède un nom et une adresse mail, et nous n'avons aucun moyen de vérifier leur identité. Dans ce chapitre, nous allons ajouter l'attribut <em>mot de passe</em> (<em>password</em>) nécessaire à une inscription initiale de l'utilisateur (<a class="ref" href="sign-up#top">chapitre&nbsp;8</a>) et à une identification (une connexion) avec une combinaison email/mot de passe (<a class="ref" href="sign-in-sign-out#top">chapitre&nbsp;9</a>). Au cours du processus, nous ré-utiliserons plusieurs des idées du <a class="ref" href="modeling-and-viewing-users-one#top">chapitre&nbsp;6</a>, incluant les <rw>migrations</rw> et les <rw>validations</rw>, et aussi introduire de nouvelles idées telles que les <rw>attributs virtuels</rw>, les <rw>méthodes privées</rw> et les <rw>fonctions de rappel</rw> (<em>callbacks</em>) d'Active Record.</p>

<p>Dès que nous aurons un attribut <code>mot_de_passe</code> fonctionnel, nous ferons une action et une vue pour afficher les profils des utilisateurs (<a class="ref" href="modeling-and-viewing-users-two#sec:better_user_views">section&nbsp;7.3</a>). Vers la fin de ce chapitre, nos profils d'utilisateur afficheront les noms et les photos du profil (comme indiqué dans la maquette de l'<a class="ref" href="modeling-and-viewing-users-two#fig:profile_mockup_profile_name">illustration&nbsp;7.1</a>), et ils seront bien testés avec des «&nbsp;utilisateurs d'usine&nbsp;».</p>

<p>Avant d'avancer, ré-initialisons la base de données avec <code>rake db:reset</code>, ce qui va retirer tous les vieux exemples d'utilisateurs des sessions précédentes&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rake db:reset</span>
</pre></div>
</div>




<div class="label" id="fig:profile_mockup_profile_name"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/profile_mockup_profile_name.png" alt="profile_mockup_profile_name" /></span></div><div class="caption"><span class="header">Illustration 7.1: </span><span class="description">Une maquette du profil utilisateur fait à la <a class="ref" href="modeling-and-viewing-users-two#sec:better_user_views">section&nbsp;7.3</a>.&nbsp;<a href="http://railstutorial.org/images/figures/profile_mockup_profile_name-full.png">(taille normale)</a></span></div></div>




<div class="label" id="sec:insecure_passwords"></div>


<h2><a id="sec:7.1" href="modeling-and-viewing-users-two#sec:insecure_passwords" class="heading"><span class="number">7.1</span> Mots de passe peu sécurisés</a></h2>


<p>Faire des mots de passe robustes requiert beaucoup de machinerie, donc nous allons diviser le processus en deux principales étapes. Dans cette section, nous allons faire un attribut <code>mot_de_passe</code> et ajouter des validations. Le modèle User (<em>Utilisateur</em>) en résultant sera complètement fonctionnel mais pas du tout sécurisé, avec des mots de passe enregistrés «&nbsp;en clair&nbsp;» dans la base de données. À la <a class="ref" href="modeling-and-viewing-users-two#sec:secure_passwords">section&nbsp;7.2</a>, nous règlerons ce problème en cryptant les mots de passe avant de les sauver, protégeant ainsi notre site des attaques toujours possibles.</p>

<div class="label" id="sec:password_validations"></div>


<h3><a id="sec:7.1.1" href="modeling-and-viewing-users-two#sec:password_validations" class="heading"><span class="number">7.1.1</span> Validations du mot de passe</a></h3>


<p>Quand bien même nous n'avons pas encore ajouté une colonne pour les mots de passe à notre base de données, nous allons déjà commencer par écrire leurs tests. Notre projet initial est d'avoir des tests pour valider la présence, la longueur et la confirmation des mots de passe.
	C'est notre plus gros bloc de tests jusqu'ici, voyez si vous pouvez le lire tout d'un tenant. Si vous restez coincé, ça vous aidera sans doute de revoir les validations analogues de la <a class="ref" href="modeling-and-viewing-users-one#sec:user_validations">section&nbsp;6.2</a> ou sauter directement au code de l'application de l'<a class="ref" href="modeling-and-viewing-users-two#code:password_validations">extrait&nbsp;7.2</a>.</p>

<p>Dans le but de minimiser les typos dans les mots de passe, quand on fera la page d'inscription de l'utilisateur au <a class="ref" href="sign-up#top">chapitre&nbsp;8</a> nous adopterons la convention courante que les utilisateurs <em>confirment</em> leur mot de passe. Pour commencer, revoyons la table d'attributs vue dans l'<a class="ref" href="modeling-and-viewing-users-one#code:validates_uniqueness_of_email_case_insensitive_test">extrait&nbsp;6.20</a>:</p>

<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
    <span class="vi">@attr</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:nom</span> <span class="o">=&gt;</span> <span class="s2">&quot;Utilisateur exemple&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;user@example.com&quot;</span> <span class="p">}</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div>


<p>Pour écrire des tests pour les mots de passe, nous aurons besoin d'ajouter <em>deux</em> nouveaux <rw>attributs</rw> à la table <code>@attr</code>, <code>password</code> (<em>mot de passe</em>) et <code>password_confirmation</code> (<em>motdepasse_confirmation</em>). Comme vous pouvez certainement le deviner, l'attribut <code>password_confirmation</code> sera utilisé pour l'étape de confirmation du mot de passe.</p>

<p>Écrivons des tests pour la présence du mot de passe et sa confirmation, avec des tests confirmant que le mot de passe a une longueur valide (réduite à quelque chose arbitrairement fixée entre 6 et 40 caractères). Le résultat apparait dans l'<a class="ref" href="modeling-and-viewing-users-two#code:password_validation_tests">extrait&nbsp;7.1</a>.</p>

<div class="label" id="code:password_validation_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 7.1.</span> <span class="description">Des tests pour les validations du mot de passe. <br /> <code>spec/models/user_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
    <span class="vi">@attr</span> <span class="o">=</span> <span class="p">{</span>
      <span class="ss">:nom</span> <span class="o">=&gt;</span> <span class="s2">&quot;Utilisateur exemple&quot;</span><span class="p">,</span>
      <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;user@example.com&quot;</span><span class="p">,</span>
      <span class="ss">:password</span> <span class="o">=&gt;</span> <span class="s2">&quot;foobar&quot;</span><span class="p">,</span>
      <span class="ss">:password_confirmation</span> <span class="o">=&gt;</span> <span class="s2">&quot;foobar&quot;</span>
    <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s2">&quot;devrait créer une nouvelle instance avec des attributs valides&quot;</span> <span class="k">do</span>
    <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="vi">@attr</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;password validations&quot;</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">&quot;devrait exiger un mot de passe&quot;</span> <span class="k">do</span>
      <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@attr</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="ss">:password</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="ss">:password_confirmation</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">))</span><span class="o">.</span>
        <span class="n">should_not</span> <span class="n">be_valid</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;devrait exiger une confirmation du mot de passe qui correspond&quot;</span> <span class="k">do</span>
      <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@attr</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="ss">:password_confirmation</span> <span class="o">=&gt;</span> <span class="s2">&quot;invalid&quot;</span><span class="p">))</span><span class="o">.</span>
        <span class="n">should_not</span> <span class="n">be_valid</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;devrait rejeter les mots de passe (trop) courts&quot;</span> <span class="k">do</span>
      <span class="n">short</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span> <span class="o">*</span> <span class="mi">5</span>
      <span class="nb">hash</span> <span class="o">=</span> <span class="vi">@attr</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="ss">:password</span> <span class="o">=&gt;</span> <span class="n">short</span><span class="p">,</span> <span class="ss">:password_confirmation</span> <span class="o">=&gt;</span> <span class="n">short</span><span class="p">)</span>
      <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">hash</span><span class="p">)</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_valid</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;devrait rejeter les (trop) longs mots de passe&quot;</span> <span class="k">do</span>
      <span class="n">long</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span> <span class="o">*</span> <span class="mi">41</span>
      <span class="nb">hash</span> <span class="o">=</span> <span class="vi">@attr</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="ss">:password</span> <span class="o">=&gt;</span> <span class="n">long</span><span class="p">,</span> <span class="ss">:password_confirmation</span> <span class="o">=&gt;</span> <span class="n">long</span><span class="p">)</span>
      <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">hash</span><span class="p">)</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_valid</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Notez sans l'<a class="ref" href="modeling-and-viewing-users-two#code:password_validation_tests">extrait&nbsp;7.1</a> comme nous collectons d'abord un set d'attributs utilisateur valides dans <code>@attr</code>. Si pour quelque raison que ce soit ces attributs ne sont pas valides &mdash;&nbsp;comme ce devrait être le cas, par exemple, si nous n'avons pas implémenté les confirmations proprement&nbsp;&mdash; alors la première étape&nbsp;:</p>

<div class="code"><div class="highlight"><pre>  <span class="n">it</span> <span class="s2">&quot;devrait créer une nouvelle instance avec des attributs valides&quot;</span> <span class="k">do</span>
    <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="vi">@attr</span><span class="p">)</span>
  <span class="k">end</span>
</pre></div>
</div>


<p>… rencontrera une erreur. Les tests suivants vérifieront alors chaque validation à son tour, en utilisant la même technique <code>@attr.merge</code> introduite la première fois dans l'<a class="ref" href="modeling-and-viewing-users-one#code:failing_validates_name_spec">extrait&nbsp;6.11</a>.</p>

<p>Voyons maintenant le code de l'application, qui contient une astuce. En fait, elle contient <em>deux</em> astuces. D'abord, vous pouvez vous attendre, à ce point, à ce qu'on joue une migration pour ajouter un attribut <code>password</code> à notre modèle User, comme nous l'avions fait pour les attributs <code>nom</code> et <code>email</code> dans l'<a class="ref" href="modeling-and-viewing-users-one#code:generate_user_model">extrait&nbsp;6.1</a>. Mais ce n'est pas le cas&nbsp;: nous n'allons enregistrer qu'un mot de passe <em>crypté</em> dans la base de données&nbsp;; pour le mot de passe, nous allons introduire la notion d'<em>attribut virtuel</em> (c'est-à-dire un attribut qui ne correspond pas à une colonne de la base de données) en utilisant la méthode <code>attr_accessor</code>, comme nous l'avons fait avec la méthode <code>attr_accessible</code> pour les attributs <code>nom</code> et <code>email</code> pour l'exemple d'utilisateur à la <a class="ref" href="rails-flavored-ruby#sec:a_user_class">section&nbsp;4.4.5</a>. L'attribut <code>password</code> ne sera jamais écrit dans la base de données, mais n'existera qu'en mémoire pour permettre l'étape de confirmation du mot de passe (implémentée ci-dessous) et l'étape de cryptage (implémentée à la <a class="ref" href="modeling-and-viewing-users-two#sec:password_migration">section&nbsp;7.1.2</a> et <a class="ref" href="modeling-and-viewing-users-two#sec:secure_passwords">section&nbsp;7.2</a>).</p>

<p>La seconde astuce est que nous n'allons <em>pas</em> introduire un attribut  <code>password_confirmation</code>, pas même un virtuel. À la place, nous utiliserons la validation spéciale&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="n">validates</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:confirmation</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</pre></div>
</div>


<p>… qui va <em>automatiquement</em> créer un attribut virtuel appelé <code>password_confirmation</code>, tout en confirmant dans le même temps qu'il correspond exactement à l'attribut <code>password</code>.</p>

<p>Ainsi préparé à comprendre l'implémentation, jetons un coup d'œil au code lui-même (<a class="ref" href="modeling-and-viewing-users-two#code:password_validations">extrait&nbsp;7.2</a>).</p>

<div class="label" id="code:password_validations"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 7.2.</span> <span class="description">Valdiation pour l'attribut <code>password</code>. <br /> <code>app/models/user.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="kp">attr_accessor</span> <span class="ss">:password</span>
  <span class="n">attr_accessible</span> <span class="ss">:nom</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:password_confirmation</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="c1"># Crée automatique l'attribut virtuel &#39;password_confirmation&#39;.</span>
  <span class="n">validates</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:presence</span>     <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span>
                       <span class="ss">:confirmation</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span>
                       <span class="ss">:length</span>       <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:within</span> <span class="o">=&gt;</span> <span class="mi">6</span><span class="o">.</span><span class="n">.</span><span class="mi">40</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Comme promis, nous utilisons <code>attr_accessor :password</code> pour créer un attribut <code>password</code> virtuel (comme à la <a class="ref" href="rails-flavored-ruby#sec:a_user_class">section&nbsp;4.4.5</a>). Puis, puisque nous allons accepter les mots de passe et leur confirmation comme part du processus d'inscription au <a class="ref" href="sign-up#top">chapitre&nbsp;8</a>, nous avons besoin d'ajouter le mot de passe et sa confirmation à la liste des attributs accessibles (mentionnée la première fois à la <a class="ref" href="modeling-and-viewing-users-one#sec:accessible_attributes">section&nbsp;6.1.2.2</a>), ce que nous faisons à la ligne&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="n">attr_accessible</span> <span class="ss">:nom</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:password_confirmation</span>
</pre></div>
</div>


<p>Ensuite vient les validation du mot de passe. Elle requièrent la présent d'un <code>:password</code> (commme, par exemplen dans l'<a class="ref" href="modeling-and-viewing-users-one#code:validates_presence_of_name">extrait&nbsp;6.7</a>) et incluent <code>:confirmation =&gt; true</code> qui rejettent les utilisateurs dont le mot de passe et sa confirmation ne correspondent pas. Nous avons aussi une deuxième application de la validation de la longueur&nbsp;; dans l'<a class="ref" href="modeling-and-viewing-users-one#code:length_validation">extrait&nbsp;6.15</a> nous contraignions l'attribut <code>nom</code> à avoir moins de 50 caractères en utilisant l'option <code>:maximum</code>&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="n">validates</span> <span class="ss">:nom</span><span class="p">,</span>  <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span>
                  <span class="ss">:length</span>   <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:maximum</span> <span class="o">=&gt;</span> <span class="mi">50</span> <span class="p">}</span>
</pre></div>
</div>


<p>Pour la validation de la longueur du mot de passe, nous avons plutôt utilisé l'option <code>:within</code>, en lui passant le <em>rang</em><sup class="footnote" id="fnref:7.1"><a href="#fn:7.1">1</a></sup> <code>6..40</code> pour forcer la contrainte de longueur.</p>

<div class="label" id="sec:password_migration"></div>


<h3><a id="sec:7.1.2" href="modeling-and-viewing-users-two#sec:password_migration" class="heading"><span class="number">7.1.2</span> La migration du mot de passe</a></h3>


<p>À ce point, nous devons considérer que nous n'enregistrons le mot de passe de l'utilisateur nulle part&nbsp;; puisque nous avons décidé d'utiliser un mot de passe virtuel, plutôt que de l'enregistrer dans la base de données, il n'existe qu'en mémoire. Comment pouvons-nous utiliser ce mot de passe pour l'identification&nbsp;? La solution consiste à créer un attribut séparé dédié à la consignation du mot de passe, et notre stratégie consistera à utiliser un mot de passe virtuel comme matériel brut pour un <em>mot de passe crypté</em>, que nous <em>enregistrerons</em> dans la base de données à l'inscription de l'utilisateur (<a class="ref" href="sign-up#top">chapitre&nbsp;8</a>) et que nous récupèrerons plus tard pour l'identification de l'utilisateur (<a class="ref" href="sign-in-sign-out#top">chapitre&nbsp;9</a>).</p>

<p>Planifions l'enregistrement du mot de passe crypté en utilisant un attribut <code>encrypted_password</code> dans notre modèle User (<em>Utilisateur</em>). Nous discuterons des détails de l'implémentation à la <a class="ref" href="modeling-and-viewing-users-two#sec:secure_passwords">section&nbsp;7.2</a>, mais nous pouvons commencer avec nos tests du mot de passe crypté en notant que le mot de passe crypté devrait au moins <em>exister</em>. Nous pouvons tester cela en utilisant la méthode Ruby <code>respond_to?</code> (<em>répond_à&nbsp;?</em> ), qui accepte un symbole et retourne <code>true</code> (<em>vrai</em>) si l'objet répond à la méthode ou l'attribut donné et <code>false</code> (<em>faux</em>) dans le cas contraire&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console --sandbox</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">respond_to?</span><span class="p">(</span><span class="ss">:password</span><span class="p">)</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">respond_to?</span><span class="p">(</span><span class="ss">:encrypted_password</span><span class="p">)</span>
<span class="go">=&gt; false</span>
</pre></div>
</div>


<p>Nous pouvons tester l'existence d'un attribut <code>encrypted_password</code> avec le code de l'<a class="ref" href="modeling-and-viewing-users-two#code:respond_to_encrypted_password">extrait&nbsp;7.3</a>, qui utilise l'<em>helper</em> de méthode RSpec <code>respond_to</code>.</p>

<div class="label" id="code:respond_to_encrypted_password"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 7.3.</span> <span class="description">Tester l'existence d'un attribut <code>encrypted_password</code>. <br /> <code>spec/models/user_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;password encryption&quot;</span> <span class="k">do</span>

    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="vi">@attr</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;devrait avoir un attribut  mot de passe crypté&quot;</span> <span class="k">do</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:encrypted_password</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Notez que dans le bloc <code>before(:each)</code> nous <em>créons</em> un utilisateur, plutôt que d'appeler juste la méthode <code>User.new</code>. Nous pourrions en fait faire réussir ce test en utilisant <code>User.new</code>, mais (comme nous le verrons dans un instant) <em>définir</em> le mot de passe crypté exigera que l'utilisateur soit enregistré dans la base de données. En utilisant <code>create!</code> dans ce premier cas ne crée pas de dommage, et le placer dans <code>before(:each)</code> nous permettra de garder tous les tests du mot de passe crypté dans un seul bloc <code>describe</code>.</p>

<p>Pour obtenir la réussite de ce test, nous aurons besoin d'une migration pour ajouter l'attribut <code>encrypted_password</code> à la table <code>users</code> (<em>utilisateurs</em>)&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate migration add_password_to_users encrypted_password:string
</pre></div>
</div>


<p>Ici le premier argument est le nom de la migration, et nous avons aussi fourni un second argument avec le nom et le type d'attribut que nous voulons créer (comparez cela avec la génération originale de la table <code>users</code> de l'<a class="ref" href="modeling-and-viewing-users-one#code:generate_user_model">extrait&nbsp;6.1</a>). Nous pouvons choisir le nom de migration que nous voulons, mais il est pratique de terminer le nom par <code>_to_users</code> (<em>pour_users</em>) pour que dans ce cas Rails puisse automatiquement construire une migration qui ajoute les colonnes à la table <code>users</code>. Plus encore, en incluant le second argument, nous donnons assez d'information à Rails pour construire entièrement la migration pour nous, comme le montre l'<a class="ref" href="modeling-and-viewing-users-two#code:password_migration">extrait&nbsp;7.4</a>.</p>

<div class="label" id="code:password_migration"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 7.4.</span> <span class="description">La migration pour ajouter la colonne <code>encrypted_password</code> à la table <code>users</code>. <br /> <code>db/migrate/&lt;timestamp&gt;_add_password_to_users.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">AddPasswordToUsers</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">up</span>
    <span class="n">add_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:encrypted_password</span><span class="p">,</span> <span class="ss">:string</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">down</span>
    <span class="n">remove_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:encrypted_password</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Ce code utilise la méthode <code>add_column</code> (<em>ajouter_colonne</em>) pour ajouter la colonne <code>encrypted_password</code> à la table <code>users</code> (et la méthode complémentaire <code>remove_column</code> pour la supprimer quand nous migrons la base en arrière). Le résultat est le modèle de données montré dans l'<a class="ref" href="modeling-and-viewing-users-two#fig:user_model_password">illustration&nbsp;7.2</a>.</p>

<div class="label" id="fig:user_model_password"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_model_password.png" alt="user_model_password" /></span></div><div class="caption"><span class="header">Illustration 7.2: </span><span class="description">Le modèle User avec un attribut mot de passe (crypté) ajouté (version anglaise).</span></div></div>


<p>Si nous jouons maintenant la migration et préparons le test de la base de données, le test devrait réussir, puisque le modèle User model répondra à l'attribut <code>encrypted_password</code> (assurez-vous de fermer toutes les consoles Rails lancées dans le «&nbsp;bac à sable&nbsp;» (<em>sandbox</em>)&nbsp;; la <em>sandbox</em> verrouille la base de données et interdit les migrations).</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rake db:migrate
<span class="gp">$</span> rake db:test:prepare
</pre></div>
</div>


<p>Bien sûr, nous pouvons jouer toute la suite de tests avec <code>rspec spec/</code>, mais il est pratique parfois de jouer juste <em>une</em> RSpec, ce que nous pouvons faire avec le drapeau <code>-e</code> («&nbsp;exemple&nbsp;»)&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rspec spec/models/user_spec.rb <span class="se">\</span>
<span class="gp">&gt;</span> -e <span class="s2">&quot;devrait avoir un attribut mot de passe crypté&quot;</span>
<span class="go">.</span>

<span class="go">1 example, 0 failures</span>
</pre></div>
</div>


<div class="label" id="sec:an_active_record_callback"></div>


<h3><a id="sec:7.1.3" href="modeling-and-viewing-users-two#sec:an_active_record_callback" class="heading"><span class="number">7.1.3</span> <em>Fonction de rappel</em> dans l'Active Record</a></h3>


<p>Maintenant que notre modèle User possède un attribut pour consigner le mot de passe, nous devons nous arranger pour générer et sauver le mot de passe crypté quand Active Record enregistre l'utilisateur dans la base de données. Nous allons réaliser cela en utilisant une technique appelée une <a href="http://fr.wikipedia.org/wiki/Fonction_de_rappel"><rw>fonction de rappel</rw></a> (<a href="http://en.wikipedia.org/wiki/Callback_(computer_science)"><em>callback</em></a>), qui est une <rw>méthode</rw> invoquée à un point particulier de la vie de l'objet Active Record. Dans le cas présent, nous utiliserons la fonction de rappel <code>before_save</code> pour créer <code>encrypted_password</code> juste avant que l'utilisateur ne soit enregistré.<sup class="footnote" id="fnref:7.2"><a href="#fn:7.2">2</a></sup></p>

<p>Nous commençons avec un test pour l'attribut mot de passe crypté. Puisque nous avons différé les détails de l'implémentation &mdash;&nbsp;et, en particulier, la méthode de cryptage&nbsp;&mdash; à la <a class="ref" href="modeling-and-viewing-users-two#sec:secure_passwords">section&nbsp;7.2</a>, dans cette section nous allons seulement nous assurer que l'attribut <code>encrypted_password</code> d'un utilisateur enregistré n'est pas vierge. Nous faisons cela en combinant la méthode <code>blank?</code> sur les chaines de caractères (<a class="ref" href="rails-flavored-ruby#sec:a_class_of_our_own">section&nbsp;4.4.2</a>) avec la convention RSpec pour les méthodes booléennes (vue pour la première fois dans le contexte des méthodes <code>valid?</code>/<code>be_valid</code> dans l'<a class="ref" href="modeling-and-viewing-users-one#code:failing_validates_name_spec">extrait&nbsp;6.11</a>), rendant le test de l'<a class="ref" href="modeling-and-viewing-users-two#code:encrypted_password_not_empty_test">extrait&nbsp;7.5</a>.</p>

<div class="label" id="code:encrypted_password_not_empty_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 7.5.</span> <span class="description">Tester que l'attribut <code>encrypted_password</code> n'est pas vide. <br /> <code>spec/models/user_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;password encryption&quot;</span> <span class="k">do</span>

    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="vi">@attr</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">it</span> <span class="s2">&quot;devrait définir le mot de passe crypté&quot;</span> <span class="k">do</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">encrypted_password</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_blank</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Ce code vérifie que <code>encrypted_password.blank?</code> n'est pas vrai (<em>true</em>) en utilisant la construction <code>should_not be_blank</code>.</p>

<p>Pour faire réussir ce test, nous <em>déclarons</em> une fonction de rappel appelée <code>encrypt_password</code> en passant un symbole de ce nom à la méthode <code>before_save</code>, et définissons ensuite une méthode <code>encrypt_password</code> pour procéder au cryptage. Avec <code>before_save</code> en place, Active Record appellera automatiquement la méthode correspondante avant d'enregistrer la donnée. Le résultat est présenté dans l'<a class="ref" href="modeling-and-viewing-users-two#code:encrypt_password_callback">extrait&nbsp;7.6</a>.</p>

<div class="label" id="code:encrypt_password_callback"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 7.6.</span> <span class="description">Fonction de rappel <code>before_save</code> pour créer l'attribut <code>encrypted_password</code>. <br /> <code>app/models/user.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">validates</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:presence</span>     <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span>
                       <span class="ss">:confirmation</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span>
                       <span class="ss">:length</span>       <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:within</span> <span class="o">=&gt;</span> <span class="mi">6</span><span class="o">.</span><span class="n">.</span><span class="mi">40</span> <span class="p">}</span>

  <span class="n">before_save</span> <span class="ss">:encrypt_password</span>

  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">encrypt_password</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">encrypted_password</span> <span class="o">=</span> <span class="n">encrypt</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">encrypt</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
      <span class="n">string</span> <span class="c1"># Implémentation provisoire&nbsp;!</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Ici la <rw>fonction de rappel</rw> <code>encrypt_password</code> délègue en fait le cryptage à une méthode <code>encrypt</code>&nbsp;; comme signalé dans le commentaire, c'est seulement une implémentation provisoire &mdash;&nbsp;construit ainsi, l'<a class="ref" href="modeling-and-viewing-users-two#code:encrypt_password_callback">extrait&nbsp;7.6</a> met simplement le mot de passe crypté à la valeur du mot de passe non crypté, ce qui n'est pas notre but. Mais ça suffit pour faire réussir notre test, et nous ferons que la méthode <code>encrypt</code> procède réellement au cryptage à la <a class="ref" href="modeling-and-viewing-users-two#sec:secure_passwords">section&nbsp;7.2</a>.</p>

<p>Avant d'essayer de comprendre l'implémentation, notez d'abord que les méthodes de cryptage sont placées après le mot-clé <code>private</code>&nbsp;; à l'intérieur d'une classe Ruby, toutes les méthodes définies <em>après</em> le mot-clé <code>private</code> (<em>privé</em>) sont utilisées de façon <em>interne</em> par l'objet et ne sont pas destinées à l'utilisage <em>publique</em>.<sup class="footnote" id="fnref:7.3"><a href="#fn:7.3">3</a></sup> À titre d'exemple, nous pouvons tester l'objet User dans la console&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">encrypt_password</span>
<span class="go">NoMethodError: Attempt to call private method</span>
<span class="c1">(Traduction&nbsp;:</span>
<span class="c1">ErreurPasDeMethode&nbsp;: Tentative d'appel d'une méthode privée)</span>
</pre></div>
</div>


<p>Ici Ruby provoque une exception (une erreur) <code>NoMethodError</code> (<em>erreur d'absence de méthode</em>) en signalant par une alerte que la méthode <code>encrypt_password</code> est privée.</p>

<p>Dans le contexte présent, rendre les méthodes <code>encrypt_password</code> et <code>encrypt</code> privées n'est pas strictement nécessaire, mais c'est une bonne pratique de les rendre privées sauf si elles sont nécessaires à l'interface publique.<sup class="footnote" id="fnref:7.4"><a href="#fn:7.4">4</a></sup></p>

<p>Maintenant que nous comprenons le mot-clé <code>private</code>, jetons un coup d'œil à la méthode <code>encrypt_password</code>&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">encrypt_password</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">encrypted_password</span> <span class="o">=</span> <span class="n">encrypt</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>


<p>C'est une méthode en une ligne (donc du meilleur genre&nbsp;!), mais elle ne contient pas seulement une mais <em>deux</em> subtilités. <em>Primo</em> , le membre gauche de la déclaration (<code>self.encrypted_password</code>) assigne explicitement l'attribut <code>encrypted_password</code> en utilisant le mot-clé <code>self</code> (<em>soi-même</em>) (de la <a class="ref" href="rails-flavored-ruby#sec:a_class_of_our_own">section&nbsp;4.4.2</a> vous vous souvenez que la classe <code>self</code> se réfère à l'objet lui-même, ce qui pour le modèle User est simplement l'utilisateur lui-même). L'utilisation de <code>self</code> est <em>obligatoire</em> dans ce contexte&nbsp;; si nous ommettons <code>self</code> et que nous écrivons&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">encrypt_password</span>
  <span class="n">encrypted_password</span> <span class="o">=</span> <span class="n">encrypt</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>


<p>Ruby créera une <em>variable locale</em> appelée <code>encrypted_password</code>, ce qui n'est pas du tout ce que nous voulons (elle n'existerait et ne serait utilisable que dans la méthode <code>encrypt_password</code>).</p>

<p><em>Secondo</em>, le membre droit de la déclaration (<code>encrypt(password)</code>) appelle la méthode <code>encrypt</code> (<em>crypter</em>) sur la variable <code>password</code>&nbsp;; mais il n'y a pas de variable <code>password</code> en vue. Dans la console, nous devrions accéder à l'attribut mot de passe (<em>password</em>) au travers d'un objet utilisateur&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:password</span> <span class="o">=&gt;</span> <span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">password</span>
<span class="go">=&gt; &quot;foobar&quot;</span>
</pre></div>
</div>


<p>À l'intérieur de la classe User, l'objet utilisateur étant <code>self</code>, nous pourrions écrire&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">encrypt_password</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">encrypted_password</span> <span class="o">=</span> <span class="n">encrypt</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>


<p>… en analogie avec l'exemple en console, remplacez simplement  <code>user</code> par <code>self</code>. Mais le <code>self</code> est ici optionnel (dans un membre d'expression droit), donc pour la brièveté nous pouvons écrire simplement&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">encrypt_password</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">encrypted_password</span> <span class="o">=</span> <span class="n">encrypt</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>


<p>… comme dans l'<a class="ref" href="modeling-and-viewing-users-two#code:encrypt_password_callback">extrait&nbsp;7.6</a> ci-dessus (bien sûr, comme nous l'avons noté, le <code>self</code> n'est <em>pas</em> optionnel quand nous assignons la valeur d'un attribut (dans le membre gauche d'une expression), donc nous devons écrire <code>self.encrypted_password</code> dans ce cas).</p>

<div class="label" id="sec:secure_passwords"></div>


<h2><a id="sec:7.2" href="modeling-and-viewing-users-two#sec:secure_passwords" class="heading"><span class="number">7.2</span> Mots de passe sécurisés</a></h2>


<p>Avec le code de la <a class="ref" href="modeling-and-viewing-users-two#sec:insecure_passwords">section&nbsp;7.1</a>, en principe nous avons fini&nbsp;: bien que le mot de passe «&nbsp;crypté&nbsp;» soit le même que le mot de passe non crypté, la possibilité d'enregistrer un mot de passe <em>crypté</em> dans la base de données nous fournit les fondations nécessaires pour l'identification et l'authentification de l'utilisateur.<sup class="footnote" id="fnref:7.5"><a href="#fn:7.5">5</a></sup> Les normes de ce <em>Tutoriel Rails</em> doivent être beaucoup plus strictes, cependant&nbsp;: tout développeur web digne de ce nom doit savoir implémenter un système de mot de passe avec un <em>hachage sécurisé à sens unique</em> (<em>secure one-way hashing</em>). Dans cette section, nous construirons le matériel puisé de la <a class="ref" href="modeling-and-viewing-users-two#sec:insecure_passwords">section&nbsp;7.1</a> pour implémenter un tel système robuste de mot de passe.</p>

<div class="label" id="sec:a_secure_password_test"></div>


<h3><a id="sec:7.2.1" href="modeling-and-viewing-users-two#sec:a_secure_password_test" class="heading"><span class="number">7.2.1</span> Un test de mot de passe sécurisé</a></h3>


<p>Comme mentionné à la <a class="ref" href="modeling-and-viewing-users-two#sec:an_active_record_callback">section&nbsp;7.1.3</a>, toute la machinerie pour le cryptage du mot de passe sera soigneusement rangé dans la région <code>private</code> du modèle User, ce qui représente une difficulté particulière pour les tests. Nous aurions besoin d'une espèce d'<em>interface publique</em> que nous pourrions exposer au reste de l'application. Un des aspects utiles du «&nbsp;Développement Dirigé par les Tests&nbsp;» est que, en agissant comme un client pour coder notre application, les tests nous motivent à concevoir une interface utilisable dès le départ.</p>

<p>L'authentification des utilisateurs implique de pouvoir comparer la version cryptée d'un mot de passe soumis avec la version cryptée du mot de passe de l'utilisateur en question. Cela signifie que nous avons besoin de définir une méthode pour accomplir la comparaison, méthode que nous appellerons <code>has_password?</code> (<em>possède_un_motdepasse?</em> )&nbsp;; ce sera notre partie publique de l'interface pour la machinerie de cryptage.<sup class="footnote" id="fnref:7.6"><a href="#fn:7.6">6</a></sup> La méthode <code>has_password?</code> testera si l'utilisateur possède le même mot de passe que celui soumis lors de l'inscription (sera écrit au <a class="ref" href="sign-in-sign-out#top">chapitre&nbsp;9</a>)&nbsp;; un squelette de méthode pour <code>has_password?</code> est présenté dans l'<a class="ref" href="modeling-and-viewing-users-two#code:has_password_skeleton">extrait&nbsp;7.7</a>.</p>

<div class="label" id="code:has_password_skeleton"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 7.7.</span> <span class="description">Une méthode <code>has_password?</code> pour les utilisateurs. <br /> <code>app/models/user.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">before_save</span> <span class="ss">:encrypt_password</span>

  <span class="c1"># Retour true (vrai) si le mot de passe correspond.</span>
  <span class="k">def</span> <span class="nf">has_password?</span><span class="p">(</span><span class="n">password_soumis</span><span class="p">)</span>
    <span class="c1"># Compare encrypted_password avec la version cryptée de</span>
    <span class="c1"># password_soumis.</span>
  <span class="k">end</span>

  <span class="kp">private</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Avec cette méthode, nous pouvons écrire des tests comme dans l'<a class="ref" href="modeling-and-viewing-users-two#code:has_password_tests">extrait&nbsp;7.8</a>, qui utilise les méthodes RSpec <code>be_true</code> (<em>être_vrai</em>) et <code>be_false</code> (<em>être_faux</em>) pour tester que <code>has_password?</code> retourne <code>true</code> ou <code>false</code> dans les cas appropriés.</p>

<div class="label" id="code:has_password_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 7.8.</span> <span class="description">Tests pour la méthode <code>has_password?</code>. <br /> <code>spec/models/user_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;Cryptage du mot de passe&quot;</span> <span class="k">do</span>

    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="vi">@attr</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;Méthode has_password?&quot;</span> <span class="k">do</span>

      <span class="n">it</span> <span class="s2">&quot;doit retourner true si les mots de passe coïncident&quot;</span> <span class="k">do</span>
        <span class="vi">@user</span><span class="o">.</span><span class="n">has_password?</span><span class="p">(</span><span class="vi">@attr</span><span class="o">[</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="n">be_true</span>
      <span class="k">end</span>    

      <span class="n">it</span> <span class="s2">&quot;doit retourner false si les mots de passe divergent&quot;</span> <span class="k">do</span>
        <span class="vi">@user</span><span class="o">.</span><span class="n">has_password?</span><span class="p">(</span><span class="s2">&quot;invalide&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="n">be_false</span>
      <span class="k">end</span> 
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>À la <a class="ref" href="modeling-and-viewing-users-two#sec:implementing_has_password">section&nbsp;7.2.3</a>, nous complèterons l'implémentation de la méthode <code>has_password?</code> (et obtiendrons que le test réussisse dans le processus). Mais d'abord nous avons besoin d'en apprendre un peu plus sur la sécurisation des mots de passe.</p>

<div class="label" id="sec:secure_password_theory"></div>


<h3><a id="sec:7.2.2" href="modeling-and-viewing-users-two#sec:secure_password_theory" class="heading"><span class="number">7.2.2</span> Un peu de théorie sur la sécurisation des mots de passe</a></h3>


<p>L'idée de base d'un mot de passe crypté est simple&nbsp;: plutôt que d'enregistrer un mot de passe «&nbsp;en clair&nbsp;» dans la base de données (donc tel quel), nous enregistrons une chaine de caractères générée en utilisant une <em>fonction de hachage cryptographique</em> (<a href="http://en.wikipedia.org/wiki/Cryptographic_hash_function">cryptographic hash function</a>), qui est par essence irréversible, de telle sorte que même un hacker en possession de la version cryptée du mot de passe sera incapable d'en déduire l'original. Pour vérifier qu'un mot de passe soumis coïncide avec le mot de passe de l'utilisateur, nous cryptons d'abord la chaine de caractères soumise puis nous la comparons au mot de passe crypté enregistré. Rejoignons une session de console pour voir comment tout cela fonctionne&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="nb">require</span> <span class="s1">&#39;digest&#39;</span>
<span class="gp">&gt;&gt; </span><span class="k">def</span> <span class="nf">secure_hash</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
<span class="gp">&gt;&gt; </span>  <span class="no">Digest</span><span class="o">::</span><span class="no">SHA2</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">=&gt; nil</span>
<span class="gp">&gt;&gt; </span><span class="n">password</span> <span class="o">=</span> <span class="s2">&quot;secret&quot;</span>
<span class="go">=&gt; &quot;secret&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">encrypted_password</span> <span class="o">=</span> <span class="n">secure_hash</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
<span class="go">=&gt; &quot;2bb80d537b1da3e38bd30361aa855686bde0eacd7162fef6a25fe97bf527a25b&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">submitted_password</span> <span class="o">=</span> <span class="s2">&quot;secret&quot;</span>
<span class="go">=&gt; &quot;secret&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">encrypted_password</span> <span class="o">==</span> <span class="n">secure_hash</span><span class="p">(</span><span class="n">submitted_password</span><span class="p">)</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p>Ici nous avons défini une fonction appelée <code>secure_hash</code> qui utilise une fonction de hachage cryptographique appelée SHA2, qui fait partie de la <a href="http://en.wikipedia.org/wiki/SHA_hash_functions">famille SHA des fonctions de hachage</a>, que nous incluons dans Ruby par la librairie <code>digest</code>.<sup class="footnote" id="fnref:7.7"><a href="#fn:7.7">7</a></sup> Il n'est pas utile de savoir exactement comment fonctionnent ces fonctions&nbsp;; ce qui est important pour notre propos est qu'elles sont à sens unique&nbsp;: il n'y a aucune façon informatisable de découvrir que&nbsp;:</p>

<pre class="verbatim">2bb80d537b1da3e38bd30361aa855686bde0eacd7162fef6a25fe97bf527a25b</pre>


<p>… est le hachage SHA2 de la chaine <code>"secret"</code>.</p>

<p>Si vous y réfléchissez, cependant, nous avons toujours un problème&nbsp;: si un hacker entrait en possession des mots de passe hachés, il pourrait quand même avoir une chance de découvrir les mots de passe originaux. Par exemple, il pourrait supposer que nous utilisons SHA2 et ainsi écrire un programme pour comparer un hachage donné avec les valeurs possibles des mots de passe&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="nb">hash</span> <span class="o">=</span> <span class="s2">&quot;2bb80d537b1da3e38bd30361aa855686bde0eacd7162fef6a25fe97bf527a25b&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">secure_hash</span><span class="p">(</span><span class="s2">&quot;secede&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="nb">hash</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="n">secure_hash</span><span class="p">(</span><span class="s2">&quot;second&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="nb">hash</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="n">secure_hash</span><span class="p">(</span><span class="s2">&quot;secret&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="nb">hash</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p>Donc notre hacker obtient une correspondance &mdash;&nbsp;mauvaise nouvelle pour les utilisateurs qui utilisent le mot de passe <code>"secret"</code>. Cette technique est connue sous le nom <a href="http://en.wikipedia.org/wiki/Rainbow_attack"><em>rainbow attack</em></a> (<em>attaque arc-en-ciel</em>).</p>

<p>Pour faire échouer une attaque arc-en-ciel éventuelle, on peut utiliser un <a href="http://en.wikipedia.org/wiki/Salt_(cryptography)"><em>salt</em></a> (<em>un sel</em>, ou un <em>grain de sel</em>), une chaine de caractères qui sera différente pour chaque utilisateur.<sup class="footnote" id="fnref:7.8"><a href="#fn:7.8">8</a></sup> Une façon courante de s'assurer l'unicité (ou presque) est de hacher le temps courant (en <a href="http://en.wikipedia.org/wiki/Coordinated_Universal_Time">UTC</a> pour être indépendant de la zone de temps) avec le mot de passe, de telle sorte que deux utilisateurs auraient le même <em>sel</em> seulement s'ils s'étaient inscrits exactement en même temps <em>et</em> avaient exactement le même mot de passe (ce qui, en théorie, est improbable, et en pratique, impossible). Voyons comment cela fonctionne en utilisant la fonction <code>secure_hash</code> définie plus haut à la console&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">utc</span>
<span class="go">=&gt; Fri Jan 29 18:11:27 UTC 2010</span>
<span class="gp">&gt;&gt; </span><span class="n">password</span> <span class="o">=</span> <span class="s2">&quot;secret&quot;</span>
<span class="go">=&gt; &quot;secret&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">salt</span> <span class="o">=</span> <span class="n">secure_hash</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">utc</span><span class="si">}</span><span class="s2">--</span><span class="si">#{</span><span class="n">password</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="go">=&gt; &quot;d1a3eb8c9aab32ec19cfda810d2ab351873b5dca4e16e7f57b3c1932113314c8&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">encrypted_password</span> <span class="o">=</span> <span class="n">secure_hash</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">salt</span><span class="si">}</span><span class="s2">--</span><span class="si">#{</span><span class="n">password</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="go">=&gt; &quot;69a98a49b7fd103058639be84fb88c19c998c8ad3639cfc5deb458018561c847&quot;</span>
</pre></div>
</div>


<p>Dans les dernières lignes, nous avons haché le sel avec le mot de passe, pour retourner un mot de passe crypté qu'il est virtuellement impossible de cracker (pour la clarté, les arguments des fonctions de hachage sont souvent séparés par des «&nbsp;<tt class="verb">--</tt>&nbsp;»).</p>

<div class="label" id="sec:implementing_has_password"></div>


<h3><a id="sec:7.2.3" href="modeling-and-viewing-users-two#sec:implementing_has_password" class="heading"><span class="number">7.2.3</span> Implémenter <code>has_password?</code></a></h3>


<p>Ayant fini avec la théorie, nous sommes maintenant en mesure de procéder à l'implémentation. Nous allons aller de l'avant pour voir où nous allons. Chaque objet utilisateur connait son propre mot de passe crypté, donc pour le vérifier avec le mot de passe soumis, nous pouvons définir <code>has_password?</code> comme suit&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">has_password?</span><span class="p">(</span><span class="n">password_soumis</span><span class="p">)</span>
  <span class="n">encrypted_password</span> <span class="o">==</span> <span class="n">encrypt</span><span class="p">(</span><span class="n">password_soumis</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>


<p>Puisque nous cryptons le mot de passe soumis en utilisant le même <em>sel</em> que celui utilisé pour le mot de passe original, cette fonction retournera <em>vrai</em> si et seulement si le mot de passe soumis correspond.</p>

<p>Puisque comparer le mot de passe d'un utilisateur avec un mot de passe soumis implique de crypter le mot de passe soumis avec le <em>sel</em>, nous avons besoin d'enregistrer ce sel quelque part, donc la première étape va consister à ajouter une colonne <code>salt</code> à la table <code>users</code>&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate migration add_salt_to_users salt:string
</pre></div>
</div>


<p>Comme avec la migration <code>encrypted_password</code> (<a class="ref" href="modeling-and-viewing-users-two#sec:password_migration">section&nbsp;7.1.2</a>), cette migration porte un nom qui se finit par <code>_to_users</code> et passe un second argument contenant le nom de l'<rw>attribut</rw> et son <rw>type</rw> («&nbsp;String&nbsp;» ici, chaine de caractères), donc Rails construit automatiquement la bonne migration (<a class="ref" href="modeling-and-viewing-users-two#code:salt_migration">extrait&nbsp;7.9</a>).</p>

<div class="label" id="code:salt_migration"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 7.9.</span> <span class="description">La migration pour ajouter la colonne <code>salt</code> à la table <code>users</code>. <br /> <code>db/migrate/&lt;timestamp&gt;_add_salt_to_users.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">AddSaltToUsers</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">up</span>
    <span class="n">add_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:salt</span><span class="p">,</span> <span class="ss">:string</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">down</span>
    <span class="n">remove_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:salt</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Nous migrons alors la base de données et préparons le test de la base de données comme d'habitude&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rake db:migrate
<span class="gp">$</span> rake db:test:prepare
</pre></div>
</div>


<p>Le résultat est une base de données avec le modèle de données correspondant à l'<a class="ref" href="modeling-and-viewing-users-two#fig:user_model_salt">illustration&nbsp;7.3</a>.</p>

<div class="label" id="fig:user_model_salt"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_model_salt.png" alt="user_model_salt" /></span></div><div class="caption"><span class="header">Illustration 7.3: </span><span class="description">Le modèle User avec un <em>sel</em> ajouté.</span></div></div>


<p>Nous sommes enfin prêts pour l'implémentation complète. Quand nous avons vu la dernière fois la fonction <code>encrypt</code> (<a class="ref" href="modeling-and-viewing-users-two#code:encrypt_password_callback">extrait&nbsp;7.6</a>), elle ne faisait rien d'autre que retourner la chaine de caractère qu'elle recevait en argument. Dans l'idée de la <a class="ref" href="modeling-and-viewing-users-two#sec:secure_password_theory">section&nbsp;7.2.2</a>, nous sommes en mesure maintenant de renvoyer plutôt un hachage sécurisé (<a class="ref" href="modeling-and-viewing-users-two#code:has_password_with_encrypt">extrait&nbsp;7.10</a>).<sup class="footnote" id="fnref:7.9"><a href="#fn:7.9">9</a></sup></p>

<div class="label" id="code:has_password_with_encrypt"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 7.10.</span> <span class="description">La méthode <code>has_password?</code> avec un cryptage sécurisé. <br /> <code>app/models/user.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;digest&#39;</span>
<span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">before_save</span> <span class="ss">:encrypt_password</span>

  <span class="k">def</span> <span class="nf">has_password?</span><span class="p">(</span><span class="n">password_soumis</span><span class="p">)</span>
    <span class="n">encrypted_password</span> <span class="o">==</span> <span class="n">encrypt</span><span class="p">(</span><span class="n">password_soumis</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">encrypt_password</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">salt</span> <span class="o">=</span> <span class="n">make_salt</span> <span class="k">if</span> <span class="n">new_record?</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">encrypted_password</span> <span class="o">=</span> <span class="n">encrypt</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">encrypt</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
      <span class="n">secure_hash</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">salt</span><span class="si">}</span><span class="s2">--</span><span class="si">#{</span><span class="n">string</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">make_salt</span>
      <span class="n">secure_hash</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">utc</span><span class="si">}</span><span class="s2">--</span><span class="si">#{</span><span class="n">password</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">secure_hash</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
      <span class="no">Digest</span><span class="o">::</span><span class="no">SHA2</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Ce code contient les deux mêmes subtilités que celles mentionnées à la <a class="ref" href="modeling-and-viewing-users-two#sec:an_active_record_callback">section&nbsp;7.1.3</a>, nommément, l'assignement d'un attribut Active Record à l'aide de <code>self</code> à la ligne&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="nb">self</span><span class="o">.</span><span class="n">salt</span> <span class="o">=</span> <span class="n">make_salt</span> <span class="k">if</span> <span class="n">new_record?</span>
</pre></div>
</div>


<p>… et l'omission du mot-clé <code>self</code> dans le membre droit de ligne de code de la méthode <code>encrypt</code>&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">encrypt</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
  <span class="n">secure_hash</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">salt</span><span class="si">}</span><span class="s2">--</span><span class="si">#{</span><span class="n">string</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>


<p>Puisque nous sommes à l'intérieur de la classe, Ruby sait que <code>salt</code> se réfère à l'attribut <code>salt</code> de l'utilisateur.</p>

<p>Il est important de noter aussi l'utilisation de la méthode booléenne de l'Active Record <code>new_record?</code>, qui retourne true (<em>vrai</em>) si l'objet n'a pas encore été enregistré dans la base de données. Puisque le <em>sel</em> est un identifiant unique pour chaque utilisateur, nous ne voulons pas qu'il change chaque fois que l'utilisateur sera actualisé (comme à la <a class="ref" href="updating-showing-and-deleting-users#sec:updating_users">section&nbsp;10.1</a>), et en incluant <code>new_record?</code> nous nous assurons que le salt sera créé <em>seulement une fois</em>, à la création de l'utilisateur<sup class="footnote" id="fnref:7.10"><a href="#fn:7.10">10</a></sup> (cette subtilité n'importe pas pour le moment, mais elle importera quand nous implémenterons une fonctionnalité «&nbsp;se souvenir de moi&nbsp;» à l'identification à la <a class="ref" href="sign-in-sign-out#sec:remember_me">section&nbsp;9.3.2</a>).</p>

<p>À ce stade, les tests de l'<a class="ref" href="modeling-and-viewing-users-two#code:has_password_tests">extrait&nbsp;7.8</a> devraient réussir&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rspec spec/models/user_spec.rb -e <span class="s2">&quot;doit retourner true si les mots de passe coïncident&quot;</span>
<span class="go">.</span>

<span class="go">1 example, 0 failures</span>

<span class="gp">$</span> rspec spec/models/user_spec.rb <span class="se">\</span>
<span class="gp">&gt;</span> -e <span class="s2">&quot;doit retourner false si les mots de passe divergent&quot;</span>
<span class="go">.</span>

<span class="go">1 example, 0 failures</span>
</pre></div>
</div>


<p>Nous pourrions aussi jouer tous les exemples dans un bloc <code>describe</code> particulier, mais nous devons prendre soin d'<em>échapper</em> tous les caractères spéciaux dans les <a href="http://rubular.com/">expressions régulières</a> &mdash;&nbsp;dans ce cas, le point d'interrogation&nbsp;«&nbsp;<code>?</code>&nbsp;» de la méthode <code>"has_password?"</code>&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rspec spec/models/user_spec.rb -e <span class="s2">&quot;Méthode has_password\?&quot;</span>
<span class="go">Run filtered using {:full_description=&gt;/(?-mix:Méthode has_password\?)/}</span>
<span class="go">..</span>

<span class="go">2 examples, 0 failures</span>
</pre></div>
</div>


<p>L'échappement («&nbsp;\&nbsp;») avant le point d'interrogation assure que l'interpréteur d'expressions régulières RSpec interprète la chaine de caractère correctement, ce qui jouera les tests associés au bloc <code>describe</code> donné.</p>

<div class="label" id="sec:an_authenticate_method"></div>


<h3><a id="sec:7.2.4" href="modeling-and-viewing-users-two#sec:an_authenticate_method" class="heading"><span class="number">7.2.4</span> Une méthode d'authentification</a></h3>


<p>Avoir une méthode <code>has_password?</code> pour chaque utilisateur est une bonne chose, mais en elle-même elle n'est pas très utile. Nous terminons notre discussion sur les mots de passe en utilisant  <code>has_password?</code> pour écrire une méthode pour identifier un utilisateur par une combinaison email/mot de passe. Au <a class="ref" href="sign-in-sign-out#top">chapitre&nbsp;9</a>, nous utiliserons cette méthode <code>authenticate</code> en identifiant les utilisateurs de notre site.</p>

<p>Nous pouvons avoir une idée de ce fonctionnement à l'aide de la console. D'abord, nous créons un utilisateur, et ensuite nous récupérons cet utilisateur par l'adresse email pour vérifier qu'il a un mot de passe donné&nbsp;:<sup class="footnote" id="fnref:7.11"><a href="#fn:7.11">11</a></sup></p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console --sandbox</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">:nom</span> <span class="o">=&gt;</span> <span class="s2">&quot;Michael Hartl&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;mhartl@example.com&quot;</span><span class="p">,</span>
<span class="gp">?&gt; </span>             <span class="ss">:password</span> <span class="o">=&gt;</span> <span class="s2">&quot;foobar&quot;</span><span class="p">,</span> <span class="ss">:password_confirmation</span> <span class="o">=&gt;</span> <span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="s2">&quot;mhartl@example.com&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">has_password?</span><span class="p">(</span><span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p>En utilisant ces idées, écrivons une méthode qui retournera un utilisateur identifié si les mots de passe correspondent, et <em>nul</em> (<code>nil</code>) dans le cas contraire. Nous devrions pouvoir utiliser la méthode de classe <code>authenticate</code> en procédant ainsi&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="no">User</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">submitted_password</span><span class="p">)</span>
</pre></div>
</div>


<p>Nous commençons par les tests, que nous utiliserons pour spécifier le comportement que nous attendons de <code>User.authenticate</code>. Il y a trois choses à vérifier&nbsp;: <code>authenticate</code>&nbsp;(1) devrait retourner <code>nil</code> quand la combinaison email/mot de passe est invalide ou&nbsp;(2) quand aucun utilisateur n'existe avec l'adresse mail fournie, et&nbsp;(3) devrait retourner l'objet utilisateur lui-même en cas de succès. Avec ces informations, nous pouvons écrire les tests de <code>authenticate</code> comme dans l'<a class="ref" href="modeling-and-viewing-users-two#code:authenticate_method_tests">extrait&nbsp;7.11</a>.</p>

<div class="label" id="code:authenticate_method_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 7.11.</span> <span class="description">Tests for the <code>User.authenticate</code> method. <br /> <code>spec/models/user_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;password encryption&quot;</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;authenticate method&quot;</span> <span class="k">do</span>

      <span class="n">it</span> <span class="s2">&quot;devrait retourner nul en cas d'inéquation entre email/mot de passe&quot;</span> <span class="k">do</span>
        <span class="n">wrong_password_user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="vi">@attr</span><span class="o">[</span><span class="ss">:email</span><span class="o">]</span><span class="p">,</span> <span class="s2">&quot;wrongpass&quot;</span><span class="p">)</span>
        <span class="n">wrong_password_user</span><span class="o">.</span><span class="n">should</span> <span class="n">be_nil</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;devrait retourner nil quand un email ne correspond à aucun utilisateur&quot;</span> <span class="k">do</span>
        <span class="n">nonexistent_user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s2">&quot;bar@foo.com&quot;</span><span class="p">,</span> <span class="vi">@attr</span><span class="o">[</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
        <span class="n">nonexistent_user</span><span class="o">.</span><span class="n">should</span> <span class="n">be_nil</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;devrait retourner l'utilisateur si email/mot de passe correspondent&quot;</span> <span class="k">do</span>
        <span class="n">matching_user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="vi">@attr</span><span class="o">[</span><span class="ss">:email</span><span class="o">]</span><span class="p">,</span> <span class="vi">@attr</span><span class="o">[</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
        <span class="n">matching_user</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="vi">@user</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Nous sommes prêts maintenant pour l'implémentation, ce qui fera réussir nos tests et nous montrera comment définir en bonus une <em>méthode de classe</em>. Nous avons mentionné les <em>méthodes de classe</em> plusieurs fois auparavant, tout récemment à la <a class="ref" href="modeling-and-viewing-users-one#sec:base de données_migrations">section&nbsp;6.1.1</a>&nbsp;; une <em>méthode de classe</em> est simplement une méthode attachée à une classe, plutôt qu'à une instance de cette classe. Par exemple, <code>new</code> (<em>nouveau</em>), <code>find</code> (<em>trouver</em>) et <code>find_by_mail</code> (<em>trouver_par_le_mail</em>) sont toutes des méthodes de classe d'une classe User. En dehors de la classe, elles sont invoquées en utilisant le nom de la classe, comme dans <code>User.find</code>, mais à l'intérieur de la classe nous pouvons omettre le nom de la classe.</p>

<div class="label" id="sidebar:self"></div>


<div class="sidebar"><span class="title"><span class="header">Box 7.1.</span><span class="description"> Qu'est-ce que <code>self</code>&nbsp;?</span></span>
<p>Nous avons déjà expliqué que <code>self</code> est «&nbsp;l'objet lui-même&nbsp;», mais ce que ça signifie dépend du contexte. À l'intérieur d'une méthode ordinaire, <code>self</code> se réfère à une <em>instance</em> de la classe, c'est-à-dire à l'objet lui-même. Par exemple, dans l'<a class="ref" href="modeling-and-viewing-users-two#code:has_password_with_encrypt">extrait&nbsp;7.10</a>, <code>self</code> est un <em>utilisateur</em> (<em>user</em>)&nbsp;:</p>

<pre class="verbatim">  def encrypt_password
    self.salt = make_salt if new_record?
    self.encrypted_password = encrypt(password)
  end</pre>


<p>À l'intérieur de la méthode <code>encrypt_password</code>, <code>self</code> est l'objet utilisateur, donc <code>self.salt</code> est identique à <code>user.salt</code> en dehors de la méthode&nbsp;:</p>

<pre class="verbatim">  $ rails console
  &gt;&gt; user = User.first
  &gt;&gt; user.salt
  =&gt; &quot;d3b9af261c502947fbf32f78cb8179b16e62eabacf059451efee404328b2f537&quot;</pre>


<p>D'un autre côté, l'<a class="ref" href="modeling-and-viewing-users-two#code:authenticate_method">extrait&nbsp;7.12</a> montre la définition de <code>authenticate</code>, qui utilise <code>self</code> pour définir une <em>méthode de classe</em>&nbsp;; ici, <code>self</code> est la classe <code>User</code> elle-même&nbsp;:</p>

<pre class="verbatim">  def self.authenticate(email, submitted_password)
    .
    .
    .
  end</pre>


<p>Parce ce qu'elle est définie dans une classe <code>User</code>,  <code>authenticate</code> est invoquée directement sur le nom de classe <code>User</code>&nbsp;:</p>

<pre class="verbatim">  &gt;&gt; user = User.authenticate('example@railstutorial.org', 'foobar')
  &gt;&gt; user.nom
  =&gt; &quot;Utilisateur exemple&quot;</pre>


<p>Il est important de noter une façon différente mais équivalente de définir une méthode de classe <code>authenticate</code>  montrée dans l'<a class="ref" href="modeling-and-viewing-users-two#code:authenticate_method">extrait&nbsp;7.12</a>. D'abord, nous pourrions indiquer la classe <code>User</code> explicitement par son nom&nbsp;:</p>

<pre class="verbatim">  def User.authenticate(email, submitted_password)
    .
    .
    .
  end</pre>


<p>(Certaines personnes peuvent trouver cette syntaxe plus claire, mais elle n'est pas aussi correcte, idiomatiquement parlant.) Ensuite, nous pourrions utiliser le code suivant qui, franchement, m'explose le cerveau&nbsp;:</p>

<pre class="verbatim">  class &lt;&lt; self
    def authenticate(email, submitted_password)
      .
      .
      .
    end
  end</pre>


<p>Ce <code>class &lt;&lt; self</code> bizarre amorce un bloc dans lequel toutes les nouvelles méthodes sont automatiquement des méthodes de classe. Je trouve cette syntaxe plutôt déroutante, mais il est possible que vous la rencontriez dans le code d'autres programmeurs, donc ça vaut le coup de la connaitre (je recommande <a href="http://www.amazon.com/gp/product/1933988657?ie=UTF8&amp;tag=httpwwwrailst-20&amp;linkCode=as2&amp;camp=1789&amp;creative=9325&amp;creativeASIN=1933988657"><em>The Well-Grounded Rubyist</em></a> de David&nbsp;A. Black si vous voulez creuser des détails de Ruby tels que celui-ci).</p>
</div>


<p>La façon de définir une méthode de classe est d'utiliser le mot-clé <code>self</code> dans la définition de la méthode (ce <code>self</code> n'est pas le même que le <code>self</code> montré dans l'<a class="ref" href="modeling-and-viewing-users-two#code:has_password_with_encrypt">extrait&nbsp;7.10</a>&nbsp;; voyez le <a class="ref" href="modeling-and-viewing-users-two#sidebar:self">Box&nbsp;7.1</a>.) L'<a class="ref" href="modeling-and-viewing-users-two#code:authenticate_method">extrait&nbsp;7.12</a> montre cette construction dans le contexte de la méthode <code>authenticate</code>. Notez l'appel à <code>find_by_email</code>, dans laquelle nous omettons le nom explicite de classe <code>User</code> puisque cette méthode est déjà à l'intérieur de la classe <code>User</code>.</p>

<div class="label" id="code:authenticate_method"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 7.12.</span> <span class="description">La méthode <code>User.authenticate</code>. <br /> <code>app/models/user.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">has_password?</span><span class="p">(</span><span class="n">submitted_password</span><span class="p">)</span>
    <span class="n">encrypted_password</span> <span class="o">==</span> <span class="n">encrypt</span><span class="p">(</span><span class="n">submitted_password</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">authenticate</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">submitted_password</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">find_by_email</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
    <span class="k">return</span> <span class="kp">nil</span>  <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">nil?</span>
    <span class="k">return</span> <span class="n">user</span> <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">has_password?</span><span class="p">(</span><span class="n">submitted_password</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="kp">private</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Il existe plusieurs façons équivalentes d'écrire la méthode <code>authenticate</code>, mais je trouve l'implémentation ci-dessus la plus claire. Elle traite deux cas (email invalide et correspondance exacte) avec le mot-clé explicite <code>return</code>, et traite le troisième cas (inadéquation du mot de passe) implicitement, puisque dans ce cas nous atteignons la fin de la méthode, ce qui retourne automatiquement la valeur <code>nil</code> (<em>nulle</em>). Voyez la <a class="ref" href="modeling-and-viewing-users-two#sec:more_modeling_users_exercises">section&nbsp;7.5</a> pour quelques unes des autres manières possibles d'implémenter cette méthode.</p>

<div class="label" id="sec:better_user_views"></div>


<h2><a id="sec:7.3" href="modeling-and-viewing-users-two#sec:better_user_views" class="heading"><span class="number">7.3</span> Meilleures vues d'utilisateurs</a></h2>


<p>Maintenant que le modèle User est effectivement achevé,<sup class="footnote" id="fnref:7.12"><a href="#fn:7.12">12</a></sup> nous sommes en mesure d'ajouter un exemple d'utilisateur à la base de données de développement et de faire une page <code>show</code> (<em>montrer</em>, <em>afficher</em>) pour afficher certaines des informations de l'utilisateur. Chemin faisant, nous ajouterons quelques tests au spec du contrôleur User que nous avons entamé à la <a class="ref" href="filling-in-the-layout#sec:users_controller">section&nbsp;5.3.1</a>.</p>

<p>Avant de poursuivre, voyons où nous en sommes restés concernant le spec du contrôleur User (<a class="ref" href="modeling-and-viewing-users-two#code:get_new_user_spec_review">extrait&nbsp;7.13</a>). Nos tests pour la page d'affichage de l'utilisateur suivront cet exemple, mais nous devons comprendre que contrairement aux tests de l'action <code>new</code> les tests de l'action <code>show</code> exigeront l'utilisation d'instances du modèle User. Cela sera rendu possible grâce à une technique appelée <em>factories</em> (<em>usines</em>).</p>

<div class="label" id="code:get_new_user_spec_review"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 7.13.</span> <span class="description">Le spec du contrôleur User dans son état actuel. <br /> <code>spec/controllers/users_controller_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">UsersController</span> <span class="k">do</span>
  <span class="n">render_views</span>

  <span class="n">describe</span> <span class="s2">&quot;GET &#39;new&#39;&quot;</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">&quot;devrait réussir&quot;</span> <span class="k">do</span>
      <span class="n">get</span> <span class="s1">&#39;new&#39;</span>
      <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">be_success</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;devrait avoir le bon titre&quot;</span> <span class="k">do</span>
      <span class="n">get</span> <span class="s1">&#39;new&#39;</span>
      <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="s2">&quot;Sign up&quot;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="sec:tests_with_factories"></div>


<h3><a id="sec:7.3.1" href="modeling-and-viewing-users-two#sec:tests_with_factories" class="heading"><span class="number">7.3.1</span> Tester la page d'affichage de l'utilisateur (avec <em>factories</em>)</a></h3>


<p>Les tests pour le contrôleur User auront besoin des objets instances du modèle User, avec de préférence des valeurs pré-définies (pour ne pas avoir à les rentrer toutes «&nbsp;à la main&nbsp;»). Par exemple, comme vu à l'<a class="ref" href="modeling-and-viewing-users-two#code:user_show_reminder">extrait&nbsp;7.14</a>, l'action <code>show</code> du contrôleur Users a besoin d'une instance de la classe User, donc les tests de cette action vont exiger que nous créions d'une manière ou d'une autre une variable <code>@user</code>. Nous allons accomplir cela avec un <em>utilisateur d'usine</em>, qui est une façon pratique de définir un objet utilisateur et de l'insérer à l'intérieur de notre base de données de test.<sup class="footnote" id="fnref:7.13"><a href="#fn:7.13">13</a></sup></p>

<div class="label" id="code:user_show_reminder"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 7.14.</span> <span class="description">L'action utilisateur <code>show</code> de l'<a class="ref" href="modeling-and-viewing-users-one#code:user_show_action">extrait&nbsp;6.25</a>. <br /> <code>app/controllers/users_controller.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">show</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Nous allons utiliser les <em>données d'usine</em> générées par <a href="http://github.com/thoughtbot/factory_girl">Factory Girl</a> (<em>Fille d'Usine</em>),<sup class="footnote" id="fnref:7.14"><a href="#fn:7.14">14</a></sup>, un gem Ruby produit par les gens valeureux de <a href="http://thoughtbot.com/">thoughtbot</a>. Comme pour les autres gems Ruby, vous pouvez l'installer en ajoutant une ligne à votre <code>Gemfile</code> utilisé par Bundler (<a class="ref" href="modeling-and-viewing-users-two#code:gemfile_factory_girl">extrait&nbsp;7.15</a>) (puisque Factory Girl est nécessaire seulement pour les tests, nous l'incluons dans le groupe <code>:test</code>).</p>

<div class="label" id="code:gemfile_factory_girl"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 7.15.</span> <span class="description">Ajout de Factory Girl dans le <code>Gemfile</code>.</span>       
</div>
<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">&#39;http://rubygems.org&#39;</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="n">group</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">gem</span> <span class="s1">&#39;factory_girl_rails&#39;</span><span class="p">,</span> <span class="s1">&#39;1.0&#39;</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Puis installez-le comme d'habitude&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle install
</pre></div>
</div>


<p>Nous sommes maintenant prêts à créer le fichier <code>spec/factories.rb</code> et à définir un utilisateur d'usine, comme le montre l'<a class="ref" href="modeling-and-viewing-users-two#code:user_factory">extrait&nbsp;7.16</a>. En plaçant le fichier <code>factories.rb</code> dans le dossier <code>spec/</code>, nous nous arrangeons pour que RSpec charge <em>factories</em> automatiquement chaque fois que nous jouons les tests.</p>

<div class="label" id="code:user_factory"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 7.16.</span> <span class="description">Une factory pour simuler des objets de modèle User. <br /> <code>spec/factories.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="c1"># En utilisant le symbole &#39;:user&#39;, nous faisons que</span>
<span class="c1"># Factory Girl simule un modèle User.</span>
<span class="no">Factory</span><span class="o">.</span><span class="n">define</span> <span class="ss">:user</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
  <span class="n">user</span><span class="o">.</span><span class="n">nom</span>                  <span class="s2">&quot;Michael Hartl&quot;</span>
  <span class="n">user</span><span class="o">.</span><span class="n">email</span>                 <span class="s2">&quot;mhartl@example.com&quot;</span>
  <span class="n">user</span><span class="o">.</span><span class="n">password</span>              <span class="s2">&quot;foobar&quot;</span>
  <span class="n">user</span><span class="o">.</span><span class="n">password_confirmation</span> <span class="s2">&quot;foobar&quot;</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Avec la définition de l'<a class="ref" href="modeling-and-viewing-users-two#code:user_factory">extrait&nbsp;7.16</a>, nous pouvons créer un User d'usine dans les tests comme cela&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="vi">@user</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
</pre></div>
</div>


<p>Comme l'indique le commentaire de la première ligne de l'<a class="ref" href="modeling-and-viewing-users-two#code:user_factory">extrait&nbsp;7.16</a>, en utilisant le symbole <code>:user</code> nous nous assurons que Factory Girl devinera que nous voulons utiliser un modèle User, donc dans ce cas <code>@user</code> simulera une <rw>instance</rw> de la <rw>classe</rw> <code>User</code>.</p>

<p>Pour utiliser notre nouvel Utilisateur d'usine dans le spec du contrôleur Users, nous allons créer une variable <code>@user</code> dans le bloc <code>before(:each)</code> et ensuite <code>get</code> (<em>demander</em>) la page d'affichage et vérifier la réussite (tout comme nous l'avons fait avec la page <code>new</code> de l'<a class="ref" href="modeling-and-viewing-users-two#code:get_new_user_spec_review">extrait&nbsp;7.13</a>), tout en vérifiant aussi que l'action <code>show</code> récupère l'utilisateur correct de la base de données. Le résultat est présenté dans l'<a class="ref" href="modeling-and-viewing-users-two#code:get_show_test">extrait&nbsp;7.17</a>  (si vous utilisez Spork, vous avez peut-être à le redémarrer pour obtenir la réussite de ces tests).</p>

<div class="label" id="code:get_show_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 7.17.</span> <span class="description">Un test pour <code>get</code>ting (<em>obtenir</em> ) la page utilisateur <code>show</code>, avec un utilisateur d'usine. <br /> <code>spec/controllers/users_controller_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">UsersController</span> <span class="k">do</span>
  <span class="n">render_views</span>

  <span class="n">describe</span> <span class="s2">&quot;GET &#39;show&#39;&quot;</span> <span class="k">do</span>

    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;devrait réussir&quot;</span> <span class="k">do</span>
      <span class="n">get</span> <span class="ss">:show</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="vi">@user</span>
      <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">be_success</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;devrait trouver le bon utilisateur&quot;</span> <span class="k">do</span>
      <span class="n">get</span> <span class="ss">:show</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="vi">@user</span>
      <span class="n">assigns</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="vi">@user</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Hormis l'utilisation d'une usine, la réelle nouveauté ici est l'utilisation de <code>assigns(:user)</code>, qui est une fonctionnalité fournie par RSpec (via la librairie sous-jacente <tt>Test::Unit</tt>). La méthode <code>assigns</code> prend un argument symbolique (ici <code>:user</code>) et retourne la valeur qu'a la variable d'instance correspondante (ici <code>@user</code> &mdash;&nbsp;<code>:user</code> => <code>@user</code>) dans l'action concernée, ici l'action <code>show</code> du contrôleur <code>User</code>. En d'autres termes, dans l'<a class="ref" href="modeling-and-viewing-users-two#code:get_show_test">extrait&nbsp;7.17</a> le code&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="n">assigns</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
</pre></div>
</div>


<p>… retourne la valeur de la variable d'instance&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="vi">@user</span>
</pre></div>
</div>


<p>… dans l'action <code>show</code> du contrôleur des utilisateurs. Le test&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="n">assigns</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="vi">@user</span>
</pre></div>
</div>


<p>… vérifie alors que la variable récupérée de la base de données dans l'action correspond à l'instance <code>@user</code> créée par Factory Girl. Il est important de noter que tous les programmeurs Rails n'utilisent pas <code>assigns</code> dans ce contexte, lui préférant parfois la technique appelée le <em>stubbing</em> (<a class="ref" href="modeling-and-viewing-users-two#sidebar:stubbing">Box&nbsp;7.2</a>).</p>

<div class="label" id="sidebar:stubbing"></div>


<div class="sidebar"><span class="title"><span class="header">Box 7.2.</span><span class="description"><code>Stub</code>er ou ne pas <code>Stub</code>er&nbsp;?</span></span>
<p>Le code de l'<a class="ref" href="modeling-and-viewing-users-two#code:get_show_test">extrait&nbsp;7.17</a> s'appuie sur une méthode <code>User.find</code> dans l'action du contrôleur pour récupérer le bon utilisateur de la base de données de test. Une autre manière d'atteindre le même résultat consiste à utiliser une technique appelée <em>stubbing</em>, à l'aide de la méthode RSpec <code>stub!</code>&nbsp;:</p>

<pre class="verbatim">  before(:each)
    @user = Factory(:user)
    User.stub!(:find, @user.id).and_return(@user)
  end</pre>


<p>Ce code s'assure que tout appel à <code>User.find</code> avec l'<code>id</code> donné retournera <code>@user</code>. Puisque c'est juste ce que nous avons dans le code de l'application (<a class="ref" href="modeling-and-viewing-users-two#code:user_show_reminder">extrait&nbsp;7.14</a>), le stub fera que RSpec va intercepter l'appel à <code>User.find</code> et, au lieu de se connecter à la base de données, retournera plutôt <code>@user</code>.</p>

<p>De nombreux programmeurs Rails, spécialement ceux utilisant RSpec, préfèrent cette approche parce qu'elle sépare les tests des controleurs de la couche modèle. En vérité, la <a href="http://railstutorial.org/book?version=2.3">version Rails 2.3 de ce livre</a> utilise stubs, aux côté des techniques très proches de <em>message expectations</em>. Après avoir acquis plus d'expérience avec les stubs et les expectations, et spécialement après avoir répondu à beaucoup de questions de lecteurs du <em>Tutoriel de la version Rails 2.3</em> déroutés par ces problèmes, j'en suis arrivé à la conclusion que le stubbing et les techniques afférentes ne valaient pas tous ces troubles.</p>

<p>Déterminer quand <em>stub</em>er les choses est difficile, et les <em>messages expectations</em> sont incroyablement subtils et sujets à erreurs (voir par exemple le <a href="http://railstutorial.org/chapters/sign-up?version=2.3#sidebar:expectation_subtlety">Box&nbsp;8.1 dans le Tutoriel <em>Rails 2.3 Tutorial</em></a>). On fait souvent l'objection suivante&nbsp;: «&nbsp;Mais maintenant les tests de contrôleur se connectent à la base de données de test&nbsp;!&nbsp;». Ce à quoi je réponds maintenant par&nbsp;: «&nbsp;Et alors&nbsp;?&nbsp;» Dans mon expérience ça n'a jamais compté. Je ne vois aucune impérieuse raison de ne pas atteindre la couche modèle dans les tests contrôleur, spécialement quand ça conduit à des tests plus simples. Si vous êtes intéressé par l'apprentissage du stubbing et des techniques de <em>message expectation</em>, je recommande la lecture du <a href="http://railstutorial.org/book?version=2.3"><em>Tutoriel Ruby on Rails 2.3</em></a>. Sinon, je suggère de ne pas trop se soucier d'une séparation complète entre couche modèle et couche contrôleur dans les tests Rails. Bien que les tests contrôleur dans la suite de ce livre se connecteront à la base de données, à un niveau <em>conceptuel</em>, la partie du MVC testée restera toujours claire.</p>

<p>En passant, les tests devraient en principe se jouer plus vite quand les contrôleurs ne se connectent pas à la base de données, et pour la suite de tests de l'application exemple complète de ce <em>Tutoriel Rails</em>, ils se connecteront &mdash;&nbsp;en environ deux dixièmes de seconde.</p>
</div>


<p>Il reste deux autres détails dans l'<a class="ref" href="modeling-and-viewing-users-two#code:get_show_test">extrait&nbsp;7.17</a> qu'il convient de souligner. D'abord, dans l'appel de <code>get</code>, le test utilise le <em>symbole</em> <code>:show</code> au lieu de la chaine <code>&rsquo;show&rsquo;</code>, ce qui est différent de la convention des autres tests (par exemple, dans l'<a class="ref" href="static-pages#code:default_pages_controller_spec">extrait&nbsp;3.11</a> nous avons écrit <code>get &rsquo;home&rsquo;</code>). Les deux, </p>

<div class="code"><div class="highlight"><pre><span class="n">get</span> <span class="ss">:show</span>
</pre></div>
</div>


<p>… et</p>

<div class="code"><div class="highlight"><pre><span class="n">get</span> <span class="s1">&#39;show&#39;</span>
</pre></div>
</div>


<p>… font la même chose, mais en testant les actions REST canoniques (<a class="ref" href="modeling-and-viewing-users-one#table:RESTful_users">Table&nbsp;6.2</a>) je préfère utiliser des symboles, ce qui pour d'évidentes raisons semble plus naturel dans ce contexte.<sup class="footnote" id="fnref:7.15"><a href="#fn:7.15">15</a></sup> Ensuite, notez que la valeur de la clé de hachage <code>:id</code>, au lieu d'être l'attribut <code>id</code> de l'utilisateur <code>@user</code>, est l'objet user lui-même&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="n">get</span> <span class="ss">:show</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="vi">@user</span>
</pre></div>
</div>

<p>Nous pourrions tout autant utiliser le code&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="n">get</span> <span class="ss">:show</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="o">.</span><span class="n">id</span>
</pre></div>
</div>


<p>… pour accomplir la même chose, mais dans ce contexte Rails convertit automatiquement l'objet user vers l'<code>id</code> correspondant.<sup class="footnote" id="fnref:7.16"><a href="#fn:7.16">16</a></sup> Utiliser la construction plus succincte&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="n">get</span> <span class="ss">:show</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="vi">@user</span>
</pre></div>
</div>


<p>… est un idiome Rails très fréquent.</p>

<p>À cause du code que nous avons ajouté dans l'<a class="ref" href="modeling-and-viewing-users-one#code:user_show_action">extrait&nbsp;6.25</a>, le test de cette section réussit déjà. Si vous êtes un peu paranoïaque, vous pouvez ex-commenter la ligne&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</pre></div>
</div>


<p>… et vérifier que le test échoue, puis dé-commenter pour réussir à nouveau (nous sommes passés par le même processus une fois auparavant, à la <a class="ref" href="modeling-and-viewing-users-one#sec:presence_validation">section&nbsp;6.2.1</a>.)</p>

<div class="label" id="sec:a_name_and_a_gravatar"></div>


<h3><a id="sec:7.3.2" href="modeling-and-viewing-users-two#sec:a_name_and_a_gravatar" class="heading"><span class="number">7.3.2</span> Un nom et un Gravatar</a></h3>


<p>Dans cette section, nous allons améliorer le look de notre page d'affichage de l'utilisateur en ajoutant une entête avec le nom de l'utilisateur et une image de profil. C'est une de ces situations où je peux aller [(either way on)(de toute façon)] le «&nbsp;développement conduit par les tests&nbsp;», et souvent en construisant les vues j'expérimenterai le code HTML avant de me soucier des tests. Restons pour le moment avec le thème TDD, et testons un entête de haut niveau (balise <code>h1</code>) contenant le nom de l'utilisateur et une balise <code>img</code> de classe <code>gravatar</code> (nous expliquerons dans un instant le sens de cette seconde partie).</p>

<p>Pour voir une page d'affichage de l'utilisateur fonctionner dans le navigateur, nous aurons besoin de créer un exemple d'utilisateur dans la base de données en mode développement. Pour ce faire, démarrons la console (<em>pas</em> dans le bac à sable cette fois) et créons un utilisateur&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rake db:reset</span>
<span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">:nom</span> <span class="o">=&gt;</span> <span class="s2">&quot;Utilisateur exemple&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;user@example.com&quot;</span><span class="p">,</span>
<span class="gp">?&gt; </span>             <span class="ss">:password</span> <span class="o">=&gt;</span> <span class="s2">&quot;foobar&quot;</span><span class="p">,</span> <span class="ss">:password_confirmation</span> <span class="o">=&gt;</span> <span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
</pre></div>
</div>


<p>Les tests de cette section sont similaires aux tests de la page <code>new</code> vus dans l'<a class="ref" href="filling-in-the-layout#code:signup_title_test">extrait&nbsp;5.26</a>. En particulier, nous utilisons la méthode <code>have_selector</code> pour vérifier le titre et le contenu de la balise&nbsp;<code>h1</code>, comme le montre l'<a class="ref" href="modeling-and-viewing-users-two#code:user_show_tests">extrait&nbsp;7.18</a>.</p>

<div class="label" id="code:user_show_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 7.18.</span> <span class="description">Tests pour la page d'affichage de l'utilisateur. <br /> <code>spec/controllers/users_controller_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">UsersController</span> <span class="k">do</span>
  <span class="n">render_views</span>

  <span class="n">describe</span> <span class="s2">&quot;GET &#39;show&#39;&quot;</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">it</span> <span class="s2">&quot;devrait avoir le bon titre&quot;</span> <span class="k">do</span>
      <span class="n">get</span> <span class="ss">:show</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="vi">@user</span>
      <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="o">.</span><span class="n">nom</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;devrait inclure le nom de l'utilisateur&quot;</span> <span class="k">do</span>
      <span class="n">get</span> <span class="ss">:show</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="vi">@user</span>
      <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;h1&quot;</span><span class="p">,</span> <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="o">.</span><span class="n">nom</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;devrait avoir une image de profil&quot;</span> <span class="k">do</span>
      <span class="n">get</span> <span class="ss">:show</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="vi">@user</span>
      <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;h1&gt;img&quot;</span><span class="p">,</span> <span class="ss">:class</span> <span class="o">=&gt;</span> <span class="s2">&quot;gravatar&quot;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Ici la méthode RSpec <code>have_selector</code> vérifie la présence des balises <code>title</code> (<em>titre</em>) et <code>h1</code> contenant le nom de l'utilisateur. Le troisième exemple introduit un nouvel élément par le code <code>h1&gt;img</code>, qui fait que la balise <code>img</code> est <em>à l'intérieur</em> de la balise <code>h1</code>..<sup class="footnote" id="fnref:7.17"><a href="#fn:7.17">17</a></sup> En addition, nous voyons que <code>have_selector</code> peut prendre une option <code>:class</code> pour tester la classe CSS de l'élément en question.</p>

<p>Nous pouvons obtenir la réussite du test en définissant la variable <code>@titre</code> à utiliser dans l'<em>helper</em> <code>title</code> (<a class="ref" href="rails-flavored-ruby#sec:title_helper">section&nbsp;4.1.1</a>), dans ce cas en l'assignant à la valeur du nom de l'utilisateur (<a class="ref" href="modeling-and-viewing-users-two#code:user_show_title">extrait&nbsp;7.19</a>).</p>

<div class="label" id="code:user_show_title"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 7.19.</span> <span class="description">Un titre pour la page d'affichage de l'utilisateur. <br /> <code>app/controllers/users_controller.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">show</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
    <span class="vi">@titre</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">nom</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Ce code introduit un problème potentiel&nbsp;: un utilisateur peut entrer un nom avec du code malveillant &mdash;&nbsp;appelé attaque <a href="http://en.wikipedia.org/wiki/Cross-site_scripting">cross-site scripting</a>&nbsp;&mdash; qui serait injecté à l'intérieur de l'application par l'helper <code>title</code> défini dans l'<a class="ref" href="rails-flavored-ruby#code:title_helper">extrait&nbsp;4.2</a>. Avant Rails&nbsp;3, la solution consistait à <em>échapper</em> les codes potentiellement problématiques en utilisant la méthode&nbsp;<code>h</code> (racourci pour <code>html_escape</code>), mais avec Rails&nbsp;3.0, tout le code Ruby embarqué est maintenant échappé par défaut.<sup class="footnote" id="fnref:7.18"><a href="#fn:7.18">18</a></sup> Par exemple, si un utilisateur essayait d'injecter un programme JavaScript malveillant en utilisant <code>&lt;script&gt;</code> dans son nom, l'échappement HTML automatique le convertirait en <code>&amp;lt;script&amp;gt;</code>, le rendant complètement inoffensif.</p>

<p>Voyons maintenant les autres tests. Créer un <code>h1</code> à partir du nom de l'utilisateur (échappé) est facile (<a class="ref" href="modeling-and-viewing-users-two#code:user_show_view_with_name">extrait&nbsp;7.20</a>).</p>

<div class="label" id="code:user_show_view_with_name"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 7.20.</span> <span class="description">L'utilisateur voir la vue aec un nom d'utilisateur. <br /> <code>app/views/users/show.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>
  <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">nom</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/h1&gt;</span>
</pre></div>
</div></div>


<p>Faire réussir le test de <code>img</code> est plus astucieux. La première étape consiste à installer le gem <a href="http://github.com/mdeering/gravatar_image_tag"><tt>gravatar_image_tag</tt></a> pour traiter chaque <a href="http://en.gravatar.com/">Gravatar</a> d'utilisateur,<sup class="footnote" id="fnref:7.19"><a href="#fn:7.19">19</a></sup> qui est un «&nbsp;avatar reconnu globalement&nbsp;».<sup class="footnote" id="fnref:7.20"><a href="#fn:7.20">20</a></sup> Comme d'habitude, nous incluerons la dépendance gem dans le fichier <code>Gemfile</code> (<a class="ref" href="modeling-and-viewing-users-two#code:gemfile_gravatar">extrait&nbsp;7.21</a>).</p>

<div class="label" id="code:gemfile_gravatar"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 7.21.</span> <span class="description">Ajout du gem Gravatar au <code>Gemfile</code>.</span>       
</div>
<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">&#39;http://rubygems.org&#39;</span>

<span class="n">gem</span> <span class="s1">&#39;rails&#39;</span><span class="p">,</span> <span class="s1">&#39;3.0.7&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;sqlite3-ruby&#39;</span><span class="p">,</span> <span class="s1">&#39;1.3.2&#39;</span><span class="p">,</span> <span class="ss">:require</span> <span class="o">=&gt;</span> <span class="s1">&#39;sqlite3&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;gravatar_image_tag&#39;</span><span class="p">,</span> <span class="s1">&#39;1.0.0.pre2&#39;</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
</pre></div>
</div></div>


<p>Installez-le avec <code>bundle</code>&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle install
</pre></div>
</div>


<p>Vous devrez peut-être aussi redémarrer votre serveur web ici pour charger le nouveau gem Gravatar proprement.</p>

<p>Les <em>gravatars</em> sont une façon pratique d'inclure des images de profil utilisateur sans avoir à gérer la difficulté des téléchargement d'images, leur redimensionnement et leur sauvegarde.<sup class="footnote" id="fnref:7.21"><a href="#fn:7.21">21</a></sup> Chaque <em>gravatar</em> est associé à une adresse email, donc le gem Gravatar est fourni avec une méthode d'<em>helper</em> appelée <code>gravatar_image_tag</code> qui prend une adresse mail comme argument&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">gravatar_image_tag</span> <span class="s1">&#39;example@railstutorial.org&#39;</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>Pour le moment, nous utilisons cela directement dans notre vue affichant l'utilisateur, comme le montre l'<a class="ref" href="modeling-and-viewing-users-two#code:user_show_view_with_gravatar">extrait&nbsp;7.22</a> (nous construirons une méthode <em>helper</em> dans un moment). Le résultat apparait dans l'<a class="ref" href="modeling-and-viewing-users-two#fig:user_show_default_gravatar_rails_3">illustration&nbsp;7.4</a>, qui montre notre exemple avec l'image gravatar par défaut.</p>

<div class="label" id="code:user_show_view_with_gravatar"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 7.22.</span> <span class="description">La vue d'affichage de l'utilisateur avec un nom et un gravatar. <br /> <code>app/views/users/show.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">gravatar_image_tag</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">nom</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/h1&gt;</span>
</pre></div>
</div></div>




<div class="label" id="fig:user_show_default_gravatar_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_show_default_gravatar_rails_3.png" alt="user_show_default_gravatar_rails_3" /></span></div><div class="caption"><span class="header">Illustration 7.4: </span><span class="description">La page initiale d'affichage de l'utilisateur  <a href="http://localhost:3000/users/1"><tt>/users/1</tt></a> avec le gravatar par défaut.&nbsp;<a href="http://railstutorial.org/images/figures/user_show_default_gravatar_rails_3-full.png">(taille normale)</a></span></div></div>


<p>Ce fonctionnement de Gravatar peut sembler magique, donc rejoignons la console pour comprendre un peu mieux ce qui se passe&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">first</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">update_attributes</span><span class="p">(</span><span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;example@railstutorial.org&quot;</span><span class="p">,</span>
<span class="gp">?&gt; </span>                       <span class="ss">:password</span> <span class="o">=&gt;</span> <span class="s2">&quot;foobar&quot;</span><span class="p">,</span>
<span class="gp">?&gt; </span>                       <span class="ss">:password_confirmation</span> <span class="o">=&gt;</span> <span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p>Notez que nous pouvons récupérer le premier (et, à ce point, le seul) utilisateur de la base de données avec la méthode pratique <code>User.first</code>. Dans l'étape <code>update_attributes</code> nous avons ré-assigné l'adresse mail de l'utilisateur, en la changeant en <code>example@railstutorial.org</code>. Comme vous pouvez le voir dans l'<a class="ref" href="modeling-and-viewing-users-two#fig:user_show_railstutorial_gravatar_rails_3">illustration&nbsp;7.5</a>, ce changement produit l'affichage d'un nouveau gravatar&nbsp;: le logo du tutoriel Rails. Ce qui se passe, c'est que Gravatar travaille en associant image et adresse email&nbsp;; puisque <code>user@example.com</code> est une adresse invalide (le domaine <a href="http://example.com/">example.com</a> est réservé aux exemples), il n'y a pas de gravatar associé à cette adresse. Mais à mon compte Gravatar j'ai associé l'adresse <code>example@railstutorial.org</code> au logo du tutoriel Rails, donc en actualisant l'utilisateur exemple avec l'adresse mail, le gravatar change automatiquement.</p>

<div class="label" id="fig:user_show_railstutorial_gravatar_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_show_railstutorial_gravatar_rails_3.png" alt="user_show_railstutorial_gravatar_rails_3" /></span></div><div class="caption"><span class="header">Illustration 7.5: </span><span class="description">La page d'affichage de l'utilisateur  <a href="http://localhost:3000/users/1"><tt>/users/1</tt></a> avec le gravatar du Tutoriel Rails.&nbsp;<a href="http://railstutorial.org/images/figures/user_show_railstutorial_gravatar_rails_3-full.png">(taille normale)</a></span></div></div>




<div class="label" id="sec:a_gravatar_helper"></div>


<h4><a id="sec:7.3.2.1" href="modeling-and-viewing-users-two#sec:a_gravatar_helper" class="heading">Un helper Gravatar</a></h4>


<p>À ce point, le gravatar s'affiche proprement, mais l'exemple final de l'<a class="ref" href="modeling-and-viewing-users-two#code:user_show_tests">extrait&nbsp;7.18</a> ne réussit toujours pas. C'est parce que la classe CSS <code>"gravatar"</code>, que nous voulons utiliser pour styliser les gravatars en CSS, n'est pas encore spécifier dans la balise <code>img</code> du gravatar. Pour faire réussir le test, nous devons ajouter l'option adéquate à la méthode <code>gravatar_image_tag</code>&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">gravatar_image_tag</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="ss">:class</span> <span class="o">=&gt;</span> <span class="s2">&quot;gravatar&quot;</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>D'un autre côté, puisque nous anticipons le fait que les gravatars apparaitront à différents endroits de notre applicatin, il serait répétitif de mettre la classe chaque fois à la main. Ce serait mieux de faire une méthode d'<em>helper</em> qui élimine préventivement cette duplication..</p>

<p>Cette situation peut vous rappeler de la répétition de la base du titre («&nbsp;Simple application du Tutoriel Ruby on Rails&nbsp;»), que nous avons résolue avec l'helper <code>titre</code> dans l'helper de l'application (<a class="ref" href="rails-flavored-ruby#code:title_helper">extrait&nbsp;4.2</a>). La solution ici est la même&nbsp;; puisque les gravatars sont naturellement associés avec les utilisaeurs, nous allons définir une méthode <code>gravatar_for</code> (<em>gravatar_pour</em>) dans le helper Users (le choix d'utiliser le helper Users plutôt plutôt que le helper Application est juste pour une commodité conceptuelle&nbsp;; Rails rend tous les helpers accessible dans les vues). Le résultat sera un code concis comme&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="vi">@user</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>L'helper <code>gravatar_for</code> devrait prendre un objet <code>user</code> et passer alors quelques options par défaut à l'helper <code>gravatar_image_tag</code>. L'implémentation apparait dans l'<a class="ref" href="modeling-and-viewing-users-two#code:gravatar_for_helper">extrait&nbsp;7.23</a>.</p>

<div class="label" id="code:gravatar_for_helper"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 7.23.</span> <span class="description">Définir une méthode d'helper <code>gravatar_for</code>. <br /> <code>app/helpers/users_helper.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">UsersHelper</span>

  <span class="k">def</span> <span class="nf">gravatar_for</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:size</span> <span class="o">=&gt;</span> <span class="mi">50</span> <span class="p">})</span>
    <span class="n">gravatar_image_tag</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">downcase</span><span class="p">,</span> <span class="ss">:alt</span> <span class="o">=&gt;</span> <span class="n">user</span><span class="o">.</span><span class="n">nom</span><span class="p">,</span>
                                            <span class="ss">:class</span> <span class="o">=&gt;</span> <span class="s1">&#39;gravatar&#39;</span><span class="p">,</span>
                                            <span class="ss">:gravatar</span> <span class="o">=&gt;</span> <span class="n">options</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Le premier argument dans l'appel à <code>gravatar_image_tag</code> passe la version minuscule de l'adresse mail (en utilisant la méthode <code>downcase</code>).<sup class="footnote" id="fnref:7.22"><a href="#fn:7.22">22</a></sup> Alors la première optin pour <code>gravatar_image_tag</code> assigne le nom de l'utilisateur à l'attribut <code>alt</code> de la balise <code>img</code> (qui sera affiché sur les dispositifs qui ne peuvent pas rendre les images), tandis que la deuxième option définit la classe CSS pour le gravatar. La troisième option passe la table d'<code>options</code> en utilisant la clé <code>:gravatar</code>, qui (conformément à la documentation gem pour <a href="http://github.com/mdeering/gravatar_image_tag"><tt>gravatar_image_tag</tt></a>) est utilisée pour définir les options pour <code>gravatar_image_tag</code>. Notez que la définition de la fonction définit une <em>options par défaut</em><sup class="footnote" id="fnref:7.23"><a href="#fn:7.23">23</a></sup> pour la taille du gravatar<sup class="footnote" id="fnref:7.24"><a href="#fn:7.24">24</a></sup> en utilisant&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="n">option</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:size</span> <span class="o">=&gt;</span> <span class="mi">50</span> <span class="p">}</span>
</pre></div>
</div>


<p>Cela fixe la taille par défaut du gravatar à <tt>50x50</tt>, ce qui nous permet également de redéfinir la taille par défaut en utilisant un code comme&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">:size</span> <span class="o">=&gt;</span> <span class="mi">30</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>Si nous actualisons à présent le template d'affichage de l'utilisateur avec le code de l'<a class="ref" href="modeling-and-viewing-users-two#code:user_show_gravatar_for">extrait&nbsp;7.24</a>, la page d'affichage de l'utilisateur apparaitra comme dans l'<a class="ref" href="modeling-and-viewing-users-two#fig:user_show_gravatar_for">illustration&nbsp;7.6</a>. Et puisque l'helper <code>gravatar_for</code> assigne à la balise <code>img</code> la classe CSS <code>"gravatar"</code>, les tests de l'<a class="ref" href="modeling-and-viewing-users-two#code:user_show_tests">extrait&nbsp;7.18</a> devrait maintenant réussir.</p>

<div class="label" id="code:user_show_gravatar_for"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 7.24.</span> <span class="description">Actualiser le template de l'affichage de l'utilisateur en utilisant <code>gravatar_for</code>. <br /> <code>app/views/users/show.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="vi">@user</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">nom</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/h1&gt;</span>
</pre></div>
</div></div>




<div class="label" id="fig:user_show_gravatar_for"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_show_gravatar_for.png" alt="user_show_gravatar_for" /></span></div><div class="caption"><span class="header">Illustration 7.6: </span><span class="description">La page d'affichage de l'utilisateur avec <code>gravatar_for</code>.&nbsp;<a href="http://railstutorial.org/images/figures/user_show_gravatar_for-full.png">(taille normale)</a></span></div></div>




<div class="label" id="sec:a_user_sidebar"></div>


<h3><a id="sec:7.3.3" href="modeling-and-viewing-users-two#sec:a_user_sidebar" class="heading"><span class="number">7.3.3</span> Une barre utilisateur latérale</a></h3>


<p>Même si nos tests réussissent à présent, et que la page d'affichage de l'utilisateur s'est considérablement améliorée, il est encore possible de la polisser un petit peu plus. Dans l'<a class="ref" href="modeling-and-viewing-users-two#code:user_show_with_sidebar">extrait&nbsp;7.25</a>, nous avons une balise <code>table</code> avec un rangée <code>tr</code> et deux cellules <code>td</code>.<sup class="footnote" id="fnref:7.25"><a href="#fn:7.25">25</a></sup></p>

<div class="label" id="code:user_show_with_sidebar"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 7.25.</span> <span class="description">Ajout d'une barre latérale pour la vue <code>show</code> de l'utilisateur. <br /> <code>app/views/users/show.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;table</span> <span class="na">class=</span><span class="s">&quot;profile&quot;</span> <span class="na">summary=</span><span class="s">&quot;Information profil&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;tr&gt;</span>
    <span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">&quot;main&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;h1&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="vi">@user</span> <span class="cp">%&gt;</span>
        <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">nom</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">&quot;sidebar round&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;strong&gt;</span>Nom<span class="nt">&lt;/strong&gt;</span> <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">nom</span> <span class="cp">%&gt;</span><span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;strong&gt;</span>URL<span class="nt">&lt;/strong&gt;</span>  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">),</span> <span class="vi">@user</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/td&gt;</span>
  <span class="nt">&lt;/tr&gt;</span>
<span class="nt">&lt;/table&gt;</span>
</pre></div>
</div></div>


<p>Ici nous avons utilisé la balise HTML&nbsp;<code>&lt;br /&gt;</code> pour forcer un retour à la ligne entre le nom de l'utilisateur et l'URL. Notez aussi l'utilisation de <code>user_path</code> pour créer un lien cliquable qui permet aux utilisateurs de partager facilement l'URL de leur profil. C'est seulement le première d'un grand nombre de routes nommées (<a class="ref" href="filling-in-the-layout#sec:rails_routes">section&nbsp;5.2.2</a>) associées à la ressource User (<a class="ref" href="modeling-and-viewing-users-one#code:users_resource">extrait&nbsp;6.26</a>)&nbsp;; nous en verrons beaucoup plus dans les prochains chapitres. Le code&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="n">user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
</pre></div>
</div>


<p>… retourne le path (<em>chemin d'accès</em>) de l'utilisateur, dans ce cas <tt>/users/1</tt>. Le code lié&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="n">user_url</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
</pre></div>
</div>


<p>… retourne juste l'URL entière, <tt>http://localhost:3000/users/1</tt> (comparez avec les routes créées à la <a class="ref" href="filling-in-the-layout#sec:rails_routes">section&nbsp;5.2.2</a>.). Les deux sont des exemples de routes nommées créées par la ressource utilisateurs de l'<a class="ref" href="modeling-and-viewing-users-one#code:users_resource">extrait&nbsp;6.26</a>&nbsp;; une liste de toutes les routes nommées apparait dans la <a class="ref" href="modeling-and-viewing-users-two#table:nomd_routes">Table&nbsp;7.1</a>.</p>

<div class="label" id="table:nomd_routes"></div>


<div class="table"><div class="center"><table class="tabular"><tr><th class="align_left"><strong>Route nommé</strong></th><th class="align_left"><strong>Chemin</strong></th></tr><tr class="top_bar"><td class="align_left"><code>users_path</code></td><td class="align_left"><tt>/users</tt></td></tr><tr><td class="align_left"><code>user_path(@user)</code></td><td class="align_left"><tt>/users/1</tt></td></tr><tr><td class="align_left"><code>new_user_path</code></td><td class="align_left"><tt>/users/new</tt></td></tr><tr><td class="align_left"><code>edit_user_path(@user)</code></td><td class="align_left"><tt>/users/1/edit</tt></td></tr><tr><td class="align_left"><code>users_url</code></td><td class="align_left"><tt>http://localhost:3000/users</tt></td></tr><tr><td class="align_left"><code>user_url(@user)</code></td><td class="align_left"><tt>http://localhost:3000/users/1</tt></td></tr><tr><td class="align_left"><code>new_user_url</code></td><td class="align_left"><tt>http://localhost:3000/users/new</tt></td></tr><tr><td class="align_left"><code>edit_user_url(@user)</code></td><td class="align_left"><tt>http://localhost:3000/users/1/edit</tt></td></tr></table></div><div class="caption"><span class="header">Table 7.1: </span><span class="description">Routes nommées fournies par la ressource utilisateurs dans l<a class="ref" href="modeling-and-viewing-users-one#code:users_resource">extrait&nbsp;6.26</a>.  </span></div></div>


<p>Notez que dans&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">),</span> <span class="vi">@user</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>… <code>user_path(@user)</code> est le lien <em>texte</em>, tandis que l'adresse est juste <code>@user</code>. Dans le contexte d'un <code>link_to</code>, Rails convertit <code>@user</code> en l'URL appropriée&nbsp;; en d'autres mots, le code ci-dessus est équivalent au code&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">),</span> <span class="n">user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>N'importe quelle formulation fonctionne bien, mais, comme dans l'idiome <code>:id =&gt; @user</code> de l'<a class="ref" href="modeling-and-viewing-users-two#code:get_show_test">extrait&nbsp;7.17</a>, utiliser juste <code>@user</code> est une convention Rails courante. Dans les deux cas, le code Ruby embarqué produit le code HTML&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;/users/1&quot;</span><span class="nt">&gt;</span>/users/1<span class="nt">&lt;/a&gt;</span>
</pre></div>
</div>


<p>Avec les éléments HTML et les classes CSS en place, nous pouvons styliser la page d'affichage avec le code CSS montré dans l'<a class="ref" href="modeling-and-viewing-users-two#code:sidebar_css">extrait&nbsp;7.26</a>. La page en résultant est montrée dans l'<a class="ref" href="modeling-and-viewing-users-two#fig:user_show_sidebar_css">illustration&nbsp;7.7</a>.</p>

<div class="label" id="code:sidebar_css"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 7.26.</span> <span class="description">CSS pour styliser la page d'affichage de l'utilisateur, incluant la barre latérale. <br /> <code>public/stylesheets/custom.css</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="c">/* User show page */</span>

<span class="nt">table</span><span class="nc">.profile</span> <span class="p">{</span>
  <span class="k">width</span><span class="o">:</span> <span class="m">100%</span><span class="p">;</span>
  <span class="k">margin-bottom</span><span class="o">:</span> <span class="m">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">td</span><span class="nc">.main</span> <span class="p">{</span>
  <span class="k">width</span><span class="o">:</span> <span class="m">70%</span><span class="p">;</span>
  <span class="k">padding</span><span class="o">:</span> <span class="m">1em</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">td</span><span class="nc">.sidebar</span> <span class="p">{</span>
  <span class="k">width</span><span class="o">:</span> <span class="m">30%</span><span class="p">;</span>
  <span class="k">padding</span><span class="o">:</span> <span class="m">1em</span><span class="p">;</span>
  <span class="k">vertical-align</span><span class="o">:</span> <span class="k">top</span><span class="p">;</span>
  <span class="k">background</span><span class="o">:</span> <span class="m">#ffc</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.profile</span> <span class="nt">img</span><span class="nc">.gravatar</span> <span class="p">{</span>
  <span class="k">border</span><span class="o">:</span> <span class="m">1px</span> <span class="k">solid</span> <span class="m">#999</span><span class="p">;</span>
  <span class="k">margin-bottom</span><span class="o">:</span> <span class="m">-15px</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div></div>




<div class="label" id="fig:user_show_sidebar_css"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_show_sidebar_css.png" alt="user_show_sidebar_css" /></span></div><div class="caption"><span class="header">Illustration 7.7: </span><span class="description">La page d'affichage de l'utilisateur <a href="http://localhost:3000/users/1"><tt>/users/1</tt></a> avec une barre latérale et du CSS.&nbsp;<a href="http://railstutorial.org/images/figures/user_show_sidebar_css-full.png">(taille normale)</a></span></div></div>




<h2><a id="sec:7.4" href="modeling-and-viewing-users-two#sec:7.4" class="heading"><span class="number">7.4</span> Conclusion</a></h2>


<p>Dans ce chapitre, nous avons effectivement achevé le modèle User, donc nous sommes maintenant pleinement prêt pour inscrire de nouveaux utilisateurs et pour les laisser s'identifier de façon sécurisée avec une combinaison email/mot de passe. Plus encore, nous avons une belle première réduction de la page de profil de l'utilisateur, donc après l'identification les utilisateeurs auront un endroit où aller.</p>

<h3><a id="sec:7.4.1" href="modeling-and-viewing-users-two#sec:7.4.1" class="heading"><span class="number">7.4.1</span> Dépôt Git</a></h3>


<p>Avant de poursuivre, nous devrions interrompre la boucle ouverte dans l'introduction du <a class="ref" href="modeling-and-viewing-users-one#top">chapitre&nbsp;6</a> en faisant un dépôt final pour la branche <code>modeling-users</code> et alors la fusionner avec la branche maitresse (<code>master</code>).<sup class="footnote" id="fnref:7.26"><a href="#fn:7.26">26</a></sup> D'abord, vérifiez que vous êtes bien sur la branche <code>modeling-users</code>&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git branch
<span class="go">  master</span>
<span class="go">* modeling-users</span>
</pre></div>
</div>


<p>Comme indiqué à la <a class="ref" href="beginning#sec:git_branch">section&nbsp;1.3.5.1</a>, l'astérisque ici indique la branche courante, donc nous sommes vraiment prêts à déposer et à fusionner&nbsp;:<sup class="footnote" id="fnref:7.27"><a href="#fn:7.27">27</a></sup></p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">&quot;User model with passwords, and user show page&quot;</span>
<span class="gp">$</span> git checkout master
<span class="gp">$</span> git merge modeling-users
</pre></div>
</div>


<div class="label" id="sec:heroku_deploy"></div>


<h3><a id="sec:7.4.2" href="modeling-and-viewing-users-two#sec:heroku_deploy" class="heading"><span class="number">7.4.2</span> déploiement Heroku</a></h3>


<p>Si vous avez déployer votre application exemple sur Heroku, vous pouvez la «&nbsp;pusher&nbsp;» maintenant&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git push heroku
</pre></div>
</div>


<p>Migrez alors la base de données sur le serveur à distance en utilisant la commande <code>heroku</code>&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> heroku rake db:migrate
</pre></div>
</div>


<p>Maintenant, si vous voulez créer un exemple d'utilisateur sur Heroku, vous pouvez utiliser la console Heroku&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ heroku console</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">:nom</span> <span class="o">=&gt;</span> <span class="s2">&quot;Utilisateur exemple&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;user@example.com&quot;</span><span class="p">,</span>
<span class="gp">?&gt; </span>             <span class="ss">:password</span> <span class="o">=&gt;</span> <span class="s2">&quot;foobar&quot;</span><span class="p">,</span> <span class="ss">:password_confirmation</span> <span class="o">=&gt;</span> <span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
</pre></div>
</div>




<div class="label" id="sec:more_modeling_users_exercises"></div>


<h2><a id="sec:7.5" href="modeling-and-viewing-users-two#sec:more_modeling_users_exercises" class="heading"><span class="number">7.5</span> Exercises</a></h2>




<ol>
<li>Copiez chaque variantes de la méthode <code>authenticate</code> des extraits <a class="ref" href="modeling-and-viewing-users-two#code:authenticate_variant_1">7.27</a> à <a class="ref" href="modeling-and-viewing-users-two#code:authenticate_variant_5">7.31</a> dans le modèle User, et vérifiez qu'ils sont correct en jouant votre suite de tests. </li>

<li>L'exemple final <code>authenticate</code> (<a class="ref" href="modeling-and-viewing-users-two#code:authenticate_variant_5">extrait&nbsp;7.31</a>) relève un défi particulier. Expérimentez avec la console pour voir si vous pouvez comprendre comment il fonctionne.</li>

<li>Comment pourriez obtenir que l'helper gravatar <code>gravatar_for</code> fonctionne si votre modèle User utilisait <code>email_address</code> au lieu de <code>email</code> pour représenter l'adresse email&nbsp;?</li>

</ol>




<div class="label" id="code:authenticate_variant_1"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 7.27.</span> <span class="description">La méthode <code>authenticate</code> avec <code>User</code> à la place de <code>self</code>.</span>       
</div>
<div class="code"><div class="highlight"><pre>  <span class="k">def</span> <span class="nc">User</span><span class="o">.</span><span class="nf">authenticate</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">submitted_password</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">find_by_email</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
    <span class="k">return</span> <span class="kp">nil</span>  <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">nil?</span>
    <span class="k">return</span> <span class="n">user</span> <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">has_password?</span><span class="p">(</span><span class="n">submitted_password</span><span class="p">)</span>
  <span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="code:authenticate_variant_2"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 7.28.</span> <span class="description">La méthode <code>authenticate</code> avec un troisième retour explicite.</span>       
</div>
<div class="code"><div class="highlight"><pre>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">authenticate</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">submitted_password</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">find_by_email</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
    <span class="k">return</span> <span class="kp">nil</span>  <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">nil?</span>
    <span class="k">return</span> <span class="n">user</span> <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">has_password?</span><span class="p">(</span><span class="n">submitted_password</span><span class="p">)</span>
    <span class="k">return</span> <span class="kp">nil</span>
  <span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="code:authenticate_variant_3"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 7.29.</span> <span class="description">La méthode <code>authenticate</code> utilisant une déclaration <code>if</code>.</span>       
</div>
<div class="code"><div class="highlight"><pre>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">authenticate</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">submitted_password</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">find_by_email</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">nil?</span>
      <span class="kp">nil</span>
    <span class="k">elsif</span> <span class="n">user</span><span class="o">.</span><span class="n">has_password?</span><span class="p">(</span><span class="n">submitted_password</span><span class="p">)</span>
      <span class="n">user</span>
    <span class="k">else</span>
      <span class="kp">nil</span>
    <span class="k">end</span>
  <span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="code:authenticate_variant_4"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 7.30.</span> <span class="description">La méthode <code>authenticate</code> utilisanat une déclaration <code>if</code> et un retour implicite.</span>       
</div>
<div class="code"><div class="highlight"><pre>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">authenticate</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">submitted_password</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">find_by_email</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">nil?</span>
      <span class="kp">nil</span>
    <span class="k">elsif</span> <span class="n">user</span><span class="o">.</span><span class="n">has_password?</span><span class="p">(</span><span class="n">submitted_password</span><span class="p">)</span>
      <span class="n">user</span>
    <span class="k">end</span>
  <span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="code:authenticate_variant_5"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 7.31.</span> <span class="description">La méthode <code>authenticate</code> utilisant l'opérateur ternaire.</span>       
</div>
<div class="code"><div class="highlight"><pre>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">authenticate</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">submitted_password</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">find_by_email</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">has_password?</span><span class="p">(</span><span class="n">submitted_password</span><span class="p">)</span> <span class="p">?</span> <span class="n">user</span> <span class="p">:</span> <span class="kp">nil</span>
  <span class="k">end</span>
</pre></div>
</div></div>




<div class="navigation">  <a class="prev_page" href="modeling-and-viewing-users-one#top">
    &laquo;&nbsp;<span class="number">chapitre 6</span> Modéliser et afficher les utilisateurs, partie I
  </a>
  <a class="next_page" href="sign-up#top">
    <span class="number">chapitre 8</span> Inscription&nbsp;&raquo;
  </a>
</div><div class="footnotes">
<ol>
<li id="fn:7.1">Nous avons vu précédemment les <em>rangs</em> à la <a class="ref" href="rails-flavored-ruby#sec:arrays_and_ranges">section&nbsp;4.3.1</a>.&nbsp;<a class="arrow" href="#fnref:7.1">&uarr;</a></li>
<li id="fn:7.2">Pour plus de détail sur le type de fonctions de rappel supportées par Active Record, voyez la <a href="http://guides.rubyonrails.org/active_record_validations_callbacks.html#callbacks-overview">discussion sur les callbacks dans les guides Rails</a>.&nbsp;<a class="arrow" href="#fnref:7.2">&uarr;</a></li>
<li id="fn:7.3">Le niveau supplémentaire d'indentation est une façon typographique de nous souvenir que nous sommes dans une section privée&nbsp;; dans le cas contraire, il est facile de manquer le mot-clé <code>private</code> et d'être dérouté en essayant d'atteindre une méthode privée que vous pensez publique. Je pensais que cette convention d'identation était stupide jusqu'à ce que je perde une heure sur ce simple problème il y a quelques années. Maintenant j'ajouter l'identation&hellip;&nbsp;<a class="arrow" href="#fnref:7.3">&uarr;</a></li>
<li id="fn:7.4">Ruby possède aussi un mot-clé très proche, appelé <code>protected</code> (<em>protégé</em>) qui diffère subtilement de <code>private</code>. Autant que je peux dire, la seule raison d'apprendre la différence serait qu'on pourrait vous poser cette question au cours d'un entretien d'embauche&nbsp;: «&nbsp;En Ruby, quelle est la différence entre <code>private</code> et <code>protected</code>?&nbsp;». Mais qui aurait envie de travailler dans une compagnie qui poserait ce genre de question vicieuse&nbsp;? Lors de son discours à RubyConf en 2008, Dave Thomas (auteur de <em>Programmer Ruby</em>) a suggéré d'éliminer <code>protected</code> des versions futures de Ruby, et j'abonde dans son sens. Utilisez simplement <code>private</code> et tout ira bien.&nbsp;<a class="arrow" href="#fnref:7.4">&uarr;</a></li>
<li id="fn:7.5">J'ai honte d'admettre que c'est ainsi que nous avons implémenté les mots de passe dans <em>RailsSpace</em>. Considérez que cette section est ma pénitence.&nbsp;<a class="arrow" href="#fnref:7.5">&uarr;</a></li>
<li id="fn:7.6">Le lecteur attentif peut noter que rien de ce que nous faisons dans cette section ne <em>requiert</em> le cryptage, mais, une fois que nous développons un peu de la théorie des mots de passe sécurisés et écrivons une implémentation basique (<a class="ref" href="modeling-and-viewing-users-two#sec:secure_password_theory">section&nbsp;7.2.2</a>), la seule façon pour la méthode <code>has_password?</code> de fonctionner proprement est que toute la machinerie de cryptage fonctionne aussi bien.&nbsp;<a class="arrow" href="#fnref:7.6">&uarr;</a></li>
<li id="fn:7.7">Dans mes réglages, la ligne <code>require &rsquo;digest&rsquo;</code> n'est pas nécessaire, mais plusieurs lecteurs m'ont reporté qu'ils rencontraient une erreur <code>NameError</code> s'il ne l'incluait pas explicitement. Ça n'entraine aucun dommage de toute façon, donc j'ai inclus explicitement <code>require</code> juste pour être sûr.&nbsp;<a class="arrow" href="#fnref:7.7">&uarr;</a></li>
<li id="fn:7.8">En théorie et techniquement, les attaques «&nbsp;arc-en-ciel&nbsp;» pourraient toujours réussir, mais en utilisant un «&nbsp;hachage salé&nbsp;», la réussite est informatiquement infaisable.&nbsp;<a class="arrow" href="#fnref:7.8">&uarr;</a></li>
<li id="fn:7.9">Comme indiqué à la <a class="ref" href="modeling-and-viewing-users-two#sec:secure_password_theory">section&nbsp;7.2.2</a>, la ligne explicite <code>require &rsquo;digest&rsquo;</code> n'est pas nécessaire sur certains systèmes, mais ça ne coûte rien de l'ajouter.&nbsp;<a class="arrow" href="#fnref:7.9">&uarr;</a></li>
<li id="fn:7.10">Dans les versions précédentes de Rails, nous pouvions utiliser la fonction de rappel <code>after_validation_before_create</code> pour définir le <em>salt</em>, mais elle a été supprimée dans Rails&nbsp;3. En passant, nous ne pouvons pas utiliser la fonction de rappel <code>before_create</code> parce qu'elle s'exécute <em>après</em> la fonction de rappel <code>before_save</code>, et la fonction de rappel <code>before_save</code> a besoin du salt.&nbsp;<a class="arrow" href="#fnref:7.10">&uarr;</a></li>
<li id="fn:7.11">En vous souvenant du <a class="ref" href="modeling-and-viewing-users-one#sidebar:base de données_indices">Box&nbsp;6.2</a>, l'indexation de la colonne <code>email</code> assurant que cette récupération serait efficace.&nbsp;<a class="arrow" href="#fnref:7.11">&uarr;</a></li>
<li id="fn:7.12">Nous projetterons d'ajouter une paire d'attributs supplémentaires (une pour identifier un utilisateur administrateur et un pour permettre la fonctionnalité «&nbsp;se souvenir de moi&nbsp;»), mais ils ne sont pas strictement nécessaires. Tous les attributs d'utilisateur <em>essentiels</em> ont maintenant été définis.&nbsp;<a class="arrow" href="#fnref:7.12">&uarr;</a></li>
<li id="fn:7.13">De nombreux programmeurs Rails expérimentés trouve que cette approche <em>factory</em> est bien plus flexible que les <em>fixtures</em> (<em>appareils</em>) que Rails utilise par défaut mais peuvent être fragiles et difficile pour la maintenance.&nbsp;<a class="arrow" href="#fnref:7.13">&uarr;</a></li>
<li id="fn:7.14">Le nom «&nbsp;Factory Girl&nbsp;» fait peut-être référence au <a href="http://www.imdb.com/title/tt0432402/">film éponyme</a>.&nbsp;<a class="arrow" href="#fnref:7.14">&uarr;</a></li>
<li id="fn:7.15">J'ai utilisé <code>get &rsquo;new&rsquo;</code> dans l'<a class="ref" href="filling-in-the-layout#code:get_new_user_spec">extrait&nbsp;5.24</a> et les tests suivants pour l'action <code>new</code> parce qu'à ce point nous n'avions pas encore rencontré l'idée des actions du concept REST. Je le remplacerai par <code>get :new</code> dans les tests futurs.&nbsp;<a class="arrow" href="#fnref:7.15">&uarr;</a></li>
<li id="fn:7.16">Il accomplit cela en appelant la méthode <code>to_param</code> sur la variable <code>@user</code>.&nbsp;<a class="arrow" href="#fnref:7.16">&uarr;</a></li>
<li id="fn:7.17">Ça n'est pas toujours nécessairement une bonne idée de créer des tests HTML aussi spécifiques, puisque nous ne voulons pas toujours contraindre aussi étroitement le layout HTML. Sentez-vous libre d'expérimenter et de trouver le bon niveau de détail pour vos projets conformément à vos goûts.&nbsp;<a class="arrow" href="#fnref:7.17">&uarr;</a></li>
<li id="fn:7.18">Ou plutôt, si vous voulez <em>déséchapper</em> le texte vous devez utiliser la méthode <code>raw</code> (<em>brut</em>), comme dans <tt class="verb">&lt;%= raw @title %&gt;</tt>.&nbsp;<a class="arrow" href="#fnref:7.18">&uarr;</a></li>
<li id="fn:7.19">Gravatar a été créé originellement par Tom Preston-Werner, co-fondateur de <a href="http://github.com/">GitHub</a>, et a été acquis et redimensionné par <a href="http://automattic.com/">Automattic</a> (plus connu comme les concepteurs de <a href="http://wordpress.com/">WordPress</a>).&nbsp;<a class="arrow" href="#fnref:7.19">&uarr;</a></li>
<li id="fn:7.20">Dans l'hindouisme, un <em>avatar</em> est la manifestation d'une divinité dans une forme humaine ou animale. Par extension, le terme <em>avatar</em> est couramment utiliser pour signifier toute forme de représentation personnelle, spécialement dans un environnement virtuel. Mais vous avez dû voir le film maintenant, donc vous savez déjà ce que c'est.&nbsp;<a class="arrow" href="#fnref:7.20">&uarr;</a></li>
<li id="fn:7.21">Si votre application a besoin de traiter les images ou tout autre téléchargement de fichier, <a href="http://github.com/thoughtbot/paperclip">Paperclip</a> est l'endroit où se rendre. Comme Factory Girl, Paperclip vous est offert par <a href="http://thoughtbot.com/">thoughtbot</a> (bien que je connaisse quelques personnes là-bas, je n'ai aucun intérêt particulier à promouvoir thoughtbot&nbsp;; ils font simplement de bons logiciels).&nbsp;<a class="arrow" href="#fnref:7.21">&uarr;</a></li>
<li id="fn:7.22">Merci au lecteur anonyme qui a noté que le plugin Gravatar est sensible à la casse dans ce contexte.&nbsp;<a class="arrow" href="#fnref:7.22">&uarr;</a></li>
<li id="fn:7.23">Il existe en fait un moyen de redéfinir la taille par défaut dans le fichier de configuration, mais j'ai trouvé ce moyen plus clair.&nbsp;<a class="arrow" href="#fnref:7.23">&uarr;</a></li>
<li id="fn:7.24">Les gravatars sont carrés, donc un seule paramètre peut définir la taille.&nbsp;<a class="arrow" href="#fnref:7.24">&uarr;</a></li>
<li id="fn:7.25">Si quelqu'un vous fait grieffe, horreur des horreurs, d'utiliser les <em>tables pour la mise en forme</em>, demandez-leur de pointer leur inspecteur firebug à la barre latérale de profil de Twitter et de vous dire ce qu'ils voient. En fait, vous trouverez que, tandis que le «&nbsp;marquage sémantique&nbsp;» utilisant des <code>div</code> et des <code>span</code> est de plus en  plus courant, virtuellement tous les sites font appel à l'occasion au <code>table</code>  pour faire de la mise en forme. Dans le cas présent, obtenir l'alignement vertical juste à droite est <em>beaucoup</em> plus facile avec les tables.&nbsp;<a class="arrow" href="#fnref:7.25">&uarr;</a></li>
<li id="fn:7.26">D'ordinaire, je recommande de faire des dépôts plus fréquente, plus petits, mais de fréquents dépôt Git tout au long du tutoriel serait difficile à maintenir and casserait trop souvent le fil de la discussion.&nbsp;<a class="arrow" href="#fnref:7.26">&uarr;</a></li>
<li id="fn:7.27">Si vous n'êtes <em>pas</em> sur la bonne branche, jouer <code>git checkout modeling-users</code> avant de procéder.&nbsp;<a class="arrow" href="#fnref:7.27">&uarr;</a></li>
</ol>
</div>




