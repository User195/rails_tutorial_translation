

<h1 class="title">Tutoriel Ruby on Rails </h1>


<h1 class="subtitle">  Apprendre Rails par l'exemple</h1>


<h2 class="author">Michael Hartl</h2>



<h1 class="contents">Contenu</h1>


<div id="table_of_contents"><ol>
<li class="chapter"><a href="beginning#top"><span class="number">Chapitre 1</span> De zéro au déploiement</a></li>
<li><ol>
<li class="section"><a href="beginning#sec:introduction"><span class="number">1.1</span> Introduction</a></li>
<li><ol>
<li class="subsection"><a href="beginning#sec:comments_for_various_readers"><span class="number">1.1.1</span> Commentaires pour les lecteurs différents</a></li>
<li class="subsection"><a href="beginning#sec:1.1.2"><span class="number">1.1.2</span> &ldquo;Dimensionner&rdquo; Rails</a></li>
<li class="subsection"><a href="beginning#sec:conventions"><span class="number">1.1.3</span> Conventions utilisées dans ce livre</a></li></ol></li>
<li class="section"><a href="beginning#sec:up_and_running"><span class="number">1.2</span> [(Up and running)(En route pour le démarrage)]</a></li>
<li><ol>
<li class="subsection"><a href="beginning#sec:development_tools"><span class="number">1.2.1</span> Environnements de développement</a></li>
<li><ol>
<li class="subsubsection"><a href="beginning#sec:1.2.1.1">IDEs</a></li>
<li class="subsubsection"><a href="beginning#sec:1.2.1.2">Éditeurs de texte et lignes de commande</a></li>
<li class="subsubsection"><a href="beginning#sec:1.2.1.3">Navigateurs</a></li>
<li class="subsubsection"><a href="beginning#sec:1.2.1.4">Note à propos des outils</a></li></ol></li>
<li class="subsection"><a href="beginning#sec:rubygems"><span class="number">1.2.2</span> Ruby, RubyGems, Rails, et Git</a></li>
<li><ol>
<li class="subsubsection"><a href="beginning#sec:rails_installer_windows">Installation de Rails (Windows)</a></li>
<li class="subsubsection"><a href="beginning#sec:install_git">Installer Git</a></li>
<li class="subsubsection"><a href="beginning#sec:install_ruby">Installer Ruby</a></li>
<li class="subsubsection"><a href="beginning#sec:install_rubygems">Installer RubyGems</a></li>
<li class="subsubsection"><a href="beginning#sec:install_rails">Installer Rails</a></li></ol></li>
<li class="subsection"><a href="beginning#sec:the_first_application"><span class="number">1.2.3</span> La première application</a></li>
<li class="subsection"><a href="beginning#sec:bundler"><span class="number">1.2.4</span> Bundler</a></li>
<li class="subsection"><a href="beginning#sec:rails_server"><span class="number">1.2.5</span> <code>Le serveur rails (rails server)</code></a></li>
<li class="subsection"><a href="beginning#sec:mvc"><span class="number">1.2.6</span> Modèles-Vue-Contrôleur (MVC)</a></li></ol></li>
<li class="section"><a href="beginning#sec:version_control"><span class="number">1.3</span> Contrôle de versions avec Git</a></li>
<li><ol>
<li class="subsection"><a href="beginning#sec:git_setup"><span class="number">1.3.1</span> Installation et réglages</a></li>
<li><ol>
<li class="subsubsection"><a href="beginning#sec:1.3.1.1">Initialisation des réglages système</a></li>
<li class="subsubsection"><a href="beginning#sec:1.3.1.2">Initialisation des réglages du dépôt (repository)</a></li></ol></li>
<li class="subsection"><a href="beginning#sec:adding_and_committing"><span class="number">1.3.2</span> Ajout et mandat de dépôt</a></li>
<li class="subsection"><a href="beginning#sec:1.3.3"><span class="number">1.3.3</span> Qu'est-ce que Git peut faire de bien pour vous&nbsp;?</a></li>
<li class="subsection"><a href="beginning#sec:github"><span class="number">1.3.4</span> GitHub</a></li>
<li class="subsection"><a href="beginning#sec:git_commands"><span class="number">1.3.5</span> Branch, edit, commit, merge</a></li>
<li><ol>
<li class="subsubsection"><a href="beginning#sec:git_branch">Branch</a></li>
<li class="subsubsection"><a href="beginning#sec:git_edit">Edit</a></li>
<li class="subsubsection"><a href="beginning#sec:git_commit">Commit</a></li>
<li class="subsubsection"><a href="beginning#sec:git_merge">Merge</a></li>
<li class="subsubsection"><a href="beginning#sec:git_push">Push</a></li></ol></li></ol></li>
<li class="section"><a href="beginning#sec:deploying"><span class="number">1.4</span> Déploiement</a></li>
<li><ol>
<li class="subsection"><a href="beginning#sec:1.4.1"><span class="number">1.4.1</span> Réglages Heroku</a></li>
<li class="subsection"><a href="beginning#sec:heroku_step_one"><span class="number">1.4.2</span> déploiement Heroku, première étape</a></li>
<li class="subsection"><a href="beginning#sec:1.4.3"><span class="number">1.4.3</span> Déploiement Heroku deployment, seconde étape</a></li>
<li class="subsection"><a href="beginning#sec:heroku_commands"><span class="number">1.4.4</span> Commandes Heroku</a></li></ol></li>
<li class="section"><a href="beginning#sec:beginning_conclusion"><span class="number">1.5</span> Conclusion</a></li></ol></li>
<li class="chapter"><a href="a-demo-app#top"><span class="number">Chapitre 2</span> Une application démo</a></li>
<li><ol>
<li class="section"><a href="a-demo-app#sec:planning_the_application"><span class="number">2.1</span> Planifier l'application</a></li>
<li><ol>
<li class="subsection"><a href="a-demo-app#sec:modeling_users"><span class="number">2.1.1</span> Modéliser les utilisateurs</a></li>
<li class="subsection"><a href="a-demo-app#sec:modeling_microposts"><span class="number">2.1.2</span> Modéliser les micro-messages</a></li></ol></li>
<li class="section"><a href="a-demo-app#sec:demo_users_resource"><span class="number">2.2</span> La ressource Utilisateurs (Users)</a></li>
<li><ol>
<li class="subsection"><a href="a-demo-app#sec:a_user_tour"><span class="number">2.2.1</span> Un tour de l'utilisateur</a></li>
<li class="subsection"><a href="a-demo-app#sec:mvc_in_action"><span class="number">2.2.2</span> MVC en action</a></li>
<li class="subsection"><a href="a-demo-app#sec:weaknesses_of_this_users_resource"><span class="number">2.2.3</span> Faiblesses de la ressource Utilisateurs (Users)</a></li></ol></li>
<li class="section"><a href="a-demo-app#sec:microposts_resource"><span class="number">2.3</span> La ressource Micro-messages (Microposts)</a></li>
<li><ol>
<li class="subsection"><a href="a-demo-app#sec:a_micropost_microtour"><span class="number">2.3.1</span> Un petit tour du micro-message</a></li>
<li class="subsection"><a href="a-demo-app#sec:putting_the_micro_in_microposts"><span class="number">2.3.2</span> Appliquer le <em>micro</em> aux micro-messages</a></li>
<li class="subsection"><a href="a-demo-app#sec:demo_user_has_many_microposts"><span class="number">2.3.3</span> Un utilisateur <code>has_many</code> (<code>possède plusieurs</code>) micro-messages</a></li>
<li class="subsection"><a href="a-demo-app#sec:inheritance_hierarchies"><span class="number">2.3.4</span> Hiérarchie des héritages</a></li>
<li class="subsection"><a href="a-demo-app#sec:deploying_the_demo_app"><span class="number">2.3.5</span> Déployer l'application Démo</a></li></ol></li>
<li class="section"><a href="a-demo-app#sec:2.4"><span class="number">2.4</span> Conclusion</a></li></ol></li>
<li class="chapter"><a href="static-pages#top"><span class="number">Chapitre 3</span> Pages statiques courantes</a></li>
<li><ol>
<li class="section"><a href="static-pages#sec:static_pages"><span class="number">3.1</span> Pages statiques</a></li>
<li><ol>
<li class="subsection"><a href="static-pages#sec:truly_static_pages"><span class="number">3.1.1</span> Pages HTML statiques</a></li>
<li class="subsection"><a href="static-pages#sec:static_pages_with_rails"><span class="number">3.1.2</span> Les pages statiques avec Rails</a></li></ol></li>
<li class="section"><a href="static-pages#sec:first_tests"><span class="number">3.2</span> Premiers tests</a></li>
<li><ol>
<li class="subsection"><a href="static-pages#sec:testing_tools"><span class="number">3.2.1</span> Outils de test</a></li>
<li><ol>
<li class="subsubsection"><a href="static-pages#sec:autotest">Auto-test</a></li></ol></li>
<li class="subsection"><a href="static-pages#sec:TDD"><span class="number">3.2.2</span> TDD : Rouge, Vert, Refactor</a></li>
<li><ol>
<li class="subsubsection"><a href="static-pages#sec:spork">Spork</a></li>
<li class="subsubsection"><a href="static-pages#sec:red">Rouge</a></li>
<li class="subsubsection"><a href="static-pages#sec:green">Vert</a></li>
<li class="subsubsection"><a href="static-pages#sec:refactor">Refactor</a></li></ol></li></ol></li>
<li class="section"><a href="static-pages#sec:slightly_dynamic_pages"><span class="number">3.3</span> Pages (un peu) dynamiques</a></li>
<li><ol>
<li class="subsection"><a href="static-pages#sec:testing_a_title_change"><span class="number">3.3.1</span> Test d'un changement de titre</a></li>
<li class="subsection"><a href="static-pages#sec:passing_title_tests"><span class="number">3.3.2</span> Réussir les tests de titre</a></li>
<li class="subsection"><a href="static-pages#sec:instance_variables_embedded_ruby"><span class="number">3.3.3</span> Variables d'instance et Ruby embarqué</a></li>
<li class="subsection"><a href="static-pages#sec:layouts"><span class="number">3.3.4</span> Supprimer les répétitions avec les <em>layouts</em></a></li></ol></li>
<li class="section"><a href="static-pages#sec:static_pages_conclusion"><span class="number">3.4</span> Conclusion</a></li>
<li class="section"><a href="static-pages#sec:static_pages_Exercices"><span class="number">3.5</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="rails-flavored-ruby#top"><span class="number">Chapitre 4</span> [(Rails-flavored Ruby)(Rails au goût Ruby)]</a></li>
<li><ol>
<li class="section"><a href="rails-flavored-ruby#sec:motivation"><span class="number">4.1</span> Motivation</a></li>
<li><ol>
<li class="subsection"><a href="rails-flavored-ruby#sec:title_helper"><span class="number">4.1.1</span> Un « helper » (« aideur ») pour le titre (<code>title</code>)</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:cascading_style_sheets"><span class="number">4.1.2</span> Feuilles de styles (CSS — Cascading Style Sheets)</a></li></ol></li>
<li class="section"><a href="rails-flavored-ruby#sec:strings_and_methods"><span class="number">4.2</span> Chaines de caractères et méthodes</a></li>
<li><ol>
<li class="subsection"><a href="rails-flavored-ruby#sec:comments"><span class="number">4.2.1</span> Commentaires</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:strings"><span class="number">4.2.2</span> Chaines de caractères</a></li>
<li><ol>
<li class="subsubsection"><a href="rails-flavored-ruby#sec:printing">Impression</a></li>
<li class="subsubsection"><a href="rails-flavored-ruby#sec:single_quoted_strings">Chaines de caractères « single-quoté »</a></li></ol></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:objects_and_message_passing"><span class="number">4.2.3</span> Objets et passage de message</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:method_definitions"><span class="number">4.2.4</span> Définition de méthode</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:back_to_the_title_helper"><span class="number">4.2.5</span> Retour à l'« helper » de titre</a></li></ol></li>
<li class="section"><a href="rails-flavored-ruby#sec:other_data_structures"><span class="number">4.3</span> Autres structures de données</a></li>
<li><ol>
<li class="subsection"><a href="rails-flavored-ruby#sec:arrays_and_ranges"><span class="number">4.3.1</span> Tableaux et rangs</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:blocks"><span class="number">4.3.2</span> Blocs</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:hashes_and_symbols"><span class="number">4.3.3</span> Tables de hachage et symboles</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:css_revisited"><span class="number">4.3.4</span> CSS revisitées</a></li></ol></li>
<li class="section"><a href="rails-flavored-ruby#sec:ruby_classes"><span class="number">4.4</span> Classes Ruby</a></li>
<li><ol>
<li class="subsection"><a href="rails-flavored-ruby#sec:constructors"><span class="number">4.4.1</span> Constructeurs</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:a_class_of_our_own"><span class="number">4.4.2</span> Héritages de classes</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:modifying_built_in_classes"><span class="number">4.4.3</span> Modifier les classes d'origine</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:a_controller_class"><span class="number">4.4.4</span> Classe de contrôleur</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:a_user_class"><span class="number">4.4.5</span> Classe utiliateur</a></li></ol></li>
<li class="section"><a href="rails-flavored-ruby#sec:Exercices"><span class="number">4.5</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="filling-in-the-layout#top"><span class="number">Chapitre 5</span> Poursuivre la mise en page</a></li>
<li><ol>
<li class="section"><a href="filling-in-the-layout#sec:structure"><span class="number">5.1</span> Ajout de structure</a></li>
<li><ol>
<li class="subsection"><a href="filling-in-the-layout#sec:adding_to_the_layout"><span class="number">5.1.1</span> Navigation du site</a></li>
<li class="subsection"><a href="filling-in-the-layout#sec:custom_css"><span class="number">5.1.2</span> Personnalisation CSS</a></li>
<li class="subsection"><a href="filling-in-the-layout#sec:partials"><span class="number">5.1.3</span> Partiels (Partials)</a></li></ol></li>
<li class="section"><a href="filling-in-the-layout#sec:layout_links"><span class="number">5.2</span> Liens pour la mise en page</a></li>
<li><ol>
<li class="subsection"><a href="filling-in-the-layout#sec:integration_tests"><span class="number">5.2.1</span> Test d'intégration</a></li>
<li class="subsection"><a href="filling-in-the-layout#sec:rails_routes"><span class="number">5.2.2</span> Routes Rails</a></li>
<li class="subsection"><a href="filling-in-the-layout#sec:nomd_routes"><span class="number">5.2.3</span> Nommer les routes</a></li></ol></li>
<li class="section"><a href="filling-in-the-layout#sec:user_signup"><span class="number">5.3</span> Inscription de l'utilisateur : une première étape</a></li>
<li><ol>
<li class="subsection"><a href="filling-in-the-layout#sec:users_controller"><span class="number">5.3.1</span> Contrôleur Utilisateur (Users controller)</a></li>
<li class="subsection"><a href="filling-in-the-layout#sec:signup_url"><span class="number">5.3.2</span> URL d'inscription</a></li></ol></li>
<li class="section"><a href="filling-in-the-layout#sec:layout_conclusion"><span class="number">5.4</span> Conclusion</a></li>
<li class="section"><a href="filling-in-the-layout#sec:layout_Exercices"><span class="number">5.5</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="modeling-and-viewing-users-one#top"><span class="number">Chapitre 6</span> Modéliser et afficher les utilisateurs, partie I</a></li>
<li><ol>
<li class="section"><a href="modeling-and-viewing-users-one#sec:user_model"><span class="number">6.1</span> Modèle utilisateur (User model)</a></li>
<li><ol>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:base de données_migrations"><span class="number">6.1.1</span> Migrations de la base de données</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:the_model_file"><span class="number">6.1.2</span> Le fichier modèle</a></li>
<li><ol>
<li class="subsubsection"><a href="modeling-and-viewing-users-one#sec:model_annotation">[(Model annotation)]</a></li>
<li class="subsubsection"><a href="modeling-and-viewing-users-one#sec:accessible_attributes">Attributs accessibles</a></li></ol></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:creating_user_objects"><span class="number">6.1.3</span> Créer des objets Utilisateur</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:finding_user_objects"><span class="number">6.1.4</span> Recherche dans les objets Utilisateurs (Users)</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:updating_user_objects"><span class="number">6.1.5</span> Actualisation des objets Utilisateurs (Users)</a></li></ol></li>
<li class="section"><a href="modeling-and-viewing-users-one#sec:user_validations"><span class="number">6.2</span> Validations utilisateur</a></li>
<li><ol>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:presence_validation"><span class="number">6.2.1</span> Valider l'existence</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:length_validation"><span class="number">6.2.2</span> Valider la longueur</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:format_validation"><span class="number">6.2.3</span> Valider le format</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:uniqueness_validation"><span class="number">6.2.4</span> Valider l'unicité</a></li>
<li><ol>
<li class="subsubsection"><a href="modeling-and-viewing-users-one#sec:the_caveat">L'avertissement d'unicité</a></li></ol></li></ol></li>
<li class="section"><a href="modeling-and-viewing-users-one#sec:viewing_users"><span class="number">6.3</span> Afficher les utilisateurs</a></li>
<li><ol>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:rails_environments"><span class="number">6.3.1</span> Débuggage et environnements Rails</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:users_show"><span class="number">6.3.2</span> Modèle, Vue et Contrôleur Utilisateur</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:a_users_resource"><span class="number">6.3.3</span> Ressource Utilisateurs</a></li>
<li><ol>
<li class="subsubsection"><a href="modeling-and-viewing-users-one#sec:params_in_debug">[(<code>params</code> in <code>debug</code>)]</a></li></ol></li></ol></li>
<li class="section"><a href="modeling-and-viewing-users-one#sec:6.4"><span class="number">6.4</span> Conclusion</a></li>
<li class="section"><a href="modeling-and-viewing-users-one#sec:6.5"><span class="number">6.5</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="modeling-and-viewing-users-two#top"><span class="number">Chapitre 7</span> Modéliser et afficher les utilisateurs, partie II</a></li>
<li><ol>
<li class="section"><a href="modeling-and-viewing-users-two#sec:insecure_passwords"><span class="number">7.1</span> Mots de passe non sûrs</a></li>
<li><ol>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:password_validations"><span class="number">7.1.1</span> Valider le mot de passe</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:password_migration"><span class="number">7.1.2</span> Migrer un mot de passe</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:an_active_record_callback"><span class="number">7.1.3</span> Un <em>callback</em> de l'Active Record</a></li></ol></li>
<li class="section"><a href="modeling-and-viewing-users-two#sec:secure_passwords"><span class="number">7.2</span> Sécuriser les mots de passe</a></li>
<li><ol>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:a_secure_password_test"><span class="number">7.2.1</span> Test de mot de passe sûr</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:secure_password_theory"><span class="number">7.2.2</span> Un peu de théorie sur les mots de passe sécurisés</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:implementing_has_password"><span class="number">7.2.3</span> Implémenter la méthode <code>has_password?</code></a></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:an_authenticate_method"><span class="number">7.2.4</span> Méthode d'authentification</a></li></ol></li>
<li class="section"><a href="modeling-and-viewing-users-two#sec:better_user_views"><span class="number">7.3</span> Meilleures vues d'utilisateurs</a></li>
<li><ol>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:tests_with_factories"><span class="number">7.3.1</span> Tester la page de l'utilisateur (avec factories)</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:a_name_and_a_gravatar"><span class="number">7.3.2</span> Un nom et un Gravatar</a></li>
<li><ol>
<li class="subsubsection"><a href="modeling-and-viewing-users-two#sec:a_gravatar_helper">Un « helper » de Gravatar</a></li></ol></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:a_user_sidebar"><span class="number">7.3.3</span> Une barre utilisateur latérale</a></li></ol></li>
<li class="section"><a href="modeling-and-viewing-users-two#sec:7.4"><span class="number">7.4</span> Conclusion</a></li>
<li><ol>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:7.4.1"><span class="number">7.4.1</span> Commit Git</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:heroku_deploy"><span class="number">7.4.2</span> Déploiement Heroku</a></li></ol></li>
<li class="section"><a href="modeling-and-viewing-users-two#sec:more_modeling_users_Exercices"><span class="number">7.5</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="sign-up#top"><span class="number">Chapitre 8</span> Inscription</a></li>
<li><ol>
<li class="section"><a href="sign-up#sec:signup_form"><span class="number">8.1</span> Formulaire d'inscription</a></li>
<li><ol>
<li class="subsection"><a href="sign-up#sec:using_form_for"><span class="number">8.1.1</span> Utiliser  <code>form_for</code></a></li>
<li class="subsection"><a href="sign-up#sec:the_form_html"><span class="number">8.1.2</span> Le formulaire HTML</a></li></ol></li>
<li class="section"><a href="sign-up#sec:signup_failure"><span class="number">8.2</span> Échec de l'inscription</a></li>
<li><ol>
<li class="subsection"><a href="sign-up#sec:testing_failure"><span class="number">8.2.1</span> Test de l'échec</a></li>
<li class="subsection"><a href="sign-up#sec:a_working_form"><span class="number">8.2.2</span> Un formulaire fonctionnel</a></li>
<li class="subsection"><a href="sign-up#sec:signup_error_messages"><span class="number">8.2.3</span> Inscription&nbsp;: messages d'erreur</a></li>
<li class="subsection"><a href="sign-up#sec:filtering_parameter_logging"><span class="number">8.2.4</span> Filtrage des paramètres d'identification</a></li></ol></li>
<li class="section"><a href="sign-up#sec:signup_success"><span class="number">8.3</span> Succès de l'inscription</a></li>
<li><ol>
<li class="subsection"><a href="sign-up#sec:testing_success"><span class="number">8.3.1</span> Tester le succès de l'inscription</a></li>
<li class="subsection"><a href="sign-up#sec:the_finished_signup_form"><span class="number">8.3.2</span> Le formulaire d'inscription finalisé</a></li>
<li class="subsection"><a href="sign-up#sec:the_flash"><span class="number">8.3.3</span> Le message «&nbsp;flash&nbsp;»</a</a></li>
<li class="subsection"><a href="sign-up#sec:the_first_signup"><span class="number">8.3.4</span> La première inscription</a></li></ol></li>
<li class="section"><a href="sign-up#sec:rspec_integration_tests"><span class="number">8.4</span> Test d'intégration RSpec</a></li>
<li><ol>
<li class="subsection"><a href="sign-up#sec:integration_tests_with_style"><span class="number">8.4.1</span> Tests d'intégration avec les styles</a></li>
<li class="subsection"><a href="sign-up#sec:failed_signup"><span class="number">8.4.2</span> Un échec d'inscription ne devrait pas créer un nouvel utilisateur</a></li>
<li class="subsection"><a href="sign-up#sec:successful_signup"><span class="number">8.4.3</span> Le succès d'une inscription devrait créer un nouvel utilisateur</a></li></ol></li>
<li class="section"><a href="sign-up#sec:8.5"><span class="number">8.5</span> Conclusion</a></li>
<li class="section"><a href="sign-up#sec:signup_Exercices"><span class="number">8.6</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="sign-in-sign-out#top"><span class="number">Chapitre 9</span> Connexion, déconnexion</a></li>
<li><ol>
<li class="section"><a href="sign-in-sign-out#sec:sessions"><span class="number">9.1</span> Les sessions</a></li>
<li><ol>
<li class="subsection"><a href="sign-in-sign-out#sec:sessions_controller"><span class="number">9.1.1</span> Le contrôleur de session</a></li>
<li class="subsection"><a href="sign-in-sign-out#sec:signin_form"><span class="number">9.1.2</span> Formulaire d'identification</a></li></ol></li>
<li class="section"><a href="sign-in-sign-out#sec:signin_failure"><span class="number">9.2</span> Échec de l'identification</a></li>
<li><ol>
<li class="subsection"><a href="sign-in-sign-out#sec:reviewing_form_submission"><span class="number">9.2.1</span> Examen de la soumission du formulaire</a></li>
<li class="subsection"><a href="sign-in-sign-out#sec:failed_signin"><span class="number">9.2.2</span> Échec de l'identification (test et code)</a></li></ol></li>
<li class="section"><a href="sign-in-sign-out#sec:signin_success"><span class="number">9.3</span> Succès de l'identification</a></li>
<li><ol>
<li class="subsection"><a href="sign-in-sign-out#sec:the_completed_create_action"><span class="number">9.3.1</span> L'action <code>create</code> («&nbsp;créer&nbsp;») finalisée</a></li>
<li class="subsection"><a href="sign-in-sign-out#sec:remember_me"><span class="number">9.3.2</span> Se souvenir de moi</a></li>
<li class="subsection"><a href="sign-in-sign-out#sec:current_user"><span class="number">9.3.3</span> Utilisateur courant</a></li></ol></li>
<li class="section"><a href="sign-in-sign-out#sec:signing_out"><span class="number">9.4</span> Déconnexion</a></li>
<li><ol>
<li class="subsection"><a href="sign-in-sign-out#sec:destroying_sessions"><span class="number">9.4.1</span> Détruire la session</a></li>
<li class="subsection"><a href="sign-in-sign-out#sec:signin_upon_signup"><span class="number">9.4.2</span> Connection à l'inscription</a></li>
<li class="subsection"><a href="sign-in-sign-out#sec:changing_the_layout_links"><span class="number">9.4.3</span> Changement des liens de la mise en plage</a></li>
<li class="subsection"><a href="sign-in-sign-out#sec:signin_out_integration_tests"><span class="number">9.4.4</span> Test d'intégration de l'identification/déconnexion</a></li></ol></li>
<li class="section"><a href="sign-in-sign-out#sec:9.5"><span class="number">9.5</span> Conclusion</a></li>
<li class="section"><a href="sign-in-sign-out#sec:sign_in_out_Exercices"><span class="number">9.6</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="updating-showing-and-deleting-users#top"><span class="number">Chapitre 10</span> Actualiser, afficher et supprimer de l'utilisateur</a></li>
<li><ol>
<li class="section"><a href="updating-showing-and-deleting-users#sec:updating_users"><span class="number">10.1</span> Actualiser l'utilisateur</a></li>
<li><ol>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:edit_form"><span class="number">10.1.1</span> Formulaire de modification</a></li>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:enabling_edits"><span class="number">10.1.2</span> Permettre les modifications</a></li></ol></li>
<li class="section"><a href="updating-showing-and-deleting-users#sec:protecting_pages"><span class="number">10.2</span> Protéger les pages</a></li>
<li><ol>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:requiring_signed_in_users"><span class="number">10.2.1</span> Utilisateurs identifiés requis</a></li>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:requiring_the_right_user"><span class="number">10.2.2</span> Nécessité du bon utilisateur</a></li>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:friendly_forwarding"><span class="number">10.2.3</span> Redirection conviviale</a></li></ol></li>
<li class="section"><a href="updating-showing-and-deleting-users#sec:showing_users"><span class="number">10.3</span> Afficher les utilisateurs</a></li>
<li><ol>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:user_index"><span class="number">10.3.1</span> Liste des utilisateurs</a></li>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:sample_users"><span class="number">10.3.2</span> Exemples d'utilisateurs</a></li>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:pagination"><span class="number">10.3.3</span> Pagination</a></li>
<li><ol>
<li class="subsubsection"><a href="updating-showing-and-deleting-users#sec:testing_pagination">Test de la pagination</a></li></ol></li>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:partial_refactoring"><span class="number">10.3.4</span> Restructuration des partielles</a></li></ol></li>
<li class="section"><a href="updating-showing-and-deleting-users#sec:destroying_users"><span class="number">10.4</span> Supprimer des utilisateurs</a></li>
<li><ol>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:administrative_users"><span class="number">10.4.1</span> Utilisateurs administrateurs</a></li>
<li><ol>
<li class="subsubsection"><a href="updating-showing-and-deleting-users#sec:revisiting_attr_accessible">Révision de <code>attr_accessible</code></a></li></ol></li>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:the_destroy_action"><span class="number">10.4.2</span> L'action <code>destroy</code> («&nbsp;supprimer&nbsp;»)</a></li></ol></li>
<li class="section"><a href="updating-showing-and-deleting-users#sec:10.5"><span class="number">10.5</span> Conclusion</a></li>
<li class="section"><a href="updating-showing-and-deleting-users#sec:updating_deleting_Exercices"><span class="number">10.6</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="user-microposts#top"><span class="number">Chapitre 11</span> Micro-messages d'utilisateur</a></li>
<li><ol>
<li class="section"><a href="user-microposts#sec:a_micropost_model"><span class="number">11.1</span> Le modèle Micropost («&nbsp;Micro-message&nbsp;»)</a></li>
<li><ol>
<li class="subsection"><a href="user-microposts#sec:the_basic_model"><span class="number">11.1.1</span> Le modèle initial</a></li>
<li><ol>
<li class="subsubsection"><a href="user-microposts#sec:accessible_attribute">Attributs accessibles</a></li></ol></li>
<li class="subsection"><a href="user-microposts#sec:user_micropost_associations"><span class="number">11.1.2</span> Associations Utilisateur/micro-messages</a></li>
<li class="subsection"><a href="user-microposts#sec:ordering_and_dependency"><span class="number">11.1.3</span> Affinements du micro-message</a></li>
<li><ol>
<li class="subsubsection"><a href="user-microposts#sec:default_scope">Portée par défaut</a></li>
<li class="subsubsection"><a href="user-microposts#sec:dependent_destroy">Dependent: destroy (dépendances de la suppression)</a></li></ol></li>
<li class="subsection"><a href="user-microposts#sec:micropost_validations"><span class="number">11.1.4</span> Validations du micro-message</a></li></ol></li>
<li class="section"><a href="user-microposts#sec:showing_microposts"><span class="number">11.2</span> Afficher les micro-messages</a></li>
<li><ol>
<li class="subsection"><a href="user-microposts#sec:augmenting_the_user_show_page"><span class="number">11.2.1</span> Etoffement de la page de l'utilisateur</a></li>
<li class="subsection"><a href="user-microposts#sec:sample_microposts"><span class="number">11.2.2</span> Exemples de micro-messages</a></li></ol></li>
<li class="section"><a href="user-microposts#sec:manipulating_microposts"><span class="number">11.3</span> Manipuler les micro-messages</a></li>
<li><ol>
<li class="subsection"><a href="user-microposts#sec:access_control"><span class="number">11.3.1</span> Contrôle de l'accès</a></li>
<li class="subsection"><a href="user-microposts#sec:creating_microposts"><span class="number">11.3.2</span> Créer des micro-messages</a></li>
<li class="subsection"><a href="user-microposts#sec:a_proto_feed"><span class="number">11.3.3</span> Une proto-alimentation</a></li>
<li class="subsection"><a href="user-microposts#sec:destroying_microposts"><span class="number">11.3.4</span> Supprimer des micro-messages</a></li>
<li class="subsection"><a href="user-microposts#sec:testing_the_new_home_page"><span class="number">11.3.5</span> Test de la nouvelle page d'accueil</a></li></ol></li>
<li class="section"><a href="user-microposts#sec:11.4"><span class="number">11.4</span> Conclusion</a></li>
<li class="section"><a href="user-microposts#sec:micropost_Exercices"><span class="number">11.5</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="following-users#top"><span class="number">Chapitre 12</span> Suivi des utilisateurs</a></li>
<li><ol>
<li class="section"><a href="following-users#sec:the_relationship_model"><span class="number">12.1</span> Le modèle Relation (Relationship model)</a></li>
<li><ol>
<li class="subsection"><a href="following-users#sec:a_problem_with_the_data_model"><span class="number">12.1.1</span> Un problème du modèle de données (et sa solution)</a></li>
<li class="subsection"><a href="following-users#sec:relationship_user_associations"><span class="number">12.1.2</span> Associations Utilisateur/Relations</a></li>
<li class="subsection"><a href="following-users#sec:relationship_validations"><span class="number">12.1.3</span> Validations</a></li>
<li class="subsection"><a href="following-users#sec:following"><span class="number">12.1.4</span> Auteurs suivis</a></li>
<li class="subsection"><a href="following-users#sec:followers"><span class="number">12.1.5</span> Lecteurs</a></li></ol></li>
<li class="section"><a href="following-users#sec:a_web_interface_for_following_and_followers"><span class="number">12.2</span> Une interface web pour les auteurs suivis et les lecteurs</a></li>
<li><ol>
<li class="subsection"><a href="following-users#sec:sample_following_data"><span class="number">12.2.1</span> Exemple de donnée de suivi</a></li>
<li class="subsection"><a href="following-users#sec:stats_and_a_follow_form"><span class="number">12.2.2</span> Statistiques et formulaire de suivi</a></li>
<li class="subsection"><a href="following-users#sec:following_and_followers_pages"><span class="number">12.2.3</span> Pages d'auteurs suivis et de lecteurs</a></li>
<li class="subsection"><a href="following-users#sec:a_working_follow_button_the_standard_way"><span class="number">12.2.4</span> Un bouton de suivi fonctionnant de façon standard</a></li>
<li class="subsection"><a href="following-users#sec:a_working_follow_button_with_ajax"><span class="number">12.2.5</span> Un bouton fonctionnant avec Ajax</a></li></ol></li>
<li class="section"><a href="following-users#sec:the_status_feed"><span class="number">12.3</span> L'état de l'alimention</a></li>
<li><ol>
<li class="subsection"><a href="following-users#sec:motivation_and_strategy"><span class="number">12.3.1</span> Motivation et stratégie</a></li>
<li class="subsection"><a href="following-users#sec:a_first_feed_implementation"><span class="number">12.3.2</span> Une première implémentation de peuplement</a></li>
<li class="subsection"><a href="following-users#sec:scopes_subselects_and_a_lambda"><span class="number">12.3.3</span> Portées, sous-requêtes et fonction <em>lambda</em></a></li>
<li class="subsection"><a href="following-users#sec:the_new_status_feed"><span class="number">12.3.4</span> Nouvel état de l'alimentation</a></li></ol></li>
<li class="section"><a href="following-users#sec:following_conclusion"><span class="number">12.4</span> Conclusion</a></li>
<li><ol>
<li class="subsection"><a href="following-users#sec:extensions_to_the_sample_application"><span class="number">12.4.1</span> Extensions de l'application exemple</a></li>
<li><ol>
<li class="subsubsection"><a href="following-users#sec:replies">Réponses</a></li>
<li class="subsubsection"><a href="following-users#sec:messaging">Notification</a></li>
<li class="subsubsection"><a href="following-users#sec:follower_notifications">Notifications aux lecteurs</a></li>
<li class="subsubsection"><a href="following-users#sec:password_reminders">Rappel du mot de passe</a></li>
<li class="subsubsection"><a href="following-users#sec:signup_confirmation">Confirmation d'inscription</a></li>
<li class="subsubsection"><a href="following-users#sec:rss_feed">Alimentation RSS</a></li>
<li class="subsubsection"><a href="following-users#sec:rest_api">REST API</a></li>
<li class="subsubsection"><a href="following-users#sec:search">Recherche</a></li></ol></li>
<li class="subsection"><a href="following-users#sec:guide_to_further_resources"><span class="number">12.4.2</span> Guide vers d'autres ressources</a></li></ol></li>
<li class="section"><a href="following-users#sec:following_Exercices"><span class="number">12.5</span> Exercices</a></li></ol></li></ol></div>

<div id="main_content"></div>

<p> <span class="preamble">
 <span id="foreword">
<strong> Avant-propos</strong> <br />
 </span>
 </span></p>

<p>Ma précédente compagnie (CD Baby) fut une des premières à basculer complètement vers Ruby on Rails, et à rebasculer aussi complètement vers PHP (googlez-moi pour prendre la mesure du drama). Ce livre de Michael Hartl m'est arrivé avec tant de recommandation que je ne pouvais faire autrement que de le lire. C'est ainsi que <em>Ruby on Rails Tutorial</em> m'a fait retourner à Rails à nouveau </p>
<p>Bien qu'ayant parcouru de nombreux livre sur Rails, c'est celui qui m'a fait vraiment &ldquo;posséder&rdquo; Rails. Tout est fait “à la manière de Rails” —&nbsp;une manière qui ne me semblait pas naturelle avant avant d'avoir terminer ce livre. C'est aussi le seul livre sur Rails qui opère un Développement conduit par le test (“test-driven development”) d'un bout à l'autre, une approche hautement recommandée par les experts mais qui n'a jamais été aussi démontrée avant. Enfin, en incluant Git, GitHub et Heroku dans les exemples en démonstration, l'auteur vous donne vraiment le goût de ce que c'est que faire un projet dans la vraie vie. Les exemples de code du tutoriel ne sont pas de reste.</p> 
	
<p>La narration linéaire est vraiment un bon format. Personnellement, j'ai étudié <em>Le Tutoriel Rails</em> en trois longues journées, en faisant tous les exemples et les exercices proposés à la fin de chaque chapitre. Lisez du début à la fin, en ne sautant aucune partie, et vous en tirerez tout le bénéfice.</p>

<p>Régalez-vous&nbsp;!</p>

<p><a href="http://sivers.org/">Derek Sivers</a> (<a href="http://sivers.org/">sivers.org</a>) <br />
<em>Précédemment&nbsp;: Fondateur de </em> <a href="http://www.cdbaby.com/"><em>CD Baby</em></a> <br />
<em>Actuellement&nbsp;: Fondateur de </em> <a href="http://thoughts.pro/"><em>Thoughts Ltd.</em></a> <br /></p>

<p> <span class="preamble">
<strong> Remerciements</strong> <br />
 </span></p>

<p>Ce <em>Tutoriel Ruby on Rails</em> doit beaucoup à mon livre précédent sur Rails, <em>RailsSpace</em>, et donc à mon co-auteur <a href="http://aure.com/">Aurelius Prochazka</a>. J'aimerais remercier Aure à la fois pour le travail qu'il a accompli sur ce précédent livre et pour son soutien pour le présent ouvrage. J'aimerais aussi remercier Debra Williams Cauley, mon éditeur pour les deux ouvrages&nbsp;; aussi longtemps qu'[elle me prendra au baseball][she keeps taking me to baseball games], je continuerai d'écrire des livres pour elle.</p>

<p>J'aimerais remerciement une longue liste de Rubyistes qui m'ont parlé et inspiré au cours des années&nbsp;; David Heinemeier Hansson, Yehuda Katz, Carl Lerche, Jeremy Kemper, Xavier Noria, Ryan Bates, Geoffrey Grosenbach, Peter Cooper, Matt Aimonetti, Gregg Pollack, Wayne&nbsp;E. Seguin, Amy Hoy, Dave Chelimsky, Pat Maddox, Tom Preston-Werner, Chris Wanstrath, Chad Fowler, Josh Susser, Obie Fernandez, Ian McFarland, Steven Bristol, Giles Bowkett, Evan Dorn, Long Nguyen, James Lindenbaum, Adam Wiggins, Tikhon Bernstam, Ron Evans, Wyatt Greene, Miles Forrest, les gens bien de Pivotal Labs, le gang Heroku, les mecs de thoughtbot, et l'équipe de GitHub. Enfin, tellement, tellement, tellement de lecteurs —&nbsp;beaucoup trop pour les citer tous&nbsp;— qui ont contribuer par leur rapport de bogues et leurs suggestions durant l'écriture de ce livre, et je tiens à saluer leur aide pour rendre ce livre aussi bon qu'il pouvait être. <br /></p>

<p> <span class="preamble">
 <span id="author">
<strong> À propos de l'auteur</strong> <br />
 </span>
 </span></p>

<p><a href="http://michaelhartl.com/">Michael Hartl</a> est programmeur, éducateur et entrepreneur. Il est le co-auteur de <em>RailsSpace</em>, un tutoriel Rails [qui s'est bien vendu] publié en 2007, et a été co-fondateur et développeur en chef de <a href="http://insoshi.com/">Insoshi</a>, une plateforme de réseau social <a href="http://github.com/popular/forked">populaire</a> en Ruby on Rails. Précédement, il a enseigné la théorie et [l'application informatique][computational physics] en physique au <a href="http://www.caltech.edu/">California Institute of Technology</a> (Caltech), où il a reçu le Lifetime Achievement Award for Excellence en enseignement. Michael est diplômé du <a href="http://college.harvard.edu/">Harvard College</a>, a un <a href="http://resolver.caltech.edu/CaltechETD:etd-05222003-161626">Ph.D. en physique</a> (NdT. Un doctorat) de <a href="http://www.caltech.edu/">Caltech</a>, et est ancien élève du programme   des entrepreneurs <a href="http://ycombinator.com/">Y&nbsp;Combinator</a>. <br /></p>

<p> <span id="license" class="preamble">
<strong> Copyright et license</strong> <br />
 </span></p>

<p><em>Le Tutoriel Ruby on Rails&nbsp;: apprendre Rails par l'exemple</em>. Copyright &copy; 2010 par Michael Hartl. Tout le code source du <em>Tutoriel Ruby on Rails</em> est disponible sour la license <a href="http://www.opensource.org/licenses/mit-license.php">MIT License</a> et la licence <a href="http://en.wikipedia.org/wiki/Beerware">Beerware License</a>.</p>

<pre class="verbatim">   Copyright (c) 2010 Michael Hartl

   [La permission est accordée ici, à titre gratuit, à toute
   personne obtenant une copie de ce logiciel et sa documentation
   associés (le “Software”), 
   Permission is hereby granted, free of charge, to any person
   obtaining a copy of this software and associated documentation
   files (the &quot;Software&quot;), de traiter dans le Software
   sans restriction, d'inclure sans limitation de droits à utiliser,
   copier, modifier, ajouter, publier, distribuer, sous-licensier,
   et/ou vendre des copies de ce Software, et de permettre au gens
   à qui ce Software est fourni d'en faire de même, assujetti aux
   conditions suivantes&nbsp;:

   La note de copyright ci-dessous et cette notice de permission
   doivent être inclues à toute copie ou portion substantielle
   du logiciel.

   LE LOGICIEL EST FOURNI “TEL QUEL”, SANS AUCUNE GARANTIE D'AUCUNE
   ESPÈCE, ESPRESSE OU IMPLICITE, INCLUANT MAIS NE LIMITANT PAS LES
   GARANTIES MARCHANDES, À PROPOS D'UN BUT PARTICULIER ET ABSENCE
   DE CONTREFAÇON. EN AUCUN CAS LES AUTEURS OU LES DÉTENTEURS DU 
   COPYRIGHT NE POURRONT ÊTRE TENUS RESPONSABLE DE DOMMAGE OU AUTRE
   RESPONSABILITÉ, SI EN UNE ACTION DE CONTRAT, TORT OU AUTREMENT,
   DÉCOULANT DIRECTEMENT OU INDIRECTEMENT DE L'UTILISATION OU DE LA
   MODIFICATION DE CE LOGICIEL.]</pre>




<pre class="verbatim">/*
 * ------------------------------------------------------------
 * &quot;THE BEERWARE LICENSE&quot; (Revision 42):
 * Michael Hartl a écrit ce code. Aussi longtemps que vous
 * conservez cette note, vous pouvez faire ce que vous voulez
 * de ce travail. Si nous nous rencontrons un jour, et que vous
 * pensez que ce travail en vaut la peine, vous pourrez me
 * payer une bière en retour.
 * ------------------------------------------------------------
 */</pre>



<div id="top"></div>


<h1 class="chapter"><a id="sec:7" href="modeling-and-viewing-users-two#top" class="heading"><span class="number">chapitre 7</span> Modéliser et afficher les utilisateurs, partie II</a></h1>


<p>Au <a class="ref" href="modeling-and-viewing-users-one#top">chapitre&nbsp;6</a>, nous avons créé la première itération d'un modèle User (<em>Utilisateur</em>) pour représenter les utilisateusr de notre application, mais le job a été à moitié accompli. Virtuellement n'importe quel site avec des utilisateurs, incluant nous-mêmes, a besoin d'un système d'<em>authentification</em>, mais pour le moment n'importe quel utilisateur qui peut s'inscricre au site possède un nom et une adresse mail, et nous n'avons aucun moyen de vérifier leur identité. Dans ce chapitre, nous allons ajouter l'attribut <em>mot de passe</em> (<em>password</em>) nécessaire à une inscription initiale de l'utilisateur (<a class="ref" href="sign-up#top">chapitre&nbsp;8</a>) et pour une identification (une connexion) avec une combinaison email/mot de passe (<a class="ref" href="sign-in-sign-out#top">chapitre&nbsp;9</a>). Au cours du processus, nous ré-utiliserons plusieurs des idées du <a class="ref" href="modeling-and-viewing-users-one#top">chapitre&nbsp;6</a>, incluant les migrations et les validations, et aussi introduire de nouvelle idées telles que les attributs virtuels, les méthodes privées et les <em>fonctions de rappel</em> (<em>callbacks</em>) d'Active Record.</p>

<p>Une fois que nous avons un attribut <code>mot_de_passe</code> fonctionnel, nous ferons une action et une vue pour afficher les profils des utilisateurs (<a class="ref" href="modeling-and-viewing-users-two#sec:better_user_views">section&nbsp;7.3</a>). Vers la fin de ce chapitre, nos profils d'utilisateur afficheront les noms et les photos du profil (comme indiqué dans la maquette de l'<a class="ref" href="modeling-and-viewing-users-two#fig:profile_mockup_profile_name">illustration&nbsp;7.1</a>), et [(they will be nicely tested with user <em>factories</em>)(ils seront bien testés avec l'utilisateur <em>factories</em>)].</p>

<p>Avant d'avancer, ré-initialisons la base de données avec <code>rake db:reset</code>, ce qui va retirer tous les vieux exemples d'utilisateurs des sessions précédentes&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rake db:reset</span>
</pre></div>
</div>




<div class="label" id="fig:profile_mockup_profile_name"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/profile_mockup_profile_name.png" alt="profile_mockup_profile_name" /></span></div><div class="caption"><span class="header">Illustration 7.1: </span><span class="description">Une maquette du profil utilisateur fait à la <a class="ref" href="modeling-and-viewing-users-two#sec:better_user_views">section&nbsp;7.3</a>.&nbsp;<a href="http://railstutorial.org/images/figures/profile_mockup_profile_name-full.png">(taille normale)</a></span></div></div>




<div class="label" id="sec:insecure_passwords"></div>


<h2><a id="sec:7.1" href="modeling-and-viewing-users-two#sec:insecure_passwords" class="heading"><span class="number">7.1</span> Mots de passe peu sécurisés</a></h2>


<p>Faire des mots de passe robustes requiert beaucoup de machinerie, donc nous allons diviser le processus en deux principales étapes. Dans cette section, nous allons faire un attribut <code>mot_de_passe</code> et ajouter des validations. Le modèle User (<em>Utilisateur</em>) en résultant sera complètement fonctionnel mais pas du tout sécurisé, avec des mots de passe enregistrés tels quels dans la base de données. À la <a class="ref" href="modeling-and-viewing-users-two#sec:secure_passwords">section&nbsp;7.2</a>, nous règlerons ce problème en cryptant les mots de passe avant de les sauver, ainsi protégeant notre site contre les possibles attaques.</p>

<div class="label" id="sec:password_validations"></div>


<h3><a id="sec:7.1.1" href="modeling-and-viewing-users-two#sec:password_validations" class="heading"><span class="number">7.1.1</span> Validations du mot de passe</a></h3>


<p>Quand bien même nous aurions déjà ajouté une colonne pour les mots de passe à notre base de données, nous allons déjà commencer par écrire leurs tests. Notre projet initial est d'avoir des tests pour valider la présence, la longueur et la confirmation des mots de passe.
	C'est notre plus gros bloc de tests jusqu'ici, voyez si vous pouvez le lire tout d'un tenant. Si vous restez coincé, ça vous aidera sans doute de revoir les validations analogues de la <a class="ref" href="modeling-and-viewing-users-one#sec:user_validations">section&nbsp;6.2</a> ou sauter directement au code de l'application de l'<a class="ref" href="modeling-and-viewing-users-two#code:password_validations">extrait&nbsp;7.2</a>.</p>

<p>Dans le but de minimiser les typos dans les mots de passe, quand on fera la page d'inscription de l'utilisateur au <a class="ref" href="sign-up#top">chapitre&nbsp;8</a> nous adopterons la convention courante que les utilisateurs <em>confirment</em> leur mot de passe. Pour commencer, revoyons la table d'attributs vue dans l'<a class="ref" href="modeling-and-viewing-users-one#code:validates_uniqueness_of_email_case_insensitive_test">extrait&nbsp;6.20</a>:</p>

<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
    <span class="vi">@attr</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:nom</span> <span class="o">=&gt;</span> <span class="s2">&quot;Utilisateur exemple&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;user@example.com&quot;</span> <span class="p">}</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div>


<p>Pour écrire des tests pour les mots de passe, nous aurons besoin d'ajouter <em>deux</em> nouveaux attributs à la table <code>@attr</code>, <code>password</code> (<em>mot de passe</em>) et <code>password_confirmation</code> (<em>motdepasse_confirmation</em>). Comme vous pouvez certainement le deviner, l'attribut <code>password_confirmation</code> sera utilisé pour l'étape de confirmation du mot de passe.</p>

<p>Écrivons des tests pour la présence du mot de passe et sa confirmation, avec des tests confirmant que le mot de passe a une longueur valide (réduite à quelque chose arbitrairement fixée entre 6 et 40 caractères). Le résultat apparait dans l'<a class="ref" href="modeling-and-viewing-users-two#code:password_validation_tests">extrait&nbsp;7.1</a>.</p>

<div class="label" id="code:password_validation_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 7.1.</span> <span class="description">Des tests pour les validations du mot de passe. <br /> <code>spec/models/user_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
    <span class="vi">@attr</span> <span class="o">=</span> <span class="p">{</span>
      <span class="ss">:nom</span> <span class="o">=&gt;</span> <span class="s2">&quot;Utilisateur exemple&quot;</span><span class="p">,</span>
      <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;user@example.com&quot;</span><span class="p">,</span>
      <span class="ss">:password</span> <span class="o">=&gt;</span> <span class="s2">&quot;foobar&quot;</span><span class="p">,</span>
      <span class="ss">:password_confirmation</span> <span class="o">=&gt;</span> <span class="s2">&quot;foobar&quot;</span>
    <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s2">&quot;devrait créer une nouvelle instance avec des attributs valides&quot;</span> <span class="k">do</span>
    <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="vi">@attr</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;password validations&quot;</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">&quot;devrait exiger un mot de passe&quot;</span> <span class="k">do</span>
      <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@attr</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="ss">:password</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="ss">:password_confirmation</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">))</span><span class="o">.</span>
        <span class="n">should_not</span> <span class="n">be_valid</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;devrait exiger une confirmation du mot de passe qui correspond&quot;</span> <span class="k">do</span>
      <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@attr</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="ss">:password_confirmation</span> <span class="o">=&gt;</span> <span class="s2">&quot;invalid&quot;</span><span class="p">))</span><span class="o">.</span>
        <span class="n">should_not</span> <span class="n">be_valid</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;devrait rejeter les mots de passe (trop) courts&quot;</span> <span class="k">do</span>
      <span class="n">short</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span> <span class="o">*</span> <span class="mi">5</span>
      <span class="nb">hash</span> <span class="o">=</span> <span class="vi">@attr</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="ss">:password</span> <span class="o">=&gt;</span> <span class="n">short</span><span class="p">,</span> <span class="ss">:password_confirmation</span> <span class="o">=&gt;</span> <span class="n">short</span><span class="p">)</span>
      <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">hash</span><span class="p">)</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_valid</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;devrait rejeter les (trop) longs mots de passe&quot;</span> <span class="k">do</span>
      <span class="n">long</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span> <span class="o">*</span> <span class="mi">41</span>
      <span class="nb">hash</span> <span class="o">=</span> <span class="vi">@attr</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="ss">:password</span> <span class="o">=&gt;</span> <span class="n">long</span><span class="p">,</span> <span class="ss">:password_confirmation</span> <span class="o">=&gt;</span> <span class="n">long</span><span class="p">)</span>
      <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">hash</span><span class="p">)</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_valid</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Notez sans l'<a class="ref" href="modeling-and-viewing-users-two#code:password_validation_tests">extrait&nbsp;7.1</a> comme nous collectons d'abord un set d'attributs utilisateur valides dans <code>@attr</code>. Si pour quelques raisons que ce soit ces attributs ne sont pas valides &mdash;&nbsp;comme ce devrait être le cas, par exemple, si nous n'avons pas implémenté les confirmations proprement&nbsp;&mdash; alors la première étape&nbsp;:</p>

<div class="code"><div class="highlight"><pre>  <span class="n">it</span> <span class="s2">&quot;devrait créer une nouvelle instance avec des attributs valides&quot;</span> <span class="k">do</span>
    <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="vi">@attr</span><span class="p">)</span>
  <span class="k">end</span>
</pre></div>
</div>


<p>… rencontrera une erreur. Les tests suivants vérifiera alors chaque validation à son tour, en utilisant la même technique <code>@attr.merge</code> introduite la première fois dans l'<a class="ref" href="modeling-and-viewing-users-one#code:failing_validates_name_spec">extrait&nbsp;6.11</a>.</p>

<p>Maintenant voyons le code de l'application, qui contient une astuce. En fait, elle contient <em>deux</em> astuces. D'abord, vous pouvez vous attendre, à ce point, à ce qu'on joue une migration pour ajouter un attribut <code>password</code> à notre modèle User, comme nous l'avions fait pour les attributs <code>nom</code> et <code>email</code> dans l'<a class="ref" href="modeling-and-viewing-users-one#code:generate_user_model">extrait&nbsp;6.1</a>. Mais ce n'est pas le cas&nbsp;: nous n'allons enregistrer qu'un mot de passe <em>crypté</em> dans la base de données&nbsp;; pour le mot de passe, nous allons introduire la notion d'<em>attribut virtuel</em> (c'est-à-dire un attribut qui ne correspond pas à une colonne de la base de données) en utilisant la méthode <code>attr_accessor</code>, bien plus que nous ne l'avions fait avec les attributs originel <code>nom</code> et <code>email</code> pour l'exemple d'utilisateur à la <a class="ref" href="rails-flavored-ruby#sec:a_user_class">section&nbsp;4.4.5</a>. L'attribut <code>password</code> ne sera jamais écrit dans la base de données, mais n'existera seulement qu'en mémoire pour permettre l'étape de confirmation du mot de passe (implémentée ci-dessous) et l'étape de cryptage (implémentée à la <a class="ref" href="modeling-and-viewing-users-two#sec:password_migration">section&nbsp;7.1.2</a> et <a class="ref" href="modeling-and-viewing-users-two#sec:secure_passwords">section&nbsp;7.2</a>).</p>

<p>La seconde astuce est que nous n'allons <em>pas</em> introduire un attribut  <code>password_confirmation</code>, pas même un virtuel. À la place, nous utiliserons la validation spéciale&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="n">validates</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:confirmation</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</pre></div>
</div>


<p>… qui va <em>automatiquement</em> créer un attribut virtuel appelé <code>password_confirmation</code>, tout en confirmant dans le même temps qu'il correspond exactement à l'attribut <code>password</code>.</p>

<p>Ainsi préparé à comprendre l'implémentation, jetons un coup d'œil au code lui-même (<a class="ref" href="modeling-and-viewing-users-two#code:password_validations">extrait&nbsp;7.2</a>).</p>

<div class="label" id="code:password_validations"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 7.2.</span> <span class="description">Valdiation pour l'attribut <code>password</code>. <br /> <code>app/models/user.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="kp">attr_accessor</span> <span class="ss">:password</span>
  <span class="n">attr_accessible</span> <span class="ss">:nom</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:password_confirmation</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="c1"># Crée automatique l'attribut virtuel &#39;password_confirmation&#39;.</span>
  <span class="n">validates</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:presence</span>     <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span>
                       <span class="ss">:confirmation</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span>
                       <span class="ss">:length</span>       <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:within</span> <span class="o">=&gt;</span> <span class="mi">6</span><span class="o">.</span><span class="n">.</span><span class="mi">40</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Comme promis, nous utilisons <code>attr_accessor :password</code> pour créer un attribut <code>password</code> virtuel (comme à la <a class="ref" href="rails-flavored-ruby#sec:a_user_class">section&nbsp;4.4.5</a>). Puis, puisque nous allons accepter les mots de passe et leur confirmation comme part du processus d'inscription au <a class="ref" href="sign-up#top">chapitre&nbsp;8</a>, nous avons besoin d'ajouter le mot de passe et sa confirmation à la liste des attributs accessibles (mentionnée la première fois à la <a class="ref" href="modeling-and-viewing-users-one#sec:accessible_attributes">section&nbsp;6.1.2.2</a>), ce que nous faisons à la ligne&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="n">attr_accessible</span> <span class="ss">:nom</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:password_confirmation</span>
</pre></div>
</div>


<p>Ensuite vient les validation du mot de passe. Elle requièrent la présent d'un <code>:password</code> (commme, par exemplen dans l'<a class="ref" href="modeling-and-viewing-users-one#code:validates_presence_of_name">extrait&nbsp;6.7</a>) et incluent <code>:confirmation =&gt; true</code> qui rejettent les utilisateurs dont le mot de passe et sa confirmation ne correspondent pas. Nous avons aussi une deuxième application de la validation de la longueur&nbsp;; dans l'<a class="ref" href="modeling-and-viewing-users-one#code:length_validation">extrait&nbsp;6.15</a> nous contraignions l'attribut <code>nom</code> à avoir moins de 50 caractères en utilisant l'option <code>:maximum</code>&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="n">validates</span> <span class="ss">:nom</span><span class="p">,</span>  <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span>
                  <span class="ss">:length</span>   <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:maximum</span> <span class="o">=&gt;</span> <span class="mi">50</span> <span class="p">}</span>
</pre></div>
</div>


<p>Pour la validation de la longueur du mot de passe, nous avons plutôt utilisé l'option <code>:within</code>, en lui passant le <em>rang</em><sup class="footnote" id="fnref:7.1"><a href="#fn:7.1">1</a></sup> <code>6..40</code> pour forcer la contrainte de longueur.</p>

<div class="label" id="sec:password_migration"></div>


<h3><a id="sec:7.1.2" href="modeling-and-viewing-users-two#sec:password_migration" class="heading"><span class="number">7.1.2</span> La migration du mot de passe</a></h3>


<p>À ce point, nous devons considérer que nous n'enregistrons le mot de passe de l'utilisateur nulle part&nbsp;; puisque nous avons décidé d'utiliser un mot de passe virtuel, plutôt que de l'enregistrer dans la base de données, il n'existe qu'en mémoire. Comment pouvons-nous utiliser ce mot de passe pour l'identification&nbsp;? La solution consiste à créer un attribut séparé dédié à la consignation du mot de passe, et notre stratégie consistera à utiliser un mot de passe virtuel comme matériel brut pour un <em>mot de passe crytpé</em>, que nous <em>enregistrerons</em> dans la base de données à l'inscription de l'utilisateur (<a class="ref" href="sign-up#top">chapitre&nbsp;8</a>) et que nous récupèrerons plus tard pour l'identification de l'utilisateur (<a class="ref" href="sign-in-sign-out#top">chapitre&nbsp;9</a>).</p>

<p>Planifions l'enregistrement du mot de passe crytpé en utilisant un attribut <code>encrypted_password</code> dans notre modèle User (<em>Utilisateur</em>). Nous discuterons des détails de l'implémentation à la <a class="ref" href="modeling-and-viewing-users-two#sec:secure_passwords">section&nbsp;7.2</a>, mais nous pouvons commencer avec nos tests du mot de passe crytpé en notant que le mot de passe crytpé devrait au moins <em>exister</em>. Nous pouvons tester cela en utilisant la méthode Ruby <code>respond_to?</code> (<em>répond_à&nbsp;?</em> ), qui accepte un symbole et retourne <code>true</code> (<em>vrai</em>) si l'objet répond à la méthode ou l'attribut donné et <code>false</code> (<em>faux</em>) dans le cas contraire&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console --sandbox</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">respond_to?</span><span class="p">(</span><span class="ss">:password</span><span class="p">)</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">respond_to?</span><span class="p">(</span><span class="ss">:encrypted_password</span><span class="p">)</span>
<span class="go">=&gt; false</span>
</pre></div>
</div>


<p>Nous pouvons tester l'existence d'un attribut <code>encrypted_password</code> avec le code de l'<a class="ref" href="modeling-and-viewing-users-two#code:respond_to_encrypted_password">extrait&nbsp;7.3</a>, qui utilise l'<em>helper</em> de méthode RSpec <code>respond_to</code>.</p>

<div class="label" id="code:respond_to_encrypted_password"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 7.3.</span> <span class="description">Tester l'existence d'un attribut <code>encrypted_password</code>. <br /> <code>spec/models/user_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;password encryption&quot;</span> <span class="k">do</span>

    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="vi">@attr</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;devrait avoir un attribut  mot de passe crytpé&quot;</span> <span class="k">do</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:encrypted_password</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Notez que dans le bloc <code>before(:each)</code> nous <em>créons</em> un utilisateur, plutôt que d'appeler juste la méthode <code>User.new</code>. Nous pourrions en fait faire réussir ce test en utilisant <code>User.new</code>, mais (comme nous le verrons dans un instant) <em>définir</em> le mot de passe crytpé exigera que l'utilisateur soit enregistré dans la base de données. En utilisant <code>create!</code> dans ce premier cas ne crée pas de dommage, et le placer dans <code>before(:each)</code> nous permettra de garder tous les tests du mot de passe crytpé dans un seul bloc <code>describe</code>.</p>

<p>Pour obtenir la réussite de ce test, nous aurons besoin d'une migration pour ajouter l'attribut <code>encrypted_password</code> à la table <code>users</code> (<em>utilisateurs</em>)&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate migration add_password_to_users encrypted_password:string
</pre></div>
</div>


<p>Ici le premier argument est le nom de la migration, et nous avons aussi fourni un second argument avec le nom et le type d'attribut que nous voulons créer (comparez cela avec la génération originale de la table <code>users</code> de l'<a class="ref" href="modeling-and-viewing-users-one#code:generate_user_model">extrait&nbsp;6.1</a>). Nous pouvons choisir le nom de migration que nous voulons, mais il est pratique de terminer le nom par <code>_to_users</code> (<em>pour_users</em>) pour que dans ce cas Rails puisse automatiquement construire une migration qui ajoute les colonnes à la table <code>users</code>. Plus encore, en incluant le second argument, nous donnons assez d'information à Rails pour construire entièrement la migration pour nous, comme le montre l'<a class="ref" href="modeling-and-viewing-users-two#code:password_migration">extrait&nbsp;7.4</a>.</p>

<div class="label" id="code:password_migration"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 7.4.</span> <span class="description">La migration pour ajouter la colonne <code>encrypted_password</code> à la table <code>users</code>. <br /> <code>db/migrate/&lt;timestamp&gt;_add_password_to_users.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">AddPasswordToUsers</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">up</span>
    <span class="n">add_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:encrypted_password</span><span class="p">,</span> <span class="ss">:string</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">down</span>
    <span class="n">remove_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:encrypted_password</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Ce code utilise la méthode <code>add_column</code> (<em>ajouter_colonne</em>) pour ajouter la colonne <code>encrypted_password</code> à la table <code>users</code> (et la méthode complémentaire <code>remove_column</code> pour la supprimer quand nous migrons la base en arrière). Le résultat est le modèle de données montré dans l'<a class="ref" href="modeling-and-viewing-users-two#fig:user_model_password">illustration&nbsp;7.2</a>.</p>

<div class="label" id="fig:user_model_password"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_model_password.png" alt="user_model_password" /></span></div><div class="caption"><span class="header">Illustration 7.2: </span><span class="description">Le modèle User avec un attribut mot de passe (crypté) ajouté.</span></div></div>


<p>Si nous jouons maintenant la migration et préparons le test de la base de données, le test devrait réussir, puisque le modèle User model répondra à l'attribut <code>encrypted_password</code> (assuez-vous de fermer toutes les console Rails lancées dans le «&nbsp;bac à sable&nbsp;» (<em>sandbox</em>)&nbsp;; la <em>sandbox</em> verrouille la base de données et interdit les migrations).</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rake db:migrate
<span class="gp">$</span> rake db:test:prepare
</pre></div>
</div>


<p>Bien sûr, nous pouvons jouer toute la suite de test avec <code>rspec spec/</code>, mais il est pratique parfois de jouer juste <em>une</em> RSpec, ce que nous pouvons faire avec le drapeau <code>-e</code> (&ldquo;exemple&rdquo;)&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rspec spec/models/user_spec.rb <span class="se">\</span>
<span class="gp">&gt;</span> -e <span class="s2">&quot;devrait avoir un attribut mot de passe crytpé&quot;</span>
<span class="go">.</span>

<span class="go">1 example, 0 failures</span>
</pre></div>
</div>


<div class="label" id="sec:an_active_record_callback"></div>


<h3><a id="sec:7.1.3" href="modeling-and-viewing-users-two#sec:an_active_record_callback" class="heading"><span class="number">7.1.3</span> Un <em>callback</em> de l'Active Record</a></h3>


<p>Maintenant que notre modèle User possède un attribut pour consigner le mot de passe, nous devons nous arranger pour générer et sauver le mot de passe crytpé quand Active Record enregistre l'utilisateur dans la base de données. Nous allons faire ça en utilisant une technique appelée un <a href="http://en.wikipedia.org/wiki/Callback_(computer_science)"><em>callback</em></a> (<em>fonction de rappel</em>), qui est méthode qui est invoquée à un point particulier de la vie de l'objet Active Record. Dans le cas présent, nous utiliserons le callback <code>before_save</code> pour créer <code>encrypted_password</code> juste avant que l'utilisateur ne soit enregistré.<sup class="footnote" id="fnref:7.2"><a href="#fn:7.2">2</a></sup></p>

<p>Nous commençons avec un test pour l'attribut mot de passe crytpé. Puisque nous avons différé les détails de l'implémentation &mdash;&nbsp;et, en particulier, la méthode de cryptage&nbsp;&mdash; à la <a class="ref" href="modeling-and-viewing-users-two#sec:secure_passwords">section&nbsp;7.2</a>, dans cette section nous allons seulement nous assurer que l'attribut <code>encrypted_password</code> d'un utilisateur enregistré n'est pas vierge. Nous faisons cela en combinant la méthode <code>blank?</code> sur les chaines de caractères (<a class="ref" href="rails-flavored-ruby#sec:a_class_of_our_own">section&nbsp;4.4.2</a>) avec la convention RSpec pour les méthodes booléennes (vue pour la première fois dans le contexte des méthodes <code>valid?</code>/<code>be_valid</code> dans l'<a class="ref" href="modeling-and-viewing-users-one#code:failing_validates_name_spec">extrait&nbsp;6.11</a>), rendant le test de l'<a class="ref" href="modeling-and-viewing-users-two#code:encrypted_password_not_empty_test">extrait&nbsp;7.5</a>.</p>

<div class="label" id="code:encrypted_password_not_empty_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 7.5.</span> <span class="description">Tester que l'attribut <code>encrypted_password</code> n'est pas vide. <br /> <code>spec/models/user_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;password encryption&quot;</span> <span class="k">do</span>

    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="vi">@attr</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">it</span> <span class="s2">&quot;devrait définir le mot de passe crypté&quot;</span> <span class="k">do</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">encrypted_password</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_blank</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Ce code vérifie que <code>encrypted_password.blank?</code> n'est pas vrai (<em>true</em>) en utilisant la construction <code>should_not be_blank</code>.</p>

<p>Pour faire réussir ce test, nous <em>déclarons</em> un callback appelé <code>encrypt_password</code> en passant un symbole de ce nom à la méthode <code>before_save</code>, et définissons ensuite une méthode <code>encrypt_password</code> pour procéder au cryptage. Avec <code>before_save</code> en place, Active Record appellera automatiquement la méthode correspondante avant d'enregistrer la donnée. Le résultat est présenté dans l'<a class="ref" href="modeling-and-viewing-users-two#code:encrypt_password_callback">extrait&nbsp;7.6</a>.</p>

<div class="label" id="code:encrypt_password_callback"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 7.6.</span> <span class="description">Un callback <code>before_save</code> pour créer l'attribut <code>encrypted_password</code>. <br /> <code>app/models/user.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">validates</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:presence</span>     <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span>
                       <span class="ss">:confirmation</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span>
                       <span class="ss">:length</span>       <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:within</span> <span class="o">=&gt;</span> <span class="mi">6</span><span class="o">.</span><span class="n">.</span><span class="mi">40</span> <span class="p">}</span>

  <span class="n">before_save</span> <span class="ss">:encrypt_password</span>

  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">encrypt_password</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">encrypted_password</span> <span class="o">=</span> <span class="n">encrypt</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">encrypt</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
      <span class="n">string</span> <span class="c1"># Implémentation provisoire&nbsp;!</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Ici le callback <code>encrypt_password</code> délègue en fait le cryptage à une méthode <code>encrypt</code>&nbsp;; comme signalé dans le commentaire, c'est seulement une implémentation provisoire &mdash;&nbsp;construit ainsi, l'<a class="ref" href="modeling-and-viewing-users-two#code:encrypt_password_callback">extrait&nbsp;7.6</a> met simplement le mot de passe crypté à la valeur du mot de passe non crypté, ce qui n'est pas notre but. Mais ça suffit pour faire réussir notre test, et nous ferons que la méthode <code>encrypt</code> procède réellement au cryptage à la <a class="ref" href="modeling-and-viewing-users-two#sec:secure_passwords">section&nbsp;7.2</a>.</p>

<p>Avant d'essayer de comprendre l'implémentation, notez d'abord que les méthodes de cryptage sont placées après le mot-clé <code>private</code>&nbsp;; à l'intérieur d'une classe Ruby, toutes les méthodes définies <em>après</em> le mot-clé <code>private</code> (<em>privé</em>) sont utilisées de façon <em>interne</em> par l'objet et ne sont pas destinées à l'utilisage <em>publique</em>.<sup class="footnote" id="fnref:7.3"><a href="#fn:7.3">3</a></sup> À titre d'exemple, nous pouvons regarder l'objet User dans la méthode&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">encrypt_password</span>
<span class="go">NoMethodError: Attempt to call private method</span>
<span class="c1">(Traduction&nbsp;:</span>
<span class="c1">ErreurPasDeMethode&nbsp;: Tentative d'appel d'une méthode privée)</span>
</pre></div>
</div>


<p>Ici Ruby provoque une exception (erreur) <code>NoMethodError</code> en signalant par une alerte que la méthode <code>encrypt_password</code> est privée.</p>

<p>Dans le contexte présent, rendre les méthodes <code>encrypt_password</code> et <code>encrypt</code> privées n'est pas strictement nécessaire, mais c'est une bonne pratique de les rendre privées sauf si elles sont nécessaire pour l'interface publique.<sup class="footnote" id="fnref:7.4"><a href="#fn:7.4">4</a></sup></p>

<p>Maintenant que nous comprenons le mot-clé <code>private</code>, jettons un autre regard à la méthode <code>encrypt_password</code>&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">encrypt_password</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">encrypted_password</span> <span class="o">=</span> <span class="n">encrypt</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>


<p>C'est une méthode en une ligne (le meilleur genre&nbsp;!), mais elle contient pas seulement une mais <em>deux</em> subtilités. <em>Primo</em> , le côté gauche de la déclaration assigne explicitement l'attribut <code>encrypted_password</code> en utilisant le mot-clé <code>self</code> (<em>soi-même</em>) (de la <a class="ref" href="rails-flavored-ruby#sec:a_class_of_our_own">section&nbsp;4.4.2</a> vous vous souvenez que la classe <code>self</code> se réfère à l'objet lui-même, ce qui pour le modèle User est simplement l'utilisateur). L'utilisation de <code>self</code> est <em>obligatoire</em> dans ce contexte&nbsp;; si nous ommettons <code>self</code> et que nous écrivons&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">encrypt_password</span>
  <span class="n">encrypted_password</span> <span class="o">=</span> <span class="n">encrypt</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>


<p>Ruby créera une <em>variable locale</em> appelée <code>encrypted_password</code>, ce qui n'est pas du tout ce que nous voulons.</p>

<p><em>Secondo</em>, le côté droit de la déclaration appelle <code>encrypt</code> (<em>crypte</em>) sur <code>password</code> (<em>mot de passe</em>), mais il n'y a pas de <code>password</code> en vue. Dans la console, nous devrions accéder à l'attribut mot de passe (<em>password</em>) au travers d'un objet utilisateur&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:password</span> <span class="o">=&gt;</span> <span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">password</span>
<span class="go">=&gt; &quot;foobar&quot;</span>
</pre></div>
</div>


<p>À l'intérieur de la classe User, l'objet utilisateur est juste <code>self</code>, et nous pourrions écrire&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">encrypt_password</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">encrypted_password</span> <span class="o">=</span> <span class="n">encrypt</span><span class="p">(</span><span class="nb">self</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>


<p>… en analogie avec l'exemple en console, remplacez simplement  <code>user</code> par <code>self</code>. Mais le <code>self</code> est optionnel, donc pour la brièveté nous pouvons écrire simplement&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">encrypt_password</span>
  <span class="nb">self</span><span class="o">.</span><span class="n">encrypted_password</span> <span class="o">=</span> <span class="n">encrypt</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>


<p>… comme dans l'<a class="ref" href="modeling-and-viewing-users-two#code:encrypt_password_callback">extrait&nbsp;7.6</a> ci-dessus (bien sûr, comme nous l'avons noté, le <code>self</code> n'est <em>pas</em> optionnel [(when assigning to an attribute)(quand nous assignons un attribut)], donc nous devons écrire <code>self.encrypted_password</code> dans ce cas).</p>

<div class="label" id="sec:secure_passwords"></div>


<h2><a id="sec:7.2" href="modeling-and-viewing-users-two#sec:secure_passwords" class="heading"><span class="number">7.2</span> Mots de passe sécurisés</a></h2>


<p>Avec le code de la <a class="ref" href="modeling-and-viewing-users-two#sec:insecure_passwords">section&nbsp;7.1</a>, en principe nous avons fait&nbsp;: bien que le mot de passe «&nbsp;crypté&nbsp;» soit le même que le mot de passe non crypté, tant que nous voulons enregistrer un mot de passe crypté dans la base de données nous avons les fondations nécessaire pour l'identification et l'authentification de l'utilisateur.<sup class="footnote" id="fnref:7.5"><a href="#fn:7.5">5</a></sup> Notre standard dans ce <em>Tutoriel Rails</em> est moins strict, cependant&nbsp;: tout développeur web digne de ce nom devrait savoir implémenter un système de mot de passe avec un <em>hachage sécurisé à sens unique</em> (<em>secure one-way hashing</em>). Dans cette section, nous construirons le matériel puisé de la <a class="ref" href="modeling-and-viewing-users-two#sec:insecure_passwords">section&nbsp;7.1</a> pour implémenter un tel système de mot de passe robuste.</p>

<div class="label" id="sec:a_secure_password_test"></div>


<h3><a id="sec:7.2.1" href="modeling-and-viewing-users-two#sec:a_secure_password_test" class="heading"><span class="number">7.2.1</span> Un test de mot de passe sécurisé</a></h3>


<p>Comme mentionné à la <a class="ref" href="modeling-and-viewing-users-two#sec:an_active_record_callback">section&nbsp;7.1.3</a>, toute la machinerie pour le cryptage du mot de passe sera soigneusement rangé dans la région <code>private</code> du modèle User, ce qui représente un défi pour le tester. Ce dont nous avons besoin est une espèce d'<em>interface publique</em> que nous pourrions exposer au reste de l'application. Un des aspects utile du «&nbsp;développement conduit par le test&nbsp;» est que, en agissant comme un client pour le code de notre application, les tests nous motive à concevoir une interface utile dès le départ.</p>

<p>L'authentification des utilisateurs implique de pouvoir comparer la version cryptée d'un mot de passe soumis avec le mot de passe (crypté) de l'utilisateur en question. Cela signifie que nous avons besoin de définir des méthode pour accomplir la comparaison, que nous appellerons <code>has_password?</code> (<em>possède_un_motdepasse?</em> )&nbsp;; ce sera notre partie publique de l'interface pour la machinerie de cryptage.<sup class="footnote" id="fnref:7.6"><a href="#fn:7.6">6</a></sup> La méthode <code>has_password?</code> testera si l'utilisateur possède le même mot de passe que celui soumis lors de l'inscription (sera écrit au <a class="ref" href="sign-in-sign-out#top">chapitre&nbsp;9</a>)&nbsp;; un squelette de méthode pour <code>has_password?</code> est présenté dans l'<a class="ref" href="modeling-and-viewing-users-two#code:has_password_skeleton">extrait&nbsp;7.7</a>.</p>

<div class="label" id="code:has_password_skeleton"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 7.7.</span> <span class="description">Une méthode <code>has_password?</code> pour les utilisateurs. <br /> <code>app/models/user.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">before_save</span> <span class="ss">:encrypt_password</span>

  <span class="c1"># Retour true (vrai) si le mot de passe correspond.</span>
  <span class="k">def</span> <span class="nf">has_password?</span><span class="p">(</span><span class="n">submitted_password</span><span class="p">)</span>
    <span class="c1"># Compare encrypted_password avec la version cryptée de</span>
    <span class="c1"># submitted_password.</span>
  <span class="k">end</span>

  <span class="kp">private</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Avec cette méthode, nous pouvons écrire des tests comme dans l'<a class="ref" href="modeling-and-viewing-users-two#code:has_password_tests">extrait&nbsp;7.8</a>, qui utilise les méthodes RSpec <code>be_true</code> (<em>être_vrai</em>) et <code>be_false</code> (<em>être_faux</em>) pour tester que <code>has_password?</code> retourne <code>true</code> ou <code>false</code> dans les cas appropriés.</p>

<div class="label" id="code:has_password_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 7.8.</span> <span class="description">Tests pour la méthode <code>has_password?</code>. <br /> <code>spec/models/user_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;password encryption&quot;</span> <span class="k">do</span>

    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="vi">@attr</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;has_password? method&quot;</span> <span class="k">do</span>

      <span class="n">it</span> <span class="s2">&quot;devrait être vrai si les mots de passe coïncident&quot;</span> <span class="k">do</span>
        <span class="vi">@user</span><span class="o">.</span><span class="n">has_password?</span><span class="p">(</span><span class="vi">@attr</span><span class="o">[</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="n">be_true</span>
      <span class="k">end</span>    

      <span class="n">it</span> <span class="s2">&quot;devrait être faux si les mots de passe sont différents&quot;</span> <span class="k">do</span>
        <span class="vi">@user</span><span class="o">.</span><span class="n">has_password?</span><span class="p">(</span><span class="s2">&quot;invalid&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="n">be_false</span>
      <span class="k">end</span> 
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>À la <a class="ref" href="modeling-and-viewing-users-two#sec:implementing_has_password">section&nbsp;7.2.3</a>, nous complèterons l'implémentation de <code>has_password?</code> (et obtiendrons que le test réussisse dans le processus). Mais d'abord nous avons besoin d'en apprendre un peu plus sur les mots de passe sécurisés.</p>

<div class="label" id="sec:secure_password_theory"></div>


<h3><a id="sec:7.2.2" href="modeling-and-viewing-users-two#sec:secure_password_theory" class="heading"><span class="number">7.2.2</span> Un peu de théorie sur la sécurisation des mots de passe</a></h3>


<p>L'idée de base d'un mot de passe crytpés est simple&nbsp;: plutôt que d'enregistre un mot de passe tel quel dans la base de données (donc en «&nbsp;texte clair&nbsp;»), nous enregistrons une chaine de caractères générée en utilisant une <em>fonction de hachage cryptographique</em> (<a href="http://en.wikipedia.org/wiki/Cryptographic_hash_function">cryptographic hash function</a>), qui est par essence irréversible, de telle sorte que même un hacker en possession de la version cryptée du mot de passe sera incapable d'en déduire l'original. Pour vérifier qu'un mot de passe soumis coïncide avec le mot de passe de l'utilisateur, nous cryptons d'abord la chaine de caractères soumise puis nous la comparons au mot de passe crypté enregistré. Rejoignons une session de console pour voir comment tout cela fonctionne&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="nb">require</span> <span class="s1">&#39;digest&#39;</span>
<span class="gp">&gt;&gt; </span><span class="k">def</span> <span class="nf">secure_hash</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
<span class="gp">&gt;&gt; </span>  <span class="no">Digest</span><span class="o">::</span><span class="no">SHA2</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">=&gt; nil</span>
<span class="gp">&gt;&gt; </span><span class="n">password</span> <span class="o">=</span> <span class="s2">&quot;secret&quot;</span>
<span class="go">=&gt; &quot;secret&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">encrypted_password</span> <span class="o">=</span> <span class="n">secure_hash</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
<span class="go">=&gt; &quot;2bb80d537b1da3e38bd30361aa855686bde0eacd7162fef6a25fe97bf527a25b&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">submitted_password</span> <span class="o">=</span> <span class="s2">&quot;secret&quot;</span>
<span class="go">=&gt; &quot;secret&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">encrypted_password</span> <span class="o">==</span> <span class="n">secure_hash</span><span class="p">(</span><span class="n">submitted_password</span><span class="p">)</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p>Ici nous avons défini une fonction appelée <code>secure_hash</code> qui utilise une fonction de hachage cryptographique appelée SHA2, qui fait partie de la <a href="http://en.wikipedia.org/wiki/SHA_hash_functions">famille SHA des fonctions de hachage</a>, que nous incluons dans Ruby par la libraiie <code>digest</code>.<sup class="footnote" id="fnref:7.7"><a href="#fn:7.7">7</a></sup> Il n'est pas utile de savoir exactement comment fonctionnent ces fonctions&nbsp;; ce qui est important pour notre propos est qu'elles sont à sens unique&nbsp;: il n'y a aucune façon informatisable de découvrir que&nbsp;:</p>

<pre class="verbatim">2bb80d537b1da3e38bd30361aa855686bde0eacd7162fef6a25fe97bf527a25b</pre>


<p>est le hachage SHA2 de la chaine <code>"secret"</code>.</p>

<p>Si vous y réfléchissez, cependant, nous avons toujours un problème&nbsp;: si un hacker entrait en possession des mots de passe hachés, il pourrait quand même avoir une chance de découvrir les mots de passe originaux. Par exemple, il pourrait supposer que nous utilisons SHA2 et ainsi écrire un programme pour comparer un hachage donné avec les valeurs possible des mots de passe&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="nb">hash</span> <span class="o">=</span> <span class="s2">&quot;2bb80d537b1da3e38bd30361aa855686bde0eacd7162fef6a25fe97bf527a25b&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">secure_hash</span><span class="p">(</span><span class="s2">&quot;secede&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="nb">hash</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="n">secure_hash</span><span class="p">(</span><span class="s2">&quot;second&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="nb">hash</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="n">secure_hash</span><span class="p">(</span><span class="s2">&quot;secret&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="nb">hash</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p>Donc notre hacker obtient une correspondance &mdash;&nbsp;mauvaise nouvelle pour les utilisateurs qui utilisent le mot de passe <code>"secret"</code>. Cette technique est connue sous le nom <a href="http://en.wikipedia.org/wiki/Rainbow_attack"><em>rainbow attack</em></a> (<em>attaque arc-en-ciel</em>).</p>

<p>Pour faire échouer une possible attaque arc-en-ciel, on peut utiliser un <a href="http://en.wikipedia.org/wiki/Salt_(cryptography)"><em>salt</em></a> (<em>un sel</em>, ou un <em>grain de sel</em>), qui est une chaine de caractères différente pour chaque utilisateur.<sup class="footnote" id="fnref:7.8"><a href="#fn:7.8">8</a></sup> Une façon courante de s'assurer l'unicité (ou presque) est de hacher le temps courant (en <a href="http://en.wikipedia.org/wiki/Coordinated_Universal_Time">UTC</a> pour être indépendant de la zone de temps) avec le mot de passe, de telle sorte que deux utilisateurs auraient le même <em>sel</em> seulement s'ils s'étaient inscrits exactement en même temps <em>et</em> avaient exactement le même mot de passe. Voyons comment cela fonctionne en utilisant la fonction <code>secure_hash</code> définie plus haut à la console&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">utc</span>
<span class="go">=&gt; Fri Jan 29 18:11:27 UTC 2010</span>
<span class="gp">&gt;&gt; </span><span class="n">password</span> <span class="o">=</span> <span class="s2">&quot;secret&quot;</span>
<span class="go">=&gt; &quot;secret&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">salt</span> <span class="o">=</span> <span class="n">secure_hash</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">utc</span><span class="si">}</span><span class="s2">--</span><span class="si">#{</span><span class="n">password</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="go">=&gt; &quot;d1a3eb8c9aab32ec19cfda810d2ab351873b5dca4e16e7f57b3c1932113314c8&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">encrypted_password</span> <span class="o">=</span> <span class="n">secure_hash</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">salt</span><span class="si">}</span><span class="s2">--</span><span class="si">#{</span><span class="n">password</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="go">=&gt; &quot;69a98a49b7fd103058639be84fb88c19c998c8ad3639cfc5deb458018561c847&quot;</span>
</pre></div>
</div>


<p>Dans les dernières lignes, nous avons haché le sel avec le mot de passe, pour retourner un mot de passe crytpé qu'il est virtuellement impossible de cracker (pour la clareté, les arguments des fonctions de hachage sont souvent séparés par <tt class="verb">--</tt>).</p>

<div class="label" id="sec:implementing_has_password"></div>

<!--FIN FRENCH-->
<h3><a id="sec:7.2.3" href="modeling-and-viewing-users-two#sec:implementing_has_password" class="heading"><span class="number">7.2.3</span> Implementing <code>has_password?</code></a></h3>


<p>Having finished with the theory, we&rsquo;re now ready for the implementation. Let&rsquo;s look ahead a little to see where we&rsquo;re going. Each user object knows its own mot de passe crytpé, so to check for a match with a submitted password we can define <code>has_password?</code> as follows:</p>

<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">has_password?</span><span class="p">(</span><span class="n">submitted_password</span><span class="p">)</span>
  <span class="n">encrypted_password</span> <span class="o">==</span> <span class="n">encrypt</span><span class="p">(</span><span class="n">submitted_password</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>


<p>As long as we encrypt the submitted password using the same salt used to encrypt the original password, this function will be true if and only if the submitted password matches.</p>

<p>Since comparing a user password with a submitted password will involve encrypting the submitted password with the salt, we need to store the salt somewhere, so the first step is to add a <code>salt</code> column to the <code>users</code> table:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate migration add_salt_to_users salt:string
</pre></div>
</div>


<p>As with the <code>encrypted_password</code> migration (<a class="ref" href="modeling-and-viewing-users-two#sec:password_migration">section&nbsp;7.1.2</a>), this migration has a name that ends in <code>_to_users</code> and passes a second argument containing the attribute name and type, so Rails automatically constructs the right migration (<a class="ref" href="modeling-and-viewing-users-two#code:salt_migration">extrait&nbsp;7.9</a>).</p>

<div class="label" id="code:salt_migration"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 7.9.</span> <span class="description">The migration to add a <code>salt</code> column to the <code>users</code> table. <br /> <code>db/migrate/&lt;timestamp&gt;_add_salt_to_users.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">AddSaltToUsers</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">up</span>
    <span class="n">add_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:salt</span><span class="p">,</span> <span class="ss">:string</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">down</span>
    <span class="n">remove_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:salt</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Then we migrate the base de données and prepare the test base de données as usual:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rake db:migrate
<span class="gp">$</span> rake db:test:prepare
</pre></div>
</div>


<p>The result is a base de données with the data model shown in <a class="ref" href="modeling-and-viewing-users-two#fig:user_model_salt">illustration&nbsp;7.3</a>.</p>

<div class="label" id="fig:user_model_salt"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_model_salt.png" alt="user_model_salt" /></span></div><div class="caption"><span class="header">Illustration 7.3: </span><span class="description">The User model with an added salt.</span></div></div>


<p>Finally, we&rsquo;re ready for the full implementation. When last we saw the <code>encrypt</code> function (<a class="ref" href="modeling-and-viewing-users-two#code:encrypt_password_callback">extrait&nbsp;7.6</a>), it did nothing, simply returning the string in its argument. With the ideas from <a class="ref" href="modeling-and-viewing-users-two#sec:secure_password_theory">section&nbsp;7.2.2</a>, we&rsquo;re now in a position to use a secure hash instead (<a class="ref" href="modeling-and-viewing-users-two#code:has_password_with_encrypt">extrait&nbsp;7.10</a>).<sup class="footnote" id="fnref:7.9"><a href="#fn:7.9">9</a></sup></p>

<div class="label" id="code:has_password_with_encrypt"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 7.10.</span> <span class="description">The <code>has_password?</code> method with secure encryption. <br /> <code>app/models/user.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;digest&#39;</span>
<span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">before_save</span> <span class="ss">:encrypt_password</span>

  <span class="k">def</span> <span class="nf">has_password?</span><span class="p">(</span><span class="n">submitted_password</span><span class="p">)</span>
    <span class="n">encrypted_password</span> <span class="o">==</span> <span class="n">encrypt</span><span class="p">(</span><span class="n">submitted_password</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">encrypt_password</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">salt</span> <span class="o">=</span> <span class="n">make_salt</span> <span class="k">if</span> <span class="n">new_record?</span>
      <span class="nb">self</span><span class="o">.</span><span class="n">encrypted_password</span> <span class="o">=</span> <span class="n">encrypt</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">encrypt</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
      <span class="n">secure_hash</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">salt</span><span class="si">}</span><span class="s2">--</span><span class="si">#{</span><span class="n">string</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">make_salt</span>
      <span class="n">secure_hash</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">utc</span><span class="si">}</span><span class="s2">--</span><span class="si">#{</span><span class="n">password</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">secure_hash</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
      <span class="no">Digest</span><span class="o">::</span><span class="no">SHA2</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>This code contains the same two subtleties mentioned in <a class="ref" href="modeling-and-viewing-users-two#sec:an_active_record_callback">section&nbsp;7.1.3</a>, namely, the assignment to an Active Record attribute in the line</p>

<div class="code"><div class="highlight"><pre><span class="nb">self</span><span class="o">.</span><span class="n">salt</span> <span class="o">=</span> <span class="n">make_salt</span> <span class="k">if</span> <span class="n">new_record?</span>
</pre></div>
</div>


<p>and the omission of the <code>self</code> keyword in the <code>encrypt</code> method:</p>

<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">encrypt</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
  <span class="n">secure_hash</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">salt</span><span class="si">}</span><span class="s2">--</span><span class="si">#{</span><span class="n">string</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>


<p>Since we&rsquo;re inside the User class, Ruby knows that <code>salt</code> refers to the user&rsquo;s <code>salt</code> attribute.</p>

<p>It&rsquo;s also important to note the use of Active Record&rsquo;s <code>new_record?</code> boolean method, which returns true if the object has not yet been saved to the base de données. Since the salt is a unique identifier for each user, we don&rsquo;t want it to change every time the user is updated (as in <a class="ref" href="updating-showing-and-deleting-users#sec:updating_users">section&nbsp;10.1</a>), and by including <code>new_record?</code> we ensure that the salt is only created <em>once</em>, when the user is first created.<sup class="footnote" id="fnref:7.10"><a href="#fn:7.10">10</a></sup> (This subtlety doesn&rsquo;t matter now, but it will when we implement a &ldquo;remember me&rdquo; signin feature in <a class="ref" href="sign-in-sign-out#sec:remember_me">section&nbsp;9.3.2</a>.)</p>

<p>At this point, the tests from <a class="ref" href="modeling-and-viewing-users-two#code:has_password_tests">extrait&nbsp;7.8</a> should pass:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rspec spec/models/user_spec.rb -e <span class="s2">&quot;should be true if the passwords match&quot;</span>
<span class="go">.</span>

<span class="go">1 example, 0 failures</span>

<span class="gp">$</span> rspec spec/models/user_spec.rb <span class="se">\</span>
<span class="gp">&gt;</span> -e <span class="s2">&quot;should be false if the passwords don&#39;t match&quot;</span>
<span class="go">.</span>

<span class="go">1 example, 0 failures</span>
</pre></div>
</div>


<p>We can also run all the examples in a particular <code>describe</code> block, but we do have to be careful to <em>escape</em> any special <a href="http://rubular.com/">regular expression</a> characters&mdash;in this case, the question mark&nbsp;<code>?</code> in <code>"has_password? method"</code>:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rspec spec/models/user_spec.rb -e <span class="s2">&quot;has_password\? method&quot;</span>
<span class="go">Run filtered using {:full_description=&gt;/(?-mix:has_password\? method)/}</span>
<span class="go">..</span>

<span class="go">2 examples, 0 failures</span>
</pre></div>
</div>


<p>The backslash before the question mark ensures that RSpec&rsquo;s regular expression matcher interprets the string correctly, thereby running the tests associated with the given <code>describe</code> block.</p>

<div class="label" id="sec:an_authenticate_method"></div>


<h3><a id="sec:7.2.4" href="modeling-and-viewing-users-two#sec:an_authenticate_method" class="heading"><span class="number">7.2.4</span> An authenticate method</a></h3>


<p>Having a <code>has_password?</code> method for each user is nice, but by itself it isn&rsquo;t very useful. We&rsquo;ll end our discussion of passwords by using <code>has_password?</code> to write a method to authenticate a user based on an email/password combination. In <a class="ref" href="sign-in-sign-out#top">chapitre&nbsp;9</a>, we&rsquo;ll use this <code>authenticate</code> method when signing users in to our site.</p>

<p>We can get a hint of how this will work by using the console. First, we&rsquo;ll create a user, and then retrieve that user by email address to verify that it has a given password:<sup class="footnote" id="fnref:7.11"><a href="#fn:7.11">11</a></sup></p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console --sandbox</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">:nom</span> <span class="o">=&gt;</span> <span class="s2">&quot;Michael Hartl&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;mhartl@example.com&quot;</span><span class="p">,</span>
<span class="gp">?&gt; </span>             <span class="ss">:password</span> <span class="o">=&gt;</span> <span class="s2">&quot;foobar&quot;</span><span class="p">,</span> <span class="ss">:password_confirmation</span> <span class="o">=&gt;</span> <span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="s2">&quot;mhartl@example.com&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">has_password?</span><span class="p">(</span><span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p>Using these ideas, let&rsquo;s write a method that will return an authenticated user on password match, and <code>nil</code> otherwise. We should be able to use the resulting <code>authenticate</code> class method as follows:</p>

<div class="code"><div class="highlight"><pre><span class="no">User</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">submitted_password</span><span class="p">)</span>
</pre></div>
</div>


<p>We start with the tests, which we&rsquo;ll use to specify the behavior we expect from <code>User.authenticate</code>. There are three cases to check: <code>authenticate</code>&nbsp;(1) should return <code>nil</code> when the email/password combination is invalid or&nbsp;(2) when no user exists with the given email address, and&nbsp;(3) should return the user object itself on success. With this information, we can write the tests for <code>authenticate</code> as in <a class="ref" href="modeling-and-viewing-users-two#code:authenticate_method_tests">extrait&nbsp;7.11</a>.</p>

<div class="label" id="code:authenticate_method_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 7.11.</span> <span class="description">Tests for the <code>User.authenticate</code> method. <br /> <code>spec/models/user_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;password encryption&quot;</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;authenticate method&quot;</span> <span class="k">do</span>

      <span class="n">it</span> <span class="s2">&quot;should return nil on email/password mismatch&quot;</span> <span class="k">do</span>
        <span class="n">wrong_password_user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="vi">@attr</span><span class="o">[</span><span class="ss">:email</span><span class="o">]</span><span class="p">,</span> <span class="s2">&quot;wrongpass&quot;</span><span class="p">)</span>
        <span class="n">wrong_password_user</span><span class="o">.</span><span class="n">should</span> <span class="n">be_nil</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should return nil for an email address with no user&quot;</span> <span class="k">do</span>
        <span class="n">nonexistent_user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="s2">&quot;bar@foo.com&quot;</span><span class="p">,</span> <span class="vi">@attr</span><span class="o">[</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
        <span class="n">nonexistent_user</span><span class="o">.</span><span class="n">should</span> <span class="n">be_nil</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should return the user on email/password match&quot;</span> <span class="k">do</span>
        <span class="n">matching_user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="vi">@attr</span><span class="o">[</span><span class="ss">:email</span><span class="o">]</span><span class="p">,</span> <span class="vi">@attr</span><span class="o">[</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
        <span class="n">matching_user</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="vi">@user</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Now we&rsquo;re ready for the implementation, which will get our tests to pass and show how to define a <em>class method</em> as a bonus. We&rsquo;ve mentioned class methods several times before, most recently in <a class="ref" href="modeling-and-viewing-users-one#sec:base de données_migrations">section&nbsp;6.1.1</a>; a class method is simply a method attached to a class, rather than an instance of that class. For example, <code>new</code>, <code>find</code>, and <code>find_by_email</code> are all class methods on the User class. Outside of the class, they are invoked using the class name, as in <code>User.find</code>, but inside the class we can omit the class name.</p>

<div class="label" id="sidebar:self"></div>


<div class="sidebar"><span class="title"><span class="header">Box 7.1.</span><span class="description">What is <code>self</code>?</span></span>
<p>We&rsquo;ve talked about how <code>self</code> is &ldquo;the object itself&rdquo;, but exactly what that means depends on context. Inside of an ordinary method, <code>self</code> refers to an <em>instance</em> of the class, that is, the object itself. For example, in <a class="ref" href="modeling-and-viewing-users-two#code:has_password_with_encrypt">extrait&nbsp;7.10</a>, <code>self</code> is a <em>user</em>:</p>

<pre class="verbatim">  def encrypt_password
    self.salt = make_salt if new_record?
    self.encrypted_password = encrypt(password)
  end</pre>


<p>Inside the <code>encrypt_password</code> method, <code>self</code> is a user object, so <code>self.salt</code> is the same as <code>user.salt</code> outside the method:</p>

<pre class="verbatim">  $ rails console
  &gt;&gt; user = User.first
  &gt;&gt; user.salt
  =&gt; &quot;d3b9af261c502947fbf32f78cb8179b16e62eabacf059451efee404328b2f537&quot;</pre>


<p>On the other hand, <a class="ref" href="modeling-and-viewing-users-two#code:authenticate_method">extrait&nbsp;7.12</a> shows the definition of <code>authenticate</code>, which uses <code>self</code> to define a <em>class method</em>; here, <code>self</code> is the <code>User</code> class itself:</p>

<pre class="verbatim">  def self.authenticate(email, submitted_password)
    .
    .
    .
  end</pre>


<p>Because it is defined on the <code>User</code> class, <code>authenticate</code> gets invoked directly on <code>User</code>:</p>

<pre class="verbatim">  &gt;&gt; user = User.authenticate('example@railstutorial.org', 'foobar')
  &gt;&gt; user.name
  =&gt; &quot;Utilisateur exemple&quot;</pre>


<p>It&rsquo;s worth noting two alternative ways of defining an <code>authenticate</code> class method equivalent to the one shown in <a class="ref" href="modeling-and-viewing-users-two#code:authenticate_method">extrait&nbsp;7.12</a>. First, we could indicate the <code>User</code> class explicitly by name:</p>

<pre class="verbatim">  def User.authenticate(email, submitted_password)
    .
    .
    .
  end</pre>


<p>(Some people might find this syntax clearer, but it&rsquo;s not as idiomatically correct.) Second, we could use the following code, which quite frankly melts my brain:</p>

<pre class="verbatim">  class &lt;&lt; self
    def authenticate(email, submitted_password)
      .
      .
      .
    end
  end</pre>


<p>The weird <code>class &lt;&lt; self</code> starts a block in which all new methods are automatically class methods. I find this syntax rather confusing, but it&rsquo;s possible you&rsquo;ll encounter it in others&rsquo; code, so it&rsquo;s worth knowing what it does. (I recommend <a href="http://www.amazon.com/gp/product/1933988657?ie=UTF8&amp;tag=httpwwwrailst-20&amp;linkCode=as2&amp;camp=1789&amp;creative=9325&amp;creativeASIN=1933988657"><em>The Well-Grounded Rubyist</em></a> by David&nbsp;A. Black if you want to dig into Ruby details like this one.)</p>
</div>


<p>The way to define a class method is to use the <code>self</code> keyword in the method definition. (This <code>self</code> is not the same as the <code>self</code> shown in <a class="ref" href="modeling-and-viewing-users-two#code:has_password_with_encrypt">extrait&nbsp;7.10</a>; see <a class="ref" href="modeling-and-viewing-users-two#sidebar:self">Box&nbsp;7.1</a>.) <a class="ref" href="modeling-and-viewing-users-two#code:authenticate_method">extrait&nbsp;7.12</a> shows this construction in the context of the <code>authenticate</code> method. Note the call to <code>find_by_email</code>, in which we omit the explicit <code>User</code> class name since this method is already inside the <code>User</code> class.</p>

<div class="label" id="code:authenticate_method"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 7.12.</span> <span class="description">The <code>User.authenticate</code> method. <br /> <code>app/models/user.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">has_password?</span><span class="p">(</span><span class="n">submitted_password</span><span class="p">)</span>
    <span class="n">encrypted_password</span> <span class="o">==</span> <span class="n">encrypt</span><span class="p">(</span><span class="n">submitted_password</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">authenticate</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">submitted_password</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">find_by_email</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
    <span class="k">return</span> <span class="kp">nil</span>  <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">nil?</span>
    <span class="k">return</span> <span class="n">user</span> <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">has_password?</span><span class="p">(</span><span class="n">submitted_password</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="kp">private</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>There are several equivalent ways to write the <code>authenticate</code> method, but I find the implementation above the clearest. It handles two cases (invalid email and a successful match) with explicit <code>return</code> keywords, and handles the third case (password mismatch) implicitly, since in that case we reach the end of the method, which automatically returns <code>nil</code>. See <a class="ref" href="modeling-and-viewing-users-two#sec:more_modeling_users_exercises">section&nbsp;7.5</a> for some of the other possible ways to implement this method.</p>

<div class="label" id="sec:better_user_views"></div>


<h2><a id="sec:7.3" href="modeling-and-viewing-users-two#sec:better_user_views" class="heading"><span class="number">7.3</span> Better user views</a></h2>


<p>Now that User model is effectively complete,<sup class="footnote" id="fnref:7.12"><a href="#fn:7.12">12</a></sup> we are in a position to add a sample user to the development base de données and make a <code>show</code> page to show some of that user&rsquo;s information. Along the way, we&rsquo;ll add some tests to the Users controller spec started in <a class="ref" href="filling-in-the-layout#sec:users_controller">section&nbsp;5.3.1</a>.</p>

<p>Before continuing, it&rsquo;s helpful to see where we left off by recalling what the Users controller spec looks like right now (<a class="ref" href="modeling-and-viewing-users-two#code:get_new_user_spec_review">extrait&nbsp;7.13</a>). Our tests for the user show page will follow this example, but we&rsquo;ll find that, unlike the tests for the <code>new</code> action, the tests for the <code>show</code> action will require the use of an instance of the User model. We&rsquo;ll meet this challenge using a technique called <em>factories</em>.</p>

<div class="label" id="code:get_new_user_spec_review"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 7.13.</span> <span class="description">The current Users controller spec. <br /> <code>spec/controllers/users_controller_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">UsersController</span> <span class="k">do</span>
  <span class="n">render_views</span>

  <span class="n">describe</span> <span class="s2">&quot;GET &#39;new&#39;&quot;</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">&quot;should be successful&quot;</span> <span class="k">do</span>
      <span class="n">get</span> <span class="s1">&#39;new&#39;</span>
      <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">be_success</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should have the right title&quot;</span> <span class="k">do</span>
      <span class="n">get</span> <span class="s1">&#39;new&#39;</span>
      <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="s2">&quot;Sign up&quot;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="sec:tests_with_factories"></div>


<h3><a id="sec:7.3.1" href="modeling-and-viewing-users-two#sec:tests_with_factories" class="heading"><span class="number">7.3.1</span> Testing the user show page (with factories)</a></h3>


<p>Tests for the Users controller will need instances of User model objects, preferably with pre-defined values. For example, as seen in <a class="ref" href="modeling-and-viewing-users-two#code:user_show_reminder">extrait&nbsp;7.14</a>, the Users controller <code>show</code> action needs an instance of the User class, so the tests for this action will require that we create an <code>@user</code> variable somehow. We&rsquo;ll accomplish this goal with a user <em>factory</em>, which is a convenient way to define a user object and insert it into our test base de données.<sup class="footnote" id="fnref:7.13"><a href="#fn:7.13">13</a></sup></p>

<div class="label" id="code:user_show_reminder"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 7.14.</span> <span class="description">The user <code>show</code> action from <a class="ref" href="modeling-and-viewing-users-one#code:user_show_action">extrait&nbsp;6.25</a>. <br /> <code>app/controllers/users_controller.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">show</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>We&rsquo;ll be using the factories generated by <a href="http://github.com/thoughtbot/factory_girl">Factory Girl</a>,<sup class="footnote" id="fnref:7.14"><a href="#fn:7.14">14</a></sup> a Ruby gem produced by the good people at <a href="http://thoughtbot.com/">thoughtbot</a>. As with other Ruby gems, we can install it by adding a line to the <code>Gemfile</code> used by Bundler (<a class="ref" href="modeling-and-viewing-users-two#code:gemfile_factory_girl">extrait&nbsp;7.15</a>). (Since Factory Girl is only needed in the tests, we&rsquo;ve included it in the <code>:test</code> group.)</p>

<div class="label" id="code:gemfile_factory_girl"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 7.15.</span> <span class="description">Adding Factory Girl to the <code>Gemfile</code>.</span>       
</div>
<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">&#39;http://rubygems.org&#39;</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="n">group</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">gem</span> <span class="s1">&#39;factory_girl_rails&#39;</span><span class="p">,</span> <span class="s1">&#39;1.0&#39;</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Then install as usual:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle install
</pre></div>
</div>


<p>Now we&rsquo;re ready to create the file <code>spec/factories.rb</code> and define a User factory, as shown in <a class="ref" href="modeling-and-viewing-users-two#code:user_factory">extrait&nbsp;7.16</a>. By putting the <code>factories.rb</code> file in the <code>spec/</code> directory, we arrange for RSpec to load our factories automatically whenever the tests run.</p>

<div class="label" id="code:user_factory"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 7.16.</span> <span class="description">A factory to simulate User model objects. <br /> <code>spec/factories.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="c1"># By using the symbol &#39;:user&#39;, we get Factory Girl to simulate the User model.</span>
<span class="no">Factory</span><span class="o">.</span><span class="n">define</span> <span class="ss">:user</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
  <span class="n">user</span><span class="o">.</span><span class="n">name</span>                  <span class="s2">&quot;Michael Hartl&quot;</span>
  <span class="n">user</span><span class="o">.</span><span class="n">email</span>                 <span class="s2">&quot;mhartl@example.com&quot;</span>
  <span class="n">user</span><span class="o">.</span><span class="n">password</span>              <span class="s2">&quot;foobar&quot;</span>
  <span class="n">user</span><span class="o">.</span><span class="n">password_confirmation</span> <span class="s2">&quot;foobar&quot;</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>With the definition in <a class="ref" href="modeling-and-viewing-users-two#code:user_factory">extrait&nbsp;7.16</a>, we can create a User factory in the tests like this:</p>

<div class="code"><div class="highlight"><pre><span class="vi">@user</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
</pre></div>
</div>


<p>As noted in the comment in the first line of <a class="ref" href="modeling-and-viewing-users-two#code:user_factory">extrait&nbsp;7.16</a>, by using the symbol <code>:user</code> we ensure that Factory Girl will guess that we want to use the User model, so in this case <code>@user</code> will simulate an instance of <code>User</code>.</p>

<p>To use our new User factory in the Users controller spec, we&rsquo;ll create an <code>@user</code> variable in a <code>before(:each)</code> block and then <code>get</code> the show page and verify success (just as we did with the <code>new</code> page in <a class="ref" href="modeling-and-viewing-users-two#code:get_new_user_spec_review">extrait&nbsp;7.13</a>), while also verifying that the <code>show</code> action pulls the correct user out of the base de données. The result appears in <a class="ref" href="modeling-and-viewing-users-two#code:get_show_test">extrait&nbsp;7.17</a>. (If you&rsquo;re using Spork, you might have to restart it to get these tests to pass.)</p>

<div class="label" id="code:get_show_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 7.17.</span> <span class="description">A test for <code>get</code>ting the user <code>show</code> page, with a user factory. <br /> <code>spec/controllers/users_controller_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">UsersController</span> <span class="k">do</span>
  <span class="n">render_views</span>

  <span class="n">describe</span> <span class="s2">&quot;GET &#39;show&#39;&quot;</span> <span class="k">do</span>

    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should be successful&quot;</span> <span class="k">do</span>
      <span class="n">get</span> <span class="ss">:show</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="vi">@user</span>
      <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">be_success</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should find the right user&quot;</span> <span class="k">do</span>
      <span class="n">get</span> <span class="ss">:show</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="vi">@user</span>
      <span class="n">assigns</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="vi">@user</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Apart from the first use of a factory, the real novelty here is the use of a <code>assigns(:user)</code>, which is a facility provided by RSpec (via the underlying <tt>Test::Unit</tt> library). The <code>assigns</code> method takes in a symbol argument and returns the value of the corresponding <em>instance</em> variable in the controller action. In other words, in <a class="ref" href="modeling-and-viewing-users-two#code:get_show_test">extrait&nbsp;7.17</a> the code</p>

<div class="code"><div class="highlight"><pre><span class="n">assigns</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
</pre></div>
</div>


<p>returns the value of the instance variable</p>

<div class="code"><div class="highlight"><pre><span class="vi">@user</span>
</pre></div>
</div>


<p>in the <code>show</code> action of the Users controller. The test</p>

<div class="code"><div class="highlight"><pre><span class="n">assigns</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="vi">@user</span>
</pre></div>
</div>


<p>then verifies that the variable retrieved from the base de données in the action corresponds to the <code>@user</code> instance created by Factory Girl. It&rsquo;s worth noting that not all Rails programmers use <code>assigns</code> in this context, preferring instead to use a technique called <em>stubbing</em> (<a class="ref" href="modeling-and-viewing-users-two#sidebar:stubbing">Box&nbsp;7.2</a>).</p>

<div class="label" id="sidebar:stubbing"></div>


<div class="sidebar"><span class="title"><span class="header">Box 7.2.</span><span class="description">To <code>stub!</code> or not to <code>stub!</code>.</span></span>
<p>The code in <a class="ref" href="modeling-and-viewing-users-two#code:get_show_test">extrait&nbsp;7.17</a> relies on the <code>User.find</code> method in the controller action to retrieve the right user from the test base de données. A second way to achieve this same result is using a technique called <em>stubbing</em>, using RSpec&rsquo;s <code>stub!</code> method:</p>

<pre class="verbatim">  before(:each)
    @user = Factory(:user)
    User.stub!(:find, @user.id).and_return(@user)
  end</pre>


<p>This code ensures that any call to <code>User.find</code> with the given <code>id</code> will return <code>@user</code>. Since this is just what we have in the application code (<a class="ref" href="modeling-and-viewing-users-two#code:user_show_reminder">extrait&nbsp;7.14</a>), the stub will cause RSpec to intercept the call to <code>User.find</code> and, instead of hitting the base de données, return <code>@user</code> instead.</p>

<p>Many Rails programmers, especially RSpec users, prefer this stubbing approach because it separates the controller tests from the model layer. Indeed, the <a href="http://railstutorial.org/book?version=2.3">Rails 2.3 version of this book</a> uses stubs, along with the closely related technique of <em>message expectations</em>. After gaining more experience with stubs and expectations, and especially after fielding lots of questions from readers of the <em>Rails 2.3 Tutorial</em> confused by these issues, I have concluded that stubbing and related techniques are not worth the trouble.</p>

<p>Figuring out exactly when to stub things out is difficult, and message expectations are incredibly subtle and error-prone (see, e.g., <a href="http://railstutorial.org/chapters/sign-up?version=2.3#sidebar:expectation_subtlety">Box&nbsp;8.1 in the <em>Rails 2.3 Tutorial</em> book</a>). To the common objection, &ldquo;But now the controller tests hit the test base de données!&rdquo;, I now find myself saying: &ldquo;So what?&rdquo; In my experience it has never mattered. I see no compelling reason not to hit the model layer in the controller tests, especially when it leads to much simpler tests. If you are interested in learning stubbing and message expectation techniques, I recommend reading the <a href="http://railstutorial.org/book?version=2.3"><em>Ruby on Rails 2.3 Tutorial</em> book</a>. Otherwise, I suggest not worrying about enforcing a full separation of the model and controller layers in Rails tests. Although the controller tests in the rest of this book will hit the test base de données, at a <em>conceptual</em> level it will always be clear which part of MVC is being tested.</p>

<p>By the way, in principle the tests should run faster when the controllers don&rsquo;t hit the base de données, and for the full <em>Rails Tutorial</em> sample application test suite they do&mdash;by around two-tenths of a second.</p>
</div>


<p>There are two other details in <a class="ref" href="modeling-and-viewing-users-two#code:get_show_test">extrait&nbsp;7.17</a> worth noting. First, in the call to <code>get</code>, the test uses the <em>symbol</em> <code>:show</code> instead of the string <code>&rsquo;show&rsquo;</code>, which is different from the convention in the other tests (for example, in <a class="ref" href="static-pages#code:default_pages_controller_spec">extrait&nbsp;3.11</a> we wrote <code>get &rsquo;home&rsquo;</code>). Both</p>

<div class="code"><div class="highlight"><pre><span class="n">get</span> <span class="ss">:show</span>
</pre></div>
</div>


<p>and</p>

<div class="code"><div class="highlight"><pre><span class="n">get</span> <span class="s1">&#39;show&#39;</span>
</pre></div>
</div>


<p>do the same thing, but when testing the canonical REST actions (<a class="ref" href="modeling-and-viewing-users-one#table:RESTful_users">Table&nbsp;6.2</a>) I prefer to use symbols, which for some reason feel more natural in this context.<sup class="footnote" id="fnref:7.15"><a href="#fn:7.15">15</a></sup> Second, note that the value of the hash key <code>:id</code>, instead of being the user&rsquo;s <code>id</code> attribute <code>@user.id</code>, is the user object itself:</p>

<div class="code"><div class="highlight"><pre><span class="n">get</span> <span class="ss">:show</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="vi">@user</span>
</pre></div>
</div>


<p>We could use the code</p>

<div class="code"><div class="highlight"><pre><span class="n">get</span> <span class="ss">:show</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="o">.</span><span class="n">id</span>
</pre></div>
</div>


<p>to accomplish the same thing, but in this context Rails automatically converts the user object to the corresponding id.<sup class="footnote" id="fnref:7.16"><a href="#fn:7.16">16</a></sup> Using the more succinct construction</p>

<div class="code"><div class="highlight"><pre><span class="n">get</span> <span class="ss">:show</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="vi">@user</span>
</pre></div>
</div>


<p>is a very common Rails idiom.</p>

<p>Because of the code we added in <a class="ref" href="modeling-and-viewing-users-one#code:user_show_action">extrait&nbsp;6.25</a>, the test in this section already passes. If you&rsquo;re feeling paranoid, you can comment out the line</p>

<div class="code"><div class="highlight"><pre><span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</pre></div>
</div>


<p>and verify that the test fails, then uncomment it to get it to pass. (We went through this same process once before, in <a class="ref" href="modeling-and-viewing-users-one#sec:presence_validation">section&nbsp;6.2.1</a>.)</p>

<div class="label" id="sec:a_name_and_a_gravatar"></div>


<h3><a id="sec:7.3.2" href="modeling-and-viewing-users-two#sec:a_name_and_a_gravatar" class="heading"><span class="number">7.3.2</span> A name and a Gravatar</a></h3>


<p>In this section, we&rsquo;ll improve the look of the user show page by adding a heading with the user&rsquo;s name and profile image. This is one of those situations where I can go either way on test-driven development, and often when making views I&rsquo;ll experiment with the HTML before bothering with tests. Let&rsquo;s stick with the TDD theme for now, and test for a top-level heading (<code>h1</code> tag) containing the user&rsquo;s name and an <code>img</code> tag of class <code>gravatar</code>. (We&rsquo;ll talk momentarily about what this second part means.)</p>

<p>To view a working user show page in a browser, we&rsquo;ll need to create a sample user in the development base de données. To do this, start the console (<em>not</em> in a sandbox this time) and create the user:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rake db:reset</span>
<span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">:nom</span> <span class="o">=&gt;</span> <span class="s2">&quot;Utilisateur exemple&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;user@example.com&quot;</span><span class="p">,</span>
<span class="gp">?&gt; </span>             <span class="ss">:password</span> <span class="o">=&gt;</span> <span class="s2">&quot;foobar&quot;</span><span class="p">,</span> <span class="ss">:password_confirmation</span> <span class="o">=&gt;</span> <span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
</pre></div>
</div>


<p>The tests in this section are similar to the tests for the <code>new</code> page seen in <a class="ref" href="filling-in-the-layout#code:signup_title_test">extrait&nbsp;5.26</a>. In particular, we use the <code>have_selector</code> method to check the title and the content of the <code>h1</code>&nbsp;tag, as seen in <a class="ref" href="modeling-and-viewing-users-two#code:user_show_tests">extrait&nbsp;7.18</a>.</p>

<div class="label" id="code:user_show_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 7.18.</span> <span class="description">Tests for the user show page. <br /> <code>spec/controllers/users_controller_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">UsersController</span> <span class="k">do</span>
  <span class="n">render_views</span>

  <span class="n">describe</span> <span class="s2">&quot;GET &#39;show&#39;&quot;</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">it</span> <span class="s2">&quot;should have the right title&quot;</span> <span class="k">do</span>
      <span class="n">get</span> <span class="ss">:show</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="vi">@user</span>
      <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should include the user&#39;s name&quot;</span> <span class="k">do</span>
      <span class="n">get</span> <span class="ss">:show</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="vi">@user</span>
      <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;h1&quot;</span><span class="p">,</span> <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should have a profile image&quot;</span> <span class="k">do</span>
      <span class="n">get</span> <span class="ss">:show</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="vi">@user</span>
      <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;h1&gt;img&quot;</span><span class="p">,</span> <span class="ss">:class</span> <span class="o">=&gt;</span> <span class="s2">&quot;gravatar&quot;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Here RSpec&rsquo;s <code>have_selector</code> method verifies the presence of a <code>title</code> and <code>h1</code> tags containing the user&rsquo;s name. The third example introduces a new element through the code <code>h1&gt;img</code>, which makes sure that the <code>img</code> tag is <em>inside</em> the <code>h1</code> tag.<sup class="footnote" id="fnref:7.17"><a href="#fn:7.17">17</a></sup> In addition, we see that <code>have_selector</code> can take a <code>:class</code> option to test the CSS class of the element in question.</p>

<p>We can get the first test to pass by setting the <code>@title</code> variable for use in the <code>title</code> helper (<a class="ref" href="rails-flavored-ruby#sec:title_helper">section&nbsp;4.1.1</a>), in this case setting it to the user&rsquo;s name (<a class="ref" href="modeling-and-viewing-users-two#code:user_show_title">extrait&nbsp;7.19</a>).</p>

<div class="label" id="code:user_show_title"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 7.19.</span> <span class="description">A title for the user show page. <br /> <code>app/controllers/users_controller.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">show</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
    <span class="vi">@title</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>This code introduces a potential problem: a user could enter a name with malicious code&mdash;called a <a href="http://en.wikipedia.org/wiki/Cross-site_scripting">cross-site scripting</a> attack&mdash;which would be injected into our application by the <code>title</code> helper defined in <a class="ref" href="rails-flavored-ruby#code:title_helper">extrait&nbsp;4.2</a>. Before Rails&nbsp;3, the solution was to <em>escape</em> potentially problematic code using the&nbsp;<code>h</code> method (short for <code>html_escape</code>), but as of Rails&nbsp;3.0 all Embedded Ruby text is escaped by default.<sup class="footnote" id="fnref:7.18"><a href="#fn:7.18">18</a></sup> For example, if a user tried to inject a malicious JavaScript program by using <code>&lt;script&gt;</code> in his name, the automatic HTML escaping would convert it to <code>&amp;lt;script&amp;gt;</code>, rendering it completely harmless.</p>

<p>Now for the other tests. Creating an <code>h1</code> with the (auto-escaped) user name is easy (<a class="ref" href="modeling-and-viewing-users-two#code:user_show_view_with_name">extrait&nbsp;7.20</a>).</p>

<div class="label" id="code:user_show_view_with_name"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 7.20.</span> <span class="description">The user show view with the user&rsquo;s name. <br /> <code>app/views/users/show.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>
  <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/h1&gt;</span>
</pre></div>
</div></div>


<p>Getting the <code>img</code> test to pass is trickier.  The first step is to install the <a href="http://github.com/mdeering/gravatar_image_tag"><tt>gravatar_image_tag</tt> gem</a> to handle each user&rsquo;s <a href="http://en.gravatar.com/">Gravatar</a>,<sup class="footnote" id="fnref:7.19"><a href="#fn:7.19">19</a></sup> which is a &ldquo;globally recognized avatar&rdquo;.<sup class="footnote" id="fnref:7.20"><a href="#fn:7.20">20</a></sup> As usual, we will include the gem dependency in the <code>Gemfile</code> (<a class="ref" href="modeling-and-viewing-users-two#code:gemfile_gravatar">extrait&nbsp;7.21</a>).</p>

<div class="label" id="code:gemfile_gravatar"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 7.21.</span> <span class="description">Adding a Gravatar gem to the <code>Gemfile</code>.</span>       
</div>
<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">&#39;http://rubygems.org&#39;</span>

<span class="n">gem</span> <span class="s1">&#39;rails&#39;</span><span class="p">,</span> <span class="s1">&#39;3.0.7&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;sqlite3-ruby&#39;</span><span class="p">,</span> <span class="s1">&#39;1.3.2&#39;</span><span class="p">,</span> <span class="ss">:require</span> <span class="o">=&gt;</span> <span class="s1">&#39;sqlite3&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;gravatar_image_tag&#39;</span><span class="p">,</span> <span class="s1">&#39;1.0.0.pre2&#39;</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
</pre></div>
</div></div>


<p>The install it with <code>bundle</code>:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle install
</pre></div>
</div>


<p>You should also restart your web server at this point to load the new Gravatar gem properly.</p>

<p>Gravatars are a convenient way to include user profile images without going through the trouble of managing image upload, cropping, and storage.<sup class="footnote" id="fnref:7.21"><a href="#fn:7.21">21</a></sup> Each Gravatar is associated with an email address, so the Gravatar gem comes with a helper method called <code>gravatar_image_tag</code> that takes an email address as an argument:</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">gravatar_image_tag</span> <span class="s1">&#39;example@railstutorial.org&#39;</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>
For the moment, we&rsquo;ll use this directly in our user show view, as seen in <a class="ref" href="modeling-and-viewing-users-two#code:user_show_view_with_gravatar">extrait&nbsp;7.22</a>. (We&rsquo;ll make a helper method for it in a moment.) The result appears in <a class="ref" href="modeling-and-viewing-users-two#fig:user_show_default_gravatar_rails_3">illustration&nbsp;7.4</a>, which shows our example user with the default Gravatar image.</p>

<div class="label" id="code:user_show_view_with_gravatar"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 7.22.</span> <span class="description">The user show view with name and Gravatar. <br /> <code>app/views/users/show.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">gravatar_image_tag</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/h1&gt;</span>
</pre></div>
</div></div>




<div class="label" id="fig:user_show_default_gravatar_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_show_default_gravatar_rails_3.png" alt="user_show_default_gravatar_rails_3" /></span></div><div class="caption"><span class="header">Illustration 7.4: </span><span class="description">The initial user show page  <a href="http://localhost:3000/users/1"><tt>/users/1</tt></a> with the default Gravatar.&nbsp;<a href="http://railstutorial.org/images/figures/user_show_default_gravatar_rails_3-full.png">(taille normale)</a></span></div></div>


<p>This Gravatar business might seem like magic, so let&rsquo;s fire up the console to get a little more insight into what&rsquo;s going on:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">first</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">update_attributes</span><span class="p">(</span><span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;example@railstutorial.org&quot;</span><span class="p">,</span>
<span class="gp">?&gt; </span>                       <span class="ss">:password</span> <span class="o">=&gt;</span> <span class="s2">&quot;foobar&quot;</span><span class="p">,</span>
<span class="gp">?&gt; </span>                       <span class="ss">:password_confirmation</span> <span class="o">=&gt;</span> <span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p>Note that we can pull out the first (and, at this point, only) user in the base de données with the handy <code>User.first</code> method. In the <code>update_attributes</code> step we&rsquo;ve reassigned the user&rsquo;s email address, changing it to <code>example@railstutorial.org</code>. As you can see from <a class="ref" href="modeling-and-viewing-users-two#fig:user_show_railstutorial_gravatar_rails_3">illustration&nbsp;7.5</a>, this change results in a new Gravatar being displayed: the Rails Tutorial logo. What&rsquo;s going on is that Gravatar works by associating images with email addresses; since <code>user@example.com</code> is an invalid email address (the <a href="http://example.com/">example.com</a> domain is reserved for examples), there is no Gravatar for that email address. But at my Gravatar account I&rsquo;ve associated the address <code>example@railstutorial.org</code> with the Rails Tutorial logo, so when updating the example user with that email address the Gravatar changes automatically.</p>

<div class="label" id="fig:user_show_railstutorial_gravatar_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_show_railstutorial_gravatar_rails_3.png" alt="user_show_railstutorial_gravatar_rails_3" /></span></div><div class="caption"><span class="header">Illustration 7.5: </span><span class="description">The user show page  <a href="http://localhost:3000/users/1"><tt>/users/1</tt></a> with the Rails Tutorial Gravatar.&nbsp;<a href="http://railstutorial.org/images/figures/user_show_railstutorial_gravatar_rails_3-full.png">(taille normale)</a></span></div></div>




<div class="label" id="sec:a_gravatar_helper"></div>


<h4><a id="sec:7.3.2.1" href="modeling-and-viewing-users-two#sec:a_gravatar_helper" class="heading">A Gravatar helper</a></h4>


<p>At this point, the Gravatar displays properly, but the final example from <a class="ref" href="modeling-and-viewing-users-two#code:user_show_tests">extrait&nbsp;7.18</a> still doesn&rsquo;t pass. This is because the <code>"gravatar"</code> class, which we want for styling the Gravatar with CSS, isn&rsquo;t yet present in the Gravatar&rsquo;s <code>img</code> tag. We could arrange for the test to pass by including an option to the <code>gravatar_image_tag</code> method:</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">gravatar_image_tag</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="ss">:class</span> <span class="o">=&gt;</span> <span class="s2">&quot;gravatar&quot;</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>On the other hand, since we expect the Gravatars to appear in multiple places in our application, it would be repetitive to put the class in everywhere by hand. It would be better to make a helper method to eliminate this duplication preemptively.</p>

<p>This situation may remind you of the repetition in the site&rsquo;s base title (&ldquo;Ruby on Rails Tutorial Sample App&rdquo;), which we solved with a <code>title</code> helper in the Application helper (<a class="ref" href="rails-flavored-ruby#code:title_helper">extrait&nbsp;4.2</a>). The solution here is similar; since Gravatars are naturally associated with users, we&rsquo;ll define a <code>gravatar_for</code> method in the Users helper. (The choice to use the Users helpers instead of the Application helper is just for conceptual convenience; Rails makes all helpers available in all views.) The result will be concise view code like</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="vi">@user</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>The <code>gravatar_for</code> helper should take in a <code>user</code> object and then pass some default options to the <code>gravatar_image_tag</code> helper. The implementation appears in <a class="ref" href="modeling-and-viewing-users-two#code:gravatar_for_helper">extrait&nbsp;7.23</a>.</p>

<div class="label" id="code:gravatar_for_helper"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 7.23.</span> <span class="description">Defining a <code>gravatar_for</code> helper method. <br /> <code>app/helpers/users_helper.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">UsersHelper</span>

  <span class="k">def</span> <span class="nf">gravatar_for</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">options</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:size</span> <span class="o">=&gt;</span> <span class="mi">50</span> <span class="p">})</span>
    <span class="n">gravatar_image_tag</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">downcase</span><span class="p">,</span> <span class="ss">:alt</span> <span class="o">=&gt;</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                            <span class="ss">:class</span> <span class="o">=&gt;</span> <span class="s1">&#39;gravatar&#39;</span><span class="p">,</span>
                                            <span class="ss">:gravatar</span> <span class="o">=&gt;</span> <span class="n">options</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>The first argument in the call to <code>gravatar_image_tag</code> passes in the lower-case version of the user&rsquo;s email address (using the <code>downcase</code> method).<sup class="footnote" id="fnref:7.22"><a href="#fn:7.22">22</a></sup> Then the first option to <code>gravatar_image_tag</code> assigns the user&rsquo;s name to the <code>img</code> tag&rsquo;s <code>alt</code> attribute (which gets displayed in devices that can&rsquo;t render images), while the second option sets the CSS class of the resulting Gravatar. The third option passes the <code>options</code> hash using the <code>:gravatar</code> key, which (according to the <a href="http://github.com/mdeering/gravatar_image_tag"><tt>gravatar_image_tag</tt> gem documentation</a>) is how to set the options for <code>gravatar_image_tag</code>. Note that the function definition sets a <em>default option</em><sup class="footnote" id="fnref:7.23"><a href="#fn:7.23">23</a></sup> for the size of the Gravatar<sup class="footnote" id="fnref:7.24"><a href="#fn:7.24">24</a></sup> using</p>

<div class="code"><div class="highlight"><pre><span class="n">option</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:size</span> <span class="o">=&gt;</span> <span class="mi">50</span> <span class="p">}</span>
</pre></div>
</div>


<p>This sets the default Gravatar size to <tt>50x50</tt>, while also allowing us to override the default size using code like</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">:size</span> <span class="o">=&gt;</span> <span class="mi">30</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>If we now update the user show template with the code in <a class="ref" href="modeling-and-viewing-users-two#code:user_show_gravatar_for">extrait&nbsp;7.24</a>, the user show page appears as in <a class="ref" href="modeling-and-viewing-users-two#fig:user_show_gravatar_for">illustration&nbsp;7.6</a>. And since the <code>gravatar_for</code> helper assigns the <code>img</code> tag the class <code>"gravatar"</code>, the tests from <a class="ref" href="modeling-and-viewing-users-two#code:user_show_tests">extrait&nbsp;7.18</a> should now pass.</p>

<div class="label" id="code:user_show_gravatar_for"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 7.24.</span> <span class="description">Updating the user show template to use <code>gravatar_for</code>. <br /> <code>app/views/users/show.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="vi">@user</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/h1&gt;</span>
</pre></div>
</div></div>




<div class="label" id="fig:user_show_gravatar_for"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_show_gravatar_for.png" alt="user_show_gravatar_for" /></span></div><div class="caption"><span class="header">Illustration 7.6: </span><span class="description">The user show page with <code>gravatar_for</code>.&nbsp;<a href="http://railstutorial.org/images/figures/user_show_gravatar_for-full.png">(taille normale)</a></span></div></div>




<div class="label" id="sec:a_user_sidebar"></div>


<h3><a id="sec:7.3.3" href="modeling-and-viewing-users-two#sec:a_user_sidebar" class="heading"><span class="number">7.3.3</span> A user sidebar</a></h3>


<p>Even though our tests are now passing, and the user show page is much-improved, it&rsquo;s still nice to polish it up just a bit more. In <a class="ref" href="modeling-and-viewing-users-two#code:user_show_with_sidebar">extrait&nbsp;7.25</a>, we have a <code>table</code> tag with one table row (<code>tr</code>) and two table data cells (<code>td</code>).<sup class="footnote" id="fnref:7.25"><a href="#fn:7.25">25</a></sup></p>

<div class="label" id="code:user_show_with_sidebar"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 7.25.</span> <span class="description">Adding a sidebar to the user <code>show</code> view. <br /> <code>app/views/users/show.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;table</span> <span class="na">class=</span><span class="s">&quot;profile&quot;</span> <span class="na">summary=</span><span class="s">&quot;Profile information&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;tr&gt;</span>
    <span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">&quot;main&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;h1&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="vi">@user</span> <span class="cp">%&gt;</span>
        <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/h1&gt;</span>
    <span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">&quot;sidebar round&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;strong&gt;</span>Name<span class="nt">&lt;/strong&gt;</span> <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span><span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;strong&gt;</span>URL<span class="nt">&lt;/strong&gt;</span>  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">),</span> <span class="vi">@user</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/td&gt;</span>
  <span class="nt">&lt;/tr&gt;</span>
<span class="nt">&lt;/table&gt;</span>
</pre></div>
</div></div>


<p>Here we&rsquo;ve used an HTML break tag&nbsp;<code>&lt;br /&gt;</code> to put a break between the user&rsquo;s name and URL. Also note the use of <code>user_path</code> to make a clickable link so that users can easily share their profile URLs. This is only the first of many named routes (<a class="ref" href="filling-in-the-layout#sec:rails_routes">section&nbsp;5.2.2</a>) associated with the User resource (<a class="ref" href="modeling-and-viewing-users-one#code:users_resource">extrait&nbsp;6.26</a>); we&rsquo;ll see many more in the next few chapters. The code</p>

<div class="code"><div class="highlight"><pre><span class="n">user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
</pre></div>
</div>


<p>returns the path to the user, in this case <tt>/users/1</tt>. The related code</p>

<div class="code"><div class="highlight"><pre><span class="n">user_url</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
</pre></div>
</div>


<p>just returns the entire URL, <tt>http://localhost:3000/users/1</tt>. (Compare to the routes created in <a class="ref" href="filling-in-the-layout#sec:rails_routes">section&nbsp;5.2.2</a>.) Both are examples of the named routes created by the users resource in <a class="ref" href="modeling-and-viewing-users-one#code:users_resource">extrait&nbsp;6.26</a>; a list of all the named routes appears in <a class="ref" href="modeling-and-viewing-users-two#table:nomd_routes">Table&nbsp;7.1</a>.</p>

<div class="label" id="table:nomd_routes"></div>


<div class="table"><div class="center"><table class="tabular"><tr><th class="align_left"><strong>Named route</strong></th><th class="align_left"><strong>Path</strong></th></tr><tr class="top_bar"><td class="align_left"><code>users_path</code></td><td class="align_left"><tt>/users</tt></td></tr><tr><td class="align_left"><code>user_path(@user)</code></td><td class="align_left"><tt>/users/1</tt></td></tr><tr><td class="align_left"><code>new_user_path</code></td><td class="align_left"><tt>/users/new</tt></td></tr><tr><td class="align_left"><code>edit_user_path(@user)</code></td><td class="align_left"><tt>/users/1/edit</tt></td></tr><tr><td class="align_left"><code>users_url</code></td><td class="align_left"><tt>http://localhost:3000/users</tt></td></tr><tr><td class="align_left"><code>user_url(@user)</code></td><td class="align_left"><tt>http://localhost:3000/users/1</tt></td></tr><tr><td class="align_left"><code>new_user_url</code></td><td class="align_left"><tt>http://localhost:3000/users/new</tt></td></tr><tr><td class="align_left"><code>edit_user_url(@user)</code></td><td class="align_left"><tt>http://localhost:3000/users/1/edit</tt></td></tr></table></div><div class="caption"><span class="header">Table 7.1: </span><span class="description">Named routes provided by the users resource in <a class="ref" href="modeling-and-viewing-users-one#code:users_resource">extrait&nbsp;6.26</a>.  </span></div></div>


<p>Note that in</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">),</span> <span class="vi">@user</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p><code>user_path(@user)</code> is the link <em>text</em>, while the address is just <code>@user</code>. In the context of a <code>link_to</code>, Rails converts <code>@user</code> to the appropriate URL; in other words, the code above is equivalent to the code</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">),</span> <span class="n">user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>Either way works fine, but, as in the <code>:id =&gt; @user</code> idiom from <a class="ref" href="modeling-and-viewing-users-two#code:get_show_test">extrait&nbsp;7.17</a>, using just <code>@user</code> is a common Rails convention. In both cases, the Embedded Ruby produces the HTML</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;/users/1&quot;</span><span class="nt">&gt;</span>/users/1<span class="nt">&lt;/a&gt;</span>
</pre></div>
</div>


<p>With the HTML elements and CSS classes in place, we can style the show page with the CSS shown in <a class="ref" href="modeling-and-viewing-users-two#code:sidebar_css">extrait&nbsp;7.26</a>. The resulting page is shown in <a class="ref" href="modeling-and-viewing-users-two#fig:user_show_sidebar_css">illustration&nbsp;7.7</a>.</p>

<div class="label" id="code:sidebar_css"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 7.26.</span> <span class="description">CSS for styling the user show page, including the sidebar. <br /> <code>public/stylesheets/custom.css</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="c">/* User show page */</span>

<span class="nt">table</span><span class="nc">.profile</span> <span class="p">{</span>
  <span class="k">width</span><span class="o">:</span> <span class="m">100%</span><span class="p">;</span>
  <span class="k">margin-bottom</span><span class="o">:</span> <span class="m">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">td</span><span class="nc">.main</span> <span class="p">{</span>
  <span class="k">width</span><span class="o">:</span> <span class="m">70%</span><span class="p">;</span>
  <span class="k">padding</span><span class="o">:</span> <span class="m">1em</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">td</span><span class="nc">.sidebar</span> <span class="p">{</span>
  <span class="k">width</span><span class="o">:</span> <span class="m">30%</span><span class="p">;</span>
  <span class="k">padding</span><span class="o">:</span> <span class="m">1em</span><span class="p">;</span>
  <span class="k">vertical-align</span><span class="o">:</span> <span class="k">top</span><span class="p">;</span>
  <span class="k">background</span><span class="o">:</span> <span class="m">#ffc</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.profile</span> <span class="nt">img</span><span class="nc">.gravatar</span> <span class="p">{</span>
  <span class="k">border</span><span class="o">:</span> <span class="m">1px</span> <span class="k">solid</span> <span class="m">#999</span><span class="p">;</span>
  <span class="k">margin-bottom</span><span class="o">:</span> <span class="m">-15px</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div></div>




<div class="label" id="fig:user_show_sidebar_css"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_show_sidebar_css.png" alt="user_show_sidebar_css" /></span></div><div class="caption"><span class="header">Illustration 7.7: </span><span class="description">The user show page  <a href="http://localhost:3000/users/1"><tt>/users/1</tt></a> with a sidebar and CSS.&nbsp;<a href="http://railstutorial.org/images/figures/user_show_sidebar_css-full.png">(taille normale)</a></span></div></div>




<h2><a id="sec:7.4" href="modeling-and-viewing-users-two#sec:7.4" class="heading"><span class="number">7.4</span> Conclusion</a></h2>


<p>In this chapter, we&rsquo;ve effectively finished the User model, so we&rsquo;re now fully prepared to sign up new users and to let them sign in securely with an email/password combination. Moreover, we have a nice first cut of the user profile page, so after signing in users will have a place to go.</p>

<h3><a id="sec:7.4.1" href="modeling-and-viewing-users-two#sec:7.4.1" class="heading"><span class="number">7.4.1</span> Git commit</a></h3>


<p>Before moving on, we should close the Git loop opened in the introduction to <a class="ref" href="modeling-and-viewing-users-one#top">chapitre&nbsp;6</a> by making a final commit to the <code>modeling-users</code> branch and then merging into <code>master</code>.<sup class="footnote" id="fnref:7.26"><a href="#fn:7.26">26</a></sup> First, verify that we are on the <code>modeling-users</code> branch:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git branch
<span class="go">  master</span>
<span class="go">* modeling-users</span>
</pre></div>
</div>


<p>As noted in <a class="ref" href="beginning#sec:git_branch">section&nbsp;1.3.5.1</a>, the asterisk here identifies the present branch, so we are indeed ready to commit and merge:<sup class="footnote" id="fnref:7.27"><a href="#fn:7.27">27</a></sup></p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">&quot;User model with passwords, and user show page&quot;</span>
<span class="gp">$</span> git checkout master
<span class="gp">$</span> git merge modeling-users
</pre></div>
</div>


<div class="label" id="sec:heroku_deploy"></div>


<h3><a id="sec:7.4.2" href="modeling-and-viewing-users-two#sec:heroku_deploy" class="heading"><span class="number">7.4.2</span> Heroku deploy</a></h3>


<p>If you&rsquo;ve deployed your sample application to Heroku, you can push it up at this point:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git push heroku
</pre></div>
</div>


<p>Then migrate the base de données on the remote server using the <code>heroku</code> command:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> heroku rake db:migrate
</pre></div>
</div>


<p>Now if you want to create a sample user on Heroku, you can use the Heroku console:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ heroku console</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">:nom</span> <span class="o">=&gt;</span> <span class="s2">&quot;Utilisateur exemple&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;user@example.com&quot;</span><span class="p">,</span>
<span class="gp">?&gt; </span>             <span class="ss">:password</span> <span class="o">=&gt;</span> <span class="s2">&quot;foobar&quot;</span><span class="p">,</span> <span class="ss">:password_confirmation</span> <span class="o">=&gt;</span> <span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
</pre></div>
</div>




<div class="label" id="sec:more_modeling_users_exercises"></div>


<h2><a id="sec:7.5" href="modeling-and-viewing-users-two#sec:more_modeling_users_exercises" class="heading"><span class="number">7.5</span> Exercises</a></h2>




<ol>
<li>Copy each of the variants of the <code>authenticate</code> method from <a class="ref" href="modeling-and-viewing-users-two#code:authenticate_variant_1">extrait&nbsp;7.27</a> through <a class="ref" href="modeling-and-viewing-users-two#code:authenticate_variant_5">extrait&nbsp;7.31</a> into your User model, and verify that they are correct by running your test suite. </li>

<li>The final <code>authenticate</code> example (<a class="ref" href="modeling-and-viewing-users-two#code:authenticate_variant_5">extrait&nbsp;7.31</a>) is particularly challenging. Experiment with the console to see if you can understand how it works.</li>

<li>How could you get the Gravatar helper <code>gravatar_for</code> to work if our User model used <code>email_address</code> instead of <code>email</code> to represent email addresses?</li>

</ol>




<div class="label" id="code:authenticate_variant_1"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 7.27.</span> <span class="description">The <code>authenticate</code> method with <code>User</code> in place of <code>self</code>.</span>       
</div>
<div class="code"><div class="highlight"><pre>  <span class="k">def</span> <span class="nc">User</span><span class="o">.</span><span class="nf">authenticate</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">submitted_password</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">find_by_email</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
    <span class="k">return</span> <span class="kp">nil</span>  <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">nil?</span>
    <span class="k">return</span> <span class="n">user</span> <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">has_password?</span><span class="p">(</span><span class="n">submitted_password</span><span class="p">)</span>
  <span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="code:authenticate_variant_2"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 7.28.</span> <span class="description">The <code>authenticate</code> method with an explicit third <code>return</code>.</span>       
</div>
<div class="code"><div class="highlight"><pre>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">authenticate</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">submitted_password</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">find_by_email</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
    <span class="k">return</span> <span class="kp">nil</span>  <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">nil?</span>
    <span class="k">return</span> <span class="n">user</span> <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">has_password?</span><span class="p">(</span><span class="n">submitted_password</span><span class="p">)</span>
    <span class="k">return</span> <span class="kp">nil</span>
  <span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="code:authenticate_variant_3"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 7.29.</span> <span class="description">The <code>authenticate</code> method using an <code>if</code> statement.</span>       
</div>
<div class="code"><div class="highlight"><pre>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">authenticate</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">submitted_password</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">find_by_email</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">nil?</span>
      <span class="kp">nil</span>
    <span class="k">elsif</span> <span class="n">user</span><span class="o">.</span><span class="n">has_password?</span><span class="p">(</span><span class="n">submitted_password</span><span class="p">)</span>
      <span class="n">user</span>
    <span class="k">else</span>
      <span class="kp">nil</span>
    <span class="k">end</span>
  <span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="code:authenticate_variant_4"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 7.30.</span> <span class="description">The <code>authenticate</code> method using an <code>if</code> statement and an implicit return.</span>       
</div>
<div class="code"><div class="highlight"><pre>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">authenticate</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">submitted_password</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">find_by_email</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">nil?</span>
      <span class="kp">nil</span>
    <span class="k">elsif</span> <span class="n">user</span><span class="o">.</span><span class="n">has_password?</span><span class="p">(</span><span class="n">submitted_password</span><span class="p">)</span>
      <span class="n">user</span>
    <span class="k">end</span>
  <span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="code:authenticate_variant_5"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 7.31.</span> <span class="description">The <code>authenticate</code> method using the ternary operator.</span>       
</div>
<div class="code"><div class="highlight"><pre>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">authenticate</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">submitted_password</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">find_by_email</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">has_password?</span><span class="p">(</span><span class="n">submitted_password</span><span class="p">)</span> <span class="p">?</span> <span class="n">user</span> <span class="p">:</span> <span class="kp">nil</span>
  <span class="k">end</span>
</pre></div>
</div></div>




<div class="navigation">  <a class="prev_page" href="modeling-and-viewing-users-one#top">
    &laquo;&nbsp;<span class="number">chapitre 6</span> Modeling and viewing users, part I
  </a>
  <a class="next_page" href="sign-up#top">
    <span class="number">chapitre 8</span> Sign up&nbsp;&raquo;
  </a>
</div><div class="footnotes">
<ol>
<li id="fn:7.1">Nous avons vu précédemment les <em>rangs</em> à la <a class="ref" href="rails-flavored-ruby#sec:arrays_and_ranges">section&nbsp;4.3.1</a>.&nbsp;<a class="arrow" href="#fnref:7.1">&uarr;</a></li>
<li id="fn:7.2">Pour plus de détail sur le type de fonctions de rappel supportées par Active Record, voyez la <a href="http://guides.rubyonrails.org/active_record_validations_callbacks.html#callbacks-overview">discussion sur les callbacks dans les guides Rails</a>.&nbsp;<a class="arrow" href="#fnref:7.2">&uarr;</a></li>
<li id="fn:7.3">Le niveau supplémentaire d'indentation est une façon typographique de nous souvenir que nous sommes dans une section privée&nbsp;; dans le cas contraire, il est facile de manquer le mot-clé <code>private</code> et d'être dérouté en essayant d'atteindre une méthode privée que vous pensez publique. Je pensais que cette convention d'identation était stupide jusqu'à ce que je perde une heure sur ce simple problème il y a quelques années. Maintenant j'ajouter l'identation&hellip;&nbsp;<a class="arrow" href="#fnref:7.3">&uarr;</a></li>
<li id="fn:7.4">Ruby possède aussi un mot-clé très proche, appelé <code>protected</code> (<em>protégé</em>) qui diffère subtilement de <code>private</code>. Autant que je peux dire, la seule raison d'apprendre la différence serait qu'on pourrait vous poser cette question au cours d'un entretien d'embauche&nbsp;: «&nbsp;En Ruby, quelle est la différence entre <code>private</code> et <code>protected</code>?&nbsp;». Mais qui aurait envie de travailler dans une compagnie qui poserait ce genre de question vicieuse&nbsp;? Lors de son discours à RubyConf en 2008, Dave Thomas (auteur de <em>Programmer Ruby</em>) a suggéré d'éliminer <code>protected</code> des versions futures de Ruby, et j'abonde dans son sens. Utilisez simplement <code>private</code> et tout ira bien.&nbsp;<a class="arrow" href="#fnref:7.4">&uarr;</a></li>
<li id="fn:7.5">J'ai honte d'admettre que c'est ainsi que nous avons implémenté les mots de passe dans <em>RailsSpace</em>. Considérez que cette section est ma pénitence.&nbsp;<a class="arrow" href="#fnref:7.5">&uarr;</a></li>
<li id="fn:7.6">Le lecteur attentif peut noter que rien de ce que nous faisons dans cette section ne <em>requiert</em> le cryptage, mais, une fois que nous développons un peu de la théorie des mots de passe sécurisés et écrivons une implémentation basique (<a class="ref" href="modeling-and-viewing-users-two#sec:secure_password_theory">section&nbsp;7.2.2</a>), la seule façon pour la méthode <code>has_password?</code> de fonctionner proprement est que toute la machinerie de cryptage fonctionne aussi bien.&nbsp;<a class="arrow" href="#fnref:7.6">&uarr;</a></li>
<li id="fn:7.7">Dans mes réglages, la ligne <code>require &rsquo;digest&rsquo;</code> n'est pas nécessaire, mais plusieurs lecteurs m'ont reporté qu'ils rencontraient une erreur <code>NameError</code> s'il ne l'incluait pas explicitement. Ça n'entraine aucun dommage de toute façon, donc j'ai inclus explicitement <code>require</code> juste pour être sûr.&nbsp;<a class="arrow" href="#fnref:7.7">&uarr;</a></li>
<li id="fn:7.8">En théorie et techniquement, les attaques «&nbsp;arc-en-ciel&nbsp;» pourraient toujours réussir, mais en utilisant un «&nbsp;hachage salé&nbsp;», la réussite est informatiquement infaisable.&nbsp;<a class="arrow" href="#fnref:7.8">&uarr;</a></li>
<li id="fn:7.9">As noted in <a class="ref" href="modeling-and-viewing-users-two#sec:secure_password_theory">section&nbsp;7.2.2</a>, the explicit <code>require &rsquo;digest&rsquo;</code> line is unnecessary on some systems, but it does no harm to include it.&nbsp;<a class="arrow" href="#fnref:7.9">&uarr;</a></li>
<li id="fn:7.10">In past versions of Rails, we could have used the <code>after_validation_before_create</code> callback to set the salt, but it has been eliminated in Rails&nbsp;3. Meanwhile, we can&rsquo;t use the <code>before_create</code> callback because it executes <em>after</em> the <code>before_save</code> callback, and the <code>before_save</code> callback needs the salt.&nbsp;<a class="arrow" href="#fnref:7.10">&uarr;</a></li>
<li id="fn:7.11">Recall from <a class="ref" href="modeling-and-viewing-users-one#sidebar:base de données_indices">Box&nbsp;6.2</a> that the <em>index</em> on the <code>email</code> column ensures that this retrieval is efficient.&nbsp;<a class="arrow" href="#fnref:7.11">&uarr;</a></li>
<li id="fn:7.12">We&rsquo;ll plan to add a couple more attributes (one to identify administrative users and one to allow a &ldquo;remember me&rdquo; feature), but they are not strictly necessary. All the <em>essential</em> user attributes have now been defined.&nbsp;<a class="arrow" href="#fnref:7.12">&uarr;</a></li>
<li id="fn:7.13">Many experienced Rails programmers find that this factory approach is much more flexible than <em>fixtures</em>, which Rails uses by default but can be brittle and difficult to maintain.&nbsp;<a class="arrow" href="#fnref:7.13">&uarr;</a></li>
<li id="fn:7.14">Presumably &ldquo;Factory Girl&rdquo; is a reference to the <a href="http://www.imdb.com/title/tt0432402/">movie of the same name</a>.&nbsp;<a class="arrow" href="#fnref:7.14">&uarr;</a></li>
<li id="fn:7.15">I used <code>get &rsquo;new&rsquo;</code> in <a class="ref" href="filling-in-the-layout#code:get_new_user_spec">extrait&nbsp;5.24</a> and subsequent tests for the <code>new</code> action because at that point we had yet to encounter the idea of standard REST actions. I&rsquo;ll switch to <code>get :new</code> in future tests.&nbsp;<a class="arrow" href="#fnref:7.15">&uarr;</a></li>
<li id="fn:7.16">It does this by calling the <code>to_param</code> method on the <code>@user</code> variable.&nbsp;<a class="arrow" href="#fnref:7.16">&uarr;</a></li>
<li id="fn:7.17">It&rsquo;s not necessarily always a good idea to make HTML tests this specific, since we don&rsquo;t always want to constrain the HTML layout this tightly. Feel free to experiment and find the right level of detail for your projects and tastes.&nbsp;<a class="arrow" href="#fnref:7.17">&uarr;</a></li>
<li id="fn:7.18">Instead, if you want <em>unescaped</em> text you have to use the <code>raw</code> method, as in <tt class="verb">&lt;%= raw @title %&gt;</tt>.&nbsp;<a class="arrow" href="#fnref:7.18">&uarr;</a></li>
<li id="fn:7.19">Gravatar was originally created by Tom Preston-Werner, cofounder of <a href="http://github.com/">GitHub</a>, and was acquired and scaled by <a href="http://automattic.com/">Automattic</a> (best known as the makers of <a href="http://wordpress.com/">WordPress</a>).&nbsp;<a class="arrow" href="#fnref:7.19">&uarr;</a></li>
<li id="fn:7.20">In Hinduism, an avatar is the manifestation of a deity in human or animal form. By extension, the term <em>avatar</em> is commonly used to mean some kind of personal representation, especially in a virtual environment. But you&rsquo;ve seen the movie by now, so you already knew this.&nbsp;<a class="arrow" href="#fnref:7.20">&uarr;</a></li>
<li id="fn:7.21">If your application does need to handle images or other file uploads, <a href="http://github.com/thoughtbot/paperclip">Paperclip</a> is the way to go. Like Factory Girl, Paperclip is brought to you by <a href="http://thoughtbot.com/">thoughtbot</a>. (Though I do know several people there, I have no vested interest in promoting thoughtbot; they just make good software.)&nbsp;<a class="arrow" href="#fnref:7.21">&uarr;</a></li>
<li id="fn:7.22">Thanks to the anonymous reader who noted that the Gravatar plugin is case-sensitive in this context.&nbsp;<a class="arrow" href="#fnref:7.22">&uarr;</a></li>
<li id="fn:7.23">There&rsquo;s actually a way to reset the default size in a configuration file, but I find this way clearer.&nbsp;<a class="arrow" href="#fnref:7.23">&uarr;</a></li>
<li id="fn:7.24">Gravatars are square, so a single parameter determines their size uniquely.&nbsp;<a class="arrow" href="#fnref:7.24">&uarr;</a></li>
<li id="fn:7.25">If anyone gives you grief for using, horror of horrors, <em>tables for layout</em>, have them point their Firebug inspector at Twitter&rsquo;s profile sidebar and tell you what they see. In fact, you&rsquo;ll find that, while &ldquo;semantic markup&rdquo; using <code>div</code>s and <code>span</code>s is increasingly common, virtually all sites resort to <code>table</code>s for layout on occasion. In the present case, getting the vertical alignment just right is <em>much</em> easier with tables.&nbsp;<a class="arrow" href="#fnref:7.25">&uarr;</a></li>
<li id="fn:7.26">Ordinarily, I recommend making more frequent, smaller commits, but frequent Git commits throughout the tutorial would be hard to maintain and would break up the flow of the discussion.&nbsp;<a class="arrow" href="#fnref:7.26">&uarr;</a></li>
<li id="fn:7.27">If you&rsquo;re <em>not</em> on the right branch, run <code>git checkout modeling-users</code> before proceeding.&nbsp;<a class="arrow" href="#fnref:7.27">&uarr;</a></li>
</ol>
</div>




