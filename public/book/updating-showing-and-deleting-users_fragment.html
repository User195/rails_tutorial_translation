<!--
	chapitre : 10
-->
<h1 class="title">Tutoriel Ruby on Rails </h1>


<h1 class="subtitle">  Apprendre Rails par l'exemple</h1>


<h2 class="author">Michael Hartl</h2>


<h1 class="contents">Contenu</h1>


<div id="table_of_contents"><ol>
<li class="chapter"><a href="beginning#top"><span class="number">Chapitre 1</span> De zéro au déploiement</a></li>
<li><ol>
<li class="section"><a href="beginning#sec:introduction"><span class="number">1.1</span> Introduction</a></li>
<li><ol>
<li class="subsection"><a href="beginning#sec:comments_for_various_readers"><span class="number">1.1.1</span> Commentaires pour les lecteurs différents</a></li>
<li class="subsection"><a href="beginning#sec:1.1.2"><span class="number">1.1.2</span> &ldquo;Dimensionner&rdquo; Rails</a></li>
<li class="subsection"><a href="beginning#sec:conventions"><span class="number">1.1.3</span> Conventions utilisées dans ce livre</a></li></ol></li>
<li class="section"><a href="beginning#sec:up_and_running"><span class="number">1.2</span> [(Up and running)(En route pour le démarrage)]</a></li>
<li><ol>
<li class="subsection"><a href="beginning#sec:development_tools"><span class="number">1.2.1</span> Environnements de développement</a></li>
<li><ol>
<li class="subsubsection"><a href="beginning#sec:1.2.1.1">IDEs</a></li>
<li class="subsubsection"><a href="beginning#sec:1.2.1.2">Éditeurs de texte et lignes de commande</a></li>
<li class="subsubsection"><a href="beginning#sec:1.2.1.3">Navigateurs</a></li>
<li class="subsubsection"><a href="beginning#sec:1.2.1.4">Note à propos des outils</a></li></ol></li>
<li class="subsection"><a href="beginning#sec:rubygems"><span class="number">1.2.2</span> Ruby, RubyGems, Rails, et Git</a></li>
<li><ol>
<li class="subsubsection"><a href="beginning#sec:rails_installer_windows">Installation de Rails (Windows)</a></li>
<li class="subsubsection"><a href="beginning#sec:install_git">Installer Git</a></li>
<li class="subsubsection"><a href="beginning#sec:install_ruby">Installer Ruby</a></li>
<li class="subsubsection"><a href="beginning#sec:install_rubygems">Installer RubyGems</a></li>
<li class="subsubsection"><a href="beginning#sec:install_rails">Installer Rails</a></li></ol></li>
<li class="subsection"><a href="beginning#sec:the_first_application"><span class="number">1.2.3</span> La première application</a></li>
<li class="subsection"><a href="beginning#sec:bundler"><span class="number">1.2.4</span> Bundler</a></li>
<li class="subsection"><a href="beginning#sec:rails_server"><span class="number">1.2.5</span> <code>Le serveur rails (rails server)</code></a></li>
<li class="subsection"><a href="beginning#sec:mvc"><span class="number">1.2.6</span> Modèles-Vue-Contrôleur (MVC)</a></li></ol></li>
<li class="section"><a href="beginning#sec:version_control"><span class="number">1.3</span> Contrôle de versions avec Git</a></li>
<li><ol>
<li class="subsection"><a href="beginning#sec:git_setup"><span class="number">1.3.1</span> Installation et réglages</a></li>
<li><ol>
<li class="subsubsection"><a href="beginning#sec:1.3.1.1">Initialisation des réglages système</a></li>
<li class="subsubsection"><a href="beginning#sec:1.3.1.2">Initialisation des réglages du dépôt (repository)</a></li></ol></li>
<li class="subsection"><a href="beginning#sec:adding_and_committing"><span class="number">1.3.2</span> Ajout et mandat de dépôt</a></li>
<li class="subsection"><a href="beginning#sec:1.3.3"><span class="number">1.3.3</span> Qu'est-ce que Git peut faire de bien pour vous&nbsp;?</a></li>
<li class="subsection"><a href="beginning#sec:github"><span class="number">1.3.4</span> GitHub</a></li>
<li class="subsection"><a href="beginning#sec:git_commands"><span class="number">1.3.5</span> Branch, edit, commit, merge</a></li>
<li><ol>
<li class="subsubsection"><a href="beginning#sec:git_branch">Branch</a></li>
<li class="subsubsection"><a href="beginning#sec:git_edit">Edit</a></li>
<li class="subsubsection"><a href="beginning#sec:git_commit">Commit</a></li>
<li class="subsubsection"><a href="beginning#sec:git_merge">Merge</a></li>
<li class="subsubsection"><a href="beginning#sec:git_push">Push</a></li></ol></li></ol></li>
<li class="section"><a href="beginning#sec:deploying"><span class="number">1.4</span> Déploiement</a></li>
<li><ol>
<li class="subsection"><a href="beginning#sec:1.4.1"><span class="number">1.4.1</span> Réglages Heroku</a></li>
<li class="subsection"><a href="beginning#sec:heroku_step_one"><span class="number">1.4.2</span> déploiement Heroku, première étape</a></li>
<li class="subsection"><a href="beginning#sec:1.4.3"><span class="number">1.4.3</span> Déploiement Heroku deployment, seconde étape</a></li>
<li class="subsection"><a href="beginning#sec:heroku_commands"><span class="number">1.4.4</span> Commandes Heroku</a></li></ol></li>
<li class="section"><a href="beginning#sec:beginning_conclusion"><span class="number">1.5</span> Conclusion</a></li></ol></li>
<li class="chapter"><a href="a-demo-app#top"><span class="number">Chapitre 2</span> Une application démo</a></li>
<li><ol>
<li class="section"><a href="a-demo-app#sec:planning_the_application"><span class="number">2.1</span> Planifier l'application</a></li>
<li><ol>
<li class="subsection"><a href="a-demo-app#sec:modeling_users"><span class="number">2.1.1</span> Modéliser les utilisateurs</a></li>
<li class="subsection"><a href="a-demo-app#sec:modeling_microposts"><span class="number">2.1.2</span> Modéliser les micro-messages</a></li></ol></li>
<li class="section"><a href="a-demo-app#sec:demo_users_resource"><span class="number">2.2</span> La ressource Utilisateurs (Users)</a></li>
<li><ol>
<li class="subsection"><a href="a-demo-app#sec:a_user_tour"><span class="number">2.2.1</span> Un tour de l'utilisateur</a></li>
<li class="subsection"><a href="a-demo-app#sec:mvc_in_action"><span class="number">2.2.2</span> MVC en action</a></li>
<li class="subsection"><a href="a-demo-app#sec:weaknesses_of_this_users_resource"><span class="number">2.2.3</span> Faiblesses de la ressource Utilisateurs (Users)</a></li></ol></li>
<li class="section"><a href="a-demo-app#sec:microposts_resource"><span class="number">2.3</span> La ressource Micro-messages (Microposts)</a></li>
<li><ol>
<li class="subsection"><a href="a-demo-app#sec:a_micropost_microtour"><span class="number">2.3.1</span> Un petit tour du micro-message</a></li>
<li class="subsection"><a href="a-demo-app#sec:putting_the_micro_in_microposts"><span class="number">2.3.2</span> Appliquer le <em>micro</em> aux micro-messages</a></li>
<li class="subsection"><a href="a-demo-app#sec:demo_user_has_many_microposts"><span class="number">2.3.3</span> Un utilisateur <code>has_many</code> (<code>possède plusieurs</code>) micro-messages</a></li>
<li class="subsection"><a href="a-demo-app#sec:inheritance_hierarchies"><span class="number">2.3.4</span> Hiérarchie des héritages</a></li>
<li class="subsection"><a href="a-demo-app#sec:deploying_the_demo_app"><span class="number">2.3.5</span> Déployer l'application Démo</a></li></ol></li>
<li class="section"><a href="a-demo-app#sec:2.4"><span class="number">2.4</span> Conclusion</a></li></ol></li>
<li class="chapter"><a href="static-pages#top"><span class="number">Chapitre 3</span> Pages statiques courantes</a></li>
<li><ol>
<li class="section"><a href="static-pages#sec:static_pages"><span class="number">3.1</span> Pages statiques</a></li>
<li><ol>
<li class="subsection"><a href="static-pages#sec:truly_static_pages"><span class="number">3.1.1</span> Pages HTML statiques</a></li>
<li class="subsection"><a href="static-pages#sec:static_pages_with_rails"><span class="number">3.1.2</span> Les pages statiques avec Rails</a></li></ol></li>
<li class="section"><a href="static-pages#sec:first_tests"><span class="number">3.2</span> Premiers tests</a></li>
<li><ol>
<li class="subsection"><a href="static-pages#sec:testing_tools"><span class="number">3.2.1</span> Outils de test</a></li>
<li><ol>
<li class="subsubsection"><a href="static-pages#sec:autotest">Auto-test</a></li></ol></li>
<li class="subsection"><a href="static-pages#sec:TDD"><span class="number">3.2.2</span> TDD : Rouge, Vert, Refactor</a></li>
<li><ol>
<li class="subsubsection"><a href="static-pages#sec:spork">Spork</a></li>
<li class="subsubsection"><a href="static-pages#sec:red">Rouge</a></li>
<li class="subsubsection"><a href="static-pages#sec:green">Vert</a></li>
<li class="subsubsection"><a href="static-pages#sec:refactor">Refactor</a></li></ol></li></ol></li>
<li class="section"><a href="static-pages#sec:slightly_dynamic_pages"><span class="number">3.3</span> Pages (un peu) dynamiques</a></li>
<li><ol>
<li class="subsection"><a href="static-pages#sec:testing_a_title_change"><span class="number">3.3.1</span> Test d'un changement de titre</a></li>
<li class="subsection"><a href="static-pages#sec:passing_title_tests"><span class="number">3.3.2</span> Réussir les tests de titre</a></li>
<li class="subsection"><a href="static-pages#sec:instance_variables_embedded_ruby"><span class="number">3.3.3</span> Variables d'instance et Ruby embarqué</a></li>
<li class="subsection"><a href="static-pages#sec:layouts"><span class="number">3.3.4</span> Supprimer les répétitions avec les <em>layouts</em></a></li></ol></li>
<li class="section"><a href="static-pages#sec:static_pages_conclusion"><span class="number">3.4</span> Conclusion</a></li>
<li class="section"><a href="static-pages#sec:static_pages_Exercices"><span class="number">3.5</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="rails-flavored-ruby#top"><span class="number">Chapitre 4</span> [(Rails-flavored Ruby)(Rails au goût Ruby)]</a></li>
<li><ol>
<li class="section"><a href="rails-flavored-ruby#sec:motivation"><span class="number">4.1</span> Motivation</a></li>
<li><ol>
<li class="subsection"><a href="rails-flavored-ruby#sec:title_helper"><span class="number">4.1.1</span> Un « helper » (« aideur ») pour le titre (<code>title</code>)</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:cascading_style_sheets"><span class="number">4.1.2</span> Feuilles de styles (CSS — Cascading Style Sheets)</a></li></ol></li>
<li class="section"><a href="rails-flavored-ruby#sec:strings_and_methods"><span class="number">4.2</span> Chaines de caractères et méthodes</a></li>
<li><ol>
<li class="subsection"><a href="rails-flavored-ruby#sec:comments"><span class="number">4.2.1</span> Commentaires</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:strings"><span class="number">4.2.2</span> Chaines de caractères</a></li>
<li><ol>
<li class="subsubsection"><a href="rails-flavored-ruby#sec:printing">Impression</a></li>
<li class="subsubsection"><a href="rails-flavored-ruby#sec:single_quoted_strings">Chaines de caractères « single-quoté »</a></li></ol></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:objects_and_message_passing"><span class="number">4.2.3</span> Objets et passage de message</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:method_definitions"><span class="number">4.2.4</span> Définition de méthode</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:back_to_the_title_helper"><span class="number">4.2.5</span> Retour à l'« helper » de titre</a></li></ol></li>
<li class="section"><a href="rails-flavored-ruby#sec:other_data_structures"><span class="number">4.3</span> Autres structures de données</a></li>
<li><ol>
<li class="subsection"><a href="rails-flavored-ruby#sec:arrays_and_ranges"><span class="number">4.3.1</span> Tableaux et rangs</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:blocks"><span class="number">4.3.2</span> Blocs</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:hashes_and_symbols"><span class="number">4.3.3</span> Tables de hachage et symboles</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:css_revisited"><span class="number">4.3.4</span> CSS revisitées</a></li></ol></li>
<li class="section"><a href="rails-flavored-ruby#sec:ruby_classes"><span class="number">4.4</span> Classes Ruby</a></li>
<li><ol>
<li class="subsection"><a href="rails-flavored-ruby#sec:constructors"><span class="number">4.4.1</span> Constructeurs</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:a_class_of_our_own"><span class="number">4.4.2</span> Héritages de classes</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:modifying_built_in_classes"><span class="number">4.4.3</span> Modifier les classes d'origine</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:a_controller_class"><span class="number">4.4.4</span> Classe de contrôleur</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:a_user_class"><span class="number">4.4.5</span> Classe utiliateur</a></li></ol></li>
<li class="section"><a href="rails-flavored-ruby#sec:Exercices"><span class="number">4.5</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="filling-in-the-layout#top"><span class="number">Chapitre 5</span> Poursuivre la mise en page</a></li>
<li><ol>
<li class="section"><a href="filling-in-the-layout#sec:structure"><span class="number">5.1</span> Ajout de structure</a></li>
<li><ol>
<li class="subsection"><a href="filling-in-the-layout#sec:adding_to_the_layout"><span class="number">5.1.1</span> Navigation du site</a></li>
<li class="subsection"><a href="filling-in-the-layout#sec:custom_css"><span class="number">5.1.2</span> Personnalisation CSS</a></li>
<li class="subsection"><a href="filling-in-the-layout#sec:partials"><span class="number">5.1.3</span> Partiels (Partials)</a></li></ol></li>
<li class="section"><a href="filling-in-the-layout#sec:layout_links"><span class="number">5.2</span> Liens pour la mise en page</a></li>
<li><ol>
<li class="subsection"><a href="filling-in-the-layout#sec:integration_tests"><span class="number">5.2.1</span> Test d'intégration</a></li>
<li class="subsection"><a href="filling-in-the-layout#sec:rails_routes"><span class="number">5.2.2</span> Routes Rails</a></li>
<li class="subsection"><a href="filling-in-the-layout#sec:named_routes"><span class="number">5.2.3</span> Nommer les routes</a></li></ol></li>
<li class="section"><a href="filling-in-the-layout#sec:user_signup"><span class="number">5.3</span> Inscription de l'utilisateur : une première étape</a></li>
<li><ol>
<li class="subsection"><a href="filling-in-the-layout#sec:users_controller"><span class="number">5.3.1</span> Contrôleur Utilisateur (Users controller)</a></li>
<li class="subsection"><a href="filling-in-the-layout#sec:signup_url"><span class="number">5.3.2</span> URL d'inscription</a></li></ol></li>
<li class="section"><a href="filling-in-the-layout#sec:layout_conclusion"><span class="number">5.4</span> Conclusion</a></li>
<li class="section"><a href="filling-in-the-layout#sec:layout_Exercices"><span class="number">5.5</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="modeling-and-viewing-users-one#top"><span class="number">Chapitre 6</span> Modéliser et afficher les utilisateurs, partie I</a></li>
<li><ol>
<li class="section"><a href="modeling-and-viewing-users-one#sec:user_model"><span class="number">6.1</span> Modèle utilisateur (User model)</a></li>
<li><ol>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:database_migrations"><span class="number">6.1.1</span> Migrations de la base de données</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:the_model_file"><span class="number">6.1.2</span> Le fichier modèle</a></li>
<li><ol>
<li class="subsubsection"><a href="modeling-and-viewing-users-one#sec:model_annotation">[(Model annotation)]</a></li>
<li class="subsubsection"><a href="modeling-and-viewing-users-one#sec:accessible_attributes">Attributs accessibles</a></li></ol></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:creating_user_objects"><span class="number">6.1.3</span> Créer des objets Utilisateur</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:finding_user_objects"><span class="number">6.1.4</span> Recherche dans les objets Utilisateurs (Users)</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:updating_user_objects"><span class="number">6.1.5</span> Actualisation des objets Utilisateurs (Users)</a></li></ol></li>
<li class="section"><a href="modeling-and-viewing-users-one#sec:user_validations"><span class="number">6.2</span> Validations utilisateur</a></li>
<li><ol>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:presence_validation"><span class="number">6.2.1</span> Valider l'existence</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:length_validation"><span class="number">6.2.2</span> Valider la longueur</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:format_validation"><span class="number">6.2.3</span> Valider le format</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:uniqueness_validation"><span class="number">6.2.4</span> Valider l'unicité</a></li>
<li><ol>
<li class="subsubsection"><a href="modeling-and-viewing-users-one#sec:the_caveat">L'avertissement d'unicité</a></li></ol></li></ol></li>
<li class="section"><a href="modeling-and-viewing-users-one#sec:viewing_users"><span class="number">6.3</span> Afficher les utilisateurs</a></li>
<li><ol>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:rails_environments"><span class="number">6.3.1</span> Débuggage et environnements Rails</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:users_show"><span class="number">6.3.2</span> Modèle, Vue et Contrôleur Utilisateur</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:a_users_resource"><span class="number">6.3.3</span> Ressource Utilisateurs</a></li>
<li><ol>
<li class="subsubsection"><a href="modeling-and-viewing-users-one#sec:params_in_debug">[(<code>params</code> in <code>debug</code>)]</a></li></ol></li></ol></li>
<li class="section"><a href="modeling-and-viewing-users-one#sec:6.4"><span class="number">6.4</span> Conclusion</a></li>
<li class="section"><a href="modeling-and-viewing-users-one#sec:6.5"><span class="number">6.5</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="modeling-and-viewing-users-two#top"><span class="number">Chapitre 7</span> Modéliser et afficher les utilisateurs, partie II</a></li>
<li><ol>
<li class="section"><a href="modeling-and-viewing-users-two#sec:insecure_passwords"><span class="number">7.1</span> Mots de passe non sûrs</a></li>
<li><ol>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:password_validations"><span class="number">7.1.1</span> Valider le mot de passe</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:password_migration"><span class="number">7.1.2</span> Migrer un mot de passe</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:an_active_record_callback"><span class="number">7.1.3</span> Un <em>callback</em> de l'Active Record</a></li></ol></li>
<li class="section"><a href="modeling-and-viewing-users-two#sec:secure_passwords"><span class="number">7.2</span> Sécuriser les mots de passe</a></li>
<li><ol>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:a_secure_password_test"><span class="number">7.2.1</span> Test de mot de passe sûr</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:secure_password_theory"><span class="number">7.2.2</span> Un peu de théorie sur la sécurisation des mots de passe</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:implementing_has_password"><span class="number">7.2.3</span> Implémenter la méthode <code>has_password?</code></a></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:an_authenticate_method"><span class="number">7.2.4</span> Méthode d'authentification</a></li></ol></li>
<li class="section"><a href="modeling-and-viewing-users-two#sec:better_user_views"><span class="number">7.3</span> Meilleures vues d'utilisateurs</a></li>
<li><ol>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:tests_with_factories"><span class="number">7.3.1</span> Tester la page de l'utilisateur (avec <em>factories</em>)</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:a_name_and_a_gravatar"><span class="number">7.3.2</span> Un nom et un Gravatar</a></li>
<li><ol>
<li class="subsubsection"><a href="modeling-and-viewing-users-two#sec:a_gravatar_helper">Un « helper » de Gravatar</a></li></ol></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:a_user_sidebar"><span class="number">7.3.3</span> Une barre utilisateur latérale</a></li></ol></li>
<li class="section"><a href="modeling-and-viewing-users-two#sec:7.4"><span class="number">7.4</span> Conclusion</a></li>
<li><ol>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:7.4.1"><span class="number">7.4.1</span> Dépôt Git</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:heroku_deploy"><span class="number">7.4.2</span> Déploiement Heroku</a></li></ol></li>
<li class="section"><a href="modeling-and-viewing-users-two#sec:more_modeling_users_Exercices"><span class="number">7.5</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="sign-up#top"><span class="number">Chapitre 8</span> Inscription</a></li>
<li><ol>
<li class="section"><a href="sign-up#sec:signup_form"><span class="number">8.1</span> Formulaire d'inscription</a></li>
<li><ol>
<li class="subsection"><a href="sign-up#sec:using_form_for"><span class="number">8.1.1</span> Utiliser  <code>form_for</code></a></li>
<li class="subsection"><a href="sign-up#sec:the_form_html"><span class="number">8.1.2</span> Le formulaire HTML</a></li></ol></li>
<li class="section"><a href="sign-up#sec:signup_failure"><span class="number">8.2</span> Échec de l'inscription</a></li>
<li><ol>
<li class="subsection"><a href="sign-up#sec:testing_failure"><span class="number">8.2.1</span> Test de l'échec</a></li>
<li class="subsection"><a href="sign-up#sec:a_working_form"><span class="number">8.2.2</span> Un formulaire fonctionnel</a></li>
<li class="subsection"><a href="sign-up#sec:signup_error_messages"><span class="number">8.2.3</span> Inscription&nbsp;: messages d'erreur</a></li>
<li class="subsection"><a href="sign-up#sec:filtering_parameter_logging"><span class="number">8.2.4</span> Filtrage des paramètres d'identification</a></li></ol></li>
<li class="section"><a href="sign-up#sec:signup_success"><span class="number">8.3</span> Succès de l'inscription</a></li>
<li><ol>
<li class="subsection"><a href="sign-up#sec:testing_success"><span class="number">8.3.1</span> Tester le succès de l'inscription</a></li>
<li class="subsection"><a href="sign-up#sec:the_finished_signup_form"><span class="number">8.3.2</span> Le formulaire d'inscription finalisé</a></li>
<li class="subsection"><a href="sign-up#sec:the_flash"><span class="number">8.3.3</span> Le message «&nbsp;flash&nbsp;»</a</a></li>
<li class="subsection"><a href="sign-up#sec:the_first_signup"><span class="number">8.3.4</span> La première inscription</a></li></ol></li>
<li class="section"><a href="sign-up#sec:rspec_integration_tests"><span class="number">8.4</span> Test d'intégration RSpec</a></li>
<li><ol>
<li class="subsection"><a href="sign-up#sec:integration_tests_with_style"><span class="number">8.4.1</span> Tests d'intégration avec les styles</a></li>
<li class="subsection"><a href="sign-up#sec:failed_signup"><span class="number">8.4.2</span> Un échec d'inscription ne devrait pas créer un nouvel utilisateur</a></li>
<li class="subsection"><a href="sign-up#sec:successful_signup"><span class="number">8.4.3</span> Le succès d'une inscription devrait créer un nouvel utilisateur</a></li></ol></li>
<li class="section"><a href="sign-up#sec:8.5"><span class="number">8.5</span> Conclusion</a></li>
<li class="section"><a href="sign-up#sec:signup_Exercices"><span class="number">8.6</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="sign-in-sign-out#top"><span class="number">Chapitre 9</span> Connexion, déconnexion</a></li>
<li><ol>
<li class="section"><a href="sign-in-sign-out#sec:sessions"><span class="number">9.1</span> Les sessions</a></li>
<li><ol>
<li class="subsection"><a href="sign-in-sign-out#sec:sessions_controller"><span class="number">9.1.1</span> Le contrôleur de session</a></li>
<li class="subsection"><a href="sign-in-sign-out#sec:signin_form"><span class="number">9.1.2</span> Formulaire d'identification</a></li></ol></li>
<li class="section"><a href="sign-in-sign-out#sec:signin_failure"><span class="number">9.2</span> Échec de l'identification</a></li>
<li><ol>
<li class="subsection"><a href="sign-in-sign-out#sec:reviewing_form_submission"><span class="number">9.2.1</span> Examen de la soumission du formulaire</a></li>
<li class="subsection"><a href="sign-in-sign-out#sec:failed_signin"><span class="number">9.2.2</span> Échec de l'identification (test et code)</a></li></ol></li>
<li class="section"><a href="sign-in-sign-out#sec:signin_success"><span class="number">9.3</span> Succès de l'identification</a></li>
<li><ol>
<li class="subsection"><a href="sign-in-sign-out#sec:the_completed_create_action"><span class="number">9.3.1</span> L'action <code>create</code> («&nbsp;créer&nbsp;») finalisée</a></li>
<li class="subsection"><a href="sign-in-sign-out#sec:remember_me"><span class="number">9.3.2</span> Se souvenir de moi</a></li>
<li class="subsection"><a href="sign-in-sign-out#sec:current_user"><span class="number">9.3.3</span> Utilisateur courant</a></li></ol></li>
<li class="section"><a href="sign-in-sign-out#sec:signing_out"><span class="number">9.4</span> Déconnexion</a></li>
<li><ol>
<li class="subsection"><a href="sign-in-sign-out#sec:destroying_sessions"><span class="number">9.4.1</span> Détruire la session</a></li>
<li class="subsection"><a href="sign-in-sign-out#sec:signin_upon_signup"><span class="number">9.4.2</span> Connection à l'inscription</a></li>
<li class="subsection"><a href="sign-in-sign-out#sec:changing_the_layout_links"><span class="number">9.4.3</span> Changement des liens de la mise en plage</a></li>
<li class="subsection"><a href="sign-in-sign-out#sec:signin_out_integration_tests"><span class="number">9.4.4</span> Test d'intégration de l'identification/déconnexion</a></li></ol></li>
<li class="section"><a href="sign-in-sign-out#sec:9.5"><span class="number">9.5</span> Conclusion</a></li>
<li class="section"><a href="sign-in-sign-out#sec:sign_in_out_Exercices"><span class="number">9.6</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="updating-showing-and-deleting-users#top"><span class="number">Chapitre 10</span> Actualiser, afficher et supprimer de l'utilisateur</a></li>
<li><ol>
<li class="section"><a href="updating-showing-and-deleting-users#sec:updating_users"><span class="number">10.1</span> Actualiser l'utilisateur</a></li>
<li><ol>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:edit_form"><span class="number">10.1.1</span> Formulaire de modification</a></li>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:enabling_edits"><span class="number">10.1.2</span> Permettre les modifications</a></li></ol></li>
<li class="section"><a href="updating-showing-and-deleting-users#sec:protecting_pages"><span class="number">10.2</span> Protéger les pages</a></li>
<li><ol>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:requiring_signed_in_users"><span class="number">10.2.1</span> Utilisateurs identifiés requis</a></li>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:requiring_the_right_user"><span class="number">10.2.2</span> Nécessité du bon utilisateur</a></li>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:friendly_forwarding"><span class="number">10.2.3</span> Redirection conviviale</a></li></ol></li>
<li class="section"><a href="updating-showing-and-deleting-users#sec:showing_users"><span class="number">10.3</span> Afficher les utilisateurs</a></li>
<li><ol>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:user_index"><span class="number">10.3.1</span> Liste des utilisateurs</a></li>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:sample_users"><span class="number">10.3.2</span> Exemples d'utilisateurs</a></li>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:pagination"><span class="number">10.3.3</span> Pagination</a></li>
<li><ol>
<li class="subsubsection"><a href="updating-showing-and-deleting-users#sec:testing_pagination">Test de la pagination</a></li></ol></li>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:partial_refactoring"><span class="number">10.3.4</span> Restructuration des partielles</a></li></ol></li>
<li class="section"><a href="updating-showing-and-deleting-users#sec:destroying_users"><span class="number">10.4</span> Supprimer des utilisateurs</a></li>
<li><ol>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:administrative_users"><span class="number">10.4.1</span> Utilisateurs administrateurs</a></li>
<li><ol>
<li class="subsubsection"><a href="updating-showing-and-deleting-users#sec:revisiting_attr_accessible">Révision de <code>attr_accessible</code></a></li></ol></li>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:the_destroy_action"><span class="number">10.4.2</span> L'action <code>destroy</code> («&nbsp;supprimer&nbsp;»)</a></li></ol></li>
<li class="section"><a href="updating-showing-and-deleting-users#sec:10.5"><span class="number">10.5</span> Conclusion</a></li>
<li class="section"><a href="updating-showing-and-deleting-users#sec:updating_deleting_Exercices"><span class="number">10.6</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="user-microposts#top"><span class="number">Chapitre 11</span> Micro-messages d'utilisateur</a></li>
<li><ol>
<li class="section"><a href="user-microposts#sec:a_micropost_model"><span class="number">11.1</span> Le modèle Micropost («&nbsp;Micro-message&nbsp;»)</a></li>
<li><ol>
<li class="subsection"><a href="user-microposts#sec:the_basic_model"><span class="number">11.1.1</span> Le modèle initial</a></li>
<li><ol>
<li class="subsubsection"><a href="user-microposts#sec:accessible_attribute">Attributs accessibles</a></li></ol></li>
<li class="subsection"><a href="user-microposts#sec:user_micropost_associations"><span class="number">11.1.2</span> Associations Utilisateur/micro-messages</a></li>
<li class="subsection"><a href="user-microposts#sec:ordering_and_dependency"><span class="number">11.1.3</span> Affinements du micro-message</a></li>
<li><ol>
<li class="subsubsection"><a href="user-microposts#sec:default_scope">Portée par défaut</a></li>
<li class="subsubsection"><a href="user-microposts#sec:dependent_destroy">Dependent: destroy (dépendances de la suppression)</a></li></ol></li>
<li class="subsection"><a href="user-microposts#sec:micropost_validations"><span class="number">11.1.4</span> Validations du micro-message</a></li></ol></li>
<li class="section"><a href="user-microposts#sec:showing_microposts"><span class="number">11.2</span> Afficher les micro-messages</a></li>
<li><ol>
<li class="subsection"><a href="user-microposts#sec:augmenting_the_user_show_page"><span class="number">11.2.1</span> Etoffement de la page de l'utilisateur</a></li>
<li class="subsection"><a href="user-microposts#sec:sample_microposts"><span class="number">11.2.2</span> Exemples de micro-messages</a></li></ol></li>
<li class="section"><a href="user-microposts#sec:manipulating_microposts"><span class="number">11.3</span> Manipuler les micro-messages</a></li>
<li><ol>
<li class="subsection"><a href="user-microposts#sec:access_control"><span class="number">11.3.1</span> Contrôle de l'accès</a></li>
<li class="subsection"><a href="user-microposts#sec:creating_microposts"><span class="number">11.3.2</span> Créer des micro-messages</a></li>
<li class="subsection"><a href="user-microposts#sec:a_proto_feed"><span class="number">11.3.3</span> Une proto-alimentation</a></li>
<li class="subsection"><a href="user-microposts#sec:destroying_microposts"><span class="number">11.3.4</span> Supprimer des micro-messages</a></li>
<li class="subsection"><a href="user-microposts#sec:testing_the_new_home_page"><span class="number">11.3.5</span> Test de la nouvelle page d'accueil</a></li></ol></li>
<li class="section"><a href="user-microposts#sec:11.4"><span class="number">11.4</span> Conclusion</a></li>
<li class="section"><a href="user-microposts#sec:micropost_Exercices"><span class="number">11.5</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="following-users#top"><span class="number">Chapitre 12</span> Suivi des utilisateurs</a></li>
<li><ol>
<li class="section"><a href="following-users#sec:the_relationship_model"><span class="number">12.1</span> Le modèle Relation (Relationship model)</a></li>
<li><ol>
<li class="subsection"><a href="following-users#sec:a_problem_with_the_data_model"><span class="number">12.1.1</span> Un problème du modèle de données (et sa solution)</a></li>
<li class="subsection"><a href="following-users#sec:relationship_user_associations"><span class="number">12.1.2</span> Associations Utilisateur/Relations</a></li>
<li class="subsection"><a href="following-users#sec:relationship_validations"><span class="number">12.1.3</span> Validations</a></li>
<li class="subsection"><a href="following-users#sec:following"><span class="number">12.1.4</span> Auteurs suivis</a></li>
<li class="subsection"><a href="following-users#sec:followers"><span class="number">12.1.5</span> Lecteurs</a></li></ol></li>
<li class="section"><a href="following-users#sec:a_web_interface_for_following_and_followers"><span class="number">12.2</span> Une interface web pour les auteurs suivis et les lecteurs</a></li>
<li><ol>
<li class="subsection"><a href="following-users#sec:sample_following_data"><span class="number">12.2.1</span> Exemple de donnée de suivi</a></li>
<li class="subsection"><a href="following-users#sec:stats_and_a_follow_form"><span class="number">12.2.2</span> Statistiques et formulaire de suivi</a></li>
<li class="subsection"><a href="following-users#sec:following_and_followers_pages"><span class="number">12.2.3</span> Pages d'auteurs suivis et de lecteurs</a></li>
<li class="subsection"><a href="following-users#sec:a_working_follow_button_the_standard_way"><span class="number">12.2.4</span> Un bouton de suivi fonctionnant de façon standard</a></li>
<li class="subsection"><a href="following-users#sec:a_working_follow_button_with_ajax"><span class="number">12.2.5</span> Un bouton fonctionnant avec Ajax</a></li></ol></li>
<li class="section"><a href="following-users#sec:the_status_feed"><span class="number">12.3</span> L'état de l'alimention</a></li>
<li><ol>
<li class="subsection"><a href="following-users#sec:motivation_and_strategy"><span class="number">12.3.1</span> Motivation et stratégie</a></li>
<li class="subsection"><a href="following-users#sec:a_first_feed_implementation"><span class="number">12.3.2</span> Une première implémentation de peuplement</a></li>
<li class="subsection"><a href="following-users#sec:scopes_subselects_and_a_lambda"><span class="number">12.3.3</span> Portées, sous-requêtes et fonction <em>lambda</em></a></li>
<li class="subsection"><a href="following-users#sec:the_new_status_feed"><span class="number">12.3.4</span> Nouvel état de l'alimentation</a></li></ol></li>
<li class="section"><a href="following-users#sec:following_conclusion"><span class="number">12.4</span> Conclusion</a></li>
<li><ol>
<li class="subsection"><a href="following-users#sec:extensions_to_the_sample_application"><span class="number">12.4.1</span> Extensions de l'application exemple</a></li>
<li><ol>
<li class="subsubsection"><a href="following-users#sec:replies">Réponses</a></li>
<li class="subsubsection"><a href="following-users#sec:messaging">Notification</a></li>
<li class="subsubsection"><a href="following-users#sec:follower_notifications">Notifications aux lecteurs</a></li>
<li class="subsubsection"><a href="following-users#sec:password_reminders">Rappel du mot de passe</a></li>
<li class="subsubsection"><a href="following-users#sec:signup_confirmation">Confirmation d'inscription</a></li>
<li class="subsubsection"><a href="following-users#sec:rss_feed">Alimentation RSS</a></li>
<li class="subsubsection"><a href="following-users#sec:rest_api">REST API</a></li>
<li class="subsubsection"><a href="following-users#sec:search">Recherche</a></li></ol></li>
<li class="subsection"><a href="following-users#sec:guide_to_further_resources"><span class="number">12.4.2</span> Guide vers d'autres ressources</a></li></ol></li>
<li class="section"><a href="following-users#sec:following_Exercices"><span class="number">12.5</span> Exercices</a></li></ol></li></ol></div>



<div id="main_content"></div>

<p> <span class="preamble">
 <span id="foreword">
<strong> Avant-propos</strong> <br />
 </span>
 </span></p>

<p>Ma précédente compagnie (CD Baby) fut une des premières à basculer intégralement vers Ruby on Rails, et à rebasculer aussi intégralement vers PHP (googlez-moi si vous voulez prendre la mesure du drame). On m'a tellement recommandé ce livre Michael Hartl que je n'ai pu faire autrement que de le lire. C'est ainsi que le <em>Tutoriel Ruby on Rails</em> m'a fait revenir à nouveau à Rails.</p>
<p>Bien qu'ayant parcouru de nombreux livres sur Rails, c'est ce tutoriel-là qui m'a véritablement «&nbsp;mis en possession&nbsp;» de Rails. Tout est fait ici «&nbsp;à la manière de Rails&nbsp;» —&nbsp;une manière qui ne m'avait jamais semblé naturelle avant que je ne lise ce livre. C'est aussi le seul ouvrage sur Rails qui met en place, d'un bout à l'autre, un <em>Développement Dirigé par les Tests</em> (<em>Test-Driven Development</em>), une approche que je savais hautement recommandée par les experts mais dont je n'avais jamais compris aussi bien la pertinence que dans ce livre. Enfin, en incluant Git, GitHub et Heroku dans les exemples de la démonstration, l'auteur vous donne vraiment le goût de ce qu'est le développement d'un projet dans la vie réelle. Et le exemples de code ne sont pas en reste.</p> 
	
<p>La narration linéaire adoptée par ce tutoriel est vraiment un bon format. Personnellement, j'ai étudié <em>Le Tutoriel Rails</em> en trois longues journées, en faisant tous les exemples et les exercices proposés à la fin de chaque chapitre. C'est en lisant ce livre du début à la fin, sans sauter la moindre partie, qu'on en tire tout le bénéfice.</p>

<p>Régalez-vous&nbsp;!</p>

<p><a href="http://sivers.org/">Derek Sivers</a> (<a href="http://sivers.org/">sivers.org</a>) <br />
<em>Précédemment&nbsp;: Fondateur de </em> <a href="http://www.cdbaby.com/"><em>CD Baby</em></a> <br />
<em>Actuellement&nbsp;: Fondateur de </em> <a href="http://thoughts.pro/"><em>Thoughts Ltd.</em></a> <br /></p>

<p> <span class="preamble">
<strong> Remerciements</strong> <br />
 </span></p>

<p>Ce <em>Tutoriel Ruby on Rails</em> doit beaucoup à mon livre précédent sur Rails, <em>RailsSpace</em>, et donc à mon co-auteur <a href="http://aure.com/">Aurelius Prochazka</a>. J'aimerais remercier Aure à la fois pour le travail qu'il a accompli sur ce précédent livre et pour son soutien pour le présent ouvrage. J'aimerais aussi remercier Debra Williams Cauley, mon éditeur pour les deux ouvrages&nbsp;; aussi longtemps qu'elle jouera avec moi au baseball, je continuerai d'écrire des livres pour elle.</p>

<p>J'aimerais remercier une longue liste de Rubyistes qui m'ont parlé et inspiré au cours des années&nbsp;: David Heinemeier Hansson, Yehuda Katz, Carl Lerche, Jeremy Kemper, Xavier Noria, Ryan Bates, Geoffrey Grosenbach, Peter Cooper, Matt Aimonetti, Gregg Pollack, Wayne&nbsp;E. Seguin, Amy Hoy, Dave Chelimsky, Pat Maddox, Tom Preston-Werner, Chris Wanstrath, Chad Fowler, Josh Susser, Obie Fernandez, Ian McFarland, Steven Bristol, Giles Bowkett, Evan Dorn, Long Nguyen, James Lindenbaum, Adam Wiggins, Tikhon Bernstam, Ron Evans, Wyatt Greene, Miles Forrest, les gens bien de Pivotal Labs, le gang Heroku, les mecs de thoughtbot et l'équipe de GitHub. Enfin, tellement, tellement, tellement de lecteurs —&nbsp;beaucoup trop pour les citer tous&nbsp;— qui ont contribué par leur rapport de bogues et leurs suggestions durant l'écriture de ce livre, et je tiens à saluer leur aide sans laquelle ce livre ne serait pas ce qu'il est. <br /></p>

<p> <span class="preamble">
 <span id="author">
<strong> À propos de l'auteur</strong> <br />
 </span>
 </span></p>

<p><a href="http://michaelhartl.com/">Michael Hartl</a> est programmeur, éducateur et entrepreneur. Il est le co-auteur de <em>RailsSpace</em>, un tutoriel Rails publié en 2007, et a été co-fondateur et développeur en chef de <a href="http://insoshi.com/">Insoshi</a>, une plateforme de réseau social <a href="http://github.com/popular/forked">populaire</a> en Ruby on Rails. Précédement, il a enseigné la théorie et la physique informatique au <a href="http://www.caltech.edu/">California Institute of Technology</a> (Caltech), où il a reçu le Lifetime Achievement Award for Excellence en enseignement. Michael est diplômé du <a href="http://college.harvard.edu/">Harvard College</a>, a un <a href="http://resolver.caltech.edu/CaltechETD:etd-05222003-161626">Ph.D. en physique</a> (un doctorat. NdT) de <a href="http://www.caltech.edu/">Caltech</a>, et il est ancien élève du programme des entrepreneurs <a href="http://ycombinator.com/">Y&nbsp;Combinator</a>. <br /></p>

<p> <span id="license" class="preamble">
<strong> Copyright et license</strong> <br />
 </span></p>

<p><em>Le Tutoriel Ruby on Rails&nbsp;: apprendre Rails par l'exemple</em>. Copyright &copy; 2010 par Michael Hartl. Tout le code source du <em>Tutoriel Ruby on Rails</em> est disponible sous la license <a href="http://www.opensource.org/licenses/mit-license.php">MIT License</a> et la licence <a href="http://en.wikipedia.org/wiki/Beerware">Beerware License</a>.</p>

<pre class="verbatim">   Copyright (c) 2010 Michael Hartl

   Permission est accordée, à titre gratuit, à toute personne obtenant
   une copie de ce logiciel et la documentation associée, pour faire des 
   modification dans le logiciel sans restriction et sans limitation des
   droits d’utiliser, copier, modifier, fusionner, publier, distribuer,
   concéder sous licence, et / ou de vendre les copies du Logiciel, et à
   autoriser les personnes auxquelles le Logiciel est meublé de le faire, 
   sous réserve des conditions suivantes:

   L’avis de copyright ci-dessus et cette autorisation doit être inclus
   dans toutes les copies ou parties substantielles du Logiciel.

   LE LOGICIEL EST FOURNI «TEL QUEL», SANS GARANTIE D’AUCUNE SORTE, 
   EXPLICITE OU IMPLICITE, Y COMPRIS, MAIS SANS S’Y LIMITER, LES 
   GARANTIES DE QUALITÉ MARCHANDE, ADAPTATION À UN USAGE PARTICULIER ET
   D’ABSENCE DE CONTREFAÇON. EN AUCUN CAS LES AUTEURS OU TITULAIRES DU
   ETRE TENU RESPONSABLE DE TOUT DOMMAGE, RÉCLAMATION OU AUTRES
   RESPONSABILITÉ, SOIT DANS UNE ACTION DE CONTRAT, UN TORT OU AUTRE,
   PROVENANT DE, DE OU EN RELATION AVEC LE LOGICIEL OU L’UTILISATION OU
   DE TRANSACTIONS AUTRES LE LOGICIEL.
	
</pre>




<pre class="verbatim">/*
 * ------------------------------------------------------------
 * &quot;LA LICENCE BEERWARE&quot; (Révision 42)&nbsp;:
 * Michael Hartl a écrit ce code. Aussi longtemps que vous
 * conservez cette note, vous pouvez faire ce que vous voulez
 * de ce travail. Si nous nous rencontrons un jour, et que vous
 * pensez que ce travail en vaut la peine, vous pourrez me
 * payer une bière en retour.
 * ------------------------------------------------------------
 */</pre>




<div id="top"></div>


<h1 class="chapter"><a id="sec:10" href="updating-showing-and-deleting-users#top" class="heading"><span class="number">Chapitre 10</span>Actualiser, afficher et supprimer des utilisateurs</a></h1>

<p>Dans ce chapitre, nous allons compléter les actions REST de la ressource Users (“utilisateurs”) (<a class="ref" href="modeling-and-viewing-users-one#table:RESTful_users">Table&nbsp;6.2</a>) en ajoutant les action <code>edit</code> (“éditer”), <code>update</code> (“actualiser”), <code>index</code> (“lister”), et <code>destroy</code> (“détruire”). Nous commencerons par donner la possibilité aux utilisateurs d'actualiser leur profil, ce qui donnera l'occasion de produire un modèle sécurisé (rendu possible  par le code d'authentification dans <a class="ref" href="sign-in-sign-out#top">Chapitre&nbsp;9</a>). Puis nous ferons un listing de tous les utilisateurs (nécessitant l'identification de l'utilisateur) ce qui nous amènera à introduire la notion de “données exemple” et de pagination. Enfin, nous ajouterons la possibilité de supprimer des utilisateurs en les retirant de la base de données. Puisque nous ne pouvons permettre à n'importe quel utilisateur d'avoir de tels pouvoirs, nous profiterons de l'occasion pour  créer la classe privilégiée d'utilisateur-administrateur (admins).</p>

<p>Avant de nous mettre au travail, commençons par initier une nouvelle branche développement&nbsp;: <code>updating-users</code>&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout -b updating-users
</pre></div>
</div>


<div class="label" id="sec:updating_users"></div>


<h2><a id="sec:10.1" href="updating-showing-and-deleting-users#sec:updating_users" class="heading"><span class="number">10.1</span> Actualisation</a></h2>


<p>La façon d'éditer les informations de l'utilisateur est très proche de celle pour les créer (<a class="ref" href="sign-up#top">Chapitre&nbsp;8</a>). Au lieu d'une action <code>new</code> rendant une vue pour des nouveaux utilisateurs, nous avons une action <code>edit</code> rendant une vue pour éditer les utilisateurs&nbsp;; à la place d'une action <code>create</code> répondant à une requête <tt>POST</tt>, nous avons une action <code>update</code> répondant à une requête <tt>PUT</tt> (<a class="ref" href="static-pages#sidebar:get_etc">Box&nbsp;3.1</a>). La différence notoire est que, entendu que n'importe qui peut s'inscrire, seul l'utilisateur courant doit être en mesure d'actualiser ses informations. Cela signifie que nous devons renforcer le contrôle d'accès afin que seuls l'utilisateur autorisé puisse accomplir les actions d'édition et d'actualisation&nbsp;; le mécanisme d'authentification du <a class="ref" href="sign-in-sign-out#top">Chapitre&nbsp;9</a> va nous permettre d'utiliser un <em>before filter</em> (un filtre “passe-avant”) pour remplir cette fonction.</p>

<div class="label" id="sec:edit_form"></div>


<h3><a id="sec:10.1.1" href="updating-showing-and-deleting-users#sec:edit_form" class="heading"><span class="number">10.1.1</span> Formulaire d'édition</a></h3>

<p>Nous commençons avec des tests pour le formulaire d'édition, dont la maquette apparait dans l'<a class="ref" href="updating-showing-and-deleting-users#fig:edit_user_mockup">Illustration&nbsp;10.1</a>.<sup class="footnote" id="fnref:10.1"><a href="#fn:10.1">1</a></sup> Les deux sont analogues aux tests que nous avons vu pour la page de nouvel utilisateur (<a class="ref" href="sign-up#code:new_users_tests">Listing&nbsp;8.1</a>), qui [vérifie la réponses appropriée et le titre][checking for the proper response and title]&nbsp;; le troisième test s'assure qu'il y ait un lien pour éditer l'image Gravatar de l'utilisateur (<a class="ref" href="modeling-and-viewing-users-two#sec:a_name_and_a_gravatar">Section&nbsp;7.3.2</a>). Si vous parcourrez [poke around] le site de Gravatar, vous verrez que la page pour ajouter ou modifier l'image est (ce qui peut sembler quelque peu étrange) à l'adresse <a href="http://gravatar.com/emails"><tt>http://gravatar.com/emails</tt></a>, donc nous testons la page <code>edit</code> page pour un lien possédant cette URL.<sup class="footnote" id="fnref:10.2"><a href="#fn:10.2">2</a></sup> Le résultat est montré dans <a class="ref" href="updating-showing-and-deleting-users#code:user_edit_specs">Listing&nbsp;10.1</a>.</p>

<div class="label" id="fig:edit_user_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/edit_user_mockup.png" alt="edit_user_mockup" /></span></div><div class="caption"><span class="header">Illustration 10.1: </span><span class="description">Mauqette de la page d'édition de l'utilisateur.&nbsp;<a href="http://railstutorial.org/images/figures/edit_user_mockup-full.png">(taille normale)</a></span></div></div>




<div class="label" id="code:user_edit_specs"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.1.</span> <span class="description">Tests pour l'action <code>edit</code> de l'utilisateur. <br /> <code>spec/controllers/users_controller_spec.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_68939a8c4a5a8b651102e480ebb0b228f70eafae">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=require%20'spec_helper'%0A%0Adescribe%20UsersController%20do%0A%20%20render_views%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20describe%20%22GET%20'edit'%22%20do%0A%0A%20%20%20%20before(:each)%20do%0A%20%20%20%20%20%20@user%20=%20Factory(:user)%0A%20%20%20%20%20%20test_sign_in(@user)%0A%20%20%20%20end%0A%0A%20%20%20%20it%20%22should%20be%20successful%22%20do%0A%20%20%20%20%20%20get%20:edit,%20:id%20=%3E%20@user%0A%20%20%20%20%20%20response.should%20be_success%0A%20%20%20%20end%0A%0A%20%20%20%20it%20%22should%20have%20the%20right%20title%22%20do%0A%20%20%20%20%20%20get%20:edit,%20:id%20=%3E%20@user%0A%20%20%20%20%20%20response.should%20have_selector(%22title%22,%20:content%20=%3E%20%22Edit%20user%22)%0A%20%20%20%20end%0A%0A%20%20%20%20it%20%22should%20have%20a%20link%20to%20change%20the%20Gravatar%22%20do%0A%20%20%20%20%20%20get%20:edit,%20:id%20=%3E%20@user%0A%20%20%20%20%20%20gravatar_url%20=%20%22http://gravatar.com/emails%22%0A%20%20%20%20%20%20response.should%20have_selector(%22a%22,%20:href%20=%3E%20gravatar_url,%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:content%20=%3E%20%22change%22)%0A%20%20%20%20end%0A%20%20end%0Aend%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=require%20'spec_helper'%0A%0Adescribe%20UsersController%20do%0A%20%20render_views%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20describe%20%22GET%20'edit'%22%20do%0A%0A%20%20%20%20before(:each)%20do%0A%20%20%20%20%20%20@user%20=%20Factory(:user)%0A%20%20%20%20%20%20test_sign_in(@user)%0A%20%20%20%20end%0A%0A%20%20%20%20it%20%22should%20be%20successful%22%20do%0A%20%20%20%20%20%20get%20:edit,%20:id%20=%3E%20@user%0A%20%20%20%20%20%20response.should%20be_success%0A%20%20%20%20end%0A%0A%20%20%20%20it%20%22should%20have%20the%20right%20title%22%20do%0A%20%20%20%20%20%20get%20:edit,%20:id%20=%3E%20@user%0A%20%20%20%20%20%20response.should%20have_selector(%22title%22,%20:content%20=%3E%20%22Edit%20user%22)%0A%20%20%20%20end%0A%0A%20%20%20%20it%20%22should%20have%20a%20link%20to%20change%20the%20Gravatar%22%20do%0A%20%20%20%20%20%20get%20:edit,%20:id%20=%3E%20@user%0A%20%20%20%20%20%20gravatar_url%20=%20%22http://gravatar.com/emails%22%0A%20%20%20%20%20%20response.should%20have_selector(%22a%22,%20:href%20=%3E%20gravatar_url,%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:content%20=%3E%20%22change%22)%0A%20%20%20%20end%0A%20%20end%0Aend%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">UsersController</span> <span class="k">do</span>
  <span class="n">render_views</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;GET &#39;edit&#39;&quot;</span> <span class="k">do</span>

    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
      <span class="n">test_sign_in</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;devrait réussir&quot;</span> <span class="k">do</span>
      <span class="n">get</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="vi">@user</span>
      <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">be_success</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;devrait avoir le bon titre&quot;</span> <span class="k">do</span>
      <span class="n">get</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="vi">@user</span>
      <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="s2">&quot;Edit user&quot;</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;devrait avoir un lien pour changer l'image Gravatar&quot;</span> <span class="k">do</span>
      <span class="n">get</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="vi">@user</span>
      <span class="n">gravatar_url</span> <span class="o">=</span> <span class="s2">&quot;http://gravatar.com/emails&quot;</span>
      <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="ss">:href</span> <span class="o">=&gt;</span> <span class="n">gravatar_url</span><span class="p">,</span>
                                         <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="s2">&quot;change&quot;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Ici, nous nous sommes assurés d'utiliser la méthode <code>test_sign_in(@user)</code> pour s'identifier en tant qu'utilisateur, anticipant par là-même l'accès protégé à la page d'édition (<a class="ref" href="updating-showing-and-deleting-users#sec:protecting_pages">Section&nbsp;10.2</a>). Dans le cas contraire, ces tests seraient invalides dès que nous implémenterions notre code d'authentification.</p>

<p>Notez, en observant la <a class="ref" href="modeling-and-viewing-users-one#table:RESTful_users">Table&nbsp;6.2</a> que l'URL correct pour la page d'édition d'un utilisateur est <tt>/users/1/edit</tt> (qui supposer que l'identifiant —&nbsp;id&nbsp;— de l'utilisateur est&nbsp;<tt>1</tt>). Souvenez-vous que l'identifiant —&nbsp;id&nbsp;— de l'utilisateur se trouve dans la variable <code>params[:id]</code>, ce qui signifie que nous pouvons trouver l'utilisateur avec le code du  <a class="ref" href="updating-showing-and-deleting-users#code:initial_edit_action">Listing&nbsp;10.2</a>. Il utiliser <code>find</code> (“trouver”) pour trouver l'utilisateur concerné dans la base de données, et renseigne alors la variable titre —&nbsp;<code>@title</code>&nbsp;—.</p>

<div class="label" id="code:initial_edit_action"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.2.</span> <span class="description">L'action <code>edit</code> de l'utilisateur. <br /> <code>app/controllers/users_controller.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_1fa0473f3e8dea2d37f9d9073a9674714734ac0b">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=class%20UsersController%20%3C%20ApplicationController%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20def%20edit%0A%20%20%20%20@user%20=%20User.find(params[:id])%0A%20%20%20%20@title%20=%20%22Edit%20user%22%0A%20%20end%0Aend%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=class%20UsersController%20%3C%20ApplicationController%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20def%20edit%0A%20%20%20%20@user%20=%20User.find(params[:id])%0A%20%20%20%20@title%20=%20%22Edit%20user%22%0A%20%20end%0Aend%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">edit</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
    <span class="vi">@title</span> <span class="o">=</span> <span class="s2">&quot;Edit user&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>

<p>Pour que le test soit valide, il faut créer la vue d'édition, montrée dans le <a class="ref" href="updating-showing-and-deleting-users#code:user_edit_view">Listing&nbsp;10.3</a>. Remarquez comme ce code s'apparente à celui de la vue du nouvel utilisateur du <a class="ref" href="sign-up#code:new_user_form">Listing&nbsp;8.2</a>&nbsp;; la grande similiture suggère de reconstruire la code à l'aide des partielles (“partial”), ce que vous pourrez faire à titre d'exercice (<a class="ref" href="updating-showing-and-deleting-users#sec:updating_deleting_exercises">Section&nbsp;10.6</a>).</p>

<div class="label" id="code:user_edit_view"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.3.</span> <span class="description">La vue d'édition de l'utilisateur. <br /> <code>app/views/users/edit.html.erb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_609ef158d399548cd6ab11f0ce03c88e31656ec1">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=%3Ch1%3EEdit%20user%3C/h1%3E%0A%0A%3C%25=%20form_for(@user)%20do%20%7Cf%7C%20%25%3E%0A%20%20%3C%25=%20render%20'shared/error_messages',%20:object%20=%3E%20f.object%20%25%3E%0A%20%20%3Cdiv%20class=%22field%22%3E%0A%20%20%20%20%3C%25=%20f.label%20:name%20%25%3E%3Cbr%20/%3E%0A%20%20%20%20%3C%25=%20f.text_field%20:name%20%25%3E%0A%20%20%3C/div%3E%0A%20%20%3Cdiv%20class=%22field%22%3E%0A%20%20%20%20%3C%25=%20f.label%20:email%20%25%3E%3Cbr%20/%3E%0A%20%20%20%20%3C%25=%20f.text_field%20:email%20%25%3E%0A%20%20%3C/div%3E%0A%20%20%3Cdiv%20class=%22field%22%3E%0A%20%20%20%20%3C%25=%20f.label%20:password%20%25%3E%3Cbr%20/%3E%0A%20%20%20%20%3C%25=%20f.password_field%20:password%20%25%3E%0A%20%20%3C/div%3E%0A%20%20%3Cdiv%20class=%22field%22%3E%0A%20%20%20%20%3C%25=%20f.label%20:password_confirmation,%20%22Confirmation%22%20%25%3E%3Cbr%20/%3E%0A%20%20%20%20%3C%25=%20f.password_field%20:password_confirmation%20%25%3E%0A%20%20%3C/div%3E%0A%20%20%3Cdiv%20class=%22actions%22%3E%0A%20%20%20%20%3C%25=%20f.submit%20%22Update%22%20%25%3E%0A%20%20%3C/div%3E%0A%3C%25%20end%20%25%3E%0A%0A%3Cdiv%3E%0A%20%20%3C%25=%20gravatar_for%20@user%20%25%3E%0A%20%20%3Ca%20href=%22http://gravatar.com/emails%22%3Echange%3C/a%3E%0A%3C/div%3E%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=%3Ch1%3EEdit%20user%3C/h1%3E%0A%0A%3C%25=%20form_for(@user)%20do%20%7Cf%7C%20%25%3E%0A%20%20%3C%25=%20render%20'shared/error_messages',%20:object%20=%3E%20f.object%20%25%3E%0A%20%20%3Cdiv%20class=%22field%22%3E%0A%20%20%20%20%3C%25=%20f.label%20:name%20%25%3E%3Cbr%20/%3E%0A%20%20%20%20%3C%25=%20f.text_field%20:name%20%25%3E%0A%20%20%3C/div%3E%0A%20%20%3Cdiv%20class=%22field%22%3E%0A%20%20%20%20%3C%25=%20f.label%20:email%20%25%3E%3Cbr%20/%3E%0A%20%20%20%20%3C%25=%20f.text_field%20:email%20%25%3E%0A%20%20%3C/div%3E%0A%20%20%3Cdiv%20class=%22field%22%3E%0A%20%20%20%20%3C%25=%20f.label%20:password%20%25%3E%3Cbr%20/%3E%0A%20%20%20%20%3C%25=%20f.password_field%20:password%20%25%3E%0A%20%20%3C/div%3E%0A%20%20%3Cdiv%20class=%22field%22%3E%0A%20%20%20%20%3C%25=%20f.label%20:password_confirmation,%20%22Confirmation%22%20%25%3E%3Cbr%20/%3E%0A%20%20%20%20%3C%25=%20f.password_field%20:password_confirmation%20%25%3E%0A%20%20%3C/div%3E%0A%20%20%3Cdiv%20class=%22actions%22%3E%0A%20%20%20%20%3C%25=%20f.submit%20%22Update%22%20%25%3E%0A%20%20%3C/div%3E%0A%3C%25%20end%20%25%3E%0A%0A%3Cdiv%3E%0A%20%20%3C%25=%20gravatar_for%20@user%20%25%3E%0A%20%20%3Ca%20href=%22http://gravatar.com/emails%22%3Echange%3C/a%3E%0A%3C/div%3E%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>Editer l'utilisateur<span class="nt">&lt;/h1&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/error_messages&#39;</span><span class="p">,</span> <span class="ss">:object</span> <span class="o">=&gt;</span> <span class="n">f</span><span class="o">.</span><span class="n">object</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;field&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:name</span> <span class="cp">%&gt;</span><span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;field&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:email</span> <span class="cp">%&gt;</span><span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;field&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password</span> <span class="cp">%&gt;</span><span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;field&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="s2">&quot;Confirmation&quot;</span> <span class="cp">%&gt;</span><span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password_confirmation</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;actions&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">&quot;Update&quot;</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

<span class="nt">&lt;div&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="vi">@user</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://gravatar.com/emails&quot;</span><span class="nt">&gt;</span>change<span class="nt">&lt;/a&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div></div>

<p>Ici, nous avons ré-utilisé la partielle partagée <code>error_messages</code> introduite à <a class="ref" href="sign-up#sec:signup_error_messages">Section&nbsp;8.2.3</a>.</p>

<p>Nous pouvons nous rappeler du <a class="ref" href="sign-up#code:f_error_messages">Listing&nbsp;8.8</a> que la partielle “error-messages” fait référence explicitement à la variable <code>@user</code>. Dans le cas présent, [][we <em>do</em> happen to have an <code>@user</code> variable], [mais dans le but d'obtenir vraiment une partielle partagée][but in order to make this a truly shared partial] [nous ne devons pas déprendre de ce fait][ we should not depend on this fact]. La solution consiste à passer à la partielle, en paramètre, un objet correspondant à la variable formulaire&nbsp;<code>f</code>&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/error_messages&#39;</span><span class="p">,</span> <span class="ss">:object</span> <span class="o">=&gt;</span> <span class="n">f</span><span class="o">.</span><span class="n">object</span> <span class="cp">%&gt;</span>
</pre></div>
</div>

<p>Cela crée une variable appelée <code>object</code> dans la partielle, qui peut être alors utilisée pour générer les messages d'erreur, comme le montre le <a class="ref" href="updating-showing-and-deleting-users#code:updated_error_messages_partial">Listing&nbsp;10.4</a>. (Notez l'élégance de la chaine de méthodes qui produit une bonne version du nom de l'objet&nbsp;; voyez l'entrée de l'API Rails pour, disons, <code>humanize</code>, [pour avoir une idée des possibilités de Rails][to get an idea of the range of Rails utilities available].)</p>

<div class="label" id="code:updated_error_messages_partial"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.4.</span> <span class="description">Actualisation de la partielle des messages d'erreur du <a class="ref" href="sign-up#code:errors_partial">Listing&nbsp;8.9</a> pour qu'il fonctionne avec d'autres objets. <br /> <code>app/views/shared/_error_messages.html.erb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_00de7ea22b93f982b6be5666d424d963731f9b25">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=%3C%25%20if%20object.errors.any?%20%25%3E%0A%20%20%3Cdiv%20id=%22error_explanation%22%3E%0A%20%20%20%20%3Ch2%3E%3C%25=%20pluralize(object.errors.count,%20%22error%22)%20%25%3E%20%0A%20%20%20%20%20%20%20%20prohibited%20this%20%3C%25=%20object.class.to_s.underscore.humanize.downcase%20%25%3E%20%0A%20%20%20%20%20%20%20%20from%20being%20saved:%3C/h2%3E%0A%20%20%20%20%3Cp%3EThere%20were%20problems%20with%20the%20following%20fields:%3C/p%3E%0A%20%20%20%20%3Cul%3E%0A%20%20%20%20%3C%25%20object.errors.full_messages.each%20do%20%7Cmsg%7C%20%25%3E%0A%20%20%20%20%20%20%3Cli%3E%3C%25=%20msg%20%25%3E%3C/li%3E%0A%20%20%20%20%3C%25%20end%20%25%3E%0A%20%20%20%20%3C/ul%3E%0A%20%20%3C/div%3E%0A%3C%25%20end%20%25%3E%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=%3C%25%20if%20object.errors.any?%20%25%3E%0A%20%20%3Cdiv%20id=%22error_explanation%22%3E%0A%20%20%20%20%3Ch2%3E%3C%25=%20pluralize(object.errors.count,%20%22error%22)%20%25%3E%20%0A%20%20%20%20%20%20%20%20prohibited%20this%20%3C%25=%20object.class.to_s.underscore.humanize.downcase%20%25%3E%20%0A%20%20%20%20%20%20%20%20from%20being%20saved:%3C/h2%3E%0A%20%20%20%20%3Cp%3EThere%20were%20problems%20with%20the%20following%20fields:%3C/p%3E%0A%20%20%20%20%3Cul%3E%0A%20%20%20%20%3C%25%20object.errors.full_messages.each%20do%20%7Cmsg%7C%20%25%3E%0A%20%20%20%20%20%20%3Cli%3E%3C%25=%20msg%20%25%3E%3C/li%3E%0A%20%20%20%20%3C%25%20end%20%25%3E%0A%20%20%20%20%3C/ul%3E%0A%20%20%3C/div%3E%0A%3C%25%20end%20%25%3E%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">object</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">any?</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;error_explanation&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;h2&gt;</span><span class="cp">&lt;%=</span> <span class="n">pluralize</span><span class="p">(</span><span class="n">object</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">count</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span> <span class="cp">%&gt;</span> 
        prohibited this <span class="cp">&lt;%=</span> <span class="n">object</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">underscore</span><span class="o">.</span><span class="n">humanize</span><span class="o">.</span><span class="n">downcase</span> <span class="cp">%&gt;</span> 
        from being saved:<span class="nt">&lt;/h2&gt;</span>
    <span class="nt">&lt;p&gt;</span>There were problems with the following fields:<span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;ul&gt;</span>
    <span class="cp">&lt;%</span> <span class="n">object</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">full_messages</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">msg</span><span class="o">|</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">msg</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/ul&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>

<p>Pendant que nous y sommes, nous allons actualiser le formulaire d'inscription avec ce code (<a class="ref" href="updating-showing-and-deleting-users#code:signup_errors_updated">Listing&nbsp;10.5</a>).</p>

<div class="label" id="code:signup_errors_updated"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.5.</span> <span class="description">Actualisation du rendu des messages d'erreur de l'inscription des utilisateurs. <br /> <code>app/views/users/new.html.erb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_9a7dcac21bbc1d2fada0b8683a2740d84b3dc7c1">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=%3Ch1%3ESign%20up%3C/h1%3E%0A%0A%3C%25=%20form_for(@user)%20do%20%7Cf%7C%20%25%3E%0A%20%20%3C%25=%20render%20'shared/error_messages',%20:object%20=%3E%20f.object%20%25%3E%0A%20%20.%0A%20%20.%0A%20%20.%0A%3C%25%20end%20%25%3E%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=%3Ch1%3ESign%20up%3C/h1%3E%0A%0A%3C%25=%20form_for(@user)%20do%20%7Cf%7C%20%25%3E%0A%20%20%3C%25=%20render%20'shared/error_messages',%20:object%20=%3E%20f.object%20%25%3E%0A%20%20.%0A%20%20.%0A%20%20.%0A%3C%25%20end%20%25%3E%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>Inscription<span class="nt">&lt;/h1&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/error_messages&#39;</span><span class="p">,</span> <span class="ss">:object</span> <span class="o">=&gt;</span> <span class="n">f</span><span class="o">.</span><span class="n">object</span> <span class="cp">%&gt;</span>
  .
  .
  .
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>

<p>Nous allons également ajouter un lien dans la partie navigation du site pour la page d'édition de l'utilisateur (que nous appellerons &ldquo;Profil&rdquo;), sur la base de la maquette dans l'<a class="ref" href="updating-showing-and-deleting-users#fig:profile_settings_link_mockup">Illustration&nbsp;10.2</a><sup class="footnote" id="fnref:10.3"><a href="#fn:10.3">3</a></sup> et montré dans le <a class="ref" href="updating-showing-and-deleting-users#code:settings_link">Listing&nbsp;10.6</a>.</p>

<div class="label" id="fig:profile_settings_link_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/profile_settings_link_mockup.png" alt="profile_settings_link_mockup" /></span></div><div class="caption"><span class="header">Figure 10.2: </span><span class="description">Maquette de la page d'édition de l'utilisateur avec un lien &ldquo;Profil&rdquo;.&nbsp;<a href="http://railstutorial.org/images/figures/profile_settings_link_mockup-full.png">(full size)</a></span></div></div>




<div class="label" id="code:settings_link"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.6.</span> <span class="description">Ajout d'un lien Profil. <br /> <code>app/views/layouts/_header.html.erb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_a05e4500ae3b22fc395253d6efba7ed9b0fe28b2">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=%3Cheader%3E%0A%20%20%3C%25=%20link_to%20logo,%20root_path%20%25%3E%0A%20%20%3Cnav%20class=%22round%22%3E%0A%20%20%20%20%3Cul%3E%0A%20%20%20%20%20%20%3Cli%3E%3C%25=%20link_to%20%22Home%22,%20root_path%20%25%3E%3C/li%3E%0A%20%20%20%20%20%20%3C%25%20if%20signed_in?%20%25%3E%0A%20%20%20%20%20%20%3Cli%3E%3C%25=%20link_to%20%22Profile%22,%20current_user%20%25%3E%3C/li%3E%0A%20%20%20%20%20%20%3Cli%3E%3C%25=%20link_to%20%22Settings%22,%20edit_user_path(current_user)%20%25%3E%3C/li%3E%0A%20%20%20%20%20%20%3C%25%20end%20%25%3E%0A%20%20%20%20%20%20.%0A%20%20%20%20%20%20.%0A%20%20%20%20%20%20.%0A%20%20%20%20%3C/ul%3E%0A%20%20%3C/nav%3E%0A%3C/header%3E%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=%3Cheader%3E%0A%20%20%3C%25=%20link_to%20logo,%20root_path%20%25%3E%0A%20%20%3Cnav%20class=%22round%22%3E%0A%20%20%20%20%3Cul%3E%0A%20%20%20%20%20%20%3Cli%3E%3C%25=%20link_to%20%22Home%22,%20root_path%20%25%3E%3C/li%3E%0A%20%20%20%20%20%20%3C%25%20if%20signed_in?%20%25%3E%0A%20%20%20%20%20%20%3Cli%3E%3C%25=%20link_to%20%22Profile%22,%20current_user%20%25%3E%3C/li%3E%0A%20%20%20%20%20%20%3Cli%3E%3C%25=%20link_to%20%22Settings%22,%20edit_user_path(current_user)%20%25%3E%3C/li%3E%0A%20%20%20%20%20%20%3C%25%20end%20%25%3E%0A%20%20%20%20%20%20.%0A%20%20%20%20%20%20.%0A%20%20%20%20%20%20.%0A%20%20%20%20%3C/ul%3E%0A%20%20%3C/nav%3E%0A%3C/header%3E%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;header&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">logo</span><span class="p">,</span> <span class="n">root_path</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;nav</span> <span class="na">class=</span><span class="s">&quot;round&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;ul&gt;</span>
      <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Home&quot;</span><span class="p">,</span> <span class="n">root_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">signed_in?</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Profile&quot;</span><span class="p">,</span> <span class="n">current_user</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
      <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Profil&quot;</span><span class="p">,</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
      .
      .
      .
    <span class="nt">&lt;/ul&gt;</span>
  <span class="nt">&lt;/nav&gt;</span>
<span class="nt">&lt;/header&gt;</span>
</pre></div>
</div></div>

<p>Ici nous utilisons la route de nom <code>edit_user_path</code> de la <a class="ref" href="modeling-and-viewing-users-one#table:RESTful_users">Table&nbsp;6.2</a>, avec la méthode pratique de l'helper <code>current_user</code> définie dans le <a class="ref" href="sign-in-sign-out#code:current_user_working">Listing&nbsp;9.16</a>.</p>

<p>Avec la variable d'instance <code>@user</code> du <a class="ref" href="updating-showing-and-deleting-users#code:initial_edit_action">Listing&nbsp;10.2</a>, les tests du <a class="ref" href="updating-showing-and-deleting-users#code:user_edit_specs">Listing&nbsp;10.1</a> réussiront. Comme cela est montré dans l'<a class="ref" href="updating-showing-and-deleting-users#fig:edit_user_settings">Illustration&nbsp;10.3</a>, le rendu de la page <code>edit</code>, bien qu'elle ne fonctionne pas encore.</p>

<div class="label" id="fig:edit_user_settings"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/edit_user_settings.png" alt="edit_user_settings" /></span></div><div class="caption"><span class="header">Figure 10.3: </span><span class="description">Edition des caractéristiques de l'utilisateur [Editing user settings] (<a href="http://localhost:3000/users/1/edit"><tt>/users/1/edit</tt></a>).&nbsp;<a href="http://railstutorial.org/images/figures/edit_user_settings-full.png">(taille normale)</a></span></div></div>

<p>En regardant le code HTML source de l'<a class="ref" href="updating-showing-and-deleting-users#fig:edit_user_settings">Illustration&nbsp;10.3</a>, nous voyons la balise de formulaire attendue (<a class="ref" href="updating-showing-and-deleting-users#code:edit_form_html">Listing&nbsp;10.7</a>).</p>

<div class="label" id="code:edit_form_html"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.7.</span> <span class="description">Code HTML pour le formulaire d'édition défini dans le <a class="ref" href="updating-showing-and-deleting-users#code:user_edit_view">Listing&nbsp;10.3</a> et affiché dans l'<a class="ref" href="updating-showing-and-deleting-users#fig:edit_user_settings">Illustration&nbsp;10.3</a>.</span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_b2e92c646c288a84aadb4724ff93c38ac409535a">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=%3Cform%20action=%22/users/1%22%20class=%22edit_user%22%20id=%22edit_user_1%22%20method=%22post%22%3E%0A%20%20%3Cinput%20name=%22_method%22%20type=%22hidden%22%20value=%22put%22%20/%3E%0A%20%20.%0A%20%20.%0A%20%20.%0A%3C/form%3E%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=%3Cform%20action=%22/users/1%22%20class=%22edit_user%22%20id=%22edit_user_1%22%20method=%22post%22%3E%0A%20%20%3Cinput%20name=%22_method%22%20type=%22hidden%22%20value=%22put%22%20/%3E%0A%20%20.%0A%20%20.%0A%20%20.%0A%3C/form%3E%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">&quot;/users/1&quot;</span> <span class="na">class=</span><span class="s">&quot;edit_user&quot;</span> <span class="na">id=</span><span class="s">&quot;edit_user_1&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">&quot;_method&quot;</span> <span class="na">type=</span><span class="s">&quot;hidden&quot;</span> <span class="na">value=</span><span class="s">&quot;put&quot;</span> <span class="nt">/&gt;</span>
  .
  .
  .
<span class="nt">&lt;/form&gt;</span>
</pre></div>
</div></div>

<p>Notez ici le champ caché (input class="hidden")</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">&quot;_method&quot;</span> <span class="na">type=</span><span class="s">&quot;hidden&quot;</span> <span class="na">value=</span><span class="s">&quot;put&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>

<p>Puisque les navigateurs internet ne peuvent pas, de façon native, envoyer des requêtes <tt>PUT</tt> (requises par les conventions REST conventions de la <a class="ref" href="modeling-and-viewing-users-one#table:RESTful_users">Table&nbsp;6.2</a>), Rails la simule avec une requête <tt>POST</tt> et un champ caché (hidden <code>input</code>).<sup class="footnote" id="fnref:10.4"><a href="#fn:10.4">4</a></sup></p>

<p>Il y a une autre subilité à noter ici&nbsp;: le code <code>form_for(@user)</code> dans le <a class="ref" href="updating-showing-and-deleting-users#code:user_edit_view">Listing&nbsp;10.3</a> est <em>très exactement</em> identique au code dans le <a class="ref" href="sign-up#code:new_user_form">Listing&nbsp;8.2</a>&mdash;donc comment fait Rails pour utiliser la requête <tt>POST</tt> pour de nouveaux utilisateurs et la requête <tt>PUT</tt> pour éditer ces utilisateurs&nbsp;? La réponse est qu'il est possible de dire si un utilisateur est nouveau ou s'il existe déjà dans la base de données via la méthode booléenne <code>new_record?</code> (nouveL_enregistrement) (que nous avons vu brièvement dans le <a class="ref" href="modeling-and-viewing-users-two#code:has_password_with_encrypt">Listing&nbsp;7.10</a>):</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">new_record?</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">new_record?</span>
<span class="go">=&gt; false</span>
</pre></div>
</div>


<p>Quand nous construisons un formulaire en utilisant <code>form_for(@user)</code>, Rails utilise la requête <tt>POST</tt> si  <code>@user.new_record?</code> est vrai (<code>true</code>) et la requête <tt>PUT</tt> si la méthode renvoie <code>false</code>.</p>

<div class="label" id="sec:enabling_edits"></div>


<h3><a id="sec:10.1.2" href="updating-showing-and-deleting-users#sec:enabling_edits" class="heading"><span class="number">10.1.2</span> Permettre l'édition</a></h3>

<p>Bien que le formulaire d'édition ne fonctionne pas encore, nous avons [extrait l'image de Gravatar][we&rsquo;ve outsourced image upload to Gravatar], donc il fonctionne déjà en cliquant sur le lien &ldquo;change&rdquo; link de l'<a class="ref" href="updating-showing-and-deleting-users#fig:edit_user_settings">Illustration&nbsp;10.3</a>, comme montré dans l'<a class="ref" href="updating-showing-and-deleting-users#fig:gravatar_cropper">Illustration&nbsp;10.4</a>. Mettons en place les autres fonctionnalités de l'édition de l'utilisateur.</p>

<div class="label" id="fig:gravatar_cropper"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/gravatar_cropper.png" alt="gravatar_cropper" /></span></div><div class="caption"><span class="header">Illustration 10.4: </span><span class="description">L'interface d'ajustement de <a href="http://gravatar.com/">Gravatar</a>, avec une image de <a href="http://michaelhartl.com/">some dude</a>.&nbsp;<a href="http://railstutorial.org/images/figures/gravatar_cropper-full.png">(taille normale)</a></span></div></div>

<p>Les tests pour  l'action <code>update</code> (“actualisation”) sont similaires à ceux de l'action <code>create</code> (“Créer”). En particulier, nous testons l'échec de l'actualisation et son succès (<a class="ref" href="updating-showing-and-deleting-users#code:user_update_specs">Listing&nbsp;10.8</a>). (C'est beaucoup de code&nbsp;; voyons si vous pouvez l'analyser en vous référant aux tests du <a class="ref" href="sign-up#top">Chapitre&nbsp;8</a>.)</p>

<div class="label" id="code:user_update_specs"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.8.</span> <span class="description">Tests pour l'action <code>update</code> de l'utilisateur. <br /> <code>spec/controllers/users_controller_spec.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_b94ffec5313a99d0b3621a363ae145623fd3937c">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=describe%20UsersController%20do%0A%20%20render_views%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20describe%20%22PUT%20'update'%22%20do%0A%0A%20%20%20%20before(:each)%20do%0A%20%20%20%20%20%20@user%20=%20Factory(:user)%0A%20%20%20%20%20%20test_sign_in(@user)%0A%20%20%20%20end%0A%0A%20%20%20%20describe%20%22failure%22%20do%0A%0A%20%20%20%20%20%20before(:each)%20do%0A%20%20%20%20%20%20%20%20@attr%20=%20%7B%20:email%20=%3E%20%22%22,%20:name%20=%3E%20%22%22,%20:password%20=%3E%20%22%22,%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:password_confirmation%20=%3E%20%22%22%20%7D%0A%20%20%20%20%20%20end%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20it%20%22should%20render%20the%20'edit'%20page%22%20do%0A%20%20%20%20%20%20%20%20put%20:update,%20:id%20=%3E%20@user,%20:user%20=%3E%20@attr%0A%20%20%20%20%20%20%20%20response.should%20render_template('edit')%0A%20%20%20%20%20%20end%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20it%20%22should%20have%20the%20right%20title%22%20do%0A%20%20%20%20%20%20%20%20put%20:update,%20:id%20=%3E%20@user,%20:user%20=%3E%20@attr%0A%20%20%20%20%20%20%20%20response.should%20have_selector(%22title%22,%20:content%20=%3E%20%22Edit%20user%22)%0A%20%20%20%20%20%20end%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20describe%20%22success%22%20do%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20before(:each)%20do%0A%20%20%20%20%20%20%20%20@attr%20=%20%7B%20:name%20=%3E%20%22New%20Name%22,%20:email%20=%3E%20%22user@example.org%22,%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:password%20=%3E%20%22barbaz%22,%20:password_confirmation%20=%3E%20%22barbaz%22%20%7D%0A%20%20%20%20%20%20end%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20it%20%22should%20change%20the%20user's%20attributes%22%20do%0A%20%20%20%20%20%20%20%20put%20:update,%20:id%20=%3E%20@user,%20:user%20=%3E%20@attr%0A%20%20%20%20%20%20%20%20@user.reload%0A%20%20%20%20%20%20%20%20@user.name.should%20%20==%20@attr[:name]%0A%20%20%20%20%20%20%20%20@user.email.should%20==%20@attr[:email]%0A%20%20%20%20%20%20end%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20it%20%22should%20redirect%20to%20the%20user%20show%20page%22%20do%0A%20%20%20%20%20%20%20%20put%20:update,%20:id%20=%3E%20@user,%20:user%20=%3E%20@attr%0A%20%20%20%20%20%20%20%20response.should%20redirect_to(user_path(@user))%0A%20%20%20%20%20%20end%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20it%20%22should%20have%20a%20flash%20message%22%20do%0A%20%20%20%20%20%20%20%20put%20:update,%20:id%20=%3E%20@user,%20:user%20=%3E%20@attr%0A%20%20%20%20%20%20%20%20flash[:success].should%20=~%20/updated/%0A%20%20%20%20%20%20end%0A%20%20%20%20end%0A%20%20end%0Aend%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=describe%20UsersController%20do%0A%20%20render_views%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20describe%20%22PUT%20'update'%22%20do%0A%0A%20%20%20%20before(:each)%20do%0A%20%20%20%20%20%20@user%20=%20Factory(:user)%0A%20%20%20%20%20%20test_sign_in(@user)%0A%20%20%20%20end%0A%0A%20%20%20%20describe%20%22failure%22%20do%0A%0A%20%20%20%20%20%20before(:each)%20do%0A%20%20%20%20%20%20%20%20@attr%20=%20%7B%20:email%20=%3E%20%22%22,%20:name%20=%3E%20%22%22,%20:password%20=%3E%20%22%22,%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:password_confirmation%20=%3E%20%22%22%20%7D%0A%20%20%20%20%20%20end%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20it%20%22should%20render%20the%20'edit'%20page%22%20do%0A%20%20%20%20%20%20%20%20put%20:update,%20:id%20=%3E%20@user,%20:user%20=%3E%20@attr%0A%20%20%20%20%20%20%20%20response.should%20render_template('edit')%0A%20%20%20%20%20%20end%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20it%20%22should%20have%20the%20right%20title%22%20do%0A%20%20%20%20%20%20%20%20put%20:update,%20:id%20=%3E%20@user,%20:user%20=%3E%20@attr%0A%20%20%20%20%20%20%20%20response.should%20have_selector(%22title%22,%20:content%20=%3E%20%22Edit%20user%22)%0A%20%20%20%20%20%20end%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20describe%20%22success%22%20do%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20before(:each)%20do%0A%20%20%20%20%20%20%20%20@attr%20=%20%7B%20:name%20=%3E%20%22New%20Name%22,%20:email%20=%3E%20%22user@example.org%22,%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:password%20=%3E%20%22barbaz%22,%20:password_confirmation%20=%3E%20%22barbaz%22%20%7D%0A%20%20%20%20%20%20end%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20it%20%22should%20change%20the%20user's%20attributes%22%20do%0A%20%20%20%20%20%20%20%20put%20:update,%20:id%20=%3E%20@user,%20:user%20=%3E%20@attr%0A%20%20%20%20%20%20%20%20@user.reload%0A%20%20%20%20%20%20%20%20@user.name.should%20%20==%20@attr[:name]%0A%20%20%20%20%20%20%20%20@user.email.should%20==%20@attr[:email]%0A%20%20%20%20%20%20end%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20it%20%22should%20redirect%20to%20the%20user%20show%20page%22%20do%0A%20%20%20%20%20%20%20%20put%20:update,%20:id%20=%3E%20@user,%20:user%20=%3E%20@attr%0A%20%20%20%20%20%20%20%20response.should%20redirect_to(user_path(@user))%0A%20%20%20%20%20%20end%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20it%20%22should%20have%20a%20flash%20message%22%20do%0A%20%20%20%20%20%20%20%20put%20:update,%20:id%20=%3E%20@user,%20:user%20=%3E%20@attr%0A%20%20%20%20%20%20%20%20flash[:success].should%20=~%20/updated/%0A%20%20%20%20%20%20end%0A%20%20%20%20end%0A%20%20end%0Aend%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="no">UsersController</span> <span class="k">do</span>
  <span class="n">render_views</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;PUT &#39;update&#39;&quot;</span> <span class="k">do</span>

    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
      <span class="n">test_sign_in</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">&quot;Échec&quot;</span> <span class="k">do</span>

      <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
        <span class="vi">@attr</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="ss">:password</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                  <span class="ss">:password_confirmation</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span> <span class="p">}</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;devrait retourner la page d'édition&quot;</span> <span class="k">do</span>
        <span class="n">put</span> <span class="ss">:update</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="vi">@attr</span>
        <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;edit&#39;</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;devrait avoir le bon titre&quot;</span> <span class="k">do</span>
        <span class="n">put</span> <span class="ss">:update</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="vi">@attr</span>
        <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="s2">&quot;Edit user&quot;</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">&quot;succès&quot;</span> <span class="k">do</span>

      <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
        <span class="vi">@attr</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;New Name&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;user@example.org&quot;</span><span class="p">,</span>
                  <span class="ss">:password</span> <span class="o">=&gt;</span> <span class="s2">&quot;barbaz&quot;</span><span class="p">,</span> <span class="ss">:password_confirmation</span> <span class="o">=&gt;</span> <span class="s2">&quot;barbaz&quot;</span> <span class="p">}</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;devrait modifier les caractéristiques de l'utilisateur&quot;</span> <span class="k">do</span>
        <span class="n">put</span> <span class="ss">:update</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="vi">@attr</span>
        <span class="vi">@user</span><span class="o">.</span><span class="n">reload</span>
        <span class="vi">@user</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">should</span>  <span class="o">==</span> <span class="vi">@attr</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span>
        <span class="vi">@user</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="vi">@attr</span><span class="o">[</span><span class="ss">:email</span><span class="o">]</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;devrait rediriger vers la page d'affichage de l'utilisateur&quot;</span> <span class="k">do</span>
        <span class="n">put</span> <span class="ss">:update</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="vi">@attr</span>
        <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">))</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;devrait afficher un message flash&quot;</span> <span class="k">do</span>
        <span class="n">put</span> <span class="ss">:update</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="vi">@attr</span>
        <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">].</span><span class="n">should</span> <span class="o">=~</span> <span class="sr">/updated/</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>

<p>La seule nouveauté ici est la méthode <code>reload</code> (“rechargement”), qui apparait dans le test pour le changements des caractéristiques de l'utilisateur&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="s2">&quot;devrait modifier les caractéristiques de l'utilisateur&quot;</span> <span class="k">do</span>
  <span class="vi">@user</span><span class="o">.</span><span class="n">reload</span>
  <span class="vi">@user</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">should</span>  <span class="o">==</span> <span class="vi">@attr</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span>
  <span class="vi">@user</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="vi">@attr</span><span class="o">[</span><span class="ss">:email</span><span class="o">]</span>
<span class="k">end</span>
</pre></div>
</div>

<p>Ce code recharge la variable <code>@user</code> de la base de données (de test) en utilisant <code>@user.reload</code>, et vérifie alors que le nouveau nom de l'utilisateur et son adresse mail correspondent aux valeurs présentent dans la table <code>@attr</code>.</p>

<p>L'action <code>update</code> (“actualiser”) nécessaire pour réussir les tests du <a class="ref" href="updating-showing-and-deleting-users#code:user_update_specs">Listing&nbsp;10.8</a> est similaire au formulaire final de l'action <code>create</code> (“créer”) (<a class="ref" href="sign-in-sign-out#code:signin_upon_signup">Listing&nbsp;9.24</a>), comme nous l'avons vu dans le <a class="ref" href="updating-showing-and-deleting-users#code:user_update_action">Listing&nbsp;10.9</a>.</p>

<div class="label" id="code:user_update_action"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.9.</span> <span class="description">L'action utilisateur <code>update</code> (“actualiser”). <br /> <code>app/controllers/users_controller.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_f8caf5d9edf24be49139fff2b367ccdc0e4bcffd">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=class%20UsersController%20%3C%20ApplicationController%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20def%20update%0A%20%20%20%20@user%20=%20User.find(params[:id])%0A%20%20%20%20if%20@user.update_attributes(params[:user])%0A%20%20%20%20%20%20flash[:success]%20=%20%22Profile%20updated.%22%0A%20%20%20%20%20%20redirect_to%20@user%0A%20%20%20%20else%0A%20%20%20%20%20%20@title%20=%20%22Edit%20user%22%0A%20%20%20%20%20%20render%20'edit'%0A%20%20%20%20end%0A%20%20end%0Aend%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=class%20UsersController%20%3C%20ApplicationController%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20def%20update%0A%20%20%20%20@user%20=%20User.find(params[:id])%0A%20%20%20%20if%20@user.update_attributes(params[:user])%0A%20%20%20%20%20%20flash[:success]%20=%20%22Profile%20updated.%22%0A%20%20%20%20%20%20redirect_to%20@user%0A%20%20%20%20else%0A%20%20%20%20%20%20@title%20=%20%22Edit%20user%22%0A%20%20%20%20%20%20render%20'edit'%0A%20%20%20%20end%0A%20%20end%0Aend%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">update</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">update_attributes</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">)</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Profile updated.&quot;</span>
      <span class="n">redirect_to</span> <span class="vi">@user</span>
    <span class="k">else</span>
      <span class="vi">@title</span> <span class="o">=</span> <span class="s2">&quot;Edit user&quot;</span>
      <span class="n">render</span> <span class="s1">&#39;edit&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>

<p>Avec cela, la page d'édition de l'utilisateur devrait fonctionner. Dans la forme actuelle, chaque édition demande à l'utilisateur de reconfirmer le mot de passe (comme requis par le champ de saisie vie dans l'<a class="ref" href="updating-showing-and-deleting-users#fig:edit_user_settings">Illustration&nbsp;10.3</a>), ce qui rend les actualisations plus sécurisées, mais reste quelque peu gênant.</p>

<div class="label" id="sec:protecting_pages"></div>


<h2><a id="sec:10.2" href="updating-showing-and-deleting-users#sec:protecting_pages" class="heading"><span class="number">10.2</span> Proctection des pages</a></h2>

<p>Bien que les actions edit (éditer) et update (actualiser) de la <a class="ref" href="updating-showing-and-deleting-users#sec:updating_users">Section&nbsp;10.1</a> soient fonctionnelles, elles souffrent d'un vice de sécurité ridicule&nbsp;: elles permettent à n'importe qui (même des utilisateurs non identifiés) d'accéder à ces actions, et n'importe quel utilisateur identifié peut modifier les informations de n'importe quel utilisateur. Dans cette section, nous allons implémenter un modèle de sécurité qui requiert des utilisateurs qu'ils soient identifiés et qui les empêchent d'actualiser d'autres informations que les leurs. Les utilisateurs qui ne sont pas identifiés ou qui tentent d'atteindre des pages protégées seront redirigés vers la page d'identification, avec un message d'aide, comme le montre la maquette de l'<a class="ref" href="updating-showing-and-deleting-users#fig:signin_page_protected_mockup">Illustration&nbsp;10.5</a>.</p>

<div class="label" id="fig:signin_page_protected_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/signin_page_protected_mockup.png" alt="signin_page_protected_mockup" /></span></div><div class="caption"><span class="header">Figure 10.5: </span><span class="description">Maquette du résultat de la tentative d'accès à une page protégée&nbsp;<a href="http://railstutorial.org/images/figures/signin_page_protected_mockup-full.png">(full size)</a></span></div></div>




<div class="label" id="sec:requiring_signed_in_users"></div>


<h3><a id="sec:10.2.1" href="updating-showing-and-deleting-users#sec:requiring_signed_in_users" class="heading"><span class="number">10.2.1</span> L'identification requise de l'utilisateur</a></h3>


<p>Puisque les restrictions de sécurité des actions <code>edit</code> et <code>update</code> sont identiques, nous les définirons dans un bloc RSpec<code>describe</code> unique. En commençant par vérifier que l'utilisateur est identifié, nos premiers tests vérifient qu'un utilisateur non identifié qui essaie d'utiliser de mauvaises actions soient simplement redirigé vers la page d'identification, comme nous pouvons le voir dans le <a class="ref" href="updating-showing-and-deleting-users#code:authentication_specs">Listing&nbsp;10.10</a>.</p>

<div class="label" id="code:authentication_specs"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.10.</span> <span class="description">Premiers tests d'authentification. <br /> <code>spec/controllers/users_controller_spec.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_6205f23fe17de15f78c25998634bc09ff90a42c8">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=describe%20UsersController%20do%0A%20%20render_views%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20describe%20%22authentication%20of%20edit/update%20pages%22%20do%0A%0A%20%20%20%20before(:each)%20do%0A%20%20%20%20%20%20@user%20=%20Factory(:user)%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20describe%20%22for%20non%2Dsigned%2Din%20users%22%20do%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20it%20%22should%20deny%20access%20to%20'edit'%22%20do%0A%20%20%20%20%20%20%20%20get%20:edit,%20:id%20=%3E%20@user%0A%20%20%20%20%20%20%20%20response.should%20redirect_to(signin_path)%0A%20%20%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20%20%20it%20%22should%20deny%20access%20to%20'update'%22%20do%0A%20%20%20%20%20%20%20%20put%20:update,%20:id%20=%3E%20@user,%20:user%20=%3E%20%7B%7D%0A%20%20%20%20%20%20%20%20response.should%20redirect_to(signin_path)%0A%20%20%20%20%20%20end%0A%20%20%20%20end%0A%20%20end%0Aend%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=describe%20UsersController%20do%0A%20%20render_views%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20describe%20%22authentication%20of%20edit/update%20pages%22%20do%0A%0A%20%20%20%20before(:each)%20do%0A%20%20%20%20%20%20@user%20=%20Factory(:user)%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20describe%20%22for%20non%2Dsigned%2Din%20users%22%20do%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20it%20%22should%20deny%20access%20to%20'edit'%22%20do%0A%20%20%20%20%20%20%20%20get%20:edit,%20:id%20=%3E%20@user%0A%20%20%20%20%20%20%20%20response.should%20redirect_to(signin_path)%0A%20%20%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20%20%20it%20%22should%20deny%20access%20to%20'update'%22%20do%0A%20%20%20%20%20%20%20%20put%20:update,%20:id%20=%3E%20@user,%20:user%20=%3E%20%7B%7D%0A%20%20%20%20%20%20%20%20response.should%20redirect_to(signin_path)%0A%20%20%20%20%20%20end%0A%20%20%20%20end%0A%20%20end%0Aend%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="no">UsersController</span> <span class="k">do</span>
  <span class="n">render_views</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;authentification des pages edit/update&quot;</span> <span class="k">do</span>

    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">&quot;pour un utilisteur non identifié&quot;</span> <span class="k">do</span>

      <span class="n">it</span> <span class="s2">&quot;devrait refuser l'acccès à l'action &#39;edit&#39;&quot;</span> <span class="k">do</span>
        <span class="n">get</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="vi">@user</span>
        <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">signin_path</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;devrait refuser l'accès à l'action &#39;update&#39;&quot;</span> <span class="k">do</span>
        <span class="n">put</span> <span class="ss">:update</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="p">{}</span>
        <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">signin_path</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>

<p>Le code de l'application permettra de réussir ces tests en utilisant un filtre “passe-avant” (<em>before filter</em>), qui permet d'appeler une méthode particulière avant d'appeler les actions données. Dans ce cas, nous définissons une méthode <code>authenticate</code> et nous l'invoquons en utilisant <code>before_filter :authenticate</code>, comme montré dans le <a class="ref" href="updating-showing-and-deleting-users#code:authenticate_before_filter">Listing&nbsp;10.11</a>.</p>

<div class="label" id="code:authenticate_before_filter"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.11.</span> <span class="description">Ajout d'un filtre “passe-avant” <code>authenticate</code>. <br /> <code>app/controllers/users_controller.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_d5fd8070eeea7dae71a20423271185277d6900d4">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=class%20UsersController%20%3C%20ApplicationController%0A%20%20before_filter%20:authenticate,%20:only%20=%3E%20[:edit,%20:update]%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20private%0A%20%20%20%20%0A%20%20%20%20def%20authenticate%0A%20%20%20%20%20%20deny_access%20unless%20signed_in?%0A%20%20%20%20end%0Aend%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=class%20UsersController%20%3C%20ApplicationController%0A%20%20before_filter%20:authenticate,%20:only%20=%3E%20[:edit,%20:update]%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20private%0A%20%20%20%20%0A%20%20%20%20def%20authenticate%0A%20%20%20%20%20%20deny_access%20unless%20signed_in?%0A%20%20%20%20end%0Aend%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:authenticate</span><span class="p">,</span> <span class="ss">:only</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">authenticate</span>
      <span class="n">deny_access</span> <span class="k">unless</span> <span class="n">signed_in?</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>

<p>Par défaut, les filtres “passe-avant” s'applique à <em>toute</em> action du contrôleur, donc ici nous restreignons l'effet du filtre aux actions <code>:edit</code> et <code>:update</code> en renseignant l'attribut  <code>:only</code> dans la table des options.</p>

<p>Ce code ne fonctionne pas encore, parce que la méthode <code>deny_access</code> (“refuser l'accès”) n'a pas été encore définie. Puisque le refus de l'accès est une partie de l'authentification, nous alons implémenter cette méthode dans l'<em>helper</em> du fichier Sessions du <a class="ref" href="sign-in-sign-out#top">Chapitre&nbsp;9</a>. Tout ce que fait  <code>deny_access</code>, c'est placer un message dans <code>flash[:notice]</code> et rediriger vers la page d'identification (<a class="ref" href="updating-showing-and-deleting-users#code:deny_access">Listing&nbsp;10.12</a>).</p>

<div class="label" id="code:deny_access"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.12.</span> <span class="description">La méthode <code>deny_access</code> pour l'authentification de l'utilisateur. <br /> <code>app/helpers/sessions_helper.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_785ea11194563a0c75b45386b329795870b38159">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=module%20SessionsHelper%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20def%20deny_access%0A%20%20%20%20redirect_to%20signin_path,%20:notice%20=%3E%20%22Please%20sign%20in%20to%20access%20this%20page.%22%0A%20%20end%0A%20%20.%0A%20%20.%0A%20%20.%0Aend%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=module%20SessionsHelper%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20def%20deny_access%0A%20%20%20%20redirect_to%20signin_path,%20:notice%20=%3E%20%22Please%20sign%20in%20to%20access%20this%20page.%22%0A%20%20end%0A%20%20.%0A%20%20.%0A%20%20.%0Aend%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">deny_access</span>
    <span class="n">redirect_to</span> <span class="n">signin_path</span><span class="p">,</span> <span class="ss">:notice</span> <span class="o">=&gt;</span> <span class="s2">&quot;Merci de vous identifier pour rejoindre cette page.&quot;</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Notez ici que le <a class="ref" href="updating-showing-and-deleting-users#code:deny_access">Listing&nbsp;10.12</a> utilise un raccourci d'écriture pour renseigner l'attribut <code>flash[:notice]</code> en passant une table “options” à la fonction  <em>redirect_to</em>. Le code dans le <a class="ref" href="updating-showing-and-deleting-users#code:deny_access">Listing&nbsp;10.12</a> est équivalent à celui plus verbeux&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="n">flash</span><span class="o">[</span><span class="ss">:notice</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Please sign in to access this page.&quot;</span>
<span class="n">redirect_to</span> <span class="n">signin_path</span>
</pre></div>
</div>


<p>(La même syntaxe fontion pour la clé <code>:error</code>, mais pas pour la clé <code>:success</code>.)</p>

<p>Associée à <code>:success</code> et <code>:error</code>, la clé <code>:notice</code> complète notre triumvirate des styles <code>flash</code>, tous supportés nativement par les feuilles de styles Blueprint CSS. En se déconnectant et en essayant d'atteindre la page d'édition de l'utilisateur <a href="http://localhost:3000/users/1/edit"><tt>/users/1/edit</tt></a>, nous pouvons voir s'afficher la boite jaune du message <code>"notice"</code>, comme dans l'<a class="ref" href="updating-showing-and-deleting-users#fig:protected_sign_in">Illustration&nbsp;10.6</a>.</p>

<div class="label" id="fig:protected_sign_in"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/protected_sign_in.png" alt="protected_sign_in" /></span></div><div class="caption"><span class="header">Illustration 10.6: </span><span class="description">Le formulaire d'identification après la tentative d'accès à une page protégée.&nbsp;<a href="http://railstutorial.org/images/figures/protected_sign_in-full.png">(taille normale)</a></span></div></div>




<div class="label" id="sec:requiring_the_right_user"></div>


<h3><a id="sec:10.2.2" href="updating-showing-and-deleting-users#sec:requiring_the_right_user" class="heading"><span class="number">10.2.2</span> Nécessité du bon utilisateur</a></h3>

<p>Bien entendu, qu'un utilisateur soit identifié n'est pas suffisant&nbsp;; les utilisateurs ne doivent être autorisés qu'à modifier leur <em>propres</em> informations suelement. Nous pouvons tester cela d'abord en identifiant un utilisateur incorrect puis en invoquant les actions <code>edit</code> et <code>update</code> (<a class="ref" href="updating-showing-and-deleting-users#code:authentication_for_signed_in">Listing&nbsp;10.13</a>). Notez que, puisque les utilisateurs ne devraient même pas <em>essayer</em> d'éditer le profil d'un autre utilisateur, nous ne les redirigerons pas vers la page d'identification mais vers l'accueil du site (l'url racine, root url).</p>

<div class="label" id="code:authentication_for_signed_in"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.13.</span> <span class="description">Test d'authentification pour les utilisateurs identifiés. <br /> <code>spec/controllers/users_controller_spec.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_2dd1135a874b7bc9b2dafd7cd48578c59fabb923">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=describe%20UsersController%20do%0A%20%20render_views%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20describe%20%22authentication%20of%20edit/update%20pages%22%20do%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20%20%20describe%20%22for%20signed%2Din%20users%22%20do%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20before(:each)%20do%0A%20%20%20%20%20%20%20%20wrong_user%20=%20Factory(:user,%20:email%20=%3E%20%22user@example.net%22)%0A%20%20%20%20%20%20%20%20test_sign_in(wrong_user)%0A%20%20%20%20%20%20end%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20it%20%22should%20require%20matching%20users%20for%20'edit'%22%20do%0A%20%20%20%20%20%20%20%20get%20:edit,%20:id%20=%3E%20@user%0A%20%20%20%20%20%20%20%20response.should%20redirect_to(root_path)%0A%20%20%20%20%20%20end%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20it%20%22should%20require%20matching%20users%20for%20'update'%22%20do%0A%20%20%20%20%20%20%20%20put%20:update,%20:id%20=%3E%20@user,%20:user%20=%3E%20%7B%7D%0A%20%20%20%20%20%20%20%20response.should%20redirect_to(root_path)%0A%20%20%20%20%20%20end%0A%20%20%20%20end%0A%20%20end%0Aend%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=describe%20UsersController%20do%0A%20%20render_views%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20describe%20%22authentication%20of%20edit/update%20pages%22%20do%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20%20%20describe%20%22for%20signed%2Din%20users%22%20do%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20before(:each)%20do%0A%20%20%20%20%20%20%20%20wrong_user%20=%20Factory(:user,%20:email%20=%3E%20%22user@example.net%22)%0A%20%20%20%20%20%20%20%20test_sign_in(wrong_user)%0A%20%20%20%20%20%20end%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20it%20%22should%20require%20matching%20users%20for%20'edit'%22%20do%0A%20%20%20%20%20%20%20%20get%20:edit,%20:id%20=%3E%20@user%0A%20%20%20%20%20%20%20%20response.should%20redirect_to(root_path)%0A%20%20%20%20%20%20end%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20it%20%22should%20require%20matching%20users%20for%20'update'%22%20do%0A%20%20%20%20%20%20%20%20put%20:update,%20:id%20=%3E%20@user,%20:user%20=%3E%20%7B%7D%0A%20%20%20%20%20%20%20%20response.should%20redirect_to(root_path)%0A%20%20%20%20%20%20end%0A%20%20%20%20end%0A%20%20end%0Aend%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="no">UsersController</span> <span class="k">do</span>
  <span class="n">render_views</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;authentification pour les pages edit/update&quot;</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;pour un utilisateur identifié&quot;</span> <span class="k">do</span>

      <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
        <span class="n">wrong_user</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:user</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;user@example.net&quot;</span><span class="p">)</span>
        <span class="n">test_sign_in</span><span class="p">(</span><span class="n">wrong_user</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;devrait correspondre à l'utilisateur à éditer&quot;</span> <span class="k">do</span>
        <span class="n">get</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="vi">@user</span>
        <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">root_path</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;devrait correspondre à l'utilisateur à actualiser&quot;</span> <span class="k">do</span>
        <span class="n">put</span> <span class="ss">:update</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="p">{}</span>
        <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">root_path</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>

<p>Le code de l'application est simple&nbsp;:nous ajoutons un second filtre “passe-avant” pour appeler la méthode <code>correct_user</code> (que nous devons encore écrire), comme montré dans le <a class="ref" href="updating-showing-and-deleting-users#code:correct_user_before_filter">Listing&nbsp;10.14</a>.</p>

<div class="label" id="code:correct_user_before_filter"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.14.</span> <span class="description">Un filtre “passe-avant” <code>correct_user</code> pour protéger les pages d'édition (edit) et d'actualisation (update). <br /> <code>app/controllers/users_controller.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_e81e642669fff1bf55f87433f52f7fb29eddfacf">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=class%20UsersController%20%3C%20ApplicationController%0A%20%20before_filter%20:authenticate,%20:only%20=%3E%20[:edit,%20:update]%0A%20%20before_filter%20:correct_user,%20:only%20=%3E%20[:edit,%20:update]%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20def%20edit%0A%20%20%20%20@title%20=%20%22Edit%20user%22%0A%20%20end%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20private%0A%20%20%20%20%0A%20%20%20%20def%20authenticate%0A%20%20%20%20%20%20deny_access%20unless%20signed_in?%0A%20%20%20%20end%0A%0A%20%20%20%20def%20correct_user%0A%20%20%20%20%20%20@user%20=%20User.find(params[:id])%0A%20%20%20%20%20%20redirect_to(root_path)%20unless%20current_user?(@user)%0A%20%20%20%20end%0Aend%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=class%20UsersController%20%3C%20ApplicationController%0A%20%20before_filter%20:authenticate,%20:only%20=%3E%20[:edit,%20:update]%0A%20%20before_filter%20:correct_user,%20:only%20=%3E%20[:edit,%20:update]%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20def%20edit%0A%20%20%20%20@title%20=%20%22Edit%20user%22%0A%20%20end%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20private%0A%20%20%20%20%0A%20%20%20%20def%20authenticate%0A%20%20%20%20%20%20deny_access%20unless%20signed_in?%0A%20%20%20%20end%0A%0A%20%20%20%20def%20correct_user%0A%20%20%20%20%20%20@user%20=%20User.find(params[:id])%0A%20%20%20%20%20%20redirect_to(root_path)%20unless%20current_user?(@user)%0A%20%20%20%20end%0Aend%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:authenticate</span><span class="p">,</span> <span class="ss">:only</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="n">before_filter</span> <span class="ss">:correct_user</span><span class="p">,</span> <span class="ss">:only</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">edit</span>
    <span class="vi">@title</span> <span class="o">=</span> <span class="s2">&quot;Edit user&quot;</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">authenticate</span>
      <span class="n">deny_access</span> <span class="k">unless</span> <span class="n">signed_in?</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">correct_user</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
      <span class="n">redirect_to</span><span class="p">(</span><span class="n">root_path</span><span class="p">)</span> <span class="k">unless</span> <span class="n">current_user?</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>

<p>Ce code utilise la méthode <code>current_user?</code>, que nous définissons (comme la méthode <code>deny_access</code>) dans l'<em>helper</em> Sessions (<a class="ref" href="updating-showing-and-deleting-users#code:current_user_p">Listing&nbsp;10.15</a>).</p>

<div class="label" id="code:current_user_p"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.15.</span> <span class="description">La méthode <code>current_user?</code>. <br /> <code>app/helpers/sessions_helper.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_d3ae31efd09eb4a4646761f14a84c5d4c4671541">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=module%20SessionsHelper%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20def%20current_user?(user)%0A%20%20%20%20user%20==%20current_user%0A%20%20end%0A%20%20%0A%20%20def%20deny_access%0A%20%20%20%20redirect_to%20signin_path,%20:notice%20=%3E%20%22Please%20sign%20in%20to%20access%20this%20page.%22%0A%20%20end%0A%20%20%0A%20%20private%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20%20%20.%0Aend%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=module%20SessionsHelper%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20def%20current_user?(user)%0A%20%20%20%20user%20==%20current_user%0A%20%20end%0A%20%20%0A%20%20def%20deny_access%0A%20%20%20%20redirect_to%20signin_path,%20:notice%20=%3E%20%22Please%20sign%20in%20to%20access%20this%20page.%22%0A%20%20end%0A%20%20%0A%20%20private%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20%20%20.%0Aend%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">current_user?</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">==</span> <span class="n">current_user</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">deny_access</span>
    <span class="n">redirect_to</span> <span class="n">signin_path</span><span class="p">,</span> <span class="ss">:notice</span> <span class="o">=&gt;</span> <span class="s2">&quot;Merci de vous identifier pour rejoindre cette page.&quot;</span>
  <span class="k">end</span>

  <span class="kp">private</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Le <a class="ref" href="updating-showing-and-deleting-users#code:correct_user_before_filter">Listing&nbsp;10.14</a> montre aussi l'actualisation de l'action <code>edit</code>. Auparavant, dans le <a class="ref" href="updating-showing-and-deleting-users#code:initial_edit_action">Listing&nbsp;10.2</a>, nous avions&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">edit</span>
  <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
  <span class="vi">@title</span> <span class="o">=</span> <span class="s2">&quot;Edit user&quot;</span>
<span class="k">end</span>
</pre></div>
</div>

<p>Mais maintenant que le filtre “passe-avant” <code>correct_user</code> définit la variable <code>@user</code> nous pouvons l'omettre dans l'action <code>edit</code> (et, de la même manière, dans l'action <code>update</code>).</p>

<div class="label" id="sec:friendly_forwarding"></div>


<h3><a id="sec:10.2.3" href="updating-showing-and-deleting-users#sec:friendly_forwarding" class="heading"><span class="number">10.2.3</span> Redirection conviviale</a></h3>

<p>Notre page de protection est complète, mais il demeure un défaut mineur&nbsp;: quand les utilisateurs tentent d'accéder à une page protégée, ils sont pour le moment redirigés à leur page de profil, sans considération pour la page qu'ils tentaient d'atteindre. En d'autres mots, si un utilisateur non identifié essaie de visiter sa page d'édition, après s'être identifié, il sera redirigé vers <tt>/users/1</tt> (l'affichage de son profil) au lieu de  <tt>/users/1/edit</tt> (sa page d'édition). Il serait plus convivial de les rediriger vers leur destination voulue.</p>

<p>La séquence de visite d'une certaine page —&nbsp;identification et redirection vers la page voulue&nbsp;— est le travail parfait pour un test d'intégration, donc élaborons-en un pour la redirection convivial&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate integration_test friendly_forwarding
</pre></div>
</div>

<p>Le code apparait alors comme dans le <a class="ref" href="updating-showing-and-deleting-users#code:friendly_forwarding_test">Listing&nbsp;10.16</a>.</p>

<div class="label" id="code:friendly_forwarding_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.16.</span> <span class="description">Test d'intégration pour la redirection conviviale. <br /> <code>spec/requests/friendly_forwardings_spec.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_0ad82445c7b64fc93ea9c9827ce829ecb8b088be">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=require%20'spec_helper'%0A%0Adescribe%20%22FriendlyForwardings%22%20do%0A%0A%20%20it%20%22should%20forward%20to%20the%20requested%20page%20after%20signin%22%20do%0A%20%20%20%20user%20=%20Factory(:user)%0A%20%20%20%20visit%20edit_user_path(user)%0A%20%20%20%20%23%20The%20test%20automatically%20follows%20the%20redirect%20to%20the%20signin%20page.%0A%20%20%20%20fill_in%20:email,%20%20%20%20:with%20=%3E%20user.email%0A%20%20%20%20fill_in%20:password,%20:with%20=%3E%20user.password%0A%20%20%20%20click_button%0A%20%20%20%20%23%20The%20test%20follows%20the%20redirect%20again,%20this%20time%20to%20users/edit.%0A%20%20%20%20response.should%20render_template('users/edit')%0A%20%20end%0Aend%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=require%20'spec_helper'%0A%0Adescribe%20%22FriendlyForwardings%22%20do%0A%0A%20%20it%20%22should%20forward%20to%20the%20requested%20page%20after%20signin%22%20do%0A%20%20%20%20user%20=%20Factory(:user)%0A%20%20%20%20visit%20edit_user_path(user)%0A%20%20%20%20%23%20The%20test%20automatically%20follows%20the%20redirect%20to%20the%20signin%20page.%0A%20%20%20%20fill_in%20:email,%20%20%20%20:with%20=%3E%20user.email%0A%20%20%20%20fill_in%20:password,%20:with%20=%3E%20user.password%0A%20%20%20%20click_button%0A%20%20%20%20%23%20The%20test%20follows%20the%20redirect%20again,%20this%20time%20to%20users/edit.%0A%20%20%20%20response.should%20render_template('users/edit')%0A%20%20end%0Aend%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;FriendlyForwardings&quot;</span> <span class="k">do</span>

  <span class="n">it</span> <span class="s2">&quot;devrait rediriger vers la page voulue après identification&quot;</span> <span class="k">do</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
    <span class="n">visit</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="c1"># Le test suit automatiquement la redirection vers la page d'identification.</span>
    <span class="n">fill_in</span> <span class="ss">:email</span><span class="p">,</span>    <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span>
    <span class="n">fill_in</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span>
    <span class="n">click_button</span>
    <span class="c1"># Le test suit à nouveau la redirection, cette fois vers users/edit.</span>
    <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;users/edit&#39;</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>(Comme indiqué dans les commentiares, le test d'intégration <em>suit</em> les redirections, donc tester que la réponse <code>devrait rediriger</code> (<code>should redirect_to</code>) vers telle ou telle URL ne fonctionnera pas. Je l'ai appris en en faisait l'expérience.)</p>

<p>Voyons maintenant l'implémentation.<sup class="footnote" id="fnref:10.5"><a href="#fn:10.5">5</a></sup> Dans le but de rediriger les utilisateurs vers leurs destination désirée, nous avons besoin de consigner quelque part leur destination, et de les rediriger vers cette destination ensuite. Le mécanisme de consignation est une des facilités proposées par Rails avec la <code>session</code>, qui peut être pensé un peu comme l'instance de variable  <code>cookie</code> de la <a class="ref" href="sign-in-sign-out#sec:remember_me">Section&nbsp;9.3.2</a> qui expire automatiquement quand le navigateur est refermé.<sup class="footnote" id="fnref:10.6"><a href="#fn:10.6">6</a></sup> Nous utilisons aussi l'objet  requête (<code>request</code>)  pour obtenir la <code>request_uri</code>, par exemple l'URL de la page requise. Le code d'application résultant est montré dans le <a class="ref" href="updating-showing-and-deleting-users#code:friendly_forwarding_code">Listing&nbsp;10.17</a>.</p>

<div class="label" id="code:friendly_forwarding_code"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.17.</span> <span class="description">Code pour implémenter la redirection conviviale. <br /> <code>app/helpers/sessions_helper.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_621444152476f18f3c78e8d92c36495609a7bd05">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=module%20SessionsHelper%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20def%20deny_access%0A%20%20%20%20store_location%0A%20%20%20%20redirect_to%20signin_path,%20:notice%20=%3E%20%22Please%20sign%20in%20to%20access%20this%20page.%22%0A%20%20end%0A%0A%20%20def%20redirect_back_or(default)%0A%20%20%20%20redirect_to(session[:return_to]%20%7C%7C%20default)%0A%20%20%20%20clear_return_to%0A%20%20end%0A%20%20%0A%20%20private%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20%20%20def%20store_location%0A%20%20%20%20%20%20session[:return_to]%20=%20request.fullpath%0A%20%20%20%20end%0A%0A%20%20%20%20def%20clear_return_to%0A%20%20%20%20%20%20session[:return_to]%20=%20nil%0A%20%20%20%20end%0Aend%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=module%20SessionsHelper%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20def%20deny_access%0A%20%20%20%20store_location%0A%20%20%20%20redirect_to%20signin_path,%20:notice%20=%3E%20%22Please%20sign%20in%20to%20access%20this%20page.%22%0A%20%20end%0A%0A%20%20def%20redirect_back_or(default)%0A%20%20%20%20redirect_to(session[:return_to]%20%7C%7C%20default)%0A%20%20%20%20clear_return_to%0A%20%20end%0A%20%20%0A%20%20private%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20%20%20def%20store_location%0A%20%20%20%20%20%20session[:return_to]%20=%20request.fullpath%0A%20%20%20%20end%0A%0A%20%20%20%20def%20clear_return_to%0A%20%20%20%20%20%20session[:return_to]%20=%20nil%0A%20%20%20%20end%0Aend%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">deny_access</span>
    <span class="n">store_location</span>
    <span class="n">redirect_to</span> <span class="n">signin_path</span><span class="p">,</span> <span class="ss">:notice</span> <span class="o">=&gt;</span> <span class="s2">&quot;Please sign in to access this page.&quot;</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">redirect_back_or</span><span class="p">(</span><span class="n">default</span><span class="p">)</span>
    <span class="n">redirect_to</span><span class="p">(</span><span class="n">session</span><span class="o">[</span><span class="ss">:return_to</span><span class="o">]</span> <span class="o">||</span> <span class="n">default</span><span class="p">)</span>
    <span class="n">clear_return_to</span>
  <span class="k">end</span>

  <span class="kp">private</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="k">def</span> <span class="nf">store_location</span>
      <span class="n">session</span><span class="o">[</span><span class="ss">:return_to</span><span class="o">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">fullpath</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">clear_return_to</span>
      <span class="n">session</span><span class="o">[</span><span class="ss">:return_to</span><span class="o">]</span> <span class="o">=</span> <span class="kp">nil</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>

<p>Ici nous avons ajouté une ligne à la méthode <code>deny_access</code>, d'abord pour ajouter le chemin complet de la requête avec la méthode <code>store_location</code> et procédant ensuite comme avant. La méthode  <code>store_location</code> place la requête URL dans la variable <code>session</code> avec pour clé <code>:return_to</code>. (Nous avons rendu les deux méthodes <code>store_location</code> et <code>clear_return_to</code> privées puisque elles ne sont jamais nécessaire en dehors de l'<em>helper</em> Sessions.)</p>

<p>Nous avons aussi défini la méthode <code>redirect_back_or</code> pour rediriger vers la requête URL si elle existe (si elle est définie), ou vers l'URL par défaut dans le cas contraire. Cette méthode est utilisé dans l'action <code>create</code> (“créer”) du contrôleur de Sessions pour procéder à la redirection en cas d'identification réussie (<a class="ref" href="updating-showing-and-deleting-users#code:friendly_session_create">Listing&nbsp;10.18</a>).</p>

<div class="label" id="code:friendly_session_create"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.18.</span> <span class="description">L'action <code>create</code> de Sessions avec une redirection conviviale. <br /> <code>app/controllers/sessions_controller.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_e10f897dbfebfdc3bd353fbb5d54a19913041b4a">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=class%20SessionsController%20%3C%20ApplicationController%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20def%20create%0A%20%20%20%20user%20=%20User.authenticate(params[:session][:email],%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20params[:session][:password])%0A%20%20%20%20if%20user.nil?%0A%20%20%20%20%20%20flash.now[:error]%20=%20%22Invalid%20email/password%20combination.%22%0A%20%20%20%20%20%20@title%20=%20%22Sign%20in%22%0A%20%20%20%20%20%20render%20'new'%0A%20%20%20%20else%0A%20%20%20%20%20%20sign_in%20user%0A%20%20%20%20%20%20redirect_back_or%20user%0A%20%20%20%20end%0A%20%20end%0A%20%20.%0A%20%20.%0A%20%20.%0Aend%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=class%20SessionsController%20%3C%20ApplicationController%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20def%20create%0A%20%20%20%20user%20=%20User.authenticate(params[:session][:email],%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20params[:session][:password])%0A%20%20%20%20if%20user.nil?%0A%20%20%20%20%20%20flash.now[:error]%20=%20%22Invalid%20email/password%20combination.%22%0A%20%20%20%20%20%20@title%20=%20%22Sign%20in%22%0A%20%20%20%20%20%20render%20'new'%0A%20%20%20%20else%0A%20%20%20%20%20%20sign_in%20user%0A%20%20%20%20%20%20redirect_back_or%20user%0A%20%20%20%20end%0A%20%20end%0A%20%20.%0A%20%20.%0A%20%20.%0Aend%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">]</span><span class="p">,</span>
                             <span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">nil?</span>
      <span class="n">flash</span><span class="o">.</span><span class="n">now</span><span class="o">[</span><span class="ss">:error</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Combinaison mail/mot de passe invalide.&quot;</span>
      <span class="vi">@title</span> <span class="o">=</span> <span class="s2">&quot;Sign in&quot;</span>
      <span class="n">render</span> <span class="s1">&#39;new&#39;</span>
    <span class="k">else</span>
      <span class="n">sign_in</span> <span class="n">user</span>
      <span class="n">redirect_back_or</span> <span class="n">user</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>

<p>Avec ça, le test d'intégration de la redirection conviviale dans le <a class="ref" href="updating-showing-and-deleting-users#code:friendly_forwarding_test">Listing&nbsp;10.16</a> devrait réussir, et l'implémentation de l'authentification basique de l'utilisateur et de la protection de page est achevée.</p>

<div class="label" id="sec:showing_users"></div>


<h2><a id="sec:10.3" href="updating-showing-and-deleting-users#sec:showing_users" class="heading"><span class="number">10.3</span> Affichage des utilisateurs</a></h2>


<p>Dans cette section nous allons ajouter la dernière action utilistaeur, l'action <code>index</code> destinée à afficher <em>tous</em> les utilisateurs, pas seulement un. Chemin faisant, nous apprendrons à peupler une base de données avec des exemples d'utilisateurs et à paginger (<em>paginating</em>) la sortie pour l'utilisateur, pour que la page puisse s'adapter à l'affichage éventuel d'un très grand nombre d'utilisateurs. Une maquette du résultat &mdash;utilisateurs, liens de paginations, et un lien de navigation &ldquo;Utilisateurs&rdquo; &mdash;est montré dans l'<a class="ref" href="updating-showing-and-deleting-users#fig:user_index_mockup">Illustration&nbsp;10.7</a>.<sup class="footnote" id="fnref:10.7"><a href="#fn:10.7">7</a></sup> Dans la <a class="ref" href="updating-showing-and-deleting-users#sec:destroying_users">Section&nbsp;10.4</a>, nous ajouterons une interface administrateur à l'index de l'utilisateur pour empêcher les utilisateurs d'être détruits (ce qui peut être problématique).</p>

<div class="label" id="fig:user_index_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_index_mockup.png" alt="user_index_mockup" /></span></div><div class="caption"><span class="header">Illustration 10.7: </span><span class="description">Maquette du listing de l'utilisateur, avec pagination et lien de navigation &ldquo;Utilisateurs&rdquo;.&nbsp;<a href="http://railstutorial.org/images/figures/user_index_mockup-full.png">(taille normale)</a></span></div></div>




<div class="label" id="sec:user_index"></div>


<h3><a id="sec:10.3.1" href="updating-showing-and-deleting-users#sec:user_index" class="heading"><span class="number">10.3.1</span> Index utilisateur</a></h3>


<p>Bien que nous gardions visible la page d'affichage d'un utilisateur à tout visiteur du site, l'index visiteur (la liste de tous les utilisateurs) sera réservée au utilisateurs identifiés, [de telle sorte qu'il y a une limite sur combien d'utilisateurs non identifiés peuvent voir par défaut][so that there&rsquo;s a limit to how much unregistered users can see by default]. Nos tests d'<code>index</code> le vérifieront, et vérifieront aussi que tous les utilisateurs soient listés pour un utilisateur identifié (<a class="ref" href="updating-showing-and-deleting-users#code:user_index_tests">Listing&nbsp;10.19</a>).</p>

<div class="label" id="code:user_index_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.19.</span> <span class="description">Test pour la page d'index utilisateur. <br /> <code>spec/controllers/users_controller_spec.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_dca69d352153b53274e8718876ce34b984829cb3">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=require%20'spec_helper'%0A%0Adescribe%20UsersController%20do%0A%20%20render_views%0A%0A%20%20describe%20%22GET%20'index'%22%20do%0A%0A%20%20%20%20describe%20%22for%20non%2Dsigned%2Din%20users%22%20do%0A%20%20%20%20%20%20it%20%22should%20deny%20access%22%20do%0A%20%20%20%20%20%20%20%20get%20:index%0A%20%20%20%20%20%20%20%20response.should%20redirect_to(signin_path)%0A%20%20%20%20%20%20%20%20flash[:notice].should%20=~%20/sign%20in/i%0A%20%20%20%20%20%20end%0A%20%20%20%20end%0A%0A%20%20%20%20describe%20%22for%20signed%2Din%20users%22%20do%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20before(:each)%20do%0A%20%20%20%20%20%20%20%20@user%20=%20test_sign_in(Factory(:user))%0A%20%20%20%20%20%20%20%20second%20=%20Factory(:user,%20:email%20=%3E%20%22another@example.com%22)%0A%20%20%20%20%20%20%20%20third%20%20=%20Factory(:user,%20:email%20=%3E%20%22another@example.net%22)%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20@users%20=%20[@user,%20second,%20third]%0A%20%20%20%20%20%20end%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20it%20%22should%20be%20successful%22%20do%0A%20%20%20%20%20%20%20%20get%20:index%0A%20%20%20%20%20%20%20%20response.should%20be_success%0A%20%20%20%20%20%20end%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20it%20%22should%20have%20the%20right%20title%22%20do%0A%20%20%20%20%20%20%20%20get%20:index%0A%20%20%20%20%20%20%20%20response.should%20have_selector(%22title%22,%20:content%20=%3E%20%22All%20users%22)%0A%20%20%20%20%20%20end%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20it%20%22should%20have%20an%20element%20for%20each%20user%22%20do%0A%20%20%20%20%20%20%20%20get%20:index%0A%20%20%20%20%20%20%20%20@users.each%20do%20%7Cuser%7C%0A%20%20%20%20%20%20%20%20%20%20response.should%20have_selector(%22li%22,%20:content%20=%3E%20user.name)%0A%20%20%20%20%20%20%20%20end%0A%20%20%20%20%20%20end%0A%20%20%20%20end%0A%20%20end%0A%20%20.%0A%20%20.%0A%20%20.%0Aend%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=require%20'spec_helper'%0A%0Adescribe%20UsersController%20do%0A%20%20render_views%0A%0A%20%20describe%20%22GET%20'index'%22%20do%0A%0A%20%20%20%20describe%20%22for%20non%2Dsigned%2Din%20users%22%20do%0A%20%20%20%20%20%20it%20%22should%20deny%20access%22%20do%0A%20%20%20%20%20%20%20%20get%20:index%0A%20%20%20%20%20%20%20%20response.should%20redirect_to(signin_path)%0A%20%20%20%20%20%20%20%20flash[:notice].should%20=~%20/sign%20in/i%0A%20%20%20%20%20%20end%0A%20%20%20%20end%0A%0A%20%20%20%20describe%20%22for%20signed%2Din%20users%22%20do%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20before(:each)%20do%0A%20%20%20%20%20%20%20%20@user%20=%20test_sign_in(Factory(:user))%0A%20%20%20%20%20%20%20%20second%20=%20Factory(:user,%20:email%20=%3E%20%22another@example.com%22)%0A%20%20%20%20%20%20%20%20third%20%20=%20Factory(:user,%20:email%20=%3E%20%22another@example.net%22)%0A%20%20%20%20%20%20%20%20%0A%20%20%20%20%20%20%20%20@users%20=%20[@user,%20second,%20third]%0A%20%20%20%20%20%20end%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20it%20%22should%20be%20successful%22%20do%0A%20%20%20%20%20%20%20%20get%20:index%0A%20%20%20%20%20%20%20%20response.should%20be_success%0A%20%20%20%20%20%20end%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20it%20%22should%20have%20the%20right%20title%22%20do%0A%20%20%20%20%20%20%20%20get%20:index%0A%20%20%20%20%20%20%20%20response.should%20have_selector(%22title%22,%20:content%20=%3E%20%22All%20users%22)%0A%20%20%20%20%20%20end%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20it%20%22should%20have%20an%20element%20for%20each%20user%22%20do%0A%20%20%20%20%20%20%20%20get%20:index%0A%20%20%20%20%20%20%20%20@users.each%20do%20%7Cuser%7C%0A%20%20%20%20%20%20%20%20%20%20response.should%20have_selector(%22li%22,%20:content%20=%3E%20user.name)%0A%20%20%20%20%20%20%20%20end%0A%20%20%20%20%20%20end%0A%20%20%20%20end%0A%20%20end%0A%20%20.%0A%20%20.%0A%20%20.%0Aend%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">UsersController</span> <span class="k">do</span>
  <span class="n">render_views</span>

  <span class="n">describe</span> <span class="s2">&quot;GET &#39;index&#39;&quot;</span> <span class="k">do</span>

    <span class="n">describe</span> <span class="s2">&quot;pour utilisateur non identifiés&quot;</span> <span class="k">do</span>
      <span class="n">it</span> <span class="s2">&quot;devrait refuser l'accès&quot;</span> <span class="k">do</span>
        <span class="n">get</span> <span class="ss">:index</span>
        <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">signin_path</span><span class="p">)</span>
        <span class="n">flash</span><span class="o">[</span><span class="ss">:notice</span><span class="o">].</span><span class="n">should</span> <span class="o">=~</span> <span class="sr">/sign in/i</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">&quot;pour utilisateurs identifiés&quot;</span> <span class="k">do</span>

      <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
        <span class="vi">@user</span> <span class="o">=</span> <span class="n">test_sign_in</span><span class="p">(</span><span class="no">Factory</span><span class="p">(</span><span class="ss">:user</span><span class="p">))</span>
        <span class="n">second</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:user</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;another@example.com&quot;</span><span class="p">)</span>
        <span class="n">third</span>  <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:user</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;another@example.net&quot;</span><span class="p">)</span>

        <span class="vi">@users</span> <span class="o">=</span> <span class="o">[</span><span class="vi">@user</span><span class="p">,</span> <span class="n">second</span><span class="p">,</span> <span class="n">third</span><span class="o">]</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;devrait réussir&quot;</span> <span class="k">do</span>
        <span class="n">get</span> <span class="ss">:index</span>
        <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">be_success</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;devrait avoir le bon titre&quot;</span> <span class="k">do</span>
        <span class="n">get</span> <span class="ss">:index</span>
        <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="s2">&quot;Tous les utilisateurs&quot;</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;devrait avoir un élément pour chaque utilisateur&quot;</span> <span class="k">do</span>
        <span class="n">get</span> <span class="ss">:index</span>
        <span class="vi">@users</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
          <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;li&quot;</span><span class="p">,</span> <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>

<p>Comme vous pouvez le voir, la méthode pour vérifier la page d'index consiste à créer trois utilisateurs d'usine (identifié pour le premier) et vérifier alors que la page d'index a un élément de liste (balise <code>li</code>) pour le nom de chacun d'eux.</p>

<p>Comme vous pouvez l'imaginer, le code de l'application utilise <code>User.all</code> pour faire une variable d'instance <code>@users</code> dans l'action <code>index</code> du contrôleur Users (<a class="ref" href="updating-showing-and-deleting-users#code:user_index">Listing&nbsp;10.20</a>).</p>

<div class="label" id="code:user_index"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.20.</span> <span class="description">L'action <code>index</code> de l'utilisateur. <br /> <code>app/controllers/users_controller.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_bd3d535c686e45c053f891ace3706775780b9549">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=class%20UsersController%20%3C%20ApplicationController%0A%20%20before_filter%20:authenticate,%20:only%20=%3E%20[:index,%20:edit,%20:update]%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20def%20index%0A%20%20%20%20@title%20=%20%22All%20users%22%0A%20%20%20%20@users%20=%20User.all%0A%20%20end%0A%0A%20%20def%20show%0A%20%20%20%20@user%20=%20User.find(params[:id])%0A%20%20%20%20@title%20=%20@user.name%0A%20%20end%0A%20%20.%0A%20%20.%0A%20%20.%0Aend%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=class%20UsersController%20%3C%20ApplicationController%0A%20%20before_filter%20:authenticate,%20:only%20=%3E%20[:index,%20:edit,%20:update]%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20def%20index%0A%20%20%20%20@title%20=%20%22All%20users%22%0A%20%20%20%20@users%20=%20User.all%0A%20%20end%0A%0A%20%20def%20show%0A%20%20%20%20@user%20=%20User.find(params[:id])%0A%20%20%20%20@title%20=%20@user.name%0A%20%20end%0A%20%20.%0A%20%20.%0A%20%20.%0Aend%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:authenticate</span><span class="p">,</span> <span class="ss">:only</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:index</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@title</span> <span class="o">=</span> <span class="s2">&quot;All users&quot;</span>
    <span class="vi">@users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">all</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">show</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
    <span class="vi">@title</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>

<p>Notez que nous avons ajouté <code>:index</code> à la liste des contrôleurs protégés par le filtre “passe-avant” <code>authenticate</code>, ce faisant on obtient la réussite du premier test de <a class="ref" href="updating-showing-and-deleting-users#code:user_index_tests">Listing&nbsp;10.19</a>.</p>

<p>Pour faire la page voulue, nous avons besoin de faire une vue qui fait une itération sur les utilisateurs et entoure chacun d'eux d'une balise&nbsp;<code>li</code>. Nous faisons cela avec la méthode <code>each</code> (“chaque”), en affichant chaque nom et gravatar d'utilisateur, entourant l'ensemble dans une balise de liste non ordonnée (<code>ul</code>) (<a class="ref" href="updating-showing-and-deleting-users#code:user_index_view">Listing&nbsp;10.21</a>).</p>

<div class="label" id="code:user_index_view"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.21.</span> <span class="description">La vue de l'index utilisateur. <br /> <code>app/views/users/index.html.erb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_83362b5b5def90a5cd2590ae3010aa4d226b5d35">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=%3Ch1%3EAll%20users%3C/h1%3E%0A%0A%3Cul%20class=%22users%22%3E%0A%20%20%3C%25%20@users.each%20do%20%7Cuser%7C%20%25%3E%0A%20%20%20%20%3Cli%3E%0A%20%20%20%20%20%20%3C%25=%20gravatar_for%20user,%20:size%20=%3E%2030%20%25%3E%0A%20%20%20%20%20%20%3C%25=%20link_to%20user.name,%20user%20%25%3E%0A%20%20%20%20%3C/li%3E%0A%20%20%3C%25%20end%20%25%3E%0A%3C/ul%3E%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=%3Ch1%3EAll%20users%3C/h1%3E%0A%0A%3Cul%20class=%22users%22%3E%0A%20%20%3C%25%20@users.each%20do%20%7Cuser%7C%20%25%3E%0A%20%20%20%20%3Cli%3E%0A%20%20%20%20%20%20%3C%25=%20gravatar_for%20user,%20:size%20=%3E%2030%20%25%3E%0A%20%20%20%20%20%20%3C%25=%20link_to%20user.name,%20user%20%25%3E%0A%20%20%20%20%3C/li%3E%0A%20%20%3C%25%20end%20%25%3E%0A%3C/ul%3E%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>Tous les utilisateurs<span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;users&quot;</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%</span> <span class="vi">@users</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;li&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="n">user</span><span class="p">,</span> <span class="ss">:size</span> <span class="o">=&gt;</span> <span class="mi">30</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/li&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/ul&gt;</span>
</pre></div>
</div></div>

<p>Nous ajoutons alors un peu de CSS pour le style (<a class="ref" href="updating-showing-and-deleting-users#code:user_index_css">Listing&nbsp;10.22</a>).</p>

<div class="label" id="code:user_index_css"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.22.</span> <span class="description">CSS pour l'index utilisateur. <br /> <code>public/stylesheets/custom.css</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_fef53c485ef7f31aa7aa0a34506a995b0ed5e74d">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=.%0A.%0A.%0Aul.users%20%7B%0A%20%20margin%2Dtop:%201em;%0A%7D%0A%0A.users%20li%20%7B%0A%20%20list%2Dstyle:%20none;%0A%7D%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=.%0A.%0A.%0Aul.users%20%7B%0A%20%20margin%2Dtop:%201em;%0A%7D%0A%0A.users%20li%20%7B%0A%20%20list%2Dstyle:%20none;%0A%7D%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="nt">ul</span><span class="nc">.users</span> <span class="p">{</span>
  <span class="k">margin-top</span><span class="o">:</span> <span class="m">1em</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.users</span> <span class="nt">li</span> <span class="p">{</span>
  <span class="k">list-style</span><span class="o">:</span> <span class="k">none</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div></div>

<p>Enfin, nous ajouterons le liens &ldquo;Utilisateurs&rdquo; à l'entête de navigation du site (<a class="ref" href="updating-showing-and-deleting-users#code:users_link">Listing&nbsp;10.23</a>). Cela introduit l'utilisation du nom de route <code>users_path</code> (“chemins aux utilisateurs”) de la <a class="ref" href="modeling-and-viewing-users-one#table:RESTful_users">Table&nbsp;6.2</a>.</p>

<div class="label" id="code:users_link"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.23.</span> <span class="description">Un lien à l'index utilisateur. <br /> <code>app/views/layouts/_header.html.erb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_5c69e226e14c7cdd297bf845974592bd15540c2f">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=%3Cheader%3E%0A%20%20%3C%25=%20link_to%20logo,%20root_path%20%25%3E%0A%20%20%3Cnav%20class=%22round%22%3E%0A%20%20%20%20%3Cul%3E%0A%20%20%20%20%20%20%3Cli%3E%3C%25=%20link_to%20%22Home%22,%20root_path%20%25%3E%3C/li%3E%0A%20%20%20%20%20%20%3C%25%20if%20signed_in?%20%25%3E%0A%20%20%20%20%20%20%3Cli%3E%3C%25=%20link_to%20%22Users%22,%20users_path%20%25%3E%3C/li%3E%0A%20%20%20%20%20%20%3Cli%3E%3C%25=%20link_to%20%22Profile%22,%20current_user%20%25%3E%3C/li%3E%0A%20%20%20%20%20%20%3Cli%3E%3C%25=%20link_to%20%22Settings%22,%20edit_user_path(current_user)%20%25%3E%3C/li%3E%0A%20%20%20%20%20%20%3C%25%20end%20%25%3E%0A%20%20%20%20%20%20.%0A%20%20%20%20%20%20.%0A%20%20%20%20%20%20.%0A%20%20%20%20%3C/ul%3E%0A%20%20%3C/nav%3E%0A%3C/header%3E%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=%3Cheader%3E%0A%20%20%3C%25=%20link_to%20logo,%20root_path%20%25%3E%0A%20%20%3Cnav%20class=%22round%22%3E%0A%20%20%20%20%3Cul%3E%0A%20%20%20%20%20%20%3Cli%3E%3C%25=%20link_to%20%22Home%22,%20root_path%20%25%3E%3C/li%3E%0A%20%20%20%20%20%20%3C%25%20if%20signed_in?%20%25%3E%0A%20%20%20%20%20%20%3Cli%3E%3C%25=%20link_to%20%22Users%22,%20users_path%20%25%3E%3C/li%3E%0A%20%20%20%20%20%20%3Cli%3E%3C%25=%20link_to%20%22Profile%22,%20current_user%20%25%3E%3C/li%3E%0A%20%20%20%20%20%20%3Cli%3E%3C%25=%20link_to%20%22Settings%22,%20edit_user_path(current_user)%20%25%3E%3C/li%3E%0A%20%20%20%20%20%20%3C%25%20end%20%25%3E%0A%20%20%20%20%20%20.%0A%20%20%20%20%20%20.%0A%20%20%20%20%20%20.%0A%20%20%20%20%3C/ul%3E%0A%20%20%3C/nav%3E%0A%3C/header%3E%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;header&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">logo</span><span class="p">,</span> <span class="n">root_path</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;nav</span> <span class="na">class=</span><span class="s">&quot;round&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;ul&gt;</span>
      <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Home&quot;</span><span class="p">,</span> <span class="n">root_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">signed_in?</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Users&quot;</span><span class="p">,</span> <span class="n">users_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
      <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Profile&quot;</span><span class="p">,</span> <span class="n">current_user</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
      <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Settings&quot;</span><span class="p">,</span> <span class="n">edit_user_path</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
      .
      .
      .
    <span class="nt">&lt;/ul&gt;</span>
  <span class="nt">&lt;/nav&gt;</span>
<span class="nt">&lt;/header&gt;</span>
</pre></div>
</div></div>

<p>Avec ça, l'index utilisateur est totalement fonctionnel (avec la réussite de tous les tests), mais on se sent un peu solitaire… (<a class="ref" href="updating-showing-and-deleting-users#fig:user_index_only_one">Illustration&nbsp;10.8</a>).</p>

<div class="label" id="fig:user_index_only_one"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_index_only_one.png" alt="user_index_only_one" /></span></div><div class="caption"><span class="header">Illustration 10.8: </span><span class="description">La page d'index utilisateur <a href="http://localhost:3000/users"><tt>/users</tt></a> avec un seul utilisateur.&nbsp;<a href="http://railstutorial.org/images/figures/user_index_only_one-full.png">(taille normale)</a></span></div></div>




<div class="label" id="sec:sample_users"></div>


<h3><a id="sec:10.3.2" href="updating-showing-and-deleting-users#sec:sample_users" class="heading"><span class="number">10.3.2</span> Utilisateurs fictifs</a></h3>

<p>Dans cette section, nous allons donner de la compagnie à notre exemple d'utilisateur solitaire. Bien sûr, pour créer suffisamment d'utilisateurs pour un index décent, nous <em>pourrions</em> utiliser notre navigateur pour rejoindre la page d'inscription et entrer les utilisateurs un par un. Mais une bien meilleure solution consiste à demander à Ruby (et Rake) de les entrer pour nous.</p>

<p>D'abord, nous allons ajouter le gem Faker à notre <code>Gemfile</code>, ce qui nous permettra de créer des exemples d'utilisateurs avec noms et des adresses-mails semi-réalistes (<a class="ref" href="updating-showing-and-deleting-users#code:faker_gemfile">Listing&nbsp;10.24</a>).</p>

<div class="label" id="code:faker_gemfile"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.24.</span> <span class="description">Ajout du gem Faker au <code>Gemfile</code>.</span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_9135d410642f6c3f9b231b1da7092706c5d1f700">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=source%20'http://rubygems.org'%0A.%0A.%0A.%0Agroup%20:development%20do%0A%20%20gem%20'rspec%2Drails',%20'2.5.0'%0A%20%20gem%20'annotate%2Dmodels',%20'1.0.4'%0A%20%20gem%20'faker',%20'0.3.1'%0Aend%0A.%0A.%0A.%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=source%20'http://rubygems.org'%0A.%0A.%0A.%0Agroup%20:development%20do%0A%20%20gem%20'rspec%2Drails',%20'2.5.0'%0A%20%20gem%20'annotate%2Dmodels',%20'1.0.4'%0A%20%20gem%20'faker',%20'0.3.1'%0Aend%0A.%0A.%0A.%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">&#39;http://rubygems.org&#39;</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="n">group</span> <span class="ss">:development</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;rspec-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;2.5.0&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;annotate-models&#39;</span><span class="p">,</span> <span class="s1">&#39;1.0.4&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;faker&#39;</span><span class="p">,</span> <span class="s1">&#39;0.3.1&#39;</span>
<span class="k">end</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
</pre></div>
</div></div>


<p>Installer alors comme d'habitude&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle install
</pre></div>
</div>


<p>Ensuite, nous allons ajouter un tâche Rake (“Rake task”) pour créer les utilisateurs fictifs. Les tâches Rake sont consignées dans le dossier <code>lib/tasks</code>, et sont définis en utilisant des <em>espace de noms</em> (<em>namespaces</em>) (dans notre cas, <code>:db</code>), comme on peut le voir dans le <a class="ref" href="updating-showing-and-deleting-users#code:db_populate">Listing&nbsp;10.25</a>.</p>

<div class="label" id="code:db_populate"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.25.</span> <span class="description">Une tâche Rake pour peupler la base de données avec des utilisateurs fictifs. <br /> <code>lib/tasks/sample_data.rake</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_9144995e5a900c92ac9f4c2918d272efed71dd55">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=require%20'faker'%0A%0Anamespace%20:db%20do%0A%20%20desc%20%22Fill%20database%20with%20sample%20data%22%0A%20%20task%20:populate%20=%3E%20:environment%20do%0A%20%20%20%20Rake::Task['db:reset'].invoke%0A%20%20%20%20User.create!(:name%20=%3E%20%22Example%20User%22,%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:email%20=%3E%20%22example@railstutorial.org%22,%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:password%20=%3E%20%22foobar%22,%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:password_confirmation%20=%3E%20%22foobar%22)%0A%20%20%20%2099.times%20do%20%7Cn%7C%0A%20%20%20%20%20%20name%20%20=%20Faker::Name.name%0A%20%20%20%20%20%20email%20=%20%22example%2D%23%7Bn%2B1%7D@railstutorial.org%22%0A%20%20%20%20%20%20password%20%20=%20%22password%22%0A%20%20%20%20%20%20User.create!(:name%20=%3E%20name,%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:email%20=%3E%20email,%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:password%20=%3E%20password,%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:password_confirmation%20=%3E%20password)%0A%20%20%20%20end%0A%20%20end%0Aend%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=require%20'faker'%0A%0Anamespace%20:db%20do%0A%20%20desc%20%22Fill%20database%20with%20sample%20data%22%0A%20%20task%20:populate%20=%3E%20:environment%20do%0A%20%20%20%20Rake::Task['db:reset'].invoke%0A%20%20%20%20User.create!(:name%20=%3E%20%22Example%20User%22,%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:email%20=%3E%20%22example@railstutorial.org%22,%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:password%20=%3E%20%22foobar%22,%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:password_confirmation%20=%3E%20%22foobar%22)%0A%20%20%20%2099.times%20do%20%7Cn%7C%0A%20%20%20%20%20%20name%20%20=%20Faker::Name.name%0A%20%20%20%20%20%20email%20=%20%22example%2D%23%7Bn%2B1%7D@railstutorial.org%22%0A%20%20%20%20%20%20password%20%20=%20%22password%22%0A%20%20%20%20%20%20User.create!(:name%20=%3E%20name,%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:email%20=%3E%20email,%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:password%20=%3E%20password,%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:password_confirmation%20=%3E%20password)%0A%20%20%20%20end%0A%20%20end%0Aend%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;faker&#39;</span>

<span class="n">namespace</span> <span class="ss">:db</span> <span class="k">do</span>
  <span class="n">desc</span> <span class="s2">&quot;Fill database with sample data&quot;</span>
  <span class="n">task</span> <span class="ss">:populate</span> <span class="o">=&gt;</span> <span class="ss">:environment</span> <span class="k">do</span>
    <span class="no">Rake</span><span class="o">::</span><span class="no">Task</span><span class="o">[</span><span class="s1">&#39;db:reset&#39;</span><span class="o">].</span><span class="n">invoke</span>
    <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span>
                 <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;example@railstutorial.org&quot;</span><span class="p">,</span>
                 <span class="ss">:password</span> <span class="o">=&gt;</span> <span class="s2">&quot;foobar&quot;</span><span class="p">,</span>
                 <span class="ss">:password_confirmation</span> <span class="o">=&gt;</span> <span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
    <span class="mi">99</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span>
      <span class="nb">name</span>  <span class="o">=</span> <span class="no">Faker</span><span class="o">::</span><span class="no">Name</span><span class="o">.</span><span class="n">name</span>
      <span class="n">email</span> <span class="o">=</span> <span class="s2">&quot;example-</span><span class="si">#{</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">@railstutorial.org&quot;</span>
      <span class="n">password</span>  <span class="o">=</span> <span class="s2">&quot;password&quot;</span>
      <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="nb">name</span><span class="p">,</span>
                   <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="n">email</span><span class="p">,</span>
                   <span class="ss">:password</span> <span class="o">=&gt;</span> <span class="n">password</span><span class="p">,</span>
                   <span class="ss">:password_confirmation</span> <span class="o">=&gt;</span> <span class="n">password</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Cela définit une tâche <code>db:populate</code> qui initialise la base de données de développement en utilisant <code>db:reset</code> (ne vous souciez  pas trop de la syntaxe quelque peu bizarre), qui crée un utilisateur fictif avec un nom et une adresse mail en faisant une réplique de notre précédent utilisateur, et 99 de plus ensuite. La ligne&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="n">task</span> <span class="ss">:populate</span> <span class="o">=&gt;</span> <span class="ss">:environment</span> <span class="k">do</span>
</pre></div>
</div>


<p>… assure que la tâche Rake task a accès à l'environnement Rails local, pour inclure le modèle User (et ainsi la méthode <code>User.create!</code>).</p>

<p>Avec le domaine de nom <code>:db</code> comme dans le <a class="ref" href="updating-showing-and-deleting-users#code:db_populate">Listing&nbsp;10.25</a>, on peut invoquer la tâche Rake comme suit&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rake db:populate
</pre></div>
</div>

<p>Après avoir joué la tâche Rake, notre application possède 100 utilisateurs fictifs, comme on peut le ovir dans l'<a class="ref" href="updating-showing-and-deleting-users#fig:user_index_all">Illustration&nbsp;10.9</a>. (J'ai pris la liberté d'associer les premières adresses à des photos pour que les utilisateurs n'aient pas tous le même gravatar par défaut.)</p>

<div class="label" id="fig:user_index_all"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_index_all.png" alt="user_index_all" /></span></div><div class="caption"><span class="header">Illustration 10.9: </span><span class="description">La page d'index utilisateur <a href="http://localhost:3000/users"><tt>/users</tt></a> avec 100 utilisateurs fictifs.&nbsp;<a href="http://railstutorial.org/images/figures/user_index_all-full.png">(taille normale)</a></span></div></div>




<div class="label" id="sec:pagination"></div>


<h3><a id="sec:10.3.3" href="updating-showing-and-deleting-users#sec:pagination" class="heading"><span class="number">10.3.3</span> Pagination</a></h3>

<p>Ayant résolu le problème d'avoir trop peu d'utilisateurs, nous nous confrontons maintenant au problème d'en avoir trop sur la même page. Maintenant, il y en a une centaine, ce qui représente un nombre raisonnablement important, et un site réel peut en compter des milliers. La solution est de <em>paginer</em> les utilisateurs, pour que (par exemple), seulement 30 s'affichent par page à n'importe quel moment.</p>

<p>Il existe plusieurs méthodes de paginaiton dans Rails&nbsp;; nous en utiliserons une des plus simples et des plus robustes, appelée <a href="http://wiki.github.com/mislav/will_paginate/"><tt>will_paginate</tt></a>. Pour l'utiliser, nous avons besoin d'actualiser le fichier <code>Gemfile</code> comme d'habitude (<a class="ref" href="updating-showing-and-deleting-users#code:will_paginate_gem">Listing&nbsp;10.26</a>).</p>

<div class="label" id="code:will_paginate_gem"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.26.</span> <span class="description">Inclusion de <tt>will_paginate</tt> dans le fichier Gemfile.</span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_1d22ab64a9a0fc0c3e2a183befa0998e0169f2c5">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=source%20'http://rubygems.org'%0A%0Agem%20'rails',%20'3.0.4'%0Agem%20'sqlite3%2Druby',%20'1.3.2',%20:require%20=%3E%20'sqlite3'%0Agem%20'gravatar_image_tag',%20'1.0.0.pre2'%0Agem%20'will_paginate',%20'3.0.pre2'%0A.%0A.%0A.%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=source%20'http://rubygems.org'%0A%0Agem%20'rails',%20'3.0.4'%0Agem%20'sqlite3%2Druby',%20'1.3.2',%20:require%20=%3E%20'sqlite3'%0Agem%20'gravatar_image_tag',%20'1.0.0.pre2'%0Agem%20'will_paginate',%20'3.0.pre2'%0A.%0A.%0A.%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">&#39;http://rubygems.org&#39;</span>

<span class="n">gem</span> <span class="s1">&#39;rails&#39;</span><span class="p">,</span> <span class="s1">&#39;3.0.4&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;sqlite3-ruby&#39;</span><span class="p">,</span> <span class="s1">&#39;1.3.2&#39;</span><span class="p">,</span> <span class="ss">:require</span> <span class="o">=&gt;</span> <span class="s1">&#39;sqlite3&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;gravatar_image_tag&#39;</span><span class="p">,</span> <span class="s1">&#39;1.0.0.pre2&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;will_paginate&#39;</span><span class="p">,</span> <span class="s1">&#39;3.0.pre2&#39;</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
</pre></div>
</div></div>


<p>Then <code>bundle install</code>:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle install
</pre></div>
</div>


<p>Avec <tt>will_paginate</tt> installé, nous sommes maintenant en mesure de paginer le résultat de nos utilisateurs trouvés. Nous allons commener par ajouter la méthode spéciale <code>will_paginate</code> dans la vue (<a class="ref" href="updating-showing-and-deleting-users#code:will_paginate_index_view">Listing&nbsp;10.27</a>)&nbsp;; nous verrons dans un moment pourquoi le code apparait au-dessus et en dessous de la liste d'utilisateurs.</p>

<div class="label" id="code:will_paginate_index_view"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.27.</span> <span class="description">L'index utilisateur avec la pagination. <br /> <code>app/views/users/index.html.erb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_82c4f816cb4d9bc486435606b323c9a4f6bef49e">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=%3Ch1%3EAll%20users%3C/h1%3E%0A%0A%3C%25=%20will_paginate%20%25%3E%0A%0A%3Cul%20class=%22users%22%3E%0A%20%20%3C%25%20@users.each%20do%20%7Cuser%7C%20%25%3E%0A%20%20%20%20%3Cli%3E%0A%20%20%20%20%20%20%3C%25=%20gravatar_for%20user,%20:size%20=%3E%2030%20%25%3E%0A%20%20%20%20%20%20%3C%25=%20link_to%20user.name,%20user%20%25%3E%0A%20%20%20%20%3C/li%3E%0A%20%20%3C%25%20end%20%25%3E%0A%3C/ul%3E%0A%0A%3C%25=%20will_paginate%20%25%3E%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=%3Ch1%3EAll%20users%3C/h1%3E%0A%0A%3C%25=%20will_paginate%20%25%3E%0A%0A%3Cul%20class=%22users%22%3E%0A%20%20%3C%25%20@users.each%20do%20%7Cuser%7C%20%25%3E%0A%20%20%20%20%3Cli%3E%0A%20%20%20%20%20%20%3C%25=%20gravatar_for%20user,%20:size%20=%3E%2030%20%25%3E%0A%20%20%20%20%20%20%3C%25=%20link_to%20user.name,%20user%20%25%3E%0A%20%20%20%20%3C/li%3E%0A%20%20%3C%25%20end%20%25%3E%0A%3C/ul%3E%0A%0A%3C%25=%20will_paginate%20%25%3E%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>Tous les utilisateurs<span class="nt">&lt;/h1&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>

<span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;users&quot;</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%</span> <span class="vi">@users</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;li&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="n">user</span><span class="p">,</span> <span class="ss">:size</span> <span class="o">=&gt;</span> <span class="mi">30</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/li&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/ul&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p>La méthode <code>will_paginate</code> est un peu magique&nbsp;; à l'intérieur d'une vue <code>users</code> (“utilisateurs”), elle cherche automatiquement un objet <code>@users</code>, et affiche des liens de paginations pour atteindre les autres pages. La vue dans le <a class="ref" href="updating-showing-and-deleting-users#code:will_paginate_index_view">Listing&nbsp;10.27</a> ne fonctionne pas encore, évidemment, puisque actuellement la variable <code>@users</code> contient le résultat de <code>User.all</code> (<a class="ref" href="updating-showing-and-deleting-users#code:user_index">Listing&nbsp;10.20</a>), qui est de classe Array (“table non associative”), tandis que <code>will_paginate</code> attend un objet de classe <code>WillPaginate::Collection</code>. Heureusement, c'est justement le type d'objet retourné par la méthode <code>paginate</code> fournie par le gem <tt>will_paginate</tt>&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">class</span>
<span class="go">=&gt; Array</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">:page</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">class</span>
<span class="go">=&gt; WillPaginate::Collection</span>
</pre></div>
</div>

<p>Notes que <code>paginage</code> prend un argument de type tableau associatif avec la clé <code>:page</code> de valeur égale à la page requise.
<code>User.paginate</code> extrait les utilisateurs de la base de donnée en une fois (30 par défaut), en se basant sur le paramètre <code>:page</code>. Ainsi, par exemple, la page&nbsp;1 sont les utilisateurs 1&ndash;30, la page&nbsp;2 les utilisateurs 31&ndash;60, etc.</p>

<p>On peut paginer les utilisateurs dans l'application exemple en utilisant  <code>paginate</code> à la place de <code>all</code> dans l'action <code>index</code> (<a class="ref" href="updating-showing-and-deleting-users#code:will_paginate_index_action">Listing&nbsp;10.28</a>). Ici le paramètre <code>:page</code> est issu de <code>params[:page]</code>, qui est généré automatiuement par <code>will_paginate</code>.</p>

<div class="label" id="code:will_paginate_index_action"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.28.</span> <span class="description">Paginer les utilisateurs dans l'action <code>index</code>. <br /> <code>app/controllers/users_controller.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_a385404c02d6d2dfc8a9e876940ec67efae30cda">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=class%20UsersController%20%3C%20ApplicationController%0A%20%20before_filter%20:authenticate,%20:only%20=%3E%20[:index,%20:edit,%20:update]%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20def%20index%0A%20%20%20%20@title%20=%20%22All%20users%22%0A%20%20%20%20@users%20=%20User.paginate(:page%20=%3E%20params[:page])%0A%20%20end%0A%20%20.%0A%20%20.%0A%20%20.%0Aend%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=class%20UsersController%20%3C%20ApplicationController%0A%20%20before_filter%20:authenticate,%20:only%20=%3E%20[:index,%20:edit,%20:update]%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20def%20index%0A%20%20%20%20@title%20=%20%22All%20users%22%0A%20%20%20%20@users%20=%20User.paginate(:page%20=%3E%20params[:page])%0A%20%20end%0A%20%20.%0A%20%20.%0A%20%20.%0Aend%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:authenticate</span><span class="p">,</span> <span class="ss">:only</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:index</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">index</span>
    <span class="vi">@title</span> <span class="o">=</span> <span class="s2">&quot;Tous les utilisateurs&quot;</span>
    <span class="vi">@users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">:page</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>La page d'index de l'utilisateur devrait maintenant fonctionner, apparaissant telle que dans l'<a class="ref" href="updating-showing-and-deleting-users#fig:user_index_pagination_rails_3">Illustration&nbsp;10.10</a>; parce que nous avons inclus <code>will_paginate</code> au-dessus et en dessous de la liste des utilisateurs, les liens de pagination apparaissent à ces deux endroits.</p>

<div class="label" id="fig:user_index_pagination_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_index_pagination_rails_3.png" alt="user_index_pagination_rails_3" /></span></div><div class="caption"><span class="header">Illustration 10.10: </span><span class="description">La page d'index <a href="http://localhost:3000/users"><tt>/users</tt></a> paginée.&nbsp;<a href="http://railstutorial.org/images/figures/user_index_pagination_rails_3-full.png">(full size)</a></span></div></div>


<p>Si vous cliquez soit le lien &nbsp;<a href="http://localhost:3000/users?page=2">2</a> soit le lien <a href="http://localhost:3000/users?page=2">Next</a>, vous obtiendrez la seconde page de résultats, comme dans l'<a class="ref" href="updating-showing-and-deleting-users#fig:user_index_page_two_rails_3">Illustration&nbsp;10.11</a>.</p>

<div class="label" id="fig:user_index_page_two_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_index_page_two_rails_3.png" alt="user_index_page_two_rails_3" /></span></div><div class="caption"><span class="header">Illustration 10.11: </span><span class="description">Page 2 de l'index (<a href="http://localhost:3000/users?page=2"><tt>/users?page=2</tt></a>).&nbsp;<a href="http://railstutorial.org/images/figures/user_index_page_two_rails_3-full.png">(taille normale)</a></span></div></div>




<div class="label" id="sec:testing_pagination"></div>


<h4><a id="sec:10.3.3.1" href="updating-showing-and-deleting-users#sec:testing_pagination" class="heading">Test de la pagination</a></h4>


<p>Tester la pagination requiert quelque connaissance de comment fonctionne <tt>will_paginate</tt>, donc nous avons commencé par l'implémentation, mais ça reste une bonne idée de la tester. Pour ce faire, nous avons besoin d'invoquer la pagination dans un test, ce qui signifie de créer d'abord plus de 30 utilisateurs (d'usine).</p>

<p>Comme auparavant, nous utiliserons Factory Girl pour simuler des utilisateurs, mais pour le moment, nous avons un problème&nbsp;: les adresses d'utilisateurs doivent être uniques, ce qui semblerait consister à créer plus de 30 utilisateurs “à la main”&mdash;un travail terriblement rébarbatif… Par chance, Factory Girl anticipe ce problème, et fournit des <em>sequences</em> pour le résoudre, comme montré dans le <a class="ref" href="updating-showing-and-deleting-users#code:factory_sequence">Listing&nbsp;10.29</a>.</p>

<div class="label" id="code:factory_sequence"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.29.</span> <span class="description">Définir une séquence Factory Girl. <br /> <code>spec/factories.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_fbaf6e80245d4c467c74fe278ca12246811ff21d">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=Factory.define%20:user%20do%20%7Cuser%7C%0A%20%20user.name%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22Michael%20Hartl%22%0A%20%20user.email%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22mhartl@example.com%22%0A%20%20user.password%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22foobar%22%0A%20%20user.password_confirmation%20%22foobar%22%0Aend%0A%0AFactory.sequence%20:email%20do%20%7Cn%7C%0A%20%20%22person%2D%23%7Bn%7D@example.com%22%0Aend%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=Factory.define%20:user%20do%20%7Cuser%7C%0A%20%20user.name%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22Michael%20Hartl%22%0A%20%20user.email%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22mhartl@example.com%22%0A%20%20user.password%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22foobar%22%0A%20%20user.password_confirmation%20%22foobar%22%0Aend%0A%0AFactory.sequence%20:email%20do%20%7Cn%7C%0A%20%20%22person%2D%23%7Bn%7D@example.com%22%0Aend%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="no">Factory</span><span class="o">.</span><span class="n">define</span> <span class="ss">:user</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
  <span class="n">user</span><span class="o">.</span><span class="n">name</span>                  <span class="s2">&quot;Michael Hartl&quot;</span>
  <span class="n">user</span><span class="o">.</span><span class="n">email</span>                 <span class="s2">&quot;mhartl@example.com&quot;</span>
  <span class="n">user</span><span class="o">.</span><span class="n">password</span>              <span class="s2">&quot;foobar&quot;</span>
  <span class="n">user</span><span class="o">.</span><span class="n">password_confirmation</span> <span class="s2">&quot;foobar&quot;</span>
<span class="k">end</span>

<span class="no">Factory</span><span class="o">.</span><span class="n">sequence</span> <span class="ss">:email</span> <span class="k">do</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span>
  <span class="s2">&quot;person-</span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">@example.com&quot;</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Cela revient à retourner des adresses-mail comme <code>person-1@example.com</code>, <code>person-2@example.com</code>, etc., que nous invoquons en utilisant la méthode <code>next</code>&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="no">Factory</span><span class="p">(</span><span class="ss">:user</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="no">Factory</span><span class="o">.</span><span class="n">next</span><span class="p">(</span><span class="ss">:email</span><span class="p">))</span>
</pre></div>
</div>


<p>En appliquant l'idée de séquence d'usine, nous pouvons faire 31 utilisateurs (l'utilisateur <code>@user</code> original et 30 de plus) à l'intérieur d'un test, et vérifier alors que la réponse obtient de <tt>will_paginate</tt> le code HTML voulu (ce que nous devrions être en mesure de déterminer en utilisant Firebug ou en consultant le code source de la page). Le résultat apparait dans le <a class="ref" href="updating-showing-and-deleting-users#code:will_paginate_test">Listing&nbsp;10.30</a>.</p>

<div class="label" id="code:will_paginate_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.30.</span> <span class="description">Un test de la pagination. <br /> <code>spec/controllers/users_controller_spec.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_cdcd4d45a89a49b541751874e967b26e40c90653">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=require%20'spec_helper'%0A%0Adescribe%20%22UsersController%22%20do%0A%20%20render_views%0A%0A%20%20describe%20%22GET%20'index'%22%20do%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20%20%20describe%20%22for%20signed%2Din%20users%22%20do%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20before(:each)%20do%0A%20%20%20%20%20%20%20%20.%0A%20%20%20%20%20%20%20%20.%0A%20%20%20%20%20%20%20%20.%0A%20%20%20%20%20%20%20%20@users%20=%20[@user,%20second,%20third]%0A%20%20%20%20%20%20%20%2030.times%20do%0A%20%20%20%20%20%20%20%20%20%20@users%20%3C%3C%20Factory(:user,%20:email%20=%3E%20Factory.next(:email))%0A%20%20%20%20%20%20%20%20end%0A%20%20%20%20%20%20end%0A%20%20%20%20%20%20.%0A%20%20%20%20%20%20.%0A%20%20%20%20%20%20.%0A%20%20%20%20%20%20it%20%22should%20have%20an%20element%20for%20each%20user%22%20do%0A%20%20%20%20%20%20%20%20get%20:index%0A%20%20%20%20%20%20%20%20@users[0..2].each%20do%20%7Cuser%7C%0A%20%20%20%20%20%20%20%20%20%20response.should%20have_selector(%22li%22,%20:content%20=%3E%20user.name)%0A%20%20%20%20%20%20%20%20end%0A%20%20%20%20%20%20end%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20it%20%22should%20paginate%20users%22%20do%0A%20%20%20%20%20%20%20%20get%20:index%0A%20%20%20%20%20%20%20%20response.should%20have_selector(%22div.pagination%22)%0A%20%20%20%20%20%20%20%20response.should%20have_selector(%22span.disabled%22,%20:content%20=%3E%20%22Previous%22)%0A%20%20%20%20%20%20%20%20response.should%20have_selector(%22a%22,%20:href%20=%3E%20%22/users?page=2%22,%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:content%20=%3E%20%222%22)%0A%20%20%20%20%20%20%20%20response.should%20have_selector(%22a%22,%20:href%20=%3E%20%22/users?page=2%22,%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:content%20=%3E%20%22Next%22)%0A%20%20%20%20%20%20end%0A%20%20%20%20end%0A%20%20end%0A%20%20.%0A%20%20.%0A%20%20.%0Aend%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=require%20'spec_helper'%0A%0Adescribe%20%22UsersController%22%20do%0A%20%20render_views%0A%0A%20%20describe%20%22GET%20'index'%22%20do%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20%20%20describe%20%22for%20signed%2Din%20users%22%20do%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20before(:each)%20do%0A%20%20%20%20%20%20%20%20.%0A%20%20%20%20%20%20%20%20.%0A%20%20%20%20%20%20%20%20.%0A%20%20%20%20%20%20%20%20@users%20=%20[@user,%20second,%20third]%0A%20%20%20%20%20%20%20%2030.times%20do%0A%20%20%20%20%20%20%20%20%20%20@users%20%3C%3C%20Factory(:user,%20:email%20=%3E%20Factory.next(:email))%0A%20%20%20%20%20%20%20%20end%0A%20%20%20%20%20%20end%0A%20%20%20%20%20%20.%0A%20%20%20%20%20%20.%0A%20%20%20%20%20%20.%0A%20%20%20%20%20%20it%20%22should%20have%20an%20element%20for%20each%20user%22%20do%0A%20%20%20%20%20%20%20%20get%20:index%0A%20%20%20%20%20%20%20%20@users[0..2].each%20do%20%7Cuser%7C%0A%20%20%20%20%20%20%20%20%20%20response.should%20have_selector(%22li%22,%20:content%20=%3E%20user.name)%0A%20%20%20%20%20%20%20%20end%0A%20%20%20%20%20%20end%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20it%20%22should%20paginate%20users%22%20do%0A%20%20%20%20%20%20%20%20get%20:index%0A%20%20%20%20%20%20%20%20response.should%20have_selector(%22div.pagination%22)%0A%20%20%20%20%20%20%20%20response.should%20have_selector(%22span.disabled%22,%20:content%20=%3E%20%22Previous%22)%0A%20%20%20%20%20%20%20%20response.should%20have_selector(%22a%22,%20:href%20=%3E%20%22/users?page=2%22,%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:content%20=%3E%20%222%22)%0A%20%20%20%20%20%20%20%20response.should%20have_selector(%22a%22,%20:href%20=%3E%20%22/users?page=2%22,%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:content%20=%3E%20%22Next%22)%0A%20%20%20%20%20%20end%0A%20%20%20%20end%0A%20%20end%0A%20%20.%0A%20%20.%0A%20%20.%0Aend%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;UsersController&quot;</span> <span class="k">do</span>
  <span class="n">render_views</span>

  <span class="n">describe</span> <span class="s2">&quot;GET &#39;index&#39;&quot;</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;pour les utilisateurs identifiés&quot;</span> <span class="k">do</span>

      <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
        <span class="o">.</span>
        <span class="o">.</span>
        <span class="o">.</span>
        <span class="vi">@users</span> <span class="o">=</span> <span class="o">[</span><span class="vi">@user</span><span class="p">,</span> <span class="n">second</span><span class="p">,</span> <span class="n">third</span><span class="o">]</span>
        <span class="mi">30</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span>
          <span class="vi">@users</span> <span class="o">&lt;&lt;</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:user</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="no">Factory</span><span class="o">.</span><span class="n">next</span><span class="p">(</span><span class="ss">:email</span><span class="p">))</span>
        <span class="k">end</span>
      <span class="k">end</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="n">it</span> <span class="s2">&quot;devrait avoir un élément pour chaque utilisateur&quot;</span> <span class="k">do</span>
        <span class="n">get</span> <span class="ss">:index</span>
        <span class="vi">@users</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">2</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
          <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;li&quot;</span><span class="p">,</span> <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;devrait paginer les utilisateurs&quot;</span> <span class="k">do</span>
        <span class="n">get</span> <span class="ss">:index</span>
        <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;div.pagination&quot;</span><span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;span.disabled&quot;</span><span class="p">,</span> <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="s2">&quot;Previous&quot;</span><span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="ss">:href</span> <span class="o">=&gt;</span> <span class="s2">&quot;/users?page=2&quot;</span><span class="p">,</span>
                                           <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="s2">&quot;2&quot;</span><span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="ss">:href</span> <span class="o">=&gt;</span> <span class="s2">&quot;/users?page=2&quot;</span><span class="p">,</span>
                                           <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="s2">&quot;Next&quot;</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Ce code s'assure que les tests invoquent la pagination en ajoutant 30<sup class="footnote" id="fnref:10.8"><a href="#fn:10.8">8</a></sup> utilisateurs à la variable <code>@users</code> en utilisant la notation “push” des tableaux <code>Array</code>&nbsp;<code>&lt;&lt;</code>, qui ajoute un élément à un tableau existant&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="o">]</span>
<span class="go">=&gt; [1, 2, 5]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span> <span class="o">&lt;&lt;</span> <span class="mi">17</span>
<span class="go">=&gt; [1, 2, 5, 17]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span> <span class="o">&lt;&lt;</span> <span class="mi">42</span> <span class="o">&lt;&lt;</span> <span class="mi">1337</span>
<span class="go">=&gt; [1, 2, 5, 17, 42, 1337]</span>
</pre></div>
</div>


<p>Nous voyons dans le dernier exemple que les occurrences de&nbsp;<code>&lt;&lt;</code> peuvent être “chaînées”. Dans le test lui-même, notez la notation compacte <code>have_selector("div.pagination")</code>, qui emprunte la convention des classes CSS (vues pour la première fois dans le <a class="ref" href="filling-in-the-layout#code:header_content">Listing&nbsp;5.3</a>) pour vérifier l'existence d'une balise <code>div</code> de classe <code>pagination</code>. Notez aussi que, maintenant qu'il y a 33 utilisateurs, nous avons actualisé le test de l'élément utilisateur pour n'utiliser que les trois premiers éléments (<code>[0..2]</code>) de la table  <code>@users</code>, ce qui correspond à ce que nous avions avant dans le <a class="ref" href="updating-showing-and-deleting-users#code:user_index_tests">Listing&nbsp;10.19</a>:</p>

<div class="code"><div class="highlight"><pre><span class="vi">@users</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">2</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
  <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;li&quot;</span><span class="p">,</span> <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>


<p>Avec ça, notre code de pagination est bien testé, et il n'y a qu'un détail mineur oublié, comme nous le verrons dans la prochaine section.</p>

<div class="label" id="sec:partial_refactoring"></div>


<h3><a id="sec:10.3.4" href="updating-showing-and-deleting-users#sec:partial_refactoring" class="heading"><span class="number">10.3.4</span> Restructuration des partielles</a></h3>


<p>L'index paginé est maintenant complet, mais il reste une amélioration que je ne peux m'empêche d'inclure&nbsp;: Rails possède des outils incroyablement [glissant|slick] pour faire des vues compactes, et dans cette section nous restructurerons la page d'index pour les utiliser. Parce que notre code est bien testé, nous pouvons le restructurer en toute confiance, assurés que nous sommes que nous ne casseront pas les fonctionnalités du site&rsquo;s functionality.</p>

<p>La première étape dans la restructuration est de remplacer le <code>li</code> de l'utilisateur (du <a class="ref" href="updating-showing-and-deleting-users#code:will_paginate_index_view">Listing&nbsp;10.27</a>) par un appel à un <code>render</code> (“rendu”) (<a class="ref" href="updating-showing-and-deleting-users#code:index_view_first_refactoring">Listing&nbsp;10.31</a>).</p>

<div class="label" id="code:index_view_first_refactoring"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.31.</span> <span class="description">Premier élément de restructuration de la vue d'index. <br /> <code>app/views/users/index.html.erb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_e8384f9a385aacd1a8e2bf2565c64c68694134e4">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=%3Ch1%3EAll%20users%3C/h1%3E%0A%0A%3C%25=%20will_paginate%20%25%3E%0A%0A%3Cul%20class=%22users%22%3E%0A%20%20%3C%25%20@users.each%20do%20%7Cuser%7C%20%25%3E%0A%20%20%20%20%3C%25=%20render%20user%20%25%3E%0A%20%20%3C%25%20end%20%25%3E%0A%3C/ul%3E%0A%0A%3C%25=%20will_paginate%20%25%3E%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=%3Ch1%3EAll%20users%3C/h1%3E%0A%0A%3C%25=%20will_paginate%20%25%3E%0A%0A%3Cul%20class=%22users%22%3E%0A%20%20%3C%25%20@users.each%20do%20%7Cuser%7C%20%25%3E%0A%20%20%20%20%3C%25=%20render%20user%20%25%3E%0A%20%20%3C%25%20end%20%25%3E%0A%3C/ul%3E%0A%0A%3C%25=%20will_paginate%20%25%3E%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>All users<span class="nt">&lt;/h1&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>

<span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;users&quot;</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%</span> <span class="vi">@users</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="n">user</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/ul&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>

<p>Ici nous appelons <code>render</code> non pas sur une chaine (string) avec le nom du partiel, mais plutôt sur une variable <code>user</code> de classe <code>User</code>&nbsp;;<sup class="footnote" id="fnref:10.9"><a href="#fn:10.9">9</a></sup> dans ce contexte, Rails recherche automatiuement un partiel appelé <code>_user.html.erb</code>, que nous devons créer (<a class="ref" href="updating-showing-and-deleting-users#code:user_partial">Listing&nbsp;10.32</a>).</p>

<div class="label" id="code:user_partial"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.32.</span> <span class="description">Partiel pour rendre un seul utilisateur. <br /> <code>app/views/users/_user.html.erb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_4c58e746ca1fade16dd57bf5d27ccfb0f1bc0cf0">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=%3Cli%3E%0A%20%20%3C%25=%20gravatar_for%20user,%20:size%20=%3E%2030%20%25%3E%0A%20%20%3C%25=%20link_to%20user.name,%20user%20%25%3E%0A%3C/li%3E%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=%3Cli%3E%0A%20%20%3C%25=%20gravatar_for%20user,%20:size%20=%3E%2030%20%25%3E%0A%20%20%3C%25=%20link_to%20user.name,%20user%20%25%3E%0A%3C/li%3E%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;li&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="n">user</span><span class="p">,</span> <span class="ss">:size</span> <span class="o">=&gt;</span> <span class="mi">30</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/li&gt;</span>
</pre></div>
</div></div>


<p>C'est une amélioration définitive, mais nous pouvons encore faire mieux&nbsp;: nous pouvons appeler <code>render</code> <em>directement</em> sur la variable <code>@users</code> (<a class="ref" href="updating-showing-and-deleting-users#code:index_final_refactoring">Listing&nbsp;10.33</a>).</p>

<div class="label" id="code:index_final_refactoring"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.33.</span> <span class="description">La restructuration complète de l'index. <br /> <code>app/views/users/index.html.erb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_368538608d9ff4622c16302f20dbfead05836046">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=%3Ch1%3EAll%20users%3C/h1%3E%0A%0A%3C%25=%20will_paginate%20%25%3E%0A%0A%3Cul%20class=%22users%22%3E%0A%20%20%3C%25=%20render%20@users%20%25%3E%0A%3C/ul%3E%0A%0A%3C%25=%20will_paginate%20%25%3E%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=%3Ch1%3EAll%20users%3C/h1%3E%0A%0A%3C%25=%20will_paginate%20%25%3E%0A%0A%3Cul%20class=%22users%22%3E%0A%20%20%3C%25=%20render%20@users%20%25%3E%0A%3C/ul%3E%0A%0A%3C%25=%20will_paginate%20%25%3E%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>Tous les utilisateurs<span class="nt">&lt;/h1&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>

<span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;users&quot;</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@users</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/ul&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p>Ici Rails déduit que <code>@users</code> est une liste d'objets <code>User</code>&nbsp;; plus encore, quand appelé avec une collection d'utilisateurs, Rails itère automatiquement sur eux, rendant chaque occurrence avec le partiel <code>_user.html.erb</code>. Le résultat est le code incroyablement compact du <a class="ref" href="updating-showing-and-deleting-users#code:index_final_refactoring">Listing&nbsp;10.33</a>.</p>

<div class="label" id="sec:destroying_users"></div>


<h2><a id="sec:10.4" href="updating-showing-and-deleting-users#sec:destroying_users" class="heading"><span class="number">10.4</span> Destruction des utilisateurs</a></h2>


<p>Maintenant que l'index est achevé, il ne reste qu'un action canonique REST à produire&nbsp;: <code>destroy</code>. Dans cette section, nous ajouterons des liens pour supprimer des utilisateurs, comme dans la maquette de l'<a class="ref" href="updating-showing-and-deleting-users#fig:user_index_delete_links_mockup">Illustration&nbsp;10.12</a>, et nous définirons l'action <code>destroy</code> (“détruire”) nécessaire pour accomplir cette suppression. Mais avant tout, nous devons créer la classe “administrateurs” qui seront autorisés à procéder à cette destruction.</p>

<div class="label" id="fig:user_index_delete_links_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_index_delete_links_mockup.png" alt="user_index_delete_links_mockup" /></span></div><div class="caption"><span class="header">Illustration 10.12: </span><span class="description">Maquette de l'index avec des liens de suppression.&nbsp;<a href="http://railstutorial.org/images/figures/user_index_delete_links_mockup-full.png">(full size)</a></span></div></div>




<div class="label" id="sec:administrative_users"></div>


<h3><a id="sec:10.4.1" href="updating-showing-and-deleting-users#sec:administrative_users" class="heading"><span class="number">10.4.1</span> Utilisateurs administrateurs</a></h3>


<p>Nous allons identifier les utilisateurs possédant des privilèges d'administrateur par le biais d'un attribut booléen <code>admin</code> dans le modèle User, ce qui nous conduira à créer une méthode <code>admin?</code> testant le statut de l'utilisateur. Nous pouvons écrire des tests pour cet attribut comme dans le <a class="ref" href="updating-showing-and-deleting-users#code:admin_specs">Listing&nbsp;10.34</a>.</p>

<div class="label" id="code:admin_specs"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.34.</span> <span class="description">Test pour un attribut <code>admin</code>. <br /> <code>spec/models/user_spec.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_d8e9994f056af9dc5497f504cae510c551b898a2">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=.%0A.%0A.%0A%20%20describe%20%22admin%20attribute%22%20do%0A%0A%20%20%20%20before(:each)%20do%0A%20%20%20%20%20%20@user%20=%20User.create!(@attr)%0A%20%20%20%20end%0A%0A%20%20%20%20it%20%22should%20respond%20to%20admin%22%20do%0A%20%20%20%20%20%20@user.should%20respond_to(:admin)%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20it%20%22should%20not%20be%20an%20admin%20by%20default%22%20do%0A%20%20%20%20%20%20@user.should_not%20be_admin%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20it%20%22should%20be%20convertible%20to%20an%20admin%22%20do%0A%20%20%20%20%20%20@user.toggle!(:admin)%0A%20%20%20%20%20%20@user.should%20be_admin%0A%20%20%20%20end%0A%20%20end%0Aend%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=.%0A.%0A.%0A%20%20describe%20%22admin%20attribute%22%20do%0A%0A%20%20%20%20before(:each)%20do%0A%20%20%20%20%20%20@user%20=%20User.create!(@attr)%0A%20%20%20%20end%0A%0A%20%20%20%20it%20%22should%20respond%20to%20admin%22%20do%0A%20%20%20%20%20%20@user.should%20respond_to(:admin)%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20it%20%22should%20not%20be%20an%20admin%20by%20default%22%20do%0A%20%20%20%20%20%20@user.should_not%20be_admin%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20it%20%22should%20be%20convertible%20to%20an%20admin%22%20do%0A%20%20%20%20%20%20@user.toggle!(:admin)%0A%20%20%20%20%20%20@user.should%20be_admin%0A%20%20%20%20end%0A%20%20end%0Aend%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;Attribut admin&quot;</span> <span class="k">do</span>

    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="vi">@attr</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;devrait confirmer l'existence de `admin`&quot;</span> <span class="k">do</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:admin</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;ne devrait pas être un administrateur par défaut&quot;</span> <span class="k">do</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_admin</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;devrait pouvoir devenir un administrateur&quot;</span> <span class="k">do</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">toggle!</span><span class="p">(</span><span class="ss">:admin</span><span class="p">)</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">should</span> <span class="n">be_admin</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Ici nous avons utilisé la méthode <code>toggle!</code> (“bascule”) pour basculer la valeur de l'attribut <code>admin</code> de <code>false</code> (“faux”) à <code>true</code> (“true”). Aussi, notez que la ligne&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="vi">@user</span><span class="o">.</span><span class="n">should</span> <span class="n">be_admin</span>
</pre></div>
</div>


<p>implique (via les conventions booléennes de RSpec) que l'utilisateur devrait posséder une méthode booléenne <code>admin?</code>.</p>

<p>Nous ajoutons l'attribut <code>admin</code> grâce à une migration comme d'habitude, en indiquant le type booléen de l'attribut dans la ligne de commande&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate migration add_admin_to_users admin:boolean
</pre></div>
</div>


<p>La migration ajoute simplement la colonne <code>admin</code> à la table <code>users</code> (<a class="ref" href="updating-showing-and-deleting-users#code:admin_migration">Listing&nbsp;10.35</a>), en [adaptant le modèle de données comme dans l'][yielding the data model in ]<a class="ref" href="updating-showing-and-deleting-users#fig:user_model_admin">Illustration&nbsp;10.13</a>.</p>

<div class="label" id="code:admin_migration"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.35.</span> <span class="description">Migration pour ajouter un attribut booléen <code>admin</code> aux utilisateurs. <br /> <code>db/migrate/&lt;timestamp&gt;_add_admin_to_users.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_5ffda71427b2b18840b24be6b9cc6c43f1fec818">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=class%20AddAdminToUsers%20%3C%20ActiveRecord::Migration%0A%20%20def%20self.up%0A%20%20%20%20add_column%20:users,%20:admin,%20:boolean,%20:default%20=%3E%20false%0A%20%20end%0A%0A%20%20def%20self.down%0A%20%20%20%20remove_column%20:users,%20:admin%0A%20%20end%0Aend%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=class%20AddAdminToUsers%20%3C%20ActiveRecord::Migration%0A%20%20def%20self.up%0A%20%20%20%20add_column%20:users,%20:admin,%20:boolean,%20:default%20=%3E%20false%0A%20%20end%0A%0A%20%20def%20self.down%0A%20%20%20%20remove_column%20:users,%20:admin%0A%20%20end%0Aend%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">AddAdminToUsers</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">up</span>
    <span class="n">add_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:admin</span><span class="p">,</span> <span class="ss">:boolean</span><span class="p">,</span> <span class="ss">:default</span> <span class="o">=&gt;</span> <span class="kp">false</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">down</span>
    <span class="n">remove_column</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:admin</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Notez l'ajout de l'argument <code>:default =&gt; false</code> à la fonction <code>add_column</code> dans le <a class="ref" href="updating-showing-and-deleting-users#code:admin_migration">Listing&nbsp;10.35</a>, qui spécifie que les utilisateurs <em>ne seront pas</em> des administrateurs par défaut (sans cet argument <code>:default =&gt; false</code>, <code>admin</code> serait nul dar défaut (<code>nil</code>), ce qui équivaut à <code>false</code>, donc cette précision n'est pas strictement nécessaire. Mais le code est plus explicite ainsi, et transmet notre intention de façon plus claire à Rails ainsi qu'aux lecteurs du code).</p>

<div class="label" id="fig:user_model_admin"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_model_admin.png" alt="user_model_admin" /></span></div><div class="caption"><span class="header">Figure 10.13: </span><span class="description">Le modèle `User` avec un attribut booléen <code>admin</code> ajouté.</span></div></div>


<p>Pour finir, nous migrons la base de données de développement et préparons le base de données de test&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rake db:migrate
<span class="gp">$</span> rake db:test:prepare
</pre></div>
</div>


<p>Comme attendu, Rails prend en compte la nature booléenne de l'attribut <code>admin</code> et ajoute automatiquement la méthode du même nom suivie d'un point d'interrogation <code>admin?</code>:<sup class="footnote" id="fnref:10.10"><a href="#fn:10.10">10</a></sup></p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">first</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">admin?</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="s2">&quot;foobar&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">toggle!</span><span class="p">(</span><span class="ss">:admin</span><span class="p">)</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">admin?</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p>Pour finir, actualisation notre peuplement fictif pour faire du premier utilisateur un administrateur (<a class="ref" href="updating-showing-and-deleting-users#code:populator_with_admin">Listing&nbsp;10.36</a>).</p>

<div class="label" id="code:populator_with_admin"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 10.36.</span> <span class="description">Peuplement fictif avec un utilisateur administrateur. <br /> <code>lib/tasks/sample_data.rake</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_b5920aee43b6281a108bdadabcded4f8a93f179c">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=require%20'faker'%0A%0Anamespace%20:db%20do%0A%20%20desc%20%22Fill%20database%20with%20sample%20data%22%0A%20%20task%20:populate%20=%3E%20:environment%20do%0A%20%20%20%20Rake::Task['db:reset'].invoke%0A%20%20%20%20admin%20=%20User.create!(:name%20=%3E%20%22Example%20User%22,%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:email%20=%3E%20%22example@railstutorial.org%22,%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:password%20=%3E%20%22foobar%22,%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:password_confirmation%20=%3E%20%22foobar%22)%0A%20%20%20%20admin.toggle!(:admin)%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20end%0Aend%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=require%20'faker'%0A%0Anamespace%20:db%20do%0A%20%20desc%20%22Fill%20database%20with%20sample%20data%22%0A%20%20task%20:populate%20=%3E%20:environment%20do%0A%20%20%20%20Rake::Task['db:reset'].invoke%0A%20%20%20%20admin%20=%20User.create!(:name%20=%3E%20%22Example%20User%22,%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:email%20=%3E%20%22example@railstutorial.org%22,%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:password%20=%3E%20%22foobar%22,%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:password_confirmation%20=%3E%20%22foobar%22)%0A%20%20%20%20admin.toggle!(:admin)%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20end%0Aend%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;faker&#39;</span>

<span class="n">namespace</span> <span class="ss">:db</span> <span class="k">do</span>
  <span class="n">desc</span> <span class="s2">&quot;Peupler la base de données avec des données fictives&quot;</span>
  <span class="n">task</span> <span class="ss">:populate</span> <span class="o">=&gt;</span> <span class="ss">:environment</span> <span class="k">do</span>
    <span class="no">Rake</span><span class="o">::</span><span class="no">Task</span><span class="o">[</span><span class="s1">&#39;db:reset&#39;</span><span class="o">].</span><span class="n">invoke</span>
    <span class="n">admin</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span>
                         <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;example@railstutorial.org&quot;</span><span class="p">,</span>
                         <span class="ss">:password</span> <span class="o">=&gt;</span> <span class="s2">&quot;foobar&quot;</span><span class="p">,</span>
                         <span class="ss">:password_confirmation</span> <span class="o">=&gt;</span> <span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
    <span class="n">admin</span><span class="o">.</span><span class="n">toggle!</span><span class="p">(</span><span class="ss">:admin</span><span class="p">)</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Enfin, jouons à nouveau le “populateur” pour ré-initialiser la base de données et la reconstruire entièrement&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rake db:populate
</pre></div>
</div>


<div class="label" id="sec:revisiting_attr_accessible"></div>


<h4><a id="sec:10.4.1.1" href="updating-showing-and-deleting-users#sec:revisiting_attr_accessible" class="heading">Révision de <code>attr_accessible</code></a></h4>


<p>Vous avez peut-être noté que le <a class="ref" href="updating-showing-and-deleting-users#code:populator_with_admin">Listing&nbsp;10.36</a> transforme un utilisateur en administrateur avec la méthode <code>toggle!(:admin)</code>, mais pourquoi ne pas ajouter simplement un <code>:admin =&gt; true</code> à la table d'initialisation&nbsp;? La réponse est que cela ne fonctionnerait pas, et ce à dessein&nbsp;: seuls les attributs définis par <code>attr_accessible</code> peuvent être renseignés par le biais d'un [“assignement public”][mass assignment], et l'attribut  <code>admin</code> n'est pas dans ce cas. L'<a class="ref" href="updating-showing-and-deleting-users#code:attr_accessible_review">Extrait&nbsp;10.37</a> reproduit la liste la plus récente des attributs <code>attr_accessible</code> &mdash;notez que <code>:admin</code>  <em>n'est pas</em> dans cette liste.</p>

<div class="label" id="code:attr_accessible_review"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 10.37.</span> <span class="description">Les attributs <code>attr_accessible</code> du modèle `User` <em>sans</em> attribut <code>:admin</code>.  <br /> <code>app/models/user.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_933f8448ae4ba5c50c4c381938b538a0dedb687f">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=class%20User%20%3C%20ActiveRecord::Base%0A%20%20attr_accessor%20:password%0A%20%20attr_accessible%20:name,%20:email,%20:password,%20:password_confirmation%0A%20%20.%0A%20%20.%0A%20%20.%0Aend%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=class%20User%20%3C%20ActiveRecord::Base%0A%20%20attr_accessor%20:password%0A%20%20attr_accessible%20:name,%20:email,%20:password,%20:password_confirmation%0A%20%20.%0A%20%20.%0A%20%20.%0Aend%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="kp">attr_accessor</span> <span class="ss">:password</span>
  <span class="n">attr_accessible</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:password_confirmation</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>La définition explicite des attributes accessibles est cruciale pour la bonne sécurité d'un site. Si nous avions omis la liste <code>attr_accessible</code> dans le modèle `User` (ou si nous avions de façon irraisonnée ajouté <code>:admin</code> à cette liste), un utilisateur mal intentionné aurait pu envoyer la requête <tt>PUT</tt> comme suit&nbsp;:<sup class="footnote" id="fnref:10.11"><a href="#fn:10.11">11</a></sup></p>

<div class="code"><div class="highlight"><pre>put /users/17?admin=1
</pre></div>
</div>


<p>Cette requête aurait pu transformer l'utilisateur d'identifiant 17 en administrateur, ce qui, pour le moins, peut être une sérieuse brèche dans la sécurité du site. Pour parer ce risque, c'est une bonne habitude de définir le paramètre <code>attr_accessible</code> pour chaque modèle.</p>

<div class="label" id="sec:the_destroy_action"></div>


<h3><a id="sec:10.4.2" href="updating-showing-and-deleting-users#sec:the_destroy_action" class="heading"><span class="number">10.4.2</span> L'action <code>destroy</code> (“détruire”)</a></h3>


<p>La dernière étape nécessaire pour achever la ressource `Utilisateurs` est d'ajouter des liens pour supprimer des utilisateurs et une action <code>destroy</code>. Nous allons commencer par ajouter un lien “supprimer” pour chaque utilisateur dans la page d'index (<a class="ref" href="updating-showing-and-deleting-users#code:delete_links">Extrait&nbsp;10.38</a>).</p>

<div class="label" id="code:delete_links"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 10.38.</span> <span class="description">Liens pour la suppression des utilisateurs (visibles seulement pour les administrateurs). <br /> <code>app/views/users/_user.html.erb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_8e658d5b4520ade348a5f95bc8fc21c8d09e7419">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=%3Cli%3E%0A%20%20%3C%25=%20gravatar_for%20user,%20:size%20=%3E%2030%20%25%3E%0A%20%20%3C%25=%20link_to%20user.name,%20user%20%25%3E%0A%20%20%3C%25%20if%20current_user.admin?%20%25%3E%0A%20%20%7C%20%3C%25=%20link_to%20%22delete%22,%20user,%20:method%20=%3E%20:delete,%20:confirm%20=%3E%20%22You%20sure?%22,%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:title%20=%3E%20%22Delete%20%23%7Buser.name%7D%22%20%25%3E%0A%20%20%3C%25%20end%20%25%3E%0A%3C/li%3E%0A%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=%3Cli%3E%0A%20%20%3C%25=%20gravatar_for%20user,%20:size%20=%3E%2030%20%25%3E%0A%20%20%3C%25=%20link_to%20user.name,%20user%20%25%3E%0A%20%20%3C%25%20if%20current_user.admin?%20%25%3E%0A%20%20%7C%20%3C%25=%20link_to%20%22delete%22,%20user,%20:method%20=%3E%20:delete,%20:confirm%20=%3E%20%22You%20sure?%22,%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:title%20=%3E%20%22Delete%20%23%7Buser.name%7D%22%20%25%3E%0A%20%20%3C%25%20end%20%25%3E%0A%3C/li%3E%0A%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;li&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="n">user</span><span class="p">,</span> <span class="ss">:size</span> <span class="o">=&gt;</span> <span class="mi">30</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">user</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">admin?</span> <span class="cp">%&gt;</span>
  | <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;delete&quot;</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="ss">:method</span> <span class="o">=&gt;</span> <span class="ss">:delete</span><span class="p">,</span> <span class="ss">:confirm</span> <span class="o">=&gt;</span> <span class="s2">&quot;You sure?&quot;</span><span class="p">,</span>
                                <span class="ss">:title</span> <span class="o">=&gt;</span> <span class="s2">&quot;Delete </span><span class="si">#{</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/li&gt;</span>
</pre></div>
</div></div>


<p>Notez l'argument <code>:method =&gt; :delete</code>, qui s'arrange pour que le lien envoie la bonne requête <tt>DELETE</tt> (“EFFACER”). Nous avons aussi entouré chaque lien à l'intérieur d'une condition&nbsp;<code>if</code> pour que seuls les administrateurs puissent les voir. Le résultat pour notre utilisateur administrateur apparait dans l'<a class="ref" href="updating-showing-and-deleting-users#fig:index_delete_links_rails_3">Illustration&nbsp;10.14</a>.</p>

<p>Les navigateurs ne peuvent pas envoyer nativement de requête <tt>DELETE</tt>, donc Rails les simule par le biais de JavaScript.<sup class="footnote" id="fnref:10.12"><a href="#fn:10.12">12</a></sup> Pour que le lien de suppression fonctionne, nous avons donc à inclure la librairie JavaScript standard de Rails, ce que nous faisons en ajoutant la ligne…</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">javascript_include_tag</span> <span class="ss">:defaults</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>… au gabarit du site. Le résultat est montré dans l'<a class="ref" href="updating-showing-and-deleting-users#code:adding_default_javascript">Illustration&nbsp;10.39</a>.</p>

<div class="label" id="code:adding_default_javascript"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 10.39.</span> <span class="description">Ajout de la librairie JavaScript standard de Rails à l'application. <br /> <code>app/views/layouts/application.html.erb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_639777059aa6c4eba12d7752ff3c532c109968b6">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=%3C!DOCTYPE%20html%3E%0A%3Chtml%3E%0A%20%20%3Chead%3E%0A%20%20%20%20%3Ctitle%3E%3C%25=%20title%20%25%3E%3C/title%3E%0A%20%20%20%20%3C%25=%20csrf_meta_tag%20%25%3E%0A%20%20%20%20%3C%25=%20render%20'layouts/stylesheets'%20%25%3E%0A%20%20%20%20%3C%25=%20javascript_include_tag%20:defaults%20%25%3E%0A%20%20%3C/head%3E%0A%20%20%3Cbody%3E%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20%3C/body%3E%0A%3C/html%3E%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=%3C!DOCTYPE%20html%3E%0A%3Chtml%3E%0A%20%20%3Chead%3E%0A%20%20%20%20%3Ctitle%3E%3C%25=%20title%20%25%3E%3C/title%3E%0A%20%20%20%20%3C%25=%20csrf_meta_tag%20%25%3E%0A%20%20%20%20%3C%25=%20render%20'layouts/stylesheets'%20%25%3E%0A%20%20%20%20%3C%25=%20javascript_include_tag%20:defaults%20%25%3E%0A%20%20%3C/head%3E%0A%20%20%3Cbody%3E%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20%3C/body%3E%0A%3C/html%3E%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  <span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;title&gt;</span><span class="cp">&lt;%=</span> <span class="n">title</span> <span class="cp">%&gt;</span><span class="nt">&lt;/title&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">csrf_meta_tag</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;layouts/stylesheets&#39;</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">javascript_include_tag</span> <span class="ss">:defaults</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/head&gt;</span>
  <span class="nt">&lt;body&gt;</span>
    .
    .
    .
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div></div>




<div class="label" id="fig:index_delete_links_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/index_delete_links_rails_3.png" alt="index_delete_links_rails_3" /></span></div><div class="caption"><span class="header">Illustration 10.14: </span><span class="description">L'index  <a href="http://localhost:3000/users"><tt>/users</tt></a> avec les liens de suppression.&nbsp;<a href="http://railstutorial.org/images/figures/index_delete_links_rails_3-full.png">(full size)</a></span></div></div>


<p>Quand bien même seuls les administrateurs seraient en mesure de voir les liens de suppression, il demeure cependant un trou de sécurité important&nbsp;: n'importe quel utilisateur mal intentionné et suffisamment [connaisseur][sophisticated] pourrait transmettre une requête <tt>DELETE</tt> en ligne de commande pour détruire n'importe quel utilisateur. Pour sécuriser proprement le site, nous avons donc aussi besoin d'un contrôle d'accès, pour que les tests ne vérifient pas seulement qu'un administrateur <em>puisse</em> supprimer des utilisateurs, mais également que les autres utilisateurs <em>ne puissent pas</em>. Le résultat apparait dans l'<a class="ref" href="updating-showing-and-deleting-users#code:destroy_tests">Extrait&nbsp;10.40</a>. Notez que, à l'instar des méthodes <code>get</code>, <code>post</code> et <code>put</code>, nous utilisons <code>delete</code> pour traiter la requête <tt>DELETE</tt> à l'intérieur des tests.</p>

<div class="label" id="code:destroy_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 10.40.</span> <span class="description">Tests pour la suppression des utilisateurs. <br /> <code>spec/controllers/users_controller_spec.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_31af19cbb9620003f3cc5a6052b64543e8d89824">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=describe%20UsersController%20do%0A%20%20render_views%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20describe%20%22DELETE%20'destroy'%22%20do%0A%20%20%20%20%0A%20%20%20%20before(:each)%20do%0A%20%20%20%20%20%20@user%20=%20Factory(:user)%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20describe%20%22as%20a%20non%2Dsigned%2Din%20user%22%20do%0A%20%20%20%20%20%20it%20%22should%20deny%20access%22%20do%0A%20%20%20%20%20%20%20%20delete%20:destroy,%20:id%20=%3E%20@user%0A%20%20%20%20%20%20%20%20response.should%20redirect_to(signin_path)%0A%20%20%20%20%20%20end%0A%20%20%20%20end%0A%0A%20%20%20%20describe%20%22as%20a%20non%2Dadmin%20user%22%20do%0A%20%20%20%20%20%20it%20%22should%20protect%20the%20page%22%20do%0A%20%20%20%20%20%20%20%20test_sign_in(@user)%0A%20%20%20%20%20%20%20%20delete%20:destroy,%20:id%20=%3E%20@user%0A%20%20%20%20%20%20%20%20response.should%20redirect_to(root_path)%0A%20%20%20%20%20%20end%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20describe%20%22as%20an%20admin%20user%22%20do%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20before(:each)%20do%0A%20%20%20%20%20%20%20%20admin%20=%20Factory(:user,%20:email%20=%3E%20%22admin@example.com%22,%20:admin%20=%3E%20true)%0A%20%20%20%20%20%20%20%20test_sign_in(admin)%0A%20%20%20%20%20%20end%0A%0A%20%20%20%20%20%20it%20%22should%20destroy%20the%20user%22%20do%0A%20%20%20%20%20%20%20%20lambda%20do%0A%20%20%20%20%20%20%20%20%20%20delete%20:destroy,%20:id%20=%3E%20@user%0A%20%20%20%20%20%20%20%20end.should%20change(User,%20:count).by(%2D1)%0A%20%20%20%20%20%20end%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20it%20%22should%20redirect%20to%20the%20users%20page%22%20do%0A%20%20%20%20%20%20%20%20delete%20:destroy,%20:id%20=%3E%20@user%0A%20%20%20%20%20%20%20%20response.should%20redirect_to(users_path)%0A%20%20%20%20%20%20end%0A%20%20%20%20end%0A%20%20end%0Aend%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=describe%20UsersController%20do%0A%20%20render_views%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20describe%20%22DELETE%20'destroy'%22%20do%0A%20%20%20%20%0A%20%20%20%20before(:each)%20do%0A%20%20%20%20%20%20@user%20=%20Factory(:user)%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20describe%20%22as%20a%20non%2Dsigned%2Din%20user%22%20do%0A%20%20%20%20%20%20it%20%22should%20deny%20access%22%20do%0A%20%20%20%20%20%20%20%20delete%20:destroy,%20:id%20=%3E%20@user%0A%20%20%20%20%20%20%20%20response.should%20redirect_to(signin_path)%0A%20%20%20%20%20%20end%0A%20%20%20%20end%0A%0A%20%20%20%20describe%20%22as%20a%20non%2Dadmin%20user%22%20do%0A%20%20%20%20%20%20it%20%22should%20protect%20the%20page%22%20do%0A%20%20%20%20%20%20%20%20test_sign_in(@user)%0A%20%20%20%20%20%20%20%20delete%20:destroy,%20:id%20=%3E%20@user%0A%20%20%20%20%20%20%20%20response.should%20redirect_to(root_path)%0A%20%20%20%20%20%20end%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20describe%20%22as%20an%20admin%20user%22%20do%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20before(:each)%20do%0A%20%20%20%20%20%20%20%20admin%20=%20Factory(:user,%20:email%20=%3E%20%22admin@example.com%22,%20:admin%20=%3E%20true)%0A%20%20%20%20%20%20%20%20test_sign_in(admin)%0A%20%20%20%20%20%20end%0A%0A%20%20%20%20%20%20it%20%22should%20destroy%20the%20user%22%20do%0A%20%20%20%20%20%20%20%20lambda%20do%0A%20%20%20%20%20%20%20%20%20%20delete%20:destroy,%20:id%20=%3E%20@user%0A%20%20%20%20%20%20%20%20end.should%20change(User,%20:count).by(%2D1)%0A%20%20%20%20%20%20end%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20it%20%22should%20redirect%20to%20the%20users%20page%22%20do%0A%20%20%20%20%20%20%20%20delete%20:destroy,%20:id%20=%3E%20@user%0A%20%20%20%20%20%20%20%20response.should%20redirect_to(users_path)%0A%20%20%20%20%20%20end%0A%20%20%20%20end%0A%20%20end%0Aend%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="no">UsersController</span> <span class="k">do</span>
  <span class="n">render_views</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;DELETE &#39;destroy&#39;&quot;</span> <span class="k">do</span>

    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">&quot;en tant qu'utilisateur non identifié&quot;</span> <span class="k">do</span>
      <span class="n">it</span> <span class="s2">&quot;devrait refuser l'accès&quot;</span> <span class="k">do</span>
        <span class="n">delete</span> <span class="ss">:destroy</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="vi">@user</span>
        <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">signin_path</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">&quot;en tant qu'utilisateur non administrateur&quot;</span> <span class="k">do</span>
      <span class="n">it</span> <span class="s2">&quot;devrait protéger la page&quot;</span> <span class="k">do</span>
        <span class="n">test_sign_in</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
        <span class="n">delete</span> <span class="ss">:destroy</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="vi">@user</span>
        <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">root_path</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">&quot;en tant qu'administrateur&quot;</span> <span class="k">do</span>

      <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
        <span class="n">admin</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:user</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;admin@example.com&quot;</span><span class="p">,</span> <span class="ss">:admin</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span>
        <span class="n">test_sign_in</span><span class="p">(</span><span class="n">admin</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;devrait détruire l'utilisateur&quot;</span> <span class="k">do</span>
        <span class="nb">lambda</span> <span class="k">do</span>
          <span class="n">delete</span> <span class="ss">:destroy</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="vi">@user</span>
        <span class="k">end</span><span class="o">.</span><span class="n">should</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;devrait rediriger vers la page des utilisateurs&quot;</span> <span class="k">do</span>
        <span class="n">delete</span> <span class="ss">:destroy</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="vi">@user</span>
        <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">users_path</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>(Vous pouvez noter que nous avons défini un utilisateur-administrateur en utilisant <code>:admin =&gt; true</code>&nbsp;; [les “utilisateurs d'usine” n'est pas concerné par les règles des paramètres <code>attr_accessible</code>][user factories are not bound by the rules of <code>attr_accessible</code> parameters].) Notez ici que la méthode <code>change</code> peut prendre une valeur négative, ce qui signifie que, tout comme nous avons vérifié la création d'un utilisateur en testant un changement de +1 (<a class="ref" href="sign-up#code:signup_success_tests">Extrait&nbsp;8.14</a>), nous pouvons vérifier une suppression d'utilisateur en testant un changement de -1&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="nb">lambda</span> <span class="k">do</span>
  <span class="n">delete</span> <span class="ss">:destroy</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="vi">@user</span>
<span class="k">end</span><span class="o">.</span><span class="n">should</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>


<p>Comme vous pouvez vous en douter, l'implémentation utilise un filtre “passe-avant” (“before filter”), cette fois pour restreindre l'accès l'action <code>destroy</code> aux seuls administrateurs. L'action <code>destroy</code> trouve elle-même l'utilisateur, le détruit, et redirige alors l'administrateur vers l'index des utilisateurs (<a class="ref" href="updating-showing-and-deleting-users#code:admin_destroy_before_filter">Extrait&nbsp;10.41</a>). [[Je mettrais un warning ici pour penser à ajouter :admin au filtre "passe-avant" :authenticate]]</p>

<div class="label" id="code:admin_destroy_before_filter"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 10.41.</span> <span class="description">Filtre “passe-avant’ pour restreindre l'utilisation de l'action <code>destroy</code> aux administrateurs. <br /> <code>app/controllers/users_controller.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_e60a95617888eb1ba93027061e7d9c324538ee8f">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=class%20UsersController%20%3C%20ApplicationController%0A%20%20before_filter%20:authenticate,%20:only%20=%3E%20[:index,%20:edit,%20:update,%20:destroy]%0A%20%20before_filter%20:correct_user,%20:only%20=%3E%20[:edit,%20:update]%0A%20%20before_filter%20:admin_user,%20%20%20:only%20=%3E%20:destroy%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20def%20destroy%0A%20%20%20%20User.find(params[:id]).destroy%0A%20%20%20%20flash[:success]%20=%20%22User%20destroyed.%22%0A%20%20%20%20redirect_to%20users_path%0A%20%20end%0A%20%20%0A%20%20private%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20%20%20def%20admin_user%0A%20%20%20%20%20%20redirect_to(root_path)%20unless%20current_user.admin?%0A%20%20%20%20end%0Aend%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=class%20UsersController%20%3C%20ApplicationController%0A%20%20before_filter%20:authenticate,%20:only%20=%3E%20[:index,%20:edit,%20:update,%20:destroy]%0A%20%20before_filter%20:correct_user,%20:only%20=%3E%20[:edit,%20:update]%0A%20%20before_filter%20:admin_user,%20%20%20:only%20=%3E%20:destroy%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20def%20destroy%0A%20%20%20%20User.find(params[:id]).destroy%0A%20%20%20%20flash[:success]%20=%20%22User%20destroyed.%22%0A%20%20%20%20redirect_to%20users_path%0A%20%20end%0A%20%20%0A%20%20private%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20%20%20def%20admin_user%0A%20%20%20%20%20%20redirect_to(root_path)%20unless%20current_user.admin?%0A%20%20%20%20end%0Aend%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:authenticate</span><span class="p">,</span> <span class="ss">:only</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:index</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
  <span class="n">before_filter</span> <span class="ss">:correct_user</span><span class="p">,</span> <span class="ss">:only</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="o">]</span>
  <span class="n">before_filter</span> <span class="ss">:admin_user</span><span class="p">,</span>   <span class="ss">:only</span> <span class="o">=&gt;</span> <span class="ss">:destroy</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">destroy</span>
    <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;User destroyed.&quot;</span>
    <span class="n">redirect_to</span> <span class="n">users_path</span>
  <span class="k">end</span>

  <span class="kp">private</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="k">def</span> <span class="nf">admin_user</span>
      <span class="n">redirect_to</span><span class="p">(</span><span class="n">root_path</span><span class="p">)</span> <span class="k">unless</span> <span class="n">current_user</span><span class="o">.</span><span class="n">admin?</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Notez que l'action <code>destroy</code> action utilise la [<em>méthode de chaînes</em>][<em>method chaining</em>] (vue brièvement dans la <a class="ref" href="rails-flavored-ruby#sec:objects_and_message_passing">Section&nbsp;4.2.3</a>) dans la ligne&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">destroy</span>
</pre></div>
</div>


<p>… ce qui fait l'économie d'une ligne de code.</p>

<p>À ce point de développement, tous les tests devraient réussir, et la ressource `Users`&mdash;avec son contrôleur, son modèle et ses vues&mdash;est fonctionnellement complète.</p>

<h2><a id="sec:10.5" href="updating-showing-and-deleting-users#sec:10.5" class="heading"><span class="number">10.5</span> Conclusion</a></h2>


<p>Nous avons parcouru un long chemin [depuis l'introduction d'un contrôleur d'utilisateur dans la][since introducing the Users controller way back in] <a class="ref" href="filling-in-the-layout#sec:user_signup">Section&nbsp;5.3</a>. Ce utilisateurs ne pouvaient même pas s'inscrire, d'identifier, se déconnecter, voir leur profil, l'éditer, et voir une liste de tous les utilisateurs&mdash;et certains peuvent même en supprimer d'autres.</p>

<p>La suite de ce livre va se construire sur les fondations de cette ressource utilisateurs (et le système d'authentification) pour faire un site avec des micro-messages comme dans (<a class="ref" href="user-microposts#top">Chapitre&nbsp;11</a>) et la possibilité de suivre des utilisateurs (<a class="ref" href="following-users#top">Chapitre&nbsp;12</a>). Ces chapitres introduiront certains des outils les plus puissants de Rails, introduisant le modelage de données (“data modeling”) avec <code>has_many</code> (“a plusieurs…”) et <code>has_many :through</code> (“a plusieurs… à travers…”).</p>

<p>Avant de pousuivre, assurez-vous de “merger” tous les changements dans la branche principale de développement&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">&quot;Done with user edit/update, index, and destroy actions&quot;</span>
<span class="gp">$</span> git checkout master
<span class="gp">$</span> git merge updating-users
</pre></div>
</div>


<p>Ça vaut aussi la peine de noter que ce chapitre a vu la dernière installation gem nécessaire. À titre d'indication, le <code>Gemfile</code> final est présenté dans l'<a class="ref" href="updating-showing-and-deleting-users#code:final_gemfile">extrait&nbsp;10.42</a>.</p>

<div class="label" id="code:final_gemfile"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 10.42.</span> <span class="description">Le <code>Gemfile</code> final de l'application.</span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_896a9415f160633c16c29d89eae681981468ffcc">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=source%20'http://rubygems.org'%0A%0Agem%20'rails',%20'3.0.4'%0Agem%20'sqlite3%2Druby',%20'1.3.2',%20:require%20=%3E%20'sqlite3'%0Agem%20'gravatar_image_tag',%20'1.0.0.pre2'%0Agem%20'will_paginate',%20'3.0.pre2'%0A%0Agroup%20:development%20do%0A%20%20gem%20'rspec%2Drails',%20'2.5.0'%0A%20%20gem%20'annotate%2Dmodels',%20'1.0.4'%0A%20%20gem%20'faker',%20'0.3.1'%0Aend%0A%0Agroup%20:test%20do%0A%20%20gem%20'rspec',%20'2.5.0'%0A%20%20gem%20'webrat',%20'0.7.1'%0A%20%20gem%20'spork',%20'0.8.4'%0A%20%20gem%20'factory_girl_rails',%20'1.0'%0Aend%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=source%20'http://rubygems.org'%0A%0Agem%20'rails',%20'3.0.4'%0Agem%20'sqlite3%2Druby',%20'1.3.2',%20:require%20=%3E%20'sqlite3'%0Agem%20'gravatar_image_tag',%20'1.0.0.pre2'%0Agem%20'will_paginate',%20'3.0.pre2'%0A%0Agroup%20:development%20do%0A%20%20gem%20'rspec%2Drails',%20'2.5.0'%0A%20%20gem%20'annotate%2Dmodels',%20'1.0.4'%0A%20%20gem%20'faker',%20'0.3.1'%0Aend%0A%0Agroup%20:test%20do%0A%20%20gem%20'rspec',%20'2.5.0'%0A%20%20gem%20'webrat',%20'0.7.1'%0A%20%20gem%20'spork',%20'0.8.4'%0A%20%20gem%20'factory_girl_rails',%20'1.0'%0Aend%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">&#39;http://rubygems.org&#39;</span>

<span class="n">gem</span> <span class="s1">&#39;rails&#39;</span><span class="p">,</span> <span class="s1">&#39;3.0.4&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;sqlite3-ruby&#39;</span><span class="p">,</span> <span class="s1">&#39;1.3.2&#39;</span><span class="p">,</span> <span class="ss">:require</span> <span class="o">=&gt;</span> <span class="s1">&#39;sqlite3&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;gravatar_image_tag&#39;</span><span class="p">,</span> <span class="s1">&#39;1.0.0.pre2&#39;</span>
<span class="n">gem</span> <span class="s1">&#39;will_paginate&#39;</span><span class="p">,</span> <span class="s1">&#39;3.0.pre2&#39;</span>

<span class="n">group</span> <span class="ss">:development</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;rspec-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;2.5.0&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;annotate-models&#39;</span><span class="p">,</span> <span class="s1">&#39;1.0.4&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;faker&#39;</span><span class="p">,</span> <span class="s1">&#39;0.3.1&#39;</span>
<span class="k">end</span>

<span class="n">group</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;rspec&#39;</span><span class="p">,</span> <span class="s1">&#39;2.5.0&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;webrat&#39;</span><span class="p">,</span> <span class="s1">&#39;0.7.1&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;spork&#39;</span><span class="p">,</span> <span class="s1">&#39;0.8.4&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;factory_girl_rails&#39;</span><span class="p">,</span> <span class="s1">&#39;1.0&#39;</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="sec:updating_deleting_exercises"></div>


<h2><a id="sec:10.6" href="updating-showing-and-deleting-users#sec:updating_deleting_exercises" class="heading"><span class="number">10.6</span> Exercises</a></h2>




<ol>

<li>Faite en sorte que le lien &ldquo;change&rdquo; du Gravatar, dans l'<a class="ref" href="updating-showing-and-deleting-users#code:user_edit_view">extrait&nbsp;10.3</a> s'ouvre dans une nouvelle fenêtre (ou un onglet). <em>Astuce&nbsp;:</em> Cherchez sur le wb&nbsp;; vous devriez trouver une méthode particulièrement robuste comportant quelque chose appelé <code>_blank</code> (“_vierge”). </li>

<li>Supprimer le code de formulaire redondant en restructurant les vues <code>new.html.erb</code> et <code>edit.html.erb</code> views pour utiliser un partiel dans l'<a class="ref" href="updating-showing-and-deleting-users#code:new_edit_partial">extrait&nbsp;10.43</a>. Notez que vous devrez passer la variable formulaire&nbsp;<code>f</code> de façon explicite comme variable locale, comme dans l'<a class="ref" href="updating-showing-and-deleting-users#code:new_user_with_partial">extrait&nbsp;10.44</a>.</li>

<li>Les utilisateurs identifiés n'ont aucune raison d'accéder aux actions <code>new</code> (“nouvel utilisateur”) et <code>create</code> (“créer l'utilisateur”) dans le contrôleur `User`. Faite en sorte qu'ils soient redirigés vers l'accueil s'ils tentent d'atteindre ces pages.</li>

<li>Ajoutez des tests pour vérifier que les liens de suppression dans l'<a class="ref" href="updating-showing-and-deleting-users#code:delete_links">extrait&nbsp;10.38</a> apparaissent pour les administrateurs et pas pour les utilisateurs normaux.</li>

<li>Modifier l'action <code>destroy</code> pour empêcher qu'un administrateur ne puisse se détruire lui-même (commencez par écrire le test).</li>

</ol>




<div class="label" id="code:new_edit_partial"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 10.43.</span> <span class="description">Un partiel pour les champs des formulaires `new` et `edit`. <br /> <code>app/views/users/_fields.html.erb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_a0cb4b03d7e198723e9a3f125008a3d3805a39a9">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=%3C%25=%20render%20'shared/error_messages',%20:object%20=%3E%20f.object%20%25%3E%0A%3Cdiv%20class=%22field%22%3E%0A%20%20%3C%25=%20f.label%20:name%20%25%3E%3Cbr%20/%3E%0A%20%20%3C%25=%20f.text_field%20:name%20%25%3E%0A%3C/div%3E%0A%3Cdiv%20class=%22field%22%3E%0A%20%20%3C%25=%20f.label%20:email%20%25%3E%3Cbr%20/%3E%0A%20%20%3C%25=%20f.text_field%20:email%20%25%3E%0A%3C/div%3E%0A%3Cdiv%20class=%22field%22%3E%0A%20%20%3C%25=%20f.label%20:password%20%25%3E%3Cbr%20/%3E%0A%20%20%3C%25=%20f.password_field%20:password%20%25%3E%0A%3C/div%3E%0A%3Cdiv%20class=%22field%22%3E%0A%20%20%3C%25=%20f.label%20:password_confirmation,%20%22Confirmation%22%20%25%3E%3Cbr%20/%3E%0A%20%20%3C%25=%20f.password_field%20:password_confirmation%20%25%3E%0A%3C/div%3E%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=%3C%25=%20render%20'shared/error_messages',%20:object%20=%3E%20f.object%20%25%3E%0A%3Cdiv%20class=%22field%22%3E%0A%20%20%3C%25=%20f.label%20:name%20%25%3E%3Cbr%20/%3E%0A%20%20%3C%25=%20f.text_field%20:name%20%25%3E%0A%3C/div%3E%0A%3Cdiv%20class=%22field%22%3E%0A%20%20%3C%25=%20f.label%20:email%20%25%3E%3Cbr%20/%3E%0A%20%20%3C%25=%20f.text_field%20:email%20%25%3E%0A%3C/div%3E%0A%3Cdiv%20class=%22field%22%3E%0A%20%20%3C%25=%20f.label%20:password%20%25%3E%3Cbr%20/%3E%0A%20%20%3C%25=%20f.password_field%20:password%20%25%3E%0A%3C/div%3E%0A%3Cdiv%20class=%22field%22%3E%0A%20%20%3C%25=%20f.label%20:password_confirmation,%20%22Confirmation%22%20%25%3E%3Cbr%20/%3E%0A%20%20%3C%25=%20f.password_field%20:password_confirmation%20%25%3E%0A%3C/div%3E%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/error_messages&#39;</span><span class="p">,</span> <span class="ss">:object</span> <span class="o">=&gt;</span> <span class="n">f</span><span class="o">.</span><span class="n">object</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;field&quot;</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:name</span> <span class="cp">%&gt;</span><span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:name</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;field&quot;</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:email</span> <span class="cp">%&gt;</span><span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;field&quot;</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password</span> <span class="cp">%&gt;</span><span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;field&quot;</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="s2">&quot;Confirmation&quot;</span> <span class="cp">%&gt;</span><span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password_confirmation</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div></div>




<div class="label" id="code:new_user_with_partial"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 10.44.</span> <span class="description">La vue pour un nouvelle utilisateur avec le partiel. <br /> <code>app/views/users/new.html.erb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_fc725d2e6e33c1450425cd3477440529dc438352">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=%3Ch1%3ESign%20up%3C/h1%3E%0A%0A%3C%25=%20form_for(@user)%20do%20%7Cf%7C%20%25%3E%0A%20%20%3C%25=%20render%20'fields',%20:f%20=%3E%20f%20%25%3E%0A%20%20%3Cdiv%20class=%22actions%22%3E%0A%20%20%20%20%3C%25=%20f.submit%20%22Sign%20up%22%20%25%3E%0A%20%20%3C/div%3E%0A%3C%25%20end%20%25%3E%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=%3Ch1%3ESign%20up%3C/h1%3E%0A%0A%3C%25=%20form_for(@user)%20do%20%7Cf%7C%20%25%3E%0A%20%20%3C%25=%20render%20'fields',%20:f%20=%3E%20f%20%25%3E%0A%20%20%3Cdiv%20class=%22actions%22%3E%0A%20%20%20%20%3C%25=%20f.submit%20%22Sign%20up%22%20%25%3E%0A%20%20%3C/div%3E%0A%3C%25%20end%20%25%3E%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>Sign up<span class="nt">&lt;/h1&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;fields&#39;</span><span class="p">,</span> <span class="ss">:f</span> <span class="o">=&gt;</span> <span class="n">f</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;actions&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">&quot;Sign up&quot;</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>




<div class="navigation">  <a class="prev_page" href="sign-in-sign-out#top">
    &laquo;&nbsp;<span class="number">Chapitre 9</span> S'identifier, se déconnecter
  </a>
  <a class="next_page" href="user-microposts#top">
    <span class="number">Chapitre 11</span> User microposts&nbsp;&raquo;
  </a>
</div><div class="footnotes">
<ol>
<li id="fn:10.1">Image from <a href="http://www.flickr.com/photos/sashawolff/4598355045/">http://www.flickr.com/photos/sashawolff/4598355045/</a>.&nbsp;<a class="arrow" href="#fnref:10.1">&uarr;</a></li>
<li id="fn:10.2">Le site Gravatar redirige en fait cette adresse vers <a href="http://en.gravatar.com/emails"><tt>http://en.gravatar.com/emails</tt></a>, qui concerne les utilisateurs de langue anglaise, mais j'ai volontairement omis d'ajouter <tt>en</tt> au compte pour l'utilisation par des utilisateurs d'autres langages.&nbsp;<a class="arrow" href="#fnref:10.2">&uarr;</a></li>
<li id="fn:10.3">Image de <a href="http://www.flickr.com/photos/sashawolff/4598355045/">http://www.flickr.com/photos/sashawolff/4598355045/</a>.&nbsp;<a class="arrow" href="#fnref:10.3">&uarr;</a></li>
<li id="fn:10.4">Ne vous souciez de comment cela fonctionne&nbsp;; les détails concernent les développeurs du framework Rails eux-même, mais ne sont pas important, à dessein, pour les développeurs d'applications.&nbsp;<a class="arrow" href="#fnref:10.4">&uarr;</a></li>
<li id="fn:10.5">Le code de cette section est adapté du gem <a href="http://github.com/thoughtbot/clearance">Clearance</a> par <a href="http://thoughtbot.com/">thoughtbot</a>.&nbsp;<a class="arrow" href="#fnref:10.5">&uarr;</a></li>
<li id="fn:10.6">Vraiment, comme indiqué dans la <a class="ref" href="sign-in-sign-out#sec:sign_in_out_exercises">Section&nbsp;9.6</a>, <code>session</code> est juste implémentée de cette façon.&nbsp;<a class="arrow" href="#fnref:10.6">&uarr;</a></li>
<li id="fn:10.7">Photo Baby de <a href="http://www.flickr.com/photos/glasgows/338937124/">http://www.flickr.com/photos/glasgows/338937124/</a>.&nbsp;<a class="arrow" href="#fnref:10.7">&uarr;</a></li>
<li id="fn:10.8">Techniquement parlant, nous n'avons besoin que d'ajouter 28 utilisateurs fictifs, puisque nous en avons déjà trois, mais je trouve le sens plus clair si nous en ajoutons plutôt 30.&nbsp;<a class="arrow" href="#fnref:10.8">&uarr;</a></li>
<li id="fn:10.9">Le nom <code>user</code> est immatériel&mdash;nous aurions pu tout aussi bien écrire <code>@users.each do |foobar|</code> et utiliser alors  <code>render foobar</code>. La clé est la <em>classe</em> de l'objet dans ce cas, <code>User</code>.&nbsp;<a class="arrow" href="#fnref:10.9">&uarr;</a></li>
<li id="fn:10.10">La méthode <code>toggle!</code> invoque les “callbacks” de Active Record mais pas les validations, donc nous devons renseigner l'attribut  <code>password</code> (mais pas la confirmation de ce mot de passe) pour avoir un mot de passe non vide dans la fonction callback <code>encrypt_password</code>.&nbsp;<a class="arrow" href="#fnref:10.10">&uarr;</a></li>
<li id="fn:10.11">Des outils en ligne de commande tels que <tt>curl</tt> (vue dans la <a class="ref" href="static-pages#sidebar:response_codes">Box&nbsp;3.2</a>) peut utiliser les requêtes <tt>PUT</tt> de cette forme.&nbsp;<a class="arrow" href="#fnref:10.11">&uarr;</a></li>
<li id="fn:10.12">Cela signifie que le lien pour supprimer un utilisateur ne fonctionnera pas si l'utilisateur a JavaScript désactivé dans son navigateur. Si vous devez traiter le cas de navigateur sans JavaScript, vous pouvez simuler une requête <tt>DELETE</tt> en utilisant la forme d'une requête <tt>POST</tt>, laquelle fonctionne même sans JavaScript&nbsp;; consultez le  Railscast sur la &ldquo;<a href="http://railscasts.com/episodes/77-destroy-without-javascript">Destruction sans JavaScript</a>&rdquo; pour les détails.&nbsp;<a class="arrow" href="#fnref:10.12">&uarr;</a></li>
</ol>
</div>