<!--
	chapitre : 9 Connexion, déconnexion
-->

<h1 class="title">Tutoriel Ruby on Rails </h1>


<h1 class="subtitle">  Apprendre Rails par l'exemple</h1>


<h2 class="author">Michael Hartl</h2>



<h1 class="contents">Contenu</h1>


<div id="table_of_contents"><ol>
<li class="chapter"><a href="beginning#top"><span class="number">Chapitre 1</span> De zéro au déploiement</a></li>
<li><ol>
<li class="section"><a href="beginning#sec:introduction"><span class="number">1.1</span> Introduction</a></li>
<li><ol>
<li class="subsection"><a href="beginning#sec:comments_for_various_readers"><span class="number">1.1.1</span> Commentaires pour les lecteurs différents</a></li>
<li class="subsection"><a href="beginning#sec:1.1.2"><span class="number">1.1.2</span> «&nbsp;Dimensionner&nbsp;» Rails</a></li>
<li class="subsection"><a href="beginning#sec:conventions"><span class="number">1.1.3</span> Conventions utilisées dans ce livre</a></li></ol></li>
<li class="section"><a href="beginning#sec:up_and_running"><span class="number">1.2</span> [(Up and running)(En route pour le démarrage)]</a></li>
<li><ol>
<li class="subsection"><a href="beginning#sec:development_tools"><span class="number">1.2.1</span> Environnements de développement</a></li>
<li><ol>
<li class="subsubsection"><a href="beginning#sec:1.2.1.1">IDEs</a></li>
<li class="subsubsection"><a href="beginning#sec:1.2.1.2">Éditeurs de texte et lignes de commande</a></li>
<li class="subsubsection"><a href="beginning#sec:1.2.1.3">Navigateurs</a></li>
<li class="subsubsection"><a href="beginning#sec:1.2.1.4">Note à propos des outils</a></li></ol></li>
<li class="subsection"><a href="beginning#sec:rubygems"><span class="number">1.2.2</span> Ruby, RubyGems, Rails, et Git</a></li>
<li><ol>
<li class="subsubsection"><a href="beginning#sec:rails_installer_windows">Installation de Rails (Windows)</a></li>
<li class="subsubsection"><a href="beginning#sec:install_git">Installer Git</a></li>
<li class="subsubsection"><a href="beginning#sec:install_ruby">Installer Ruby</a></li>
<li class="subsubsection"><a href="beginning#sec:install_rubygems">Installer RubyGems</a></li>
<li class="subsubsection"><a href="beginning#sec:install_rails">Installer Rails</a></li></ol></li>
<li class="subsection"><a href="beginning#sec:the_first_application"><span class="number">1.2.3</span> La première application</a></li>
<li class="subsection"><a href="beginning#sec:bundler"><span class="number">1.2.4</span> Bundler</a></li>
<li class="subsection"><a href="beginning#sec:rails_server"><span class="number">1.2.5</span> <code>Le serveur rails (rails server)</code></a></li>
<li class="subsection"><a href="beginning#sec:mvc"><span class="number">1.2.6</span> Modèles-Vue-Contrôleur (MVC)</a></li></ol></li>
<li class="section"><a href="beginning#sec:version_control"><span class="number">1.3</span> Contrôle de versions avec Git</a></li>
<li><ol>
<li class="subsection"><a href="beginning#sec:git_setup"><span class="number">1.3.1</span> Installation et réglages</a></li>
<li><ol>
<li class="subsubsection"><a href="beginning#sec:1.3.1.1">Initialisation des réglages système</a></li>
<li class="subsubsection"><a href="beginning#sec:1.3.1.2">Initialisation des réglages du dépôt (repository)</a></li></ol></li>
<li class="subsection"><a href="beginning#sec:adding_and_committing"><span class="number">1.3.2</span> Ajout et mandat de dépôt</a></li>
<li class="subsection"><a href="beginning#sec:1.3.3"><span class="number">1.3.3</span> Qu'est-ce que Git peut faire de bien pour vous&nbsp;?</a></li>
<li class="subsection"><a href="beginning#sec:github"><span class="number">1.3.4</span> GitHub</a></li>
<li class="subsection"><a href="beginning#sec:git_commands"><span class="number">1.3.5</span> Branch, edit, commit, merge</a></li>
<li><ol>
<li class="subsubsection"><a href="beginning#sec:git_branch">Branch</a></li>
<li class="subsubsection"><a href="beginning#sec:git_edit">Edit</a></li>
<li class="subsubsection"><a href="beginning#sec:git_commit">Commit</a></li>
<li class="subsubsection"><a href="beginning#sec:git_merge">Merge</a></li>
<li class="subsubsection"><a href="beginning#sec:git_push">Push</a></li></ol></li></ol></li>
<li class="section"><a href="beginning#sec:deploying"><span class="number">1.4</span> Déploiement</a></li>
<li><ol>
<li class="subsection"><a href="beginning#sec:1.4.1"><span class="number">1.4.1</span> Réglages Heroku</a></li>
<li class="subsection"><a href="beginning#sec:heroku_step_one"><span class="number">1.4.2</span> déploiement Heroku, première étape</a></li>
<li class="subsection"><a href="beginning#sec:1.4.3"><span class="number">1.4.3</span> Déploiement Heroku deployment, seconde étape</a></li>
<li class="subsection"><a href="beginning#sec:heroku_commands"><span class="number">1.4.4</span> Commandes Heroku</a></li></ol></li>
<li class="section"><a href="beginning#sec:beginning_conclusion"><span class="number">1.5</span> Conclusion</a></li></ol></li>
<li class="chapter"><a href="a-demo-app#top"><span class="number">Chapitre 2</span> Une application démo</a></li>
<li><ol>
<li class="section"><a href="a-demo-app#sec:planning_the_application"><span class="number">2.1</span> Planifier l'application</a></li>
<li><ol>
<li class="subsection"><a href="a-demo-app#sec:modeling_users"><span class="number">2.1.1</span> Modéliser les utilisateurs</a></li>
<li class="subsection"><a href="a-demo-app#sec:modeling_microposts"><span class="number">2.1.2</span> Modéliser les micro-messages</a></li></ol></li>
<li class="section"><a href="a-demo-app#sec:demo_users_resource"><span class="number">2.2</span> La ressource Utilisateurs (Users)</a></li>
<li><ol>
<li class="subsection"><a href="a-demo-app#sec:a_user_tour"><span class="number">2.2.1</span> Un tour de l'utilisateur</a></li>
<li class="subsection"><a href="a-demo-app#sec:mvc_in_action"><span class="number">2.2.2</span> MVC en action</a></li>
<li class="subsection"><a href="a-demo-app#sec:weaknesses_of_this_users_resource"><span class="number">2.2.3</span> Faiblesses de la ressource Utilisateurs (Users)</a></li></ol></li>
<li class="section"><a href="a-demo-app#sec:microposts_resource"><span class="number">2.3</span> La ressource Micro-messages (Microposts)</a></li>
<li><ol>
<li class="subsection"><a href="a-demo-app#sec:a_micropost_microtour"><span class="number">2.3.1</span> Un petit tour du micro-message</a></li>
<li class="subsection"><a href="a-demo-app#sec:putting_the_micro_in_microposts"><span class="number">2.3.2</span> Appliquer le <em>micro</em> aux micro-messages</a></li>
<li class="subsection"><a href="a-demo-app#sec:demo_user_has_many_microposts"><span class="number">2.3.3</span> Un utilisateur <code>has_many</code> (<code>possède plusieurs</code>) micro-messages</a></li>
<li class="subsection"><a href="a-demo-app#sec:inheritance_hierarchies"><span class="number">2.3.4</span> Hiérarchie des héritages</a></li>
<li class="subsection"><a href="a-demo-app#sec:deploying_the_demo_app"><span class="number">2.3.5</span> Déployer l'application Démo</a></li></ol></li>
<li class="section"><a href="a-demo-app#sec:2.4"><span class="number">2.4</span> Conclusion</a></li></ol></li>
<li class="chapter"><a href="static-pages#top"><span class="number">Chapitre 3</span> Pages statiques courantes</a></li>
<li><ol>
<li class="section"><a href="static-pages#sec:static_pages"><span class="number">3.1</span> Pages statiques</a></li>
<li><ol>
<li class="subsection"><a href="static-pages#sec:truly_static_pages"><span class="number">3.1.1</span> Pages HTML statiques</a></li>
<li class="subsection"><a href="static-pages#sec:static_pages_with_rails"><span class="number">3.1.2</span> Les pages statiques avec Rails</a></li></ol></li>
<li class="section"><a href="static-pages#sec:first_tests"><span class="number">3.2</span> Premiers tests</a></li>
<li><ol>
<li class="subsection"><a href="static-pages#sec:testing_tools"><span class="number">3.2.1</span> Outils de test</a></li>
<li><ol>
<li class="subsubsection"><a href="static-pages#sec:autotest">Auto-test</a></li></ol></li>
<li class="subsection"><a href="static-pages#sec:TDD"><span class="number">3.2.2</span> TDD : Rouge, Vert, Refactor</a></li>
<li><ol>
<li class="subsubsection"><a href="static-pages#sec:spork">Spork</a></li>
<li class="subsubsection"><a href="static-pages#sec:red">Rouge</a></li>
<li class="subsubsection"><a href="static-pages#sec:green">Vert</a></li>
<li class="subsubsection"><a href="static-pages#sec:refactor">Refactor</a></li></ol></li></ol></li>
<li class="section"><a href="static-pages#sec:slightly_dynamic_pages"><span class="number">3.3</span> Pages (un peu) dynamiques</a></li>
<li><ol>
<li class="subsection"><a href="static-pages#sec:testing_a_title_change"><span class="number">3.3.1</span> Test d'un changement de titre</a></li>
<li class="subsection"><a href="static-pages#sec:passing_title_tests"><span class="number">3.3.2</span> Réussir les tests de titre</a></li>
<li class="subsection"><a href="static-pages#sec:instance_variables_embedded_ruby"><span class="number">3.3.3</span> Variables d'instance et Ruby embarqué</a></li>
<li class="subsection"><a href="static-pages#sec:layouts"><span class="number">3.3.4</span> Supprimer les répétitions avec les <em>layouts</em></a></li></ol></li>
<li class="section"><a href="static-pages#sec:static_pages_conclusion"><span class="number">3.4</span> Conclusion</a></li>
<li class="section"><a href="static-pages#sec:static_pages_Exercices"><span class="number">3.5</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="rails-flavored-ruby#top"><span class="number">Chapitre 4</span> [(Rails-flavored Ruby)(Rails au goût Ruby)]</a></li>
<li><ol>
<li class="section"><a href="rails-flavored-ruby#sec:motivation"><span class="number">4.1</span> Motivation</a></li>
<li><ol>
<li class="subsection"><a href="rails-flavored-ruby#sec:title_helper"><span class="number">4.1.1</span> Un « helper » (« aideur ») pour le titre (<code>titre</code>)</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:cascading_style_sheets"><span class="number">4.1.2</span> Feuilles de styles (CSS — Cascading Style Sheets)</a></li></ol></li>
<li class="section"><a href="rails-flavored-ruby#sec:strings_and_methods"><span class="number">4.2</span> Chaines de caractères et méthodes</a></li>
<li><ol>
<li class="subsection"><a href="rails-flavored-ruby#sec:comments"><span class="number">4.2.1</span> Commentaires</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:strings"><span class="number">4.2.2</span> Chaines de caractères</a></li>
<li><ol>
<li class="subsubsection"><a href="rails-flavored-ruby#sec:printing">Impression</a></li>
<li class="subsubsection"><a href="rails-flavored-ruby#sec:single_quoted_strings">Chaines de caractères « single-quoté »</a></li></ol></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:objects_and_message_passing"><span class="number">4.2.3</span> Objets et passage de message</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:method_definitions"><span class="number">4.2.4</span> Définition de méthode</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:back_to_the_title_helper"><span class="number">4.2.5</span> Retour à l'« helper » de titre</a></li></ol></li>
<li class="section"><a href="rails-flavored-ruby#sec:other_data_structures"><span class="number">4.3</span> Autres structures de données</a></li>
<li><ol>
<li class="subsection"><a href="rails-flavored-ruby#sec:arrays_and_ranges"><span class="number">4.3.1</span> Tableaux et rangs</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:blocks"><span class="number">4.3.2</span> Blocs</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:hashes_and_symbols"><span class="number">4.3.3</span> Tables de hachage et symboles</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:css_revisited"><span class="number">4.3.4</span> CSS revisitées</a></li></ol></li>
<li class="section"><a href="rails-flavored-ruby#sec:ruby_classes"><span class="number">4.4</span> Classes Ruby</a></li>
<li><ol>
<li class="subsection"><a href="rails-flavored-ruby#sec:constructors"><span class="number">4.4.1</span> Constructeurs</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:a_class_of_our_own"><span class="number">4.4.2</span> Héritages de classes</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:modifying_built_in_classes"><span class="number">4.4.3</span> Modifier les classes d'origine</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:a_controller_class"><span class="number">4.4.4</span> Classe de contrôleur</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:a_user_class"><span class="number">4.4.5</span> Classe utiliateur</a></li></ol></li>
<li class="section"><a href="rails-flavored-ruby#sec:Exercices"><span class="number">4.5</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="filling-in-the-layout#top"><span class="number">Chapitre 5</span> Poursuivre la mise en page</a></li>
<li><ol>
<li class="section"><a href="filling-in-the-layout#sec:structure"><span class="number">5.1</span> Ajout de structure</a></li>
<li><ol>
<li class="subsection"><a href="filling-in-the-layout#sec:adding_to_the_layout"><span class="number">5.1.1</span> Navigation du site</a></li>
<li class="subsection"><a href="filling-in-the-layout#sec:custom_css"><span class="number">5.1.2</span> Personnalisation CSS</a></li>
<li class="subsection"><a href="filling-in-the-layout#sec:partials"><span class="number">5.1.3</span> Partiels (Partials)</a></li></ol></li>
<li class="section"><a href="filling-in-the-layout#sec:layout_links"><span class="number">5.2</span> Liens pour la mise en page</a></li>
<li><ol>
<li class="subsection"><a href="filling-in-the-layout#sec:integration_tests"><span class="number">5.2.1</span> Test d'intégration</a></li>
<li class="subsection"><a href="filling-in-the-layout#sec:rails_routes"><span class="number">5.2.2</span> Routes Rails</a></li>
<li class="subsection"><a href="filling-in-the-layout#sec:named_routes"><span class="number">5.2.3</span> Nommer les routes</a></li></ol></li>
<li class="section"><a href="filling-in-the-layout#sec:user_signup"><span class="number">5.3</span> Inscription de l'utilisateur : une première étape</a></li>
<li><ol>
<li class="subsection"><a href="filling-in-the-layout#sec:users_controller"><span class="number">5.3.1</span> Contrôleur Utilisateur (Users controller)</a></li>
<li class="subsection"><a href="filling-in-the-layout#sec:signup_url"><span class="number">5.3.2</span> URL d'inscription</a></li></ol></li>
<li class="section"><a href="filling-in-the-layout#sec:layout_conclusion"><span class="number">5.4</span> Conclusion</a></li>
<li class="section"><a href="filling-in-the-layout#sec:layout_Exercices"><span class="number">5.5</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="modeling-and-viewing-users-one#top"><span class="number">Chapitre 6</span> Modéliser et afficher les utilisateurs, partie I</a></li>
<li><ol>
<li class="section"><a href="modeling-and-viewing-users-one#sec:user_model"><span class="number">6.1</span> Modèle utilisateur (User model)</a></li>
<li><ol>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:database_migrations"><span class="number">6.1.1</span> Migrations de la base de données</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:the_model_file"><span class="number">6.1.2</span> Le fichier modèle</a></li>
<li><ol>
<li class="subsubsection"><a href="modeling-and-viewing-users-one#sec:model_annotation">[(Model annotation)]</a></li>
<li class="subsubsection"><a href="modeling-and-viewing-users-one#sec:accessible_attributes">Attributs accessibles</a></li></ol></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:creating_user_objects"><span class="number">6.1.3</span> Créer des objets Utilisateur</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:finding_user_objects"><span class="number">6.1.4</span> Recherche dans les objets Utilisateurs (Users)</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:updating_user_objects"><span class="number">6.1.5</span> Actualisation des objets Utilisateurs (Users)</a></li></ol></li>
<li class="section"><a href="modeling-and-viewing-users-one#sec:user_validations"><span class="number">6.2</span> Validations utilisateur</a></li>
<li><ol>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:presence_validation"><span class="number">6.2.1</span> Valider l'existence</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:length_validation"><span class="number">6.2.2</span> Valider la longueur</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:format_validation"><span class="number">6.2.3</span> Valider le format</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:uniqueness_validation"><span class="number">6.2.4</span> Valider l'unicité</a></li>
<li><ol>
<li class="subsubsection"><a href="modeling-and-viewing-users-one#sec:the_caveat">L'avertissement d'unicité</a></li></ol></li></ol></li>
<li class="section"><a href="modeling-and-viewing-users-one#sec:viewing_users"><span class="number">6.3</span> Afficher les utilisateurs</a></li>
<li><ol>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:rails_environments"><span class="number">6.3.1</span> Débuggage et environnements Rails</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:users_show"><span class="number">6.3.2</span> Modèle, Vue et Contrôleur Utilisateur</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:a_users_resource"><span class="number">6.3.3</span> Ressource Utilisateurs</a></li>
<li><ol>
<li class="subsubsection"><a href="modeling-and-viewing-users-one#sec:params_in_debug">[(<code>params</code> in <code>debug</code>)]</a></li></ol></li></ol></li>
<li class="section"><a href="modeling-and-viewing-users-one#sec:6.4"><span class="number">6.4</span> Conclusion</a></li>
<li class="section"><a href="modeling-and-viewing-users-one#sec:6.5"><span class="number">6.5</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="modeling-and-viewing-users-two#top"><span class="number">Chapitre 7</span> Modéliser et afficher les utilisateurs, partie II</a></li>
<li><ol>
<li class="section"><a href="modeling-and-viewing-users-two#sec:insecure_passwords"><span class="number">7.1</span> Mots de passe non sûrs</a></li>
<li><ol>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:password_validations"><span class="number">7.1.1</span> Valider le mot de passe</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:password_migration"><span class="number">7.1.2</span> Migrer un mot de passe</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:an_active_record_fonction de rappel"><span class="number">7.1.3</span> Un <em>fonction de rappel</em> de l'Active Record</a></li></ol></li>
<li class="section"><a href="modeling-and-viewing-users-two#sec:secure_passwords"><span class="number">7.2</span> Sécuriser les mots de passe</a></li>
<li><ol>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:a_secure_password_test"><span class="number">7.2.1</span> Test de mot de passe sûr</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:secure_password_theory"><span class="number">7.2.2</span> Un peu de théorie sur la sécurisation des mots de passe</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:implementing_has_password"><span class="number">7.2.3</span> Implémenter la méthode <code>has_password?</code></a></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:an_authenticate_method"><span class="number">7.2.4</span> Méthode d'authentification</a></li></ol></li>
<li class="section"><a href="modeling-and-viewing-users-two#sec:better_user_views"><span class="number">7.3</span> Meilleures vues d'utilisateurs</a></li>
<li><ol>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:tests_with_factories"><span class="number">7.3.1</span> Tester la page de l'utilisateur (avec <em>factories</em>)</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:a_name_and_a_gravatar"><span class="number">7.3.2</span> Un nom et un Gravatar</a></li>
<li><ol>
<li class="subsubsection"><a href="modeling-and-viewing-users-two#sec:a_gravatar_helper">Un « helper » de Gravatar</a></li></ol></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:a_user_sidebar"><span class="number">7.3.3</span> Une barre utilisateur latérale</a></li></ol></li>
<li class="section"><a href="modeling-and-viewing-users-two#sec:7.4"><span class="number">7.4</span> Conclusion</a></li>
<li><ol>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:7.4.1"><span class="number">7.4.1</span> Dépôt Git</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:heroku_deploy"><span class="number">7.4.2</span> Déploiement Heroku</a></li></ol></li>
<li class="section"><a href="modeling-and-viewing-users-two#sec:more_modeling_users_Exercices"><span class="number">7.5</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="sign-up#top"><span class="number">Chapitre 8</span> Inscription</a></li>
<li><ol>
<li class="section"><a href="sign-up#sec:signup_form"><span class="number">8.1</span> Formulaire d'inscription</a></li>
<li><ol>
<li class="subsection"><a href="sign-up#sec:using_form_for"><span class="number">8.1.1</span> Utiliser  <code>form_for</code></a></li>
<li class="subsection"><a href="sign-up#sec:the_form_html"><span class="number">8.1.2</span> Le formulaire HTML</a></li></ol></li>
<li class="section"><a href="sign-up#sec:signup_failure"><span class="number">8.2</span> Échec de l'inscription</a></li>
<li><ol>
<li class="subsection"><a href="sign-up#sec:testing_failure"><span class="number">8.2.1</span> Test de l'échec</a></li>
<li class="subsection"><a href="sign-up#sec:a_working_form"><span class="number">8.2.2</span> Un formulaire fonctionnel</a></li>
<li class="subsection"><a href="sign-up#sec:signup_error_messages"><span class="number">8.2.3</span> Inscription&nbsp;: messages d'erreur</a></li>
<li class="subsection"><a href="sign-up#sec:filtering_parameter_logging"><span class="number">8.2.4</span> Filtrer les paramètres d'identification</a></li></ol></li>
<li class="section"><a href="sign-up#sec:signup_success"><span class="number">8.3</span> Succès de l'inscription</a></li>
<li><ol>
<li class="subsection"><a href="sign-up#sec:testing_success"><span class="number">8.3.1</span> Tester le succès de l'inscription</a></li>
<li class="subsection"><a href="sign-up#sec:the_finished_signup_form"><span class="number">8.3.2</span> Le formulaire d'inscription finalisé</a></li>
<li class="subsection"><a href="sign-up#sec:the_flash"><span class="number">8.3.3</span> Le message «&nbsp;flash&nbsp;»</a</a></li>
<li class="subsection"><a href="sign-up#sec:the_first_signup"><span class="number">8.3.4</span> La première inscription</a></li></ol></li>
<li class="section"><a href="sign-up#sec:rspec_integration_tests"><span class="number">8.4</span> Test d'intégration RSpec</a></li>
<li><ol>
<li class="subsection"><a href="sign-up#sec:integration_tests_with_style"><span class="number">8.4.1</span> Tests d'intégration avec les styles</a></li>
<li class="subsection"><a href="sign-up#sec:failed_signup"><span class="number">8.4.2</span> Un échec d'inscription ne devrait pas créer un nouvel utilisateur</a></li>
<li class="subsection"><a href="sign-up#sec:successful_signup"><span class="number">8.4.3</span> Le succès d'une inscription devrait créer un nouvel utilisateur</a></li></ol></li>
<li class="section"><a href="sign-up#sec:8.5"><span class="number">8.5</span> Conclusion</a></li>
<li class="section"><a href="sign-up#sec:signup_Exercices"><span class="number">8.6</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="sign-in-sign-out#top"><span class="number">Chapitre 9</span> Connexion, déconnexion</a></li>
<li><ol>
<li class="section"><a href="sign-in-sign-out#sec:sessions"><span class="number">9.1</span> Les sessions</a></li>
<li><ol>
<li class="subsection"><a href="sign-in-sign-out#sec:sessions_controller"><span class="number">9.1.1</span> Le contrôleur de session</a></li>
<li class="subsection"><a href="sign-in-sign-out#sec:signin_form"><span class="number">9.1.2</span> Formulaire d'identification</a></li></ol></li>
<li class="section"><a href="sign-in-sign-out#sec:signin_failure"><span class="number">9.2</span> Échec de l'identification</a></li>
<li><ol>
<li class="subsection"><a href="sign-in-sign-out#sec:reviewing_form_submission"><span class="number">9.2.1</span> Examen de la soumission du formulaire</a></li>
<li class="subsection"><a href="sign-in-sign-out#sec:failed_signin"><span class="number">9.2.2</span> Échec de l'identification (test et code)</a></li></ol></li>
<li class="section"><a href="sign-in-sign-out#sec:signin_success"><span class="number">9.3</span> Succès de l'identification</a></li>
<li><ol>
<li class="subsection"><a href="sign-in-sign-out#sec:the_completed_create_action"><span class="number">9.3.1</span> L'action <code>create</code> («&nbsp;créer&nbsp;») finalisée</a></li>
<li class="subsection"><a href="sign-in-sign-out#sec:remember_me"><span class="number">9.3.2</span> Se souvenir de moi</a></li>
<li class="subsection"><a href="sign-in-sign-out#sec:current_user"><span class="number">9.3.3</span> Utilisateur courant</a></li></ol></li>
<li class="section"><a href="sign-in-sign-out#sec:signing_out"><span class="number">9.4</span> Déconnexion</a></li>
<li><ol>
<li class="subsection"><a href="sign-in-sign-out#sec:destroying_sessions"><span class="number">9.4.1</span> Détruire la session</a></li>
<li class="subsection"><a href="sign-in-sign-out#sec:signin_upon_signup"><span class="number">9.4.2</span> Connection à l'inscription</a></li>
<li class="subsection"><a href="sign-in-sign-out#sec:changing_the_layout_links"><span class="number">9.4.3</span> Changement des liens de la mise en plage</a></li>
<li class="subsection"><a href="sign-in-sign-out#sec:signin_out_integration_tests"><span class="number">9.4.4</span> Test d'intégration de l'identification/déconnexion</a></li></ol></li>
<li class="section"><a href="sign-in-sign-out#sec:9.5"><span class="number">9.5</span> Conclusion</a></li>
<li class="section"><a href="sign-in-sign-out#sec:sign_in_out_Exercices"><span class="number">9.6</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="updating-showing-and-deleting-users#top"><span class="number">Chapitre 10</span> Actualiser, afficher et supprimer de l'utilisateur</a></li>
<li><ol>
<li class="section"><a href="updating-showing-and-deleting-users#sec:updating_users"><span class="number">10.1</span> Actualiser l'utilisateur</a></li>
<li><ol>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:edit_form"><span class="number">10.1.1</span> Formulaire de modification</a></li>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:enabling_edits"><span class="number">10.1.2</span> Permettre les modifications</a></li></ol></li>
<li class="section"><a href="updating-showing-and-deleting-users#sec:protecting_pages"><span class="number">10.2</span> Protéger les pages</a></li>
<li><ol>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:requiring_signed_in_users"><span class="number">10.2.1</span> Utilisateurs identifiés requis</a></li>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:requiring_the_right_user"><span class="number">10.2.2</span> Nécessité du bon utilisateur</a></li>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:friendly_forwarding"><span class="number">10.2.3</span> Redirection conviviale</a></li></ol></li>
<li class="section"><a href="updating-showing-and-deleting-users#sec:showing_users"><span class="number">10.3</span> Afficher les utilisateurs</a></li>
<li><ol>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:user_index"><span class="number">10.3.1</span> Liste des utilisateurs</a></li>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:sample_users"><span class="number">10.3.2</span> Exemples d'utilisateurs</a></li>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:pagination"><span class="number">10.3.3</span> Pagination</a></li>
<li><ol>
<li class="subsubsection"><a href="updating-showing-and-deleting-users#sec:testing_pagination">Test de la pagination</a></li></ol></li>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:partial_refactoring"><span class="number">10.3.4</span> Restructuration des partielles</a></li></ol></li>
<li class="section"><a href="updating-showing-and-deleting-users#sec:destroying_users"><span class="number">10.4</span> Supprimer des utilisateurs</a></li>
<li><ol>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:administrative_users"><span class="number">10.4.1</span> Utilisateurs administrateurs</a></li>
<li><ol>
<li class="subsubsection"><a href="updating-showing-and-deleting-users#sec:revisiting_attr_accessible">Révision de <code>attr_accessible</code></a></li></ol></li>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:the_destroy_action"><span class="number">10.4.2</span> L'action <code>destroy</code> («&nbsp;supprimer&nbsp;»)</a></li></ol></li>
<li class="section"><a href="updating-showing-and-deleting-users#sec:10.5"><span class="number">10.5</span> Conclusion</a></li>
<li class="section"><a href="updating-showing-and-deleting-users#sec:updating_deleting_Exercices"><span class="number">10.6</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="user-microposts#top"><span class="number">Chapitre 11</span> Micro-messages d'utilisateur</a></li>
<li><ol>
<li class="section"><a href="user-microposts#sec:a_micropost_model"><span class="number">11.1</span> Le modèle Micropost («&nbsp;Micro-message&nbsp;»)</a></li>
<li><ol>
<li class="subsection"><a href="user-microposts#sec:the_basic_model"><span class="number">11.1.1</span> Le modèle initial</a></li>
<li><ol>
<li class="subsubsection"><a href="user-microposts#sec:accessible_attribute">Attributs accessibles</a></li></ol></li>
<li class="subsection"><a href="user-microposts#sec:user_micropost_associations"><span class="number">11.1.2</span> Associations Utilisateur/micro-messages</a></li>
<li class="subsection"><a href="user-microposts#sec:ordering_and_dependency"><span class="number">11.1.3</span> Affinements du micro-message</a></li>
<li><ol>
<li class="subsubsection"><a href="user-microposts#sec:default_scope">Portée par défaut</a></li>
<li class="subsubsection"><a href="user-microposts#sec:dependent_destroy">Dependent: destroy (dépendances de la suppression)</a></li></ol></li>
<li class="subsection"><a href="user-microposts#sec:micropost_validations"><span class="number">11.1.4</span> Validations du micro-message</a></li></ol></li>
<li class="section"><a href="user-microposts#sec:showing_microposts"><span class="number">11.2</span> Afficher les micro-messages</a></li>
<li><ol>
<li class="subsection"><a href="user-microposts#sec:augmenting_the_user_show_page"><span class="number">11.2.1</span> Etoffement de la page de l'utilisateur</a></li>
<li class="subsection"><a href="user-microposts#sec:sample_microposts"><span class="number">11.2.2</span> Exemples de micro-messages</a></li></ol></li>
<li class="section"><a href="user-microposts#sec:manipulating_microposts"><span class="number">11.3</span> Manipuler les micro-messages</a></li>
<li><ol>
<li class="subsection"><a href="user-microposts#sec:access_control"><span class="number">11.3.1</span> Contrôle de l'accès</a></li>
<li class="subsection"><a href="user-microposts#sec:creating_microposts"><span class="number">11.3.2</span> Créer des micro-messages</a></li>
<li class="subsection"><a href="user-microposts#sec:a_proto_feed"><span class="number">11.3.3</span> Une proto-alimentation</a></li>
<li class="subsection"><a href="user-microposts#sec:destroying_microposts"><span class="number">11.3.4</span> Supprimer des micro-messages</a></li>
<li class="subsection"><a href="user-microposts#sec:testing_the_new_home_page"><span class="number">11.3.5</span> Test de la nouvelle page d'accueil</a></li></ol></li>
<li class="section"><a href="user-microposts#sec:11.4"><span class="number">11.4</span> Conclusion</a></li>
<li class="section"><a href="user-microposts#sec:micropost_Exercices"><span class="number">11.5</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="following-users#top"><span class="number">Chapitre 12</span> Suivi des utilisateurs</a></li>
<li><ol>
<li class="section"><a href="following-users#sec:the_relationship_model"><span class="number">12.1</span> Le modèle Relation (Relationship model)</a></li>
<li><ol>
<li class="subsection"><a href="following-users#sec:a_problem_with_the_data_model"><span class="number">12.1.1</span> Un problème du modèle de données (et sa solution)</a></li>
<li class="subsection"><a href="following-users#sec:relationship_user_associations"><span class="number">12.1.2</span> Associations Utilisateur/Relations</a></li>
<li class="subsection"><a href="following-users#sec:relationship_validations"><span class="number">12.1.3</span> Validations</a></li>
<li class="subsection"><a href="following-users#sec:following"><span class="number">12.1.4</span> Auteurs suivis</a></li>
<li class="subsection"><a href="following-users#sec:followers"><span class="number">12.1.5</span> Lecteurs</a></li></ol></li>
<li class="section"><a href="following-users#sec:a_web_interface_for_following_and_followers"><span class="number">12.2</span> Une interface web pour les auteurs suivis et les lecteurs</a></li>
<li><ol>
<li class="subsection"><a href="following-users#sec:sample_following_data"><span class="number">12.2.1</span> Exemple de donnée de suivi</a></li>
<li class="subsection"><a href="following-users#sec:stats_and_a_follow_form"><span class="number">12.2.2</span> Statistiques et formulaire de suivi</a></li>
<li class="subsection"><a href="following-users#sec:following_and_followers_pages"><span class="number">12.2.3</span> Pages d'auteurs suivis et de lecteurs</a></li>
<li class="subsection"><a href="following-users#sec:a_working_follow_button_the_standard_way"><span class="number">12.2.4</span> Un bouton de suivi fonctionnant de façon standard</a></li>
<li class="subsection"><a href="following-users#sec:a_working_follow_button_with_ajax"><span class="number">12.2.5</span> Un bouton fonctionnant avec Ajax</a></li></ol></li>
<li class="section"><a href="following-users#sec:the_status_feed"><span class="number">12.3</span> L'état de l'alimention</a></li>
<li><ol>
<li class="subsection"><a href="following-users#sec:motivation_and_strategy"><span class="number">12.3.1</span> Motivation et stratégie</a></li>
<li class="subsection"><a href="following-users#sec:a_first_feed_implementation"><span class="number">12.3.2</span> Une première implémentation de peuplement</a></li>
<li class="subsection"><a href="following-users#sec:scopes_subselects_and_a_lambda"><span class="number">12.3.3</span> Portées, sous-requêtes et fonction <em>lambda</em></a></li>
<li class="subsection"><a href="following-users#sec:the_new_status_feed"><span class="number">12.3.4</span> Nouvel état de l'alimentation</a></li></ol></li>
<li class="section"><a href="following-users#sec:following_conclusion"><span class="number">12.4</span> Conclusion</a></li>
<li><ol>
<li class="subsection"><a href="following-users#sec:extensions_to_the_sample_application"><span class="number">12.4.1</span> Extensions de l'application exemple</a></li>
<li><ol>
<li class="subsubsection"><a href="following-users#sec:replies">Réponses</a></li>
<li class="subsubsection"><a href="following-users#sec:messaging">Notification</a></li>
<li class="subsubsection"><a href="following-users#sec:follower_notifications">Notifications aux lecteurs</a></li>
<li class="subsubsection"><a href="following-users#sec:password_reminders">Rappel du mot de passe</a></li>
<li class="subsubsection"><a href="following-users#sec:signup_confirmation">Confirmation d'inscription</a></li>
<li class="subsubsection"><a href="following-users#sec:rss_feed">Alimentation RSS</a></li>
<li class="subsubsection"><a href="following-users#sec:rest_api">REST API</a></li>
<li class="subsubsection"><a href="following-users#sec:search">Recherche</a></li></ol></li>
<li class="subsection"><a href="following-users#sec:guide_to_further_resources"><span class="number">12.4.2</span> Guide vers d'autres ressources</a></li></ol></li>
<li class="section"><a href="following-users#sec:following_Exercices"><span class="number">12.5</span> Exercices</a></li></ol></li></ol></div>


<div id="main_content"></div>

<p> <span class="preamble">
 <span id="foreword">
<strong> Avant-propos</strong> <br />
 </span>
 </span></p>

<p>Ma précédente compagnie (CD Baby) fut une des premières à basculer intégralement vers Ruby on Rails, et à rebasculer aussi intégralement vers PHP (googlez-moi si vous voulez prendre la mesure du drame). On m'a tellement recommandé ce livre Michael Hartl que je n'ai pu faire autrement que de le lire. C'est ainsi que le <em>Tutoriel Ruby on Rails</em> m'a fait revenir à nouveau à Rails.</p>
<p>Bien qu'ayant parcouru de nombreux livres sur Rails, c'est ce tutoriel-là qui m'a véritablement «&nbsp;mis en possession&nbsp;» de Rails. Tout est fait ici «&nbsp;à la manière de Rails&nbsp;» —&nbsp;une manière qui ne m'avait jamais semblé naturelle avant que je ne lise ce livre. C'est aussi le seul ouvrage sur Rails qui met en place, d'un bout à l'autre, un <em>Développement Dirigé par les Tests</em> (<em>Test-Driven Development</em>), une approche que je savais hautement recommandée par les experts mais dont je n'avais jamais compris aussi bien la pertinence que dans ce livre. Enfin, en incluant Git, GitHub et Heroku dans les exemples de la démonstration, l'auteur vous donne vraiment le goût de ce qu'est le développement d'un projet dans la vie réelle. Et le exemples de code ne sont pas en reste.</p> 
	
<p>La narration linéaire adoptée par ce tutoriel est vraiment un bon format. Personnellement, j'ai étudié <em>Le Tutoriel Rails</em> en trois longues journées, en faisant tous les exemples et les exercices proposés à la fin de chaque chapitre. C'est en lisant ce livre du début à la fin, sans sauter la moindre partie, qu'on en tire tout le bénéfice.</p>

<p>Régalez-vous&nbsp;!</p>

<p><a href="http://sivers.org/">Derek Sivers</a> (<a href="http://sivers.org/">sivers.org</a>) <br />
<em>Précédemment&nbsp;: Fondateur de </em> <a href="http://www.cdbaby.com/"><em>CD Baby</em></a> <br />
<em>Actuellement&nbsp;: Fondateur de </em> <a href="http://thoughts.pro/"><em>Thoughts Ltd.</em></a> <br /></p>

<p> <span class="preamble">
<strong> Remerciements</strong> <br />
 </span></p>

<p>Ce <em>Tutoriel Ruby on Rails</em> doit beaucoup à mon livre précédent sur Rails, <em>RailsSpace</em>, et donc à mon co-auteur <a href="http://aure.com/">Aurelius Prochazka</a>. J'aimerais remercier Aure à la fois pour le travail qu'il a accompli sur ce précédent livre et pour son soutien pour le présent ouvrage. J'aimerais aussi remercier Debra Williams Cauley, mon éditeur pour les deux ouvrages&nbsp;; aussi longtemps qu'elle jouera avec moi au baseball, je continuerai d'écrire des livres pour elle.</p>

<p>J'aimerais remercier une longue liste de Rubyistes qui m'ont parlé et inspiré au cours des années&nbsp;: David Heinemeier Hansson, Yehuda Katz, Carl Lerche, Jeremy Kemper, Xavier Noria, Ryan Bates, Geoffrey Grosenbach, Peter Cooper, Matt Aimonetti, Gregg Pollack, Wayne&nbsp;E. Seguin, Amy Hoy, Dave Chelimsky, Pat Maddox, Tom Preston-Werner, Chris Wanstrath, Chad Fowler, Josh Susser, Obie Fernandez, Ian McFarland, Steven Bristol, Giles Bowkett, Evan Dorn, Long Nguyen, James Lindenbaum, Adam Wiggins, Tikhon Bernstam, Ron Evans, Wyatt Greene, Miles Forrest, les gens bien de Pivotal Labs, le gang Heroku, les mecs de thoughtbot et l'équipe de GitHub. Enfin, tellement, tellement, tellement de lecteurs —&nbsp;beaucoup trop pour les citer tous&nbsp;— qui ont contribué par leur rapport de bogues et leurs suggestions durant l'écriture de ce livre, et je tiens à saluer leur aide sans laquelle ce livre ne serait pas ce qu'il est. <br /></p>

<p> <span class="preamble">
 <span id="author">
<strong> À propos de l'auteur</strong> <br />
 </span>
 </span></p>

<p><a href="http://michaelhartl.com/">Michael Hartl</a> est programmeur, éducateur et entrepreneur. Il est le co-auteur de <em>RailsSpace</em>, un tutoriel Rails publié en 2007, et a été co-fondateur et développeur en chef de <a href="http://insoshi.com/">Insoshi</a>, une plateforme de réseau social <a href="http://github.com/popular/forked">populaire</a> en Ruby on Rails. Précédement, il a enseigné la théorie et la physique informatique au <a href="http://www.caltech.edu/">California Institute of Technology</a> (Caltech), où il a reçu le Lifetime Achievement Award for Excellence en enseignement. Michael est diplômé du <a href="http://college.harvard.edu/">Harvard College</a>, a un <a href="http://resolver.caltech.edu/CaltechETD:etd-05222003-161626">Ph.D. en physique</a> (un doctorat. NdT) de <a href="http://www.caltech.edu/">Caltech</a>, et il est ancien élève du programme des entrepreneurs <a href="http://ycombinator.com/">Y&nbsp;Combinator</a>. <br /></p>

<p> <span id="license" class="preamble">
<strong> Copyright et license</strong> <br />
 </span></p>

<p><em>Le Tutoriel Ruby on Rails&nbsp;: apprendre Rails par l'exemple</em>. Copyright &copy; 2010 par Michael Hartl. Tout le code source du <em>Tutoriel Ruby on Rails</em> est disponible sous la license <a href="http://www.opensource.org/licenses/mit-license.php">MIT License</a> et la licence <a href="http://en.wikipedia.org/wiki/Beerware">Beerware License</a>.</p>

<pre class="verbatim">   Copyright (c) 2010 Michael Hartl

   Permission est accordée, à titre gratuit, à toute personne obtenant
   une copie de ce logiciel et la documentation associée, pour faire des 
   modification dans le logiciel sans restriction et sans limitation des
   droits d’utiliser, copier, modifier, fusionner, publier, distribuer,
   concéder sous licence, et / ou de vendre les copies du Logiciel, et à
   autoriser les personnes auxquelles le Logiciel est meublé de le faire, 
   sous réserve des conditions suivantes:

   L’avis de copyright ci-dessus et cette autorisation doit être inclus
   dans toutes les copies ou parties substantielles du Logiciel.

   LE LOGICIEL EST FOURNI «TEL QUEL», SANS GARANTIE D’AUCUNE SORTE, 
   EXPLICITE OU IMPLICITE, Y COMPRIS, MAIS SANS S’Y LIMITER, LES 
   GARANTIES DE QUALITÉ MARCHANDE, ADAPTATION À UN USAGE PARTICULIER ET
   D’ABSENCE DE CONTREFAÇON. EN AUCUN CAS LES AUTEURS OU TITULAIRES DU
   ETRE TENU RESPONSABLE DE TOUT DOMMAGE, RÉCLAMATION OU AUTRES
   RESPONSABILITÉ, SOIT DANS UNE ACTION DE CONTRAT, UN TORT OU AUTRE,
   PROVENANT DE, DE OU EN RELATION AVEC LE LOGICIEL OU L’UTILISATION OU
   DE TRANSACTIONS AUTRES LE LOGICIEL.
	
</pre>




<pre class="verbatim">/*
 * ------------------------------------------------------------
 * &quot;LA LICENCE BEERWARE&quot; (Révision 42)&nbsp;:
 * Michael Hartl a écrit ce code. Aussi longtemps que vous
 * conservez cette note, vous pouvez faire ce que vous voulez
 * de ce travail. Si nous nous rencontrons un jour, et que vous
 * pensez que ce travail en vaut la peine, vous pourrez me
 * payer une bière en retour.
 * ------------------------------------------------------------
 */</pre>



<div id="top"></div>


<h1 class="chapter"><a id="sec:9" href="sign-in-sign-out#top" class="heading"><span class="number">Chapitre 9</span> Connexion, déconnection</a></h1>


<p>Maintenant que les nouveaux utilisateurs peuvent s'inscrire sur notre site (<a class="ref" href="sign-up#top">chapitre&nbsp;8</a>), il est temps de donner aux utilisateurs enregistrés la possibilité de se connecter et se déconnection. Cela nous permettra d'ajouter des personnalisations basées sur l'état d'inscription en fonction de l'état de l'utilisateur courant. Par exemple, dans ce chapitre nous actualiserons l'entête avec les liens d'identification et de déconnexion et le lien pour rejoindre le profil&nbsp;; au <a class="ref" href="user-microposts#top">chapitre&nbsp;11</a>, nous utiliserons l'identité d'un utilisateur connecté pour créer des micro-messages associés à cet utilisateur, et au <a class="ref" href="following-users#top">chapitre&nbsp;12</a> nous permettrons à l'utilisateur de suivre d'autres utilisateurs de l'application (cela en suivant l'alimentation de leurs micro-messages).</p>

<p>Avoir des utilisateurs connectés nous permettra aussi d'implémenter un modèle de sécurité restreignant l'accès de pages particulières à des utilisateurs particuliers. Par exemple, comme nous le verrons au <a class="ref" href="updating-showing-and-deleting-users#top">chapitre&nbsp;10</a>, seuls les utilisateurs connectés seront en mesure d'accéder à la page utilisée pour modifier les informations de l'utilisateur. Le système d'identification (de <em>connexion</em>) rendra aussi possible certains privilèges pour les utilisateurs administrateurs, comme la possibilité (aussi au <a class="ref" href="updating-showing-and-deleting-users#top">chapitre&nbsp;10</a>) de détruire des utilisateurs de la base de données.</p>

<p>Comme dans les chapitres précédents, nous ferons notre travail sur une branche sujet et fusionnerons les changements à la fin&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout -b sign-in-out
</pre></div>
</div>


<div class="label" id="sec:sessions"></div>


<h2><a id="sec:9.1" href="sign-in-sign-out#sec:sessions" class="heading"><span class="number">9.1</span> Les sessions</a></h2>


<p>Une <a href="http://en.wikipedia.org/wiki/Session_(computer_science)"><em>session</em></a> est une connexion semi-permanente entre deux ordinateurs, tels qu'un ordinateur client jouant un navigateur web et un serveur jouant Rails. Il existe plusieurs modèles de comportement de session sur le web&nbsp;: «&nbsp;oublier&nbsp;» la session à la fermeture du navigateur, utiliser une option «&nbsp;se souvenir de moi&nbsp;» pour des sessions persistantes, et se souvenir des sessions jusqu'à ce que l'utilisateur se déconnecte explicitement.<sup class="footnote" id="fnref:9.1"><a href="#fn:9.1">1</a></sup> Nous opterons pour la dernière de ces options&nbsp;: quand les utilisateurs s'identifient, nous nous rappellerons de leur status «&nbsp;pour toujours&nbsp;»,<sup class="footnote" id="fnref:9.2"><a href="#fn:9.2">2</a></sup> effaçant la session seulement quand l'utilisateur se déconnecte explicitement.</p>

<p>Il est pratique de modeler les sessions comme une ressource REST&nbsp;: nous aurons une page d'identification for les <em>nouvelles</em> (<code>new</code>) sessions, l'identification créera (<code>create</code>) une session, et la déconnexion la <em>détruira</em> (<code>destroy</code>). Nous aurons par conséquent besoin d'un contrôleur Sessions avec les action <code>new</code> (<em>nouvelle</em>), <code>create</code> (<em>créer</em>) et <code>destroy</code> (<em>détruire</em>). Contrairement au cas du contrôleur Users, qui utilise une base de données (via le modèle User) pour les données persistantes, le contrôleur Sessions utilisera un <a href="http://en.wikipedia.org/wiki/HTTP_cookie"><em>cookie</em></a>, qui est un petit morceau de texte placé sur le navigateur de l'utilisateur. Le plus gros du travail de l'identification consiste à construire cette machinerie d'authentification basée sur les cookies. Dans cette section et la suivante, nous allons nous préparer à ce travail en construisant un contrôleur Sessions, un formulaire d'identification et les actions de contrôleur correspondantes (le plus gros ce travail est similaire à l'inscription de l'utilisateur du <a class="ref" href="sign-up#top">chapitre&nbsp;8</a>). Nous terminerons alors l'identification de l'utilisateur avec le code nécessaire manipulant les cookies à la <a class="ref" href="sign-in-sign-out#sec:signin_success">section&nbsp;9.3</a>.</p>

<div class="label" id="sec:sessions_controller"></div>


<h3><a id="sec:9.1.1" href="sign-in-sign-out#sec:sessions_controller" class="heading"><span class="number">9.1.1</span> Contrôleur Sessions</a></h3>


<p>Les éléments de l'inscription et de l'identification correspondent aux actions REST particulière du contrôleur Sessions&nbsp;: le formulaire d'identification est traité par l'action <code>new</code> (couverte par cette section), et plus précisément l'identification est traitée en envoyant une requête <tt>POST</tt> à l'action <code>create</code> (<a class="ref" href="sign-in-sign-out#sec:signin_failure">section&nbsp;9.2</a> et <a class="ref" href="sign-in-sign-out#sec:signin_success">section&nbsp;9.3</a>), et la déconnexion est traitée en envoyant une requête <tt>DELETE</tt> à l'action <code>destroy</code> (<a class="ref" href="sign-in-sign-out#sec:signing_out">section&nbsp;9.4</a>) (rappelez-vous de l'association des verbes HTTP avec les actions REST de la <a class="ref" href="modeling-and-viewing-users-one#table:RESTful_users">table&nbsp;6.2</a>.) Puisque nous savons que nous avons besoin d'une action <code>new</code>, nous pouvons la créer en générant le contrôleur Session (comme pour le contrôleur Users de l'<a class="ref" href="filling-in-the-layout#code:generate_users_controller">extrait&nbsp;5.23</a>):<sup class="footnote" id="fnref:9.3"><a href="#fn:9.3">3</a></sup></p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate controller Sessions new
<span class="gp">$</span> rm -rf spec/views
<span class="gp">$</span> rm -rf spec/helpers
</pre></div>
</div>


<p>Maintenant, comme avec le formulaire d'inscription  à la <a class="ref" href="sign-up#sec:signup_form">section&nbsp;8.1</a>, nous créons un nouveau fichier pour le spec du contrôleur Sessions et ajoutons une paire de tests pour l'action <code>new</code> et la vue correspondante (<a class="ref" href="sign-in-sign-out#code:new_session_tests">extrait&nbsp;9.1</a>) (ce modèle devrait commencer à vous être familier maintenant).</p>

<div class="label" id="code:new_session_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 9.1.</span> <span class="description">Tests pour l'action <code>new</code> et la vue de la session. <br /> <code>spec/controllers/sessions_controller_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">SessionsController</span> <span class="k">do</span>
  <span class="n">render_views</span>

  <span class="n">describe</span> <span class="s2">&quot;GET &#39;new&#39;&quot;</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">&quot;devrait réussir&quot;</span> <span class="k">do</span>
      <span class="n">get</span> <span class="ss">:new</span>
      <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">be_success</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;devrait avoir le bon titre&quot;</span> <span class="k">do</span>
      <span class="n">get</span> <span class="ss">:new</span>
      <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;titre&quot;</span><span class="p">,</span> <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="s2">&quot;S'identifier&quot;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Pour faire réussir ces tests, nous avons d'abord besoin d'ajouter une route pour l'action <code>new</code>, et tant que nous y serons, nous créerons toutes les actions nécessaire au long de ce chapitre. Nous suivons de façon générale l'exemple de l'<a class="ref" href="modeling-and-viewing-users-one#code:users_resource">extrait&nbsp;6.26</a>, mais dans ce cas nous définissons seulement les actions particulières dont nous avons besoin, c'est-à-dire <code>new</code>, <code>create</code> et <code>destroy</code>, et ajoutons aussi les routes nommées pour l'identification et la déconnexion (<a class="ref" href="sign-in-sign-out#code:sessions_resource">extrait&nbsp;9.2</a>).</p>

<div class="label" id="code:sessions_resource"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 9.2.</span> <span class="description">Ajout d'une ressource pour obtenir les actions RESTful pour les sessions. <br /> <code>config/routes.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="no">SampleApp</span><span class="o">::</span><span class="no">Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">resources</span> <span class="ss">:users</span>
  <span class="n">resources</span> <span class="ss">:sessions</span><span class="p">,</span> <span class="ss">:only</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:new</span><span class="p">,</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>

  <span class="n">match</span> <span class="s1">&#39;/signup&#39;</span><span class="p">,</span>  <span class="ss">:to</span> <span class="o">=&gt;</span> <span class="s1">&#39;users#new&#39;</span>
  <span class="n">match</span> <span class="s1">&#39;/signin&#39;</span><span class="p">,</span>  <span class="ss">:to</span> <span class="o">=&gt;</span> <span class="s1">&#39;sessions#new&#39;</span>
  <span class="n">match</span> <span class="s1">&#39;/signout&#39;</span><span class="p">,</span> <span class="ss">:to</span> <span class="o">=&gt;</span> <span class="s1">&#39;sessions#destroy&#39;</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Comme vous pouvez le voir, les méthodes <code>resources</code> (<em>ressources</em>) peuvent prendre une table d'options, qui dans ce cas possède une clé <code>:only</code> et une valeur égale à un tableau des actions à laquelle doit répondre le contrôleur Sessions. Les ressources définies dans l'<a class="ref" href="sign-in-sign-out#code:sessions_resource">extrait&nbsp;9.2</a> fournissent des URLs et des actions similaires à celles des utilisateurs (<a class="ref" href="modeling-and-viewing-users-one#table:RESTful_users">Table&nbsp;6.2</a>), comme montré dans la <a class="ref" href="sign-in-sign-out#table:RESTful_sessions">table&nbsp;9.1</a>.</p>

<div class="label" id="table:RESTful_sessions"></div>


<div class="table"><div class="center"><table class="tabular"><tr><th class="align_left"><strong>Requête HTTP</strong></th><th class="align_left"><strong>URL</strong></th><th class="align_left"><strong>Route nommée</strong></th><th class="align_left"><strong>Action</strong></th><th class="align_left"><strong>But</strong></th></tr><tr class="top_bar"><td class="align_left"><tt>GET</tt></td><td class="align_left"><tt>/signin</tt></td><td class="align_left"><code>signin_path</code></td><td class="align_left"><code>new</code></td><td class="align_left">page pour une nouvelle session (identification)</td></tr><tr><td class="align_left"><tt>POST</tt></td><td class="align_left"><tt>/sessions</tt></td><td class="align_left"><code>sessions_path</code></td><td class="align_left"><code>create</code></td><td class="align_left">crée une nouvelle session</td></tr><tr><td class="align_left"><tt>DELETE</tt></td><td class="align_left"><tt>/signout</tt></td><td class="align_left"><code>signout_path</code></td><td class="align_left"><code>destroy</code></td><td class="align_left">efface la session (déconnexion)</td></tr></table></div><div class="caption"><span class="header">Table 9.1: </span><span class="description">Routes RESTful fournies par les règles de sessions de l'<a class="ref" href="sign-in-sign-out#code:sessions_resource">extrait&nbsp;9.2</a>.</span></div></div>


<p>Nous pouvons obtenir la réussite du second test de l'<a class="ref" href="sign-in-sign-out#code:new_session_tests">extrait&nbsp;9.1</a> en ajoutant la variable d'instance titre adéquate à l'action <code>new</code>, comme dans l'<a class="ref" href="sign-in-sign-out#code:new_session_title">extrait&nbsp;9.3</a> (qui définit aussi les actions <code>create</code> et <code>destroy</code> pour référence future).</p>

<div class="label" id="code:new_session_title"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 9.3.</span> <span class="description">Ajout du titre pour la page d'identification. <br /> <code>app/controllers/sessions_controller.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">new</span>
    <span class="vi">@titre</span> <span class="o">=</span> <span class="s2">&quot;S'identifier&quot;</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Avec ça, les tests de l'<a class="ref" href="sign-in-sign-out#code:new_session_tests">extrait&nbsp;9.1</a> devraient réussir, et nous sommes prêts à construire le formulaire d'identification.</p>

<div class="label" id="sec:signin_form"></div>


<h3><a id="sec:9.1.2" href="sign-in-sign-out#sec:signin_form" class="heading"><span class="number">9.1.2</span> Formulaire d'identification </a></h3>


<p>Le formulaire d'identification (ou, de façon équivalente, le formulaire de nouvelle session) est similaire en apparence au formulaire d'inscription, à l'exception prêt que nous n'avons que deux champs (email et mot de passe) au lieu de quatre. Une maquette est présentée dans l'<a class="ref" href="sign-in-sign-out#fig:signin_mockup">illustration&nbsp;9.1</a>.</p>

<div class="label" id="fig:signin_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/signin_mockup.png" alt="signin_mockup" /></span></div><div class="caption"><span class="header">Illustration 9.1: </span><span class="description">Une maquette du formulaire d'identification.&nbsp;<a href="http://railstutorial.org/images/figures/signin_mockup-full.png">(taille normale)</a></span></div></div>


<p>Rappelez-vous, de l'<a class="ref" href="sign-up#code:new_user_form">extrait&nbsp;8.2</a>, que le formulaire d'inscription utilise l'helper <code>form_for</code>, prenant en argument la variable d'instance utilisateur <code>@user</code>&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  .
  .
  .
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>La différence principale avec le formulaire de nouvelle session est que nous n'avons pas de modèle Session, et ainsi pas d'analogue pour la variable <code>@user</code>. Cela signifie que, en construisant le formulaire de nouvelle session, nous devons donner à <code>form_for</code> légèrement plus d'information&nbsp;; en particulier, alors que&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
</pre></div>
</div>


<p>… permet à Rails de déduire que <code>action</code> du formulaire devrait être le <tt>POST</tt> de l'URL <tt>/users</tt>, dans le cas des sessions nous avons besoin d'indiquer le <em>nom</em> de la ressource tout comme l'URL appropriée&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="n">form_for</span><span class="p">(</span><span class="ss">:session</span><span class="p">,</span> <span class="ss">:url</span> <span class="o">=&gt;</span> <span class="n">sessions_path</span><span class="p">)</span>
</pre></div>
</div>


<p>Puisque nous authentifions les utilisateurs avec les adresses mail et les mots de passe, nous avons besoin d'un champ pour chacun à l'intérieur du formulaire&nbsp;; le résultat apparait dans l'<a class="ref" href="sign-in-sign-out#code:signin_form">extrait&nbsp;9.4</a>.</p>

<div class="label" id="code:signin_form"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 9.4.</span> <span class="description">Code pour le formulaire d'identification. <br /> <code>app/views/sessions/new.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>Identification<span class="nt">&lt;/h1&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="ss">:session</span><span class="p">,</span> <span class="ss">:url</span> <span class="o">=&gt;</span> <span class="n">sessions_path</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;field&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:email</span> <span class="cp">%&gt;</span><span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;field&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password</span> <span class="cp">%&gt;</span><span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;actions&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">&quot;Identification&quot;</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

<span class="nt">&lt;p&gt;</span>New user? <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;S'inscrire&nbsp;!&quot;</span><span class="p">,</span> <span class="n">signup_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/p&gt;</span>
</pre></div>
</div></div>


<p>Avec le code de l'<a class="ref" href="sign-in-sign-out#code:signin_form">extrait&nbsp;9.4</a>, le formulaire d'identification apparait comme dans l'<a class="ref" href="sign-in-sign-out#fig:signin_form">illustration&nbsp;9.2</a>.</p>

<div class="label" id="fig:signin_form"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/signin_form.png" alt="signin_form" /></span></div><div class="caption"><span class="header">Illustration 9.2: </span><span class="description">Le formulaire d'identification (<a href="http://localhost:3000/sessions/new">/sessions/new</a>).&nbsp;<a href="http://railstutorial.org/images/figures/signin_form-full.png">(taille normale)</a></span></div></div>


<p>Bien que nous allions perdre bientôt l'habitude de regarder dans le code HTML généré par Rails (et faire plutôt confiance aux helpers pour faire leur travail), pour le moment justons-y un coup d'œil (<a class="ref" href="sign-in-sign-out#code:signin_form_html">extrait&nbsp;9.5</a>).</p>

<div class="label" id="code:signin_form_html"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 9.5.</span> <span class="description">HTML pour le formulaire d'identification produit par l'<a class="ref" href="sign-in-sign-out#code:signin_form">extrait&nbsp;9.4</a>.</span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">&quot;/sessions&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;field&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;session_email&quot;</span><span class="nt">&gt;</span>Email<span class="nt">&lt;/label&gt;&lt;br</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;session_email&quot;</span> <span class="na">name=</span><span class="s">&quot;session[email]&quot;</span> <span class="na">size=</span><span class="s">&quot;30&quot;</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="nt">/&gt;</span>

  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;field&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;session_password&quot;</span><span class="nt">&gt;</span>Password<span class="nt">&lt;/label&gt;&lt;br</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;session_password&quot;</span> <span class="na">name=</span><span class="s">&quot;session[password]&quot;</span> <span class="na">size=</span><span class="s">&quot;30&quot;</span>
           <span class="na">type=</span><span class="s">&quot;password&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;actions&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;session_submit&quot;</span> <span class="na">name=</span><span class="s">&quot;commit&quot;</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">value=</span><span class="s">&quot;S'identifier&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</pre></div>
</div></div>


<p>En comparant l'<a class="ref" href="sign-in-sign-out#code:signin_form_html">extrait&nbsp;9.5</a> avec l'<a class="ref" href="sign-up#code:signup_form_html">extrait&nbsp;8.5</a>, vous devriez pouvoir deviner que soumettre ce formulaire produira une table <code>params</code> où <code>params[:session][:email]</code> et <code>params[:session][:password]</code> correspondent au champs email et mot de passe. Traiter cette soumission &mdash;&nbsp;et, en particulier, authentifier les utilisateurs en se basant sur l'email et le mot de passe soumis&nbsp;&mdash; est le projet des deux prochaines sections.</p>

<div class="label" id="sec:signin_failure"></div>


<h2><a id="sec:9.2" href="sign-in-sign-out#sec:signin_failure" class="heading"><span class="number">9.2</span> Échec de l'identification</a></h2>


<p>Comme dans le cas de la création d'utilisateurs (signup), la première étape dans la création de sessions (signin) est de traiter les entrées <em>invalides</em>. Nous allons commencer par revoir ce qui se passe quand un formulaire est soumis, et nous arranger alors pour afficher un message d'erreur utile dans le cas de l'échec de l'identification (comme présenté dans la maquette de l'<a class="ref" href="sign-in-sign-out#fig:signin_failure_mockup">illustration&nbsp;9.3</a>). Enfin, nous poserons les bases d'une identification réussie (<a class="ref" href="sign-in-sign-out#sec:signin_success">section&nbsp;9.3</a>) en évaluant chaque soumission de l'identification en se basant sur la validité de sa combinaisons email/mot de passe.</p>

<div class="label" id="fig:signin_failure_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/signin_failure_mockup.png" alt="signin_failure_mockup" /></span></div><div class="caption"><span class="header">Illustration 9.3: </span><span class="description">Une maquette de l'échec de l'identification.&nbsp;<a href="http://railstutorial.org/images/figures/signin_failure_mockup-full.png">(taille normale)</a></span></div></div>




<div class="label" id="sec:reviewing_form_submission"></div>


<h3><a id="sec:9.2.1" href="sign-in-sign-out#sec:reviewing_form_submission" class="heading"><span class="number">9.2.1</span> Examen de la soumission du formulaire</a></h3>


<p>Commençons par définir une action <code>create</code> minimale pour le contrôleur Sessions (<a class="ref" href="sign-in-sign-out#code:initial_create_session">extrait&nbsp;9.6</a>), qui ne fait rien d'autre que rendre la vue <code>new</code>. Soumettre le formulaire <a href="http://localhost:3000/sessions/new"><tt>/sessions/new</tt></a> avec des champs vierge puis renvoyer le résultat vu dans l'<a class="ref" href="sign-in-sign-out#fig:initial_failed_signin_rails_3">illustration&nbsp;9.4</a>.</p>

<div class="label" id="code:initial_create_session"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 9.6.</span> <span class="description">Une version préliminaire de l'action <code>create</code> de Sessions. <br /> <code>app/controllers/sessions_controller.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">render</span> <span class="s1">&#39;new&#39;</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="fig:initial_failed_signin_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/initial_failed_signin_rails_3.png" alt="initial_failed_signin_rails_3" /></span></div><div class="caption"><span class="header">Illustration 9.4: </span><span class="description">L'échec de l'identification initiale, avec <code>create</code> comme dans l'<a class="ref" href="sign-in-sign-out#code:initial_create_session">extrait&nbsp;9.6</a>.&nbsp;<a href="http://railstutorial.org/images/figures/initial_failed_signin_rails_3-full.png">(taille normale)</a></span></div></div>


<p>L'inspection attentive des informations de débuggage de l'<a class="ref" href="sign-in-sign-out#fig:initial_failed_signin_rails_3">illustration&nbsp;9.4</a> montre que, comme soulevé à la fin de la <a class="ref" href="sign-in-sign-out#sec:signin_form">section&nbsp;9.1.2</a>, de la soumission résulte une table <code>params</code> contenant l'email et le mot de passe sous la clé <code>:session</code>&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="nn">---</span> <span class="kt">!map</span><span class="l-Scalar-Plain">:ActiveSupport::HashWithIndifferentAccess</span>
<span class="l-Scalar-Plain">commit</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">S'identifier</span>
<span class="l-Scalar-Plain">session</span><span class="p-Indicator">:</span> <span class="kt">!ActiveSupport</span><span class="l-Scalar-Plain">::HashWithIndifferentAccess</span> 
  <span class="l-Scalar-Plain">password</span><span class="p-Indicator">:</span> <span class="s">&quot;&quot;</span>
  <span class="l-Scalar-Plain">email</span><span class="p-Indicator">:</span> <span class="s">&quot;&quot;</span>
<span class="l-Scalar-Plain">authenticity_token</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">BlO65PA1oS5vqrv591dt9B22HGSWW0HbBtoHKbBKYDQ=</span>
<span class="l-Scalar-Plain">action</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">create</span>
<span class="l-Scalar-Plain">controller</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">sessions</span>
</pre></div>
</div>


<p>Comme dans le cas de l'inscription de l'utilisateur (<a class="ref" href="sign-up#fig:signup_failure_rails_3">illustration&nbsp;8.6</a>) ces paramètres forment un table <em>imbriquée</em> comme celle que nous avons vu dans l'<a class="ref" href="rails-flavored-ruby#code:nested_hashes">extrait&nbsp;4.5</a>. En particulier, <code>params</code> contient une table imbriquée de la forme&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="p">{</span> <span class="ss">:session</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:password</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span> <span class="p">}</span> <span class="p">}</span>
</pre></div>
</div>


<p>Cela signifie que&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">]</span>
</pre></div>
</div>


<p>… est lui-même une table&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="p">{</span> <span class="ss">:password</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span> <span class="p">}</span>
</pre></div>
</div>


<p>Comme résultat&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">]</span>
</pre></div>
</div>


<p>… est l'adresse mail soumise et&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span>
</pre></div>
</div>


<p>… est le mot de passe soumis.</p>

<p>En d'autres termes, à l'intérieur de l'action <code>create</code>, la table <code>params</code> contient toutes les informations dont nous avons besoin pour authentifier les utilisateurs par l'email et le mot de passe. Ça n'est pas le fait du hasard, mais nous avons déjà développé exactement la méthode nécessaire&nbsp;: <code>User.authenticate</code> à la <a class="ref" href="modeling-and-viewing-users-two#sec:an_authenticate_method">section&nbsp;7.2.4</a> (<a class="ref" href="modeling-and-viewing-users-two#code:authenticate_method">extrait&nbsp;7.12</a>). En se souvenant que <code>authenticate</code> retourne <code>nil</code> pour une authentification invalide, notre stratégie pour l'identification des utilisateurs peut être résumée comme suit&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">create</span>
  <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">]</span><span class="p">,</span>
                           <span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">nil?</span>
    <span class="c1"># Crée un message d'erreur et rend le formulaire d'identification.</span>
  <span class="k">else</span>
    <span class="c1"># Authentifie l'utilisateur et redirige vers la page d'affichage.</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>




<div class="label" id="sec:failed_signin"></div>


<h3><a id="sec:9.2.2" href="sign-in-sign-out#sec:failed_signin" class="heading"><span class="number">9.2.2</span> Échec de l'identification (test et code)</a></h3>


<p>Dans le but de traiter un échec d'identification, d'abord nous avons besoin de déterminer que c'est un échec. Les tests suivent l'exemple des tests analogues pour l'inscription de l'utilisateur (<a class="ref" href="sign-up#code:failing_create_specs">extrait&nbsp;8.6</a>), comme vu dans l'<a class="ref" href="sign-in-sign-out#code:failed_signin_tests">extrait&nbsp;9.7</a>.</p>

<div class="label" id="code:failed_signin_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 9.7.</span> <span class="description">Tests pour un échec d'identification. <br /> <code>spec/controllers/sessions_controller_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">SessionsController</span> <span class="k">do</span>
  <span class="n">render_views</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;POST &#39;create&#39;&quot;</span> <span class="k">do</span>

    <span class="n">describe</span> <span class="s2">&quot;invalid signin&quot;</span> <span class="k">do</span>

      <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
        <span class="vi">@attr</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;email@example.com&quot;</span><span class="p">,</span> <span class="ss">:password</span> <span class="o">=&gt;</span> <span class="s2">&quot;invalid&quot;</span> <span class="p">}</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;devrait re-rendre la page new&quot;</span> <span class="k">do</span>
        <span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:session</span> <span class="o">=&gt;</span> <span class="vi">@attr</span>
        <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;new&#39;</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;devrait avoir le bon titre&quot;</span> <span class="k">do</span>
        <span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:session</span> <span class="o">=&gt;</span> <span class="vi">@attr</span>
        <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;titre&quot;</span><span class="p">,</span> <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="s2">&quot;S'identifier&quot;</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;devait avoir un message flash.now&quot;</span> <span class="k">do</span>
        <span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:session</span> <span class="o">=&gt;</span> <span class="vi">@attr</span>
        <span class="n">flash</span><span class="o">.</span><span class="n">now</span><span class="o">[</span><span class="ss">:error</span><span class="o">].</span><span class="n">should</span> <span class="o">=~</span> <span class="sr">/invalid/i</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Le code de l'application nécessaire pour faire réussir ces tests est présenté dans l'<a class="ref" href="sign-in-sign-out#code:signin_failure">extrait&nbsp;9.8</a>. Comme promis à la <a class="ref" href="sign-in-sign-out#sec:reviewing_form_submission">section&nbsp;9.2.1</a>, nous extrayons l'adresse mail soumise et le mot de passe de la table <code>params</code>, et les passons ensuite à la méthode <code>User.authenticate</code>. Si l'utilisateur n'est pas authentifié (c'est-à-dire s'il est <code>nil</code>), nous définissons le titre et rendons à nouveau le formulaire d'identification.<sup class="footnote" id="fnref:9.4"><a href="#fn:9.4">4</a></sup> Nous traiterons l'autre branche de la déclaration if-else à la <a class="ref" href="sign-in-sign-out#sec:signin_success">section&nbsp;9.3</a>&nbsp;; pour le moment, nous allons juste laissé un commentaire descriptif.</p>

<div class="label" id="code:signin_failure"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 9.8.</span> <span class="description">Code pour une tentaive ratée d'identification. <br /> <code>app/controllers/sessions_controller.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">]</span><span class="p">,</span>
                             <span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">nil?</span>
      <span class="n">flash</span><span class="o">.</span><span class="n">now</span><span class="o">[</span><span class="ss">:error</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Combinaison Email/Mot de passe invalide.&quot;</span>
      <span class="vi">@titre</span> <span class="o">=</span> <span class="s2">&quot;S'identifier&quot;</span>
      <span class="n">render</span> <span class="s1">&#39;new&#39;</span>
    <span class="k">else</span>
      <span class="c1"># Authentifie l'utilisateur et redirige vers sa page d'affichage.</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Rappelez-vous de la <a class="ref" href="sign-up#sec:failed_signup">section&nbsp;8.4.2</a>&nbsp;: nous avons affiché les erreurs de l'inscription en utilisant les messages d'erreur du modèle User. Puisque la session n'est pas un modèle Active Record, cette stratégie ne fonctionnera pas ici, donc à la place nous déposons un message dans le flash (ou, plus exactement, dans <code>flash.now</code>&nbsp;; voyez le <a class="ref" href="sign-in-sign-out#sidebar:flash_now">Box&nbsp;9.1</a>). Grâce au message flash affiché dans le layout du site (<a class="ref" href="sign-up#code:layout_flash">extrait&nbsp;8.16</a>), le message <code>flash[:error]</code> sera automatiquement affiché&nbsp;; grâce aux CSS Blueprint, il aura automatiquement une belle stylisation (<a class="ref" href="sign-in-sign-out#fig:failed_signin">illustration&nbsp;9.5</a>).</p>

<div class="label" id="sidebar:flash_now"></div>


<div class="sidebar"><span class="title"><span class="header">Box 9.1.</span><span class="description">Flash point now</span></span>
<p>Il existe une subtile différence enetre <code>flash</code> et <code>flash.now</code>. La variable <code>flash</code> est conçue pour être utilisée avant une <em>redirection</em>, et elle persiste sur la page résultante de la-dite requête &mdash;&nbsp;c'est-à-dire qu'elle apparait une fois, disparait une fois, et disparait quand vous cliquez un autre lien. Malheureusement, cela signifie que si nous ne <em>redirigeons pas</em> la page, et qu'au contraire nous ne faisons que la <em>rendre</em> (comme dans <a class="ref" href="sign-in-sign-out#code:signin_failure">extrait&nbsp;9.8</a>), le message flash persiste pour les <em>deux</em> requêtes&nbsp;: il apparait sur la page rendue mais il attend toujours pour une rediction (c'est-à-dire une seconde requête), et ainsi apparait <em>une nouvelle fois</em> si vous cliquez un lien.</p>

<p>Pour éviter ce comportement bizarre, en <em>rendant</em> (<code>render</code>) plutôt qu'en <em>redirigeant</em> (<code>redirect</code>) nous utilisons <code>flash.now</code> plutôt que <code>flash</code>. L'objet <code>flash.now</code> est spécialement conçu pour afficher les messages flash sur les pages rendues. si vous vous demandez jamais pour un message flash est affiché à un endroit que vous n'attendiez pas, il n'y a de fortes chances qu'il faille que vous remplaciez <code>flash</code> par <code>flash.now</code>.</p>
</div>




<div class="label" id="fig:failed_signin"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/failed_signin.png" alt="failed_signin" /></span></div><div class="caption"><span class="header">Illustration 9.5: </span><span class="description">Une identification ratée (avec un message flash).&nbsp;<a href="http://railstutorial.org/images/figures/failed_signin-full.png">(taille normale)</a></span></div></div>



<div class="label" id="sec:signin_success"></div>


<h2><a id="sec:9.3" href="sign-in-sign-out#sec:signin_success" class="heading"><span class="number">9.3</span> Réussite de l'identification</a></h2>


<p>Ayant traité un échec de l'identification, nous avons besoin maintenant, effectivement, de pouvoir authentifier un utilisateur. Une idée de là où nous allons &mdash;&nbsp;la page de profil de l'utilisateur, avec des liens de navigation&nbsp;&mdash; est maquetté dans l'<a class="ref" href="sign-in-sign-out#fig:signin_success_mockup">illustration&nbsp;9.6</a>.<sup class="footnote" id="fnref:9.5"><a href="#fn:9.5">5</a></sup> En arriver là requiert quelques uns des défis Ruby de programmation les plus avancés jusque-là, alors accrochez-vous jusqu'à la fin et préparez-vous à soulever du poids. Heureusement, la première étape est facile &mdash;&nbsp;compléter l'action <code>create</code> du contrôleur Sessions est du gâteau. Malheureusement, c'est aussi une escroquerie.</p>

<div class="label" id="fig:signin_success_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/signin_success_mockup.png" alt="signin_success_mockup" /></span></div><div class="caption"><span class="header">Illustration 9.6: </span><span class="description">Une maquette du profil utilisateur après une identification réussie (avec des liens de navigation actualisés). &nbsp;<a href="http://railstutorial.org/images/figures/signin_success_mockup-full.png">(taille normale)</a></span></div></div>




<div class="label" id="sec:the_completed_create_action"></div>


<h3><a id="sec:9.3.1" href="sign-in-sign-out#sec:the_completed_create_action" class="heading"><span class="number">9.3.1</span> L'action <code>create</code> achevée</a></h3>


<p>Remplir l'aire non occupée pour le moment par le commentaire d'identification (<a class="ref" href="sign-in-sign-out#code:signin_failure">extrait&nbsp;9.8</a>) est simple&nbsp;: à la réussite de l'identification, nous identifions l'utilisateur en utilisant la foncion <code>sign_in</code> et nous le redirigeons vers sa page de profil (<a class="ref" href="sign-in-sign-out#code:sign_in_success_not_yet_working">extrait&nbsp;9.9</a>). Nous voyons maintenant pourquoi c'est une escroquerie&nbsp;: hélas, <code>sign_in</code> n'existe pas pour le moment. L'écrire nous occupera pendant toute cette section.</p>

<div class="label" id="code:sign_in_success_not_yet_working"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 9.9.</span> <span class="description">L'action <code>create</code> du contrôleur Sessions achevée (mais pas encore fonctionnelle). <br /> <code>app/controllers/sessions_controller.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">authenticate</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:email</span><span class="o">]</span><span class="p">,</span>
                             <span class="n">params</span><span class="o">[</span><span class="ss">:session</span><span class="o">][</span><span class="ss">:password</span><span class="o">]</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">nil?</span>
      <span class="n">flash</span><span class="o">.</span><span class="n">now</span><span class="o">[</span><span class="ss">:error</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Combinaison Email/Mot de passe invalide.&quot;</span>
      <span class="vi">@titre</span> <span class="o">=</span> <span class="s2">&quot;S'identifier&quot;</span>
      <span class="n">render</span> <span class="s1">&#39;new&#39;</span>
    <span class="k">else</span>
      <span class="n">sign_in</span> <span class="n">user</span>
      <span class="n">redirect_to</span> <span class="n">user</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Même si la fonction <code>sign_in</code> fait défaut, nous pouvons quand même écrire les tests (<a class="ref" href="sign-in-sign-out#code:pending_signin_tests">extrait&nbsp;9.10</a>) (nous remplirons le corps du premier test à la <a class="ref" href="sign-in-sign-out#sec:current_user">section&nbsp;9.3.3</a>).</p>

<div class="label" id="code:pending_signin_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 9.10.</span> <span class="description">Ajouter des tests pour l'identification de l'utilisateur (sera complet à la <a class="ref" href="sign-in-sign-out#sec:current_user">section&nbsp;9.3.3</a>). <br /> <code>spec/controllers/sessions_controller_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="no">SessionsController</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;POST &#39;create&#39;&quot;</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;avec un email et un mot de passe valides&quot;</span> <span class="k">do</span>

      <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
        <span class="vi">@user</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
        <span class="vi">@attr</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="ss">:password</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password</span> <span class="p">}</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;devrait identifier l'utilisateur&quot;</span> <span class="k">do</span>
        <span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:session</span> <span class="o">=&gt;</span> <span class="vi">@attr</span>
        <span class="c1"># Remplir avec les tests pour l'identification de l'utilisateur.</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;devrait rediriger vers la page d'affichage de l'utilisateur&quot;</span> <span class="k">do</span>
        <span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:session</span> <span class="o">=&gt;</span> <span class="vi">@attr</span>
        <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">))</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Ces tests ne réussissent pas encore, mais c'est un bon départ.</p>

<div class="label" id="sec:remember_me"></div>


<h3><a id="sec:9.3.2" href="sign-in-sign-out#sec:remember_me" class="heading"><span class="number">9.3.2</span> Se souvenir de moi</a></h3>


<p>Nous sommes maintenant en mesure de commencer à implémenter notre modèle d'identification, nommément, en se souvenant de l'état «&nbsp;pour toutjours&nbsp;» de l'identification de l'utilisateur et en effaçant la session seulement quand l'utilisateur se déconnecte explicitement. Les fonctions d'identification elles-même finiront par franchir la ligne du traditionnel Modèle-Vue-Contrôleur&nbsp;; en particulier, plusieurs fonctions d'identification auront besoin d'être accessibles dans les contrôleurs tout comme dans les vues. Vous vous souvenez sans doute, de la <a class="ref" href="rails-flavored-ruby#sec:back_to_the_title_helper">section&nbsp;4.2.5</a>, que Ruby fournit un <em>module</em> pratique pour emballer les fonctions ensemble et les inclure à plusieurs endroits, et c'est ce que nous projetons pour les fonctions d'identification. Nous pourrions faire un tout nouveau module pour l'authentification, mais le contrôleur Sessions nous arrive déjà équipé d'un module, nommément <code>SessionsHelper</code>. Plus encore, les <em>helpers</em> sont automatiquement inclus dans les vues Rails, donc tout ce que nous avons besoin de faire pour utiliser les fonctions de l'helper Sessions dans les contrôleurs est d'inclure le module dans le contrôleur Application (<a class="ref" href="sign-in-sign-out#code:sessions_helper_include">extrait&nbsp;9.11</a>).</p>

<div class="label" id="code:sessions_helper_include"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 9.11.</span> <span class="description">Inclure le module helper Sessions dans le contrôleur Application. <br /> <code>app/controllers/application_controller.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">protect_from_forgery</span>
  <span class="kp">include</span> <span class="no">SessionsHelper</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Par défaut, tous les helpers sont accessibles dans les vues (<code>views</code>) mais pas dans les contrôleurs. Nous avons besoin des méthodes de l'helper Sessions aux deux endroits, donc nous devons l'inclure explicitement.</p>

<div class="label" id="sidebar:session_cookie"></div>


<div class="sidebar"><span class="title"><span class="header">Box 9.2.</span><span class="description">Sessions et cookies</span></span>
<p>Parce que HTTP est un <a href="http://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol#HTTP_session_state"><em>protacole sans état</em></a>, les applications web requiérant l'identification des utilisateurs implémentent une façon de pister chaque parcours d'utilisateur de page en page. Une technique pour maintenir l'état de l'identification de l'utilisateur consiste à utiliser la traditionnelle session Rails (via la fonction spéciale <code>sessions</code>) pour enregistrer un <em>rappel symbolique</em> (<code>remember_token</code>) égal à l'identifiant (<code>id</code>) de l'utilisateur&nbsp;:</p>

<pre class="verbatim">  session[:remember_token] = user.id</pre>


<p>Cette objet <code>session</code> rend l'<code>id</code> de l'utilisateur accessible de page en page en l'enregistrant dans un cookie qui expire à la fermeture du navigateur. Sur chaque page, l'application a juste besoin d'appeler&nbsp;:</p>

<pre class="verbatim">  User.find_by_id(session[:remember_token])</pre>


<p>… pour récupérer l'utilisateur. À cause de la façon dont Rails traite les sessions, ce processus est sécurisé&nbsp;; si un utilisateur malicieux essaie de «&nbsp;parodier&nbsp;» l'id d'un utilisateur, Rails détectera une discordance en s'appuyant sur le <em>session id</em> particulier généré pour chaque session.</p>

<p>Pour nos choix de conception de l'application, qui implique des sessions <em>persistantes</em> &mdash;&nbsp;c'est-à-dire des états d'identification qui durent même lorsque le navigateur est fermé&nbsp;&mdash; enregistrer l'identifiant de l'utilisateur constitue un trou de sécurité. Dès que nous cassons le lien entre l'id de session particulier et l'id de l'utilisateur enregistré, un utilisateur malveillant pourrrait s'identifier comme cet utilisateur avec un <code>remember_token</code> égal à l'id de l'utilisateur. Pour <em>fixer</em> ce défaut, nous générons un rappel symbolique unique, sécurisé, pour chaque utilisateur, basé sur l'<code>id</code> et le <code>salt</code> (<em>sel</em>) de l'utilisateur. Plus encore, un rappel symbolique <em>permanent</em> devrait aussi représenter un trou de sécurité &mdash;&nbsp;en inspectant les cookies du navigateur, un utilisateur malveillant pourrait trouver le rappel symbolique et l'utiliser alors pour s'identifier depuis n'importe quel autre ordinateur, n'importe quand. Nous résolvons cela en ajoutant un <em>timestamp</em> (une <em>signature de temps</em>) au rappel symbolique, et ré-initialisons ce rappel chaque fois que l'utilisateur s'identifie sur l'application. Il en résulte une session persistante essentiellement imperméable à l'attaque.</p>
</div>


<p>Nous sommes maintenant prêt pour le premier élément d'identification, la fonction <code>sign_in</code> elle-même. Notre méthode d'authentification consiste à placer un <em>rappel symbolique</em> (<em>remember token</em>) comme cookie sur le navigateur de l'utilisateur (<a class="ref" href="sign-in-sign-out#sidebar:session_cookie">Box&nbsp;9.2</a>), et de l'utiliser ensuite pour trouver l'enregistrement de l'utilisateur dans la base de données à mesure que l'utilisateur navigue de page en page (implémenté à la <a class="ref" href="sign-in-sign-out#sec:current_user">section&nbsp;9.3.3</a>). Le résultat (<a class="ref" href="sign-in-sign-out#code:sign_in_function">extrait&nbsp;9.12</a>) pousse deux choses dans la pile&nbsp;: la table <code>cookies</code> et <code>current_user</code>.<sup class="footnote" id="fnref:9.6"><a href="#fn:9.6">6</a></sup> Commençons à les faire s'exprimer.</p>

<div class="label" id="code:sign_in_function"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 9.12.</span> <span class="description">La fonction <code>sign_in</code> complète (mais pas encore fonctionnelle). <br /> <code>app/helpers/sessions_helper.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>

  <span class="k">def</span> <span class="nf">sign_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">cookies</span><span class="o">.</span><span class="n">permanent</span><span class="o">.</span><span class="n">signed</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="o">[</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">salt</span><span class="o">]</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">current_user</span> <span class="o">=</span> <span class="n">user</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>L'<a class="ref" href="sign-in-sign-out#code:sign_in_function">extrait&nbsp;9.12</a> introduit l'utilitaire <code>cookies</code> fourni par Rails. Nous pouvons utiliser <code>cookies</code> comme si c'était une table&nbsp;; chaque élément dans le cookie est lui-même une table de deux éléments, une <code>value</code> (une <em>valeur</em>) et une date optionnelle <code>expires</code>. Par exemple, nous pourrions implémenter l'identification de l'utilisateur en plaçant un cookie avec une valeur égale à l'<code>id</code> de l'utilisateur qui expire dans vingt ans&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:value</span>   <span class="o">=&gt;</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                             <span class="ss">:expires</span> <span class="o">=&gt;</span> <span class="mi">20</span><span class="o">.</span><span class="n">years</span><span class="o">.</span><span class="n">from_now</span><span class="o">.</span><span class="n">utc</span> <span class="p">}</span>
</pre></div>
</div>


<p>(Ce code utilise l'un des helpers de temps pratique de Rails, comme discuté dans la <a class="ref" href="sign-in-sign-out#sidebar:time_helpers">Box&nbsp;9.3</a>.) Nous pourrions alors récupérer l'utilisateur avec un code comme&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="no">User</span><span class="o">.</span><span class="n">find_by_id</span><span class="p">(</span><span class="n">cookies</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span><span class="p">)</span>
</pre></div>
</div>


<p>Bien sûr, <code>cookies</code> n'est pas <em>vraiment</em> une table, puisque renseigner un <code>cookie</code>, en fait, <em>enregistre</em> une petite pièce de texte sur le navigateur (comme vu dans l'<a class="ref" href="sign-in-sign-out#fig:user_remember_token_cookie_rails_3">illustration&nbsp;9.7</a>), mais une part de la beauté de Rails est qu'il vous laisse oublier ce genre de détail et se concentre sur l'écriture de l'application.</p>

<div class="label" id="fig:user_remember_token_cookie_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_remember_token_cookie_rails_3.png" alt="user_remember_token_cookie_rails_3" /></span></div><div class="caption"><span class="header">Illustration 9.7: </span><span class="description">Un rappel symbolique sécurisé.&nbsp;<a href="http://railstutorial.org/images/figures/user_remember_token_cookie_rails_3-full.png">(taille normale)</a></span></div></div>


<p>Malheureusement, utiliser l'<code>id</code> de l'utilisateur de cette manière n'est pas très sûr, pour des raisons discutées dans le <a class="ref" href="sign-in-sign-out#sidebar:session_cookie">Box&nbsp;9.2</a>&nbsp;: un utilisateur malveillant pourrait simuler un cookie avec l'id donnée, et ainsi permettre l'accès du système à n'importe quel utilisateur. La solution traditionnelle avec Rails&nbsp;3 était de créer un rappel symbolique sécurisé associé au modèle User à utiliser à la place de l'<code>id</code> de l'utilisateur (voyez par exemple la <a href="http://railstutorial.org/chapters/sign-in-sign-out?version=2.3#top">version Rails&nbsp;2.3 du <em>Tutoriel Rails</em></a>). Cette façon de faire est devenue si courante que Rails&nbsp;3 l'implémente maintenant pour nous en utilisant <code>cookies.permanent.signed</code>&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="n">cookies</span><span class="o">.</span><span class="n">permanent</span><span class="o">.</span><span class="n">signed</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="o">[</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">salt</span><span class="o">]</span>
</pre></div>
</div>


<p>L'assignement de la valeur du côté droit est un tableau consistant en un identifiant unique (c'est-à-dire l'<code>id</code> de l'utilisateur) et une valeur sécurisée utilisée pour créer une <a href="http://en.wikipedia.org/wiki/Digital_signature">signature digitale</a> pour empêcher le genre d'attaque décrite à la <a class="ref" href="modeling-and-viewing-users-two#sec:secure_passwords">section&nbsp;7.2</a>. En particulier, puisque nous avons pris la peine de créer un <em>salt</em> sécurisé à la <a class="ref" href="modeling-and-viewing-users-two#sec:implementing_has_password">section&nbsp;7.2.3</a>, nous pouvons réutiliser cette valeur ici pour signer le rappel symbolique. Sous le capot, utiliser <code>permanent</code> fait que Rails règle l'expiration à <code>20.years.from_now</code>, et <code>signed</code> rend le cookie sécurisé, de telle sorte que l'<code>id</code> de l'utilisateur  n'est jamais exposé dans le navigateur (nous verrons comment récupérer l'utilisateur en utilisant le rappel symbolique à la <a class="ref" href="sign-in-sign-out#sec:current_user">section&nbsp;9.3.3</a>).</p>

<p>Le code ci-dessus montre l'importance d'utiliser <code>new_record?</code> dans l'<a class="ref" href="modeling-and-viewing-users-two#code:has_password_with_encrypt">extrait&nbsp;7.10</a> pour sauver le <em>sel</em> seulement à la création de l'utilisateur. Dans le cas contraire, ce <code>salt</code> changerait chaque fois que l'utilisateur est enregistré, empêchant de récupérer la session de l'utilisateur de la <a class="ref" href="sign-in-sign-out#sec:current_user">section&nbsp;9.3.3</a>.</p>

<div class="label" id="sidebar:time_helpers"></div>


<div class="sidebar"><span class="title"><span class="header">Box 9.3.</span><span class="description">Les cookies expirent <code>20.years.from_now</code> (<em>20.ans.plus_tard</em>)</span></span>
<p>Vous vous souvenez sans doute, de la <a class="ref" href="rails-flavored-ruby#sec:a_class_of_our_own">section&nbsp;4.4.2</a>, que Ruby vous laisse ajouter des méthodes à <em>n'importe quelle</em> classe, même les classes intégrées. Dans la section mentionnée, nous avons ajouté une méthode <code>palindrome?</code> à la classe <code>String</code> (et découvert en résultat que <code>"kayak"</code> était un palindrome), et nous avons vu aussi comment Rails ajoutait une méthode <code>blank?</code> à la classe <code>Object</code> (<em>Objet</em>) (de telle sorte que <code>"".blank?</code>, <code>"&nbsp;".blank?</code> et <code>nil.blank?</code> sont toutes <code>true</code>). Le code du cookie dans l'<a class="ref" href="sign-in-sign-out#code:sign_in_function">extrait&nbsp;9.12</a> (qui définit internalement une cookie qui expire <code>20.years.from_now</code>) donne encore un autre exemple de cette pratique à travers de l'un des <em>helpers de temps</em> Rails, qui sont des méthodes ajoutées à la classe <code>Fixnum</code> (la classe de base pour les nombres)&nbsp;:</p>

<pre class="verbatim">  $ rails console
  &gt;&gt; 1.year.from_now
  =&gt; Sun, 13 Mar 2011 03:38:55 UTC +00:00
  &gt;&gt; 10.weeks.ago
  =&gt; Sat, 02 Jan 2010 03:39:14 UTC +00:00</pre>


<p>Rails ajoute d'autres <em>helpers</em> aussi&nbsp;:</p>

<pre class="verbatim">  &gt;&gt; 1.kilobyte
  =&gt; 1024
  &gt;&gt; 5.megabytes
  =&gt; 5242880</pre>


<p>Elles sont utiles pour les validations de téléchargement, rendant plus facile de restreindre, disons, la taille des images téléchargées à <code>5.megabytes</code>.</p>

<p>Bien qu'elle doive être utilisé avec précaution, la flexibilité d'ajouter des méthodes aux classes intégrées permet des ajouts extraordinairement naturels à Ruby. En effet, toute l'élégance de Rails découle en fin de compte de la malléabilité du langage sous-jacent Ruby.</p>
</div>




<div class="label" id="sec:current_user"></div>


<h3><a id="sec:9.3.3" href="sign-in-sign-out#sec:current_user" class="heading"><span class="number">9.3.3</span> Utilisateur courant</a></h3>


<p>Dans cette section, nous apprendrons comment obtenir et définir la session de l'utilisateur courant. Regardons à nous la fonction <code>sign_in</code> pour voir où nous en sommes&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>

  <span class="k">def</span> <span class="nf">sign_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">cookies</span><span class="o">.</span><span class="n">permanent</span><span class="o">.</span><span class="n">signed</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="o">[</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">salt</span><span class="o">]</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">current_user</span> <span class="o">=</span> <span class="n">user</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>


<p>Concentrons-nous maintenant sur la deuxième ligne&nbsp;:<sup class="footnote" id="fnref:9.7"><a href="#fn:9.7">7</a></sup></p>

<div class="code"><div class="highlight"><pre><span class="nb">self</span><span class="o">.</span><span class="n">current_user</span> <span class="o">=</span> <span class="n">user</span>
</pre></div>
</div>


<p>Le but de cette ligne est de créer une variable <code>current_user</code>, accessible aussi bien dans les contrôleurs que dans les vues, ce qui permettra des constructions telles que&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">nom</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>… ou&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="n">redirect_to</span> <span class="n">current_user</span>
</pre></div>
</div>


<p>Le but principal de cette section est de définir <code>current_user</code>.</p>

<p>Pour décrire le comportement de la machinerie d'identification restant à implémenter, nous allons d'abord remplir le test pour l'identification de l'utilisateur (<a class="ref" href="sign-in-sign-out#code:signin_test">extrait&nbsp;9.13</a>).</p>

<div class="label" id="code:signin_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 9.13.</span> <span class="description">Remplir le test pour l'identification de l'utilisateur. <br /> <code>spec/controllers/sessions_controller_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="no">SessionsController</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;POST &#39;create&#39;&quot;</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;avec un email et un mot de passe valides&quot;</span> <span class="k">do</span>

      <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
        <span class="vi">@user</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
        <span class="vi">@attr</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="ss">:password</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password</span> <span class="p">}</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;devrait identifier l'utilisateur&quot;</span> <span class="k">do</span>
        <span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:session</span> <span class="o">=&gt;</span> <span class="vi">@attr</span>
        <span class="n">controller</span><span class="o">.</span><span class="n">current_user</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="vi">@user</span>
        <span class="n">controller</span><span class="o">.</span><span class="n">should</span> <span class="n">be_signed_in</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;devrait rediriger vers la page d'affichage de l'utilisateur&quot;</span> <span class="k">do</span>
        <span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:session</span> <span class="o">=&gt;</span> <span class="vi">@attr</span>
        <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">))</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Le nouveau test utilise la variable <code>controller</code> (<em>contrôleur</em>) (accessible à l'intérieur des tests Rails) pour vérifier que la variable <code>current_user</code> est réglé à l'utilisateur identifié, et que l'utilisateur est identifié&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="s2">&quot;devrait identifier l'utilisateur&quot;</span> <span class="k">do</span>
  <span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:session</span> <span class="o">=&gt;</span> <span class="vi">@attr</span>
  <span class="n">controller</span><span class="o">.</span><span class="n">current_user</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="vi">@user</span>
  <span class="n">controller</span><span class="o">.</span><span class="n">should</span> <span class="n">be_signed_in</span>
<span class="k">end</span>
</pre></div>
</div>


<p>La deuxième ligne peut être un peu déroutante à ce stade, mais vous pouvez deviner en vous fondant sur la convention RSpec pour les méthodes booléenne que&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="n">controller</span><span class="o">.</span><span class="n">should</span> <span class="n">be_signed_in</span>
</pre></div>
</div>


<p>… est équivalent à&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="n">controller</span><span class="o">.</span><span class="n">signed_in?</span><span class="o">.</span><span class="n">should</span> <span class="n">be_true</span>
</pre></div>
</div>


<p>C'est une allusion au fait que nous devrons définit une méthode <code>signed_in?</code> qui retourne <code>true</code> (<em>vrai</em>) si un utilisateur est identifié et <code>false</code> (<em>faux</em>) dans le cas contraire. Plus encore, la méthode <code>signed_in?</code> sera attachée au contrôleur, pas à l'utilisateur, ce qui explique pourquoi nous écrivons <code>controller.signed_in?</code> au lieu de <code>current_user.signed_in?</code> (si aucun utilisateur n'est identifié, comment pourrions-nous appelé <code>signed_in?</code> sur lui&nbsp;?).</p>

<p>Pour commencer à écrire le code de <code>current_user</code>, notez que la ligne&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="nb">self</span><span class="o">.</span><span class="n">current_user</span> <span class="o">=</span> <span class="n">user</span>
</pre></div>
</div>


<p>… est un <em>assignement</em>. Ruby possède une syntaxe spéciale pour définir de telle fonction d'assignement, montré dans l'<a class="ref" href="sign-in-sign-out#code:current_user_equals">extrait&nbsp;9.14</a>.</p>

<div class="label" id="code:current_user_equals"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 9.14.</span> <span class="description">Définir l'assignement de <code>current_user</code>. <br /> <code>app/helpers/sessions_helper.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>

  <span class="k">def</span> <span class="nf">sign_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">current_user</span><span class="o">=</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="vi">@current_user</span> <span class="o">=</span> <span class="n">user</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Cela peut sembler déroutant, mais ça définit simplement une méthode  <code>current_user=</code> expressément conçue pour traiter l'assignement de  <code>current_user</code>. Son premier argument est la partie droite de l'assignement, dans ce cas l'utilisateur qui doit être identifié. Le corps d'une ligne de cette méthode définit juste une variable d'instance  <code>@current_user</code>, en enregistrant effectivement l'utilisateur pour un usage ultérieur.</p>

<p>En Ruby ordinaire, nous pourrions définir une deuxième méthode, <code>current_user</code>, conçue pour retourner la valeur de <code>@current_user</code> (<a class="ref" href="sign-in-sign-out#code:current_user_wrong">extrait&nbsp;9.15</a>).</p>

<div class="label" id="code:current_user_wrong"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 9.15.</span> <span class="description">Un définition tentante mais inutile de <code>current_user</code>.</span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>

  <span class="k">def</span> <span class="nf">sign_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">current_user</span><span class="o">=</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="vi">@current_user</span> <span class="o">=</span> <span class="n">user</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">current_user</span>
    <span class="vi">@current_user</span>     <span class="c1"># Inutile&nbsp;! N'utilisez pas cette ligne.</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Si nous faisions ça, nous répliquerions en effet la fonctionnalité de <code>attr_accessor</code>, vue pour la première fois à la <a class="ref" href="rails-flavored-ruby#sec:a_user_class">section&nbsp;4.4.5</a> et utilisée pour créer une <code>password</code> (<em>mot de passe</em>) virtuel à la <a class="ref" href="modeling-and-viewing-users-two#sec:password_validations">section&nbsp;7.1.1</a>.<sup class="footnote" id="fnref:9.8"><a href="#fn:9.8">8</a></sup> Le problème est que ça échoue complètement pour résoudre notre problème&nbsp;: avec le code de l'<a class="ref" href="sign-in-sign-out#code:current_user_wrong">extrait&nbsp;9.15</a>, l'état de l'identification de l'utilisateur serait oublié&nbsp;: dès que l'utilisateur rejoindrait une autre page &mdash;&nbsp;poof&nbsp;!&nbsp;&mdash; la session cesserait et l'utilisateur serait automatiquement déconnecté.</p>

<p>Pour éviter ce problème, nous pouvons trouver la session utilisateur correspondant au cookie créé par le code de l'<a class="ref" href="sign-in-sign-out#code:sign_in_function">extrait&nbsp;9.12</a>, comme montré dans l'<a class="ref" href="sign-in-sign-out#code:current_user_working">extrait&nbsp;9.16</a>.</p>

<div class="label" id="code:current_user_working"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 9.16.</span> <span class="description">Trouver l'utilisateur courant par <code>remember_token</code>. <br /> <code>app/helpers/sessions_helper.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">current_user</span>
    <span class="vi">@current_user</span> <span class="o">||=</span> <span class="n">user_from_remember_token</span>
  <span class="k">end</span>

  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">user_from_remember_token</span>
      <span class="no">User</span><span class="o">.</span><span class="n">authenticate_with_salt</span><span class="p">(</span><span class="o">*</span><span class="n">remember_token</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">remember_token</span>
      <span class="n">cookies</span><span class="o">.</span><span class="n">signed</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">||</span> <span class="o">[</span><span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="o">]</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Ce code utilise plusieurs fonctionnalités plus avancées de Ruby, donc prenons un moment pour les examiner.</p>

<p>D'abord, l'<a class="ref" href="sign-in-sign-out#code:current_user_working">extrait&nbsp;9.16</a> utilise l'opérateur d'assignement courant mais initialement obscur <code>||=</code> («&nbsp;ou égal&nbsp;») (<a class="ref" href="sign-in-sign-out#sidebar:or_equals">Box&nbsp;9.4</a>). Son effet est de régler la variable d'instance à l'utilisateur correspondant au rappel symbolique, mais seulement si <code>@current_user</code> n'est pas défini.<sup class="footnote" id="fnref:9.9"><a href="#fn:9.9">9</a></sup> En d'autres mots, la construction&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="vi">@current_user</span> <span class="o">||=</span> <span class="n">user_from_remember_token</span>
</pre></div>
</div>


<p>… appelle la méthode <code>user_from_remember_token</code> la première fois que <code>current_user</code> est appelé, mais retourne  <code>@current_user</code> au cours des invocations suivantes sans appeler <code>user_from_remember_token</code>.<sup class="footnote" id="fnref:9.10"><a href="#fn:9.10">10</a></sup></p>

<div class="label" id="sidebar:or_equals"></div>


<div class="sidebar"><span class="title"><span class="header">Box 9.4.</span><span class="description">Qu'est-ce que c'est que *$@! <code>||=</code>&nbsp;? </span></span>
<p>La construction <code>||=</code> est très «&nbsp;Ruby-iche&nbsp;» &mdash;c'est-à-dire qu'elle est hautement caractéristique du langage Ruby&nbsp;&mdash; et donc importante à apprendre si vous projetez de faire plus de programmation Ruby. Bien qu'au début elle puisse sembler mystérieuse, <em>ou égal</em> est facile à comprendre par analogie.</p>

<p>Nous commençons par noter un idiome commun pour changer une variable déjà définie. De nombreux programme informatiques utilise l'incrémentation de variable, comme dans&nbsp;:</p>

<pre class="verbatim">  x = x + 1</pre>


<p>La plupart des langages fournissent un raccourci sémantique pour cette opération&nbsp;; en Ruby (et en C, C++, Perl, Pytho, Java, etc.), il apparait ainsi&nbsp;:</p>

<pre class="verbatim">  x += 1</pre>


<p>Des constructions analogues existent de la même façon pour d'autres opérateurs&nbsp;:</p>

<pre class="verbatim">  $ rails console
  &gt;&gt; x = 1
  =&gt; 1
  &gt;&gt; x += 1
  =&gt; 2
  &gt;&gt; x *= 3
  =&gt; 6
  &gt;&gt; x -= 7
  =&gt; -1</pre>


<p>Dans chaque cas, le modèle est que <code>x = x O y</code> et <code>x O= y</code> sont équivalents pour n'importe quel opérateur <code>O</code>.</p>

<p>Une autre pattern courante de Ruby est d'assigner une variable si elle est null (<code>nil</code>) mais de la laisser telle quelle dans le cas contraire. En vous souvenant de l'opérateur&nbsp;<em>ou</em> <code>||</code> vu à la <a class="ref" href="rails-flavored-ruby#sec:objects_and_message_passing">section&nbsp;4.2.3</a>, nous pouvons écrire cela comme suit&nbsp;:</p>

<pre class="verbatim">  &gt;&gt; @user
  =&gt; nil
  &gt;&gt; @user = @user || &quot;l'utilisateur &quot;
  =&gt; &quot;the user&quot;
  &gt;&gt; @user = @user || &quot;un autre utilisateur&quot;
  =&gt; &quot;the user&quot;</pre>


<p>Puisque <code>nil</code> est faux dans un contexte booléen, le premier assignement est <code>nil || "l'utilisateur"</code>, qui est évalué à <code>"l'utilisateur"</code>&nbsp;; de façon similaire, le second assignement est <code>"l'utilisateur" || "un autre utilisateur"</code>, qui est aussi évalué à <code>"l'utilisateur"</code> &mdash;puisque les chaines de caractères sont <code>true</code> (<em>vrai</em>) dans un contexte booléen, [(the series of <code>||</code> expressions terminates after the first expression is evaluated)(les séries d'expressions <code>||</code> qui termine après la première expression est évaluée)] (cette pratique d'évaluer les expressions <code>||</code> de gauche à droite et de s'arrêter à la première valeur vraie est connue sous le nom de <em>évaluation court-circuit</em>).</p>

<p>En comparant les sessions de console pour une variété d'opérateurs, nous voyons que <code>@user = @user || value</code> suit le modèle <code>x = x O y</code> avec <code>||</code> à la place de <code>O</code>, ce qui suggère la construction équivalente suivante&nbsp;:</p>

<pre class="verbatim">  &gt;&gt; @user ||= &quot;the user&quot;
  =&gt; &quot;the user&quot;</pre>


<p>Voil&agrave;&nbsp;!</p>
</div>


<p>L'<a class="ref" href="sign-in-sign-out#code:current_user_working">extrait&nbsp;9.16</a> utilise aussi l'opérateur&nbsp;<code>*</code>, qui nous permet d'utiliser un tableau à deux éléments comme argument pour une méthode attendant deux variables, comme nous pouvons le voir dans la session de console&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="n">bar</span><span class="p">,</span> <span class="n">baz</span><span class="p">)</span>
<span class="gp">?&gt; </span>  <span class="n">bar</span> <span class="o">+</span> <span class="n">baz</span>
<span class="gp">?&gt; </span><span class="k">end</span>
<span class="go">=&gt; nil</span>
<span class="gp">&gt;&gt; </span><span class="n">foo</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="go">=&gt; 3</span>
<span class="gp">&gt;&gt; </span><span class="n">foo</span><span class="p">(</span><span class="o">*[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">]</span><span class="p">)</span>
<span class="go">=&gt; 3</span>
</pre></div>
</div>


<p>La raison pour laquelle c'est nécessaire dans l'<a class="ref" href="sign-in-sign-out#code:current_user_working">extrait&nbsp;9.16</a> est que <code>cookies.signed[:remember_me]</code> retourne un tableau de deux éléments &mdash;&nbsp;l'<code>id</code> de l'utilisateur et le <code>salt</code>&nbsp;&mdash; mais, (en suivant les conventions de Ruby) nous voulons que la méthode <code>authenticate_with_salt</code> prenne deux arguments, donc elle peut être invoquée avec&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="no">User</span><span class="o">.</span><span class="n">authenticate_with_salt</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">salt</span><span class="p">)</span>
</pre></div>
</div>


<p>(Il n'existe pas de raison fondamentale pour que <code>authenticate_with_salt</code> ne puisse prendre un tableau comme argument, mais ce ne serait pas idiomatiquement correct en Ruby.)</p>

<p>Enfin, dans la méthode d'helper <code>remember_token</code> définie par l'<a class="ref" href="sign-in-sign-out#code:current_user_working">extrait&nbsp;9.16</a>, nous utilisons l'opérateur&nbsp;<code>||</code> pour retourner un <em>tableau</em> de valeurs nulles si <code>cookies.signed[:remember_me]</code> lui-même est nul&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="n">cookies</span><span class="o">.</span><span class="n">signed</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">||</span> <span class="o">[</span><span class="kp">nil</span><span class="p">,</span> <span class="kp">nil</span><span class="o">]</span>
</pre></div>
</div>


<p>La raison d'être de ce code est que le support pour les tests des cookies d'identification est encore jeune, et la valeur <code>nil</code> pour le cookie occasionne des cassures de test fallacieux. Retourner plutôt <code>[nil, nil]</code> règle ce problème.<sup class="footnote" id="fnref:9.11"><a href="#fn:9.11">11</a></sup></p>

<p>L'étape finale pour obtenir que le code de l'<a class="ref" href="sign-in-sign-out#code:current_user_working">extrait&nbsp;9.16</a> fonctionne est de définir une méthode de classe <code>authenticate_with_salt</code>. Cette méthode, qui est analogue à la méthode originale <code>authenticate</code> définie dans l'<a class="ref" href="modeling-and-viewing-users-two#code:authenticate_method">extrait&nbsp;7.12</a>, est montrée dans l'<a class="ref" href="sign-in-sign-out#code:authenticate_with_salt">extrait&nbsp;9.17</a>.</p>

<div class="label" id="code:authenticate_with_salt"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 9.17.</span> <span class="description">Ajout d'une méthode <code>authenticate_with_salt</code> au modèle User. <br /> <code>app/models/user.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">authenticate</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">submitted_password</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">find_by_email</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
    <span class="k">return</span> <span class="kp">nil</span>  <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">nil?</span>
    <span class="k">return</span> <span class="n">user</span> <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">has_password?</span><span class="p">(</span><span class="n">submitted_password</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">authenticate_with_salt</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">cookie_salt</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">find_by_id</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
    <span class="p">(</span><span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">salt</span> <span class="o">==</span> <span class="n">cookie_salt</span><span class="p">)</span> <span class="p">?</span> <span class="n">user</span> <span class="p">:</span> <span class="kp">nil</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Ici, <code>authenticate_with_salt</code> commence par trouver l'utilisateur par son <code>id</code> unique, et vérifie alors que le <code>salt</code> enregistré dans le cookie est bien celui de l'utilisateur.</p>

<p>Il est important de noter que cette implémentation de <code>authenticate_with_salt</code> est identique à la fonction du code suivant, qui est plus proche de la méthode <code>authenticate</code>&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">authenticate_with_salt</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">cookie_salt</span><span class="p">)</span>
  <span class="n">user</span> <span class="o">=</span> <span class="n">find_by_id</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
  <span class="k">return</span> <span class="kp">nil</span>  <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">nil?</span>
  <span class="k">return</span> <span class="n">user</span> <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">salt</span> <span class="o">==</span> <span class="n">cookie_salt</span>
<span class="k">end</span>
</pre></div>
</div>


<p>Dans les deux cas, la méthode retourne l'utilisateur si <code>user</code> est pas <code>nil</code> et si le <em>sel</em> de l'utilisateur correspond au <em>sel</em> du cookie, et retourne <code>nil</code> dans le cas contraire. D'un autre côté, le code tel que&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="p">(</span><span class="n">user</span> <span class="o">&amp;&amp;</span> <span class="n">user</span><span class="o">.</span><span class="n">salt</span> <span class="o">==</span> <span class="n">cookie_salt</span><span class="p">)</span> <span class="p">?</span> <span class="n">user</span> <span class="p">:</span> <span class="kp">nil</span>
</pre></div>
</div>


<p>… est courant en Ruby idiomatique correct, donc j'ai pensé que c'était une bonne idée de l'introduire. Ce code utilise l'étrange mais utile <em>ternary operator</em> (<em>opérateur ternaire</em>) pour «&nbsp;compresser&nbsp;» une construction <code>if</code>-<code>else</code> en une seule ligne (<a class="ref" href="sign-in-sign-out#sidebar:ternary_operator">Box&nbsp;9.5</a>).</p>

<div class="label" id="sidebar:ternary_operator"></div>


<div class="sidebar"><span class="title"><span class="header">Box 9.5.</span><span class="description">10 types de gens</span></span>
<p>Il y a 10 genres de personnes dans le monde&nbsp;: ceux qui ressemble à l'opérateur ternaire, ceux qui n'y ressemble pas, et ceux qui ne le connaissent pas (si vous faisiez partie de la troisième catégorie, vous n'y appartiendrez plus longtemps).</p>

<p>Quand vous faites beaucoup de programmation, vous apprenez rapidement que l'un des plus courant bloc de contrôle est quelque chose comme&nbsp;:</p>

<pre class="verbatim">  if boolean? # Si ça est vrai
    faire_une_chose 
  else # sinon
    faire_autre_chose
  end # fin </pre>


<p>Ruby, comme la plupart des autres langages (incluant C/C++, Perl, PHP et Java), vous permettent de remplacer ça part une expression plus compacte en utilisant l'<em>opérateur ternaire</em> (appelé ainsi parce qu'il est constitué de trois parties)&nbsp;:</p>

<pre class="verbatim">  boolean? ? faire_une_chose : faire_autre_chose </pre>


<p>Vous pouvez aussi utiliser l'opérateur ternaire pour remplacer l'assignement&nbsp;:</p>

<pre class="verbatim">  if boolean?
    var = foo
  else 
    var = bar
  end </pre>


<p>… devient alors&nbsp;:</p>

<pre class="verbatim">  var = boolean? ? foo : bar</pre>


<p>L'opérateur ternaire est courant en Ruby idiomatique, donc c'est une bonne idée de chercher les opportunités de l'utiliser.</p>
</div>


<p>À ce point où nous en sommes, le test d'identification réussit presque&nbsp;; la seule chose restant à faire est de définir la méthode booléenne <code>signed_in?</code>. Heureusement, c'est facile avec l'utilisation de l'opérateur «&nbsp;not&nbsp;» (<em>pas</em>)&nbsp;<code>!</code>&nbsp;: un utilisateur est identifié si <code>current_user</code> n'est <em>pas</em> <code>nil</code> (<a class="ref" href="sign-in-sign-out#code:signed_in_p">extrait&nbsp;9.18</a>).</p>

<div class="label" id="code:signed_in_p"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 9.18.</span> <span class="description">La méthode d'helper <code>signed_in?</code>. <br /> <code>app/helpers/sessions_helper.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">signed_in?</span>
    <span class="o">!</span><span class="n">current_user</span><span class="o">.</span><span class="n">nil?</span>
  <span class="k">end</span>

  <span class="kp">private</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Bien qu'elle soit déjà utile pour le test, nous allons revoir la méthode <code>signed_in?</code> pour un meilleur usage encore à la <a class="ref" href="sign-in-sign-out#sec:changing_the_layout_links">section&nbsp;9.4.3</a> et encore au <a class="ref" href="updating-showing-and-deleting-users#top">chapitre&nbsp;10</a>.</p>

<p>Avec ça, tous les tests devraient réussir.</p>

<div class="label" id="sec:signing_out"></div>


<h2><a id="sec:9.4" href="sign-in-sign-out#sec:signing_out" class="heading"><span class="number">9.4</span> Déconnexion</a></h2>


<p>Comme discuté à la <a class="ref" href="sign-in-sign-out#sec:sessions">section&nbsp;9.1</a>, notre modèle d'authentification est de garder les utilisateurs identifiés jusqu'à ce qu'ils se déconnectent explicitement. Dans cette section, nous allons ajouter les fonctionnalités nécessaires à la déconnexion. Une fois cela fait, nous ajouterons quelques tests d'intégration pour mettre à l'épreuve notre machinerie de déconnexion.</p>

<div class="label" id="sec:destroying_sessions"></div>


<h3><a id="sec:9.4.1" href="sign-in-sign-out#sec:destroying_sessions" class="heading"><span class="number">9.4.1</span> Détruire les sessions</a></h3>


<p>Jusqu'ici, les actions du contrôleur Sessions ont suivi la convention REST en utilisant <code>new</code> pour une page d'identification et <code>create</code> pour achever l'identification. Nous allons poursuivre sur cette voie en utilisant une action <code>destroy</code> pour effacer la sessions, c'est-à-dire pour se déconnecter.</p>

<p>Pour tester l'action déconnexion, nous avons d'abord besoin d'un moyen de s'identifier dans le test. La façon la plus facile de faire ça est d'utiliser l'objet <code>controller</code> vu à la <a class="ref" href="sign-in-sign-out#sec:current_user">section&nbsp;9.3.3</a> et d'utiliser l'helper <code>sign_in</code> pour identifier l'utilisateur donné. Pour pouvoir utiliser la fonction <code>test_sign_in</code> en résultant dans tous nos tests, nous devons la placer dans le fichier helper spec, comme vu dans l'<a class="ref" href="sign-in-sign-out#code:test_sign_in">extrait&nbsp;9.19</a>.<sup class="footnote" id="fnref:9.12"><a href="#fn:9.12">12</a></sup></p>

<div class="label" id="code:test_sign_in"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 9.19.</span> <span class="description">Une fonction <code>test_sign_in</code> pour simuler l'identification de l'utilisateur à l'intérieur des tests. <br /> <code>spec/spec_helper.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="no">Rspec</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">test_sign_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">controller</span><span class="o">.</span><span class="n">sign_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Après avoir joué <code>test_sign_in</code>, <code>current_user</code> ne sera pas <code>nil</code>, donc <code>signed_in?</code> renverra <code>true</code> (<em>vrai</em>).</p>

<p>Avec cet helper spec en main, le test pour la déconnexion est simple&nbsp;: s'identifier avec un utilisateur (d'usine) et alors invoquer l'action <code>destroy</code> et vérifier que l'utilisateur se trouve déconnecté (<a class="ref" href="sign-in-sign-out#code:destroy_session_test">extrait&nbsp;9.20</a>).</p>

<div class="label" id="code:destroy_session_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 9.20.</span> <span class="description">Un test de destruction de la session (déconnexion utilisateur). <br /> <code>spec/controllers/sessions_controller_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="no">SessionsController</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;DELETE &#39;destroy&#39;&quot;</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">&quot;devrait déconnecter un utilisateur&quot;</span> <span class="k">do</span>
      <span class="n">test_sign_in</span><span class="p">(</span><span class="no">Factory</span><span class="p">(</span><span class="ss">:user</span><span class="p">))</span>
      <span class="n">delete</span> <span class="ss">:destroy</span>
      <span class="n">controller</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_signed_in</span>
      <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">root_path</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Le seul nouvel élément ici est la méthode <code>delete</code>, qui répond à la requête HTTP <tt>DELETE</tt> (en analogie aux méthodes <code>get</code> et <code>post</code> vues dans les précédents tests), comme l'exige les conventions REST (<a class="ref" href="sign-in-sign-out#table:RESTful_sessions">Table&nbsp;9.1</a>).</p>

<p>Comme avec l'identification de l'utilisateur, qui est reliée à la fonction <code>sign_in</code>, la déconnexion de l'utilisateur confie juste le dur boulot à la fonction <code>sign_out</code> (<a class="ref" href="sign-in-sign-out#code:destroy_session">extrait&nbsp;9.21</a>).</p>

<div class="label" id="code:destroy_session"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 9.21.</span> <span class="description">Détruire une session (déconnexion utilisateur). <br /> <code>app/controllers/sessions_controller.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="n">sign_out</span>
    <span class="n">redirect_to</span> <span class="n">root_path</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Comme avec les autres éléments d'authentification, nous placerons <code>sign_out</code> dans le module helper Sessions (<a class="ref" href="sign-in-sign-out#code:sign_out_method">extrait&nbsp;9.22</a>).</p>

<div class="label" id="code:sign_out_method"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 9.22.</span> <span class="description">La méthode <code>sign_out</code> dans le module helper Sessions. <br /> <code>app/helpers/sessions_helper.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>

  <span class="k">def</span> <span class="nf">sign_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">cookies</span><span class="o">.</span><span class="n">permanent</span><span class="o">.</span><span class="n">signed</span><span class="o">[</span><span class="ss">:remember_token</span><span class="o">]</span> <span class="o">=</span> <span class="o">[</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">salt</span><span class="o">]</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">current_user</span> <span class="o">=</span> <span class="n">user</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">sign_out</span>
    <span class="n">cookies</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="ss">:remember_token</span><span class="p">)</span>
    <span class="nb">self</span><span class="o">.</span><span class="n">current_user</span> <span class="o">=</span> <span class="kp">nil</span>
  <span class="k">end</span>

  <span class="kp">private</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Comme vous pouvez le voir, la méthode <code>sign_out</code> effectivement annule la méthode <code>sign_in</code> en effaçant le rappel symbolique (<code>remember token</code>) et en réglant l'utilisateur courant  à <code>nil</code>.<sup class="footnote" id="fnref:9.13"><a href="#fn:9.13">13</a></sup></p>

<div class="label" id="sec:signin_upon_signup"></div>


<h3><a id="sec:9.4.2" href="sign-in-sign-out#sec:signin_upon_signup" class="heading"><span class="number">9.4.2</span> Connexion à l'inscription</a></h3>


<p>En principe, nous en avons fini avec l'authentification, mais telle que se présente l'application actuellement, il n'y a pas de liens pour les actions d'identification et de déconnexion. Plus encore, les tout nouveaux utilisateurs enregistrés peuvent être déroutés de ne pas être identifiés par défaut à l'inscription.</p>

<p>Nous allons fixer ce second problème d'abord, en commençant par tester qu'un nouvel utilisateur est automatiquement identifié (<a class="ref" href="sign-in-sign-out#code:sign_up_sign_in">extrait&nbsp;9.23</a>).</p>

<div class="label" id="code:sign_up_sign_in"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 9.23.</span> <span class="description">Tester qu'un nouvel utilisateur soit aussi identifié. <br /> <code>spec/controllers/users_controller_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">UsersController</span> <span class="k">do</span>
  <span class="n">render_views</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;POST &#39;create&#39;&quot;</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;success&quot;</span> <span class="k">do</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="n">it</span> <span class="s2">&quot;devrait identifier l'utilisateur&quot;</span> <span class="k">do</span>
        <span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="vi">@attr</span>
        <span class="n">controller</span><span class="o">.</span><span class="n">should</span> <span class="n">be_signed_in</span>
      <span class="k">end</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Avec la méthode <code>sign_in</code> de la <a class="ref" href="sign-in-sign-out#sec:signin_success">section&nbsp;9.3</a>, faire que le test réussisse en identifiant un utilisateur est facile&nbsp;: ajoutez juste <code>sign_in @user</code> juste après avoir sauver l'utilisateur dans la base de données (<a class="ref" href="sign-in-sign-out#code:signin_upon_signup">extrait&nbsp;9.24</a>).</p>

<div class="label" id="code:signin_upon_signup"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 9.24.</span> <span class="description">Identifier l'utilisateur après son inscription. <br /> <code>app/controllers/users_controller.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
      <span class="n">sign_in</span> <span class="vi">@user</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Bienvenue dans l'Application Exemple&nbsp;!&quot;</span>
      <span class="n">redirect_to</span> <span class="vi">@user</span>
    <span class="k">else</span>
      <span class="vi">@titre</span> <span class="o">=</span> <span class="s2">&quot;Sign up&quot;</span>
      <span class="n">render</span> <span class="s1">&#39;new&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="sec:changing_the_layout_links"></div>


<h3><a id="sec:9.4.3" href="sign-in-sign-out#sec:changing_the_layout_links" class="heading"><span class="number">9.4.3</span> Changement des liens de la mise en plage</a></h3>


<p>Nous en arrivons finalement à une application pratique pour tout nos travaux d'identification et d'inscription&nbsp;: nous allons changer les liens du layout en s'appuyant sur l'état de l'identification. En particulier, comme le montre la maquette de l'<a class="ref" href="sign-in-sign-out#fig:signin_success_mockup">illustration&nbsp;9.6</a>, nous allons faire en sorte que les liens changent suivant que l'utilisateur est identifié ou déconnecté, et nous allons ajouter aussi un lien vers la page de profil pour un utilisateur identifié.</p>

<p>Nous commençons avec les deux tests d'intégration&nbsp;: un pour vérifier que le lien <code>"S'inscrire"</code> est visible pour un utilisateur non identifié, et un pour vérifier que le lien <code>Déconnexion</code> soit visible pour un utilisateur identifié&nbsp;; ces deux cas vérifient que le lien conduise à l'URL appropriée. Nous placerons ces tests dans le test des liens du layout que nous avons créé à la <a class="ref" href="filling-in-the-layout#sec:integration_tests">section&nbsp;5.2.1</a>&nbsp;; le résultat apparait dans l'<a class="ref" href="sign-in-sign-out#code:signin_layout_test">extrait&nbsp;9.25</a>.</p>

<div class="label" id="code:signin_layout_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 9.25.</span> <span class="description">Tests pour les liens de connexion/déconnexion dans le layout du site. <br /> <code>spec/requests/layout_links_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">&quot;Liens du layout&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;quand pas identifié&quot;</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s2">&quot;doit avoir un lien de connexion&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="n">root_path</span>
      <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="ss">:href</span> <span class="o">=&gt;</span> <span class="n">signin_path</span><span class="p">,</span>
                                         <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="s2">&quot;S'identifier&quot;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;quand identifié&quot;</span> <span class="k">do</span>

    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
      <span class="n">visit</span> <span class="n">signin_path</span>
      <span class="n">fill_in</span> <span class="ss">:email</span><span class="p">,</span>    <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span>
      <span class="n">fill_in</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="o">.</span><span class="n">password</span>
      <span class="n">click_button</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;devrait avoir un lien de déconnxion&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="n">root_path</span>
      <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="ss">:href</span> <span class="o">=&gt;</span> <span class="n">signout_path</span><span class="p">,</span>
                                         <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="s2">&quot;Déconnexion&quot;</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;devrait avoir un lien vers le profil&quot;</span> 
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Ici le bloc <code>before(:each)</code> identifie en visitant la page d'identification et en soumettant une paire email/mot de passe valide.<sup class="footnote" id="fnref:9.14"><a href="#fn:9.14">14</a></sup> Nous faisons cela plutôt que d'utiliser la fonction <code>test_sign_in</code> de l'<a class="ref" href="sign-in-sign-out#code:test_sign_in">extrait&nbsp;9.19</a> parce que <code>test_sign_in</code> ne fonctionne pas à l'intérieur des tests d'intégration pour certaines raisons (voir la <a class="ref" href="sign-in-sign-out#sec:sign_in_out_exercises">section&nbsp;9.6</a> pour un exercice pour construire une fonction <code>integration_sign_in</code> à l'usage des tests d'intégration).</p>

<p>Le code de l'application utilise une structure de branchement si-alors à l'intérieur du code Ruby embarqué, en utilisant la méthode <code>signed_in?</code> définie dans l'<a class="ref" href="sign-in-sign-out#code:signed_in_p">extrait&nbsp;9.18</a>&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">signed_in?</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Déconnexion&quot;</span><span class="p">,</span> <span class="n">signout_path</span><span class="p">,</span> <span class="ss">:method</span> <span class="o">=&gt;</span> <span class="ss">:delete</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
<span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;S'identifier&quot;</span><span class="p">,</span> <span class="n">signin_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>Remarquez que le lien de déconnexion passe un argument table indiquant qu'il devrait soumettre avec une requête HTTP <tt>DELETE</tt>.<sup class="footnote" id="fnref:9.15"><a href="#fn:9.15">15</a></sup> Avec ce fragment ajouté, l'entête complète du partiel apparait comme dans l'<a class="ref" href="sign-in-sign-out#code:layout_signin_signout_links">extrait&nbsp;9.26</a>.</p>

<div class="label" id="code:layout_signin_signout_links"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 9.26.</span> <span class="description">Changer les liens du layout links pour l'utilisateur identifié. <br /> <code>app/views/layouts/_header.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;header&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">logo</span><span class="p">,</span> <span class="n">root_path</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;nav</span> <span class="na">class=</span><span class="s">&quot;round&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;ul&gt;</span>
      <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Home&quot;</span><span class="p">,</span> <span class="n">root_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
      <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Help&quot;</span><span class="p">,</span> <span class="n">help_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">signed_in?</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Déconnexion&quot;</span><span class="p">,</span> <span class="n">signout_path</span><span class="p">,</span> <span class="ss">:method</span> <span class="o">=&gt;</span> <span class="ss">:delete</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;S'identifier&quot;</span><span class="p">,</span> <span class="n">signin_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/ul&gt;</span>
  <span class="nt">&lt;/nav&gt;</span>
<span class="nt">&lt;/header&gt;</span>
</pre></div>
</div></div>


<p>Dans l'<a class="ref" href="sign-in-sign-out#code:layout_signin_signout_links">extrait&nbsp;9.26</a> nous avons utilisé l'helper <code>logo</code> des exercices du <a class="ref" href="filling-in-the-layout#top">chapitre&nbsp;5</a> (<a class="ref" href="filling-in-the-layout#sec:layout_exercises">section&nbsp;5.5</a>)&nbsp;; dans le cas où vous n'auriez pas fait cet exercice, la réponse apparait dans l'<a class="ref" href="sign-in-sign-out#code:logo_helper_solution">extrait&nbsp;9.27</a>.</p>

<div class="label" id="code:logo_helper_solution"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 9.27.</span> <span class="description">Un helper pour le logo du site. <br /> <code>app/helpers/application_helper.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">ApplicationHelper</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">logo</span>
    <span class="n">image_tag</span><span class="p">(</span><span class="s2">&quot;logo.png&quot;</span><span class="p">,</span> <span class="ss">:alt</span> <span class="o">=&gt;</span> <span class="s2">&quot;Application Exemple&quot;</span><span class="p">,</span> <span class="ss">:class</span> <span class="o">=&gt;</span> <span class="s2">&quot;round&quot;</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Enfin, ajoutons le lien vers le profil. Le test (<a class="ref" href="sign-in-sign-out#code:profile_link_test">extrait&nbsp;9.28</a>) et le code de l'application (<a class="ref" href="sign-in-sign-out#code:profile_link">extrait&nbsp;9.29</a>) sont tous deux extrêmement simples. Remarquez que l'URL du lien vers le profil est simplement <code>current_user</code>,<sup class="footnote" id="fnref:9.16"><a href="#fn:9.16">16</a></sup> qui est notre première utilisation de cette méthode utile (ça ne sera pas la dernière).</p>

<div class="label" id="code:profile_link_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 9.28.</span> <span class="description">Un test pour le lien du profil. <br /> <code>spec/requests/layout_links_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="s2">&quot;Liens du layout&quot;</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;quand identifié&quot;</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">it</span> <span class="s2">&quot;devrait avoir un lien vers le profil&quot;</span> <span class="k">do</span>
      <span class="n">visit</span> <span class="n">root_path</span>
      <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="ss">:href</span> <span class="o">=&gt;</span> <span class="n">user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">),</span>
                                         <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="s2">&quot;Profil&quot;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="code:profile_link"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 9.29.</span> <span class="description">Ajout du lien vers le profil. <br /> <code>app/views/layouts/_header.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;header&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">logo</span><span class="p">,</span> <span class="n">root_path</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;nav</span> <span class="na">class=</span><span class="s">&quot;round&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;ul&gt;</span>
      <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Accueil&quot;</span><span class="p">,</span> <span class="n">root_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">signed_in?</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Profil&quot;</span><span class="p">,</span> <span class="n">current_user</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Aide&quot;</span><span class="p">,</span> <span class="n">help_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">signed_in?</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Déconnexion&quot;</span><span class="p">,</span> <span class="n">signout_path</span><span class="p">,</span> <span class="ss">:method</span> <span class="o">=&gt;</span> <span class="ss">:delete</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;S'identifier&quot;</span><span class="p">,</span> <span class="n">signin_path</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/ul&gt;</span>
  <span class="nt">&lt;/nav&gt;</span>
<span class="nt">&lt;/header&gt;</span>
</pre></div>
</div></div>


<p>Avec le code de cette section, un utilisateur identifié voit maintenant les deux liens de déconnexion et de profil, comme voulu (<a class="ref" href="sign-in-sign-out#fig:profile_with_signout_link">illustration&nbsp;9.8</a>).</p>

<div class="label" id="fig:profile_with_signout_link"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/profile_with_signout_link.png" alt="profile_with_signout_link" /></span></div><div class="caption"><span class="header">Illustration 9.8: </span><span class="description">Un utilisateur identifié avec les liens déconnexion et profil.&nbsp;<a href="http://railstutorial.org/images/figures/profile_with_signout_link-full.png">(taille normale)</a></span></div></div>




<div class="label" id="sec:signin_out_integration_tests"></div>


<h3><a id="sec:9.4.4" href="sign-in-sign-out#sec:signin_out_integration_tests" class="heading"><span class="number">9.4.4</span> Test d'intégration pour l'identification et la déconnexion</a></h3>


<p>Comme pierre angulaire de notre dur labeur sur l'authentification, nous allons finir avec les tests d'intégration pour l'identification et la déconnexion (placé dans le fichier <code>users_spec.rb</code> pour le côté pratique). Le testing d'intégration RSpec est suffisamment expressif pour que l'<a class="ref" href="sign-in-sign-out#code:sign_in_out_integration_tests">extrait&nbsp;9.30</a> ne demande qu'une toute petite explication&nbsp;; j'aime spécialement l'utilisation de <code>click_link "Déconnexion"</code>, qui ne fait pas que simuler le clic sur le lien de déconnexion dans le navigateur mais produit également une erreur si ce lien n'existe pas &mdash;&nbsp;testant ainsi l'URL, la route nommée, le texte du lien et le changement des liens dans le laxyout en une seule ligne. Si ça n'est pas un test d'<em>integration</em>, je ne sais pas ce que c'est&nbsp;!</p>

<div class="label" id="code:sign_in_out_integration_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 9.30.</span> <span class="description">Un test d'intégration pour l'identification et la déconnxion. <br /> <code>spec/requests/users_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Users&quot;</span> <span class="k">do</span>

  <span class="n">describe</span> <span class="s2">&quot;signup&quot;</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;identification/déconnexion&quot;</span> <span class="k">do</span>

    <span class="n">describe</span> <span class="s2">&quot;l'échec&quot;</span> <span class="k">do</span>
      <span class="n">it</span> <span class="s2">&quot;ne devrait pas identifier l'utilisateur&quot;</span> <span class="k">do</span>
        <span class="n">visit</span> <span class="n">signin_path</span>
        <span class="n">fill_in</span> <span class="ss">:email</span><span class="p">,</span>    <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span>
        <span class="n">fill_in</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span>
        <span class="n">click_button</span>
        <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;div.flash.error&quot;</span><span class="p">,</span> <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="s2">&quot;Invalid&quot;</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">&quot;le succès&quot;</span> <span class="k">do</span>
      <span class="n">it</span> <span class="s2">&quot;devrait identifier un utilisateur puis le déconnecter&quot;</span> <span class="k">do</span>
        <span class="n">user</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
        <span class="n">visit</span> <span class="n">signin_path</span>
        <span class="n">fill_in</span> <span class="ss">:email</span><span class="p">,</span>    <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span>
        <span class="n">fill_in</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span>
        <span class="n">click_button</span>
        <span class="n">controller</span><span class="o">.</span><span class="n">should</span> <span class="n">be_signed_in</span>
        <span class="n">click_link</span> <span class="s2">&quot;Déconnexion&quot;</span>
        <span class="n">controller</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_signed_in</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>




<h2><a id="sec:9.5" href="sign-in-sign-out#sec:9.5" class="heading"><span class="number">9.5</span> Conclusion</a></h2>


<p>Nous avons couvert un grand nombre de points dans ce chapitre, transformant notre application prometteuse mais informe en site capable d'accomplir une pleine suite de registration et d'identification. Tout ce qu'il reste à faire pour achever l'authentification est de restreindre l'accès aux pages en s'appuyant sur l'état de l'identification et l'identité de l'utilisateur. Nous accomplirons ces tâches tout en donnant à l'utilisateur la possibilité de modifier ses informations et en donnant aux administrations la capacité de supprimer des utilisateurs.</p>

<p>Mais avant de poursuivre, fusionnons nos changement dans la branche maitresse de notre repository&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">&quot;Fini avec l'identification et la deconnexion&quot;</span>
<span class="gp">$</span> git checkout master
<span class="gp">$</span> git merge sign-in-out
</pre></div>
</div>


<div class="label" id="sec:sign_in_out_exercises"></div>


<h2><a id="sec:9.6" href="sign-in-sign-out#sec:sign_in_out_exercises" class="heading"><span class="number">9.6</span> Exercises</a></h2>


<p>Le deuxième et troisième exercices sont plus difficiles que d'habitude. Les résoudre nécessitera des recherches externes (par exemple la consultation de l'API Rails et des recherches Google), mais ils peuvent être sautés sans perte de la continuité du livre.</p>

<ol>

<li>Plusieurs des spécifications d'intégration utilisent le même code pour identifier un utilisateur. Remplacez ce code par une fonction <code>integration_sign_in</code> dans l'<a class="ref" href="sign-in-sign-out#code:integration_sign_in">extrait&nbsp;9.31</a> et vérifiez que les tests continuent de réussir.</li>

<li>Utilisez la <code>session</code> plutôt que les <code>cookies</code> de telle sorte que les utilisateurs puissent être automatiquement déconnectés quand ils ferment leur navigateur..<sup class="footnote" id="fnref:9.17"><a href="#fn:9.17">17</a></sup> <em>Astuce&nbsp;:</em> faites une recherche Google sur les termes «&nbsp;Rails session&nbsp;».</li>

<li><strong>(avancé)</strong> Certains sites utilisent une connexion sécurisée (HTTPS) pour leurs pages d'identification. Cherchez en ligne pour apprendre comment utiliser HTTPS en Rails, and sécurisez ensuite les actions <code>new</code> et <code>create</code> du contrôleur Sessions. <em>Challenge supplémentaire</em>&nbsp;:écrivez des tests pour les fonctionnalités HTTPS (note&nbsp;: je vous suggère de faire cet exercice seulement en mode développement, ce qui ne nécessitera pas d'obtenir un certificat SSL ou de régler la machinerie de cryptage SSL. En réalité, déployer un site «&nbsp;SSL-enabled&nbsp;» est <em>beaucoup</em> plus difficile).</li>

</ol>




<div class="label" id="code:integration_sign_in"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 9.31.</span> <span class="description">Une fonction pour identifier les utilisateurs à l'intérieur des tests d'intégration. <br /> <code>spec/spec_helper.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="no">Rspec</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">test_sign_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">controller</span><span class="o">.</span><span class="n">sign_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">integration_sign_in</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">visit</span> <span class="n">signin_path</span>
    <span class="n">fill_in</span> <span class="ss">:email</span><span class="p">,</span>    <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span>
    <span class="n">fill_in</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span>
    <span class="n">click_button</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="navigation">  <a class="prev_page" href="sign-up#top">
    &laquo;&nbsp;<span class="number">chapitre 8</span> Inscription
  </a>
  <a class="next_page" href="updating-showing-and-deleting-users#top">
    <span class="number">chapitre 10</span> Actualiser, afficher et supprimer des utilisateurs&nbsp;&raquo;
  </a>
</div><div class="footnotes">
<ol>
<li id="fn:9.1">Un autre modèle courant est de faire expirer la session après un certain laps de temps. C'est spécialement approprié sur les sites qui contiennent des données sensibles, comme les banques et les comptes financiers.&nbsp;<a class="arrow" href="#fnref:9.1">&uarr;</a></li>
<li id="fn:9.2">Nous verrons à la <a class="ref" href="sign-in-sign-out#sec:remember_me">section&nbsp;9.3.2</a> combien de temps signifie en réalité «&nbsp;pour toujours&nbsp;».&nbsp;<a class="arrow" href="#fnref:9.2">&uarr;</a></li>
<li id="fn:9.3">Si on lui donne les actions <code>create</code> et <code>destroy</code>, le script <code>generate</code> construira les <em>vues</em> pour ces actions, ce dont nous n'avons pas besoin. Bien sûr, nous pourrions détruire ces vues, mais j'ai décidé de les omettre de la commande <code>generate</code> et de plutôt définir ces actions à la main.&nbsp;<a class="arrow" href="#fnref:9.3">&uarr;</a></li>
<li id="fn:9.4">Dans le cas où vous vous demanderiez pourquoi nous utilisons <code>user</code> plutôt que <code>@user</code> dans l'<a class="ref" href="sign-in-sign-out#code:signin_failure">extrait&nbsp;9.8</a>, c'est parce que cette variable user n'est jamais demandé dans aucune vue, dont il n'y  a pas de raison de ne pas utiliser un variable d'instance ici (utiliser <code>@user</code> fonctionnerait aussi, cependant).&nbsp;<a class="arrow" href="#fnref:9.4">&uarr;</a></li>
<li id="fn:9.5">Image provenant de <a href="http://www.flickr.com/photos/hermanusbackpackers/3343254977/">http://www.flickr.com/photos/hermanusbackpackers/3343254977/</a>.&nbsp;<a class="arrow" href="#fnref:9.5">&uarr;</a></li>
<li id="fn:9.6">Sur certains systèmes, vous pouvez avoir besoin d'utiliser <code>self.current_user = user</code> pour faire réussir les tests à venir.&nbsp;<a class="arrow" href="#fnref:9.6">&uarr;</a></li>
<li id="fn:9.7">Parce que le module helper Sessions est inclus dans le contrôleur Application, la variable <code>self</code> ici est le contrôleur lui-même.&nbsp;<a class="arrow" href="#fnref:9.7">&uarr;</a></li>
<li id="fn:9.8">En fait, les deux sont exactement équivalents&nbsp;; <code>attr_accessor</code> est simplement une façon pratique de créer automatiquement des méthodes telles que getter et setter.&nbsp;<a class="arrow" href="#fnref:9.8">&uarr;</a></li>
<li id="fn:9.9">Classiquement, cela signifie assigner les valeurs qui sont intialement <code>nil</code>, mais notez que les valeurs <code>false</code> seront également sur-définies par l'opérateur <code>||=</code>.&nbsp;<a class="arrow" href="#fnref:9.9">&uarr;</a></li>
<li id="fn:9.10">Cette technique d'optimisation pour éviter de répéter des appels de fonction est connue sous le noim de <a href="http://fr.wikipedia.org/wiki/M%C3%A9moization"><em>mémoization</em></a>.&nbsp;<a class="arrow" href="#fnref:9.10">&uarr;</a></li>
<li id="fn:9.11">Cela ressemble à l'histoire de la queue qui remue le chien, mais c'est le prix à payer pour rester à la pointe.&nbsp;<a class="arrow" href="#fnref:9.11">&uarr;</a></li>
<li id="fn:9.12">Si vous utilisez Spork, elle sera placée à l'intérieur du bloc <code>Spork.prefork</code>.&nbsp;<a class="arrow" href="#fnref:9.12">&uarr;</a></li>
<li id="fn:9.13">Vous pouvez apprendre des choses sur les choses comme  <code>cookies.delete</code> en lisant l'entrée «&nbsp;cookies&nbsp;» dans l'API Rails (puisque les liens vers l'API Rails tendent à être très vite dépassés, utilisez votre moteur de recherche pour trouver une version actualisée).&nbsp;<a class="arrow" href="#fnref:9.13">&uarr;</a></li>
<li id="fn:9.14">Notez que nous pouvons utiliser les symboles à la place des chaines de caractères pour les labels, par exemple <code>fill_in :email</code> au lieu de <code>fill_in "Email"</code>. Nous utilisons ce dernier dans l'<a class="ref" href="sign-up#code:signup_success_test">extrait&nbsp;8.22</a>, mais maintenant cela ne devrait pas vous surprendre que Rails nous permette d'utiliser plutôt les symboles.&nbsp;<a class="arrow" href="#fnref:9.14">&uarr;</a></li>
<li id="fn:9.15">Les navigateurs web ne peuvent pas, en vérité, transmettre une requête <tt>DELETE</tt>&nbsp;; Rails la simule avec JavaScript.&nbsp;<a class="arrow" href="#fnref:9.15">&uarr;</a></li>
<li id="fn:9.16">De la <a class="ref" href="modeling-and-viewing-users-two#sec:a_user_sidebar">section&nbsp;7.3.3</a> vous vous souvenez que nous pouvons nous lier directement à un objet utilisateur et permettre à Rails de deviner l'URL adéquate.&nbsp;<a class="arrow" href="#fnref:9.16">&uarr;</a></li>
<li id="fn:9.17">Ce qui est un peu déroutant, c'est que nous avons utilisé les <code>cookies</code> pour implémenter les sessions, et la <code>session</code> est implémentée avec les cookies&nbsp;!&nbsp;<a class="arrow" href="#fnref:9.17">&uarr;</a></li>
</ol>
</div>




