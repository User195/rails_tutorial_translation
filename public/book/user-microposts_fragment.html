

<h1 class="title">Tutoriel Ruby on Rails </h1>


<h1 class="subtitle">  Apprendre Rails par l'exemple</h1>


<h2 class="author">Michael Hartl</h2>




<h1 class="contents">Contenu</h1>


<div id="table_of_contents"><ol>
<li class="chapter"><a href="beginning#top"><span class="number">Chapitre 1</span> De zéro au déploiement</a></li>
<li><ol>
<li class="section"><a href="beginning#sec:introduction"><span class="number">1.1</span> Introduction</a></li>
<li><ol>
<li class="subsection"><a href="beginning#sec:comments_for_various_readers"><span class="number">1.1.1</span> Commentaires pour les lecteurs différents</a></li>
<li class="subsection"><a href="beginning#sec:1.1.2"><span class="number">1.1.2</span> &ldquo;Dimensionner&rdquo; Rails</a></li>
<li class="subsection"><a href="beginning#sec:conventions"><span class="number">1.1.3</span> Conventions utilisées dans ce livre</a></li></ol></li>
<li class="section"><a href="beginning#sec:up_and_running"><span class="number">1.2</span> [(Up and running)(En route pour le démarrage)]</a></li>
<li><ol>
<li class="subsection"><a href="beginning#sec:development_tools"><span class="number">1.2.1</span> Environnements de développement</a></li>
<li><ol>
<li class="subsubsection"><a href="beginning#sec:1.2.1.1">IDEs</a></li>
<li class="subsubsection"><a href="beginning#sec:1.2.1.2">Éditeurs de texte et lignes de commande</a></li>
<li class="subsubsection"><a href="beginning#sec:1.2.1.3">Navigateurs</a></li>
<li class="subsubsection"><a href="beginning#sec:1.2.1.4">Note à propos des outils</a></li></ol></li>
<li class="subsection"><a href="beginning#sec:rubygems"><span class="number">1.2.2</span> Ruby, RubyGems, Rails, et Git</a></li>
<li><ol>
<li class="subsubsection"><a href="beginning#sec:rails_installer_windows">Installation de Rails (Windows)</a></li>
<li class="subsubsection"><a href="beginning#sec:install_git">Installer Git</a></li>
<li class="subsubsection"><a href="beginning#sec:install_ruby">Installer Ruby</a></li>
<li class="subsubsection"><a href="beginning#sec:install_rubygems">Installer RubyGems</a></li>
<li class="subsubsection"><a href="beginning#sec:install_rails">Installer Rails</a></li></ol></li>
<li class="subsection"><a href="beginning#sec:the_first_application"><span class="number">1.2.3</span> La première application</a></li>
<li class="subsection"><a href="beginning#sec:bundler"><span class="number">1.2.4</span> Bundler</a></li>
<li class="subsection"><a href="beginning#sec:rails_server"><span class="number">1.2.5</span> <code>Le serveur rails (rails server)</code></a></li>
<li class="subsection"><a href="beginning#sec:mvc"><span class="number">1.2.6</span> Modèles-Vue-Contrôleur (MVC)</a></li></ol></li>
<li class="section"><a href="beginning#sec:version_control"><span class="number">1.3</span> Contrôle de versions avec Git</a></li>
<li><ol>
<li class="subsection"><a href="beginning#sec:git_setup"><span class="number">1.3.1</span> Installation et réglages</a></li>
<li><ol>
<li class="subsubsection"><a href="beginning#sec:1.3.1.1">Initialisation des réglages système</a></li>
<li class="subsubsection"><a href="beginning#sec:1.3.1.2">Initialisation des réglages du dépôt (repository)</a></li></ol></li>
<li class="subsection"><a href="beginning#sec:adding_and_committing"><span class="number">1.3.2</span> Ajout et mandat de dépôt</a></li>
<li class="subsection"><a href="beginning#sec:1.3.3"><span class="number">1.3.3</span> Qu'est-ce que Git peut faire de bien pour vous&nbsp;?</a></li>
<li class="subsection"><a href="beginning#sec:github"><span class="number">1.3.4</span> GitHub</a></li>
<li class="subsection"><a href="beginning#sec:git_commands"><span class="number">1.3.5</span> Branch, edit, commit, merge</a></li>
<li><ol>
<li class="subsubsection"><a href="beginning#sec:git_branch">Branch</a></li>
<li class="subsubsection"><a href="beginning#sec:git_edit">Edit</a></li>
<li class="subsubsection"><a href="beginning#sec:git_commit">Commit</a></li>
<li class="subsubsection"><a href="beginning#sec:git_merge">Merge</a></li>
<li class="subsubsection"><a href="beginning#sec:git_push">Push</a></li></ol></li></ol></li>
<li class="section"><a href="beginning#sec:deploying"><span class="number">1.4</span> Déploiement</a></li>
<li><ol>
<li class="subsection"><a href="beginning#sec:1.4.1"><span class="number">1.4.1</span> Réglages Heroku</a></li>
<li class="subsection"><a href="beginning#sec:heroku_step_one"><span class="number">1.4.2</span> déploiement Heroku, première étape</a></li>
<li class="subsection"><a href="beginning#sec:1.4.3"><span class="number">1.4.3</span> Déploiement Heroku deployment, seconde étape</a></li>
<li class="subsection"><a href="beginning#sec:heroku_commands"><span class="number">1.4.4</span> Commandes Heroku</a></li></ol></li>
<li class="section"><a href="beginning#sec:beginning_conclusion"><span class="number">1.5</span> Conclusion</a></li></ol></li>
<li class="chapter"><a href="a-demo-app#top"><span class="number">Chapitre 2</span> Une application démo</a></li>
<li><ol>
<li class="section"><a href="a-demo-app#sec:planning_the_application"><span class="number">2.1</span> Planifier l'application</a></li>
<li><ol>
<li class="subsection"><a href="a-demo-app#sec:modeling_users"><span class="number">2.1.1</span> Modéliser les utilisateurs</a></li>
<li class="subsection"><a href="a-demo-app#sec:modeling_microposts"><span class="number">2.1.2</span> Modéliser les micro-messages</a></li></ol></li>
<li class="section"><a href="a-demo-app#sec:demo_users_resource"><span class="number">2.2</span> La ressource Utilisateurs (Users)</a></li>
<li><ol>
<li class="subsection"><a href="a-demo-app#sec:a_user_tour"><span class="number">2.2.1</span> Un tour de l'utilisateur</a></li>
<li class="subsection"><a href="a-demo-app#sec:mvc_in_action"><span class="number">2.2.2</span> MVC en action</a></li>
<li class="subsection"><a href="a-demo-app#sec:weaknesses_of_this_users_resource"><span class="number">2.2.3</span> Faiblesses de la ressource Utilisateurs (Users)</a></li></ol></li>
<li class="section"><a href="a-demo-app#sec:microposts_resource"><span class="number">2.3</span> La ressource Micro-messages (Microposts)</a></li>
<li><ol>
<li class="subsection"><a href="a-demo-app#sec:a_micropost_microtour"><span class="number">2.3.1</span> Un petit tour du micro-message</a></li>
<li class="subsection"><a href="a-demo-app#sec:putting_the_micro_in_microposts"><span class="number">2.3.2</span> Appliquer le <em>micro</em> aux micro-messages</a></li>
<li class="subsection"><a href="a-demo-app#sec:demo_user_has_many_microposts"><span class="number">2.3.3</span> Un utilisateur <code>has_many</code> (<code>possède plusieurs</code>) micro-messages</a></li>
<li class="subsection"><a href="a-demo-app#sec:inheritance_hierarchies"><span class="number">2.3.4</span> Hiérarchie des héritages</a></li>
<li class="subsection"><a href="a-demo-app#sec:deploying_the_demo_app"><span class="number">2.3.5</span> Déployer l'application Démo</a></li></ol></li>
<li class="section"><a href="a-demo-app#sec:2.4"><span class="number">2.4</span> Conclusion</a></li></ol></li>
<li class="chapter"><a href="static-pages#top"><span class="number">Chapitre 3</span> Pages statiques courantes</a></li>
<li><ol>
<li class="section"><a href="static-pages#sec:static_pages"><span class="number">3.1</span> Pages statiques</a></li>
<li><ol>
<li class="subsection"><a href="static-pages#sec:truly_static_pages"><span class="number">3.1.1</span> Pages HTML statiques</a></li>
<li class="subsection"><a href="static-pages#sec:static_pages_with_rails"><span class="number">3.1.2</span> Les pages statiques avec Rails</a></li></ol></li>
<li class="section"><a href="static-pages#sec:first_tests"><span class="number">3.2</span> Premiers tests</a></li>
<li><ol>
<li class="subsection"><a href="static-pages#sec:testing_tools"><span class="number">3.2.1</span> Outils de test</a></li>
<li><ol>
<li class="subsubsection"><a href="static-pages#sec:autotest">Auto-test</a></li></ol></li>
<li class="subsection"><a href="static-pages#sec:TDD"><span class="number">3.2.2</span> TDD : Rouge, Vert, Refactor</a></li>
<li><ol>
<li class="subsubsection"><a href="static-pages#sec:spork">Spork</a></li>
<li class="subsubsection"><a href="static-pages#sec:red">Rouge</a></li>
<li class="subsubsection"><a href="static-pages#sec:green">Vert</a></li>
<li class="subsubsection"><a href="static-pages#sec:refactor">Refactor</a></li></ol></li></ol></li>
<li class="section"><a href="static-pages#sec:slightly_dynamic_pages"><span class="number">3.3</span> Pages (un peu) dynamiques</a></li>
<li><ol>
<li class="subsection"><a href="static-pages#sec:testing_a_title_change"><span class="number">3.3.1</span> Test d'un changement de titre</a></li>
<li class="subsection"><a href="static-pages#sec:passing_title_tests"><span class="number">3.3.2</span> Réussir les tests de titre</a></li>
<li class="subsection"><a href="static-pages#sec:instance_variables_embedded_ruby"><span class="number">3.3.3</span> Variables d'instance et Ruby embarqué</a></li>
<li class="subsection"><a href="static-pages#sec:layouts"><span class="number">3.3.4</span> Supprimer les répétitions avec les <em>layouts</em></a></li></ol></li>
<li class="section"><a href="static-pages#sec:static_pages_conclusion"><span class="number">3.4</span> Conclusion</a></li>
<li class="section"><a href="static-pages#sec:static_pages_Exercices"><span class="number">3.5</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="rails-flavored-ruby#top"><span class="number">Chapitre 4</span> [(Rails-flavored Ruby)(Rails au goût Ruby)]</a></li>
<li><ol>
<li class="section"><a href="rails-flavored-ruby#sec:motivation"><span class="number">4.1</span> Motivation</a></li>
<li><ol>
<li class="subsection"><a href="rails-flavored-ruby#sec:title_helper"><span class="number">4.1.1</span> Un « helper » (« aideur ») pour le titre (<code>title</code>)</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:cascading_style_sheets"><span class="number">4.1.2</span> Feuilles de styles (CSS — Cascading Style Sheets)</a></li></ol></li>
<li class="section"><a href="rails-flavored-ruby#sec:strings_and_methods"><span class="number">4.2</span> Chaines de caractères et méthodes</a></li>
<li><ol>
<li class="subsection"><a href="rails-flavored-ruby#sec:comments"><span class="number">4.2.1</span> Commentaires</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:strings"><span class="number">4.2.2</span> Chaines de caractères</a></li>
<li><ol>
<li class="subsubsection"><a href="rails-flavored-ruby#sec:printing">Impression</a></li>
<li class="subsubsection"><a href="rails-flavored-ruby#sec:single_quoted_strings">Chaines de caractères « single-quoté »</a></li></ol></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:objects_and_message_passing"><span class="number">4.2.3</span> Objets et passage de message</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:method_definitions"><span class="number">4.2.4</span> Définition de méthode</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:back_to_the_title_helper"><span class="number">4.2.5</span> Retour à l'« helper » de titre</a></li></ol></li>
<li class="section"><a href="rails-flavored-ruby#sec:other_data_structures"><span class="number">4.3</span> Autres structures de données</a></li>
<li><ol>
<li class="subsection"><a href="rails-flavored-ruby#sec:arrays_and_ranges"><span class="number">4.3.1</span> Tableaux et rangs</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:blocks"><span class="number">4.3.2</span> Blocs</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:hashes_and_symbols"><span class="number">4.3.3</span> Tables de hachage et symboles</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:css_revisited"><span class="number">4.3.4</span> CSS revisitées</a></li></ol></li>
<li class="section"><a href="rails-flavored-ruby#sec:ruby_classes"><span class="number">4.4</span> Classes Ruby</a></li>
<li><ol>
<li class="subsection"><a href="rails-flavored-ruby#sec:constructors"><span class="number">4.4.1</span> Constructeurs</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:a_class_of_our_own"><span class="number">4.4.2</span> Héritages de classes</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:modifying_built_in_classes"><span class="number">4.4.3</span> Modifier les classes d'origine</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:a_controller_class"><span class="number">4.4.4</span> Classe de contrôleur</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:a_user_class"><span class="number">4.4.5</span> Classe utiliateur</a></li></ol></li>
<li class="section"><a href="rails-flavored-ruby#sec:Exercices"><span class="number">4.5</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="filling-in-the-layout#top"><span class="number">Chapitre 5</span> Poursuivre la mise en page</a></li>
<li><ol>
<li class="section"><a href="filling-in-the-layout#sec:structure"><span class="number">5.1</span> Ajout de structure</a></li>
<li><ol>
<li class="subsection"><a href="filling-in-the-layout#sec:adding_to_the_layout"><span class="number">5.1.1</span> Navigation du site</a></li>
<li class="subsection"><a href="filling-in-the-layout#sec:custom_css"><span class="number">5.1.2</span> Personnalisation CSS</a></li>
<li class="subsection"><a href="filling-in-the-layout#sec:partials"><span class="number">5.1.3</span> Partiels (Partials)</a></li></ol></li>
<li class="section"><a href="filling-in-the-layout#sec:layout_links"><span class="number">5.2</span> Liens pour la mise en page</a></li>
<li><ol>
<li class="subsection"><a href="filling-in-the-layout#sec:integration_tests"><span class="number">5.2.1</span> Test d'intégration</a></li>
<li class="subsection"><a href="filling-in-the-layout#sec:rails_routes"><span class="number">5.2.2</span> Routes Rails</a></li>
<li class="subsection"><a href="filling-in-the-layout#sec:named_routes"><span class="number">5.2.3</span> Nommer les routes</a></li></ol></li>
<li class="section"><a href="filling-in-the-layout#sec:user_signup"><span class="number">5.3</span> Inscription de l'utilisateur : une première étape</a></li>
<li><ol>
<li class="subsection"><a href="filling-in-the-layout#sec:users_controller"><span class="number">5.3.1</span> Contrôleur Utilisateur (Users controller)</a></li>
<li class="subsection"><a href="filling-in-the-layout#sec:signup_url"><span class="number">5.3.2</span> URL d'inscription</a></li></ol></li>
<li class="section"><a href="filling-in-the-layout#sec:layout_conclusion"><span class="number">5.4</span> Conclusion</a></li>
<li class="section"><a href="filling-in-the-layout#sec:layout_Exercices"><span class="number">5.5</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="modeling-and-viewing-users-one#top"><span class="number">Chapitre 6</span> Modéliser et afficher les utilisateurs, partie I</a></li>
<li><ol>
<li class="section"><a href="modeling-and-viewing-users-one#sec:user_model"><span class="number">6.1</span> Modèle utilisateur (User model)</a></li>
<li><ol>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:database_migrations"><span class="number">6.1.1</span> Migrations de la base de données</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:the_model_file"><span class="number">6.1.2</span> Le fichier modèle</a></li>
<li><ol>
<li class="subsubsection"><a href="modeling-and-viewing-users-one#sec:model_annotation">[(Model annotation)]</a></li>
<li class="subsubsection"><a href="modeling-and-viewing-users-one#sec:accessible_attributes">Attributs accessibles</a></li></ol></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:creating_user_objects"><span class="number">6.1.3</span> Créer des objets Utilisateur</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:finding_user_objects"><span class="number">6.1.4</span> Recherche dans les objets Utilisateurs (Users)</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:updating_user_objects"><span class="number">6.1.5</span> Actualisation des objets Utilisateurs (Users)</a></li></ol></li>
<li class="section"><a href="modeling-and-viewing-users-one#sec:user_validations"><span class="number">6.2</span> Validations utilisateur</a></li>
<li><ol>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:presence_validation"><span class="number">6.2.1</span> Valider l'existence</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:length_validation"><span class="number">6.2.2</span> Valider la longueur</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:format_validation"><span class="number">6.2.3</span> Valider le format</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:uniqueness_validation"><span class="number">6.2.4</span> Valider l'unicité</a></li>
<li><ol>
<li class="subsubsection"><a href="modeling-and-viewing-users-one#sec:the_caveat">L'avertissement d'unicité</a></li></ol></li></ol></li>
<li class="section"><a href="modeling-and-viewing-users-one#sec:viewing_users"><span class="number">6.3</span> Afficher les utilisateurs</a></li>
<li><ol>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:rails_environments"><span class="number">6.3.1</span> Débuggage et environnements Rails</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:users_show"><span class="number">6.3.2</span> Modèle, Vue et Contrôleur Utilisateur</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:a_users_resource"><span class="number">6.3.3</span> Ressource Utilisateurs</a></li>
<li><ol>
<li class="subsubsection"><a href="modeling-and-viewing-users-one#sec:params_in_debug">[(<code>params</code> in <code>debug</code>)]</a></li></ol></li></ol></li>
<li class="section"><a href="modeling-and-viewing-users-one#sec:6.4"><span class="number">6.4</span> Conclusion</a></li>
<li class="section"><a href="modeling-and-viewing-users-one#sec:6.5"><span class="number">6.5</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="modeling-and-viewing-users-two#top"><span class="number">Chapitre 7</span> Modéliser et afficher les utilisateurs, partie II</a></li>
<li><ol>
<li class="section"><a href="modeling-and-viewing-users-two#sec:insecure_passwords"><span class="number">7.1</span> Mots de passe non sûrs</a></li>
<li><ol>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:password_validations"><span class="number">7.1.1</span> Valider le mot de passe</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:password_migration"><span class="number">7.1.2</span> Migrer un mot de passe</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:an_active_record_callback"><span class="number">7.1.3</span> Un <em>callback</em> de l'Active Record</a></li></ol></li>
<li class="section"><a href="modeling-and-viewing-users-two#sec:secure_passwords"><span class="number">7.2</span> Sécuriser les mots de passe</a></li>
<li><ol>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:a_secure_password_test"><span class="number">7.2.1</span> Test de mot de passe sûr</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:secure_password_theory"><span class="number">7.2.2</span> Un peu de théorie sur la sécurisation des mots de passe</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:implementing_has_password"><span class="number">7.2.3</span> Implémenter la méthode <code>has_password?</code></a></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:an_authenticate_method"><span class="number">7.2.4</span> Méthode d'authentification</a></li></ol></li>
<li class="section"><a href="modeling-and-viewing-users-two#sec:better_user_views"><span class="number">7.3</span> Meilleures vues d'utilisateurs</a></li>
<li><ol>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:tests_with_factories"><span class="number">7.3.1</span> Tester la page de l'utilisateur (avec <em>factories</em>)</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:a_name_and_a_gravatar"><span class="number">7.3.2</span> Un nom et un Gravatar</a></li>
<li><ol>
<li class="subsubsection"><a href="modeling-and-viewing-users-two#sec:a_gravatar_helper">Un « helper » de Gravatar</a></li></ol></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:a_user_sidebar"><span class="number">7.3.3</span> Une barre utilisateur latérale</a></li></ol></li>
<li class="section"><a href="modeling-and-viewing-users-two#sec:7.4"><span class="number">7.4</span> Conclusion</a></li>
<li><ol>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:7.4.1"><span class="number">7.4.1</span> Dépôt Git</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:heroku_deploy"><span class="number">7.4.2</span> Déploiement Heroku</a></li></ol></li>
<li class="section"><a href="modeling-and-viewing-users-two#sec:more_modeling_users_Exercices"><span class="number">7.5</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="sign-up#top"><span class="number">Chapitre 8</span> Inscription</a></li>
<li><ol>
<li class="section"><a href="sign-up#sec:signup_form"><span class="number">8.1</span> Formulaire d'inscription</a></li>
<li><ol>
<li class="subsection"><a href="sign-up#sec:using_form_for"><span class="number">8.1.1</span> Utiliser  <code>form_for</code></a></li>
<li class="subsection"><a href="sign-up#sec:the_form_html"><span class="number">8.1.2</span> Le formulaire HTML</a></li></ol></li>
<li class="section"><a href="sign-up#sec:signup_failure"><span class="number">8.2</span> Échec de l'inscription</a></li>
<li><ol>
<li class="subsection"><a href="sign-up#sec:testing_failure"><span class="number">8.2.1</span> Test de l'échec</a></li>
<li class="subsection"><a href="sign-up#sec:a_working_form"><span class="number">8.2.2</span> Un formulaire fonctionnel</a></li>
<li class="subsection"><a href="sign-up#sec:signup_error_messages"><span class="number">8.2.3</span> Inscription&nbsp;: messages d'erreur</a></li>
<li class="subsection"><a href="sign-up#sec:filtering_parameter_logging"><span class="number">8.2.4</span> Filtrage des paramètres d'identification</a></li></ol></li>
<li class="section"><a href="sign-up#sec:signup_success"><span class="number">8.3</span> Succès de l'inscription</a></li>
<li><ol>
<li class="subsection"><a href="sign-up#sec:testing_success"><span class="number">8.3.1</span> Tester le succès de l'inscription</a></li>
<li class="subsection"><a href="sign-up#sec:the_finished_signup_form"><span class="number">8.3.2</span> Le formulaire d'inscription finalisé</a></li>
<li class="subsection"><a href="sign-up#sec:the_flash"><span class="number">8.3.3</span> Le message «&nbsp;flash&nbsp;»</a</a></li>
<li class="subsection"><a href="sign-up#sec:the_first_signup"><span class="number">8.3.4</span> La première inscription</a></li></ol></li>
<li class="section"><a href="sign-up#sec:rspec_integration_tests"><span class="number">8.4</span> Test d'intégration RSpec</a></li>
<li><ol>
<li class="subsection"><a href="sign-up#sec:integration_tests_with_style"><span class="number">8.4.1</span> Tests d'intégration avec les styles</a></li>
<li class="subsection"><a href="sign-up#sec:failed_signup"><span class="number">8.4.2</span> Un échec d'inscription ne devrait pas créer un nouvel utilisateur</a></li>
<li class="subsection"><a href="sign-up#sec:successful_signup"><span class="number">8.4.3</span> Le succès d'une inscription devrait créer un nouvel utilisateur</a></li></ol></li>
<li class="section"><a href="sign-up#sec:8.5"><span class="number">8.5</span> Conclusion</a></li>
<li class="section"><a href="sign-up#sec:signup_Exercices"><span class="number">8.6</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="sign-in-sign-out#top"><span class="number">Chapitre 9</span> Connexion, déconnexion</a></li>
<li><ol>
<li class="section"><a href="sign-in-sign-out#sec:sessions"><span class="number">9.1</span> Les sessions</a></li>
<li><ol>
<li class="subsection"><a href="sign-in-sign-out#sec:sessions_controller"><span class="number">9.1.1</span> Le contrôleur de session</a></li>
<li class="subsection"><a href="sign-in-sign-out#sec:signin_form"><span class="number">9.1.2</span> Formulaire d'identification</a></li></ol></li>
<li class="section"><a href="sign-in-sign-out#sec:signin_failure"><span class="number">9.2</span> Échec de l'identification</a></li>
<li><ol>
<li class="subsection"><a href="sign-in-sign-out#sec:reviewing_form_submission"><span class="number">9.2.1</span> Examen de la soumission du formulaire</a></li>
<li class="subsection"><a href="sign-in-sign-out#sec:failed_signin"><span class="number">9.2.2</span> Échec de l'identification (test et code)</a></li></ol></li>
<li class="section"><a href="sign-in-sign-out#sec:signin_success"><span class="number">9.3</span> Succès de l'identification</a></li>
<li><ol>
<li class="subsection"><a href="sign-in-sign-out#sec:the_completed_create_action"><span class="number">9.3.1</span> L'action <code>create</code> («&nbsp;créer&nbsp;») finalisée</a></li>
<li class="subsection"><a href="sign-in-sign-out#sec:remember_me"><span class="number">9.3.2</span> Se souvenir de moi</a></li>
<li class="subsection"><a href="sign-in-sign-out#sec:current_user"><span class="number">9.3.3</span> Utilisateur courant</a></li></ol></li>
<li class="section"><a href="sign-in-sign-out#sec:signing_out"><span class="number">9.4</span> Déconnexion</a></li>
<li><ol>
<li class="subsection"><a href="sign-in-sign-out#sec:destroying_sessions"><span class="number">9.4.1</span> Détruire la session</a></li>
<li class="subsection"><a href="sign-in-sign-out#sec:signin_upon_signup"><span class="number">9.4.2</span> Connection à l'inscription</a></li>
<li class="subsection"><a href="sign-in-sign-out#sec:changing_the_layout_links"><span class="number">9.4.3</span> Changement des liens de la mise en plage</a></li>
<li class="subsection"><a href="sign-in-sign-out#sec:signin_out_integration_tests"><span class="number">9.4.4</span> Test d'intégration de l'identification/déconnexion</a></li></ol></li>
<li class="section"><a href="sign-in-sign-out#sec:9.5"><span class="number">9.5</span> Conclusion</a></li>
<li class="section"><a href="sign-in-sign-out#sec:sign_in_out_Exercices"><span class="number">9.6</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="updating-showing-and-deleting-users#top"><span class="number">Chapitre 10</span> Actualiser, afficher et supprimer de l'utilisateur</a></li>
<li><ol>
<li class="section"><a href="updating-showing-and-deleting-users#sec:updating_users"><span class="number">10.1</span> Actualiser l'utilisateur</a></li>
<li><ol>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:edit_form"><span class="number">10.1.1</span> Formulaire de modification</a></li>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:enabling_edits"><span class="number">10.1.2</span> Permettre les modifications</a></li></ol></li>
<li class="section"><a href="updating-showing-and-deleting-users#sec:protecting_pages"><span class="number">10.2</span> Protéger les pages</a></li>
<li><ol>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:requiring_signed_in_users"><span class="number">10.2.1</span> Utilisateurs identifiés requis</a></li>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:requiring_the_right_user"><span class="number">10.2.2</span> Nécessité du bon utilisateur</a></li>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:friendly_forwarding"><span class="number">10.2.3</span> Redirection conviviale</a></li></ol></li>
<li class="section"><a href="updating-showing-and-deleting-users#sec:showing_users"><span class="number">10.3</span> Afficher les utilisateurs</a></li>
<li><ol>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:user_index"><span class="number">10.3.1</span> Liste des utilisateurs</a></li>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:sample_users"><span class="number">10.3.2</span> Exemples d'utilisateurs</a></li>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:pagination"><span class="number">10.3.3</span> Pagination</a></li>
<li><ol>
<li class="subsubsection"><a href="updating-showing-and-deleting-users#sec:testing_pagination">Test de la pagination</a></li></ol></li>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:partial_refactoring"><span class="number">10.3.4</span> Restructuration des partielles</a></li></ol></li>
<li class="section"><a href="updating-showing-and-deleting-users#sec:destroying_users"><span class="number">10.4</span> Supprimer des utilisateurs</a></li>
<li><ol>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:administrative_users"><span class="number">10.4.1</span> Utilisateurs administrateurs</a></li>
<li><ol>
<li class="subsubsection"><a href="updating-showing-and-deleting-users#sec:revisiting_attr_accessible">Révision de <code>attr_accessible</code></a></li></ol></li>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:the_destroy_action"><span class="number">10.4.2</span> L'action <code>destroy</code> («&nbsp;supprimer&nbsp;»)</a></li></ol></li>
<li class="section"><a href="updating-showing-and-deleting-users#sec:10.5"><span class="number">10.5</span> Conclusion</a></li>
<li class="section"><a href="updating-showing-and-deleting-users#sec:updating_deleting_Exercices"><span class="number">10.6</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="user-microposts#top"><span class="number">Chapitre 11</span> Micro-messages d'utilisateur</a></li>
<li><ol>
<li class="section"><a href="user-microposts#sec:a_micropost_model"><span class="number">11.1</span> Le modèle Micropost («&nbsp;Micro-message&nbsp;»)</a></li>
<li><ol>
<li class="subsection"><a href="user-microposts#sec:the_basic_model"><span class="number">11.1.1</span> Le modèle initial</a></li>
<li><ol>
<li class="subsubsection"><a href="user-microposts#sec:accessible_attribute">Attributs accessibles</a></li></ol></li>
<li class="subsection"><a href="user-microposts#sec:user_micropost_associations"><span class="number">11.1.2</span> Associations Utilisateur/micro-messages</a></li>
<li class="subsection"><a href="user-microposts#sec:ordering_and_dependency"><span class="number">11.1.3</span> Affinements du micro-message</a></li>
<li><ol>
<li class="subsubsection"><a href="user-microposts#sec:default_scope">Portée par défaut</a></li>
<li class="subsubsection"><a href="user-microposts#sec:dependent_destroy">Dependent: destroy (dépendances de la suppression)</a></li></ol></li>
<li class="subsection"><a href="user-microposts#sec:micropost_validations"><span class="number">11.1.4</span> Validations du micro-message</a></li></ol></li>
<li class="section"><a href="user-microposts#sec:showing_microposts"><span class="number">11.2</span> Afficher les micro-messages</a></li>
<li><ol>
<li class="subsection"><a href="user-microposts#sec:augmenting_the_user_show_page"><span class="number">11.2.1</span> Etoffement de la page de l'utilisateur</a></li>
<li class="subsection"><a href="user-microposts#sec:sample_microposts"><span class="number">11.2.2</span> Exemples de micro-messages</a></li></ol></li>
<li class="section"><a href="user-microposts#sec:manipulating_microposts"><span class="number">11.3</span> Manipuler les micro-messages</a></li>
<li><ol>
<li class="subsection"><a href="user-microposts#sec:access_control"><span class="number">11.3.1</span> Contrôle de l'accès</a></li>
<li class="subsection"><a href="user-microposts#sec:creating_microposts"><span class="number">11.3.2</span> Créer des micro-messages</a></li>
<li class="subsection"><a href="user-microposts#sec:a_proto_feed"><span class="number">11.3.3</span> Une proto-alimentation</a></li>
<li class="subsection"><a href="user-microposts#sec:destroying_microposts"><span class="number">11.3.4</span> Supprimer des micro-messages</a></li>
<li class="subsection"><a href="user-microposts#sec:testing_the_new_home_page"><span class="number">11.3.5</span> Test de la nouvelle page d'accueil</a></li></ol></li>
<li class="section"><a href="user-microposts#sec:11.4"><span class="number">11.4</span> Conclusion</a></li>
<li class="section"><a href="user-microposts#sec:micropost_Exercices"><span class="number">11.5</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="following-users#top"><span class="number">Chapitre 12</span> Suivi des utilisateurs</a></li>
<li><ol>
<li class="section"><a href="following-users#sec:the_relationship_model"><span class="number">12.1</span> Le modèle Relation (Relationship model)</a></li>
<li><ol>
<li class="subsection"><a href="following-users#sec:a_problem_with_the_data_model"><span class="number">12.1.1</span> Un problème du modèle de données (et sa solution)</a></li>
<li class="subsection"><a href="following-users#sec:relationship_user_associations"><span class="number">12.1.2</span> Associations Utilisateur/Relations</a></li>
<li class="subsection"><a href="following-users#sec:relationship_validations"><span class="number">12.1.3</span> Validations</a></li>
<li class="subsection"><a href="following-users#sec:following"><span class="number">12.1.4</span> Auteurs suivis</a></li>
<li class="subsection"><a href="following-users#sec:followers"><span class="number">12.1.5</span> Lecteurs</a></li></ol></li>
<li class="section"><a href="following-users#sec:a_web_interface_for_following_and_followers"><span class="number">12.2</span> Une interface web pour les auteurs suivis et les lecteurs</a></li>
<li><ol>
<li class="subsection"><a href="following-users#sec:sample_following_data"><span class="number">12.2.1</span> Exemple de donnée de suivi</a></li>
<li class="subsection"><a href="following-users#sec:stats_and_a_follow_form"><span class="number">12.2.2</span> Statistiques et formulaire de suivi</a></li>
<li class="subsection"><a href="following-users#sec:following_and_followers_pages"><span class="number">12.2.3</span> Pages d'auteurs suivis et de lecteurs</a></li>
<li class="subsection"><a href="following-users#sec:a_working_follow_button_the_standard_way"><span class="number">12.2.4</span> Un bouton de suivi fonctionnant de façon standard</a></li>
<li class="subsection"><a href="following-users#sec:a_working_follow_button_with_ajax"><span class="number">12.2.5</span> Un bouton fonctionnant avec Ajax</a></li></ol></li>
<li class="section"><a href="following-users#sec:the_status_feed"><span class="number">12.3</span> L'état de l'alimention</a></li>
<li><ol>
<li class="subsection"><a href="following-users#sec:motivation_and_strategy"><span class="number">12.3.1</span> Motivation et stratégie</a></li>
<li class="subsection"><a href="following-users#sec:a_first_feed_implementation"><span class="number">12.3.2</span> Une première implémentation de peuplement</a></li>
<li class="subsection"><a href="following-users#sec:scopes_subselects_and_a_lambda"><span class="number">12.3.3</span> Portées, sous-requêtes et fonction <em>lambda</em></a></li>
<li class="subsection"><a href="following-users#sec:the_new_status_feed"><span class="number">12.3.4</span> Nouvel état de l'alimentation</a></li></ol></li>
<li class="section"><a href="following-users#sec:following_conclusion"><span class="number">12.4</span> Conclusion</a></li>
<li><ol>
<li class="subsection"><a href="following-users#sec:extensions_to_the_sample_application"><span class="number">12.4.1</span> Extensions de l'application exemple</a></li>
<li><ol>
<li class="subsubsection"><a href="following-users#sec:replies">Réponses</a></li>
<li class="subsubsection"><a href="following-users#sec:messaging">Notification</a></li>
<li class="subsubsection"><a href="following-users#sec:follower_notifications">Notifications aux lecteurs</a></li>
<li class="subsubsection"><a href="following-users#sec:password_reminders">Rappel du mot de passe</a></li>
<li class="subsubsection"><a href="following-users#sec:signup_confirmation">Confirmation d'inscription</a></li>
<li class="subsubsection"><a href="following-users#sec:rss_feed">Alimentation RSS</a></li>
<li class="subsubsection"><a href="following-users#sec:rest_api">REST API</a></li>
<li class="subsubsection"><a href="following-users#sec:search">Recherche</a></li></ol></li>
<li class="subsection"><a href="following-users#sec:guide_to_further_resources"><span class="number">12.4.2</span> Guide vers d'autres ressources</a></li></ol></li>
<li class="section"><a href="following-users#sec:following_Exercices"><span class="number">12.5</span> Exercices</a></li></ol></li></ol></div>


<div id="main_content"></div>

<p> <span class="preamble">
 <span id="foreword">
<strong> Avant-propos</strong> <br />
 </span>
 </span></p>

<p>Ma précédente compagnie (CD Baby) fut une des premières à basculer intégralement vers Ruby on Rails, et à rebasculer aussi intégralement vers PHP (googlez-moi si vous voulez prendre la mesure du drame). On m'a tellement recommandé ce livre Michael Hartl que je n'ai pu faire autrement que de le lire. C'est ainsi que le <em>Tutoriel Ruby on Rails</em> m'a fait revenir à nouveau à Rails.</p>
<p>Bien qu'ayant parcouru de nombreux livres sur Rails, c'est ce tutoriel-là qui m'a véritablement «&nbsp;mis en possession&nbsp;» de Rails. Tout est fait ici «&nbsp;à la manière de Rails&nbsp;» —&nbsp;une manière qui ne m'avait jamais semblé naturelle avant que je ne lise ce livre. C'est aussi le seul ouvrage sur Rails qui met en place, d'un bout à l'autre, un <em>Développement Dirigé par les Tests</em> (<em>Test-Driven Development</em>), une approche que je savais hautement recommandée par les experts mais dont je n'avais jamais compris aussi bien la pertinence que dans ce livre. Enfin, en incluant Git, GitHub et Heroku dans les exemples de la démonstration, l'auteur vous donne vraiment le goût de ce qu'est le développement d'un projet dans la vie réelle. Et le exemples de code ne sont pas en reste.</p> 
	
<p>La narration linéaire adoptée par ce tutoriel est vraiment un bon format. Personnellement, j'ai étudié <em>Le Tutoriel Rails</em> en trois longues journées, en faisant tous les exemples et les exercices proposés à la fin de chaque chapitre. C'est en lisant ce livre du début à la fin, sans sauter la moindre partie, qu'on en tire tout le bénéfice.</p>

<p>Régalez-vous&nbsp;!</p>

<p><a href="http://sivers.org/">Derek Sivers</a> (<a href="http://sivers.org/">sivers.org</a>) <br />
<em>Précédemment&nbsp;: Fondateur de </em> <a href="http://www.cdbaby.com/"><em>CD Baby</em></a> <br />
<em>Actuellement&nbsp;: Fondateur de </em> <a href="http://thoughts.pro/"><em>Thoughts Ltd.</em></a> <br /></p>

<p> <span class="preamble">
<strong> Remerciements</strong> <br />
 </span></p>

<p>Ce <em>Tutoriel Ruby on Rails</em> doit beaucoup à mon livre précédent sur Rails, <em>RailsSpace</em>, et donc à mon co-auteur <a href="http://aure.com/">Aurelius Prochazka</a>. J'aimerais remercier Aure à la fois pour le travail qu'il a accompli sur ce précédent livre et pour son soutien pour le présent ouvrage. J'aimerais aussi remercier Debra Williams Cauley, mon éditeur pour les deux ouvrages&nbsp;; aussi longtemps qu'elle jouera avec moi au baseball, je continuerai d'écrire des livres pour elle.</p>

<p>J'aimerais remercier une longue liste de Rubyistes qui m'ont parlé et inspiré au cours des années&nbsp;: David Heinemeier Hansson, Yehuda Katz, Carl Lerche, Jeremy Kemper, Xavier Noria, Ryan Bates, Geoffrey Grosenbach, Peter Cooper, Matt Aimonetti, Gregg Pollack, Wayne&nbsp;E. Seguin, Amy Hoy, Dave Chelimsky, Pat Maddox, Tom Preston-Werner, Chris Wanstrath, Chad Fowler, Josh Susser, Obie Fernandez, Ian McFarland, Steven Bristol, Giles Bowkett, Evan Dorn, Long Nguyen, James Lindenbaum, Adam Wiggins, Tikhon Bernstam, Ron Evans, Wyatt Greene, Miles Forrest, les gens bien de Pivotal Labs, le gang Heroku, les mecs de thoughtbot et l'équipe de GitHub. Enfin, tellement, tellement, tellement de lecteurs —&nbsp;beaucoup trop pour les citer tous&nbsp;— qui ont contribué par leur rapport de bogues et leurs suggestions durant l'écriture de ce livre, et je tiens à saluer leur aide sans laquelle ce livre ne serait pas ce qu'il est. <br /></p>

<p> <span class="preamble">
 <span id="author">
<strong> À propos de l'auteur</strong> <br />
 </span>
 </span></p>

<p><a href="http://michaelhartl.com/">Michael Hartl</a> est programmeur, éducateur et entrepreneur. Il est le co-auteur de <em>RailsSpace</em>, un tutoriel Rails publié en 2007, et a été co-fondateur et développeur en chef de <a href="http://insoshi.com/">Insoshi</a>, une plateforme de réseau social <a href="http://github.com/popular/forked">populaire</a> en Ruby on Rails. Précédement, il a enseigné la théorie et la physique informatique au <a href="http://www.caltech.edu/">California Institute of Technology</a> (Caltech), où il a reçu le Lifetime Achievement Award for Excellence en enseignement. Michael est diplômé du <a href="http://college.harvard.edu/">Harvard College</a>, a un <a href="http://resolver.caltech.edu/CaltechETD:etd-05222003-161626">Ph.D. en physique</a> (un doctorat. NdT) de <a href="http://www.caltech.edu/">Caltech</a>, et il est ancien élève du programme des entrepreneurs <a href="http://ycombinator.com/">Y&nbsp;Combinator</a>. <br /></p>

<p> <span id="license" class="preamble">
<strong> Copyright et license</strong> <br />
 </span></p>

<p><em>Le Tutoriel Ruby on Rails&nbsp;: apprendre Rails par l'exemple</em>. Copyright &copy; 2010 par Michael Hartl. Tout le code source du <em>Tutoriel Ruby on Rails</em> est disponible sous la license <a href="http://www.opensource.org/licenses/mit-license.php">MIT License</a> et la licence <a href="http://en.wikipedia.org/wiki/Beerware">Beerware License</a>.</p>

<pre class="verbatim">   Copyright (c) 2010 Michael Hartl

   Permission est accordée, à titre gratuit, à toute personne obtenant
   une copie de ce logiciel et la documentation associée, pour faire des 
   modification dans le logiciel sans restriction et sans limitation des
   droits d’utiliser, copier, modifier, fusionner, publier, distribuer,
   concéder sous licence, et / ou de vendre les copies du Logiciel, et à
   autoriser les personnes auxquelles le Logiciel est meublé de le faire, 
   sous réserve des conditions suivantes:

   L’avis de copyright ci-dessus et cette autorisation doit être inclus
   dans toutes les copies ou parties substantielles du Logiciel.

   LE LOGICIEL EST FOURNI «TEL QUEL», SANS GARANTIE D’AUCUNE SORTE, 
   EXPLICITE OU IMPLICITE, Y COMPRIS, MAIS SANS S’Y LIMITER, LES 
   GARANTIES DE QUALITÉ MARCHANDE, ADAPTATION À UN USAGE PARTICULIER ET
   D’ABSENCE DE CONTREFAÇON. EN AUCUN CAS LES AUTEURS OU TITULAIRES DU
   ETRE TENU RESPONSABLE DE TOUT DOMMAGE, RÉCLAMATION OU AUTRES
   RESPONSABILITÉ, SOIT DANS UNE ACTION DE CONTRAT, UN TORT OU AUTRE,
   PROVENANT DE, DE OU EN RELATION AVEC LE LOGICIEL OU L’UTILISATION OU
   DE TRANSACTIONS AUTRES LE LOGICIEL.
	
</pre>




<pre class="verbatim">/*
 * ------------------------------------------------------------
 * &quot;LA LICENCE BEERWARE&quot; (Révision 42)&nbsp;:
 * Michael Hartl a écrit ce code. Aussi longtemps que vous
 * conservez cette note, vous pouvez faire ce que vous voulez
 * de ce travail. Si nous nous rencontrons un jour, et que vous
 * pensez que ce travail en vaut la peine, vous pourrez me
 * payer une bière en retour.
 * ------------------------------------------------------------
 */</pre>




<div id="top"></div>

<h1 class="chapter"><a id="sec:11" href="http://ruby.railstutorial.org/chapters/user-microposts#top" class="heading"><span class="number">Chapitre 11</span> Micro-messages d'utilisateur</a></h1>


<p>Le <a class="ref" href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#top">Chapitre&nbsp;10</a> a vu l'implémentation complète des actions REST de la ressource Utilisateurs, donc le temps est finalement arrivé d'ajouter une seconde ressource&nbsp;: les <em>micro-messages</em> d'utilisateurs.<sup class="footnote" id="fnref:11.1"><a href="#fn:11.1">1</a></sup> Ce sont de courts messages associés à un utilisateur particulier, vu pour la première fois dans leur forme larvaire au <a class="ref" href="http://ruby.railstutorial.org/chapters/a-demo-app#top">Chapitre&nbsp;2</a>. Dans le présent chapitre, nous allons construire une version intégrale de l'esquisse de la <a class="ref" href="http://ruby.railstutorial.org/chapters/a-demo-app#sec:microposts_resource">Section&nbsp;2.3</a> en construire le modèle de données `Micropost` (pour “Micro-messages”), en l'assoicant au modèle `User` à l'aide des méthodes  <code>has_many</code> et <code>belongs_to</code>, et en faisant les formulaires et les partiels nécessaires pour les manipuler et les afficher. Dans le <a class="ref" href="http://ruby.railstutorial.org/chapters/following-users#top">Chapite&nbsp;12</a>, nous achèverons notre mini clone de Twitter en ajoutant la notion de  <em>suivi</em> (“following”) des utilisateurs pour recevoir la <em>nourriture</em> de leurs micro-messages.</p>

<p>Si vous utilisez le contrôle de version git, je vous suggère de créer une nouvelle branche sujet comme d'habitude&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout -b user-microposts
</pre></div>
</div>




<div class="label" id="sec:a_micropost_model"></div>


<h2><a id="sec:11.1" href="http://ruby.railstutorial.org/chapters/user-microposts#sec:a_micropost_model" class="heading"><span class="number">11.1</span> Un modèle `Micropost`</a></h2>


<p>Nous commençons la ressource Microposts en créant un modèle `Micropost`, qui comprend l'essentiel des caractéristiques des micro-messages. Le code qui suit se construit sur le travail de la <a class="ref" href="http://ruby.railstutorial.org/chapters/a-demo-app#sec:microposts_resource">Section&nbsp;2.3</a>&nbsp;; comme avec le modèle de cette section, notre nouveau modèle Micropost incluera des validations de données et une association avec le modèle `User`. Contrairement à ce modèle, le modèle Micropost sera complètement testé, aura aussi un <em>classement par défaut</em> ainsi qu'un mécanisme de <em>destruction automatique</em> si l'utilisateur auteur des messages est supprimé.</p>

<div class="label" id="sec:the_basic_model"></div>


<h3><a id="sec:11.1.1" href="http://ruby.railstutorial.org/chapters/user-microposts#sec:the_basic_model" class="heading"><span class="number">11.1.1</span> Le modèle de base</a></h3>


<p>Le modèle Micropost n'a besoin que de deux attributs&nbsp;: un attribut <code>content</code> (“contenu”) pour conserver le contenu du micro-message,<sup class="footnote" id="fnref:11.2"><a href="#fn:11.2">2</a></sup> et un attribut <code>user_id</code> (“identifiant utilisateur”) pour associer le micro-message à l'utilisateur qui l'a écrit. Comme pour le modèle `User`, (<a class="ref" href="http://ruby.railstutorial.org/chapters/modeling-and-viewing-users-one#code:generate_user_model">Extrait&nbsp;6.1</a>), nous générons ce nouveau modèle en utilisant <code>generate model</code>&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate model Micropost content:string user_id:integer
</pre></div>
</div>


<p>Ce code produit une nouvelle migration qui crée une table  <code>microposts</code> dans la base de données (<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:micropost_migration">Extrait&nbsp;11.1</a>)&nbsp;; vous pouvez la comparer à la migration analogue qui a permis de créer la table <code>users</code> dans l'<a class="ref" href="http://ruby.railstutorial.org/chapters/modeling-and-viewing-users-one#code:users_migration">extrait&nbsp;6.2</a>.</p>

<div class="label" id="code:micropost_migration"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 11.1.</span> <span class="description">La migration Micropost (notez l'indexation sur l'attribut <code>user_id</code>.) <br> <code>db/migrate/&lt;timestamp&gt;_create_microposts.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" id="clippy_ad02a7c72dece1adc8cf7fb034a394e959d958e0" height="14" width="110">
      <param name="movie" value="/flash/clippy.swf">
      <param name="allowScriptAccess" value="always">
      <param name="quality" value="high">
      <param name="scale" value="noscale">
      <param name="FlashVars" value="text=class%20CreateMicroposts%20%3C%20ActiveRecord::Migration%0A%20%20def%20self.up%0A%20%20%20%20create_table%20:microposts%20do%20%7Ct%7C%0A%20%20%20%20%20%20t.string%20:content%0A%20%20%20%20%20%20t.integer%20:user_id%0A%0A%20%20%20%20%20%20t.timestamps%0A%20%20%20%20end%0A%20%20%20%20add_index%20:microposts,%20:user_id%0A%20%20end%0A%0A%20%20def%20self.down%0A%20%20%20%20drop_table%20:microposts%0A%20%20end%0Aend%0A">
      <param name="bgcolor" value="#ffffff">
      <embed src="Chapter-11_fichiers/clippy.swf" name="clippy" quality="high" allowscriptaccess="always" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="text=class%20CreateMicroposts%20%3C%20ActiveRecord::Migration%0A%20%20def%20self.up%0A%20%20%20%20create_table%20:microposts%20do%20%7Ct%7C%0A%20%20%20%20%20%20t.string%20:content%0A%20%20%20%20%20%20t.integer%20:user_id%0A%0A%20%20%20%20%20%20t.timestamps%0A%20%20%20%20end%0A%20%20%20%20add_index%20:microposts,%20:user_id%0A%20%20end%0A%0A%20%20def%20self.down%0A%20%20%20%20drop_table%20:microposts%0A%20%20end%0Aend%0A" bgcolor="#ffffff" height="14" width="110">
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">CreateMicroposts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">up</span>
    <span class="n">create_table</span> <span class="ss">:microposts</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="o">.</span><span class="n">string</span> <span class="ss">:content</span>
      <span class="n">t</span><span class="o">.</span><span class="n">integer</span> <span class="ss">:user_id</span>

      <span class="n">t</span><span class="o">.</span><span class="n">timestamps</span>
    <span class="k">end</span>
    <span class="n">add_index</span> <span class="ss">:microposts</span><span class="p">,</span> <span class="ss">:user_id</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">down</span>
    <span class="n">drop_table</span> <span class="ss">:microposts</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Notez que, puisque nous envisageons de récupérer tous les micro-messages associés à un identifiant d'utilisateur donné, l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:micropost_migration">extrait&nbsp;11.1</a> ajoute un index (<a class="ref" href="http://ruby.railstutorial.org/chapters/modeling-and-viewing-users-one#sidebar:database_indices">Box&nbsp;6.2</a>) sur la colonne <code>user_id</code>&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="n">add_index</span> <span class="ss">:microposts</span><span class="p">,</span> <span class="ss">:user_id</span>
</pre></div>
</div>


<p>Notez aussi la ligne <code>t.timestamps</code> qui, comme mentionné dans la <a class="ref" href="http://ruby.railstutorial.org/chapters/modeling-and-viewing-users-one#sec:database_migrations">Section&nbsp;6.1.1</a>) ajoute les colonnes magiques  <code>created_at</code> (“créé à…”) et <code>updated_at</code> (“modifié à…”). Nous travaillerons avec la colonne <code>created_at</code> dans les sections <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#sec:ordering_and_dependency">Section&nbsp;11.1.3</a> et <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#sec:augmenting_the_user_show_page">Section&nbsp;11.2.1</a>.</p>

<p>On peut jouer la migration microposts comme d'habitude (en prenant soin de préparer la base de données de test puisque le modèle de données a changé)&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rake db:migrate
<span class="gp">$</span> rake db:test:prepare
</pre></div>
</div>


<p>Le résultat est un modèle Micropost dont la structure est présentée dans l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#fig:micropost_model">illustration&nbsp;11.1</a>.</p>

<div class="label" id="fig:micropost_model"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="Chapter-11_fichiers/micropost_model.png" alt="micropost_model"></span></div><div class="caption"><span class="header">Illustration 11.1: </span><span class="description">Le modèle de données Micropost.</span></div></div>




<div class="label" id="sec:accessible_attribute"></div>


<h4><a id="sec:11.1.1.1" href="http://ruby.railstutorial.org/chapters/user-microposts#sec:accessible_attribute" class="heading">Attributs accessibles</a></h4>


<p>Avant d'étoffer le modèle Micropost, il est tout d'abord important d'utiliser <code>attr_accessible</code> pour indiquer les attributs modifiable publiquement. Comme abordé dans la <a class="ref" href="http://ruby.railstutorial.org/chapters/modeling-and-viewing-users-one#sec:accessible_attributes">Section&nbsp;6.1.2.2</a> et la <a class="ref" href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#sec:revisiting_attr_accessible">Section&nbsp;10.4.1.1</a>, oublier de définir les attributs accessibles signifie que n'importe qui pourrait changer les attributs de n'importe quel micro-message simplement en utilisant un client en ligne de commande pour produire des requêtes malveillantes. Par exemple, un utilisateur mal intentionné pourrait modifier l'attribut <code>user_id</code> pour associer un micro-message à un mauvais utilisateur.</p>

<p>Dans le cas du modèle Micropost, il y a seulement <em>un</em> attribut qui a besoin d'être édité par le web, l'attribut <code>content</code> (<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:micropost_accessible_attribute">Extrait&nbsp;11.2</a>).</p>

<div class="label" id="code:micropost_accessible_attribute"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 11.2.</span> <span class="description">Rendre l'attribut <code>content</code> (et <em>seulement</em> l'attribut <code>content</code>) accessible. <br> <code>app/models/micropost.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" id="clippy_491345c1c37941a4f209246636897a6794613b3e" height="14" width="110">
      <param name="movie" value="/flash/clippy.swf">
      <param name="allowScriptAccess" value="always">
      <param name="quality" value="high">
      <param name="scale" value="noscale">
      <param name="FlashVars" value="text=class%20Micropost%20%3C%20ActiveRecord::Base%0A%20%20attr_accessible%20:content%0Aend%0A">
      <param name="bgcolor" value="#ffffff">
      <embed src="Chapter-11_fichiers/clippy.swf" name="clippy" quality="high" allowscriptaccess="always" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="text=class%20Micropost%20%3C%20ActiveRecord::Base%0A%20%20attr_accessible%20:content%0Aend%0A" bgcolor="#ffffff" height="14" width="110">
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:content</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Puisque <code>user_id</code> <em>n'est pas</em> listé dans le paramètre <code>attr_accessible</code>, il ne peut pas être modifié par le web, parce qu'un paramètre <code>user_id</code> dans une assignation publique telle que&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="no">Micropost</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:content</span> <span class="o">=&gt;</span> <span class="s2">"foo bar"</span><span class="p">,</span> <span class="ss">:user_id</span> <span class="o">=&gt;</span> <span class="mi">17</span><span class="p">)</span>
</pre></div>
</div>


<p>… sera tout simplement ignorée.</p>

<p>La déclaration de <code>attr_accessible</code> dans l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:micropost_accessible_attribute">extrait&nbsp;11.2</a> est nécessaire pour la sécurité du site, mais introduit un problème dans le modèle spec (modèle de test) par défaut (<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:initial_micropost_spec">Extrait&nbsp;11.3</a>).</p>

<div class="label" id="code:initial_micropost_spec"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 11.3.</span> <span class="description">Le module de test spec Micropost initial. <br> <code>spec/models/micropost_spec.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" id="clippy_0b1aadc7a73a4f7df3b3aef65a665f988efd7c54" height="14" width="110">
      <param name="movie" value="/flash/clippy.swf">
      <param name="allowScriptAccess" value="always">
      <param name="quality" value="high">
      <param name="scale" value="noscale">
      <param name="FlashVars" value="text=require%20'spec_helper'%0A%0Adescribe%20Micropost%20do%0A%0A%20%20before(:each)%20do%0A%20%20%20%20@attr%20=%20%7B%0A%20%20%20%20%20%20:content%20=%3E%20%22value%20for%20content%22,%0A%20%20%20%20%20%20:user_id%20=%3E%201%0A%20%20%20%20%7D%0A%20%20end%0A%0A%20%20it%20%22should%20create%20a%20new%20instance%20given%20valid%20attributes%22%20do%0A%20%20%20%20Micropost.create!(@attr)%0A%20%20end%0Aend%0A">
      <param name="bgcolor" value="#ffffff">
      <embed src="Chapter-11_fichiers/clippy.swf" name="clippy" quality="high" allowscriptaccess="always" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="text=require%20'spec_helper'%0A%0Adescribe%20Micropost%20do%0A%0A%20%20before(:each)%20do%0A%20%20%20%20@attr%20=%20%7B%0A%20%20%20%20%20%20:content%20=%3E%20%22value%20for%20content%22,%0A%20%20%20%20%20%20:user_id%20=%3E%201%0A%20%20%20%20%7D%0A%20%20end%0A%0A%20%20it%20%22should%20create%20a%20new%20instance%20given%20valid%20attributes%22%20do%0A%20%20%20%20Micropost.create!(@attr)%0A%20%20end%0Aend%0A" bgcolor="#ffffff" height="14" width="110">
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">Micropost</span> <span class="k">do</span>

  <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
    <span class="vi">@attr</span> <span class="o">=</span> <span class="p">{</span>
      <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="s2">"value for content"</span><span class="p">,</span>
      <span class="ss">:user_id</span> <span class="o">=&gt;</span> <span class="mi">1</span>
    <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s2">"devrait créer une nouvelle instance avec les attributs valides"</span> <span class="k">do</span>
    <span class="no">Micropost</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="vi">@attr</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Le test réussi, mais il recèle un aspect suspect (essayez de vous l'imaginer avant de passer à la suite)</p>

<p>Le problème est que le bloc <code>before(:each)</code> dans l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:initial_micropost_spec">extrait&nbsp;11.3</a> assigne l'identifiant de l'utilisateur par assignation publique, ce qui est très exactement ce que le paramètre <code>attr_accessible</code> est censé empêcher&nbsp;; en particulier, comme noté ci-dessous, la partie <code>:user_id =&gt; 1</code> de l'initialisation de la table est simplement ignorée. La solution est d'éviter, pour créer un micro-message, d'utiliser <code>Micropost.new</code> directement&nbsp;; nous allons plutôt créer le nouveau micro-message à travers son <em>association</em> avec le modèle User, qui définit automatiquement l'identifiant de l'utilisateur (user id). Accomplir cela sera l'objet de la section suivante.</p>

<div class="label" id="sec:user_micropost_associations"></div>


<h3><a id="sec:11.1.2" href="http://ruby.railstutorial.org/chapters/user-microposts#sec:user_micropost_associations" class="heading"><span class="number">11.1.2</span> Association Utilisateur/Micro-message (User/Micropost)</a></h3>


<p>Le but de cette section est d'établir une <em>association</em> entre le modèle Micropost et le modèle User —une relation entraperçue dans la <a class="ref" href="http://ruby.railstutorial.org/chapters/a-demo-app#sec:demo_user_has_many_microposts">Section&nbsp;2.3.3</a> et vue schématiquement dans l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#fig:micropost_belongs_to_user">illustration&nbsp;11.2</a> et l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#fig:user_has_many_microposts">illustration&nbsp;11.3</a>. Chemin faisant, nous écrirons des tests pour le modèle Micropost qui, contrairement à l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:initial_micropost_spec">extrait&nbsp;11.3</a>, sont compatible avec l'utilisation du paramètre <code>attr_accessible</code> de l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:micropost_accessible_attribute">extrait&nbsp;11.2</a>.</p>

<div class="label" id="fig:micropost_belongs_to_user"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="Chapter-11_fichiers/micropost_belongs_to_user.png" alt="micropost_belongs_to_user"></span></div><div class="caption"><span class="header">Figure 11.2: </span><span class="description">La relation  <code>belongs_to</code> entre le micro-message et son auteur.&nbsp;<a href="http://railstutorial.org/images/figures/micropost_belongs_to_user-full.png">(taille normale)</a></span></div></div>




<div class="label" id="fig:user_has_many_microposts"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="Chapter-11_fichiers/user_has_many_microposts.png" alt="user_has_many_microposts"></span></div><div class="caption"><span class="header">Illustration 11.3: </span><span class="description">La relation <code>has_many</code> entre l'utilisateur et ses micro-messages.&nbsp;<a href="http://railstutorial.org/images/figures/user_has_many_microposts-full.png">(taille normale)</a></span></div></div>


<p>Commençons les tests pour l'association du modèle Micropost. D'abord, nous voulons repliquer le test <code>Micropost.create!</code> vu dans l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:initial_micropost_spec">extrait&nbsp;11.3</a> sans l'assignement public invalide. Ensuite, nous tirons de l''<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#fig:micropost_belongs_to_user">illustration&nbsp;11.2</a> qu'un objet <code>micropost</code> devrait posséder une méthode <code>user</code>. Enfin, <code>micropost.user</code> devrait être l'utilisateur correspondant à l'attribut <code>user_id</code> du micro-message. Nous pouvons exprimer ces exigences en RSpec avec le code de l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:micropost_belongs_to_user_spec">extrait&nbsp;11.4</a>.</p>

<div class="label" id="code:micropost_belongs_to_user_spec"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 11.4.</span> <span class="description">Test de l'association entre micro-message et utilisateur. <br> <code>spec/models/micropost_spec.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" id="clippy_a416c83044d6b12527972f9b5e7b1c5164c25ca7" height="14" width="110">
      <param name="movie" value="/flash/clippy.swf">
      <param name="allowScriptAccess" value="always">
      <param name="quality" value="high">
      <param name="scale" value="noscale">
      <param name="FlashVars" value="text=require%20'spec_helper'%0A%0Adescribe%20Micropost%20do%0A%0A%20%20before(:each)%20do%0A%20%20%20%20@user%20=%20Factory(:user)%0A%20%20%20%20@attr%20=%20%7B%20:content%20=%3E%20%22value%20for%20content%22%20%7D%0A%20%20end%0A%0A%20%20it%20%22should%20create%20a%20new%20instance%20given%20valid%20attributes%22%20do%0A%20%20%20%20@user.microposts.create!(@attr)%0A%20%20end%0A%0A%20%20describe%20%22user%20associations%22%20do%0A%20%20%20%20%0A%20%20%20%20before(:each)%20do%0A%20%20%20%20%20%20@micropost%20=%20@user.microposts.create(@attr)%0A%20%20%20%20end%0A%0A%20%20%20%20it%20%22should%20have%20a%20user%20attribute%22%20do%0A%20%20%20%20%20%20@micropost.should%20respond_to(:user)%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20it%20%22should%20have%20the%20right%20associated%20user%22%20do%0A%20%20%20%20%20%20@micropost.user_id.should%20==%20@user.id%0A%20%20%20%20%20%20@micropost.user.should%20==%20@user%0A%20%20%20%20end%0A%20%20end%0Aend%0A">
      <param name="bgcolor" value="#ffffff">
      <embed src="Chapter-11_fichiers/clippy.swf" name="clippy" quality="high" allowscriptaccess="always" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="text=require%20'spec_helper'%0A%0Adescribe%20Micropost%20do%0A%0A%20%20before(:each)%20do%0A%20%20%20%20@user%20=%20Factory(:user)%0A%20%20%20%20@attr%20=%20%7B%20:content%20=%3E%20%22value%20for%20content%22%20%7D%0A%20%20end%0A%0A%20%20it%20%22should%20create%20a%20new%20instance%20given%20valid%20attributes%22%20do%0A%20%20%20%20@user.microposts.create!(@attr)%0A%20%20end%0A%0A%20%20describe%20%22user%20associations%22%20do%0A%20%20%20%20%0A%20%20%20%20before(:each)%20do%0A%20%20%20%20%20%20@micropost%20=%20@user.microposts.create(@attr)%0A%20%20%20%20end%0A%0A%20%20%20%20it%20%22should%20have%20a%20user%20attribute%22%20do%0A%20%20%20%20%20%20@micropost.should%20respond_to(:user)%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20it%20%22should%20have%20the%20right%20associated%20user%22%20do%0A%20%20%20%20%20%20@micropost.user_id.should%20==%20@user.id%0A%20%20%20%20%20%20@micropost.user.should%20==%20@user%0A%20%20%20%20end%0A%20%20end%0Aend%0A" bgcolor="#ffffff" height="14" width="110">
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">Micropost</span> <span class="k">do</span>

  <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
    <span class="vi">@attr</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="s2">"value for content"</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s2">"devrait créer une nouvelle instance de micro-message avec les bons attributs"</span> <span class="k">do</span>
    <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="vi">@attr</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">"associations avec l'utilisateur"</span> <span class="k">do</span>

    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="vi">@micropost</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="vi">@attr</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">"devrait avoir un attribut user"</span> <span class="k">do</span>
      <span class="vi">@micropost</span><span class="o">.</span><span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">"devrait avoir le bon utilisateur associé"</span> <span class="k">do</span>
      <span class="vi">@micropost</span><span class="o">.</span><span class="n">user_id</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="vi">@user</span><span class="o">.</span><span class="n">id</span>
      <span class="vi">@micropost</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="vi">@user</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Notez que, plutôt que d'utiliser <code>Micropost.create</code> ou <code>Micropost.create!</code> pour créer un micro-message, l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:micropost_belongs_to_user_spec">extrait&nbsp;11.4</a> utilise…</p>

<div class="code"><div class="highlight"><pre><span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="vi">@attr</span><span class="p">)</span>
</pre></div>
</div>


<p>…et …</p>

<div class="code"><div class="highlight"><pre><span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="vi">@attr</span><span class="p">)</span>
</pre></div>
</div>


<p>Cette tournure est la façon <a href="http://www.answers.com/canonical">canonique</a> de créer un micro-message par associotion avec l'utilisateur (nous utilisons un utilisateur fictif parce que ces tests s'adressent au modèle Micropost, pas au modèle User [[je ne comprends pas vraiment]]) Créé de cette manière, l'objet micropost a <em>automatiquement</em> son attribut <code>user_id</code> défini avec la bonne valeur, ce qui règle le problème relevé dans la <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#sec:accessible_attribute">Section&nbsp;11.1.1.1</a>. En particulier, le code…</p>

<div class="code"><div class="highlight"><pre>  <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
    <span class="vi">@attr</span> <span class="o">=</span> <span class="p">{</span>
      <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="s2">"value for content"</span><span class="p">,</span>
      <span class="ss">:user_id</span> <span class="o">=&gt;</span> <span class="mi">1</span>
    <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s2">"devrait créer une nouvelle instance avec les attributs valides"</span> <span class="k">do</span>
    <span class="no">Micropost</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="vi">@attr</span><span class="p">)</span>
  <span class="k">end</span>
</pre></div>
</div>


<p>… de l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:initial_micropost_spec">extrait&nbsp;11.3</a> est défectueux car <code>:user_id =&gt; 1</code> ne fait rien quand <code>user_id</code> ne fait pas partie des attributs accessibles du modèle Micropost. En passant par l'association avec l'utilisateur, en revanche, le code…</p>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="s2">"devrait créer une nouvelle instance avec les attributs valides"</span> <span class="k">do</span>
  <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="vi">@attr</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>


<p>… de l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:micropost_belongs_to_user_spec">extrait&nbsp;11.4</a> a le bon <code>user_id</code> par construction.</p>


<p>Ces méthodes <code>create</code> spéciales ne fonctionnent pas encore&nbsp;; elles requièrent l'association <code>has_many</code> adéquate dans le modèle `User`. Nous différons les tests plus détaillés de cette association à la <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#sec:ordering_and_dependency">section&nbsp;11.1.3</a>&nbsp;; pour le moment, nous allons simplement tester la présence de l'attribut <code>microposts</code> (<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:user_has_many_microposts_spec">Extrait&nbsp;11.5</a>).</p>

<div class="label" id="code:user_has_many_microposts_spec"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.5.</span> <span class="description">Test de l'existence de l'attribut <code>microposts</code> pour l'utilisateur. <br> <code>spec/models/user_spec.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" id="clippy_3c6f3ba4d26bc6136c12fd74701f25e086ae0e9d" height="14" width="110">
      <param name="movie" value="/flash/clippy.swf">
      <param name="allowScriptAccess" value="always">
      <param name="quality" value="high">
      <param name="scale" value="noscale">
      <param name="FlashVars" value="text=require%20'spec_helper'%0A%0Adescribe%20User%20do%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20describe%20%22micropost%20associations%22%20do%0A%20%20%20%20%0A%20%20%20%20before(:each)%20do%0A%20%20%20%20%20%20@user%20=%20User.create(@attr)%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20it%20%22should%20have%20a%20microposts%20attribute%22%20do%0A%20%20%20%20%20%20@user.should%20respond_to(:microposts)%0A%20%20%20%20end%0A%20%20end%0Aend%0A">
      <param name="bgcolor" value="#ffffff">
      <embed src="Chapter-11_fichiers/clippy.swf" name="clippy" quality="high" allowscriptaccess="always" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="text=require%20'spec_helper'%0A%0Adescribe%20User%20do%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20describe%20%22micropost%20associations%22%20do%0A%20%20%20%20%0A%20%20%20%20before(:each)%20do%0A%20%20%20%20%20%20@user%20=%20User.create(@attr)%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20it%20%22should%20have%20a%20microposts%20attribute%22%20do%0A%20%20%20%20%20%20@user.should%20respond_to(:microposts)%0A%20%20%20%20end%0A%20%20end%0Aend%0A" bgcolor="#ffffff" height="14" width="110">
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"les associations au micro-message"</span> <span class="k">do</span>

    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="vi">@attr</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">"devrait avoir un attribut"</span> <span class="k">do</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:microposts</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Nous pouvons obtenir la réussite des tests des extraits <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:micropost_belongs_to_user_spec">Extrait&nbsp;11.4</a> et <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:user_has_many_microposts_spec">Extrait&nbsp;11.5</a> en utilisant l'association <code>belongs_to</code>/<code>has_many</code> (définies dans l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#fig:micropost_belongs_to_user">illustration&nbsp;11.2</a> et l''<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#fig:user_has_many_microposts">illustration&nbsp;11.3</a>), par le codes de l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:micropost_belongs_to_user">extrait&nbsp;11.6</a> et l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:user_has_many_microposts">extrait&nbsp;11.7</a>.</p>

<div class="label" id="code:micropost_belongs_to_user"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 11.6.</span> <span class="description">Un micro-message <code>belongs_to</code> (“appartient à…”) un utilisateur. <br> <code>app/models/micropost.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" id="clippy_370d87fca5399011fb968e723ac4824771b9a3d7" height="14" width="110">
      <param name="movie" value="/flash/clippy.swf">
      <param name="allowScriptAccess" value="always">
      <param name="quality" value="high">
      <param name="scale" value="noscale">
      <param name="FlashVars" value="text=class%20Micropost%20%3C%20ActiveRecord::Base%0A%20%20attr_accessible%20:content%0A%0A%20%20belongs_to%20:user%0Aend%0A">
      <param name="bgcolor" value="#ffffff">
      <embed src="Chapter-11_fichiers/clippy.swf" name="clippy" quality="high" allowscriptaccess="always" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="text=class%20Micropost%20%3C%20ActiveRecord::Base%0A%20%20attr_accessible%20:content%0A%0A%20%20belongs_to%20:user%0Aend%0A" bgcolor="#ffffff" height="14" width="110">
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:content</span>

  <span class="n">belongs_to</span> <span class="ss">:user</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="code:user_has_many_microposts"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 11.7.</span> <span class="description">Un utilisateur <code>has_many</code> (“possède plusieurs…”) micro-messages. <br> <code>app/models/user.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" id="clippy_0d5ca94c69755a5a7932b4cb1737b7f84c6e092a" height="14" width="110">
      <param name="movie" value="/flash/clippy.swf">
      <param name="allowScriptAccess" value="always">
      <param name="quality" value="high">
      <param name="scale" value="noscale">
      <param name="FlashVars" value="text=class%20User%20%3C%20ActiveRecord::Base%0A%20%20attr_accessor%20:password%0A%20%20attr_accessible%20:name,%20:email,%20:password,%20:password_confirmation%0A%20%20%0A%20%20has_many%20:microposts%0A%20%20.%0A%20%20.%0A%20%20.%0Aend%0A">
      <param name="bgcolor" value="#ffffff">
      <embed src="Chapter-11_fichiers/clippy.swf" name="clippy" quality="high" allowscriptaccess="always" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="text=class%20User%20%3C%20ActiveRecord::Base%0A%20%20attr_accessor%20:password%0A%20%20attr_accessible%20:name,%20:email,%20:password,%20:password_confirmation%0A%20%20%0A%20%20has_many%20:microposts%0A%20%20.%0A%20%20.%0A%20%20.%0Aend%0A" bgcolor="#ffffff" height="14" width="110">
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="kp">attr_accessor</span> <span class="ss">:password</span>
  <span class="n">attr_accessible</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:password_confirmation</span>

  <span class="n">has_many</span> <span class="ss">:microposts</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>En utilisant cette association <code>belongs_to</code>/<code>has_many</code>, Rails construit les méthodes montrées dans la <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#table:association_methods">table&nbsp;11.1</a>. Vous devriez comparer les entrées dans la <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#table:association_methods">table&nbsp;11.1</a> avec le code de l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:micropost_belongs_to_user_spec">extrait&nbsp;11.4</a> et l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:user_has_many_microposts_spec">extrait&nbsp;11.5</a> pour être sûr de bien comprendre la nature essentielle de ces associations (il y a une méthode dans la <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#table:association_methods">table&nbsp;11.1</a> que nous n'avons pas utilisé pour le moment, la méthode <code>build</code> (“construire”)&nbsp;; il en sera fait bon usage dans la <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#sec:micropost_validations">section&nbsp;11.1.4</a> et spécialement la <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#sec:creating_microposts">section&nbsp;11.3.2</a>.)</p>

<div class="label" id="table:association_methods"></div>


<div class="table"><div class="center"><table class="tabular"><tbody><tr><th class="align_left"><strong>Méthode</strong></th><th class="align_left"><strong>Objectif</strong></th></tr><tr class="top_bar"><td class="align_left"><code>micropost.user</code></td><td class="align_left">Retourne l'objet `User` associé au micro-messages.</td></tr><tr><td class="align_left"><code>user.microposts</code></td><td class="align_left">Retour une liste (array) des micro-messages de l'utilisateur.</td></tr><tr><td class="align_left"><code>user.microposts.create(arg)</code></td><td class="align_left">Crée un micro-message (<code>user_id = user.id</code>).</td></tr><tr><td class="align_left"><code>user.microposts.create!(arg)</code></td><td class="align_left">Crée un micro-message (en généraant une exception —&nbsp;une erreur&nbsp;— en cas d'échec).</td></tr><tr><td class="align_left"><code>user.microposts.build(arg)</code></td><td class="align_left">Retourne un nouvel objet Micropost (<code>user_id = user.id</code>).</td></tr></tbody></table></div><div class="caption"><span class="header">Table 11.1: </span><span class="description">Résumé des méthodes de l'association utilisateur/micro-message (user/micropost).</span></div></div>




<div class="label" id="sec:ordering_and_dependency"></div>


<h3><a id="sec:11.1.3" href="http://ruby.railstutorial.org/chapters/user-microposts#sec:ordering_and_dependency" class="heading"><span class="number">11.1.3</span> Affinements du micro-message</a></h3>


<p>Le test de l'association <code>has_many</code> (“possède plusieurs…”) de l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:user_has_many_microposts_spec">extrait&nbsp;11.5</a> ne teste pas grand chose —&nbsp;il vérifie simplement l'<em>existence</em> de l'attribut <code>microposts</code> (“micro-messages”). Dans cette section, nous allons ajouter un <em>ordering</em> (“classement”) et un <em>dependency</em> (“dépendance”) aux micro-messages, tout en testant aussi que la valeur retournée par la méthode <code>user.microposts</code> est bien une liste (array) de micro-messages.</p>

<p>Nous allons avoir besoin de construire quelques micro-messages dans le modèle de test `User`, ce qui signifie que nous devrons faire une “usine à micro-messages” (“micropost factory”). Pour ce faire, nous avons besoin d'un moyen de construire une association dans Factory Girl. Heureusement, c'est très facile —&nbsp;nous avons juste à utiliser la méthode <code>micropost.association</code> de Factory Girl, comme le montre l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:micropost_factory">extrait&nbsp;11.8</a>.<sup class="footnote" id="fnref:11.3"><a href="#fn:11.3">3</a></sup></p>

<div class="label" id="code:micropost_factory"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 11.8.</span> <span class="description">Le fichier Factory complet, incluant une nouvelle production pour les micro-messages. <br> <code>spec/factories.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" id="clippy_e3722aa04ab02d3b744f149fc7734740f8c1f6b8" height="14" width="110">
      <param name="movie" value="/flash/clippy.swf">
      <param name="allowScriptAccess" value="always">
      <param name="quality" value="high">
      <param name="scale" value="noscale">
      <param name="FlashVars" value="text=%23%20By%20using%20the%20symbol%20':user',%20we%20get%20Factory%20Girl%20to%20simulate%20the%20User%20model.%0AFactory.define%20:user%20do%20%7Cuser%7C%0A%20%20user.name%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22Michael%20Hartl%22%0A%20%20user.email%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22mhartl@example.com%22%0A%20%20user.password%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22foobar%22%0A%20%20user.password_confirmation%20%22foobar%22%0Aend%0A%0AFactory.sequence%20:email%20do%20%7Cn%7C%0A%20%20%22person%2D%23%7Bn%7D@example.com%22%0Aend%0A%0AFactory.define%20:micropost%20do%20%7Cmicropost%7C%0A%20%20micropost.content%20%22Foo%20bar%22%0A%20%20micropost.association%20:user%0Aend%0A">
      <param name="bgcolor" value="#ffffff">
      <embed src="Chapter-11_fichiers/clippy.swf" name="clippy" quality="high" allowscriptaccess="always" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="text=%23%20By%20using%20the%20symbol%20':user',%20we%20get%20Factory%20Girl%20to%20simulate%20the%20User%20model.%0AFactory.define%20:user%20do%20%7Cuser%7C%0A%20%20user.name%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22Michael%20Hartl%22%0A%20%20user.email%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22mhartl@example.com%22%0A%20%20user.password%20%20%20%20%20%20%20%20%20%20%20%20%20%20%22foobar%22%0A%20%20user.password_confirmation%20%22foobar%22%0Aend%0A%0AFactory.sequence%20:email%20do%20%7Cn%7C%0A%20%20%22person%2D%23%7Bn%7D@example.com%22%0Aend%0A%0AFactory.define%20:micropost%20do%20%7Cmicropost%7C%0A%20%20micropost.content%20%22Foo%20bar%22%0A%20%20micropost.association%20:user%0Aend%0A" bgcolor="#ffffff" height="14" width="110">
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="c1"># En utilisant le symbole ':user', nous obtenons que Factory Girl simule
# le modèle `User`.</span>
<span class="no">Factory</span><span class="o">.</span><span class="n">define</span> <span class="ss">:user</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
  <span class="n">user</span><span class="o">.</span><span class="n">name</span>                  <span class="s2">"Michael Hartl"</span>
  <span class="n">user</span><span class="o">.</span><span class="n">email</span>                 <span class="s2">"mhartl@example.com"</span>
  <span class="n">user</span><span class="o">.</span><span class="n">password</span>              <span class="s2">"foobar"</span>
  <span class="n">user</span><span class="o">.</span><span class="n">password_confirmation</span> <span class="s2">"foobar"</span>
<span class="k">end</span>

<span class="no">Factory</span><span class="o">.</span><span class="n">sequence</span> <span class="ss">:email</span> <span class="k">do</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span>
  <span class="s2">"person-</span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">@example.com"</span>
<span class="k">end</span>

<span class="no">Factory</span><span class="o">.</span><span class="n">define</span> <span class="ss">:micropost</span> <span class="k">do</span> <span class="o">|</span><span class="n">micropost</span><span class="o">|</span>
  <span class="n">micropost</span><span class="o">.</span><span class="n">content</span> <span class="s2">"Foo bar"</span>
  <span class="n">micropost</span><span class="o">.</span><span class="n">association</span> <span class="ss">:user</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="sec:default_scope"></div>


<h4><a id="sec:11.1.3.1" href="http://ruby.railstutorial.org/chapters/user-microposts#sec:default_scope" class="heading">Portée par défaut</a></h4>


<p>[Nous pourrions nous arranger pour que les micro-messages produits fonctionne dans un test pour le classement des micro-messages.][We can put the micropost factory to work in a test for the ordering of microposts.] Par défaut, l'utilisation de <code>user.microposts</code> pour relever de la base de données les micro-messages de l'utilisateur ne garantit en aucune façon l'ordre de ces messages, mais (en suivant les conventions des blogs et de Twitter), nous voulons que les micro-messages sortent dans l'ordre inverse de leur création, c'est-à-dire les plus récents en premier. Pour tester ce classement, nous commençons par créer deux micro-messages comme suit&nbsp;:</p>

<div class="code"><div class="highlight"><pre>  <span class="vi">@mp1</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">:created_at</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
  <span class="vi">@mp2</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">:created_at</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
</pre></div>
</div>


<p>Ici nous indiquons que le second message a été créé plus récemment, une heure plus tôt (<code>1.hour.ago</code> = “il y a 1 heure”), et le premier message a été créé il y a un jour (<code>1.day.ago</code>). Notez comme l'utilisation de  Girl est pratique ici&nbsp;: non seulement nous pouvons désigner un utilisateur en utilisant une “assignation publique” (puisque les productions de Factory <em>by-passent</em> —&nbsp;contournent&nbsp;— le paramètre <code>attr_accessible</code>), mais nous pouvons aussi renseigner l'attribut <code>created_at</code> manuellement, ce que Active Record ne nous laisseraient jamais faire.<sup class="footnote" id="fnref:11.4"><a href="#fn:11.4">4</a></sup></p>

<p>La plupart des adaptateurs de bases de données (SQLite compris) retournent les micro-messages en les classant par leur identifiant (colonne <code>id</code>), donc nous pouvons arranger un test initial qui échouera presque à coup sûr, en utilisant le code de l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:micropost_ordering_test">extrait&nbsp;11.9</a>.</p>

<div class="label" id="code:micropost_ordering_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 11.9.</span> <span class="description">Test de l'ordre des micro-messages de l'utilisateur. <br> <code>spec/models/user_spec.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" id="clippy_a907921501d43b031a3d8ddce65cdaa906db7361" height="14" width="110">
      <param name="movie" value="/flash/clippy.swf">
      <param name="allowScriptAccess" value="always">
      <param name="quality" value="high">
      <param name="scale" value="noscale">
      <param name="FlashVars" value="text=require%20'spec_helper'%0A%0Adescribe%20User%20do%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20describe%20%22micropost%20associations%22%20do%0A%20%20%20%20%0A%20%20%20%20before(:each)%20do%0A%20%20%20%20%20%20@user%20=%20User.create(@attr)%0A%20%20%20%20%20%20@mp1%20=%20Factory(:micropost,%20:user%20=%3E%20@user,%20:created_at%20=%3E%201.day.ago)%0A%20%20%20%20%20%20@mp2%20=%20Factory(:micropost,%20:user%20=%3E%20@user,%20:created_at%20=%3E%201.hour.ago)%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20it%20%22should%20have%20a%20microposts%20attribute%22%20do%0A%20%20%20%20%20%20@user.should%20respond_to(:microposts)%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20it%20%22should%20have%20the%20right%20microposts%20in%20the%20right%20order%22%20do%0A%20%20%20%20%20%20@user.microposts.should%20==%20[@mp2,%20@mp1]%0A%20%20%20%20end%0A%20%20end%0Aend%0A">
      <param name="bgcolor" value="#ffffff">
      <embed src="Chapter-11_fichiers/clippy.swf" name="clippy" quality="high" allowscriptaccess="always" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="text=require%20'spec_helper'%0A%0Adescribe%20User%20do%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20describe%20%22micropost%20associations%22%20do%0A%20%20%20%20%0A%20%20%20%20before(:each)%20do%0A%20%20%20%20%20%20@user%20=%20User.create(@attr)%0A%20%20%20%20%20%20@mp1%20=%20Factory(:micropost,%20:user%20=%3E%20@user,%20:created_at%20=%3E%201.day.ago)%0A%20%20%20%20%20%20@mp2%20=%20Factory(:micropost,%20:user%20=%3E%20@user,%20:created_at%20=%3E%201.hour.ago)%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20it%20%22should%20have%20a%20microposts%20attribute%22%20do%0A%20%20%20%20%20%20@user.should%20respond_to(:microposts)%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20it%20%22should%20have%20the%20right%20microposts%20in%20the%20right%20order%22%20do%0A%20%20%20%20%20%20@user.microposts.should%20==%20[@mp2,%20@mp1]%0A%20%20%20%20end%0A%20%20end%0Aend%0A" bgcolor="#ffffff" height="14" width="110">
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"micropost associations"</span> <span class="k">do</span>

    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="vi">@attr</span><span class="p">)</span>
      <span class="vi">@mp1</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">:created_at</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
      <span class="vi">@mp2</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">:created_at</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">"devrait avoir un attribut `microposts`"</span> <span class="k">do</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:microposts</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">"devrait avoir les bons micro-messags dans le bon ordre"</span> <span class="k">do</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="o">[</span><span class="vi">@mp2</span><span class="p">,</span> <span class="vi">@mp1</span><span class="o">]</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>La clé du problème ici est…</p>

<div class="code"><div class="highlight"><pre><span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="o">[</span><span class="vi">@mp2</span><span class="p">,</span> <span class="vi">@mp1</span><span class="o">]</span>
</pre></div>
</div>


<p>… qui indique que les messages doivent être bien classés, les plus récents d'abord. Cette condition devrait échouer parce que par défaut les messages seront classés par leur identifiant (id), donc&nbsp;: <code>[@mp1, @mp2]</code>. Ce test vérifie aussi la validité de l'association <code>has_many</code> elle-même, en s'assurant (comme indiqué dans la <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#table:association_methods">table&nbsp;11.1</a>) que <code>user.microposts</code> est bien une liste (array) de micro-messages.</p>

<p>Pour faire réussir le test de classement, nous utilisons une facilité de Rails appelée <code>default_scope</code> (“portée par défaut”) avec un paramètre <code>:order</code> (“ordre”), comme le montre l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:micropost_ordering">extrait&nbsp;11.10</a>. (C'est notre premier exemple de la notion de <em>portée</em> (<em>scope</em>). Nous en apprendrons davantage à propos de la “portée” dans un contexte plus général au <a class="ref" href="http://ruby.railstutorial.org/chapters/following-users#top">Chapitre&nbsp;12</a>.)</p>

<div class="label" id="code:micropost_ordering"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 11.10.</span> <span class="description">Classement des micro-messages avec <code>default_scope</code>.  <br> <code>app/models/micropost.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" id="clippy_77ba53ababd372a2ddfca99e3d229cb97f820edf" height="14" width="110">
      <param name="movie" value="/flash/clippy.swf">
      <param name="allowScriptAccess" value="always">
      <param name="quality" value="high">
      <param name="scale" value="noscale">
      <param name="FlashVars" value="text=class%20Micropost%20%3C%20ActiveRecord::Base%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20default_scope%20:order%20=%3E%20'microposts.created_at%20DESC'%0Aend%0A">
      <param name="bgcolor" value="#ffffff">
      <embed src="Chapter-11_fichiers/clippy.swf" name="clippy" quality="high" allowscriptaccess="always" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="text=class%20Micropost%20%3C%20ActiveRecord::Base%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20default_scope%20:order%20=%3E%20'microposts.created_at%20DESC'%0Aend%0A" bgcolor="#ffffff" height="14" width="110">
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">default_scope</span> <span class="ss">:order</span> <span class="o">=&gt;</span> <span class="s1">'microposts.created_at DESC'</span>
<span class="k">end</span>
</pre></div>
</div></div>

<p>The order here is <code>’microposts.created_at DESC’</code>, where <code>DESC</code> is SQL for “descending”, i.e., in descending order from newest to oldest.</p>

<div class="label" id="sec:dependent_destroy"></div>


<h4><a id="sec:11.1.3.2" href="http://ruby.railstutorial.org/chapters/user-microposts#sec:dependent_destroy" class="heading">Destruction dépendante (Dependent: destroy)</a></h4>


<p>En dehors du classement adéquat, nous aimerions ajouter un second affinement aux micro-messages. Comme nous l'avons vu à la <a class="ref" href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#sec:destroying_users">section&nbsp;10.4</a>, les administrateurs du site ont le pouvoir de suppression (<em>destroy</em>) des utilisateurs. Il semble raisonnable de penser que si un utilisateur est supprimé, ses micro-messages doivent être détruits. Nous pouvons tester cela d'abord en détruisant un auteur de micro-messages, puis ensuite en vérifiant que les micro-messages associés à cet utilisateur ne se trouvent plus dans la base de données (<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:micropost_dependency_test">Extrait&nbsp;11.11</a>).</p>

<div class="label" id="code:micropost_dependency_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 11.11.</span> <span class="description">Test de la destruction des micro-messages à la destruction de leur auteur. <br> <code>spec/models/user_spec.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" id="clippy_d19e41f8dd51f82fe89636c0b4bcc87ff98901da" height="14" width="110">
      <param name="movie" value="/flash/clippy.swf">
      <param name="allowScriptAccess" value="always">
      <param name="quality" value="high">
      <param name="scale" value="noscale">
      <param name="FlashVars" value="text=describe%20User%20do%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20describe%20%22micropost%20associations%22%20do%0A%20%20%20%20%0A%20%20%20%20before(:each)%20do%0A%20%20%20%20%20%20@user%20=%20User.create(@attr)%0A%20%20%20%20%20%20@mp1%20=%20Factory(:micropost,%20:user%20=%3E%20@user,%20:created_at%20=%3E%201.day.ago)%0A%20%20%20%20%20%20@mp2%20=%20Factory(:micropost,%20:user%20=%3E%20@user,%20:created_at%20=%3E%201.hour.ago)%0A%20%20%20%20end%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20%20%20it%20%22should%20destroy%20associated%20microposts%22%20do%0A%20%20%20%20%20%20@user.destroy%0A%20%20%20%20%20%20[@mp1,%20@mp2].each%20do%20%7Cmicropost%7C%0A%20%20%20%20%20%20%20%20Micropost.find_by_id(micropost.id).should%20be_nil%0A%20%20%20%20%20%20end%0A%20%20%20%20end%0A%20%20end%0A%20%20.%0A%20%20.%0A%20%20.%0Aend%0A">
      <param name="bgcolor" value="#ffffff">
      <embed src="Chapter-11_fichiers/clippy.swf" name="clippy" quality="high" allowscriptaccess="always" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="text=describe%20User%20do%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20describe%20%22micropost%20associations%22%20do%0A%20%20%20%20%0A%20%20%20%20before(:each)%20do%0A%20%20%20%20%20%20@user%20=%20User.create(@attr)%0A%20%20%20%20%20%20@mp1%20=%20Factory(:micropost,%20:user%20=%3E%20@user,%20:created_at%20=%3E%201.day.ago)%0A%20%20%20%20%20%20@mp2%20=%20Factory(:micropost,%20:user%20=%3E%20@user,%20:created_at%20=%3E%201.hour.ago)%0A%20%20%20%20end%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20%20%20it%20%22should%20destroy%20associated%20microposts%22%20do%0A%20%20%20%20%20%20@user.destroy%0A%20%20%20%20%20%20[@mp1,%20@mp2].each%20do%20%7Cmicropost%7C%0A%20%20%20%20%20%20%20%20Micropost.find_by_id(micropost.id).should%20be_nil%0A%20%20%20%20%20%20end%0A%20%20%20%20end%0A%20%20end%0A%20%20.%0A%20%20.%0A%20%20.%0Aend%0A" bgcolor="#ffffff" height="14" width="110">
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"micropost associations"</span> <span class="k">do</span>

    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="vi">@attr</span><span class="p">)</span>
      <span class="vi">@mp1</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">:created_at</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
      <span class="vi">@mp2</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">:created_at</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">it</span> <span class="s2">"devrait détruire les micro-messages associés"</span> <span class="k">do</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">destroy</span>
      <span class="o">[</span><span class="vi">@mp1</span><span class="p">,</span> <span class="vi">@mp2</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">micropost</span><span class="o">|</span>
        <span class="no">Micropost</span><span class="o">.</span><span class="n">find_by_id</span><span class="p">(</span><span class="n">micropost</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="n">be_nil</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Ici nous avons utilisé <code>Micropost.find_by_id</code>, qui retourne la valeur nulle (<code>nil</code>) si l'enregistrement n'est pas trouvé dans la base de données, tandis que <code>Micropost.find</code> provoque une exception (une erreur) en cas d'échec, ce qui est plus difficile à tester. (Si vous êtes curieux…</p>

<div class="code"><div class="highlight"><pre><span class="nb">lambda</span> <span class="k">do</span> 
  <span class="no">Micropost</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">micropost</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<span class="k">end</span><span class="o">.</span><span class="n">should</span> <span class="n">raise_error</span><span class="p">(</span><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">RecordNotFound</span><span class="p">)</span>
</pre></div>
</div>


<p>… accomplit ce test)</p>

<p>Le code de l'application pour que l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:micropost_dependency_test">extrait&nbsp;11.11</a> réussisse le test fait moins d'une ligne&nbsp;; en fait, c'est juste une option à ajouter à la méthode associative <code>has_many</code>, comme le montre l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:micropost_dependency">extrait&nbsp;11.12</a>.</p>

<div class="label" id="code:micropost_dependency"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 11.12.</span> <span class="description">S'assurer que les micro-messages de l'utilisateur seront détruits avec lui. <br> <code>app/models/user.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" id="clippy_79a87399627165d5a2732c079ddf1f00aa86dcd1" height="14" width="110">
      <param name="movie" value="/flash/clippy.swf">
      <param name="allowScriptAccess" value="always">
      <param name="quality" value="high">
      <param name="scale" value="noscale">
      <param name="FlashVars" value="text=class%20User%20%3C%20ActiveRecord::Base%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20has_many%20:microposts,%20:dependent%20=%3E%20:destroy%0A%20%20.%0A%20%20.%0A%20%20.%0Aend%0A">
      <param name="bgcolor" value="#ffffff">
      <embed src="Chapter-11_fichiers/clippy.swf" name="clippy" quality="high" allowscriptaccess="always" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="text=class%20User%20%3C%20ActiveRecord::Base%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20has_many%20:microposts,%20:dependent%20=%3E%20:destroy%0A%20%20.%0A%20%20.%0A%20%20.%0Aend%0A" bgcolor="#ffffff" height="14" width="110">
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">has_many</span> <span class="ss">:microposts</span><span class="p">,</span> <span class="ss">:dependent</span> <span class="o">=&gt;</span> <span class="ss">:destroy</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Avec ça, le formulaire final de l'association utilisateur/micro-message est en place.</p>

<div class="label" id="sec:micropost_validations"></div>


<h3><a id="sec:11.1.4" href="http://ruby.railstutorial.org/chapters/user-microposts#sec:micropost_validations" class="heading"><span class="number">11.1.4</span> Validation du micro-message</a></h3>


<p>Avant d'abandonner le modèle `Micropost` (“Micro-message”), nous allons [nous occuper d'une ou deux impairs possibles][we’ll tie off a couple of loose ends] en ajoutant des validations (en suivant l'exemple donné dans la <a class="ref" href="http://ruby.railstutorial.org/chapters/a-demo-app#sec:putting_the_micro_in_microposts">Section&nbsp;2.3.2</a>). Les deux attributs <code>user_id</code> et <code>content</code> sont requis, et <code>content</code> est de plus contraint de faire moins de 140 signes, ce que nous testons avec le code de l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:micropost_validations_tests">extrait&nbsp;11.13</a>.</p>

<div class="label" id="code:micropost_validations_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 11.13.</span> <span class="description">Tests pour les validations du modèle Micropost. <br> <code>spec/models/micropost_spec.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" id="clippy_5f543db9527e4fd4a5d442cd34b09d46594d2d29" height="14" width="110">
      <param name="movie" value="/flash/clippy.swf">
      <param name="allowScriptAccess" value="always">
      <param name="quality" value="high">
      <param name="scale" value="noscale">
      <param name="FlashVars" value="text=require%20'spec_helper'%0A%0Adescribe%20Micropost%20do%0A%0A%20%20before(:each)%20do%0A%20%20%20%20@user%20=%20Factory(:user)%0A%20%20%20%20@attr%20=%20%7B%20:content%20=%3E%20%22value%20for%20content%22%20%7D%0A%20%20end%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20describe%20%22validations%22%20do%0A%20%20%20%20%0A%20%20%20%20it%20%22should%20require%20a%20user%20id%22%20do%0A%20%20%20%20%20%20Micropost.new(@attr).should_not%20be_valid%0A%20%20%20%20end%0A%20%20%0A%20%20%20%20it%20%22should%20require%20nonblank%20content%22%20do%0A%20%20%20%20%20%20@user.microposts.build(:content%20=%3E%20%22%20%20%22).should_not%20be_valid%0A%20%20%20%20end%0A%20%20%0A%20%20%20%20it%20%22should%20reject%20long%20content%22%20do%0A%20%20%20%20%20%20@user.microposts.build(:content%20=%3E%20%22a%22%20*%20141).should_not%20be_valid%0A%20%20%20%20end%0A%20%20end%0Aend%0A">
      <param name="bgcolor" value="#ffffff">
      <embed src="Chapter-11_fichiers/clippy.swf" name="clippy" quality="high" allowscriptaccess="always" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="text=require%20'spec_helper'%0A%0Adescribe%20Micropost%20do%0A%0A%20%20before(:each)%20do%0A%20%20%20%20@user%20=%20Factory(:user)%0A%20%20%20%20@attr%20=%20%7B%20:content%20=%3E%20%22value%20for%20content%22%20%7D%0A%20%20end%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20describe%20%22validations%22%20do%0A%20%20%20%20%0A%20%20%20%20it%20%22should%20require%20a%20user%20id%22%20do%0A%20%20%20%20%20%20Micropost.new(@attr).should_not%20be_valid%0A%20%20%20%20end%0A%20%20%0A%20%20%20%20it%20%22should%20require%20nonblank%20content%22%20do%0A%20%20%20%20%20%20@user.microposts.build(:content%20=%3E%20%22%20%20%22).should_not%20be_valid%0A%20%20%20%20end%0A%20%20%0A%20%20%20%20it%20%22should%20reject%20long%20content%22%20do%0A%20%20%20%20%20%20@user.microposts.build(:content%20=%3E%20%22a%22%20*%20141).should_not%20be_valid%0A%20%20%20%20end%0A%20%20end%0Aend%0A" bgcolor="#ffffff" height="14" width="110">
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">Micropost</span> <span class="k">do</span>

  <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
    <span class="vi">@attr</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="s2">"value for content"</span> <span class="p">}</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"validations"</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">"requiert un identifiant d'utilisateur"</span> <span class="k">do</span>
      <span class="no">Micropost</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@attr</span><span class="p">)</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_valid</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">"requiert un contenu non vide"</span> <span class="k">do</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="ss">:content</span> <span class="o">=&gt;</span> <span class="s2">"  "</span><span class="p">)</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_valid</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">"derait rejeter un contenu trop long"</span> <span class="k">do</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="ss">:content</span> <span class="o">=&gt;</span> <span class="s2">"a"</span> <span class="o">*</span> <span class="mi">141</span><span class="p">)</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_valid</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Cela suit de façon générale les exemples des tests de validation du modèle `User` de la <a class="ref" href="http://ruby.railstutorial.org/chapters/modeling-and-viewing-users-one#sec:user_validations">section&nbsp;6.2</a>.
	(les tests, dans cette section&nbsp;6.2 ont été répartis sur plusieurs lignes, mais vous devriez être suffisamment à l'aise maintenant avec le code RSpec pour digérer la formulation plus compacte utilisée ci-dessus)</p>

<p>Comme dans la <a class="ref" href="http://ruby.railstutorial.org/chapters/modeling-and-viewing-users-one#sec:user_validations">section&nbsp;6.2</a>, le code de l''<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:micropost_validations_tests">extrait&nbsp;11.13</a> utilise la multiplication de chaines (string multiplication) pour tester la validation de la longueur du micro-message&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails console
<span class="gp">&gt;</span>&gt; <span class="s2">"a"</span> * 10
<span class="go">=&gt; "aaaaaaaaaa"</span>
<span class="gp">&gt;</span>&gt; <span class="s2">"a"</span> * 141
<span class="go">=&gt; "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa</span>
<span class="go">aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"</span>
</pre></div>
</div>


<p>En contraste, au lieu d'utiliser le constructeur par défaut&nbsp;<code>new</code> comme dans…</p>

<div class="code"><div class="highlight"><pre><span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="p">)</span>
</pre></div>
</div>


<p>… le code dans l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:micropost_validations_tests">extrait&nbsp;11.13</a> utilise la méthode <code>build</code>&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span>
</pre></div>
</div>


<p>Rappelez-vous que d'après la <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#table:association_methods">table&nbsp;11.1</a> que c'est par essence équivalent à <code>Micropost.new</code>, à la différence près que ça règle de façon automatique l'attribut <code>user_id</code> du micro-message à la valeur <code>@user.id</code>.</p>

<p>Les validations elles-mêmes sont franchement analogues à celles du modèle `User`, comme le montre l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:micropost_validations">extrait&nbsp;11.14</a>.</p>

<div class="label" id="code:micropost_validations"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 11.14.</span> <span class="description">Les validations du modèle Micropost. <br> <code>app/models/micropost.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" id="clippy_7c313fb9812aef6528eab7a04e8291518d13d962" height="14" width="110">
      <param name="movie" value="/flash/clippy.swf">
      <param name="allowScriptAccess" value="always">
      <param name="quality" value="high">
      <param name="scale" value="noscale">
      <param name="FlashVars" value="text=class%20Micropost%20%3C%20ActiveRecord::Base%0A%20%20attr_accessible%20:content%0A%20%20%0A%20%20belongs_to%20:user%0A%20%20%0A%20%20validates%20:content,%20:presence%20=%3E%20true,%20:length%20=%3E%20%7B%20:maximum%20=%3E%20140%20%7D%0A%20%20validates%20:user_id,%20:presence%20=%3E%20true%0A%20%20%0A%20%20default_scope%20:order%20=%3E%20'microposts.created_at%20DESC'%0Aend%0A">
      <param name="bgcolor" value="#ffffff">
      <embed src="Chapter-11_fichiers/clippy.swf" name="clippy" quality="high" allowscriptaccess="always" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="text=class%20Micropost%20%3C%20ActiveRecord::Base%0A%20%20attr_accessible%20:content%0A%20%20%0A%20%20belongs_to%20:user%0A%20%20%0A%20%20validates%20:content,%20:presence%20=%3E%20true,%20:length%20=%3E%20%7B%20:maximum%20=%3E%20140%20%7D%0A%20%20validates%20:user_id,%20:presence%20=%3E%20true%0A%20%20%0A%20%20default_scope%20:order%20=%3E%20'microposts.created_at%20DESC'%0Aend%0A" bgcolor="#ffffff" height="14" width="110">
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:content</span>

  <span class="n">belongs_to</span> <span class="ss">:user</span>

  <span class="n">validates</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">:length</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:maximum</span> <span class="o">=&gt;</span> <span class="mi">140</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="ss">:user_id</span><span class="p">,</span> <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span>

  <span class="n">default_scope</span> <span class="ss">:order</span> <span class="o">=&gt;</span> <span class="s1">'microposts.created_at DESC'</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Cela achève le modelage des données pour les utilisateurs les micro-messages. Il est temps à présent de construire l'interface web.</p>

<div class="label" id="sec:showing_microposts"></div>


<h2><a id="sec:11.2" href="http://ruby.railstutorial.org/chapters/user-microposts#sec:showing_microposts" class="heading"><span class="number">11.2</span> Affichage des micro-messages</a></h2>


<p>Bien que nous n'ayons pas encore de façon de créer des micro-messages par le web —&nbsp;cela viendra avec la <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#sec:creating_microposts">section&nbsp;11.3.2</a>&nbsp;— çe ne doit pas nous empêcher de les afficher (et de tester cette affichage). À l'instar de Twitter, nous planifions d'afficher ces micro-messages d'utilisateur non pas dans une page <code>index</code> séparée, mais plutôt dans la page de l'utilisateur elle-même (la page <code>show</code>), comme l'illustration la maquette de l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#fig:user_microposts_mockup">illustration&nbsp;11.4</a>. Nous commencerons avec un template ERb assez simple qui affichera un micro-message dans le profil de l'utlisateur, puis nous ajouterons les micro-messages dans le peuplement de la base exemple de la <a class="ref" href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#sec:sample_users">section&nbsp;10.3.2</a> pour que nous ayons quelque chose à afficher.</p>

<div class="label" id="fig:user_microposts_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="Chapter-11_fichiers/user_microposts_mockup.png" alt="user_microposts_mockup"></span></div><div class="caption"><span class="header">Illustration 11.4: </span><span class="description">Maquette de la page de profil avec des micro-messages.&nbsp;<a href="http://railstutorial.org/images/figures/user_microposts_mockup-full.png">(taille normale)</a></span></div></div>


<p>Comme pour la discussion sur la machinerie d'identification dans la <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec:remember_me">section&nbsp;9.3.2</a>, la <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#sec:augmenting_the_user_show_page">section&nbsp;11.2.1</a> poussera souvent plusieurs éléments à la fois dans le tampon (<a href="http://en.wikipedia.org/wiki/Stack_%28data_structure%29">stack</a>), avant de les “éclater” un par un. Si vous vous sentez un peu lourd, soyez patient&nbsp;; il y a un paiement plutôt sympa à la <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#sec:sample_microposts">section&nbsp;11.2.2</a>.</p>

<div class="label" id="sec:augmenting_the_user_show_page"></div>


<h3><a id="sec:11.2.1" href="http://ruby.railstutorial.org/chapters/user-microposts#sec:augmenting_the_user_show_page" class="heading"><span class="number">11.2.1</span> Etoffement de la page de l'utilisateur</a></h3>


<p>Nous commençons avec un test pour l'affichage des micro-messages de l'utilisateur. Nous travaillons dans le spec du contrôleur `Users` puisque c'est le contrôleur `Users` qui contient l'action <code>show</code> de l'utilisateur. Notre stratégie est de créer une paire de micro-messages d'usine associés à un utilisateur, et alors de vérifier que la page possède une balise <code>span</code> de classe CSS <code>"content"</code> contenant chaque contenu de message. L'exemple RSpec en résultant apparait dans l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:user_show_microposts_test">extrait&nbsp;11.15</a>.</p>

<div class="label" id="code:user_show_microposts_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 11.15.</span> <span class="description">Test d'affichage des micro-messages dans la page d'affichage de l'utilisateur (<code>show</code> page). <br> <code>spec/controllers/users_controller_spec.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" id="clippy_9f89775a748371bb3005f3e861ad514f37083e78" height="14" width="110">
      <param name="movie" value="/flash/clippy.swf">
      <param name="allowScriptAccess" value="always">
      <param name="quality" value="high">
      <param name="scale" value="noscale">
      <param name="FlashVars" value="text=require%20'spec_helper'%0A%0Adescribe%20UsersController%20do%0A%20%20render_views%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20describe%20%22GET%20'show'%22%20do%0A%20%20%20%20%0A%20%20%20%20before(:each)%20do%0A%20%20%20%20%20%20@user%20=%20Factory(:user)%0A%20%20%20%20end%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20%20%20it%20%22should%20show%20the%20user's%20microposts%22%20do%0A%20%20%20%20%20%20mp1%20=%20Factory(:micropost,%20:user%20=%3E%20@user,%20:content%20=%3E%20%22Foo%20bar%22)%0A%20%20%20%20%20%20mp2%20=%20Factory(:micropost,%20:user%20=%3E%20@user,%20:content%20=%3E%20%22Baz%20quux%22)%0A%20%20%20%20%20%20get%20:show,%20:id%20=%3E%20@user%0A%20%20%20%20%20%20response.should%20have_selector(%22span.content%22,%20:content%20=%3E%20mp1.content)%0A%20%20%20%20%20%20response.should%20have_selector(%22span.content%22,%20:content%20=%3E%20mp2.content)%0A%20%20%20%20end%0A%20%20end%0A%20%20.%0A%20%20.%0A%20%20.%0Aend%0A">
      <param name="bgcolor" value="#ffffff">
      <embed src="Chapter-11_fichiers/clippy.swf" name="clippy" quality="high" allowscriptaccess="always" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="text=require%20'spec_helper'%0A%0Adescribe%20UsersController%20do%0A%20%20render_views%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20describe%20%22GET%20'show'%22%20do%0A%20%20%20%20%0A%20%20%20%20before(:each)%20do%0A%20%20%20%20%20%20@user%20=%20Factory(:user)%0A%20%20%20%20end%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20%20%20it%20%22should%20show%20the%20user's%20microposts%22%20do%0A%20%20%20%20%20%20mp1%20=%20Factory(:micropost,%20:user%20=%3E%20@user,%20:content%20=%3E%20%22Foo%20bar%22)%0A%20%20%20%20%20%20mp2%20=%20Factory(:micropost,%20:user%20=%3E%20@user,%20:content%20=%3E%20%22Baz%20quux%22)%0A%20%20%20%20%20%20get%20:show,%20:id%20=%3E%20@user%0A%20%20%20%20%20%20response.should%20have_selector(%22span.content%22,%20:content%20=%3E%20mp1.content)%0A%20%20%20%20%20%20response.should%20have_selector(%22span.content%22,%20:content%20=%3E%20mp2.content)%0A%20%20%20%20end%0A%20%20end%0A%20%20.%0A%20%20.%0A%20%20.%0Aend%0A" bgcolor="#ffffff" height="14" width="110">
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">UsersController</span> <span class="k">do</span>
  <span class="n">render_views</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"GET 'show'"</span> <span class="k">do</span>

    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">it</span> <span class="s2">"devrait afficher les micro-messages de l'utilisateur"</span> <span class="k">do</span>
      <span class="n">mp1</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="s2">"Foo bar"</span><span class="p">)</span>
      <span class="n">mp2</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="s2">"Baz quux"</span><span class="p">)</span>
      <span class="n">get</span> <span class="ss">:show</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="vi">@user</span>
      <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">"span.content"</span><span class="p">,</span> <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="n">mp1</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
      <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">"span.content"</span><span class="p">,</span> <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="n">mp2</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Bien que ces tests échoueront jusqu'à ce que soit implémenté l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:micropost_partial">extrait&nbsp;11.17</a>, nous allons commencer sur le code de l'application par insérer une table de micro-messages à l'intérieur de la page de profil de l'utilisateur, comme montré dans l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:user_show_microposts">extrait&nbsp;11.16</a>.<sup class="footnote" id="fnref:11.5"><a href="#fn:11.5">5</a></sup></p>

<div class="label" id="code:user_show_microposts"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 11.16.</span> <span class="description">Ajout de micro-messages à la page d'affichage de l'utilisateur. <br> <code>app/views/users/show.html.erb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" id="clippy_088cef1ca652006fdc41d9275c8ace05776f15c2" height="14" width="110">
      <param name="movie" value="/flash/clippy.swf">
      <param name="allowScriptAccess" value="always">
      <param name="quality" value="high">
      <param name="scale" value="noscale">
      <param name="FlashVars" value="text=%3Ctable%20class=%22profile%22%3E%0A%20%20%3Ctr%3E%0A%20%20%20%20%3Ctd%20class=%22main%22%3E%0A%20%20%20%20%20%20.%0A%20%20%20%20%20%20.%0A%20%20%20%20%20%20.%0A%20%20%20%20%20%20%3C%25%20unless%20@user.microposts.empty?%20%25%3E%0A%20%20%20%20%20%20%20%20%3Ctable%20class=%22microposts%22%20summary=%22User%20microposts%22%3E%0A%20%20%20%20%20%20%20%20%20%20%3C%25=%20render%20@microposts%20%25%3E%0A%20%20%20%20%20%20%20%20%3C/table%3E%0A%20%20%20%20%20%20%20%20%3C%25=%20will_paginate%20@microposts%20%25%3E%0A%20%20%20%20%20%20%3C%25%20end%20%25%3E%0A%20%20%20%20%3C/td%3E%0A%20%20%20%20%3Ctd%20class=%22sidebar%20round%22%3E%0A%20%20%20%20%20%20%3Cstrong%3EName%3C/strong%3E%20%3C%25=%20@user.name%20%25%3E%3Cbr%20/%3E%0A%20%20%20%20%20%20%3Cstrong%3EURL%3C/strong%3E%20%3C%25=%20link_to%20user_path(@user),%20@user%20%25%3E%3Cbr%20/%3E%0A%20%20%20%20%20%20%3Cstrong%3EMicroposts%3C/strong%3E%20%3C%25=%20@user.microposts.count%20%25%3E%0A%20%20%20%20%3C/td%3E%0A%20%20%3C/tr%3E%0A%3C/table%3E%0A">
      <param name="bgcolor" value="#ffffff">
      <embed src="Chapter-11_fichiers/clippy.swf" name="clippy" quality="high" allowscriptaccess="always" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="text=%3Ctable%20class=%22profile%22%3E%0A%20%20%3Ctr%3E%0A%20%20%20%20%3Ctd%20class=%22main%22%3E%0A%20%20%20%20%20%20.%0A%20%20%20%20%20%20.%0A%20%20%20%20%20%20.%0A%20%20%20%20%20%20%3C%25%20unless%20@user.microposts.empty?%20%25%3E%0A%20%20%20%20%20%20%20%20%3Ctable%20class=%22microposts%22%20summary=%22User%20microposts%22%3E%0A%20%20%20%20%20%20%20%20%20%20%3C%25=%20render%20@microposts%20%25%3E%0A%20%20%20%20%20%20%20%20%3C/table%3E%0A%20%20%20%20%20%20%20%20%3C%25=%20will_paginate%20@microposts%20%25%3E%0A%20%20%20%20%20%20%3C%25%20end%20%25%3E%0A%20%20%20%20%3C/td%3E%0A%20%20%20%20%3Ctd%20class=%22sidebar%20round%22%3E%0A%20%20%20%20%20%20%3Cstrong%3EName%3C/strong%3E%20%3C%25=%20@user.name%20%25%3E%3Cbr%20/%3E%0A%20%20%20%20%20%20%3Cstrong%3EURL%3C/strong%3E%20%3C%25=%20link_to%20user_path(@user),%20@user%20%25%3E%3Cbr%20/%3E%0A%20%20%20%20%20%20%3Cstrong%3EMicroposts%3C/strong%3E%20%3C%25=%20@user.microposts.count%20%25%3E%0A%20%20%20%20%3C/td%3E%0A%20%20%3C/tr%3E%0A%3C/table%3E%0A" bgcolor="#ffffff" height="14" width="110">
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;table</span> <span class="na">class=</span><span class="s">"profile"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;tr&gt;</span>
    <span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">"main"</span><span class="nt">&gt;</span>
      .
      .
      .
      <span class="cp">&lt;%</span> <span class="k">unless</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">empty?</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;table</span> <span class="na">class=</span><span class="s">"microposts"</span> <span class="na">summary=</span><span class="s">"User microposts"</span><span class="nt">&gt;</span>
          <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@microposts</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;/table&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="vi">@microposts</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">"sidebar round"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;strong&gt;</span>Name<span class="nt">&lt;/strong&gt;</span> <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span><span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;strong&gt;</span>URL<span class="nt">&lt;/strong&gt;</span> <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">),</span> <span class="vi">@user</span> <span class="cp">%&gt;</span><span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;strong&gt;</span>Microposts<span class="nt">&lt;/strong&gt;</span> <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">count</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/td&gt;</span>
  <span class="nt">&lt;/tr&gt;</span>
<span class="nt">&lt;/table&gt;</span>
</pre></div>
</div></div>


<p>Nous allons traiter avec la <code>table</code> microposts momentanément, mais il y reste quelques autres choses à noter d'abord. Une nouvelle idée est l'utilisation de <code>empty?</code> dans la ligne&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">empty?</span>
</pre></div>
</div>


<p>Ce code applique la méthode <code>empty?</code>, déjà abordée dans le contexte des chaines de caractères (p.e. à la <a class="ref" href="http://ruby.railstutorial.org/chapters/rails-flavored-ruby#sec:objects_and_message_passing">section&nbsp;4.2.3</a>), cette fois à une table&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">].</span><span class="n">empty?</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="o">[].</span><span class="n">empty?</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p>En utilisant la clause conditionnelle <code>unless</code>…</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">unless</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">empty?</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>… nous nous assurons qu'une table HTML vide ne sera pas affichée quand l'utilisateur ne possède aucun micro-message.</p>

<p>Nous noterons aussi, de l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:user_show_microposts">extrait&nbsp;11.16</a>, que nous avons déjà anticipé la pagination des micro-messages par&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="vi">@microposts</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>Si vous comparez ce code avec la ligne analogue de la page qui présente la liste des utilisateurs, de l''<a class="ref" href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#code:will_paginate_index_view">extrait&nbsp;10.27</a>, vuos verez que précédemment nous n'avions que&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>
</pre></div>
</div>

<p>Cela fonctionnait parce que, dans le contexte du contrôleur `Users` (“Utilisateurs”), <code>will_paginate</code> <em>présume</em> l'existence d'une variable d'instance qui s'appellerait <code>@users</code> (ce qui, comme nous l'avons vu dans la <a class="ref" href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#sec:pagination">section&nbsp;10.3.3</a>, devrait être de classe <code>WillPaginate::Collection</code>). Dans le cas présent, puisque nous sommes toujours dans le contrôleur `Users` mais que nous voulons paginer plutôt les <em>micro-messages</em>, nous devons passer explicitement une variable <code>@microposts</code> à <code>will_paginate</code>. Bien entendu, cela signifie que nous allons devoir définir cette varable dans l'action <code>show</code> de l'utilisateur (<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:user_show_microposts_instance">Extrait&nbsp;11.18</a> ci-dessous).</p>

<p>Enfin, notez que nous avons pris la liberté d'ajouter un compte du nombre courant de micro-messages à la “sidebar” du profil&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">"sidebar round"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;strong&gt;</span>Name<span class="nt">&lt;/strong&gt;</span> <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span><span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;strong&gt;</span>URL<span class="nt">&lt;/strong&gt;</span> <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">),</span> <span class="vi">@user</span> <span class="cp">%&gt;</span><span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;strong&gt;</span>Microposts<span class="nt">&lt;/strong&gt;</span> <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">count</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/td&gt;</span>
</pre></div>
</div>

<p>Ici, <code>@user.microposts.count</code> est analogue à la méthode  <code>User.count</code>, mis à part le fait que ne sont comptés que les micro-messages appartenant à l'utilisateur donné par le biais de l'association utilisateur/micro-messages.<sup class="footnote" id="fnref:11.6"><a href="#fn:11.6">6</a></sup></p>

<p>Maintenant, pour la <code>table</code> micro-messages elle-même&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;table</span> <span class="na">class=</span><span class="s">"microposts"</span> <span class="na">summary=</span><span class="s">"User microposts"</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@microposts</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/table&gt;</span>
</pre></div>
</div>


<p>Ce code est responsable de la génération de la table des micro-messages, mais vous pouvez voir qu'elle ne fait que [déférer le lifting important du partiel micropost][it just defers the heavy lifting to a micropost 
partial]. Nous avons vu dans la <a class="ref" href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#sec:partial_refactoring">section&nbsp;10.3.4</a> que le code…</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@users</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>… renvoie automatiquement chacun des utilisateurs de la variable <code>@users</code> en utilisant le partiel <code>_user.html.erb</code>. De la même manière, le code…</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@microposts</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>… fait exactement la même chose pour les micro-messages. Cela signifie que nous devons définir le partiel <code>_micropost.html.erb</code> (dans le dossier <code>micropost</code> des vues —&nbsp;views), comme dans l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:micropost_partial">extrait&nbsp;11.17</a>.</p>

<div class="label" id="code:micropost_partial"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 11.17.</span> <span class="description">Un partiel pour affiche un unique micro-message. <br> <code>app/views/microposts/_micropost.html.erb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" id="clippy_14fad44a4a636ca422f6b73e1c8460ec6877d7e6" height="14" width="110">
      <param name="movie" value="/flash/clippy.swf">
      <param name="allowScriptAccess" value="always">
      <param name="quality" value="high">
      <param name="scale" value="noscale">
      <param name="FlashVars" value="text=%3Ctr%3E%0A%20%20%3Ctd%20class=%22micropost%22%3E%0A%20%20%20%20%3Cspan%20class=%22content%22%3E%3C%25=%20micropost.content%20%25%3E%3C/span%3E%0A%20%20%20%20%3Cspan%20class=%22timestamp%22%3E%0A%20%20%20%20%20%20Posted%20%3C%25=%20time_ago_in_words(micropost.created_at)%20%25%3E%20ago.%0A%20%20%20%20%3C/span%3E%0A%20%20%3C/td%3E%0A%3C/tr%3E%0A">
      <param name="bgcolor" value="#ffffff">
      <embed src="Chapter-11_fichiers/clippy.swf" name="clippy" quality="high" allowscriptaccess="always" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="text=%3Ctr%3E%0A%20%20%3Ctd%20class=%22micropost%22%3E%0A%20%20%20%20%3Cspan%20class=%22content%22%3E%3C%25=%20micropost.content%20%25%3E%3C/span%3E%0A%20%20%20%20%3Cspan%20class=%22timestamp%22%3E%0A%20%20%20%20%20%20Posted%20%3C%25=%20time_ago_in_words(micropost.created_at)%20%25%3E%20ago.%0A%20%20%20%20%3C/span%3E%0A%20%20%3C/td%3E%0A%3C/tr%3E%0A" bgcolor="#ffffff" height="14" width="110">
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;tr&gt;</span>
  <span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">"micropost"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"content"</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">micropost</span><span class="o">.</span><span class="n">content</span> <span class="cp">%&gt;</span><span class="nt">&lt;/span&gt;</span>
    <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"timestamp"</span><span class="nt">&gt;</span>
      Posted <span class="cp">&lt;%=</span> <span class="n">time_ago_in_words</span><span class="p">(</span><span class="n">micropost</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span> <span class="cp">%&gt;</span> ago.
    <span class="nt">&lt;/span&gt;</span>
  <span class="nt">&lt;/td&gt;</span>
<span class="nt">&lt;/tr&gt;</span>
</pre></div>
</div></div>


<p>Ce code utilise l'impressionnante méthode <code>time_ago_in_words</code> de <em>helper</em>, dont nous verrons l'effet dans la <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#sec:sample_microposts">section&nbsp;11.2.2</a>.</p>

<p>À ce point, malgré la définition de tous les templates Erb nécessaires, le test de l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:user_show_microposts_test">extrait&nbsp;11.15</a> devrait échouer par défaut de la variable  <code>@microposts</code>. Nous pouvons le faire réussir avec l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:user_show_microposts_instance">extrait&nbsp;11.18</a>.</p>

<div class="label" id="code:user_show_microposts_instance"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 11.18.</span> <span class="description">Ajout d'un variable d'instance <code>@microposts</code> à l'action <code>show</code> de l'utilisateur. <br> <code>app/controllers/users_controller.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" id="clippy_7b36f16208f973b7f61a22dce04fd3bb57b2c479" height="14" width="110">
      <param name="movie" value="/flash/clippy.swf">
      <param name="allowScriptAccess" value="always">
      <param name="quality" value="high">
      <param name="scale" value="noscale">
      <param name="FlashVars" value="text=class%20UsersController%20%3C%20ApplicationController%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20def%20show%0A%20%20%20%20@user%20=%20User.find(params[:id])%0A%20%20%20%20@microposts%20=%20@user.microposts.paginate(:page%20=%3E%20params[:page])%0A%20%20%20%20@title%20=%20@user.name%0A%20%20end%0Aend%0A">
      <param name="bgcolor" value="#ffffff">
      <embed src="Chapter-11_fichiers/clippy.swf" name="clippy" quality="high" allowscriptaccess="always" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="text=class%20UsersController%20%3C%20ApplicationController%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20def%20show%0A%20%20%20%20@user%20=%20User.find(params[:id])%0A%20%20%20%20@microposts%20=%20@user.microposts.paginate(:page%20=%3E%20params[:page])%0A%20%20%20%20@title%20=%20@user.name%0A%20%20end%0Aend%0A" bgcolor="#ffffff" height="14" width="110">
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">show</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
    <span class="vi">@microposts</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">:page</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">)</span>
    <span class="vi">@title</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Notez ici l'intelligence de <code>paginate</code> —&nbsp;il fonctionne même avec l'association des micro-messages, en convertissant à la volée la liste (array) en objet de classe <code>WillPaginate::Collection</code>.</p>

<p>En ajoutant en plus le code CSS de l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:micropost_css">extrait&nbsp;11.19</a> à notre feuille de styles <code>custom.css</code>,<sup class="footnote" id="fnref:11.7"><a href="#fn:11.7">7</a></sup> nous pouvons jeter un œil à notre nouvelle page de profil utilisateur de l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#fig:user_profile_no_microposts">illustration&nbsp;11.5</a>. C'est plutôt…  décevant. Bien sûr, c'est parce qu'il n'y a pour le moment aucun micro-message. Il est temps de changer ça.</p>

<div class="label" id="code:micropost_css"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 11.19.</span> <span class="description">Code CSS pour les micro-messages (inclue tous les styles  CSS de ce chapitre). <br> <code>public/stylesheets/custom.css</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" id="clippy_5374fe932c23cfcca29a150235b88bd870dccec0" height="14" width="110">
      <param name="movie" value="/flash/clippy.swf">
      <param name="allowScriptAccess" value="always">
      <param name="quality" value="high">
      <param name="scale" value="noscale">
      <param name="FlashVars" value="text=.%0A.%0A.%0Ah1.micropost%20%7B%0A%20%20margin%2Dbottom:%200.3em;%0A%7D%0A%0Atable.microposts%20%7B%0A%20%20margin%2Dtop:%201em;%0A%7D%0A%0Atable.microposts%20tr%20%7B%0A%20%20height:%2070px;%0A%7D%0A%0Atable.microposts%20tr%20td.gravatar%20%7B%0A%20%20border%2Dtop:%201px%20solid%20%23ccc;%0A%20%20vertical%2Dalign:%20top;%0A%20%20width:%2050px;%0A%7D%0A%0Atable.microposts%20tr%20td.micropost%20%7B%0A%20%20border%2Dtop:%201px%20solid%20%23ccc;%0A%20%20vertical%2Dalign:%20top;%0A%20%20padding%2Dtop:%2010px;%0A%7D%0A%0Atable.microposts%20tr%20td.micropost%20span.timestamp%20%7B%0A%20%20display:%20block;%0A%20%20font%2Dsize:%2085%25;%0A%20%20color:%20%23666;%0A%7D%0A%0Adiv.user_info%20img%20%7B%0A%20%20padding%2Dright:%200.1em;%0A%7D%0A%0Adiv.user_info%20a%20%7B%0A%20%20text%2Ddecoration:%20none;%0A%7D%0A%0Adiv.user_info%20span.user_name%20%7B%0A%20%20position:%20absolute;%0A%7D%0A%0Adiv.user_info%20span.microposts%20%7B%0A%20%20font%2Dsize:%2080%25;%0A%7D%0A%0Aform.new_micropost%20%7B%0A%20%20margin%2Dbottom:%202em;%0A%7D%0A%0Aform.new_micropost%20textarea%20%7B%0A%20%20height:%204em;%0A%20%20margin%2Dbottom:%200;%0A%7D%0A">
      <param name="bgcolor" value="#ffffff">
      <embed src="Chapter-11_fichiers/clippy.swf" name="clippy" quality="high" allowscriptaccess="always" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="text=.%0A.%0A.%0Ah1.micropost%20%7B%0A%20%20margin%2Dbottom:%200.3em;%0A%7D%0A%0Atable.microposts%20%7B%0A%20%20margin%2Dtop:%201em;%0A%7D%0A%0Atable.microposts%20tr%20%7B%0A%20%20height:%2070px;%0A%7D%0A%0Atable.microposts%20tr%20td.gravatar%20%7B%0A%20%20border%2Dtop:%201px%20solid%20%23ccc;%0A%20%20vertical%2Dalign:%20top;%0A%20%20width:%2050px;%0A%7D%0A%0Atable.microposts%20tr%20td.micropost%20%7B%0A%20%20border%2Dtop:%201px%20solid%20%23ccc;%0A%20%20vertical%2Dalign:%20top;%0A%20%20padding%2Dtop:%2010px;%0A%7D%0A%0Atable.microposts%20tr%20td.micropost%20span.timestamp%20%7B%0A%20%20display:%20block;%0A%20%20font%2Dsize:%2085%25;%0A%20%20color:%20%23666;%0A%7D%0A%0Adiv.user_info%20img%20%7B%0A%20%20padding%2Dright:%200.1em;%0A%7D%0A%0Adiv.user_info%20a%20%7B%0A%20%20text%2Ddecoration:%20none;%0A%7D%0A%0Adiv.user_info%20span.user_name%20%7B%0A%20%20position:%20absolute;%0A%7D%0A%0Adiv.user_info%20span.microposts%20%7B%0A%20%20font%2Dsize:%2080%25;%0A%7D%0A%0Aform.new_micropost%20%7B%0A%20%20margin%2Dbottom:%202em;%0A%7D%0A%0Aform.new_micropost%20textarea%20%7B%0A%20%20height:%204em;%0A%20%20margin%2Dbottom:%200;%0A%7D%0A" bgcolor="#ffffff" height="14" width="110">
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="nt">h1</span><span class="nc">.micropost</span> <span class="p">{</span>
  <span class="k">margin-bottom</span><span class="o">:</span> <span class="m">0.3em</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">table</span><span class="nc">.microposts</span> <span class="p">{</span>
  <span class="k">margin-top</span><span class="o">:</span> <span class="m">1em</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">table</span><span class="nc">.microposts</span> <span class="nt">tr</span> <span class="p">{</span>
  <span class="k">height</span><span class="o">:</span> <span class="m">70px</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">table</span><span class="nc">.microposts</span> <span class="nt">tr</span> <span class="nt">td</span><span class="nc">.gravatar</span> <span class="p">{</span>
  <span class="k">border-top</span><span class="o">:</span> <span class="m">1px</span> <span class="k">solid</span> <span class="m">#ccc</span><span class="p">;</span>
  <span class="k">vertical-align</span><span class="o">:</span> <span class="k">top</span><span class="p">;</span>
  <span class="k">width</span><span class="o">:</span> <span class="m">50px</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">table</span><span class="nc">.microposts</span> <span class="nt">tr</span> <span class="nt">td</span><span class="nc">.micropost</span> <span class="p">{</span>
  <span class="k">border-top</span><span class="o">:</span> <span class="m">1px</span> <span class="k">solid</span> <span class="m">#ccc</span><span class="p">;</span>
  <span class="k">vertical-align</span><span class="o">:</span> <span class="k">top</span><span class="p">;</span>
  <span class="k">padding-top</span><span class="o">:</span> <span class="m">10px</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">table</span><span class="nc">.microposts</span> <span class="nt">tr</span> <span class="nt">td</span><span class="nc">.micropost</span> <span class="nt">span</span><span class="nc">.timestamp</span> <span class="p">{</span>
  <span class="k">display</span><span class="o">:</span> <span class="k">block</span><span class="p">;</span>
  <span class="k">font-size</span><span class="o">:</span> <span class="m">85%</span><span class="p">;</span>
  <span class="k">color</span><span class="o">:</span> <span class="m">#666</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">div</span><span class="nc">.user_info</span> <span class="nt">img</span> <span class="p">{</span>
  <span class="k">padding-right</span><span class="o">:</span> <span class="m">0.1em</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">div</span><span class="nc">.user_info</span> <span class="nt">a</span> <span class="p">{</span>
  <span class="k">text-decoration</span><span class="o">:</span> <span class="k">none</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">div</span><span class="nc">.user_info</span> <span class="nt">span</span><span class="nc">.user_name</span> <span class="p">{</span>
  <span class="k">position</span><span class="o">:</span> <span class="k">absolute</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">div</span><span class="nc">.user_info</span> <span class="nt">span</span><span class="nc">.microposts</span> <span class="p">{</span>
  <span class="k">font-size</span><span class="o">:</span> <span class="m">80%</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">form</span><span class="nc">.new_micropost</span> <span class="p">{</span>
  <span class="k">margin-bottom</span><span class="o">:</span> <span class="m">2em</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">form</span><span class="nc">.new_micropost</span> <span class="nt">textarea</span> <span class="p">{</span>
  <span class="k">height</span><span class="o">:</span> <span class="m">4em</span><span class="p">;</span>
  <span class="k">margin-bottom</span><span class="o">:</span> <span class="m">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div></div>




<div class="label" id="fig:user_profile_no_microposts"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="Chapter-11_fichiers/user_profile_no_microposts.png" alt="user_profile_no_microposts"></span></div><div class="caption"><span class="header">Illustration 11.5: </span><span class="description">La page de profil utilisateur avec le code pour les micro-messages —&nbsp;mais aucun micro-messages.&nbsp;<a href="http://railstutorial.org/images/figures/user_profile_no_microposts-full.png">(full size)</a></span></div></div>




<div class="label" id="sec:sample_microposts"></div>


<h3><a id="sec:11.2.2" href="http://ruby.railstutorial.org/chapters/user-microposts#sec:sample_microposts" class="heading"><span class="number">11.2.2</span> Exemples de micro-messages</a></h3>


<p>Avec le travail des templates pour les micro-messages d'utilisateur de la <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#sec:augmenting_the_user_show_page">section&nbsp;11.2.1</a>, le dénouement a été plutôt décevant. Nous pouvons rectifier cette triste situation en ajoutant des micro-messages fictifs par le biais du “populateur” de la <a class="ref" href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#sec:sample_users">section&nbsp;10.3.2</a>. Ajouter des micro-messages fictifs pour <em>tous</em> les utilisateurs prendrait un certain temps, donc nous ne choisirons dans un premier temps que les six premiers utilisateurs<sup class="footnote" id="fnref:11.8"><a href="#fn:11.8">8</a></sup> en faisant appel à l'option <code>:limit</code> de la méthode <code>User.all</code>&nbsp;:<sup class="footnote" id="fnref:11.9"><a href="#fn:11.9">9</a></sup></p>

<div class="code"><div class="highlight"><pre><span class="no">User</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="ss">:limit</span> <span class="o">=&gt;</span> <span class="mi">6</span><span class="p">)</span>
</pre></div>
</div>


<p>Nous créons alors 50 micro-messages pour chacun de ces utilisateurs (suffisamment pour dépasser la limite de pagination de 30), en générant un exemple de contenu pour chaque micro-message en utilisant la méthode <a href="http://faker.rubyforge.org/rdoc/classes/Faker/Lorem.html"><tt>Lorem.sentence</tt> du très pratique gem Faker</a>. (<code>Faker::Lorem.sentence</code> retourne le texte <em>lorem ipsum</em>&nbsp;; comme cela avait été noté dans le <a class="ref" href="http://ruby.railstutorial.org/chapters/modeling-and-viewing-users-one#top">chapitre&nbsp;6</a>, <em>lorem ipsum</em> possède <a href="http://www.straightdope.com/columns/read/2290/what-does-the-filler-text-lorem-ipsum-mean">une fascinante histoire</a>.) Le résultat est le nouvel exemple de populateur de données de l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:sample_microposts">extrait&nbsp;11.20</a>.</p>

<div class="label" id="code:sample_microposts"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 11.20.</span> <span class="description">Ajout de micro-messages fictifs. <br> <code>lib/tasks/sample_data.rake</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" id="clippy_0c3265a53a511dd5be5ce733a805f83b2f2fb8a3" height="14" width="110">
      <param name="movie" value="/flash/clippy.swf">
      <param name="allowScriptAccess" value="always">
      <param name="quality" value="high">
      <param name="scale" value="noscale">
      <param name="FlashVars" value="text=require%20'faker'%0A%0Anamespace%20:db%20do%0A%20%20desc%20%22Fill%20database%20with%20sample%20data%22%0A%20%20task%20:populate%20=%3E%20:environment%20do%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20%20%20User.all(:limit%20=%3E%206).each%20do%20%7Cuser%7C%0A%20%20%20%20%20%2050.times%20do%0A%20%20%20%20%20%20%20%20user.microposts.create!(:content%20=%3E%20Faker::Lorem.sentence(5))%0A%20%20%20%20%20%20end%0A%20%20%20%20end%0A%20%20end%0Aend%0A">
      <param name="bgcolor" value="#ffffff">
      <embed src="Chapter-11_fichiers/clippy.swf" name="clippy" quality="high" allowscriptaccess="always" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="text=require%20'faker'%0A%0Anamespace%20:db%20do%0A%20%20desc%20%22Fill%20database%20with%20sample%20data%22%0A%20%20task%20:populate%20=%3E%20:environment%20do%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20%20%20User.all(:limit%20=%3E%206).each%20do%20%7Cuser%7C%0A%20%20%20%20%20%2050.times%20do%0A%20%20%20%20%20%20%20%20user.microposts.create!(:content%20=%3E%20Faker::Lorem.sentence(5))%0A%20%20%20%20%20%20end%0A%20%20%20%20end%0A%20%20end%0Aend%0A" bgcolor="#ffffff" height="14" width="110">
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'faker'</span>

<span class="n">namespace</span> <span class="ss">:db</span> <span class="k">do</span>
  <span class="n">desc</span> <span class="s2">"Remplissage de la base de données avec des messages fictifs"</span>
  <span class="n">task</span> <span class="ss">:populate</span> <span class="o">=&gt;</span> <span class="ss">:environment</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="no">User</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="ss">:limit</span> <span class="o">=&gt;</span> <span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
      <span class="mi">50</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span>
        <span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">:content</span> <span class="o">=&gt;</span> <span class="no">Faker</span><span class="o">::</span><span class="no">Lorem</span><span class="o">.</span><span class="n">sentence</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Bien entendu, pour générer les nouvelles exemples de données, nous avons à jouer la tâche Rake <code>db:populate</code>&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rake db:populate
</pre></div>
</div>


<p>Avec ce code, nous sommes en position de tirer les fruits des durs labeurs de notre <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#sec:augmenting_the_user_show_page">section&nbsp;11.2.1</a> en affichant l'information de chaque micro-message.<sup class="footnote" id="fnref:11.10"><a href="#fn:11.10">10</a></sup> L'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#fig:user_profile_with_microposts">illustration&nbsp;11.6</a> montre la page de profil de l'utilisateur pour un premier utilisateur (identifié), tandis que l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#fig:other_profile_with_microposts">illustration&nbsp;11.7</a> montre le profil d'un second utilisateur. Pour finir, l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#fig:user_profile_microposts_page_2_rails_3">illustration&nbsp;11.8</a> montre la <em>seconde</em> page de micro-messages d'un <em>premier</em> utilisateur, accompagné des liens de pagination en bas de l'affichage. Dans les trois cas, observez que chaque micro-message indique le temps de puis sa création (p.e., “Posted
 1 minute ago.” — “posté il y a une minute”)&nbsp;; c'est le travail de la méthode <code>time_ago_in_words</code> de l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:micropost_partial">extrait&nbsp;11.17</a>. Si vous patientez une ou deux minutes puis rechargez les pages, vous verrez ce texte s'actualiser automatiquement en se fondant sur le nouveau temps.</p>

<div class="label" id="fig:user_profile_with_microposts"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="Chapter-11_fichiers/user_profile_with_microposts.png" alt="user_profile_with_microposts"></span></div><div class="caption"><span class="header">Illustration 11.6: </span><span class="description">Le profil d'utilisateur (<a href="http://localhost:3000/users/1"><tt>/users/1</tt></a>) avec des micro-messages.&nbsp;<a href="http://railstutorial.org/images/figures/user_profile_with_microposts-full.png">(taille normale)</a></span></div></div>




<div class="label" id="fig:other_profile_with_microposts"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="Chapter-11_fichiers/other_profile_with_microposts.png" alt="other_profile_with_microposts"></span></div><div class="caption"><span class="header">Illustration 11.7: </span><span class="description">Profil d'un autre utilisateur, lui aussi avec des micro-messages (<a href="http://localhost:3000/users/3"><tt>/users/3</tt></a>).&nbsp;<a href="http://railstutorial.org/images/figures/other_profile_with_microposts-full.png">(taille normale)</a></span></div></div>




<div class="label" id="fig:user_profile_microposts_page_2_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="Chapter-11_fichiers/user_profile_microposts_page_2_rails_3.png" alt="user_profile_microposts_page_2_rails_3"></span></div><div class="caption"><span class="header">Illustration 11.8: </span><span class="description">Une seconde page de micro-messages, avec les liens de pagination (<a href="http://localhost:3000/users/1?page=2"><tt>/users/1?page=2</tt></a>).&nbsp;<a href="http://railstutorial.org/images/figures/user_profile_microposts_page_2_rails_3-full.png">(taille normale)</a></span></div></div>




<div class="label" id="sec:manipulating_microposts"></div>


<h2><a id="sec:11.3" href="http://ruby.railstutorial.org/chapters/user-microposts#sec:manipulating_microposts" class="heading"><span class="number">11.3</span> Manipuler les micro-messages</a></h2>


<p>Ayant fini et la modélistaion des données et l'affichage des micro-messages par templates, nous tournons maintenant notre attention vers l'interface qui va permettre de créer ces messages par le biais du web. Le résultat sera notre troisième exemple d'utilisation d'un formulataire HTML pour créer une ressource —&nbsp;dans ce cas, une ressource  Microposts.<sup class="footnote" id="fnref:11.11"><a href="#fn:11.11">11</a></sup> Dans cette section, nous verrons aussi [la première astuce d'un <em>statut d'alimentation</em>][the first hint of a <em>status feed</em>] —&nbsp;une notion portée à sa pleine réalisation dans le <a class="ref" href="http://ruby.railstutorial.org/chapters/following-users#top">chapitre&nbsp;12</a>. Finalement, comme avec les utilisateurs, nous rendrons possible la destruction des messages au travers du web.</p>

<p>Il y a une cassure avec les conventions passées qu'il convient de noter&nbsp;: l'interface de la ressource Micropost tournera principalement à travers les contrôleurs `Users` et `Pages` plutôt que par un contrôleur qui lui serait dédié. Cela signifie que la “route” à la ressource `Microposts` est inhabituellement simple,  comme le montre l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:microposts_resource">extrait&nbsp;11.21</a>. Le code de l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:microposts_resource">extrait&nbsp;11.21</a> conduit à son tour aux routes pleinement conformes aux conventions REST montrées dans la <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#table:RESTful_microposts">table&nbsp;11.2</a>, qui est un petit sous-ensemble de l'ensemble complet des routes de la <a class="ref" href="http://ruby.railstutorial.org/chapters/a-demo-app#table:demo_RESTful_microposts">table&nbsp;2.3</a>. Bien sûr, cette simplicité est [le signe que la technique est <em>plus</em> avancée, pas <em>moins</em>][a sign of being <em>more</em> advanced, not less] —&nbsp;nous revenons de loin depuis notre premier recours à l'échaffaudage du <a class="ref" href="http://ruby.railstutorial.org/chapters/a-demo-app#top">chapitre&nbsp;2</a>, et nous n'avons plus besoin d'autant de complexité.</p>

<div class="label" id="code:microposts_resource"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 11.21.</span> <span class="description">Routes pour la ressource Microposts. <br> <code>config/routes.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" id="clippy_cbf4a635d70b386ef3eb57285e14d54678887809" height="14" width="110">
      <param name="movie" value="/flash/clippy.swf">
      <param name="allowScriptAccess" value="always">
      <param name="quality" value="high">
      <param name="scale" value="noscale">
      <param name="FlashVars" value="text=SampleApp::Application.routes.draw%20do%0A%20%20resources%20:users%0A%20%20resources%20:sessions,%20%20%20:only%20=%3E%20[:new,%20:create,%20:destroy]%0A%20%20resources%20:microposts,%20:only%20=%3E%20[:create,%20:destroy]%0A%20%20.%0A%20%20.%0A%20%20.%0Aend%0A">
      <param name="bgcolor" value="#ffffff">
      <embed src="Chapter-11_fichiers/clippy.swf" name="clippy" quality="high" allowscriptaccess="always" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="text=SampleApp::Application.routes.draw%20do%0A%20%20resources%20:users%0A%20%20resources%20:sessions,%20%20%20:only%20=%3E%20[:new,%20:create,%20:destroy]%0A%20%20resources%20:microposts,%20:only%20=%3E%20[:create,%20:destroy]%0A%20%20.%0A%20%20.%0A%20%20.%0Aend%0A" bgcolor="#ffffff" height="14" width="110">
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="no">SampleApp</span><span class="o">::</span><span class="no">Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">resources</span> <span class="ss">:users</span>
  <span class="n">resources</span> <span class="ss">:sessions</span><span class="p">,</span>   <span class="ss">:only</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:new</span><span class="p">,</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
  <span class="n">resources</span> <span class="ss">:microposts</span><span class="p">,</span> <span class="ss">:only</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="table:RESTful_microposts"></div>


<div class="table"><div class="center"><table class="tabular"><tbody><tr><th class="align_left"><strong>HTTP request</strong></th><th class="align_left"><strong>URL</strong></th><th class="align_left"><strong>Action</strong></th><th class="align_left"><strong>Purpose</strong></th></tr><tr class="top_bar"><td class="align_left"><tt>POST</tt></td><td class="align_left"><tt>/microposts</tt></td><td class="align_left"><code>create</code></td><td class="align_left">create a new micropost</td></tr><tr><td class="align_left"><tt>DELETE</tt></td><td class="align_left"><tt>/microposts/1</tt></td><td class="align_left"><code>destroy</code></td><td class="align_left">delete micropost with id <code>1</code></td></tr></tbody></table></div><div class="caption"><span class="header">Table 11.2: </span><span class="description">Routes REST produite par la ressources Microposts dans l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:microposts_resource">Extrait&nbsp;11.21</a>.</span></div></div>




<div class="label" id="sec:access_control"></div>


<h3><a id="sec:11.3.1" href="http://ruby.railstutorial.org/chapters/user-microposts#sec:access_control" class="heading"><span class="number">11.3.1</span> Contrôle d'accès</a></h3>


<p>Nous commençons notre développement de la ressource Microposts avec quelque contrôle d'accès dans le contrôleur Micropost. L'idée est simple&nbsp;: les deux actions <code>create</code> et <code>destroy</code> requièrent que l'utilisateur soit identifié. Le code RSpec pour tester cela apparait dans l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:micropost_access_control">extrait&nbsp;11.22</a>,
ce qui requiert la création du fichier spec du contrôleur Microposts (nous testerons et ajouterons un troisième protection —&nbsp;que seul l'utilisateur puisse détruire ses propres messages&nbsp;— dans la <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#sec:destroying_microposts">section&nbsp;11.3.4</a>.)</p>

<div class="label" id="code:micropost_access_control"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 11.22.</span> <span class="description">Tests d'accès de contrôle pour le contrôleur Microposts. <br> <code>spec/controllers/microposts_controller_spec.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" id="clippy_7c88036faf7e1b97c8a4211a150b8aa5497213c7" height="14" width="110">
      <param name="movie" value="/flash/clippy.swf">
      <param name="allowScriptAccess" value="always">
      <param name="quality" value="high">
      <param name="scale" value="noscale">
      <param name="FlashVars" value="text=require%20'spec_helper'%0A%0Adescribe%20MicropostsController%20do%0A%20%20render_views%0A%20%20%0A%20%20describe%20%22access%20control%22%20do%0A%0A%20%20%20%20it%20%22should%20deny%20access%20to%20'create'%22%20do%0A%20%20%20%20%20%20post%20:create%0A%20%20%20%20%20%20response.should%20redirect_to(signin_path)%0A%20%20%20%20end%0A%0A%20%20%20%20it%20%22should%20deny%20access%20to%20'destroy'%22%20do%0A%20%20%20%20%20%20delete%20:destroy,%20:id%20=%3E%201%0A%20%20%20%20%20%20response.should%20redirect_to(signin_path)%0A%20%20%20%20end%0A%20%20end%0Aend%0A">
      <param name="bgcolor" value="#ffffff">
      <embed src="Chapter-11_fichiers/clippy.swf" name="clippy" quality="high" allowscriptaccess="always" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="text=require%20'spec_helper'%0A%0Adescribe%20MicropostsController%20do%0A%20%20render_views%0A%20%20%0A%20%20describe%20%22access%20control%22%20do%0A%0A%20%20%20%20it%20%22should%20deny%20access%20to%20'create'%22%20do%0A%20%20%20%20%20%20post%20:create%0A%20%20%20%20%20%20response.should%20redirect_to(signin_path)%0A%20%20%20%20end%0A%0A%20%20%20%20it%20%22should%20deny%20access%20to%20'destroy'%22%20do%0A%20%20%20%20%20%20delete%20:destroy,%20:id%20=%3E%201%0A%20%20%20%20%20%20response.should%20redirect_to(signin_path)%0A%20%20%20%20end%0A%20%20end%0Aend%0A" bgcolor="#ffffff" height="14" width="110">
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">MicropostsController</span> <span class="k">do</span>
  <span class="n">render_views</span>

  <span class="n">describe</span> <span class="s2">"contrôle d'accès"</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">"devrait refuser l'accès pour  'create'"</span> <span class="k">do</span>
      <span class="n">post</span> <span class="ss">:create</span>
      <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">signin_path</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">"devrait refuser l'accès pour  'destroy'"</span> <span class="k">do</span>
      <span class="n">delete</span> <span class="ss">:destroy</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="mi">1</span>
      <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">signin_path</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>L'écriture du code de l'application nécessaire à la réussite des test de l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:micropost_access_control">extrait&nbsp;11.22</a> requiert d'abord un peu de restructuration. Rappelez-vous comment, dans la <a class="ref" href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#sec:requiring_signed_in_users">section&nbsp;10.2.1</a>, nous avons forcé l'identification requise en utilisant un filtre “passe-avant” qui s'appelait l méthode <code>authenticate</code> (<a class="ref" href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#code:authenticate_before_filter">Extrait&nbsp;10.11</a>). À ce moment-là, nous n'avions besoin que de la méthode <code>authenticate</code> dans le contrôleur `Users`, mais maintenant nous trouvons que nous en avons besoin aussi dans le contrôleur Microposts, donc nous allons déplacer la méthode <code>authenticate</code> dans l'<em>helper</em> Sessions, comme le montre l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:sessions_helper_authenticate">extrait&nbsp;11.23</a>.<sup class="footnote" id="fnref:11.12"><a href="#fn:11.12">12</a></sup></p>

<div class="label" id="code:sessions_helper_authenticate"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 11.23.</span> <span class="description">Déplacement de la méthode <code>authenticate</code> dans l'<em>helper</em> de session. <br> <code>app/helpers/sessions_helper.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" id="clippy_b3241e9f4b6a5b3b0d14dd4b0e7b1a30f3d4588e" height="14" width="110">
      <param name="movie" value="/flash/clippy.swf">
      <param name="allowScriptAccess" value="always">
      <param name="quality" value="high">
      <param name="scale" value="noscale">
      <param name="FlashVars" value="text=module%20SessionsHelper%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20def%20authenticate%0A%20%20%20%20deny_access%20unless%20signed_in?%0A%20%20end%0A%0A%20%20def%20deny_access%0A%20%20%20%20store_location%0A%20%20%20%20redirect_to%20signin_path,%20:notice%20=%3E%20%22Please%20sign%20in%20to%20access%20this%20page.%22%0A%20%20end%0A%20%20.%0A%20%20.%0A%20%20.%0Aend%0A">
      <param name="bgcolor" value="#ffffff">
      <embed src="Chapter-11_fichiers/clippy.swf" name="clippy" quality="high" allowscriptaccess="always" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="text=module%20SessionsHelper%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20def%20authenticate%0A%20%20%20%20deny_access%20unless%20signed_in?%0A%20%20end%0A%0A%20%20def%20deny_access%0A%20%20%20%20store_location%0A%20%20%20%20redirect_to%20signin_path,%20:notice%20=%3E%20%22Please%20sign%20in%20to%20access%20this%20page.%22%0A%20%20end%0A%20%20.%0A%20%20.%0A%20%20.%0Aend%0A" bgcolor="#ffffff" height="14" width="110">
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">authenticate</span>
    <span class="n">deny_access</span> <span class="k">unless</span> <span class="n">signed_in?</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">deny_access</span>
    <span class="n">store_location</span>
    <span class="n">redirect_to</span> <span class="n">signin_path</span><span class="p">,</span> <span class="ss">:notice</span> <span class="o">=&gt;</span> <span class="s2">"Merci de vous identifier pour rejoindre cette page."</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>(pour éviter la répétition de code, nous devons également supprimer la méthode <code>authenticate</code> du contrôler `Users`.)</p>

<p>Avec le code de l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:sessions_helper_authenticate">extrait&nbsp;11.23</a>, la méthode <code>authenticate</code> est maintenant accessible depuis le contrôleur `Microposts`, ce qui signifie que nous pouvons restreindre l'accès aux actions <code>create</code> et <code>destroy</code> avec le filtre “passe-avant” de l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:microposts_controller_access_control">extrait&nbsp;11.24</a>. (puisque nous n'avons pas généré ce contrôleur en ligne de commande —&nbsp;<code>$ rails generate controler etc.&nbsp;—, vous devrez créer son fichier à la main.)</p>

<div class="label" id="code:microposts_controller_access_control"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 11.24.</span> <span class="description">Ajout de l'authentification aux actions du contrôleur `Microposts`. <br> <code>app/controllers/microposts_controller.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" id="clippy_5824c7455744f89ca783267fe7f471333812bd0c" height="14" width="110">
      <param name="movie" value="/flash/clippy.swf">
      <param name="allowScriptAccess" value="always">
      <param name="quality" value="high">
      <param name="scale" value="noscale">
      <param name="FlashVars" value="text=class%20MicropostsController%20%3C%20ApplicationController%0A%20%20before_filter%20:authenticate%0A%20%20%0A%20%20def%20create%0A%20%20end%0A%0A%20%20def%20destroy%0A%20%20end%0Aend%0A">
      <param name="bgcolor" value="#ffffff">
      <embed src="Chapter-11_fichiers/clippy.swf" name="clippy" quality="high" allowscriptaccess="always" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="text=class%20MicropostsController%20%3C%20ApplicationController%0A%20%20before_filter%20:authenticate%0A%20%20%0A%20%20def%20create%0A%20%20end%0A%0A%20%20def%20destroy%0A%20%20end%0Aend%0A" bgcolor="#ffffff" height="14" width="110">
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MicropostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:authenticate</span>

  <span class="k">def</span> <span class="nf">create</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Notez que n'avons pas restreint l'application du fichier “passe-avant” aux actions, puisque pour le moment il s'applique aux deux seules actions. Si nous étions amenés à ajouter, disons, une action <code>index</code> accessible même aux utilisateurs non identifiés, nous devrions spécifier les actions protégées de façon explicite&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MicropostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:authenticate</span><span class="p">,</span> <span class="ss">:only</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>

  <span class="k">def</span> <span class="nf">create</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>




<div class="label" id="sec:creating_microposts"></div>


<h3><a id="sec:11.3.2" href="http://ruby.railstutorial.org/chapters/user-microposts#sec:creating_microposts" class="heading"><span class="number">11.3.2</span> Création des micro-messages</a></h3>


<p>Au <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-up#top">chapitre&nbsp;8</a>, nous avons implémenté l'inscription des utilisateurs en créant un formulaire HTML qui générait une requête HTTP <tt>POST</tt> pour l'action <code>create</code> dans le contrôleur `Users`. L'implémentation de la création d'un micro-message est similaire&nbsp;; la différence principe réside dans le fait que plutôt que d'utiliser une page séparée pour <tt>/microposts/new</tt>, à l'instar des conventions Twitter, nous construirons ce formulaire dans la page d'accueil elle-même (c'est-à-dire le chemin d'accès à la racine —&nbsp;root path&nbsp;<tt>/</tt>), comme le montre la maquette de l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#fig:home_page_with_micropost_form_mockup">illutration&nbsp;11.9</a>.</p>

<div class="label" id="fig:home_page_with_micropost_form_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="Chapter-11_fichiers/home_page_with_micropost_form_mockup.png" alt="home_page_with_micropost_form_mockup"></span></div><div class="caption"><span class="header">Illustration 11.9: </span><span class="description">Maquette de la page d'accueil avec un formulaire pour créer des micro-messages.&nbsp;<a href="http://railstutorial.org/images/figures/home_page_with_micropost_form_mockup-full.png">(full size)</a></span></div></div>


<p>Dans la page d'accueil telle que nous l'avons laissée, elle apparaissait comme dans l'<a class="ref" href="http://ruby.railstutorial.org/chapters/filling-in-the-layout#fig:layout_rounded_corners">illustration&nbsp;5.7</a> —&nbsp;c'est-à-dire qu'elle avait un gros bouton “S'inscrire maintenant&nbsp;!” en son centre. Puisque la création d'un micro-message n'a de sens que dans le contexte d'un utilisateur identifié particulier, un des buts de cete section sera de produire différentes version de la page d'accueil en fonction du statut d'identifictaion de l'utilisateur. Nous implémenterons cela dans l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:microposts_home_page">extrait&nbsp;11.27</a> ci-dessous, mais pour le moment, le seul impératif est que les testes pour l'action <code>create</code> du contrôleur  `Microposts` devrait identifier un utilisateur (d'usine) avant d'essayer de créer un message.</p>

<p>Avec cette avertissement à l'esprit, les tests de création des micro-messages ressemblent à ceux de la création de l'utilisateur de l'<a class="ref" href="http://ruby.railstutorial.org/chapters/sign-up#code:failing_create_specs">extrait&nbsp;8.6</a> et l'<a class="ref" href="http://ruby.railstutorial.org/chapters/sign-up#code:signup_success_tests">extrait&nbsp;8.14</a>&nbsp;; le résultat apparait dans l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:microposts_create_tests">extrait&nbsp;11.25</a>.</p>

<div class="label" id="code:microposts_create_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 11.25.</span> <span class="description">Tests de l'action <code>create</code> du contrôleur  `Microposts`. <br> <code>spec/controllers/microposts_controller_spec.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" id="clippy_0d01a9b36640a3d106b5d0487d75cfb8a26d084d" height="14" width="110">
      <param name="movie" value="/flash/clippy.swf">
      <param name="allowScriptAccess" value="always">
      <param name="quality" value="high">
      <param name="scale" value="noscale">
      <param name="FlashVars" value="text=require%20'spec_helper'%0A%0Adescribe%20MicropostsController%20do%0A%20%20.%0A%20%20.%0A%20%20.%20%0A%20%20describe%20%22POST%20'create'%22%20do%0A%20%20%20%20%0A%20%20%20%20before(:each)%20do%0A%20%20%20%20%20%20@user%20=%20test_sign_in(Factory(:user))%0A%20%20%20%20end%0A%20%20%0A%20%20%20%20describe%20%22failure%22%20do%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20before(:each)%20do%0A%20%20%20%20%20%20%20%20@attr%20=%20%7B%20:content%20=%3E%20%22%22%20%7D%0A%20%20%20%20%20%20end%0A%0A%20%20%20%20%20%20it%20%22should%20not%20create%20a%20micropost%22%20do%0A%20%20%20%20%20%20%20%20lambda%20do%0A%20%20%20%20%20%20%20%20%20%20post%20:create,%20:micropost%20=%3E%20@attr%0A%20%20%20%20%20%20%20%20end.should_not%20change(Micropost,%20:count)%0A%20%20%20%20%20%20end%0A%0A%20%20%20%20%20%20it%20%22should%20render%20the%20home%20page%22%20do%0A%20%20%20%20%20%20%20%20post%20:create,%20:micropost%20=%3E%20@attr%0A%20%20%20%20%20%20%20%20response.should%20render_template('pages/home')%0A%20%20%20%20%20%20end%0A%20%20%20%20end%0A%20%20%0A%20%20%20%20describe%20%22success%22%20do%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20before(:each)%20do%0A%20%20%20%20%20%20%20%20@attr%20=%20%7B%20:content%20=%3E%20%22Lorem%20ipsum%22%20%7D%0A%20%20%20%20%20%20end%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20it%20%22should%20create%20a%20micropost%22%20do%0A%20%20%20%20%20%20%20%20lambda%20do%0A%20%20%20%20%20%20%20%20%20%20post%20:create,%20:micropost%20=%3E%20@attr%0A%20%20%20%20%20%20%20%20end.should%20change(Micropost,%20:count).by(1)%0A%20%20%20%20%20%20end%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20it%20%22should%20redirect%20to%20the%20home%20page%22%20do%0A%20%20%20%20%20%20%20%20post%20:create,%20:micropost%20=%3E%20@attr%0A%20%20%20%20%20%20%20%20response.should%20redirect_to(root_path)%0A%20%20%20%20%20%20end%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20it%20%22should%20have%20a%20flash%20message%22%20do%0A%20%20%20%20%20%20%20%20post%20:create,%20:micropost%20=%3E%20@attr%0A%20%20%20%20%20%20%20%20flash[:success].should%20=~%20/micropost%20created/i%0A%20%20%20%20%20%20end%0A%20%20%20%20end%0A%20%20end%0Aend%0A">
      <param name="bgcolor" value="#ffffff">
      <embed src="Chapter-11_fichiers/clippy.swf" name="clippy" quality="high" allowscriptaccess="always" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="text=require%20'spec_helper'%0A%0Adescribe%20MicropostsController%20do%0A%20%20.%0A%20%20.%0A%20%20.%20%0A%20%20describe%20%22POST%20'create'%22%20do%0A%20%20%20%20%0A%20%20%20%20before(:each)%20do%0A%20%20%20%20%20%20@user%20=%20test_sign_in(Factory(:user))%0A%20%20%20%20end%0A%20%20%0A%20%20%20%20describe%20%22failure%22%20do%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20before(:each)%20do%0A%20%20%20%20%20%20%20%20@attr%20=%20%7B%20:content%20=%3E%20%22%22%20%7D%0A%20%20%20%20%20%20end%0A%0A%20%20%20%20%20%20it%20%22should%20not%20create%20a%20micropost%22%20do%0A%20%20%20%20%20%20%20%20lambda%20do%0A%20%20%20%20%20%20%20%20%20%20post%20:create,%20:micropost%20=%3E%20@attr%0A%20%20%20%20%20%20%20%20end.should_not%20change(Micropost,%20:count)%0A%20%20%20%20%20%20end%0A%0A%20%20%20%20%20%20it%20%22should%20render%20the%20home%20page%22%20do%0A%20%20%20%20%20%20%20%20post%20:create,%20:micropost%20=%3E%20@attr%0A%20%20%20%20%20%20%20%20response.should%20render_template('pages/home')%0A%20%20%20%20%20%20end%0A%20%20%20%20end%0A%20%20%0A%20%20%20%20describe%20%22success%22%20do%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20before(:each)%20do%0A%20%20%20%20%20%20%20%20@attr%20=%20%7B%20:content%20=%3E%20%22Lorem%20ipsum%22%20%7D%0A%20%20%20%20%20%20end%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20it%20%22should%20create%20a%20micropost%22%20do%0A%20%20%20%20%20%20%20%20lambda%20do%0A%20%20%20%20%20%20%20%20%20%20post%20:create,%20:micropost%20=%3E%20@attr%0A%20%20%20%20%20%20%20%20end.should%20change(Micropost,%20:count).by(1)%0A%20%20%20%20%20%20end%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20it%20%22should%20redirect%20to%20the%20home%20page%22%20do%0A%20%20%20%20%20%20%20%20post%20:create,%20:micropost%20=%3E%20@attr%0A%20%20%20%20%20%20%20%20response.should%20redirect_to(root_path)%0A%20%20%20%20%20%20end%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20it%20%22should%20have%20a%20flash%20message%22%20do%0A%20%20%20%20%20%20%20%20post%20:create,%20:micropost%20=%3E%20@attr%0A%20%20%20%20%20%20%20%20flash[:success].should%20=~%20/micropost%20created/i%0A%20%20%20%20%20%20end%0A%20%20%20%20end%0A%20%20end%0Aend%0A" bgcolor="#ffffff" height="14" width="110">
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">MicropostsController</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span> 
  <span class="n">describe</span> <span class="s2">"POST 'create'"</span> <span class="k">do</span>

    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="n">test_sign_in</span><span class="p">(</span><span class="no">Factory</span><span class="p">(</span><span class="ss">:user</span><span class="p">))</span>
    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">"échec"</span> <span class="k">do</span>

      <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
        <span class="vi">@attr</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="s2">""</span> <span class="p">}</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">"ne devrait pas créer de micro-message"</span> <span class="k">do</span>
        <span class="nb">lambda</span> <span class="k">do</span>
          <span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:micropost</span> <span class="o">=&gt;</span> <span class="vi">@attr</span>
        <span class="k">end</span><span class="o">.</span><span class="n">should_not</span> <span class="n">change</span><span class="p">(</span><span class="no">Micropost</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">"devrait retourner la page d'accueil"</span> <span class="k">do</span>
        <span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:micropost</span> <span class="o">=&gt;</span> <span class="vi">@attr</span>
        <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">'pages/home'</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">"succès"</span> <span class="k">do</span>

      <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
        <span class="vi">@attr</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="s2">"Lorem ipsum"</span> <span class="p">}</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">"devrait créer un micro-message"</span> <span class="k">do</span>
        <span class="nb">lambda</span> <span class="k">do</span>
          <span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:micropost</span> <span class="o">=&gt;</span> <span class="vi">@attr</span>
        <span class="k">end</span><span class="o">.</span><span class="n">should</span> <span class="n">change</span><span class="p">(</span><span class="no">Micropost</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">"devrait rediriger vers la page d'accueil"</span> <span class="k">do</span>
        <span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:micropost</span> <span class="o">=&gt;</span> <span class="vi">@attr</span>
        <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">root_path</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">"devrait avoir un message flash"</span> <span class="k">do</span>
        <span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:micropost</span> <span class="o">=&gt;</span> <span class="vi">@attr</span>
        <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">].</span><span class="n">should</span> <span class="o">=~</span> <span class="sr">/micropost created/i</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>L'action <code>create</code> des micro-messages est similaire à celles des utilisateurs (<a class="ref" href="http://ruby.railstutorial.org/chapters/sign-up#code:user_create_action">Extrait&nbsp;8.15</a>)&nbsp;; la principale différence réside dans l'utilisation de l'association utilisateur/micro-message pour construire (<code>build</code>) le nouveau micro-message, comme le montre l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:microposts_create_action">extrait&nbsp;11.26</a>.</p>

<div class="label" id="code:microposts_create_action"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 11.26.</span> <span class="description">L'action <code>create</code> du contrôleur `Microposts`. <br> <code>app/controllers/microposts_controller.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" id="clippy_5c8745660d1ad89e2d224507dca739052db083d1" height="14" width="110">
      <param name="movie" value="/flash/clippy.swf">
      <param name="allowScriptAccess" value="always">
      <param name="quality" value="high">
      <param name="scale" value="noscale">
      <param name="FlashVars" value="text=class%20MicropostsController%20%3C%20ApplicationController%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20def%20create%0A%20%20%20%20@micropost%20%20=%20current_user.microposts.build(params[:micropost])%0A%20%20%20%20if%20@micropost.save%0A%20%20%20%20%20%20flash[:success]%20=%20%22Micropost%20created!%22%0A%20%20%20%20%20%20redirect_to%20root_path%0A%20%20%20%20else%0A%20%20%20%20%20%20render%20'pages/home'%0A%20%20%20%20end%0A%20%20end%0A%20%20.%0A%20%20.%0A%20%20.%0Aend%0A">
      <param name="bgcolor" value="#ffffff">
      <embed src="Chapter-11_fichiers/clippy.swf" name="clippy" quality="high" allowscriptaccess="always" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="text=class%20MicropostsController%20%3C%20ApplicationController%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20def%20create%0A%20%20%20%20@micropost%20%20=%20current_user.microposts.build(params[:micropost])%0A%20%20%20%20if%20@micropost.save%0A%20%20%20%20%20%20flash[:success]%20=%20%22Micropost%20created!%22%0A%20%20%20%20%20%20redirect_to%20root_path%0A%20%20%20%20else%0A%20%20%20%20%20%20render%20'pages/home'%0A%20%20%20%20end%0A%20%20end%0A%20%20.%0A%20%20.%0A%20%20.%0Aend%0A" bgcolor="#ffffff" height="14" width="110">
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MicropostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@micropost</span>  <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:micropost</span><span class="o">]</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">save</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Micropost created!"</span>
      <span class="n">redirect_to</span> <span class="n">root_path</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">'pages/home'</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>À ce stade, les tests de l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:microposts_create_tests">extrait&nbsp;11.25</a> devraient tous réussir, mais bien entendu nous n'avons pas encore de formulaire pour créer le micro-message. Nous pouvons arranger cela avec l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:microposts_home_page">extrait&nbsp;11.27</a>, qui produit différents code HTML en se fondant sur le fait que le visiteur du site est identifié ou non.</p>

<div class="label" id="code:microposts_home_page"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 11.27.</span> <span class="description">Ajout de la création des micro-messages à la page d'accueil (<a href="http://localhost:3000/"><tt>/</tt></a>). <br> <code>app/views/pages/home.html.erb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" id="clippy_4b5a962777c872efe0387936a20f3e1ad821201e" height="14" width="110">
      <param name="movie" value="/flash/clippy.swf">
      <param name="allowScriptAccess" value="always">
      <param name="quality" value="high">
      <param name="scale" value="noscale">
      <param name="FlashVars" value="text=%3C%25%20if%20signed_in?%20%25%3E%0A%20%20%3Ctable%20class=%22front%22%20summary=%22For%20signed%2Din%20users%22%3E%0A%20%20%20%20%3Ctr%3E%0A%20%20%20%20%20%20%3Ctd%20class=%22main%22%3E%0A%20%20%20%20%20%20%20%20%3Ch1%20class=%22micropost%22%3EWhat's%20up?%3C/h1%3E%0A%20%20%20%20%20%20%20%20%3C%25=%20render%20'shared/micropost_form'%20%25%3E%0A%20%20%20%20%20%20%3C/td%3E%0A%20%20%20%20%20%20%3Ctd%20class=%22sidebar%20round%22%3E%0A%20%20%20%20%20%20%20%20%3C%25=%20render%20'shared/user_info'%20%25%3E%0A%20%20%20%20%20%20%3C/td%3E%0A%20%20%20%20%3C/tr%3E%0A%20%20%3C/table%3E%0A%3C%25%20else%20%25%3E%0A%20%20%3Ch1%3ESample%20App%3C/h1%3E%0A%0A%20%20%3Cp%3E%0A%20%20%20%20This%20is%20the%20home%20page%20for%20the%0A%20%20%20%20%3Ca%20href=%22http://railstutorial.org/%22%3ERuby%20on%20Rails%20Tutorial%3C/a%3E%0A%20%20%20%20sample%20application.%0A%20%20%3C/p%3E%0A%0A%20%20%3C%25=%20link_to%20%22Sign%20up%20now!%22,%20signup_path,%20:class%20=%3E%20%22signup_button%20round%22%20%25%3E%0A%3C%25%20end%20%25%3E%0A">
      <param name="bgcolor" value="#ffffff">
      <embed src="Chapter-11_fichiers/clippy.swf" name="clippy" quality="high" allowscriptaccess="always" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="text=%3C%25%20if%20signed_in?%20%25%3E%0A%20%20%3Ctable%20class=%22front%22%20summary=%22For%20signed%2Din%20users%22%3E%0A%20%20%20%20%3Ctr%3E%0A%20%20%20%20%20%20%3Ctd%20class=%22main%22%3E%0A%20%20%20%20%20%20%20%20%3Ch1%20class=%22micropost%22%3EWhat's%20up?%3C/h1%3E%0A%20%20%20%20%20%20%20%20%3C%25=%20render%20'shared/micropost_form'%20%25%3E%0A%20%20%20%20%20%20%3C/td%3E%0A%20%20%20%20%20%20%3Ctd%20class=%22sidebar%20round%22%3E%0A%20%20%20%20%20%20%20%20%3C%25=%20render%20'shared/user_info'%20%25%3E%0A%20%20%20%20%20%20%3C/td%3E%0A%20%20%20%20%3C/tr%3E%0A%20%20%3C/table%3E%0A%3C%25%20else%20%25%3E%0A%20%20%3Ch1%3ESample%20App%3C/h1%3E%0A%0A%20%20%3Cp%3E%0A%20%20%20%20This%20is%20the%20home%20page%20for%20the%0A%20%20%20%20%3Ca%20href=%22http://railstutorial.org/%22%3ERuby%20on%20Rails%20Tutorial%3C/a%3E%0A%20%20%20%20sample%20application.%0A%20%20%3C/p%3E%0A%0A%20%20%3C%25=%20link_to%20%22Sign%20up%20now!%22,%20signup_path,%20:class%20=%3E%20%22signup_button%20round%22%20%25%3E%0A%3C%25%20end%20%25%3E%0A" bgcolor="#ffffff" height="14" width="110">
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">signed_in?</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;table</span> <span class="na">class=</span><span class="s">"front"</span> <span class="na">summary=</span><span class="s">"For signed-in users"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;tr&gt;</span>
      <span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">"main"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;h1</span> <span class="na">class=</span><span class="s">"micropost"</span><span class="nt">&gt;</span>What's up?<span class="nt">&lt;/h1&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/micropost_form'</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/td&gt;</span>
      <span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">"sidebar round"</span><span class="nt">&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/user_info'</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;/tr&gt;</span>
  <span class="nt">&lt;/table&gt;</span>
<span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;h1&gt;</span>Sample App<span class="nt">&lt;/h1&gt;</span>

  <span class="nt">&lt;p&gt;</span>
    This is the home page for the
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"http://railstutorial.org/"</span><span class="nt">&gt;</span>Ruby on Rails Tutorial<span class="nt">&lt;/a&gt;</span>
    sample application.
  <span class="nt">&lt;/p&gt;</span>

  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"S'inscrire maintenant&nbsp;!"</span><span class="p">,</span> <span class="n">signup_path</span><span class="p">,</span> <span class="ss">:class</span> <span class="o">=&gt;</span> <span class="s2">"signup_button round"</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p>Avoir autant de code dans chaque branche de la condition <code>if</code>-<code>else</code> est un peu fouilli, et rendre cela plus propre en utilisant les partiels est laissé comme exercice (<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#sec:micropost_exercises">section&nbsp;11.5</a>). Remplir les partiels indispensables de l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:microposts_home_page">extrait&nbsp;11.27</a> n'est pas un exercice, en revanche&nbsp;; nous remplissons le partiel du formulaire du micro-message de l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:micropost_form">extrait&nbsp;11.28</a> et la nouvelle sidebar de la page d'accueil dans l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:user_info">extrait&nbsp;11.29</a>.</p>

<div class="label" id="code:micropost_form"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 11.28.</span> <span class="description">Le partiel formulaire pour créer un micro-message. <br> <code>app/views/shared/_micropost_form.html.erb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" id="clippy_1ada7fe856b7983bd8feb9bb64935db74a323ff0" height="14" width="110">
      <param name="movie" value="/flash/clippy.swf">
      <param name="allowScriptAccess" value="always">
      <param name="quality" value="high">
      <param name="scale" value="noscale">
      <param name="FlashVars" value="text=%3C%25=%20form_for%20@micropost%20do%20%7Cf%7C%20%25%3E%0A%20%20%3C%25=%20render%20'shared/error_messages',%20:object%20=%3E%20f.object%20%25%3E%0A%20%20%3Cdiv%20class=%22field%22%3E%0A%20%20%20%20%3C%25=%20f.text_area%20:content%20%25%3E%0A%20%20%3C/div%3E%0A%20%20%3Cdiv%20class=%22actions%22%3E%0A%20%20%20%20%3C%25=%20f.submit%20%22Submit%22%20%25%3E%0A%20%20%3C/div%3E%0A%3C%25%20end%20%25%3E%0A">
      <param name="bgcolor" value="#ffffff">
      <embed src="Chapter-11_fichiers/clippy.swf" name="clippy" quality="high" allowscriptaccess="always" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="text=%3C%25=%20form_for%20@micropost%20do%20%7Cf%7C%20%25%3E%0A%20%20%3C%25=%20render%20'shared/error_messages',%20:object%20=%3E%20f.object%20%25%3E%0A%20%20%3Cdiv%20class=%22field%22%3E%0A%20%20%20%20%3C%25=%20f.text_area%20:content%20%25%3E%0A%20%20%3C/div%3E%0A%20%20%3Cdiv%20class=%22actions%22%3E%0A%20%20%20%20%3C%25=%20f.submit%20%22Submit%22%20%25%3E%0A%20%20%3C/div%3E%0A%3C%25%20end%20%25%3E%0A" bgcolor="#ffffff" height="14" width="110">
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">form_for</span> <span class="vi">@micropost</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/error_messages'</span><span class="p">,</span> <span class="ss">:object</span> <span class="o">=&gt;</span> <span class="n">f</span><span class="o">.</span><span class="n">object</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"field"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_area</span> <span class="ss">:content</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"actions"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">"Submit"</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>




<div class="label" id="code:user_info"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 11.29.</span> <span class="description">Le partiel pour la sidebar d'information de l'utilisateur. <br> <code>app/views/shared/_user_info.html.erb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" id="clippy_be306a19e6fd523fef1c7418eff73dc236bec700" height="14" width="110">
      <param name="movie" value="/flash/clippy.swf">
      <param name="allowScriptAccess" value="always">
      <param name="quality" value="high">
      <param name="scale" value="noscale">
      <param name="FlashVars" value="text=%3Cdiv%20class=%22user_info%22%3E%0A%20%20%3Ca%20href=%22%3C%25=%20user_path(current_user)%20%25%3E%22%3E%0A%20%20%20%20%3C%25=%20gravatar_for%20current_user,%20:size%20=%3E%2030%20%25%3E%0A%20%20%20%20%3Cspan%20class=%22user_name%22%3E%0A%20%20%20%20%20%20%3C%25=%20current_user.name%20%25%3E%0A%20%20%20%20%3C/span%3E%0A%20%20%20%20%3Cspan%20class=%22microposts%22%3E%0A%20%20%20%20%20%20%3C%25=%20pluralize(current_user.microposts.count,%20%22micropost%22)%20%25%3E%0A%20%20%20%20%3C/span%3E%0A%20%20%3C/a%3E%0A%3C/div%3E%0A">
      <param name="bgcolor" value="#ffffff">
      <embed src="Chapter-11_fichiers/clippy.swf" name="clippy" quality="high" allowscriptaccess="always" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="text=%3Cdiv%20class=%22user_info%22%3E%0A%20%20%3Ca%20href=%22%3C%25=%20user_path(current_user)%20%25%3E%22%3E%0A%20%20%20%20%3C%25=%20gravatar_for%20current_user,%20:size%20=%3E%2030%20%25%3E%0A%20%20%20%20%3Cspan%20class=%22user_name%22%3E%0A%20%20%20%20%20%20%3C%25=%20current_user.name%20%25%3E%0A%20%20%20%20%3C/span%3E%0A%20%20%20%20%3Cspan%20class=%22microposts%22%3E%0A%20%20%20%20%20%20%3C%25=%20pluralize(current_user.microposts.count,%20%22micropost%22)%20%25%3E%0A%20%20%20%20%3C/span%3E%0A%20%20%3C/a%3E%0A%3C/div%3E%0A" bgcolor="#ffffff" height="14" width="110">
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"user_info"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"</span><span class="cp">&lt;%=</span> <span class="n">user_path</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="s">"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="n">current_user</span><span class="p">,</span> <span class="ss">:size</span> <span class="o">=&gt;</span> <span class="mi">30</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"user_name"</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/span&gt;</span>
    <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"microposts"</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">pluralize</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">count</span><span class="p">,</span> <span class="s2">"micropost"</span><span class="p">)</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/span&gt;</span>
  <span class="nt">&lt;/a&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div></div>


<p>Notez que, comme dans la sidebar du profil (<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:user_show_microposts">extrait&nbsp;11.16</a>), l'information sur l'utilisateur dans l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:user_info">extrait&nbsp;11.29</a> affiche le nombre total de micro-messages de l'utilisateur. Il y a une légère différence dans l'affichage, cependant&nbsp;; dans la sidebar du profil, <strong>Microposts</strong> est un label, et afficher <strong>Micro-message</strong>&nbsp;1 fait parfaitement sens. Dans le cas présent, en revanche, dire “1 micro-message” est grammaticalement incorrect, donc nous nous arrangeons pour afficher “1 micro-message” (mais “2 
micro-messages”) en utilisant la méthode “helper” <code>pluralize</code>, très pratique.</p>

<p>Le formulaire défini dans l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:micropost_form">extrait&nbsp;11.28</a> est une réplique exacte du formulaire d'inscription de l'<a class="ref" href="http://ruby.railstutorial.org/chapters/sign-up#code:new_user_form">exrait&nbsp;8.2</a>, ce qui signifie qu'il nécessite une variable d'instance  <code>@micropost</code>. C'est accompli dans l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:micropost_instance_variable">extrait&nbsp;11.30</a> —&nbsp;mais seulement quand l'utilisateur est identifié.</p>

<div class="label" id="code:micropost_instance_variable"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 11.30.</span> <span class="description">Ajout d'une variable d'instance `micropost` à l'action  <code>home</code>. <br> <code>app/controllers/pages_controller.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" id="clippy_ebf6effc3dbbe962f35fc84878ed3c53d9b9cb31" height="14" width="110">
      <param name="movie" value="/flash/clippy.swf">
      <param name="allowScriptAccess" value="always">
      <param name="quality" value="high">
      <param name="scale" value="noscale">
      <param name="FlashVars" value="text=class%20PagesController%20%3C%20ApplicationController%0A%0A%20%20def%20home%0A%20%20%20%20@title%20=%20%22Home%22%0A%20%20%20%20@micropost%20=%20Micropost.new%20if%20signed_in?%0A%20%20end%0A%20%20.%0A%20%20.%0A%20%20.%0Aend%0A">
      <param name="bgcolor" value="#ffffff">
      <embed src="Chapter-11_fichiers/clippy.swf" name="clippy" quality="high" allowscriptaccess="always" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="text=class%20PagesController%20%3C%20ApplicationController%0A%0A%20%20def%20home%0A%20%20%20%20@title%20=%20%22Home%22%0A%20%20%20%20@micropost%20=%20Micropost.new%20if%20signed_in?%0A%20%20end%0A%20%20.%0A%20%20.%0A%20%20.%0Aend%0A" bgcolor="#ffffff" height="14" width="110">
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">PagesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">home</span>
    <span class="vi">@title</span> <span class="o">=</span> <span class="s2">"Home"</span>
    <span class="vi">@micropost</span> <span class="o">=</span> <span class="no">Micropost</span><span class="o">.</span><span class="n">new</span> <span class="k">if</span> <span class="n">signed_in?</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Maintenant le code HTML devrait être correct, affichant le formulaire comment dans l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#fig:home_with_form">illustration&nbsp;11.10</a>, et un formulaire avec une erreur de soumission comme dans l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#fig:home_form_errors">illustration&nbsp;11.11</a>. Vous êtes invité à ce point à créer un nouveau message pour vous-même pour vérifier que tout fonctionne correctement —&nbsp;mais vous devriez peut-être attendre la <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#sec:a_proto_feed">section&nbsp;11.3.3</a>.</p>

<div class="label" id="fig:home_with_form"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="Chapter-11_fichiers/home_with_form.png" alt="home_with_form"></span></div><div class="caption"><span class="header">Illustration 11.10: </span><span class="description">La page d'accueil (<a href="http://localhost:3000/"><tt>/</tt></a>) avec un nouveau formulaire de micro-message.&nbsp;<a href="http://railstutorial.org/images/figures/home_with_form-full.png">(taille normale)</a></span></div></div>




<div class="label" id="fig:home_form_errors"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="Chapter-11_fichiers/home_form_errors.png" alt="home_form_errors"></span></div><div class="caption"><span class="header">Illustration 11.11: </span><span class="description">La page d'accueil avec des erreurs dans le formulaire.&nbsp;<a href="http://railstutorial.org/images/figures/home_form_errors-full.png">(taille normale)</a></span></div></div>


<div class="label" id="sec:a_proto_feed"></div>


<h3><a id="sec:11.3.3" href="http://ruby.railstutorial.org/chapters/user-microposts#sec:a_proto_feed" class="heading"><span class="number">11.3.3</span> Une proto-alimentation</a></h3>


<p>Le commentaire à la fin de la <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#sec:creating_microposts">section&nbsp;11.3.2</a> fait allusion à un problème&nbsp;: la page d'accueil courante n'affiche aucun micro-messages. Si vous voulez, vous pouvez vérifier que ce formulaire montré dans l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#fig:home_with_form">illustration&nbsp;11.10</a> fonctionne en soumettant une entrée valide et en se rendant ensuite sur la <a href="http://localhost:3000/users/1">page de profil</a> pour voir le message, mais cela est plutôt fastidieux. Il serait bien meilleur d'avoir une <em>alimentation</em> des micro-messages qui inclut les propres messages de l'utilisateur, comme le montre la mauette de l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#fig:proto_feed_mockup">illustration&nbsp;11.12</a>. (Dans le <a class="ref" href="http://ruby.railstutorial.org/chapters/following-users#top">chapitre&nbsp;12</a>, nous généraliserons cette alimentation pour inclure les micro-messages des utilisateurs qui sont <em>suivis</em> (“<em>followed</em>”) par l'utilisateur courant.)</p>

<div class="label" id="fig:proto_feed_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="Chapter-11_fichiers/proto_feed_mockup.png" alt="proto_feed_mockup"></span></div><div class="caption"><span class="header">Illustration 11.12: </span><span class="description">Maquette de la page d'accueil vers une proto-alimentation.&nbsp;<a href="http://railstutorial.org/images/figures/proto_feed_mockup-full.png">(taille normale)</a></span></div></div>


<p>Puisque chaque utilisateur devrait avoir une alimentation, nous sommes naturellement conduit à une méthode <code>feed</code> (“alimentation”) dans le modèle de l'utilisateur. Éventuellement, nous testerons que l'alimentation retourne bien les messages que l'utilisateur suit, mais pour le moment, nous testerons simplement que la méthode <code>feed</code> <em>inclut</em> les micro-messages de l'utilisateur courant mais <em>exclut</em> les messages d'un utilisateur différent. Nous pouvons exprimer ces exigences dans le code avec l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:feed_specs">extrait&nbsp;11.31</a>.</p>

<div class="label" id="code:feed_specs"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 11.31.</span> <span class="description">Tests pour le [](proto-)statut de l'alimentation][(proto-)status feed]. <br> <code>spec/models/user_spec.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" id="clippy_38a7f0e89ab5108f2c400c45f92eed67c6d942d4" height="14" width="110">
      <param name="movie" value="/flash/clippy.swf">
      <param name="allowScriptAccess" value="always">
      <param name="quality" value="high">
      <param name="scale" value="noscale">
      <param name="FlashVars" value="text=require%20'spec_helper'%0A%0Adescribe%20User%20do%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20describe%20%22micropost%20associations%22%20do%0A%0A%20%20%20%20before(:each)%20do%0A%20%20%20%20%20%20@user%20=%20User.create(@attr)%0A%20%20%20%20%20%20@mp1%20=%20Factory(:micropost,%20:user%20=%3E%20@user,%20:created_at%20=%3E%201.day.ago)%0A%20%20%20%20%20%20@mp2%20=%20Factory(:micropost,%20:user%20=%3E%20@user,%20:created_at%20=%3E%201.hour.ago)%0A%20%20%20%20end%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20%20%20describe%20%22status%20feed%22%20do%0A%0A%20%20%20%20%20%20it%20%22should%20have%20a%20feed%22%20do%0A%20%20%20%20%20%20%20%20@user.should%20respond_to(:feed)%0A%20%20%20%20%20%20end%0A%0A%20%20%20%20%20%20it%20%22should%20include%20the%20user's%20microposts%22%20do%0A%20%20%20%20%20%20%20%20@user.feed.include?(@mp1).should%20be_true%0A%20%20%20%20%20%20%20%20@user.feed.include?(@mp2).should%20be_true%0A%20%20%20%20%20%20end%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20it%20%22should%20not%20include%20a%20different%20user's%20microposts%22%20do%0A%20%20%20%20%20%20%20%20mp3%20=%20Factory(:micropost,%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:user%20=%3E%20Factory(:user,%20:email%20=%3E%20Factory.next(:email)))%0A%20%20%20%20%20%20%20%20@user.feed.include?(mp3).should%20be_false%0A%20%20%20%20%20%20end%0A%20%20%20%20end%0A%20%20end%0Aend%0A">
      <param name="bgcolor" value="#ffffff">
      <embed src="Chapter-11_fichiers/clippy.swf" name="clippy" quality="high" allowscriptaccess="always" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="text=require%20'spec_helper'%0A%0Adescribe%20User%20do%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20describe%20%22micropost%20associations%22%20do%0A%0A%20%20%20%20before(:each)%20do%0A%20%20%20%20%20%20@user%20=%20User.create(@attr)%0A%20%20%20%20%20%20@mp1%20=%20Factory(:micropost,%20:user%20=%3E%20@user,%20:created_at%20=%3E%201.day.ago)%0A%20%20%20%20%20%20@mp2%20=%20Factory(:micropost,%20:user%20=%3E%20@user,%20:created_at%20=%3E%201.hour.ago)%0A%20%20%20%20end%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20%20%20describe%20%22status%20feed%22%20do%0A%0A%20%20%20%20%20%20it%20%22should%20have%20a%20feed%22%20do%0A%20%20%20%20%20%20%20%20@user.should%20respond_to(:feed)%0A%20%20%20%20%20%20end%0A%0A%20%20%20%20%20%20it%20%22should%20include%20the%20user's%20microposts%22%20do%0A%20%20%20%20%20%20%20%20@user.feed.include?(@mp1).should%20be_true%0A%20%20%20%20%20%20%20%20@user.feed.include?(@mp2).should%20be_true%0A%20%20%20%20%20%20end%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20it%20%22should%20not%20include%20a%20different%20user's%20microposts%22%20do%0A%20%20%20%20%20%20%20%20mp3%20=%20Factory(:micropost,%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:user%20=%3E%20Factory(:user,%20:email%20=%3E%20Factory.next(:email)))%0A%20%20%20%20%20%20%20%20@user.feed.include?(mp3).should%20be_false%0A%20%20%20%20%20%20end%0A%20%20%20%20end%0A%20%20end%0Aend%0A" bgcolor="#ffffff" height="14" width="110">
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"micropost associations"</span> <span class="k">do</span>

    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="vi">@attr</span><span class="p">)</span>
      <span class="vi">@mp1</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">:created_at</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
      <span class="vi">@mp2</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">:created_at</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">"[statut d'alimentation][status feed]"</span> <span class="k">do</span>

      <span class="n">it</span> <span class="s2">"devrait avoir une methode `feed`"</span> <span class="k">do</span>
        <span class="vi">@user</span><span class="o">.</span><span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:feed</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">"devrait inclure les micro-messages de l'utilisateur"</span> <span class="k">do</span>
        <span class="vi">@user</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="vi">@mp1</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="n">be_true</span>
        <span class="vi">@user</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="vi">@mp2</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="n">be_true</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">"ne devrait pas inclure les micro-messages d'un autre utilisateur"</span> <span class="k">do</span>
        <span class="n">mp3</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span>
                      <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:user</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="no">Factory</span><span class="o">.</span><span class="n">next</span><span class="p">(</span><span class="ss">:email</span><span class="p">)))</span>
        <span class="vi">@user</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">mp3</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="n">be_false</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Ces test introduise la [méthode tableau <code>include?</code> (“inclure”)][array <code>include?</code> method], qui teste simplement si une liste (array) inclut l'élément donnée&nbsp;:<sup class="footnote" id="fnref:11.13"><a href="#fn:11.13">13</a></sup></p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="s2">"foo"</span><span class="p">,</span> <span class="ss">:bar</span><span class="o">]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="s2">"foo"</span><span class="p">)</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="ss">:bar</span><span class="p">)</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="s2">"baz"</span><span class="p">)</span>
<span class="go">=&gt; false</span>
</pre></div>
</div>


<p>Nous pouvons arranger une alimentation (<code>feed</code>) de micro-message appropriée en sélectionnant tous les micro-messages dont l'attribut <code>user_id</code> serait égal à l'identifiant de l'utilisateur courant, ce que nous accomplissons en utilisant la méthode <code>where</code> sur le modèle <code>Micropost</code>, comme le montre l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:proto_status_feed">extrait&nbsp;11.32</a>.<sup class="footnote" id="fnref:11.14"><a href="#fn:11.14">14</a></sup></p>

<div class="label" id="code:proto_status_feed"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 11.32.</span> <span class="description">Implémentation préliminaire pour le [statut d'alimentation du micro-message][micropost status feed]. <br> <code>app/models/user.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" id="clippy_3e982d43c2418474435590f7291f81eddf74a355" height="14" width="110">
      <param name="movie" value="/flash/clippy.swf">
      <param name="allowScriptAccess" value="always">
      <param name="quality" value="high">
      <param name="scale" value="noscale">
      <param name="FlashVars" value="text=class%20User%20%3C%20ActiveRecord::Base%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20def%20feed%0A%20%20%20%20%23%20This%20is%20preliminary.%20See%20Chapter%2012%20for%20the%20full%20implementation.%0A%20%20%20%20Micropost.where(%22user_id%20=%20?%22,%20id)%0A%20%20end%0A%20%20.%0A%20%20.%0A%20%20.%0Aend%0A">
      <param name="bgcolor" value="#ffffff">
      <embed src="Chapter-11_fichiers/clippy.swf" name="clippy" quality="high" allowscriptaccess="always" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="text=class%20User%20%3C%20ActiveRecord::Base%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20def%20feed%0A%20%20%20%20%23%20This%20is%20preliminary.%20See%20Chapter%2012%20for%20the%20full%20implementation.%0A%20%20%20%20Micropost.where(%22user_id%20=%20?%22,%20id)%0A%20%20end%0A%20%20.%0A%20%20.%0A%20%20.%0Aend%0A" bgcolor="#ffffff" height="14" width="110">
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">feed</span>
    <span class="c1"># C'est un préliminaire. Voir le chapitre 12 pour l'implémentation complète.</span>
    <span class="no">Micropost</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">"user_id = ?"</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Le point d'interrogation dans…</p>

<div class="code"><div class="highlight"><pre><span class="no">Micropost</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">"user_id = ?"</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
</pre></div>
</div>


<p>… s'assure que l'identifiant (<code>id</code>) est proprement “échappé” avant d'être inclus dans la requête SQL sous-jacente, évitant par là-même un sérieux trou de sécurité appelé <a href="http://en.wikipedia.org/wiki/SQL_injection"><em>SQL injection</em></a> (“injection SQL”). (L'attribut&nbsp;<code>id</code> ici est juste un entier, donc il n'y a aucun danger dans ce cas, mais <em>toujours</em> échapper les variables injectées dans les déclarations SQL est une habitude à cultiver)</p>

<p>Les lecteurs attentifs peuvent noter à ce point que le code dans l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:proto_status_feed">extrait&nbsp;11.32</a> revient à écrire&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">feed</span>
  <span class="n">microposts</span>
<span class="k">end</span>
</pre></div>
</div>


<p>Nous avons utilisé plutôt le code de l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:proto_status_feed">extrait&nbsp;11.32</a> plutôt parce qu'[il généralise beaucoup plus naturellement pour le statut d'alimentation complet du][it generalizes much more naturally to the full status feed needed in] <a class="ref" href="http://ruby.railstutorial.org/chapters/following-users#top">chapitre&nbsp;12</a>.</p>

<p>Pour utiliser l'alimentation dans l'application exemple, nous ajontons une variable d'instance <code>@feed_items</code> pour l'alimentation (paginée) de l'utilisateur courant, comme dans l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:feed_instance_variable">extrait&nbsp;11.33</a>, et alors ajoutons un partiel alimentation (<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:feed_partial">Extrait&nbsp;11.34</a>) à la page d'accueil (<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:home_with_feed">Extrait&nbsp;11.36</a>).</p>

<div class="label" id="code:feed_instance_variable"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 11.33.</span> <span class="description">Ajout d'un variable d'instance à l'action <code>home</code> (“accueil”). <br> <code>app/controllers/pages_controller.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" id="clippy_8d1bdabf45b53697c1faa48c0397eeebabea250c" height="14" width="110">
      <param name="movie" value="/flash/clippy.swf">
      <param name="allowScriptAccess" value="always">
      <param name="quality" value="high">
      <param name="scale" value="noscale">
      <param name="FlashVars" value="text=class%20PagesController%20%3C%20ApplicationController%0A%0A%20%20def%20home%0A%20%20%20%20@title%20=%20%22Home%22%0A%20%20%20%20if%20signed_in?%0A%20%20%20%20%20%20@micropost%20=%20Micropost.new%0A%20%20%20%20%20%20@feed_items%20=%20current_user.feed.paginate(:page%20=%3E%20params[:page])%0A%20%20%20%20end%0A%20%20end%0A%20%20.%0A%20%20.%0A%20%20.%0Aend%0A">
      <param name="bgcolor" value="#ffffff">
      <embed src="Chapter-11_fichiers/clippy.swf" name="clippy" quality="high" allowscriptaccess="always" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="text=class%20PagesController%20%3C%20ApplicationController%0A%0A%20%20def%20home%0A%20%20%20%20@title%20=%20%22Home%22%0A%20%20%20%20if%20signed_in?%0A%20%20%20%20%20%20@micropost%20=%20Micropost.new%0A%20%20%20%20%20%20@feed_items%20=%20current_user.feed.paginate(:page%20=%3E%20params[:page])%0A%20%20%20%20end%0A%20%20end%0A%20%20.%0A%20%20.%0A%20%20.%0Aend%0A" bgcolor="#ffffff" height="14" width="110">
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">PagesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">home</span>
    <span class="vi">@title</span> <span class="o">=</span> <span class="s2">"Home"</span>
    <span class="k">if</span> <span class="n">signed_in?</span>
      <span class="vi">@micropost</span> <span class="o">=</span> <span class="no">Micropost</span><span class="o">.</span><span class="n">new</span>
      <span class="vi">@feed_items</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">:page</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="code:feed_partial"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 11.34.</span> <span class="description">Le partiel du statut d'alimentation. <br> <code>app/views/shared/_feed.html.erb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" id="clippy_7017d265e070f2724fa66c6d02aa02bf93cc5b9a" height="14" width="110">
      <param name="movie" value="/flash/clippy.swf">
      <param name="allowScriptAccess" value="always">
      <param name="quality" value="high">
      <param name="scale" value="noscale">
      <param name="FlashVars" value="text=%3C%25%20unless%20@feed_items.empty?%20%25%3E%0A%20%20%3Ctable%20class=%22microposts%22%20summary=%22User%20microposts%22%3E%0A%20%20%20%20%3C%25=%20render%20:partial%20=%3E%20'shared/feed_item',%20:collection%20=%3E%20@feed_items%20%25%3E%0A%20%20%3C/table%3E%0A%20%20%3C%25=%20will_paginate%20@feed_items%20%25%3E%0A%3C%25%20end%20%25%3E%0A">
      <param name="bgcolor" value="#ffffff">
      <embed src="Chapter-11_fichiers/clippy.swf" name="clippy" quality="high" allowscriptaccess="always" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="text=%3C%25%20unless%20@feed_items.empty?%20%25%3E%0A%20%20%3Ctable%20class=%22microposts%22%20summary=%22User%20microposts%22%3E%0A%20%20%20%20%3C%25=%20render%20:partial%20=%3E%20'shared/feed_item',%20:collection%20=%3E%20@feed_items%20%25%3E%0A%20%20%3C/table%3E%0A%20%20%3C%25=%20will_paginate%20@feed_items%20%25%3E%0A%3C%25%20end%20%25%3E%0A" bgcolor="#ffffff" height="14" width="110">
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">unless</span> <span class="vi">@feed_items</span><span class="o">.</span><span class="n">empty?</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;table</span> <span class="na">class=</span><span class="s">"microposts"</span> <span class="na">summary=</span><span class="s">"User microposts"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="ss">:partial</span> <span class="o">=&gt;</span> <span class="s1">'shared/feed_item'</span><span class="p">,</span> <span class="ss">:collection</span> <span class="o">=&gt;</span> <span class="vi">@feed_items</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/table&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="vi">@feed_items</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p>[Le partiel du statut d'alimentation differt l'élément alimentation en rendant pour un partiel de l'élément d'alimention en utilisant le code][The status feed partial defers the feed item rendering to a feed item partial using the code]&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="ss">:partial</span> <span class="o">=&gt;</span> <span class="s1">'shared/feed_item'</span><span class="p">,</span> <span class="ss">:collection</span> <span class="o">=&gt;</span> <span class="vi">@feed_items</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>Ici nous passons un paramètre <code>:collection</code> avec les éléments d'alimentation, ce qui contraint <code>render</code> à utiliser le partiel donné (<code>’feed_item’</code> dans ce cas) pour rendre chaque élément dans la collection. (Nous avons omis le paramètre <code>:partial</code> dans les rendus précédents, en écrivant, p.e., <code>render ’shared/micropost’</code>, mais avec un paramètre <code>:collection</code> cette syntaxe ne fonctionne pas.) Le partiel de l'élément d'alimentation lui-même apparait dans l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:feed_item_partial">extrait&nbsp;11.35</a>&nbsp;; notez l'addition d'un lien de suppression au partiel de l'élément d'alimentation, suivant l'exemple de l'<a class="ref" href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#code:delete_links">extrait&nbsp;10.38</a>.</p>

<div class="label" id="code:feed_item_partial"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 11.35.</span> <span class="description">Partiel pour un simple élément d'alimentation. <br> <code>app/views/shared/_feed_item.html.erb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" id="clippy_5290ad32b6d45dab5a4e0588bbf2e106c8439574" height="14" width="110">
      <param name="movie" value="/flash/clippy.swf">
      <param name="allowScriptAccess" value="always">
      <param name="quality" value="high">
      <param name="scale" value="noscale">
      <param name="FlashVars" value="text=%3Ctr%3E%0A%20%20%3Ctd%20class=%22gravatar%22%3E%0A%20%20%20%20%3C%25=%20link_to%20gravatar_for(feed_item.user),%20feed_item.user%20%25%3E%0A%20%20%3C/td%3E%0A%20%20%3Ctd%20class=%22micropost%22%3E%0A%20%20%20%20%3Cspan%20class=%22user%22%3E%0A%20%20%20%20%20%20%3C%25=%20link_to%20feed_item.user.name,%20feed_item.user%20%25%3E%0A%20%20%20%20%3C/span%3E%0A%20%20%20%20%3Cspan%20class=%22content%22%3E%3C%25=%20feed_item.content%20%25%3E%3C/span%3E%0A%20%20%20%20%3Cspan%20class=%22timestamp%22%3E%0A%20%20%20%20%20%20Posted%20%3C%25=%20time_ago_in_words(feed_item.created_at)%20%25%3E%20ago.%0A%20%20%20%20%3C/span%3E%0A%20%20%3C/td%3E%0A%20%20%3C%25%20if%20current_user?(feed_item.user)%20%25%3E%0A%20%20%3Ctd%3E%0A%20%20%20%20%3C%25=%20link_to%20%22delete%22,%20feed_item,%20:method%20=%3E%20:delete,%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:confirm%20=%3E%20%22You%20sure?%22,%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:title%20=%3E%20feed_item.content%20%25%3E%0A%20%20%3C/td%3E%0A%20%20%3C%25%20end%20%25%3E%0A%3C/tr%3E%0A">
      <param name="bgcolor" value="#ffffff">
      <embed src="Chapter-11_fichiers/clippy.swf" name="clippy" quality="high" allowscriptaccess="always" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="text=%3Ctr%3E%0A%20%20%3Ctd%20class=%22gravatar%22%3E%0A%20%20%20%20%3C%25=%20link_to%20gravatar_for(feed_item.user),%20feed_item.user%20%25%3E%0A%20%20%3C/td%3E%0A%20%20%3Ctd%20class=%22micropost%22%3E%0A%20%20%20%20%3Cspan%20class=%22user%22%3E%0A%20%20%20%20%20%20%3C%25=%20link_to%20feed_item.user.name,%20feed_item.user%20%25%3E%0A%20%20%20%20%3C/span%3E%0A%20%20%20%20%3Cspan%20class=%22content%22%3E%3C%25=%20feed_item.content%20%25%3E%3C/span%3E%0A%20%20%20%20%3Cspan%20class=%22timestamp%22%3E%0A%20%20%20%20%20%20Posted%20%3C%25=%20time_ago_in_words(feed_item.created_at)%20%25%3E%20ago.%0A%20%20%20%20%3C/span%3E%0A%20%20%3C/td%3E%0A%20%20%3C%25%20if%20current_user?(feed_item.user)%20%25%3E%0A%20%20%3Ctd%3E%0A%20%20%20%20%3C%25=%20link_to%20%22delete%22,%20feed_item,%20:method%20=%3E%20:delete,%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:confirm%20=%3E%20%22You%20sure?%22,%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:title%20=%3E%20feed_item.content%20%25%3E%0A%20%20%3C/td%3E%0A%20%20%3C%25%20end%20%25%3E%0A%3C/tr%3E%0A" bgcolor="#ffffff" height="14" width="110">
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;tr&gt;</span>
  <span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">"gravatar"</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">gravatar_for</span><span class="p">(</span><span class="n">feed_item</span><span class="o">.</span><span class="n">user</span><span class="p">),</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">user</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/td&gt;</span>
  <span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">"micropost"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"user"</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">user</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/span&gt;</span>
    <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"content"</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">content</span> <span class="cp">%&gt;</span><span class="nt">&lt;/span&gt;</span>
    <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"timestamp"</span><span class="nt">&gt;</span>
      Posted <span class="cp">&lt;%=</span> <span class="n">time_ago_in_words</span><span class="p">(</span><span class="n">feed_item</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span> <span class="cp">%&gt;</span> ago.
    <span class="nt">&lt;/span&gt;</span>
  <span class="nt">&lt;/td&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">current_user?</span><span class="p">(</span><span class="n">feed_item</span><span class="o">.</span><span class="n">user</span><span class="p">)</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;td&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"delete"</span><span class="p">,</span> <span class="n">feed_item</span><span class="p">,</span> <span class="ss">:method</span> <span class="o">=&gt;</span> <span class="ss">:delete</span><span class="p">,</span>
                                     <span class="ss">:confirm</span> <span class="o">=&gt;</span> <span class="s2">"You sure?"</span><span class="p">,</span>
                                     <span class="ss">:title</span> <span class="o">=&gt;</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">content</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/td&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/tr&gt;</span>
</pre></div>
</div></div>


<p>Nous pouvons alors ajouter l'alimentation à la page d'accueil en rendant le partiel d'alimentation comme d'habitude (<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:home_with_feed">Extrait&nbsp;11.36</a>). Le résultat est un affichage de l'alimentation sur la page d'accueil, comme voulu (<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#fig:home_with_proto_feed">Extrait&nbsp;11.13</a>).</p>

<div class="label" id="code:home_with_feed"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 11.36.</span> <span class="description">Ajout d'un statut d'alimentation sur la page d'accueil. <br> <code>app/views/pages/home.html.erb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" id="clippy_4da5373caa0c73eaffcbc5e4d160c2f00ae5ffba" height="14" width="110">
      <param name="movie" value="/flash/clippy.swf">
      <param name="allowScriptAccess" value="always">
      <param name="quality" value="high">
      <param name="scale" value="noscale">
      <param name="FlashVars" value="text=%3C%25%20if%20signed_in?%20%25%3E%0A%20%20%3Ctable%20class=%22front%22%20summary=%22For%20signed%2Din%20users%22%3E%0A%20%20%20%20%3Ctr%3E%0A%20%20%20%20%20%20%3Ctd%20class=%22main%22%3E%0A%20%20%20%20%20%20%20%20%3Ch1%20class=%22micropost%22%3EWhat's%20up?%3C/h1%3E%0A%20%20%20%20%20%20%20%20%3C%25=%20render%20'shared/micropost_form'%20%25%3E%0A%20%20%20%20%20%20%20%20%3C%25=%20render%20'shared/feed'%20%25%3E%0A%20%20%20%20%20%20%3C/td%3E%0A%20%20%20%20%20%20.%0A%20%20%20%20%20%20.%0A%20%20%20%20%20%20.%0A%20%20%20%20%3C/tr%3E%0A%20%20%3C/table%3E%0A%20%20%0A%3C%25%20else%20%25%3E%0A%20%20.%0A%20%20.%0A%20%20.%0A%3C%25%20end%20%25%3E%0A">
      <param name="bgcolor" value="#ffffff">
      <embed src="Chapter-11_fichiers/clippy.swf" name="clippy" quality="high" allowscriptaccess="always" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="text=%3C%25%20if%20signed_in?%20%25%3E%0A%20%20%3Ctable%20class=%22front%22%20summary=%22For%20signed%2Din%20users%22%3E%0A%20%20%20%20%3Ctr%3E%0A%20%20%20%20%20%20%3Ctd%20class=%22main%22%3E%0A%20%20%20%20%20%20%20%20%3Ch1%20class=%22micropost%22%3EWhat's%20up?%3C/h1%3E%0A%20%20%20%20%20%20%20%20%3C%25=%20render%20'shared/micropost_form'%20%25%3E%0A%20%20%20%20%20%20%20%20%3C%25=%20render%20'shared/feed'%20%25%3E%0A%20%20%20%20%20%20%3C/td%3E%0A%20%20%20%20%20%20.%0A%20%20%20%20%20%20.%0A%20%20%20%20%20%20.%0A%20%20%20%20%3C/tr%3E%0A%20%20%3C/table%3E%0A%20%20%0A%3C%25%20else%20%25%3E%0A%20%20.%0A%20%20.%0A%20%20.%0A%3C%25%20end%20%25%3E%0A" bgcolor="#ffffff" height="14" width="110">
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">signed_in?</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;table</span> <span class="na">class=</span><span class="s">"front"</span> <span class="na">summary=</span><span class="s">"For signed-in users"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;tr&gt;</span>
      <span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">"main"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;h1</span> <span class="na">class=</span><span class="s">"micropost"</span><span class="nt">&gt;</span>What's up?<span class="nt">&lt;/h1&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/micropost_form'</span> <span class="cp">%&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">'shared/feed'</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/td&gt;</span>
      .
      .
      .
    <span class="nt">&lt;/tr&gt;</span>
  <span class="nt">&lt;/table&gt;</span>

<span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
  .
  .
  .
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>




<div class="label" id="fig:home_with_proto_feed"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="Chapter-11_fichiers/home_with_proto_feed.png" alt="home_with_proto_feed"></span></div><div class="caption"><span class="header">Illustration 11.13: </span><span class="description">Page d'accueil page (<a href="http://localhost:3000/"><tt>/</tt></a>) avec une proto-alimentation.&nbsp;<a href="http://railstutorial.org/images/figures/home_with_proto_feed-full.png">(taille normale)</a></span></div></div>


<p>À ce point, créer une nouveau micro-message fonctionne comme voulu, comme montré dans l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#fig:micropost_created">illustration&nbsp;11.14</a>. (Nous écrirons un test d'intégration pour cet effet à la <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#sec:testing_the_new_home_page">section&nbsp;11.3.5</a>.) Il y a une subtilité, cependant&nbsp;: à l'<em>échec</em> de la soumission du micro-message, la page d'accueil attend une variable d'instance <code>@feed_items</code>, donc les échecs de soumission actuellement [provoquent une rupture][break] (comme vous devriez pouvoir le vérifier en jouant votre suite de tests). La solution la plus simple est de supprimer entièrement l'alimentation en lui assignant une liste (array) vide, comme dans l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:microposts_create_action_with_feed">extrait&nbsp;11.37</a>.<sup class="footnote" id="fnref:11.15"><a href="#fn:11.15">15</a></sup></p>

<div class="label" id="fig:micropost_created"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="Chapter-11_fichiers/micropost_created.png" alt="micropost_created"></span></div><div class="caption"><span class="header">Illustration 11.14: </span><span class="description">Page d'accueil après la création d'un nouveau micro-message.&nbsp;<a href="http://railstutorial.org/images/figures/micropost_created-full.png">(full size)</a></span></div></div>




<div class="label" id="code:microposts_create_action_with_feed"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 11.37.</span> <span class="description">Ajout d'un variable d'instance (vide) <code>@feed_items</code> à l'action <code>create</code> (“créer”). <br> <code>app/controllers/microposts_controller.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" id="clippy_abca89b4e7c76f1aaecb86010d4958e6b7375165" height="14" width="110">
      <param name="movie" value="/flash/clippy.swf">
      <param name="allowScriptAccess" value="always">
      <param name="quality" value="high">
      <param name="scale" value="noscale">
      <param name="FlashVars" value="text=class%20MicropostsController%20%3C%20ApplicationController%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20def%20create%0A%20%20%20%20@micropost%20=%20current_user.microposts.build(params[:micropost])%0A%20%20%20%20if%20@micropost.save%0A%20%20%20%20%20%20flash[:success]%20=%20%22Micropost%20created!%22%0A%20%20%20%20%20%20redirect_to%20root_path%0A%20%20%20%20else%0A%20%20%20%20%20%20@feed_items%20=%20[]%0A%20%20%20%20%20%20render%20'pages/home'%0A%20%20%20%20end%0A%20%20end%0A%20%20.%0A%20%20.%0A%20%20.%0Aend%0A">
      <param name="bgcolor" value="#ffffff">
      <embed src="Chapter-11_fichiers/clippy.swf" name="clippy" quality="high" allowscriptaccess="always" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="text=class%20MicropostsController%20%3C%20ApplicationController%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20def%20create%0A%20%20%20%20@micropost%20=%20current_user.microposts.build(params[:micropost])%0A%20%20%20%20if%20@micropost.save%0A%20%20%20%20%20%20flash[:success]%20=%20%22Micropost%20created!%22%0A%20%20%20%20%20%20redirect_to%20root_path%0A%20%20%20%20else%0A%20%20%20%20%20%20@feed_items%20=%20[]%0A%20%20%20%20%20%20render%20'pages/home'%0A%20%20%20%20end%0A%20%20end%0A%20%20.%0A%20%20.%0A%20%20.%0Aend%0A" bgcolor="#ffffff" height="14" width="110">
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MicropostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:micropost</span><span class="o">]</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">save</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">"Micropost created!"</span>
      <span class="n">redirect_to</span> <span class="n">root_path</span>
    <span class="k">else</span>
      <span class="vi">@feed_items</span> <span class="o">=</span> <span class="o">[]</span>
      <span class="n">render</span> <span class="s1">'pages/home'</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="sec:destroying_microposts"></div>


<h3><a id="sec:11.3.4" href="http://ruby.railstutorial.org/chapters/user-microposts#sec:destroying_microposts" class="heading"><span class="number">11.3.4</span> Destruction des micro-messages</a></h3>


<p>La dernière pièce de fonctionnalité à ajouter à la ressource `Microposts` est la possibilité de détruire les messages. Comme avec la suppression des utilisateurs (<a class="ref" href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#sec:the_destroy_action">section&nbsp;10.4.2</a>), nous accomplissons cela avec un lien “supprimer”, comme le montre la maquette de l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#fig:micropost_delete_links_mockup">illustration&nbsp;11.15</a>. Contrairement à ce cas, qui restreignait la suppression d'utilisateur aux administrateurs, le lien suppression  fonctionnera seulement pour les micro-messages créés par l'utilisateur courant.</p>

<div class="label" id="fig:micropost_delete_links_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="Chapter-11_fichiers/micropost_delete_links_mockup.png" alt="micropost_delete_links_mockup"></span></div><div class="caption"><span class="header">Illustration 11.15: </span><span class="description">Maquette de la proto-alimentation avec le lien de suppression des micro-messages.&nbsp;<a href="http://railstutorial.org/images/figures/micropost_delete_links_mockup-full.png">(full size)</a></span></div></div>


<p>Notre première étape consiste à ajouter un lien de suppression au partiel de micro-message comment dans l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:feed_item_partial">extrait&nbsp;11.35</a>. Le résultat apparait dans l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:micropost_partial_with_delete">extrait&nbsp;11.38</a>.</p>

<div class="label" id="code:micropost_partial_with_delete"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 11.38.</span> <span class="description">Partiel d'affichage d'un micro-message. <br> <code>app/views/microposts/_micropost.html.erb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" id="clippy_8186193083c547ed229e4908b40df48accc5ee01" height="14" width="110">
      <param name="movie" value="/flash/clippy.swf">
      <param name="allowScriptAccess" value="always">
      <param name="quality" value="high">
      <param name="scale" value="noscale">
      <param name="FlashVars" value="text=%3Ctr%3E%0A%20%20%3Ctd%20class=%22micropost%22%3E%0A%20%20%20%20%3Cspan%20class=%22content%22%3E%3C%25=%20micropost.content%20%25%3E%3C/span%3E%0A%20%20%20%20%3Cspan%20class=%22timestamp%22%3E%0A%20%20%20%20%20%20Posted%20%3C%25=%20time_ago_in_words(micropost.created_at)%20%25%3E%20ago.%0A%20%20%20%20%3C/span%3E%0A%20%20%3C/td%3E%0A%20%20%3C%25%20if%20current_user?(micropost.user)%20%25%3E%0A%20%20%3Ctd%3E%0A%20%20%20%20%3C%25=%20link_to%20%22delete%22,%20micropost,%20:method%20=%3E%20:delete,%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:confirm%20=%3E%20%22You%20sure?%22,%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:title%20=%3E%20micropost.content%20%25%3E%0A%20%20%3C/td%3E%0A%20%20%3C%25%20end%20%25%3E%0A%3C/tr%3E%0A">
      <param name="bgcolor" value="#ffffff">
      <embed src="Chapter-11_fichiers/clippy.swf" name="clippy" quality="high" allowscriptaccess="always" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="text=%3Ctr%3E%0A%20%20%3Ctd%20class=%22micropost%22%3E%0A%20%20%20%20%3Cspan%20class=%22content%22%3E%3C%25=%20micropost.content%20%25%3E%3C/span%3E%0A%20%20%20%20%3Cspan%20class=%22timestamp%22%3E%0A%20%20%20%20%20%20Posted%20%3C%25=%20time_ago_in_words(micropost.created_at)%20%25%3E%20ago.%0A%20%20%20%20%3C/span%3E%0A%20%20%3C/td%3E%0A%20%20%3C%25%20if%20current_user?(micropost.user)%20%25%3E%0A%20%20%3Ctd%3E%0A%20%20%20%20%3C%25=%20link_to%20%22delete%22,%20micropost,%20:method%20=%3E%20:delete,%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:confirm%20=%3E%20%22You%20sure?%22,%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:title%20=%3E%20micropost.content%20%25%3E%0A%20%20%3C/td%3E%0A%20%20%3C%25%20end%20%25%3E%0A%3C/tr%3E%0A" bgcolor="#ffffff" height="14" width="110">
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;tr&gt;</span>
  <span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">"micropost"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"content"</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">micropost</span><span class="o">.</span><span class="n">content</span> <span class="cp">%&gt;</span><span class="nt">&lt;/span&gt;</span>
    <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"timestamp"</span><span class="nt">&gt;</span>
      Posted <span class="cp">&lt;%=</span> <span class="n">time_ago_in_words</span><span class="p">(</span><span class="n">micropost</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span> <span class="cp">%&gt;</span> ago.
    <span class="nt">&lt;/span&gt;</span>
  <span class="nt">&lt;/td&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">current_user?</span><span class="p">(</span><span class="n">micropost</span><span class="o">.</span><span class="n">user</span><span class="p">)</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;td&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">"delete"</span><span class="p">,</span> <span class="n">micropost</span><span class="p">,</span> <span class="ss">:method</span> <span class="o">=&gt;</span> <span class="ss">:delete</span><span class="p">,</span>
                                     <span class="ss">:confirm</span> <span class="o">=&gt;</span> <span class="s2">"You sure?"</span><span class="p">,</span>
                                     <span class="ss">:title</span> <span class="o">=&gt;</span> <span class="n">micropost</span><span class="o">.</span><span class="n">content</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/td&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/tr&gt;</span>
</pre></div>
</div></div>


<p><em>Notez&nbsp;:</em> en ce qui concerne la dernière version de Rails&nbsp;3.0, moi et quelques autres lecteurs rencontrent quelquefois un étrange bogue, où l'assocation <code>micropost.user</code> n'est pas faite proprement. Le résultat est qu'appeler <code>micropost.user</code> provoque une exception (une erreur) <code>NoMethodError</code>. Puisque ce bogue est [corrigé][fixed], pour le détourner vous pouvez remplacer la ligne…</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">current_user?</span><span class="p">(</span><span class="n">micropost</span><span class="o">.</span><span class="n">user</span><span class="p">)</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>… par la ligne&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">user</span> <span class="o">=</span> <span class="n">micropost</span><span class="o">.</span><span class="n">user</span> <span class="k">rescue</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">micropost</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">current_user?</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>Quand l'appel de <code>micropost.user</code> provoque une exception, ce code trouve l'utilisateur en se basant sur l'attribut <code>user_id</code> du micro-message.</p>

<p>Les tests pour l'action <code>destroy</code> sont simplement une généralisation des test similaires de la suppression d'utilisateurs (<a class="ref" href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#code:destroy_tests">Extrait&nbsp;10.40</a>), comme le montre l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:micropost_destroy_specs">extrait&nbsp;11.39</a>.</p>

<div class="label" id="code:micropost_destroy_specs"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 11.39.</span> <span class="description">Tests pour l'action <code>destroy</code> (“détruire”) du contrôleur `Microposts`. <br> <code>spec/controllers/microposts_controller_spec.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" id="clippy_335b45d6804116b41fe84cd646a9eee493b26e7b" height="14" width="110">
      <param name="movie" value="/flash/clippy.swf">
      <param name="allowScriptAccess" value="always">
      <param name="quality" value="high">
      <param name="scale" value="noscale">
      <param name="FlashVars" value="text=describe%20MicropostsController%20do%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20describe%20%22DELETE%20'destroy'%22%20do%0A%0A%20%20%20%20describe%20%22for%20an%20unauthorized%20user%22%20do%0A%0A%20%20%20%20%20%20before(:each)%20do%0A%20%20%20%20%20%20%20%20@user%20=%20Factory(:user)%0A%20%20%20%20%20%20%20%20wrong_user%20=%20Factory(:user,%20:email%20=%3E%20Factory.next(:email))%0A%20%20%20%20%20%20%20%20test_sign_in(wrong_user)%0A%20%20%20%20%20%20%20%20@micropost%20=%20Factory(:micropost,%20:user%20=%3E%20@user)%0A%20%20%20%20%20%20end%0A%0A%20%20%20%20%20%20it%20%22should%20deny%20access%22%20do%0A%20%20%20%20%20%20%20%20delete%20:destroy,%20:id%20=%3E%20@micropost%0A%20%20%20%20%20%20%20%20response.should%20redirect_to(root_path)%0A%20%20%20%20%20%20end%0A%20%20%20%20end%0A%0A%20%20%20%20describe%20%22for%20an%20authorized%20user%22%20do%0A%0A%20%20%20%20%20%20before(:each)%20do%0A%20%20%20%20%20%20%20%20@user%20=%20test_sign_in(Factory(:user))%0A%20%20%20%20%20%20%20%20@micropost%20=%20Factory(:micropost,%20:user%20=%3E%20@user)%0A%20%20%20%20%20%20end%0A%0A%20%20%20%20%20%20it%20%22should%20destroy%20the%20micropost%22%20do%0A%20%20%20%20%20%20%20%20lambda%20do%20%0A%20%20%20%20%20%20%20%20%20%20delete%20:destroy,%20:id%20=%3E%20@micropost%0A%20%20%20%20%20%20%20%20end.should%20change(Micropost,%20:count).by(%2D1)%0A%20%20%20%20%20%20end%0A%20%20%20%20end%0A%20%20end%0Aend%0A">
      <param name="bgcolor" value="#ffffff">
      <embed src="Chapter-11_fichiers/clippy.swf" name="clippy" quality="high" allowscriptaccess="always" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="text=describe%20MicropostsController%20do%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20describe%20%22DELETE%20'destroy'%22%20do%0A%0A%20%20%20%20describe%20%22for%20an%20unauthorized%20user%22%20do%0A%0A%20%20%20%20%20%20before(:each)%20do%0A%20%20%20%20%20%20%20%20@user%20=%20Factory(:user)%0A%20%20%20%20%20%20%20%20wrong_user%20=%20Factory(:user,%20:email%20=%3E%20Factory.next(:email))%0A%20%20%20%20%20%20%20%20test_sign_in(wrong_user)%0A%20%20%20%20%20%20%20%20@micropost%20=%20Factory(:micropost,%20:user%20=%3E%20@user)%0A%20%20%20%20%20%20end%0A%0A%20%20%20%20%20%20it%20%22should%20deny%20access%22%20do%0A%20%20%20%20%20%20%20%20delete%20:destroy,%20:id%20=%3E%20@micropost%0A%20%20%20%20%20%20%20%20response.should%20redirect_to(root_path)%0A%20%20%20%20%20%20end%0A%20%20%20%20end%0A%0A%20%20%20%20describe%20%22for%20an%20authorized%20user%22%20do%0A%0A%20%20%20%20%20%20before(:each)%20do%0A%20%20%20%20%20%20%20%20@user%20=%20test_sign_in(Factory(:user))%0A%20%20%20%20%20%20%20%20@micropost%20=%20Factory(:micropost,%20:user%20=%3E%20@user)%0A%20%20%20%20%20%20end%0A%0A%20%20%20%20%20%20it%20%22should%20destroy%20the%20micropost%22%20do%0A%20%20%20%20%20%20%20%20lambda%20do%20%0A%20%20%20%20%20%20%20%20%20%20delete%20:destroy,%20:id%20=%3E%20@micropost%0A%20%20%20%20%20%20%20%20end.should%20change(Micropost,%20:count).by(%2D1)%0A%20%20%20%20%20%20end%0A%20%20%20%20end%0A%20%20end%0Aend%0A" bgcolor="#ffffff" height="14" width="110">
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="no">MicropostsController</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">"DELETE 'destroy'"</span> <span class="k">do</span>

    <span class="n">describe</span> <span class="s2">"pour un utilisateur non autorisé"</span> <span class="k">do</span>

      <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
        <span class="vi">@user</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
        <span class="n">wrong_user</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:user</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="no">Factory</span><span class="o">.</span><span class="n">next</span><span class="p">(</span><span class="ss">:email</span><span class="p">))</span>
        <span class="n">test_sign_in</span><span class="p">(</span><span class="n">wrong_user</span><span class="p">)</span>
        <span class="vi">@micropost</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">"devrait refuser l'accès"</span> <span class="k">do</span>
        <span class="n">delete</span> <span class="ss">:destroy</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="vi">@micropost</span>
        <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">root_path</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">"pour un utilisateur autorisé"</span> <span class="k">do</span>

      <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
        <span class="vi">@user</span> <span class="o">=</span> <span class="n">test_sign_in</span><span class="p">(</span><span class="no">Factory</span><span class="p">(</span><span class="ss">:user</span><span class="p">))</span>
        <span class="vi">@micropost</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">"devrait détruire le micro-message"</span> <span class="k">do</span>
        <span class="nb">lambda</span> <span class="k">do</span> 
          <span class="n">delete</span> <span class="ss">:destroy</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="vi">@micropost</span>
        <span class="k">end</span><span class="o">.</span><span class="n">should</span> <span class="n">change</span><span class="p">(</span><span class="no">Micropost</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Le code de l'application est aussi analogue au cas de l'utilisateur dans l'<a class="ref" href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#code:admin_destroy_before_filter">extrait&nbsp;10.41</a>&nbsp;; la différence principale est que, plutôt que d'utiliser un filtre “passe-avant” <code>admin_user</code>, dans le cas des micro-messages nous utilisons un filtre “passe-avant” <code>authorized_user</code> qui vérifie que l'utilisateur courant est l'auteur du micro-message. Le code apparait dans l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:microposts_destroy_action">extrait&nbsp;11.40</a>, et le résultat de la suppression du deuxième plus récent message apparait dans l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#fig:home_post_delete">illustration&nbsp;11.16</a>.</p>

<div class="label" id="code:microposts_destroy_action"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 11.40.</span> <span class="description">L'action <code>destroy</code> du contrôleur `Microposts`. <br> <code>app/controllers/microposts_controller.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" id="clippy_4919d0b21a06698efd5572ec0a9958bbfacdc313" height="14" width="110">
      <param name="movie" value="/flash/clippy.swf">
      <param name="allowScriptAccess" value="always">
      <param name="quality" value="high">
      <param name="scale" value="noscale">
      <param name="FlashVars" value="text=class%20MicropostsController%20%3C%20ApplicationController%0A%20%20before_filter%20:authenticate,%20:only%20=%3E%20[:create,%20:destroy]%0A%20%20before_filter%20:authorized_user,%20:only%20=%3E%20:destroy%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20def%20destroy%0A%20%20%20%20@micropost.destroy%0A%20%20%20%20redirect_back_or%20root_path%0A%20%20end%0A%0A%20%20private%0A%20%20%0A%20%20%20%20def%20authorized_user%0A%20%20%20%20%20%20@micropost%20=%20Micropost.find(params[:id])%0A%20%20%20%20%20%20redirect_to%20root_path%20unless%20current_user?(@micropost.user)%0A%20%20%20%20end%0Aend%0A">
      <param name="bgcolor" value="#ffffff">
      <embed src="Chapter-11_fichiers/clippy.swf" name="clippy" quality="high" allowscriptaccess="always" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="text=class%20MicropostsController%20%3C%20ApplicationController%0A%20%20before_filter%20:authenticate,%20:only%20=%3E%20[:create,%20:destroy]%0A%20%20before_filter%20:authorized_user,%20:only%20=%3E%20:destroy%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20def%20destroy%0A%20%20%20%20@micropost.destroy%0A%20%20%20%20redirect_back_or%20root_path%0A%20%20end%0A%0A%20%20private%0A%20%20%0A%20%20%20%20def%20authorized_user%0A%20%20%20%20%20%20@micropost%20=%20Micropost.find(params[:id])%0A%20%20%20%20%20%20redirect_to%20root_path%20unless%20current_user?(@micropost.user)%0A%20%20%20%20end%0Aend%0A" bgcolor="#ffffff" height="14" width="110">
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MicropostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:authenticate</span><span class="p">,</span> <span class="ss">:only</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
  <span class="n">before_filter</span> <span class="ss">:authorized_user</span><span class="p">,</span> <span class="ss">:only</span> <span class="o">=&gt;</span> <span class="ss">:destroy</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="vi">@micropost</span><span class="o">.</span><span class="n">destroy</span>
    <span class="n">redirect_back_or</span> <span class="n">root_path</span>
  <span class="k">end</span>

  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">authorized_user</span>
      <span class="vi">@micropost</span> <span class="o">=</span> <span class="no">Micropost</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
      <span class="n">redirect_to</span> <span class="n">root_path</span> <span class="k">unless</span> <span class="n">current_user?</span><span class="p">(</span><span class="vi">@micropost</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="fig:home_post_delete"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="Chapter-11_fichiers/home_post_delete.png" alt="home_post_delete"></span></div><div class="caption"><span class="header">Illustration 11.16: </span><span class="description">Page d'accueil de l'utilisateur après la suppression du second plus récent micro-message.&nbsp;<a href="http://railstutorial.org/images/figures/home_post_delete-full.png">(full size)</a></span></div></div>




<div class="label" id="sec:testing_the_new_home_page"></div>


<h3><a id="sec:11.3.5" href="http://ruby.railstutorial.org/chapters/user-microposts#sec:testing_the_new_home_page" class="heading"><span class="number">11.3.5</span> Test de la nouvelle page d'accueil</a></h3>


<p>Avant de quitter la création et la suppresion des micro-messages, nous allons écrire un spec d'intégration RSpec pour tester que nos formulaire fonctionnent proprement. Comme dans le cas des utilisateurs (<a class="ref" href="http://ruby.railstutorial.org/chapters/sign-up#sec:rspec_integration_tests">Section&nbsp;8.4</a>), nous commençons par générer un spec d'intégration `microposts` (“micro-messags”)&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate integration_test microposts
</pre></div>
</div>


<p>Des tests pour échec et la réussite de la création du micro-message apparaissent dans l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:microposts_integration_spec">extrait&nbsp;11.41</a>.</p>

<div class="label" id="code:microposts_integration_spec"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 11.41.</span> <span class="description">Un test d'intégration pour les micro-messages sur la page d'accueil (<code>home</code> page). <br> <code>spec/requests/microposts_spec.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" id="clippy_46f82d00f99f5727539e5eea240e447f4bab867f" height="14" width="110">
      <param name="movie" value="/flash/clippy.swf">
      <param name="allowScriptAccess" value="always">
      <param name="quality" value="high">
      <param name="scale" value="noscale">
      <param name="FlashVars" value="text=require%20'spec_helper'%0A%0Adescribe%20%22Microposts%22%20do%0A%0A%20%20before(:each)%20do%0A%20%20%20%20user%20=%20Factory(:user)%0A%20%20%20%20visit%20signin_path%0A%20%20%20%20fill_in%20:email,%20%20%20%20:with%20=%3E%20user.email%0A%20%20%20%20fill_in%20:password,%20:with%20=%3E%20user.password%0A%20%20%20%20click_button%0A%20%20end%0A%20%20%0A%20%20describe%20%22creation%22%20do%0A%20%20%20%20%0A%20%20%20%20describe%20%22failure%22%20do%0A%20%20%20%20%0A%20%20%20%20%20%20it%20%22should%20not%20make%20a%20new%20micropost%22%20do%0A%20%20%20%20%20%20%20%20lambda%20do%0A%20%20%20%20%20%20%20%20%20%20visit%20root_path%0A%20%20%20%20%20%20%20%20%20%20fill_in%20:micropost_content,%20:with%20=%3E%20%22%22%0A%20%20%20%20%20%20%20%20%20%20click_button%0A%20%20%20%20%20%20%20%20%20%20response.should%20render_template('pages/home')%0A%20%20%20%20%20%20%20%20%20%20response.should%20have_selector(%22div%23error_explanation%22)%0A%20%20%20%20%20%20%20%20end.should_not%20change(Micropost,%20:count)%0A%20%20%20%20%20%20end%0A%20%20%20%20end%0A%0A%20%20%20%20describe%20%22success%22%20do%0A%20%20%0A%20%20%20%20%20%20it%20%22should%20make%20a%20new%20micropost%22%20do%0A%20%20%20%20%20%20%20%20content%20=%20%22Lorem%20ipsum%20dolor%20sit%20amet%22%0A%20%20%20%20%20%20%20%20lambda%20do%0A%20%20%20%20%20%20%20%20%20%20visit%20root_path%0A%20%20%20%20%20%20%20%20%20%20fill_in%20:micropost_content,%20:with%20=%3E%20content%0A%20%20%20%20%20%20%20%20%20%20click_button%0A%20%20%20%20%20%20%20%20%20%20response.should%20have_selector(%22span.content%22,%20:content%20=%3E%20content)%0A%20%20%20%20%20%20%20%20end.should%20change(Micropost,%20:count).by(1)%0A%20%20%20%20%20%20end%0A%20%20%20%20end%0A%20%20end%0Aend%0A">
      <param name="bgcolor" value="#ffffff">
      <embed src="Chapter-11_fichiers/clippy.swf" name="clippy" quality="high" allowscriptaccess="always" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="text=require%20'spec_helper'%0A%0Adescribe%20%22Microposts%22%20do%0A%0A%20%20before(:each)%20do%0A%20%20%20%20user%20=%20Factory(:user)%0A%20%20%20%20visit%20signin_path%0A%20%20%20%20fill_in%20:email,%20%20%20%20:with%20=%3E%20user.email%0A%20%20%20%20fill_in%20:password,%20:with%20=%3E%20user.password%0A%20%20%20%20click_button%0A%20%20end%0A%20%20%0A%20%20describe%20%22creation%22%20do%0A%20%20%20%20%0A%20%20%20%20describe%20%22failure%22%20do%0A%20%20%20%20%0A%20%20%20%20%20%20it%20%22should%20not%20make%20a%20new%20micropost%22%20do%0A%20%20%20%20%20%20%20%20lambda%20do%0A%20%20%20%20%20%20%20%20%20%20visit%20root_path%0A%20%20%20%20%20%20%20%20%20%20fill_in%20:micropost_content,%20:with%20=%3E%20%22%22%0A%20%20%20%20%20%20%20%20%20%20click_button%0A%20%20%20%20%20%20%20%20%20%20response.should%20render_template('pages/home')%0A%20%20%20%20%20%20%20%20%20%20response.should%20have_selector(%22div%23error_explanation%22)%0A%20%20%20%20%20%20%20%20end.should_not%20change(Micropost,%20:count)%0A%20%20%20%20%20%20end%0A%20%20%20%20end%0A%0A%20%20%20%20describe%20%22success%22%20do%0A%20%20%0A%20%20%20%20%20%20it%20%22should%20make%20a%20new%20micropost%22%20do%0A%20%20%20%20%20%20%20%20content%20=%20%22Lorem%20ipsum%20dolor%20sit%20amet%22%0A%20%20%20%20%20%20%20%20lambda%20do%0A%20%20%20%20%20%20%20%20%20%20visit%20root_path%0A%20%20%20%20%20%20%20%20%20%20fill_in%20:micropost_content,%20:with%20=%3E%20content%0A%20%20%20%20%20%20%20%20%20%20click_button%0A%20%20%20%20%20%20%20%20%20%20response.should%20have_selector(%22span.content%22,%20:content%20=%3E%20content)%0A%20%20%20%20%20%20%20%20end.should%20change(Micropost,%20:count).by(1)%0A%20%20%20%20%20%20end%0A%20%20%20%20end%0A%20%20end%0Aend%0A" bgcolor="#ffffff" height="14" width="110">
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">'spec_helper'</span>

<span class="n">describe</span> <span class="s2">"Microposts"</span> <span class="k">do</span>

  <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
    <span class="n">visit</span> <span class="n">signin_path</span>
    <span class="n">fill_in</span> <span class="ss">:email</span><span class="p">,</span>    <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span>
    <span class="n">fill_in</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span>
    <span class="n">click_button</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">"création"</span> <span class="k">do</span>

    <span class="n">describe</span> <span class="s2">"échec"</span> <span class="k">do</span>

      <span class="n">it</span> <span class="s2">"ne devrait pas créer un nouveau micro-message"</span> <span class="k">do</span>
        <span class="nb">lambda</span> <span class="k">do</span>
          <span class="n">visit</span> <span class="n">root_path</span>
          <span class="n">fill_in</span> <span class="ss">:micropost_content</span><span class="p">,</span> <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="s2">""</span>
          <span class="n">click_button</span>
          <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">'pages/home'</span><span class="p">)</span>
          <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">"div#error_explanation"</span><span class="p">)</span>
        <span class="k">end</span><span class="o">.</span><span class="n">should_not</span> <span class="n">change</span><span class="p">(</span><span class="no">Micropost</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">"succès"</span> <span class="k">do</span>

      <span class="n">it</span> <span class="s2">"devrait créer un nouveau micro-message"</span> <span class="k">do</span>
        <span class="n">content</span> <span class="o">=</span> <span class="s2">"Lorem ipsum dolor sit amet"</span>
        <span class="nb">lambda</span> <span class="k">do</span>
          <span class="n">visit</span> <span class="n">root_path</span>
          <span class="n">fill_in</span> <span class="ss">:micropost_content</span><span class="p">,</span> <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="n">content</span>
          <span class="n">click_button</span>
          <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">"span.content"</span><span class="p">,</span> <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="n">content</span><span class="p">)</span>
        <span class="k">end</span><span class="o">.</span><span class="n">should</span> <span class="n">change</span><span class="p">(</span><span class="no">Micropost</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Ayabt fini de tester les fonctionnalités attachées aux micro-messages, nous sommes maintenant en mesure d'élaborer la fonctionnalité final de notre exemple d'application&nbsp;: le suivi d'utilisateur.</p>

<h2><a id="sec:11.4" href="http://ruby.railstutorial.org/chapters/user-microposts#sec:11.4" class="heading"><span class="number">11.4</span> Conclusion</a></h2>


<p>Avec l'addition de la ressource `Microposts`, nous en avons presque fini avec notre exemple d'application. Tout ce qu'il reste à faire est d'ajouter une “couche sociale” en permettant à des utilisateurs de se suivre l'un l'autre. Nous allons apprendre comment modeler une telle relation entre utilisateurs, et voir les implications pour les statuts d'alimentation, au <a class="ref" href="http://ruby.railstutorial.org/chapters/following-users#top">chapitre&nbsp;12</a>.</p>

<p>Avant d'y venir, assurez-vous d'enregistrer (<code>commit</code> et <code>merge</code>) vos changements si vous utilisez le contrôle de versions Git&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">"Added user microposts"</span>
<span class="gp">$</span> git checkout master
<span class="gp">$</span> git merge user-microposts
</pre></div>
</div>


<p>Vous pouvez aussi “pousser” l'application sur Heroku à ce point. Parce que le modèle de données a changé avec l'addition de la table <code>microposts</code>, vous aurez aussi besoin de migrer la base de données de production&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git push heroku
<span class="gp">$</span> heroku rake db:migrate
</pre></div>
</div>


<div class="label" id="sec:micropost_exercises"></div>


<h2><a id="sec:11.5" href="http://ruby.railstutorial.org/chapters/user-microposts#sec:micropost_exercises" class="heading"><span class="number">11.5</span> Exercices</a></h2>


<p>Nous avons abordé suffisamment de sujets maintenant pour entrevoir une combinaison d'extensions possible à notre application. En voilà quelques unes parmi les nombreuses possibilités&nbsp;:</p>

<ol>
<li><strong>(challenge)</strong> Ajoutez un affichage, à l'aide de JavaScript, pour afficher le décompte de 140 signes sur la page d'accueil, à mesure que l'utilisateur entre du texte.</li>
<li>Ajoutez des tests pour le compte des micro-messages dans la sidebar (sans oublier le traitement du pluriel).</li>
<li><strong>(principalement pour les designers)</strong> Modifiez le listing des micro-messages en utilisant une liste numérotée plutôt qu'une table. (<em>Note&nbsp;:</em> c'est la façon pour Twitter d'afficher [ses statuts d'actualisation][its status updates].) Ajouter ensuite les styles CSS appropriés pour que l'alimentation en résultant n'ait pas l'air trop moche.</li>
<li>Ajoutez des tests pour la pagination des micro-messages.</li>
<li>Restructurez la page d'accueil pour utiliser des partiels différents pour les deux branches des conditions <code>if</code> et <code>else</code>.</li>
<li>Écrivez un test pour vous assurer que le lien de suppression des messages n'apparaissent pas sur le messages dont l'utilisateur courant n'est pas l'auteur.</li>
<li>Ajoutez  une route “imbriquée” (<a href="http://guides.rubyonrails.org/routing.html#nested-routes">nested route</a>) pour que <tt>/users/1/microposts</tt> affiche tous les micro-messages de l'utilisateur&nbsp;1. (Vous aurez aussi à ajouter une action <code>index</code> au contrôleur `Microposts` et à créer la vue correspondante.)</li>
<li>Les très longs mots, généralement, perturbent l'affichage, comme on peut le voir dans l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#fig:long_word_micropost">illustration&nbsp;11.17</a>. Réglez ce problème en utilisant l'<em>helper</em> <code>wrap</code> défini dans l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:wrap">extrait&nbsp;11.42</a>. (Notez l'utilisation de la méthode <code>raw</code> (“brut”) pour empêcher Rails d'échapper le code HTML, liée à la méthode <code>sanitize</code> nécessaire pour prévenir le [scripting à travers le site][cross-site scripting].)</li>
</ol>




<div class="label" id="fig:long_word_micropost"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="Chapter-11_fichiers/long_word_micropost.png" alt="long_word_micropost"></span></div><div class="caption"><span class="header">Illustration 11.17: </span><span class="description">Déficience de l'affichage à cause d'un mot trop long.&nbsp;<a href="http://railstutorial.org/images/figures/long_word_micropost-full.png">(traille normale)</a></span></div></div>




<div class="label" id="code:wrap"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 11.42.</span> <span class="description">Un <em>helper</em> pour traiter les mots longs. <br> <code>app/helpers/microposts_helper.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" id="clippy_b4a99478b7655d60d310b34e7e645deb2756af52" height="14" width="110">
      <param name="movie" value="/flash/clippy.swf">
      <param name="allowScriptAccess" value="always">
      <param name="quality" value="high">
      <param name="scale" value="noscale">
      <param name="FlashVars" value="text=module%20MicropostsHelper%0A%0A%20%20def%20wrap(content)%0A%20%20%20%20sanitize(raw(content.split.map%7B%20%7Cs%7C%20wrap_long_string(s)%20%7D.join('%20')))%0A%20%20end%0A%0A%20%20private%0A%0A%20%20%20%20def%20wrap_long_string(text,%20max_width%20=%2030)%0A%20%20%20%20%20%20zero_width_space%20=%20%22%26%238203;%22%0A%20%20%20%20%20%20regex%20=%20/.%7B1,%23%7Bmax_width%7D%7D/%0A%20%20%20%20%20%20(text.length%20%3C%20max_width)%20?%20text%20:%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20text.scan(regex).join(zero_width_space)%0A%20%20%20%20end%0Aend%0A">
      <param name="bgcolor" value="#ffffff">
      <embed src="Chapter-11_fichiers/clippy.swf" name="clippy" quality="high" allowscriptaccess="always" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" flashvars="text=module%20MicropostsHelper%0A%0A%20%20def%20wrap(content)%0A%20%20%20%20sanitize(raw(content.split.map%7B%20%7Cs%7C%20wrap_long_string(s)%20%7D.join('%20')))%0A%20%20end%0A%0A%20%20private%0A%0A%20%20%20%20def%20wrap_long_string(text,%20max_width%20=%2030)%0A%20%20%20%20%20%20zero_width_space%20=%20%22%26%238203;%22%0A%20%20%20%20%20%20regex%20=%20/.%7B1,%23%7Bmax_width%7D%7D/%0A%20%20%20%20%20%20(text.length%20%3C%20max_width)%20?%20text%20:%20%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20text.scan(regex).join(zero_width_space)%0A%20%20%20%20end%0Aend%0A" bgcolor="#ffffff" height="14" width="110">
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">MicropostsHelper</span>

  <span class="k">def</span> <span class="nf">wrap</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
    <span class="n">sanitize</span><span class="p">(</span><span class="n">raw</span><span class="p">(</span><span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="o">.</span><span class="n">map</span><span class="p">{</span> <span class="o">|</span><span class="n">s</span><span class="o">|</span> <span class="n">wrap_long_string</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="p">}</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">' '</span><span class="p">)))</span>
  <span class="k">end</span>

  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">wrap_long_string</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">max_width</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span>
      <span class="n">zero_width_space</span> <span class="o">=</span> <span class="s2">"&amp;#8203;"</span>
      <span class="n">regex</span> <span class="o">=</span> <span class="sr">/.{1,</span><span class="si">#{</span><span class="n">max_width</span><span class="si">}</span><span class="sr">}/</span>
      <span class="p">(</span><span class="n">text</span><span class="o">.</span><span class="n">length</span> <span class="o">&lt;</span> <span class="n">max_width</span><span class="p">)</span> <span class="p">?</span> <span class="n">text</span> <span class="p">:</span> 
                                  <span class="n">text</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">regex</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">zero_width_space</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="navigation">  <a class="prev_page" href="http://ruby.railstutorial.org/chapters/updating-showing-and-deleting-users#top">
    «&nbsp;<span class="number">Chapitre 10</span> Actualiser, afficher et supprimer des utilisateurs
  </a>
  <a class="next_page" href="http://ruby.railstutorial.org/chapters/following-users#top">
    <span class="number">Chapitre 12</span> Following users&nbsp;»
  </a>
</div><div class="footnotes">
<ol>
<li id="fn:11.1">Techniquement, nous traitons les sessions comme une ressource dans le <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#top">chapitre&nbsp;9</a>, mais elles ne sont pas sauvées dans la base de données de la même façon que les utilisateurs et les micro-messages.&nbsp;<a class="arrow" href="#fnref:11.1">&uarr;</a></li>
<li id="fn:11.2">L'attribut <code>content</code> (“contenu”) sera une chaine de caractères (<code>string</code>), mais, comme cela est noté brièvement dans la <a class="ref" href="http://ruby.railstutorial.org/chapters/a-demo-app#sec:modeling_microposts">section&nbsp;2.1.2</a>, pour des champs de saisie de textes plus longs, vous devriez utiliser le type de donnée <code>text</code>.&nbsp;<a class="arrow" href="#fnref:11.2">&uarr;</a></li>
<li id="fn:11.3">Pour en savoir plus sur les associations dans Factory Girl, y compris toutes les options possibles, voyez la <a href="http://rdoc.info/projects/thoughtbot/factory_girl">Documentation Factory Girl</a>.&nbsp;<a class="arrow" href="#fnref:11.3">&uarr;</a></li>
<li id="fn:11.4">Souvenez-vous que <code>created_at</code> (“créé à…”) et <code>updated_at</code> ("actualisé le…") sont des colonnes “magiques”, donc toute assignation explicte sera remplacée par ces valeurs magiques.&nbsp;<a class="arrow" href="#fnref:11.4">&uarr;</a></li>
<li id="fn:11.5">Conformément au “marquage sémantique” (<a href="http://en.wikipedia.org/wiki/HTML#Semantic_HTML">semantic markup</a>), il serait probablement meilleur d'utiliser une liste numérotée (<a href="http://www.w3.org/MarkUp/html3/seqlists.html"><em>ordered list</em></a>), mais dans ce cas l'alignement du texte et des images est beaucoup plus difficile qu'avec les tables. Voyez l'exercice de la <a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#sec:micropost_exercises">section&nbsp;11.5</a> si vous mettez un point d'honneur à utiliser la version sémantique.&nbsp;<a class="arrow" href="#fnref:11.5">&uarr;</a></li>
<li id="fn:11.6">Dans le cas où vous vous poseriez la question, la méthode associative <code>count</code> (“compter”) est intelligente, et exécute le décompte directement dans la base de données. En particulier, elle <em>ne</em> tire <em>pas</em> tous les micro-messages de la base pour compter ensuite le nombre d'éléments dans la liste obtenue, ce qui serait terriblement consommateur à mesure que le nombre de micro-messages grossirait. Au lieu de ça, elle demande à la base de données de compter les micro-messages possédant un identifiant d'utilisateur donné (<code>user_id</code>). En passant, [dans l'éventualité peu probable que dénombrer les messages soit toujours un goulot de bouteille —&nbsp;un entonnoir&nbsp;— dans votre application][in the 
unlikely event that finding the count is still a bottleneck in your 
application], vous pouvez même le rendre encore plus rapide avec un <a href="http://railscasts.com/episodes/23-counter-cache-column"><em>counter cache</em></a>.&nbsp;<a class="arrow" href="#fnref:11.6">&uarr;</a></li>
<li id="fn:11.7">De façon pratique, l'<a class="ref" href="http://ruby.railstutorial.org/chapters/user-microposts#code:micropost_css">extrait&nbsp;11.19</a> contient en fait <em>tous</em> les styles CSS nécessaires à ce chapitre.&nbsp;<a class="arrow" href="#fnref:11.7">&uarr;</a></li>
<li id="fn:11.8">(c'est-à-dire cinq utilisateurs avec un gravatar personnalisé, et un avec le gravatar par défaut)&nbsp;<a class="arrow" href="#fnref:11.8">&uarr;</a></li>
<li id="fn:11.9">Consultez votre journal de développement (<code>log/development.log</code>) si vous êtes curieux de connaitre la commande SQL que cette méthode génère.&nbsp;<a class="arrow" href="#fnref:11.9">&uarr;</a></li>
<li id="fn:11.10">À dessein, le texte <em>lorem ipsum</em> du gem Faker est aléatoire, donc les contenus des micro-messages en exemple seront différents.&nbsp;<a class="arrow" href="#fnref:11.10">&uarr;</a></li>
<li id="fn:11.11">Les deux autres ressources sont la ressource `Users` de la <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-up#sec:signup_form">section&nbsp;8.1</a> et la ressource `Sessions` de la <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec:sessions">section&nbsp;9.1</a>.&nbsp;<a class="arrow" href="#fnref:11.11">&uarr;</a></li>
<li id="fn:11.12">Nous avons noté dans la <a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#sec:remember_me">section&nbsp;9.3.2</a> que les méthodes <em>helper</em> sont disponibes seulement dans les <em>vues</em> (<em>views</em>) par défaut, mais nous avons fait en sorte que les méthodes helper de la ressource `Sessions` soit également accessible par les contrôleurs en ajoutant le code <code>include SessionsHelper</code> au contrôleur de l'application (<a class="ref" href="http://ruby.railstutorial.org/chapters/sign-in-sign-out#code:sessions_helper_include">Extrait&nbsp;9.11</a>).&nbsp;<a class="arrow" href="#fnref:11.12">&uarr;</a></li>
<li id="fn:11.13">L'apprentissage des méthodes telles que <code>include?</code> est une des raisons pour laquelle, comme cela est noté dans la <a class="ref" href="http://ruby.railstutorial.org/chapters/beginning#sec:comments_for_various_readers">section&nbsp;1.1.1</a>, je recommande lire un livre de pur Ruby après avoir achevé celui-ci.&nbsp;<a class="arrow" href="#fnref:11.13">&uarr;</a></li>
<li id="fn:11.14">Voyez le guide Rails après du <a href="http://guides.rubyonrails.org/active_record_querying.html">Active Record Query Interface</a> pour en savoir plus sur la clause <code>where</code> et similaire.&nbsp;<a class="arrow" href="#fnref:11.14">&uarr;</a></li>
<li id="fn:11.15">Malheureusement, retourner une alimentation paginée ne fonctionne pas dans ce cas. Implémentez-la et cliquez sur un lien de pagination pour comprendre pourquoi. 
(Les <a href="http://railstutorial.org/screencasts">screencasts du tutoriel Rails</a> couvre ce problème plus ne profondeur.)&nbsp;<a class="arrow" href="#fnref:11.15">&uarr;</a></li>
</ol>
</div>
