

<h1 class="title">Ruby on Rails チュートリアル </h1>


<h1 class="subtitle"> 実例を使ってRailsを学ぼう</h1>


<h2 class="author">Michael Hartl (マイケル・ハートル)</h2>




<h1 class="contents">目次</h1>


<div id="table_of_contents"><ol><li class="chapter"><a href="beginning#top"><span class="number">第1章</span> ゼロからデプロイまで</a></li><li><ol><li class="section"><a href="beginning#sec:introduction"><span class="number">1.1</span>　はじめに</a></li><li><ol><li class="subsection"><a href="beginning#sec:comments_for_various_readers"><span class="number">1.1.1</span> 読者の皆さまへのコメント</a></li><li class="subsection"><a href="beginning#sec:1.1.2"><span class="number">1.1.2</span> Railsとスケールについて</a></li><li class="subsection"><a href="beginning#sec:conventions"><span class="number">1.1.3</span> この本における取り決め</a></li></ol></li><li class="section"><a href="beginning#sec:up_and_running"><span class="number">1.2</span> さっそく動作させる</a></li><li><ol><li class="subsection"><a href="beginning#sec:development_tools"><span class="number">1.2.1</span> 開発環境</a></li><li><ol><li class="subsubsection"><a href="beginning#sec:1.2.1.1">IDEs</a></li><li class="subsubsection"><a href="beginning#sec:1.2.1.2">テキストエディタとコマンドライン</a></li><li class="subsubsection"><a href="beginning#sec:1.2.1.3">ブラウザ</a></li><li class="subsubsection"><a href="beginning#sec:1.2.1.4">使用するツールについて</a></li></ol></li><li class="subsection"><a href="beginning#sec:rubygems"><span class="number">1.2.2</span> Ruby, RubyGems, Rails, そして Git</a></li><li><ol><li class="subsubsection"><a href="beginning#sec:rails_installer_windows">Rails インストーラ (Windows)</a></li><li class="subsubsection"><a href="beginning#sec:install_git">Gitのインストール</a></li><li class="subsubsection"><a href="beginning#sec:install_ruby">Rubyのインストール</a></li><li class="subsubsection"><a href="beginning#sec:install_rubygems">RubyGemsのインストール</a></li><li class="subsubsection"><a href="beginning#sec:install_rails">Railsのインストール</a></li></ol></li><li class="subsection"><a href="beginning#sec:the_first_application"><span class="number">1.2.3</span> 最初のアプリケーション</a></li><li class="subsection"><a href="beginning#sec:bundler"><span class="number">1.2.4</span> Bundler</a></li><li class="subsection"><a href="beginning#sec:rails_server"><span class="number">1.2.5</span> <code>rails server</code></a></li><li class="subsection"><a href="beginning#sec:mvc"><span class="number">1.2.6</span> Model-view-controller (MVC)</a></li></ol></li><li class="section"><a href="beginning#sec:version_control"><span class="number">1.3</span> Gitによるバージョン管理</a></li><li><ol><li class="subsection"><a href="beginning#sec:git_setup"><span class="number">1.3.1</span> インストールとセットアップ</a></li><li><ol><li class="subsubsection"><a href="beginning#sec:1.3.1.1">最初のシステム・セットアップ</a></li><li class="subsubsection"><a href="beginning#sec:1.3.1.2">最初のリポジトリ・セットアップ</a></li></ol></li><li class="subsection"><a href="beginning#sec:adding_and_committing"><span class="number">1.3.2</span> 追加とコミット</a></li><li class="subsection"><a href="beginning#sec:1.3.3"><span class="number">1.3.3</span> Gitの利点とは？</a></li><li class="subsection"><a href="beginning#sec:github"><span class="number">1.3.4</span> GitHub</a></li><li class="subsection"><a href="beginning#sec:git_commands"><span class="number">1.3.5</span> ブランチ(branch)、変更(edit)、 コミット(commit)、 統合(merge)</a></li><li><ol><li class="subsubsection"><a href="beginning#sec:git_branch">ブランチ(branch)</a></li><li class="subsubsection"><a href="beginning#sec:git_edit">Edit</a></li><li class="subsubsection"><a href="beginning#sec:git_commit">Commit</a></li><li class="subsubsection"><a href="beginning#sec:git_merge">統合(merge)</a></li><li class="subsubsection"><a href="beginning#sec:git_push">Push</a></li></ol></li></ol></li><li class="section"><a href="beginning#sec:deploying"><span class="number">1.4</span> デプロイする</a></li><li><ol><li class="subsection"><a href="beginning#sec:1.4.1"><span class="number">1.4.1</span> Herokuのセットアップ</a></li><li class="subsection"><a href="beginning#sec:heroku_step_one"><span class="number">1.4.2</span> Herokuにデプロイする　(1)</a></li><li class="subsection"><a href="beginning#sec:1.4.3"><span class="number">1.4.3</span> Herokuにデプロイする (2)</a></li><li class="subsection"><a href="beginning#sec:heroku_commands"><span class="number">1.4.4</span> Heroku コマンド</a></li></ol></li><li class="section"><a href="beginning#sec:beginning_conclusion"><span class="number">1.5</span> 最後に</a></li></ol></li><li class="chapter"><a href="a-demo-app#top"><span class="number">第２章</span>　デモアプリケーション</a></li><li><ol><li class="section"><a href="a-demo-app#sec:planning_the_application"><span class="number">2.1</span> アプリの計画</a></li><li><ol><li class="subsection"><a href="a-demo-app#sec:modeling_users"><span class="number">2.1.1</span> ユーザーのモデル</a></li><li class="subsection"><a href="a-demo-app#sec:modeling_microposts"><span class="number">2.1.2</span> マイクロプロストのモデル</a></li></ol></li><li class="section"><a href="a-demo-app#sec:demo_users_resource"><span class="number">2.2</span> Usersリソース</a></li><li><ol><li class="subsection"><a href="a-demo-app#sec:a_user_tour"><span class="number">2.2.1</span> ユーザーページを見てみる</a></li><li class="subsection"><a href="a-demo-app#sec:mvc_in_action"><span class="number">2.2.2</span> 作動中のMVC </a></li><li class="subsection"><a href="a-demo-app#sec:weaknesses_of_this_users_resource"><span class="number">2.2.3</span> Usersリソースの欠点</a></li></ol></li><li class="section"><a href="a-demo-app#sec:microposts_resource"><span class="number">2.3</span> Microposts リソース</a></li><li><ol><li class="subsection"><a href="a-demo-app#sec:a_micropost_microtour"><span class="number">2.3.1</span> マイクロポストのページを見てみる</a></li><li class="subsection"><a href="a-demo-app#sec:putting_the_micro_in_microposts"><span class="number">2.3.2</span> マイクロポストを <em>マイクロ</em> にする</a></li><li class="subsection"><a href="a-demo-app#sec:demo_user_has_many_microposts"><span class="number">2.3.3</span> ユーザーとマイクロポストを <code>has_many</code> で関連づける</a></li><li class="subsection"><a href="a-demo-app#sec:inheritance_hierarchies"><span class="number">2.3.4</span> 継承階層</a></li><li class="subsection"><a href="a-demo-app#sec:deploying_the_demo_app"><span class="number">2.3.5</span>デモアプリケーションのデプロイ</a></li></ol></li><li class="section"><a href="a-demo-app#sec:2.4"><span class="number">2.4</span> 最後に</a></li></ol></li><li class="chapter"><a href="static-pages#top"><span class="number">第3章</span>主に静的ページの作成</a></li><li><ol><li class="section"><a href="static-pages#sec:static_pages"><span class="number">3.1</span> 静的ページ</a></li><li><ol><li class="subsection"><a href="static-pages#sec:truly_static_pages"><span class="number">3.1.1</span> 「本当に」静的なページ</a></li><li class="subsection"><a href="static-pages#sec:static_pages_with_rails"><span class="number">3.1.2</span> Railsでの静的なページ</a></li></ol></li><li class="section"><a href="static-pages#sec:first_tests"><span class="number">3.2</span> 最初のテスト</a></li><li><ol><li class="subsection"><a href="static-pages#sec:testing_tools"><span class="number">3.2.1</span> テストに使用するツール</a></li><li><ol><li class="subsubsection"><a href="static-pages#sec:autotest">Autotest</a></li></ol></li><li class="subsection"><a href="static-pages#sec:TDD"><span class="number">3.2.2</span> TDD: 赤(Red), 緑(Green), リファクタリング</a></li><li><ol><li class="subsubsection"><a href="static-pages#sec:spork">Spork</a></li><li class="subsubsection"><a href="static-pages#sec:red">赤(Red)</a></li><li class="subsubsection"><a href="static-pages#sec:green">緑(Green)</a></li><li class="subsubsection"><a href="static-pages#sec:refactor">リファクタリング</a></li></ol></li></ol></li><li class="section"><a href="static-pages#sec:slightly_dynamic_pages"><span class="number">3.3</span> ちょっとだけ動的なページ</a></li><li><ol><li class="subsection"><a href="static-pages#sec:testing_a_title_change"><span class="number">3.3.1</span> タイトル変更のテスト</a></li><li class="subsection"><a href="static-pages#sec:passing_title_tests"><span class="number">3.3.2</span> タイトルのテストをパスさせる</a></li><li class="subsection"><a href="static-pages#sec:instance_variables_embedded_ruby"><span class="number">3.3.3</span> インスタンス変数とEmbedded Ruby</a></li><li class="subsection"><a href="static-pages#sec:layouts"><span class="number">3.3.4</span> レイアウトを使って重複をなくす</a></li></ol></li><li class="section"><a href="static-pages#sec:static_pages_conclusion"><span class="number">3.4</span> 最後に</a></li><li class="section"><a href="static-pages#sec:static_pages_exercises"><span class="number">3.5</span> 練習</a></li></ol></li><li class="chapter"><a href="rails-flavored-ruby#top"><span class="number">第4章</span> Rails風味のRuby</a></li><li><ol><li class="section"><a href="rails-flavored-ruby#sec:motivation"><span class="number">4.1</span> 動機</a></li><li><ol><li class="subsection"><a href="rails-flavored-ruby#sec:title_helper"><span class="number">4.1.1</span> <code>title</code> ヘルパー</a></li><li class="subsection"><a href="rails-flavored-ruby#sec:cascading_style_sheets"><span class="number">4.1.2</span> スタイルシート(CSS)</a></li></ol></li><li class="section"><a href="rails-flavored-ruby#sec:strings_and_methods"><span class="number">4.2</span> 文字列(string）とメソッド</a></li><li><ol><li class="subsection"><a href="rails-flavored-ruby#sec:comments"><span class="number">4.2.1</span> コメント</a></li><li class="subsection"><a href="rails-flavored-ruby#sec:strings"><span class="number">4.2.2</span> 文字列</a></li><li><ol><li class="subsubsection"><a href="rails-flavored-ruby#sec:printing">出力</a></li><li class="subsubsection"><a href="rails-flavored-ruby#sec:single_quoted_strings">シングルクォート内の文字列</a></li></ol></li><li class="subsection"><a href="rails-flavored-ruby#sec:objects_and_message_passing"><span class="number">4.2.3</span> オブジェクトとメッセージパッシング</a></li><li class="subsection"><a href="rails-flavored-ruby#sec:method_definitions"><span class="number">4.2.4</span>メソッドの定義</a></li><li class="subsection"><a href="rails-flavored-ruby#sec:back_to_the_title_helper"><span class="number">4.2.5</span> <code>title</code> ヘルパー、再び</a></li></ol></li><li class="section"><a href="rails-flavored-ruby#sec:other_data_structures"><span class="number">4.3</span> 他のデータ構造</a></li><li><ol><li class="subsection"><a href="rails-flavored-ruby#sec:arrays_and_ranges"><span class="number">4.3.1</span> 配列と範囲演算子</a></li><li class="subsection"><a href="rails-flavored-ruby#sec:blocks"><span class="number">4.3.2</span>ブロック</a></li><li class="subsection"><a href="rails-flavored-ruby#sec:hashes_and_symbols"><span class="number">4.3.3</span> ハッシュとシンボル</a></li><li class="subsection"><a href="rails-flavored-ruby#sec:css_revisited"><span class="number">4.3.4</span> CSS 再び</a></li></ol></li><li class="section"><a href="rails-flavored-ruby#sec:ruby_classes"><span class="number">4.4</span> Ruby におけるクラス</a></li><li><ol><li class="subsection"><a href="rails-flavored-ruby#sec:constructors"><span class="number">4.4.1</span> コンストラクタ</a></li><li class="subsection"><a href="rails-flavored-ruby#sec:a_class_of_our_own"><span class="number">4.4.2</span> クラス継承</a></li><li class="subsection"><a href="rails-flavored-ruby#sec:modifying_built_in_classes"><span class="number">4.4.3</span> 組み込み関数の変更</a></li><li class="subsection"><a href="rails-flavored-ruby#sec:a_controller_class"><span class="number">4.4.4</span> コントローラクラス</a></li><li class="subsection"><a href="rails-flavored-ruby#sec:a_user_class"><span class="number">4.4.5</span> ユーザークラス</a></li></ol></li><li class="section"><a href="rails-flavored-ruby#sec:exercises"><span class="number">4.5</span> 練習</a></li></ol></li><li class="chapter"><a href="filling-in-the-layout#top"><span class="number">第5章</span> レイアウトを埋める</a></li><li><ol><li class="section"><a href="filling-in-the-layout#sec:structure"><span class="number">5.1</span> 構造を少し追加する</a></li><li><ol><li class="subsection"><a href="filling-in-the-layout#sec:adding_to_the_layout"><span class="number">5.1.1</span> ナビゲーション</a></li><li class="subsection"><a href="filling-in-the-layout#sec:custom_css"><span class="number">5.1.2</span> カスタム・CSS/a></li><li class="subsection"><a href="filling-in-the-layout#sec:partials"><span class="number">5.1.3</span> パーシャル(partial)</a></li></ol></li><li class="section"><a href="filling-in-the-layout#sec:layout_links"><span class="number">5.2</span> レイアウトのリンク</a></li><li><ol><li class="subsection"><a href="filling-in-the-layout#sec:integration_tests"><span class="number">5.2.1</span> 統合テスト（インテグレーションテスト）</a></li><li class="subsection"><a href="filling-in-the-layout#sec:rails_routes"><span class="number">5.2.2</span> Rails ルート</a></li><li class="subsection"><a href="filling-in-the-layout#sec:named_routes"><span class="number">5.2.3</span> 名前付きルート</a></li></ol></li><li class="section"><a href="filling-in-the-layout#sec:user_signup"><span class="number">5.3</span> 第1歩:ユーザー登録</a></li><li><ol><li class="subsection"><a href="filling-in-the-layout#sec:users_controller"><span class="number">5.3.1</span> Users コントローラ</a></li><li class="subsection"><a href="filling-in-the-layout#sec:signup_url"><span class="number">5.3.2</span> ユーザー登録URL</a></li></ol></li><li class="section"><a href="filling-in-the-layout#sec:layout_conclusion"><span class="number">5.4</span> Conclusion</a></li><li class="section"><a href="filling-in-the-layout#sec:layout_exercises"><span class="number">5.5</span> 練習</a></li></ol></li><li class="chapter"><a href="modeling-and-viewing-users-one#top"><span class="number">第6章</span> ユーザーのモデルと表示(1)</a></li><li><ol><li class="section"><a href="modeling-and-viewing-users-one#sec:user_model"><span class="number">6.1</span> User モデル</a></li><li><ol><li class="subsection"><a href="modeling-and-viewing-users-one#sec:database_migrations"><span class="number">6.1.1</span> データベース・マイグレーション</a></li><li class="subsection"><a href="modeling-and-viewing-users-one#sec:the_model_file"><span class="number">6.1.2</span> モデルのファイル</a></li><li><ol><li class="subsubsection"><a href="modeling-and-viewing-users-one#sec:model_annotation">モデルの注釈</a></li><li class="subsubsection"><a href="modeling-and-viewing-users-one#sec:accessible_attributes">accessibleな属性</a></li></ol></li><li class="subsection"><a href="modeling-and-viewing-users-one#sec:creating_user_objects"><span class="number">6.1.3</span> ユーザーオブジェクトの生成</a></li><li class="subsection"><a href="modeling-and-viewing-users-one#sec:finding_user_objects"><span class="number">6.1.4</span> ユーザーオブジェクトの検索</a></li><li class="subsection"><a href="modeling-and-viewing-users-one#sec:updating_user_objects"><span class="number">6.1.5</span> ユーザーオブジェクトの更新</a></li></ol></li><li class="section"><a href="modeling-and-viewing-users-one#sec:user_validations"><span class="number">6.2</span> ユーザーのバリデーション(確認)</a></li><li><ol><li class="subsection"><a href="modeling-and-viewing-users-one#sec:presence_validation"><span class="number">6.2.1</span> 存在のバリデーション</a></li><li class="subsection"><a href="modeling-and-viewing-users-one#sec:length_validation"><span class="number">6.2.2</span> 長さのバリデーション</a></li><li class="subsection"><a href="modeling-and-viewing-users-one#sec:format_validation"><span class="number">6.2.3</span> 形式のバリデーション</a></li><li class="subsection"><a href="modeling-and-viewing-users-one#sec:uniqueness_validation"><span class="number">6.2.4</span> 一意性(Uniqueness)のバリデーション</a></li><li><ol><li class="subsubsection"><a href="modeling-and-viewing-users-one#sec:the_caveat">一意性(Uniqueness）の問題点</a></li></ol></li></ol></li><li class="section"><a href="modeling-and-viewing-users-one#sec:viewing_users"><span class="number">6.3</span> ユーザーを表示する</a></li><li><ol><li class="subsection"><a href="modeling-and-viewing-users-one#sec:rails_environments"><span class="number">6.3.1</span> Rails環境とデバッギング</a></li><li class="subsection"><a href="modeling-and-viewing-users-one#sec:users_show"><span class="number">6.3.2</span> ユーザーのモデル,ビュー,コントローラ(MVC)</a></li><li class="subsection"><a href="modeling-and-viewing-users-one#sec:a_users_resource"><span class="number">6.3.3</span> Users リソース</a></li><li><ol><li class="subsubsection"><a href="modeling-and-viewing-users-one#sec:params_in_debug"><code>debug</code>での<code>params</code> </a></li></ol></li></ol></li><li class="section"><a href="modeling-and-viewing-users-one#sec:6.4"><span class="number">6.4</span> 最後に</a></li><li class="section"><a href="modeling-and-viewing-users-one#sec:6.5"><span class="number">6.5</span> 練習</a></li></ol></li><li class="chapter"><a href="modeling-and-viewing-users-two#top"><span class="number">第7章</span> ユーザーのモデルと表示(2)</a></li><li><ol><li class="section"><a href="modeling-and-viewing-users-two#sec:insecure_passwords"><span class="number">7.1</span> 危険なパスワード</a></li><li><ol><li class="subsection"><a href="modeling-and-viewing-users-two#sec:password_validations"><span class="number">7.1.1</span>パスワードのバリデーション</a></li><li class="subsection"><a href="modeling-and-viewing-users-two#sec:password_migration"><span class="number">7.1.2</span> パスワードのマイグレーション</a></li><li class="subsection"><a href="modeling-and-viewing-users-two#sec:an_active_record_callback"><span class="number">7.1.3</span> Active Record コールバック</a></li></ol></li><li class="section"><a href="modeling-and-viewing-users-two#sec:secure_passwords"><span class="number">7.2</span> 安全なパスワード</a></li><li><ol><li class="subsection"><a href="modeling-and-viewing-users-two#sec:a_secure_password_test"><span class="number">7.2.1</span> 安全なパスワードのテスト</a></li><li class="subsection"><a href="modeling-and-viewing-users-two#sec:secure_password_theory"><span class="number">7.2.2</span> パスワードの安全性について</a></li><li class="subsection"><a href="modeling-and-viewing-users-two#sec:implementing_has_password"><span class="number">7.2.3</span> <code>has_password?</code>の実装</a></li><li class="subsection"><a href="modeling-and-viewing-users-two#sec:an_authenticate_method"><span class="number">7.2.4</span> 認証メソッド</a></li></ol></li><li class="section"><a href="modeling-and-viewing-users-two#sec:better_user_views"><span class="number">7.3</span> ユーザービューを改良する</a></li><li><ol><li class="subsection"><a href="modeling-and-viewing-users-two#sec:tests_with_factories"><span class="number">7.3.1</span> factoryを使ったユーザー表示ページのテスト</a></li><li class="subsection"><a href="modeling-and-viewing-users-two#sec:a_name_and_a_gravatar"><span class="number">7.3.2</span> 名前とGravatar</a></li><li><ol><li class="subsubsection"><a href="modeling-and-viewing-users-two#sec:a_gravatar_helper">Gravatar用ヘルパー</a></li></ol></li><li class="subsection"><a href="modeling-and-viewing-users-two#sec:a_user_sidebar"><span class="number">7.3.3</span> ユーザーサイドバー</a></li></ol></li><li class="section"><a href="modeling-and-viewing-users-two#sec:7.4"><span class="number">7.4</span> 最後に</a></li><li><ol><li class="subsection"><a href="modeling-and-viewing-users-two#sec:7.4.1"><span class="number">7.4.1</span> Git コミット</a></li><li class="subsection"><a href="modeling-and-viewing-users-two#sec:heroku_deploy"><span class="number">7.4.2</span> Heroku デプロイ</a></li></ol></li><li class="section"><a href="modeling-and-viewing-users-two#sec:more_modeling_users_exercises"><span class="number">7.5</span>練習</a></li></ol></li><li class="chapter"><a href="sign-up#top"><span class="number">第8章</span> ユーザー登録</a></li><li><ol><li class="section"><a href="sign-up#sec:signup_form"><span class="number">8.1</span> ユーザー登録用フォーム</a></li><li><ol><li class="subsection"><a href="sign-up#sec:using_form_for"><span class="number">8.1.1</span> <code>form_for</code>を使用する</a></li><li class="subsection"><a href="sign-up#sec:the_form_html"><span class="number">8.1.2</span> フォームのHTML</a></li></ol></li><li class="section"><a href="sign-up#sec:signup_failure"><span class="number">8.2</span> ユーザー登録失敗</a></li><li><ol><li class="subsection"><a href="sign-up#sec:testing_failure"><span class="number">8.2.1</span> 登録失敗のテスト</a></li><li class="subsection"><a href="sign-up#sec:a_working_form"><span class="number">8.2.2</span> 正常に動くフォーム</a></li><li class="subsection"><a href="sign-up#sec:signup_error_messages"><span class="number">8.2.3</span> ユーザー登録失敗時のエラーメッセージ</a></li><li class="subsection"><a href="sign-up#sec:filtering_parameter_logging"><span class="number">8.2.4</span> パラメータ・ログをフィルターする</a></li></ol></li><li class="section"><a href="sign-up#sec:signup_success"><span class="number">8.3</span> ユーザー登録成功</a></li><li><ol><li class="subsection"><a href="sign-up#sec:testing_success"><span class="number">8.3.1</span> ユーザー登録成功のテスト</a></li><li class="subsection"><a href="sign-up#sec:the_finished_signup_form"><span class="number">8.3.2</span> ユーザー登録用フォームの完成</a></li><li class="subsection"><a href="sign-up#sec:the_flash"><span class="number">8.3.3</span> flash</a></li><li class="subsection"><a href="sign-up#sec:the_first_signup"><span class="number">8.3.4</span> 実際にユーザーを登録させてみる</a></li></ol></li><li class="section"><a href="sign-up#sec:rspec_integration_tests"><span class="number">8.4</span> RSpec インテグレーションテスト</a></li><li><ol><li class="subsection"><a href="sign-up#sec:integration_tests_with_style"><span class="number">8.4.1</span> 華やかなインテグレーションテスト</a></li><li class="subsection"><a href="sign-up#sec:failed_signup"><span class="number">8.4.2</span> ユーザー登録失敗時に、新しいユーザーが作成されない事をテスト</a></li><li class="subsection"><a href="sign-up#sec:successful_signup"><span class="number">8.4.3</span> ユーザー登録成功時に、新しいユーザーが正しく作成される事をテスト認</a></li></ol></li><li class="section"><a href="sign-up#sec:8.5"><span class="number">8.5</span> 最後に</a></li><li class="section"><a href="sign-up#sec:signup_exercises"><span class="number">8.6</span> 練習</a></li></ol></li><li class="chapter"><a href="sign-in-sign-out#top"><span class="number">第9章</span> サインイン、サインアウト</a></li><li><ol><li class="section"><a href="sign-in-sign-out#sec:sessions"><span class="number">9.1</span> Session</a></li><li><ol><li class="subsection"><a href="sign-in-sign-out#sec:sessions_controller"><span class="number">9.1.1</span> Sessionコントローラ</a></li><li class="subsection"><a href="sign-in-sign-out#sec:signin_form"><span class="number">9.1.2</span> サインイン用フォーム</a></li></ol></li><li class="section"><a href="sign-in-sign-out#sec:signin_failure"><span class="number">9.2</span> サインイン失敗</a></li><li><ol><li class="subsection"><a href="sign-in-sign-out#sec:reviewing_form_submission"><span class="number">9.2.1</span>フォーム送信について</a></li><li class="subsection"><a href="sign-in-sign-out#sec:failed_signin"><span class="number">9.2.2</span> サインイン失敗(テストと実装)</a></li></ol></li><li class="section"><a href="sign-in-sign-out#sec:signin_success"><span class="number">9.3</span> サインイン成功</a></li><li><ol><li class="subsection"><a href="sign-in-sign-out#sec:the_completed_create_action"><span class="number">9.3.1</span>　<code>create</code>アクションの完成</a></li><li class="subsection"><a href="sign-in-sign-out#sec:remember_me"><span class="number">9.3.2</span> ユーザー情報の保存</a></li><li class="subsection"><a href="sign-in-sign-out#sec:current_user"><span class="number">9.3.3</span> 現在のユーザー</a></li></ol></li><li class="section"><a href="sign-in-sign-out#sec:signing_out"><span class="number">9.4</span> サインアウト</a></li><li><ol><li class="subsection"><a href="sign-in-sign-out#sec:destroying_sessions"><span class="number">9.4.1</span> セッションの破棄</a></li><li class="subsection"><a href="sign-in-sign-out#sec:signin_upon_signup"><span class="number">9.4.2</span> ユーザー登録時にサインインさせる</a></li><li class="subsection"><a href="sign-in-sign-out#sec:changing_the_layout_links"><span class="number">9.4.3</span> レイアウトのリンクを変更する</a></li><li class="subsection"><a href="sign-in-sign-out#sec:signin_out_integration_tests"><span class="number">9.4.4</span> サインイン・サインアウトのインテグレーションテスト</a></li></ol></li><li class="section"><a href="sign-in-sign-out#sec:9.5"><span class="number">9.5</span> 最後に</a></li><li class="section"><a href="sign-in-sign-out#sec:sign_in_out_exercises"><span class="number">9.6</span> 練習</a></li></ol></li><li class="chapter"><a href="updating-showing-and-deleting-users#top"><span class="number">Chapter 10</span> ユーザーの更新・表示・削除</a></li><li><ol><li class="section"><a href="updating-showing-and-deleting-users#sec:updating_users"><span class="number">10.1</span> ユーザーの更新</a></li><li><ol><li class="subsection"><a href="updating-showing-and-deleting-users#sec:edit_form"><span class="number">10.1.1</span> ユーザー編集用のフォーム</a></li><li class="subsection"><a href="updating-showing-and-deleting-users#sec:enabling_edits"><span class="number">10.1.2</span> ユーザー編集機能の実装</a></li></ol></li><li class="section"><a href="updating-showing-and-deleting-users#sec:protecting_pages"><span class="number">10.2</span> ページの保護</a></li><li><ol><li class="subsection"><a href="updating-showing-and-deleting-users#sec:requiring_signed_in_users"><span class="number">10.2.1</span> ユーザーがサインインしている事を確認する</a></li><li class="subsection"><a href="updating-showing-and-deleting-users#sec:requiring_the_right_user"><span class="number">10.2.2</span> 正しいユーザーである事を確認する</a></li><li class="subsection"><a href="updating-showing-and-deleting-users#sec:friendly_forwarding"><span class="number">10.2.3</span> 転送機能の改良</a></li></ol></li><li class="section"><a href="updating-showing-and-deleting-users#sec:showing_users"><span class="number">10.3</span> ユーザーを表示する</a></li><li><ol><li class="subsection"><a href="updating-showing-and-deleting-users#sec:user_index"><span class="number">10.3.1</span> ユーザーのインデックス</a></li><li class="subsection"><a href="updating-showing-and-deleting-users#sec:sample_users"><span class="number">10.3.2</span> サンプル用ユーザー</a></li><li class="subsection"><a href="updating-showing-and-deleting-users#sec:pagination"><span class="number">10.3.3</span> ページ送り</a></li><li><ol><li class="subsubsection"><a href="updating-showing-and-deleting-users#sec:testing_pagination">ページ送りのテスト</a></li></ol></li><li class="subsection"><a href="updating-showing-and-deleting-users#sec:partial_refactoring"><span class="number">10.3.4</span> パーシャル(partial)のリファクタリング</a></li></ol></li><li class="section"><a href="updating-showing-and-deleting-users#sec:destroying_users"><span class="number">10.4</span> ユーザーの削除</a></li><li><ol><li class="subsection"><a href="updating-showing-and-deleting-users#sec:administrative_users"><span class="number">10.4.1</span> 管理権限を持ったユーザー</a></li><li><ol><li class="subsubsection"><a href="updating-showing-and-deleting-users#sec:revisiting_attr_accessible"><code>attr_accessible</code>再び</a></li></ol></li><li class="subsection"><a href="updating-showing-and-deleting-users#sec:the_destroy_action"><span class="number">10.4.2</span> The <code>destroy</code> アクション</a></li></ol></li><li class="section"><a href="updating-showing-and-deleting-users#sec:10.5"><span class="number">10.5</span> 最後に</a></li><li class="section"><a href="updating-showing-and-deleting-users#sec:updating_deleting_exercises"><span class="number">10.6</span> 練習</a></li></ol></li><li class="chapter"><a href="user-microposts#top"><span class="number">Chapter 11</span> ユーザーのマイクロポスト</a></li><li><ol><li class="section"><a href="user-microposts#sec:a_micropost_model"><span class="number">11.1</span> マイクロポストのモデル</a></li><li><ol><li class="subsection"><a href="user-microposts#sec:the_basic_model"><span class="number">11.1.1</span>基本的なモデル</a></li><li><ol><li class="subsubsection"><a href="user-microposts#sec:accessible_attribute">Accessible 属性</a></li></ol></li><li class="subsection"><a href="user-microposts#sec:user_micropost_associations"><span class="number">11.1.2</span> User/Micropost の関連づけ</a></li><li class="subsection"><a href="user-microposts#sec:ordering_and_dependency"><span class="number">11.1.3</span> Micropost を改良する</a></li><li><ol><li class="subsubsection"><a href="user-microposts#sec:default_scope">デフォルトのスコープ</a></li><li class="subsubsection"><a href="user-microposts#sec:dependent_destroy">Dependent: destroy</a></li></ol></li><li class="subsection"><a href="user-microposts#sec:micropost_validations"><span class="number">11.1.4</span> マイクロポストのバリデーション</a></li></ol></li><li class="section"><a href="user-microposts#sec:showing_microposts"><span class="number">11.2</span> マイクロポストの表示</a></li><li><ol><li class="subsection"><a href="user-microposts#sec:augmenting_the_user_show_page"><span class="number">11.2.1</span> ユーザー表次ページの機能拡張</a></li><li class="subsection"><a href="user-microposts#sec:sample_microposts"><span class="number">11.2.2</span> サンプル用マイクロポスト</a></li></ol></li><li class="section"><a href="user-microposts#sec:manipulating_microposts"><span class="number">11.3</span> マイクロポストを扱う</a></li><li><ol><li class="subsection"><a href="user-microposts#sec:access_control"><span class="number">11.3.1</span> アクセス管理</a></li><li class="subsection"><a href="user-microposts#sec:creating_microposts"><span class="number">11.3.2</span> マイクロポストの作成</a></li><li class="subsection"><a href="user-microposts#sec:a_proto_feed"><span class="number">11.3.3</span> フィードの原型</a></li><li class="subsection"><a href="user-microposts#sec:destroying_microposts"><span class="number">11.3.4</span> マイクロポストの削除</a></li><li class="subsection"><a href="user-microposts#sec:testing_the_new_home_page"><span class="number">11.3.5</span> 新しいhomeページのテスト</a></li></ol></li><li class="section"><a href="user-microposts#sec:11.4"><span class="number">11.4</span> 最後に</a></li><li class="section"><a href="user-microposts#sec:micropost_exercises"><span class="number">11.5</span> 練習</a></li></ol></li><li class="chapter"><a href="following-users#top"><span class="number">Chapter 12</span> ユーザーをフォローする</a></li><li><ol><li class="section"><a href="following-users#sec:the_relationship_model"><span class="number">12.1</span> Relationshipのモデル</a></li><li><ol><li class="subsection"><a href="following-users#sec:a_problem_with_the_data_model"><span class="number">12.1.1</span> データモデルの問題点(と解決法)</a></li><li class="subsection"><a href="following-users#sec:relationship_user_associations"><span class="number">12.1.2</span> UsersとRelationshipsの関連</a></li><li class="subsection"><a href="following-users#sec:relationship_validations"><span class="number">12.1.3</span>バリデーション</a></li><li class="subsection"><a href="following-users#sec:following"><span class="number">12.1.4</span> 「フォローしている」ユーザー</a></li><li class="subsection"><a href="following-users#sec:followers"><span class="number">12.1.5</span> 「フォローされている」ユーザー</a></li></ol></li><li class="section"><a href="following-users#sec:a_web_interface_for_following_and_followers"><span class="number">12.2</span> 「フォローしている・されている」用のウェブ・インターフェース</a></li><li><ol><li class="subsection"><a href="following-users#sec:sample_following_data"><span class="number">12.2.1</span> 「フォローしている」用のサンプルデータ</a></li><li class="subsection"><a href="following-users#sec:stats_and_a_follow_form"><span class="number">12.2.2</span> 統計とフォロー用のフォーム</a></li><li class="subsection"><a href="following-users#sec:following_and_followers_pages"><span class="number">12.2.3</span> 「フォローしている」と「フォローされている」のページ</a></li><li class="subsection"><a href="following-users#sec:a_working_follow_button_the_standard_way"><span class="number">12.2.4</span> 「フォローする」ボタン(Ajaxなし)</a></li><li class="subsection"><a href="following-users#sec:a_working_follow_button_with_ajax"><span class="number">12.2.5</span> 「フォローする」ボタン(Ajaxあり)</a></li></ol></li><li class="section"><a href="following-users#sec:the_status_feed"><span class="number">12.3</span> ステータスフィード</a></li><li><ol><li class="subsection"><a href="following-users#sec:motivation_and_strategy"><span class="number">12.3.1</span> 動機と計画</a></li><li class="subsection"><a href="following-users#sec:a_first_feed_implementation"><span class="number">12.3.2</span> ステータスフィードの実装</a></li><li class="subsection"><a href="following-users#sec:scopes_subselects_and_a_lambda"><span class="number">12.3.3</span> スコープ, サブセレクト, そしてlambda</a></li><li class="subsection"><a href="following-users#sec:the_new_status_feed"><span class="number">12.3.4</span> 新しいステータスフィード</a></li></ol></li><li class="section"><a href="following-users#sec:following_conclusion"><span class="number">12.4</span> 最後に</a></li><li><ol><li class="subsection"><a href="following-users#sec:extensions_to_the_sample_application"><span class="number">12.4.1</span> サンプルアプリケーションの機能拡大</a></li><li><ol><li class="subsubsection"><a href="following-users#sec:replies">返信機能</a></li><li class="subsubsection"><a href="following-users#sec:messaging">メッセージ機能</a></li><li class="subsubsection"><a href="following-users#sec:follower_notifications">フォロワーの通知</a></li><li class="subsubsection"><a href="following-users#sec:password_reminders">パスワードリマインダー</a></li><li class="subsubsection"><a href="following-users#sec:signup_confirmation">ユーザーの登録確認</a></li><li class="subsubsection"><a href="following-users#sec:rss_feed">RSSフィード</a></li><li class="subsubsection"><a href="following-users#sec:rest_api">REST API</a></li><li class="subsubsection"><a href="following-users#sec:search">検索機能</a></li></ol></li><li class="subsection"><a href="following-users#sec:guide_to_further_resources"><span class="number">12.4.2</span>読み物ガイド</a></li></ol></li><li class="section"><a href="following-users#sec:following_exercises"><span class="number">12.5</span> 練習</a></li></ol></li></ol></div>

<div id="main_content"></div>


<p> <span class="preamble">
 <span id="foreword">
<strong> 前書き
</strong> <br />
 </span>
 </span></p>

<p>私が前にいた会社(CD Baby)は、かなり早い段階でRuby on Railsに乗り換え、そしてまたPHPに戻っていった会社でした。(詳細は私の名前をGoogleで検索してみて下さい)　Michael Hartl氏によるこの本を強く進められて、これはやってみなければ、と試してみたところ、私が再びRailsに乗り換えるのに使用したのがこの<em>Ruby on Railsチュートリアル</em>でした。</p>

<p>私は多数のRails本を参考にしてきましたが、決定的だったのはこれです。本書では全ての手順が&ldquo;Rails way&rdquo;(「Rails方式」)で行われており、始めは慣れない方式でしたが、この本を終えた今、やっと自然な方式だと感じる事が出来るようになりました。また、本書はRails本の中で唯一、全編を通して強く推奨されているTDD(Test Driven Development-テスト駆動開発)を行っており、非常に分かりやすく解説されています。最後に、Git、GitHub、そしてHerokuを実例に含む事で、チュートリアルのコード例も含め実際のプロジェクトの開発プロセスを体験出来るようになっています。</p>

<p>この物語風の直線的な形式は、非常に良い物だと思います。私は3日間かけて章の終わりにある練習問題もやりながら<em>Rails　チュートリアル</em>を一気に読破しました。最初から最後まで、途中で飛ばさずにやるのが一番効果的で有益な読み方ですのでぜひやってみて下さい。</p>

<p>では、お楽しみあれ!</p>

<p><a href="http://sivers.org/">デレック・シバーズ(Derek Sivers)</a> (<a href="http://sivers.org/">sivers.org</a>) <br />
<em>元:</em> <a href="http://www.cdbaby.com/"><em>CD Baby </em></a><em>(創始者)</em><br />
<em>現在:</em> <a href="http://thoughts.pro/"><em>Thoughts Ltd.</em></a><em>(創始者)</em> <br /></p>

<p> <span class="preamble">
<strong> 謝辞</strong> <br />
 </span></p>

<p><em>Ruby on Rails チュートリアル</em>は、私の以前の著書<em>RailsSpace</em>と、その時の共著者の<a href="http://aure.com/">Aurelius Prochazka</a>に負うところが多くあります。Aureには、RailsSpaceでの協力と本書への支援も含め、感謝したいと思います。また、<em>RailsSpace</em>と<em>Rails チュートリアル</em>両方の編集を担当して頂いたDebra Williams Cauley氏にも謝意を表したく思います。彼女に野球の試合に連れて行ってもらえる限り、私は本を書き続けます。</p>

<p>私にインスピレーションと知識を与えてくれたRubyistの方々にも感謝したいと思います:David Heinemeier Hansson, Yehuda Katz, Carl Lerche, Jeremy Kemper, Xavier Noria, Ryan Bates, Geoffrey Grosenbach, Peter Cooper, Matt Aimonetti, Gregg Pollack, Wayne&nbsp;E. Seguin, Amy Hoy, Dave Chelimsky, Pat Maddox, Tom Preston-Werner, Chris Wanstrath, Chad Fowler, Josh Susser, Obie Fernandez, Ian McFarland, Steven Bristol, Giles Bowkett, Evan Dorn, Long Nguyen, James Lindenbaum, Adam Wiggins, Tikhon Bernstam, Ron Evans, Wyatt Greene, Miles Forrest, Pivotal Labsの方々, Herokuの方々, thoughtbotの方々, そしてGitHubチーム。
最後に、リストにするには多すぎるほどにたくさんの読者の方々から執筆中にバグ報告や提案を頂き、本書を出来る限り良いものにするのに大変役立ちました。
<br /></p>

<p> <span class="preamble">
 <span id="author">
<strong> 著者</strong> <br />
 </span>
 </span></p>

<p><a href="http://michaelhartl.com/">マイケル・ハートル(Michael Hartl)</a> はプログラマー・教育者・起業家です. 氏は2007年に出版されたRails本のベスt−セラー<em>RailsSpace</em>の共著者の一人で、Railsで書かれた<a href="http://github.com/popular/forked">人気の</em>ソーシャルネットワーキング<a href="http://insoshi.com/">Insoshi</a>を設立しリード開発者を担当していました。以前は、<a href="http://www.caltech.edu/">カリフォルニア工科大学</a>(Caltech)で理論物理学と計算物理学の講師を務め、優秀な教育者に贈られるLifetime Achievement Awardを受賞しています。マイケルは<a href="http://college.harvard.edu/">ハーバード大学</a>出身で、Caltechにて<a href="http://resolver.caltech.edu/CaltechETD:etd-05222003-161626">物理学の博士号</a>を取得し、<a href="http://ycombinator.com/">Y&nbsp;Combinator</a>の卒業生でもあります。<br /></p>

<p> <span id="license" class="preamble">
<strong> 著作権とライセンス</strong> <br />
 </span></p>

<p><em>Ruby on Rails チュートリアル: 実例を使ってRailsを学ぼう</em>. Copyright &copy; 2010 by Michael Hartl. <em>Ruby on Rails チュートリアル</em>内の全てのソースコードは<a href="http://www.opensource.org/licenses/mit-license.php">MIT ライセンス</a> と<a href="http://en.wikipedia.org/wiki/Beerware">Beerware ライセンス</a>の元で提供されています。</p>

<pre class="verbatim">   Copyright (c) 2010 Michael Hartl
   以下に定める条件に従い、本ソフトウェアおよび関連文書のファイル（以下「ソフトウェア」）
   の複製を取得するすべての人に対し、ソフトウェアを無制限に扱うことを無償で許可します。
   これには、ソフトウェアの複製を使用、複写、変更、結合、掲載、頒布、サブライセンス、
   および/または販売する権利、およびソフトウェアを提供する相手に同じことを許可する権利も
   無制限に含まれます。

   上記の著作権表示および本許諾表示を、ソフトウェアのすべての複製または重要な部分に記載
   するものとします。
   
   ソフトウェアは「現状のまま」で、明示であるか暗黙であるかを問わず、何らの保証もなく提供されます。
   ここでいう保証とは、商品性、特定の目的への適合性、および権利非侵害についての保証も含みますが、
   それに限定されるものではありません。 作者または著作権者は、契約行為、不法行為、
   またはそれ以外であろうと、ソフトウェアに起因または関連し、あるいはソフトウェアの使用
   またはその他の扱いによって生じる一切の請求、損害、その他の義務について何らの責任も
   負わないものとします。 
</pre>




<pre class="verbatim">/*
 * ------------------------------------------------------------
 * &quot;BEERWARE ライセンス&quot; (リビジョン 42):
 * このソースコードはMichael Hartlによる物です。このライセンスを含む限り、
 * ソースコードで何をしても構いません。いつか会う事があって、あなたがこの
 * チュートリアルが有用だったと思うなら、僕にビールを奢ってくれれば嬉しいです。
 * ------------------------------------------------------------
 */</pre>




<div id="top"></div>


<h1 class="chapter"><a id="sec:11" href="user-microposts#top" class="heading"><span class="number">Chapter 11</span> User microposts</a></h1>


<p><a class="ref" href="updating-showing-and-deleting-users#top">Chapter&nbsp;10</a> saw the completion of the REST actions for the Users resource, so the time has finally come to add a second resource: user <em>microposts</em>.<sup class="footnote" id="fnref:11.1"><a href="#fn:11.1">1</a></sup> These are short messages associated with a particular user, first seen in larval form in <a class="ref" href="a-demo-app#top">Chapter&nbsp;2</a>. In this chapter, we will make a full-strength version of the sketch from <a class="ref" href="a-demo-app#sec:microposts_resource">Section&nbsp;2.3</a> by constructing the Micropost data model, associating it with the User model using the <code>has_many</code> and <code>belongs_to</code> methods, and then making the forms and partials needed to manipulate and display the results. In <a class="ref" href="following-users#top">Chapter&nbsp;12</a>, we will complete our tiny Twitter clone by adding the notion of <em>following</em> users in order to receive a <em>feed</em> of their microposts.</p>

<p>If you&rsquo;re using Git for version control, I suggest making a topic branch as usual:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout -b user-microposts
</pre></div>
</div>




<div class="label" id="sec:a_micropost_model"></div>


<h2><a id="sec:11.1" href="user-microposts#sec:a_micropost_model" class="heading"><span class="number">11.1</span> A Micropost model</a></h2>


<p>We begin the Microposts resource by creating a Micropost model, which captures the essential characteristics of microposts. What follows builds on the work from <a class="ref" href="a-demo-app#sec:microposts_resource">Section&nbsp;2.3</a>; as with the model in that section, our new Micropost model will include data validations and an association with the User model. Unlike that model, the present Micropost model will be fully tested, and will also have a default <em>ordering</em> and automatic <em>destruction</em> if its parent user is destroyed.</p>

<div class="label" id="sec:the_basic_model"></div>


<h3><a id="sec:11.1.1" href="user-microposts#sec:the_basic_model" class="heading"><span class="number">11.1.1</span> The basic model</a></h3>


<p>The Micropost model needs only two attributes: a <code>content</code> attribute to hold the micropost&rsquo;s content,<sup class="footnote" id="fnref:11.2"><a href="#fn:11.2">2</a></sup> and a <code>user_id</code> to associate a micropost with a particular user. As with the case of the User model (<a class="ref" href="modeling-and-viewing-users-one#code:generate_user_model">Listing&nbsp;6.1</a>), we generate it using <code>generate model</code>:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate model Micropost content:string user_id:integer
</pre></div>
</div>


<p>This produces a migration to create a <code>microposts</code> table in the database (<a class="ref" href="user-microposts#code:micropost_migration">Listing&nbsp;11.1</a>); compare it to the analogous migration for the <code>users</code> table from <a class="ref" href="modeling-and-viewing-users-one#code:users_migration">Listing&nbsp;6.2</a>.</p>

<div class="label" id="code:micropost_migration"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.1.</span> <span class="description">The Micropost migration. (Note the index on <code>user_id</code>.) <br /> <code>db/migrate/&lt;timestamp&gt;_create_microposts.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">CreateMicroposts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">up</span>
    <span class="n">create_table</span> <span class="ss">:microposts</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="o">.</span><span class="n">string</span> <span class="ss">:content</span>
      <span class="n">t</span><span class="o">.</span><span class="n">integer</span> <span class="ss">:user_id</span>

      <span class="n">t</span><span class="o">.</span><span class="n">timestamps</span>
    <span class="k">end</span>
    <span class="n">add_index</span> <span class="ss">:microposts</span><span class="p">,</span> <span class="ss">:user_id</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">down</span>
    <span class="n">drop_table</span> <span class="ss">:microposts</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Note that, since we expect to retrieve all the microposts associated with a given user&nbsp;id, <a class="ref" href="user-microposts#code:micropost_migration">Listing&nbsp;11.1</a> adds an index (<a class="ref" href="modeling-and-viewing-users-one#sidebar:database_indices">Box&nbsp;6.2</a>) on the <code>user_id</code> column:</p>

<div class="code"><div class="highlight"><pre><span class="n">add_index</span> <span class="ss">:microposts</span><span class="p">,</span> <span class="ss">:user_id</span>
</pre></div>
</div>


<p>Note also the <code>t.timestamps</code> line, which (as mentioned in <a class="ref" href="modeling-and-viewing-users-one#sec:database_migrations">Section&nbsp;6.1.1</a>) adds the magic <code>created_at</code> and <code>updated_at</code> columns. We&rsquo;ll put the <code>created_at</code> column to work in <a class="ref" href="user-microposts#sec:ordering_and_dependency">Section&nbsp;11.1.3</a> and <a class="ref" href="user-microposts#sec:augmenting_the_user_show_page">Section&nbsp;11.2.1</a>.</p>

<p>We can run the microposts migration as usual (taking care to prepare the test database since the data model has changed):</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rake db:migrate
<span class="gp">$</span> rake db:test:prepare
</pre></div>
</div>


<p>The result is a Micropost model with the structure shown in <a class="ref" href="user-microposts#fig:micropost_model">Figure&nbsp;11.1</a>.</p>

<div class="label" id="fig:micropost_model"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/micropost_model.png" alt="micropost_model" /></span></div><div class="caption"><span class="header">Figure 11.1: </span><span class="description">The Micropost data model.</span></div></div>




<div class="label" id="sec:accessible_attribute"></div>


<h4><a id="sec:11.1.1.1" href="user-microposts#sec:accessible_attribute" class="heading">Accessible attribute</a></h4>


<p>Before fleshing out the Micropost model, it&rsquo;s important first to use <code>attr_accessible</code> to indicate the attributes editable through the web. As discussed in <a class="ref" href="modeling-and-viewing-users-one#sec:accessible_attributes">Section&nbsp;6.1.2.2</a> and <a class="ref" href="updating-showing-and-deleting-users#sec:revisiting_attr_accessible">Section&nbsp;10.4.1.1</a>, failing to define accessible attributes means that anyone could change any aspect of a micropost object simply by using a command-line client to issue malicious requests. For example, a malicious user could change the <code>user_id</code> attributes on microposts, thereby associating microposts with the wrong users.</p>

<p>In the case of the Micropost model, there is only <em>one</em> attribute that needs to be editable through the web, namely, the <code>content</code> attribute (<a class="ref" href="user-microposts#code:micropost_accessible_attribute">Listing&nbsp;11.2</a>).</p>

<div class="label" id="code:micropost_accessible_attribute"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.2.</span> <span class="description">Making the <code>content</code> attribute (and <em>only</em> the <code>content</code> attribute) accessible. <br /> <code>app/models/micropost.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:content</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Since <code>user_id</code> <em>isn&rsquo;t</em> listed as an <code>attr_accessible</code> parameter, it can&rsquo;t be edited through the web, because a <code>user_id</code> parameter in a mass assignment such as</p>

<div class="code"><div class="highlight"><pre><span class="no">Micropost</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:content</span> <span class="o">=&gt;</span> <span class="s2">&quot;foo bar&quot;</span><span class="p">,</span> <span class="ss">:user_id</span> <span class="o">=&gt;</span> <span class="mi">17</span><span class="p">)</span>
</pre></div>
</div>


<p>will simply be ignored.</p>

<p>The <code>attr_accessible</code> declaration in <a class="ref" href="user-microposts#code:micropost_accessible_attribute">Listing&nbsp;11.2</a> is necessary for site security, but it introduces a problem in the default Micropost model spec (<a class="ref" href="user-microposts#code:initial_micropost_spec">Listing&nbsp;11.3</a>).</p>

<div class="label" id="code:initial_micropost_spec"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.3.</span> <span class="description">The initial Micropost spec. <br /> <code>spec/models/micropost_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">Micropost</span> <span class="k">do</span>

  <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
    <span class="vi">@attr</span> <span class="o">=</span> <span class="p">{</span>
      <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="s2">&quot;value for content&quot;</span><span class="p">,</span>
      <span class="ss">:user_id</span> <span class="o">=&gt;</span> <span class="mi">1</span>
    <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s2">&quot;should create a new instance given valid attributes&quot;</span> <span class="k">do</span>
    <span class="no">Micropost</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="vi">@attr</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>This test currently passes, but there&rsquo;s something fishy about it. (See if you can figure out what before proceeding.)</p>

<p>The problem is that the <code>before(:each)</code> block in <a class="ref" href="user-microposts#code:initial_micropost_spec">Listing&nbsp;11.3</a> assigns the user id through mass assignment, which is exactly what <code>attr_accessible</code> is designed to prevent; in particular, as noted above, the <code>:user_id =&gt; 1</code> part of the initialization hash is simply ignored. The solution is to avoid using <code>Micropost.new</code> directly; instead, we will create the new micropost through its <em>association</em> with the User model, which sets the user id automatically. Accomplishing this is the task of the next section.</p>

<div class="label" id="sec:user_micropost_associations"></div>


<h3><a id="sec:11.1.2" href="user-microposts#sec:user_micropost_associations" class="heading"><span class="number">11.1.2</span> User/Micropost associations</a></h3>


<p>The goal of this section is to establish an <em>association</em> between the Micropost model and the User model&mdash;a relationship seen briefly in <a class="ref" href="a-demo-app#sec:demo_user_has_many_microposts">Section&nbsp;2.3.3</a> and shown schematically in <a class="ref" href="user-microposts#fig:micropost_belongs_to_user">Figure&nbsp;11.2</a> and <a class="ref" href="user-microposts#fig:user_has_many_microposts">Figure&nbsp;11.3</a>. Along the way, we&rsquo;ll write tests for the Micropost model that, unlike <a class="ref" href="user-microposts#code:initial_micropost_spec">Listing&nbsp;11.3</a>, are compatible with the use of <code>attr_accessible</code> in <a class="ref" href="user-microposts#code:micropost_accessible_attribute">Listing&nbsp;11.2</a>.</p>

<div class="label" id="fig:micropost_belongs_to_user"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/micropost_belongs_to_user.png" alt="micropost_belongs_to_user" /></span></div><div class="caption"><span class="header">Figure 11.2: </span><span class="description">The <code>belongs_to</code> relationship between a micropost and its user.&nbsp;<a href="http://railstutorial.org/images/figures/micropost_belongs_to_user-full.png">(full size)</a></span></div></div>




<div class="label" id="fig:user_has_many_microposts"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_has_many_microposts.png" alt="user_has_many_microposts" /></span></div><div class="caption"><span class="header">Figure 11.3: </span><span class="description">The <code>has_many</code> relationship between a user and its microposts.&nbsp;<a href="http://railstutorial.org/images/figures/user_has_many_microposts-full.png">(full size)</a></span></div></div>


<p>We start with tests for the Micropost model association. First, we want to replicate the <code>Micropost.create!</code> test shown in <a class="ref" href="user-microposts#code:initial_micropost_spec">Listing&nbsp;11.3</a> without the invalid mass assignment. Second, we see from <a class="ref" href="user-microposts#fig:micropost_belongs_to_user">Figure&nbsp;11.2</a> that a <code>micropost</code> object should have a <code>user</code> method. Finally, <code>micropost.user</code> should be the user corresponding to the micropost&rsquo;s <code>user_id</code>. We can express these requirements in RSpec with the code in <a class="ref" href="user-microposts#code:micropost_belongs_to_user_spec">Listing&nbsp;11.4</a>.</p>

<div class="label" id="code:micropost_belongs_to_user_spec"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.4.</span> <span class="description">Tests for the micropost&rsquo;s user association. <br /> <code>spec/models/micropost_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">Micropost</span> <span class="k">do</span>

  <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
    <span class="vi">@attr</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="s2">&quot;value for content&quot;</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s2">&quot;should create a new instance given valid attributes&quot;</span> <span class="k">do</span>
    <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="vi">@attr</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;user associations&quot;</span> <span class="k">do</span>

    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="vi">@micropost</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="vi">@attr</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should have a user attribute&quot;</span> <span class="k">do</span>
      <span class="vi">@micropost</span><span class="o">.</span><span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should have the right associated user&quot;</span> <span class="k">do</span>
      <span class="vi">@micropost</span><span class="o">.</span><span class="n">user_id</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="vi">@user</span><span class="o">.</span><span class="n">id</span>
      <span class="vi">@micropost</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="vi">@user</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Note that, rather than using <code>Micropost.create</code> or <code>Micropost.create!</code> to create a micropost, <a class="ref" href="user-microposts#code:micropost_belongs_to_user_spec">Listing&nbsp;11.4</a> uses</p>

<div class="code"><div class="highlight"><pre><span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="vi">@attr</span><span class="p">)</span>
</pre></div>
</div>


<p>and</p>

<div class="code"><div class="highlight"><pre><span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="vi">@attr</span><span class="p">)</span>
</pre></div>
</div>


<p>This pattern is the <a href="http://www.answers.com/canonical">canonical</a> way to create a micropost through its association with users. (We use a factory user because these tests are for the Micropost model, not the User model.) When created in this way, the micropost object <em>automatically</em> has its <code>user_id</code> set to the right value, which fixes the issue noted in <a class="ref" href="user-microposts#sec:accessible_attribute">Section&nbsp;11.1.1.1</a>. In particular, the code</p>

<div class="code"><div class="highlight"><pre>  <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
    <span class="vi">@attr</span> <span class="o">=</span> <span class="p">{</span>
      <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="s2">&quot;value for content&quot;</span><span class="p">,</span>
      <span class="ss">:user_id</span> <span class="o">=&gt;</span> <span class="mi">1</span>
    <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s2">&quot;should create a new instance given valid attributes&quot;</span> <span class="k">do</span>
    <span class="no">Micropost</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="vi">@attr</span><span class="p">)</span>
  <span class="k">end</span>
</pre></div>
</div>


<p>from <a class="ref" href="user-microposts#code:initial_micropost_spec">Listing&nbsp;11.3</a> is defective because <code>:user_id =&gt; 1</code> does nothing when <code>user_id</code> is not one of the Micropost model&rsquo;s accessible attributes. By going through the user association, on the other hand, the code</p>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="s2">&quot;should create a new instance given valid attributes&quot;</span> <span class="k">do</span>
  <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="vi">@attr</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>


<p>from <a class="ref" href="user-microposts#code:micropost_belongs_to_user_spec">Listing&nbsp;11.4</a> has the right <code>user_id</code> by construction.</p>

<p>These special <code>create</code> methods won&rsquo;t work yet; they require the proper <code>has_many</code> association in the User model. We&rsquo;ll defer the more detailed tests for this association to <a class="ref" href="user-microposts#sec:ordering_and_dependency">Section&nbsp;11.1.3</a>; for now, we&rsquo;ll simply test for the presence of a <code>microposts</code> attribute (<a class="ref" href="user-microposts#code:user_has_many_microposts_spec">Listing&nbsp;11.5</a>).</p>

<div class="label" id="code:user_has_many_microposts_spec"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.5.</span> <span class="description">A test for the user&rsquo;s <code>microposts</code> attribute. <br /> <code>spec/models/user_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;micropost associations&quot;</span> <span class="k">do</span>

    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="vi">@attr</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should have a microposts attribute&quot;</span> <span class="k">do</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:microposts</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>We can get the tests in both <a class="ref" href="user-microposts#code:micropost_belongs_to_user_spec">Listing&nbsp;11.4</a> and <a class="ref" href="user-microposts#code:user_has_many_microposts_spec">Listing&nbsp;11.5</a> to pass using the <code>belongs_to</code>/<code>has_many</code> association illustrated in <a class="ref" href="user-microposts#fig:micropost_belongs_to_user">Figure&nbsp;11.2</a> and <a class="ref" href="user-microposts#fig:user_has_many_microposts">Figure&nbsp;11.3</a>, as shown in <a class="ref" href="user-microposts#code:micropost_belongs_to_user">Listing&nbsp;11.6</a> and <a class="ref" href="user-microposts#code:user_has_many_microposts">Listing&nbsp;11.7</a>.</p>

<div class="label" id="code:micropost_belongs_to_user"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.6.</span> <span class="description">A micropost <code>belongs_to</code> a user. <br /> <code>app/models/micropost.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:content</span>

  <span class="n">belongs_to</span> <span class="ss">:user</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="code:user_has_many_microposts"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.7.</span> <span class="description">A user <code>has_many</code> microposts. <br /> <code>app/models/user.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="kp">attr_accessor</span> <span class="ss">:password</span>
  <span class="n">attr_accessible</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:password_confirmation</span>

  <span class="n">has_many</span> <span class="ss">:microposts</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Using this <code>belongs_to</code>/<code>has_many</code> association, Rails constructs the methods shown in <a class="ref" href="user-microposts#table:association_methods">Table&nbsp;11.1</a>. You should compare the entries in <a class="ref" href="user-microposts#table:association_methods">Table&nbsp;11.1</a> with the code in <a class="ref" href="user-microposts#code:micropost_belongs_to_user_spec">Listing&nbsp;11.4</a> and <a class="ref" href="user-microposts#code:user_has_many_microposts_spec">Listing&nbsp;11.5</a> to satisfy yourself that you understand the basic nature of the associations. (There is one method in <a class="ref" href="user-microposts#table:association_methods">Table&nbsp;11.1</a> we haven&rsquo;t used so far, the <code>build</code> method; it will be put to good use in <a class="ref" href="user-microposts#sec:micropost_validations">Section&nbsp;11.1.4</a> and especially in <a class="ref" href="user-microposts#sec:creating_microposts">Section&nbsp;11.3.2</a>.)</p>

<div class="label" id="table:association_methods"></div>


<div class="table"><div class="center"><table class="tabular"><tr><th class="align_left"><strong>Method</strong></th><th class="align_left"><strong>Purpose</strong></th></tr><tr class="top_bar"><td class="align_left"><code>micropost.user</code></td><td class="align_left">Return the User object associated with the micropost.</td></tr><tr><td class="align_left"><code>user.microposts</code></td><td class="align_left">Return an array of the user&rsquo;s microposts.</td></tr><tr><td class="align_left"><code>user.microposts.create(arg)</code></td><td class="align_left">Create a micropost (<code>user_id = user.id</code>).</td></tr><tr><td class="align_left"><code>user.microposts.create!(arg)</code></td><td class="align_left">Create a micropost (exception on failure).</td></tr><tr><td class="align_left"><code>user.microposts.build(arg)</code></td><td class="align_left">Return a new Micropost object (<code>user_id = user.id</code>).</td></tr></table></div><div class="caption"><span class="header">Table 11.1: </span><span class="description">A summary of user/micropost association methods.</span></div></div>




<div class="label" id="sec:ordering_and_dependency"></div>


<h3><a id="sec:11.1.3" href="user-microposts#sec:ordering_and_dependency" class="heading"><span class="number">11.1.3</span> Micropost refinements</a></h3>


<p>The test in <a class="ref" href="user-microposts#code:user_has_many_microposts_spec">Listing&nbsp;11.5</a> of the <code>has_many</code> association doesn&rsquo;t test for much&mdash;it merely verifies the <em>existence</em> of a <code>microposts</code> attribute. In this section, we&rsquo;ll add <em>ordering</em> and <em>dependency</em> to microposts, while also testing that the <code>user.microposts</code> method actually returns an array of microposts.</p>

<p>We will need to construct some microposts in the User model spec, which means that we should make a micropost factory at this point. To do this, we need a way to make an association in Factory Girl. Happily, this is easy&mdash;we just use the Factory Girl method <code>micropost.association</code>, as seen in <a class="ref" href="user-microposts#code:micropost_factory">Listing&nbsp;11.8</a>.<sup class="footnote" id="fnref:11.3"><a href="#fn:11.3">3</a></sup></p>

<div class="label" id="code:micropost_factory"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.8.</span> <span class="description">The complete factory file, including a new factory for microposts. <br /> <code>spec/factories.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="c1"># By using the symbol &#39;:user&#39;, we get Factory Girl to simulate the User model.</span>
<span class="no">Factory</span><span class="o">.</span><span class="n">define</span> <span class="ss">:user</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
  <span class="n">user</span><span class="o">.</span><span class="n">name</span>                  <span class="s2">&quot;Michael Hartl&quot;</span>
  <span class="n">user</span><span class="o">.</span><span class="n">email</span>                 <span class="s2">&quot;mhartl@example.com&quot;</span>
  <span class="n">user</span><span class="o">.</span><span class="n">password</span>              <span class="s2">&quot;foobar&quot;</span>
  <span class="n">user</span><span class="o">.</span><span class="n">password_confirmation</span> <span class="s2">&quot;foobar&quot;</span>
<span class="k">end</span>

<span class="no">Factory</span><span class="o">.</span><span class="n">sequence</span> <span class="ss">:email</span> <span class="k">do</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span>
  <span class="s2">&quot;person-</span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">@example.com&quot;</span>
<span class="k">end</span>

<span class="no">Factory</span><span class="o">.</span><span class="n">define</span> <span class="ss">:micropost</span> <span class="k">do</span> <span class="o">|</span><span class="n">micropost</span><span class="o">|</span>
  <span class="n">micropost</span><span class="o">.</span><span class="n">content</span> <span class="s2">&quot;Foo bar&quot;</span>
  <span class="n">micropost</span><span class="o">.</span><span class="n">association</span> <span class="ss">:user</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="sec:default_scope"></div>


<h4><a id="sec:11.1.3.1" href="user-microposts#sec:default_scope" class="heading">Default scope</a></h4>


<p>We can put the micropost factory to work in a test for the ordering of microposts. By default, using <code>user.microposts</code> to pull a user&rsquo;s microposts from the database makes no guarantees about the order of the posts, but (following the convention of blogs and Twitter) we want the microposts to come out in reverse order of when they were created, i.e., most recent first. To test this ordering, we first create a couple of microposts as follows:</p>

<div class="code"><div class="highlight"><pre>  <span class="vi">@mp1</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">:created_at</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
  <span class="vi">@mp2</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">:created_at</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
</pre></div>
</div>


<p>Here we indicate that the second post was created more recently, <code>1.hour.ago</code>, with the first post created <code>1.day.ago</code>. Note how convenient the use of Factory Girl is: not only can we assign the user using mass assignment (since factories bypass <code>attr_accessible</code>), we can also set <code>created_at</code> manually, which Active Record won&rsquo;t allow us to do.<sup class="footnote" id="fnref:11.4"><a href="#fn:11.4">4</a></sup></p>

<p>Most database adapters (including the one for SQLite) return the microposts in order of their ids, so we can arrange for an initial test that almost certainly fails using the code in <a class="ref" href="user-microposts#code:micropost_ordering_test">Listing&nbsp;11.9</a>.</p>

<div class="label" id="code:micropost_ordering_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.9.</span> <span class="description">Testing the order of a user&rsquo;s microposts. <br /> <code>spec/models/user_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;micropost associations&quot;</span> <span class="k">do</span>

    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="vi">@attr</span><span class="p">)</span>
      <span class="vi">@mp1</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">:created_at</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
      <span class="vi">@mp2</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">:created_at</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should have a microposts attribute&quot;</span> <span class="k">do</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:microposts</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should have the right microposts in the right order&quot;</span> <span class="k">do</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="o">[</span><span class="vi">@mp2</span><span class="p">,</span> <span class="vi">@mp1</span><span class="o">]</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>The key line here is</p>

<div class="code"><div class="highlight"><pre><span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="o">[</span><span class="vi">@mp2</span><span class="p">,</span> <span class="vi">@mp1</span><span class="o">]</span>
</pre></div>
</div>


<p>indicating that the posts should be ordered newest first. This should fail because by default the posts will be ordered by&nbsp;id, i.e., <code>[@mp1, @mp2]</code>. This test also verifies the basic correctness of the <code>has_many</code> association itself, by checking (as indicated in <a class="ref" href="user-microposts#table:association_methods">Table&nbsp;11.1</a>) that <code>user.microposts</code> is an array of microposts.</p>

<p>To get the ordering test to pass, we use a Rails facility called <code>default_scope</code> with an <code>:order</code> parameter, as shown in <a class="ref" href="user-microposts#code:micropost_ordering">Listing&nbsp;11.10</a>. (This is our first example of the notion of <em>scope</em>. We will learn about scope in a more general context in <a class="ref" href="following-users#top">Chapter&nbsp;12</a>.)</p>

<div class="label" id="code:micropost_ordering"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.10.</span> <span class="description">Ordering the microposts with <code>default_scope</code>.  <br /> <code>app/models/micropost.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">default_scope</span> <span class="ss">:order</span> <span class="o">=&gt;</span> <span class="s1">&#39;microposts.created_at DESC&#39;</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>The order here is <code>&rsquo;microposts.created_at DESC&rsquo;</code>, where <code>DESC</code> is SQL for &ldquo;descending&rdquo;, i.e., in descending order from newest to oldest.</p>

<div class="label" id="sec:dependent_destroy"></div>


<h4><a id="sec:11.1.3.2" href="user-microposts#sec:dependent_destroy" class="heading">Dependent: destroy</a></h4>


<p>Apart from proper ordering, there is a second refinement we&rsquo;d like to add to microposts. Recall from <a class="ref" href="updating-showing-and-deleting-users#sec:destroying_users">Section&nbsp;10.4</a> that site administrators have the power to <em>destroy</em> users. It stands to reason that if a user is destroyed, the user&rsquo;s microposts should be destroyed as well. We can test for this by first destroying a micropost&rsquo;s user and then verifying that the associated microposts are no longer in the database (<a class="ref" href="user-microposts#code:micropost_dependency_test">Listing&nbsp;11.11</a>).</p>

<div class="label" id="code:micropost_dependency_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.11.</span> <span class="description">Testing that microposts are destroyed when users are. <br /> <code>spec/models/user_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;micropost associations&quot;</span> <span class="k">do</span>

    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="vi">@attr</span><span class="p">)</span>
      <span class="vi">@mp1</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">:created_at</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
      <span class="vi">@mp2</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">:created_at</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">it</span> <span class="s2">&quot;should destroy associated microposts&quot;</span> <span class="k">do</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">destroy</span>
      <span class="o">[</span><span class="vi">@mp1</span><span class="p">,</span> <span class="vi">@mp2</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">micropost</span><span class="o">|</span>
        <span class="no">Micropost</span><span class="o">.</span><span class="n">find_by_id</span><span class="p">(</span><span class="n">micropost</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="n">be_nil</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Here we have used <code>Micropost.find_by_id</code>, which returns <code>nil</code> if the record is not found, whereas <code>Micropost.find</code> raises an exception on failure, which is a bit harder to test for. (In case you&rsquo;re curious,</p>

<div class="code"><div class="highlight"><pre><span class="nb">lambda</span> <span class="k">do</span> 
  <span class="no">Micropost</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">micropost</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<span class="k">end</span><span class="o">.</span><span class="n">should</span> <span class="n">raise_error</span><span class="p">(</span><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">RecordNotFound</span><span class="p">)</span>
</pre></div>
</div>


<p>does the trick in this case.)</p>

<p>The application code to get <a class="ref" href="user-microposts#code:micropost_dependency_test">Listing&nbsp;11.11</a> to pass is less than one line; in fact, it&rsquo;s just an option to the <code>has_many</code> association method, as shown in <a class="ref" href="user-microposts#code:micropost_dependency">Listing&nbsp;11.12</a>.</p>

<div class="label" id="code:micropost_dependency"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.12.</span> <span class="description">Ensuring that a user&rsquo;s microposts are destroyed along with the user. <br /> <code>app/models/user.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">has_many</span> <span class="ss">:microposts</span><span class="p">,</span> <span class="ss">:dependent</span> <span class="o">=&gt;</span> <span class="ss">:destroy</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>With that, the final form of the user/micropost association is in place.</p>

<div class="label" id="sec:micropost_validations"></div>


<h3><a id="sec:11.1.4" href="user-microposts#sec:micropost_validations" class="heading"><span class="number">11.1.4</span> Micropost validations</a></h3>


<p>Before leaving the Micropost model, we&rsquo;ll tie off a couple of loose ends by adding validations (following the example from <a class="ref" href="a-demo-app#sec:putting_the_micro_in_microposts">Section&nbsp;2.3.2</a>). Both the <code>user_id</code> and <code>content</code> attributes are required, and <code>content</code> is further constrained to be no longer than 140 characters, which we test for using the code in <a class="ref" href="user-microposts#code:micropost_validations_tests">Listing&nbsp;11.13</a>.</p>

<div class="label" id="code:micropost_validations_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.13.</span> <span class="description">Tests for the Micropost model validations. <br /> <code>spec/models/micropost_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">Micropost</span> <span class="k">do</span>

  <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
    <span class="vi">@attr</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="s2">&quot;value for content&quot;</span> <span class="p">}</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;validations&quot;</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">&quot;should require a user id&quot;</span> <span class="k">do</span>
      <span class="no">Micropost</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@attr</span><span class="p">)</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_valid</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should require nonblank content&quot;</span> <span class="k">do</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="ss">:content</span> <span class="o">=&gt;</span> <span class="s2">&quot;  &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_valid</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should reject long content&quot;</span> <span class="k">do</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="ss">:content</span> <span class="o">=&gt;</span> <span class="s2">&quot;a&quot;</span> <span class="o">*</span> <span class="mi">141</span><span class="p">)</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_valid</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>These generally follow the examples from the User model validation tests from <a class="ref" href="modeling-and-viewing-users-one#sec:user_validations">Section&nbsp;6.2</a>. (The analogous tests were broken into multiple lines in that section, but you should be comfortable enough reading RSpec code by now to digest the more compact formulation above.)</p>

<p>As in <a class="ref" href="modeling-and-viewing-users-one#sec:user_validations">Section&nbsp;6.2</a>, the code in <a class="ref" href="user-microposts#code:micropost_validations_tests">Listing&nbsp;11.13</a> uses string multiplication to test the micropost length validation:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails console
<span class="gp">&gt;</span>&gt; <span class="s2">&quot;a&quot;</span> * 10
<span class="go">=&gt; &quot;aaaaaaaaaa&quot;</span>
<span class="gp">&gt;</span>&gt; <span class="s2">&quot;a&quot;</span> * 141
<span class="go">=&gt; &quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa</span>
<span class="go">aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;</span>
</pre></div>
</div>


<p>In contrast, instead of using the default&nbsp;<code>new</code> constructor as in</p>

<div class="code"><div class="highlight"><pre><span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="p">)</span>
</pre></div>
</div>


<p>the code in <a class="ref" href="user-microposts#code:micropost_validations_tests">Listing&nbsp;11.13</a> uses the <code>build</code> method:</p>

<div class="code"><div class="highlight"><pre><span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span>
</pre></div>
</div>


<p>Recall from <a class="ref" href="user-microposts#table:association_methods">Table&nbsp;11.1</a> that this is essentially equivalent to <code>Micropost.new</code>, except that it automatically sets the micropost&rsquo;s <code>user_id</code> to <code>@user.id</code>.</p>

<p>The validations themselves are straightforward analogues of the User model validations, as seen in <a class="ref" href="user-microposts#code:micropost_validations">Listing&nbsp;11.14</a>.</p>

<div class="label" id="code:micropost_validations"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.14.</span> <span class="description">The Micropost model validations. <br /> <code>app/models/micropost.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:content</span>

  <span class="n">belongs_to</span> <span class="ss">:user</span>

  <span class="n">validates</span> <span class="ss">:content</span><span class="p">,</span> <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">:length</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:maximum</span> <span class="o">=&gt;</span> <span class="mi">140</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="ss">:user_id</span><span class="p">,</span> <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span>

  <span class="n">default_scope</span> <span class="ss">:order</span> <span class="o">=&gt;</span> <span class="s1">&#39;microposts.created_at DESC&#39;</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>This completes the data modeling for users and microposts. It&rsquo;s time now to build the web interface.</p>

<div class="label" id="sec:showing_microposts"></div>


<h2><a id="sec:11.2" href="user-microposts#sec:showing_microposts" class="heading"><span class="number">11.2</span> Showing microposts</a></h2>


<p>Although we don&rsquo;t yet have a way to create microposts through the web&mdash;that comes in <a class="ref" href="user-microposts#sec:creating_microposts">Section&nbsp;11.3.2</a>&mdash;that won&rsquo;t stop us from displaying them (and testing that display). Following Twitter&rsquo;s lead, we&rsquo;ll plan to display a user&rsquo;s microposts not on a separate microposts <code>index</code> page, but rather directly on the user <code>show</code> page itself, as mocked up in <a class="ref" href="user-microposts#fig:user_microposts_mockup">Figure&nbsp;11.4</a>. We&rsquo;ll start with fairly simple ERb templates for adding a micropost display to the user profile, and then we&rsquo;ll add microposts to the sample data populator from <a class="ref" href="updating-showing-and-deleting-users#sec:sample_users">Section&nbsp;10.3.2</a> so that we have something to display.</p>

<div class="label" id="fig:user_microposts_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_microposts_mockup.png" alt="user_microposts_mockup" /></span></div><div class="caption"><span class="header">Figure 11.4: </span><span class="description">A mockup of a profile page with microposts.&nbsp;<a href="http://railstutorial.org/images/figures/user_microposts_mockup-full.png">(full size)</a></span></div></div>


<p>As with the discussion of the signin machinery in <a class="ref" href="sign-in-sign-out#sec:remember_me">Section&nbsp;9.3.2</a>, <a class="ref" href="user-microposts#sec:augmenting_the_user_show_page">Section&nbsp;11.2.1</a> will often push several elements onto the <a href="http://en.wikipedia.org/wiki/Stack_(data_structure)">stack</a> at a time, and then pop them off one by one. If you start getting bogged down, be patient; there&rsquo;s some nice payoff in <a class="ref" href="user-microposts#sec:sample_microposts">Section&nbsp;11.2.2</a>.</p>

<div class="label" id="sec:augmenting_the_user_show_page"></div>


<h3><a id="sec:11.2.1" href="user-microposts#sec:augmenting_the_user_show_page" class="heading"><span class="number">11.2.1</span> Augmenting the user show page</a></h3>


<p>We begin with a test for displaying the user&rsquo;s microposts. We work in the Users controller spec, since it is the Users controller that contains the user <code>show</code> action. Our strategy is to create a couple of factory microposts associated with the user, and then verify that the show page has a <code>span</code> tag with CSS class <code>"content"</code> containing each post&rsquo;s content. The resulting RSpec example appears in <a class="ref" href="user-microposts#code:user_show_microposts_test">Listing&nbsp;11.15</a>.</p>

<div class="label" id="code:user_show_microposts_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.15.</span> <span class="description">A test for showing microposts on the user <code>show</code> page. <br /> <code>spec/controllers/users_controller_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">UsersController</span> <span class="k">do</span>
  <span class="n">render_views</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;GET &#39;show&#39;&quot;</span> <span class="k">do</span>

    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">it</span> <span class="s2">&quot;should show the user&#39;s microposts&quot;</span> <span class="k">do</span>
      <span class="n">mp1</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="s2">&quot;Foo bar&quot;</span><span class="p">)</span>
      <span class="n">mp2</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="s2">&quot;Baz quux&quot;</span><span class="p">)</span>
      <span class="n">get</span> <span class="ss">:show</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="vi">@user</span>
      <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;span.content&quot;</span><span class="p">,</span> <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="n">mp1</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
      <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;span.content&quot;</span><span class="p">,</span> <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="n">mp2</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Although these tests won&rsquo;t pass until <a class="ref" href="user-microposts#code:micropost_partial">Listing&nbsp;11.17</a>, we&rsquo;ll get started on the application code by inserting a table of microposts into the user profile page, as shown in <a class="ref" href="user-microposts#code:user_show_microposts">Listing&nbsp;11.16</a>.<sup class="footnote" id="fnref:11.5"><a href="#fn:11.5">5</a></sup></p>

<div class="label" id="code:user_show_microposts"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.16.</span> <span class="description">Adding microposts to the user <code>show</code> page. <br /> <code>app/views/users/show.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;table</span> <span class="na">class=</span><span class="s">&quot;profile&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;tr&gt;</span>
    <span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">&quot;main&quot;</span><span class="nt">&gt;</span>
      .
      .
      .
      <span class="cp">&lt;%</span> <span class="k">unless</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">empty?</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;table</span> <span class="na">class=</span><span class="s">&quot;microposts&quot;</span> <span class="na">summary=</span><span class="s">&quot;User microposts&quot;</span><span class="nt">&gt;</span>
          <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@microposts</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;/table&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="vi">@microposts</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">&quot;sidebar round&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;strong&gt;</span>Name<span class="nt">&lt;/strong&gt;</span> <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span><span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;strong&gt;</span>URL<span class="nt">&lt;/strong&gt;</span> <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">),</span> <span class="vi">@user</span> <span class="cp">%&gt;</span><span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;strong&gt;</span>Microposts<span class="nt">&lt;/strong&gt;</span> <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">count</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/td&gt;</span>
  <span class="nt">&lt;/tr&gt;</span>
<span class="nt">&lt;/table&gt;</span>
</pre></div>
</div></div>


<p>We&rsquo;ll deal with the microposts <code>table</code> momentarily, but there are several other things to note first. One new idea is the use of <code>empty?</code> in the line</p>

<div class="code"><div class="highlight"><pre><span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">empty?</span>
</pre></div>
</div>


<p>This applies the <code>empty?</code> method, seen before in the context of strings (e.g., <a class="ref" href="rails-flavored-ruby#sec:objects_and_message_passing">Section&nbsp;4.2.3</a>), to an array:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">].</span><span class="n">empty?</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="o">[].</span><span class="n">empty?</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p>By using the conditional <code>unless</code> clause,</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">unless</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">empty?</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>we make sure that an empty table won&rsquo;t be displayed when the user has no microposts.</p>

<p>You&rsquo;ll also note from <a class="ref" href="user-microposts#code:user_show_microposts">Listing&nbsp;11.16</a> that we&rsquo;ve preemptively added pagination for microposts through</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="vi">@microposts</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>If you compare this with the analogous line on the user index page, <a class="ref" href="updating-showing-and-deleting-users#code:will_paginate_index_view">Listing&nbsp;10.27</a>, you&rsquo;ll see that before we had just</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>This worked because, in the context of the Users controller, <code>will_paginate</code> <em>assumes</em> the existence of an instance variable called <code>@users</code> (which, as we saw in <a class="ref" href="updating-showing-and-deleting-users#sec:pagination">Section&nbsp;10.3.3</a>, should be of class <code>WillPaginate::Collection</code>). In the present case, since we are still in the Users controller but want to paginate <em>microposts</em> instead, we pass an explicit <code>@microposts</code> variable to <code>will_paginate</code>. Of course, this means that we will have to define such a variable in the user <code>show</code> action (<a class="ref" href="user-microposts#code:user_show_microposts_instance">Listing&nbsp;11.18</a> below).</p>

<p>Finally, note that we have taken this opportunity to add a count of the current number of microposts to the profile sidebar:</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">&quot;sidebar round&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;strong&gt;</span>Name<span class="nt">&lt;/strong&gt;</span> <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span><span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;strong&gt;</span>URL<span class="nt">&lt;/strong&gt;</span> <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">),</span> <span class="vi">@user</span> <span class="cp">%&gt;</span><span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;strong&gt;</span>Microposts<span class="nt">&lt;/strong&gt;</span> <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">count</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/td&gt;</span>
</pre></div>
</div>


<p>Here <code>@user.microposts.count</code> is the analogue of the <code>User.count</code> method, except that it counts the microposts belonging to a given user through the user/micropost association.<sup class="footnote" id="fnref:11.6"><a href="#fn:11.6">6</a></sup></p>

<p>Now for the microposts <code>table</code> itself:</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;table</span> <span class="na">class=</span><span class="s">&quot;microposts&quot;</span> <span class="na">summary=</span><span class="s">&quot;User microposts&quot;</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@microposts</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/table&gt;</span>
</pre></div>
</div>


<p>This code is responsible for generating the table of microposts, but you can see that it just defers the heavy lifting to a micropost partial. We saw in <a class="ref" href="updating-showing-and-deleting-users#sec:partial_refactoring">Section&nbsp;10.3.4</a> that the code</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@users</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>automatically renders each of the users in the <code>@users</code> variable using the <code>_user.html.erb</code> partial. Similarly, the code</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@microposts</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>does exactly the same thing for microposts. This means that we must define a <code>_micropost.html.erb</code> partial (along with a <code>micropost</code> views directory), as shown in <a class="ref" href="user-microposts#code:micropost_partial">Listing&nbsp;11.17</a>.</p>

<div class="label" id="code:micropost_partial"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.17.</span> <span class="description">A partial for showing a single micropost. <br /> <code>app/views/microposts/_micropost.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;tr&gt;</span>
  <span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">&quot;micropost&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;content&quot;</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">micropost</span><span class="o">.</span><span class="n">content</span> <span class="cp">%&gt;</span><span class="nt">&lt;/span&gt;</span>
    <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;timestamp&quot;</span><span class="nt">&gt;</span>
      Posted <span class="cp">&lt;%=</span> <span class="n">time_ago_in_words</span><span class="p">(</span><span class="n">micropost</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span> <span class="cp">%&gt;</span> ago.
    <span class="nt">&lt;/span&gt;</span>
  <span class="nt">&lt;/td&gt;</span>
<span class="nt">&lt;/tr&gt;</span>
</pre></div>
</div></div>


<p>This uses the awesome <code>time_ago_in_words</code> helper method, whose effect we will see in <a class="ref" href="user-microposts#sec:sample_microposts">Section&nbsp;11.2.2</a>.</p>

<p>Thus far, despite defining all the relevant ERb templates, the test in <a class="ref" href="user-microposts#code:user_show_microposts_test">Listing&nbsp;11.15</a> should have been failing for want of an <code>@microposts</code> variable. We can get it to pass with <a class="ref" href="user-microposts#code:user_show_microposts_instance">Listing&nbsp;11.18</a>.</p>

<div class="label" id="code:user_show_microposts_instance"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.18.</span> <span class="description">Adding an <code>@microposts</code> instance variable to the user <code>show</code> action. <br /> <code>app/controllers/users_controller.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">show</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
    <span class="vi">@microposts</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">:page</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">)</span>
    <span class="vi">@title</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Notice here how clever <code>paginate</code> is&mdash;it even works with the microposts association, converting the array into a <code>WillPaginate::Collection</code> object on the fly.</p>

<p>Upon adding the CSS from <a class="ref" href="user-microposts#code:micropost_css">Listing&nbsp;11.19</a> to our <code>custom.css</code> stylesheet,<sup class="footnote" id="fnref:11.7"><a href="#fn:11.7">7</a></sup> we can get a look at our new user profile page in <a class="ref" href="user-microposts#fig:user_profile_no_microposts">Figure&nbsp;11.5</a>. It&rsquo;s rather&hellip; disappointing. Of course, this is because there are not currently any microposts. It&rsquo;s time to change that.</p>

<div class="label" id="code:micropost_css"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.19.</span> <span class="description">The CSS for microposts (includes all the CSS for this chapter). <br /> <code>public/stylesheets/custom.css</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="nt">h1</span><span class="nc">.micropost</span> <span class="p">{</span>
  <span class="k">margin-bottom</span><span class="o">:</span> <span class="m">0.3em</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">table</span><span class="nc">.microposts</span> <span class="p">{</span>
  <span class="k">margin-top</span><span class="o">:</span> <span class="m">1em</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">table</span><span class="nc">.microposts</span> <span class="nt">tr</span> <span class="p">{</span>
  <span class="k">height</span><span class="o">:</span> <span class="m">70px</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">table</span><span class="nc">.microposts</span> <span class="nt">tr</span> <span class="nt">td</span><span class="nc">.gravatar</span> <span class="p">{</span>
  <span class="k">border-top</span><span class="o">:</span> <span class="m">1px</span> <span class="k">solid</span> <span class="m">#ccc</span><span class="p">;</span>
  <span class="k">vertical-align</span><span class="o">:</span> <span class="k">top</span><span class="p">;</span>
  <span class="k">width</span><span class="o">:</span> <span class="m">50px</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">table</span><span class="nc">.microposts</span> <span class="nt">tr</span> <span class="nt">td</span><span class="nc">.micropost</span> <span class="p">{</span>
  <span class="k">border-top</span><span class="o">:</span> <span class="m">1px</span> <span class="k">solid</span> <span class="m">#ccc</span><span class="p">;</span>
  <span class="k">vertical-align</span><span class="o">:</span> <span class="k">top</span><span class="p">;</span>
  <span class="k">padding-top</span><span class="o">:</span> <span class="m">10px</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">table</span><span class="nc">.microposts</span> <span class="nt">tr</span> <span class="nt">td</span><span class="nc">.micropost</span> <span class="nt">span</span><span class="nc">.timestamp</span> <span class="p">{</span>
  <span class="k">display</span><span class="o">:</span> <span class="k">block</span><span class="p">;</span>
  <span class="k">font-size</span><span class="o">:</span> <span class="m">85%</span><span class="p">;</span>
  <span class="k">color</span><span class="o">:</span> <span class="m">#666</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">div</span><span class="nc">.user_info</span> <span class="nt">img</span> <span class="p">{</span>
  <span class="k">padding-right</span><span class="o">:</span> <span class="m">0.1em</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">div</span><span class="nc">.user_info</span> <span class="nt">a</span> <span class="p">{</span>
  <span class="k">text-decoration</span><span class="o">:</span> <span class="k">none</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">div</span><span class="nc">.user_info</span> <span class="nt">span</span><span class="nc">.user_name</span> <span class="p">{</span>
  <span class="k">position</span><span class="o">:</span> <span class="k">absolute</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">div</span><span class="nc">.user_info</span> <span class="nt">span</span><span class="nc">.microposts</span> <span class="p">{</span>
  <span class="k">font-size</span><span class="o">:</span> <span class="m">80%</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">form</span><span class="nc">.new_micropost</span> <span class="p">{</span>
  <span class="k">margin-bottom</span><span class="o">:</span> <span class="m">2em</span><span class="p">;</span>
<span class="p">}</span>

<span class="nt">form</span><span class="nc">.new_micropost</span> <span class="nt">textarea</span> <span class="p">{</span>
  <span class="k">height</span><span class="o">:</span> <span class="m">4em</span><span class="p">;</span>
  <span class="k">margin-bottom</span><span class="o">:</span> <span class="m">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div></div>




<div class="label" id="fig:user_profile_no_microposts"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_profile_no_microposts.png" alt="user_profile_no_microposts" /></span></div><div class="caption"><span class="header">Figure 11.5: </span><span class="description">The user profile page with code for microposts&mdash;but no microposts.&nbsp;<a href="http://railstutorial.org/images/figures/user_profile_no_microposts-full.png">(full size)</a></span></div></div>




<div class="label" id="sec:sample_microposts"></div>


<h3><a id="sec:11.2.2" href="user-microposts#sec:sample_microposts" class="heading"><span class="number">11.2.2</span> Sample microposts</a></h3>


<p>With all the work making templates for user microposts in <a class="ref" href="user-microposts#sec:augmenting_the_user_show_page">Section&nbsp;11.2.1</a>, the ending was rather anticlimactic. We can rectify this sad situation by adding microposts to the sample populator from <a class="ref" href="updating-showing-and-deleting-users#sec:sample_users">Section&nbsp;10.3.2</a>. Adding sample microposts for <em>all</em> the users actually takes a rather long time, so first we&rsquo;ll select just the first six users<sup class="footnote" id="fnref:11.8"><a href="#fn:11.8">8</a></sup> using the <code>:limit</code> option to the <code>User.all</code> method:<sup class="footnote" id="fnref:11.9"><a href="#fn:11.9">9</a></sup></p>

<div class="code"><div class="highlight"><pre><span class="no">User</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="ss">:limit</span> <span class="o">=&gt;</span> <span class="mi">6</span><span class="p">)</span>
</pre></div>
</div>


<p>We then make 50 microposts for each user (plenty to overflow the pagination limit of&nbsp;30), generating sample content for each micropost using the Faker gem&rsquo;s handy <a href="http://faker.rubyforge.org/rdoc/classes/Faker/Lorem.html"><tt>Lorem.sentence</tt> method</a>. (<code>Faker::Lorem.sentence</code> returns <em>lorem ipsum</em> text; as noted in <a class="ref" href="modeling-and-viewing-users-one#top">Chapter&nbsp;6</a>, <em>lorem ipsum</em> has a <a href="http://www.straightdope.com/columns/read/2290/what-does-the-filler-text-lorem-ipsum-mean">fascinating back story</a>.) The result is the new sample data populator shown in <a class="ref" href="user-microposts#code:sample_microposts">Listing&nbsp;11.20</a>.</p>

<div class="label" id="code:sample_microposts"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.20.</span> <span class="description">Adding microposts to the sample data. <br /> <code>lib/tasks/sample_data.rake</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;faker&#39;</span>

<span class="n">namespace</span> <span class="ss">:db</span> <span class="k">do</span>
  <span class="n">desc</span> <span class="s2">&quot;Fill database with sample data&quot;</span>
  <span class="n">task</span> <span class="ss">:populate</span> <span class="o">=&gt;</span> <span class="ss">:environment</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="no">User</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="ss">:limit</span> <span class="o">=&gt;</span> <span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
      <span class="mi">50</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span>
        <span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">:content</span> <span class="o">=&gt;</span> <span class="no">Faker</span><span class="o">::</span><span class="no">Lorem</span><span class="o">.</span><span class="n">sentence</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Of course, to generate the new sample data we have to run the <code>db:populate</code> Rake task:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rake db:populate
</pre></div>
</div>


<p>With that, we are in a position to enjoy the fruits of our <a class="ref" href="user-microposts#sec:augmenting_the_user_show_page">Section&nbsp;11.2.1</a> labors by displaying information for each micropost.<sup class="footnote" id="fnref:11.10"><a href="#fn:11.10">10</a></sup> <a class="ref" href="user-microposts#fig:user_profile_with_microposts">Figure&nbsp;11.6</a> shows the user profile page for the first (signed-in) user, while <a class="ref" href="user-microposts#fig:other_profile_with_microposts">Figure&nbsp;11.7</a> shows the profile for a second user. Finally, <a class="ref" href="user-microposts#fig:user_profile_microposts_page_2_rails_3">Figure&nbsp;11.8</a> shows the <em>second</em> page of microposts for the first user, along with the pagination links at the bottom of the display. In all three cases, observe that each micropost display indicates the time since it was created (e.g., &ldquo;Posted 1 minute ago.&rdquo;); this is the work of the <code>time_ago_in_words</code> method from <a class="ref" href="user-microposts#code:micropost_partial">Listing&nbsp;11.17</a>. If you wait a couple minutes and reload the pages, you&rsquo;ll see how the text gets automatically updated based on the new time.</p>

<div class="label" id="fig:user_profile_with_microposts"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_profile_with_microposts.png" alt="user_profile_with_microposts" /></span></div><div class="caption"><span class="header">Figure 11.6: </span><span class="description">The user profile (<a href="http://localhost:3000/users/1"><tt>/users/1</tt></a>) with microposts.&nbsp;<a href="http://railstutorial.org/images/figures/user_profile_with_microposts-full.png">(full size)</a></span></div></div>




<div class="label" id="fig:other_profile_with_microposts"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/other_profile_with_microposts.png" alt="other_profile_with_microposts" /></span></div><div class="caption"><span class="header">Figure 11.7: </span><span class="description">The profile of a different user, also with microposts (<a href="http://localhost:3000/users/3"><tt>/users/3</tt></a>).&nbsp;<a href="http://railstutorial.org/images/figures/other_profile_with_microposts-full.png">(full size)</a></span></div></div>




<div class="label" id="fig:user_profile_microposts_page_2_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_profile_microposts_page_2_rails_3.png" alt="user_profile_microposts_page_2_rails_3" /></span></div><div class="caption"><span class="header">Figure 11.8: </span><span class="description">A second of profile microposts, with pagination links (<a href="http://localhost:3000/users/1?page=2"><tt>/users/1?page=2</tt></a>).&nbsp;<a href="http://railstutorial.org/images/figures/user_profile_microposts_page_2_rails_3-full.png">(full size)</a></span></div></div>




<div class="label" id="sec:manipulating_microposts"></div>


<h2><a id="sec:11.3" href="user-microposts#sec:manipulating_microposts" class="heading"><span class="number">11.3</span> Manipulating microposts</a></h2>


<p>Having finished both the data modeling and display templates for microposts, we now turn our attention to the interface for creating them through the web. The result will be our third example of using an HTML form to create a resource&mdash;in this case, a Microposts resource.<sup class="footnote" id="fnref:11.11"><a href="#fn:11.11">11</a></sup> In this section, we&rsquo;ll also see the first hint of a <em>status feed</em>&mdash;a notion brought to full fruition in <a class="ref" href="following-users#top">Chapter&nbsp;12</a>. Finally, as with users, we&rsquo;ll make it possible to destroy microposts through the web.</p>

<p>There is one break with past convention worth noting: the interface to the Microposts resource will run principally through the Users and Pages controllers, rather than relying on a controller of its own. This means that the routes for the Microposts resource are unusually simple, as seen in <a class="ref" href="user-microposts#code:microposts_resource">Listing&nbsp;11.21</a>. The code in <a class="ref" href="user-microposts#code:microposts_resource">Listing&nbsp;11.21</a> leads in turn to the RESTful routes show in <a class="ref" href="user-microposts#table:RESTful_microposts">Table&nbsp;11.2</a>, which is a small subset of the full set of routes seen in <a class="ref" href="a-demo-app#table:demo_RESTful_microposts">Table&nbsp;2.3</a>. Of course, this simplicity is a sign of being <em>more</em> advanced, not less&mdash;we&rsquo;ve come a long way since our reliance on scaffolding in <a class="ref" href="a-demo-app#top">Chapter&nbsp;2</a>, and we no longer need most of its complexity.</p>

<div class="label" id="code:microposts_resource"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.21.</span> <span class="description">Routes for the Microposts resource. <br /> <code>config/routes.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="no">SampleApp</span><span class="o">::</span><span class="no">Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">resources</span> <span class="ss">:users</span>
  <span class="n">resources</span> <span class="ss">:sessions</span><span class="p">,</span>   <span class="ss">:only</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:new</span><span class="p">,</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
  <span class="n">resources</span> <span class="ss">:microposts</span><span class="p">,</span> <span class="ss">:only</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="table:RESTful_microposts"></div>


<div class="table"><div class="center"><table class="tabular"><tr><th class="align_left"><strong>HTTP request</strong></th><th class="align_left"><strong>URL</strong></th><th class="align_left"><strong>Action</strong></th><th class="align_left"><strong>Purpose</strong></th></tr><tr class="top_bar"><td class="align_left"><tt>POST</tt></td><td class="align_left"><tt>/microposts</tt></td><td class="align_left"><code>create</code></td><td class="align_left">create a new micropost</td></tr><tr><td class="align_left"><tt>DELETE</tt></td><td class="align_left"><tt>/microposts/1</tt></td><td class="align_left"><code>destroy</code></td><td class="align_left">delete micropost with id <code>1</code></td></tr></table></div><div class="caption"><span class="header">Table 11.2: </span><span class="description">RESTful routes provided by the Microposts resource in <a class="ref" href="user-microposts#code:microposts_resource">Listing&nbsp;11.21</a>.</span></div></div>




<div class="label" id="sec:access_control"></div>


<h3><a id="sec:11.3.1" href="user-microposts#sec:access_control" class="heading"><span class="number">11.3.1</span> Access control</a></h3>


<p>We begin our development of the Microposts resource with some access control in the Microposts controller. The idea is simple: both the <code>create</code> and <code>destroy</code> actions should require users to be signed in. The RSpec code to test for this appears in <a class="ref" href="user-microposts#code:micropost_access_control">Listing&nbsp;11.22</a>, which will require creating the Microposts controller spec file. (We&rsquo;ll test for and add a third protection&mdash;ensuring that only a micropost&rsquo;s user can destroy it&mdash;in <a class="ref" href="user-microposts#sec:destroying_microposts">Section&nbsp;11.3.4</a>.)</p>

<div class="label" id="code:micropost_access_control"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.22.</span> <span class="description">Access control tests for the Microposts controller. <br /> <code>spec/controllers/microposts_controller_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">MicropostsController</span> <span class="k">do</span>
  <span class="n">render_views</span>

  <span class="n">describe</span> <span class="s2">&quot;access control&quot;</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">&quot;should deny access to &#39;create&#39;&quot;</span> <span class="k">do</span>
      <span class="n">post</span> <span class="ss">:create</span>
      <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">signin_path</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should deny access to &#39;destroy&#39;&quot;</span> <span class="k">do</span>
      <span class="n">delete</span> <span class="ss">:destroy</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="mi">1</span>
      <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">signin_path</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Writing the application code needed to get the tests in <a class="ref" href="user-microposts#code:micropost_access_control">Listing&nbsp;11.22</a> to pass requires a little refactoring first. Recall from <a class="ref" href="updating-showing-and-deleting-users#sec:requiring_signed_in_users">Section&nbsp;10.2.1</a> that we enforced the signin requirement using a before filter that called the <code>authenticate</code> method (<a class="ref" href="updating-showing-and-deleting-users#code:authenticate_before_filter">Listing&nbsp;10.11</a>). At the time, we only needed <code>authenticate</code> in the Users controller, but now we find that we need it in the Microposts controller as well, so we&rsquo;ll move <code>authenticate</code> into the Sessions helper, as shown in <a class="ref" href="user-microposts#code:sessions_helper_authenticate">Listing&nbsp;11.23</a>.<sup class="footnote" id="fnref:11.12"><a href="#fn:11.12">12</a></sup></p>

<div class="label" id="code:sessions_helper_authenticate"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.23.</span> <span class="description">Moving the <code>authenticate</code> method into the Sessions helper. <br /> <code>app/helpers/sessions_helper.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">SessionsHelper</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">authenticate</span>
    <span class="n">deny_access</span> <span class="k">unless</span> <span class="n">signed_in?</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">deny_access</span>
    <span class="n">store_location</span>
    <span class="n">redirect_to</span> <span class="n">signin_path</span><span class="p">,</span> <span class="ss">:notice</span> <span class="o">=&gt;</span> <span class="s2">&quot;Please sign in to access this page.&quot;</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>(To avoid code repetition, you should also remove <code>authenticate</code> from the Users controller at this time.)</p>

<p>With the code in <a class="ref" href="user-microposts#code:sessions_helper_authenticate">Listing&nbsp;11.23</a>, the <code>authenticate</code> method is now available in the Microposts controller, which means that we can restrict access to the <code>create</code> and <code>destroy</code> actions with the before filter shown in <a class="ref" href="user-microposts#code:microposts_controller_access_control">Listing&nbsp;11.24</a>. (Since we didn&rsquo;t generate it at the command line, you will have to create the Microposts controller file by hand.)</p>

<div class="label" id="code:microposts_controller_access_control"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.24.</span> <span class="description">Adding authentication to the Microposts controller actions. <br /> <code>app/controllers/microposts_controller.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MicropostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:authenticate</span>

  <span class="k">def</span> <span class="nf">create</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Note that we haven&rsquo;t restricted the actions the before filter applies to, since presently it applies to them both. If we were to add, say, an <code>index</code> action accessible even to non-signed-in users, we would need to specify the protected actions explicitly:</p>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MicropostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:authenticate</span><span class="p">,</span> <span class="ss">:only</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>

  <span class="k">def</span> <span class="nf">create</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>




<div class="label" id="sec:creating_microposts"></div>


<h3><a id="sec:11.3.2" href="user-microposts#sec:creating_microposts" class="heading"><span class="number">11.3.2</span> Creating microposts</a></h3>


<p>In <a class="ref" href="sign-up#top">Chapter&nbsp;8</a>, we implemented user signup by making an HTML form that issued an HTTP <tt>POST</tt> request to the <code>create</code> action in the Users controller. The implementation of micropost creation is similar; the main difference is that, rather than using a separate page at <tt>/microposts/new</tt>, we will (following Twitter&rsquo;s convention) put the form on the Home page itself (i.e., the root path&nbsp;<tt>/</tt>), as mocked up in <a class="ref" href="user-microposts#fig:home_page_with_micropost_form_mockup">Figure&nbsp;11.9</a>.</p>

<div class="label" id="fig:home_page_with_micropost_form_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/home_page_with_micropost_form_mockup.png" alt="home_page_with_micropost_form_mockup" /></span></div><div class="caption"><span class="header">Figure 11.9: </span><span class="description">A mockup of the Home page with a form for creating microposts.&nbsp;<a href="http://railstutorial.org/images/figures/home_page_with_micropost_form_mockup-full.png">(full size)</a></span></div></div>


<p>When we last left the Home page, it appeared as in <a class="ref" href="filling-in-the-layout#fig:layout_rounded_corners">Figure&nbsp;5.7</a>&mdash;that is, it had a big, fat &ldquo;Sign up now!&rdquo; button in the middle. Since a micropost creation form only makes sense in the context of a particular signed-in user, one goal of this section will be to serve different versions of the Home page depending on a visitor&rsquo;s signin status. We&rsquo;ll implement this in <a class="ref" href="user-microposts#code:microposts_home_page">Listing&nbsp;11.27</a> below, but for now the only implication is that the tests for the Microposts controller <code>create</code> action should sign a (factory) user in before attempting to make a post.</p>

<p>With that caveat in mind, the micropost creation tests parallel those for user creation from <a class="ref" href="sign-up#code:failing_create_specs">Listing&nbsp;8.6</a> and <a class="ref" href="sign-up#code:signup_success_tests">Listing&nbsp;8.14</a>; the result appears in <a class="ref" href="user-microposts#code:microposts_create_tests">Listing&nbsp;11.25</a>.</p>

<div class="label" id="code:microposts_create_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.25.</span> <span class="description">Tests for the Microposts controller <code>create</code> action. <br /> <code>spec/controllers/microposts_controller_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">MicropostsController</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span> 
  <span class="n">describe</span> <span class="s2">&quot;POST &#39;create&#39;&quot;</span> <span class="k">do</span>

    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="n">test_sign_in</span><span class="p">(</span><span class="no">Factory</span><span class="p">(</span><span class="ss">:user</span><span class="p">))</span>
    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">&quot;failure&quot;</span> <span class="k">do</span>

      <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
        <span class="vi">@attr</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span> <span class="p">}</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should not create a micropost&quot;</span> <span class="k">do</span>
        <span class="nb">lambda</span> <span class="k">do</span>
          <span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:micropost</span> <span class="o">=&gt;</span> <span class="vi">@attr</span>
        <span class="k">end</span><span class="o">.</span><span class="n">should_not</span> <span class="n">change</span><span class="p">(</span><span class="no">Micropost</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should render the home page&quot;</span> <span class="k">do</span>
        <span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:micropost</span> <span class="o">=&gt;</span> <span class="vi">@attr</span>
        <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;pages/home&#39;</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">&quot;success&quot;</span> <span class="k">do</span>

      <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
        <span class="vi">@attr</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="s2">&quot;Lorem ipsum&quot;</span> <span class="p">}</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should create a micropost&quot;</span> <span class="k">do</span>
        <span class="nb">lambda</span> <span class="k">do</span>
          <span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:micropost</span> <span class="o">=&gt;</span> <span class="vi">@attr</span>
        <span class="k">end</span><span class="o">.</span><span class="n">should</span> <span class="n">change</span><span class="p">(</span><span class="no">Micropost</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should redirect to the home page&quot;</span> <span class="k">do</span>
        <span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:micropost</span> <span class="o">=&gt;</span> <span class="vi">@attr</span>
        <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">root_path</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should have a flash message&quot;</span> <span class="k">do</span>
        <span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:micropost</span> <span class="o">=&gt;</span> <span class="vi">@attr</span>
        <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">].</span><span class="n">should</span> <span class="o">=~</span> <span class="sr">/micropost created/i</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>The <code>create</code> action for microposts is similar to its user analogue (<a class="ref" href="sign-up#code:user_create_action">Listing&nbsp;8.15</a>); the principal difference lies in using the user/micropost association to <code>build</code> the new micropost, as seen in <a class="ref" href="user-microposts#code:microposts_create_action">Listing&nbsp;11.26</a>.</p>

<div class="label" id="code:microposts_create_action"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.26.</span> <span class="description">The Microposts controller <code>create</code> action. <br /> <code>app/controllers/microposts_controller.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MicropostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@micropost</span>  <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:micropost</span><span class="o">]</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">save</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Micropost created!&quot;</span>
      <span class="n">redirect_to</span> <span class="n">root_path</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="s1">&#39;pages/home&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>At this point, the tests in <a class="ref" href="user-microposts#code:microposts_create_tests">Listing&nbsp;11.25</a> should all be passing, but of course we still don&rsquo;t have a form to create microposts. We can rectify this with <a class="ref" href="user-microposts#code:microposts_home_page">Listing&nbsp;11.27</a>, which serves up different HTML based on whether the site visitor is signed in or not.</p>

<div class="label" id="code:microposts_home_page"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.27.</span> <span class="description">Adding microposts creation to the Home page (<a href="http://localhost:3000/"><tt>/</tt></a>). <br /> <code>app/views/pages/home.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">signed_in?</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;table</span> <span class="na">class=</span><span class="s">&quot;front&quot;</span> <span class="na">summary=</span><span class="s">&quot;For signed-in users&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;tr&gt;</span>
      <span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">&quot;main&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;h1</span> <span class="na">class=</span><span class="s">&quot;micropost&quot;</span><span class="nt">&gt;</span>What&#39;s up?<span class="nt">&lt;/h1&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/micropost_form&#39;</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/td&gt;</span>
      <span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">&quot;sidebar round&quot;</span><span class="nt">&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/user_info&#39;</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;/tr&gt;</span>
  <span class="nt">&lt;/table&gt;</span>
<span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;h1&gt;</span>Sample App<span class="nt">&lt;/h1&gt;</span>

  <span class="nt">&lt;p&gt;</span>
    This is the home page for the
    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://railstutorial.org/&quot;</span><span class="nt">&gt;</span>Ruby on Rails Tutorial<span class="nt">&lt;/a&gt;</span>
    sample application.
  <span class="nt">&lt;/p&gt;</span>

  <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;Sign up now!&quot;</span><span class="p">,</span> <span class="n">signup_path</span><span class="p">,</span> <span class="ss">:class</span> <span class="o">=&gt;</span> <span class="s2">&quot;signup_button round&quot;</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p>Having so much code in each branch of the <code>if</code>-<code>else</code> conditional is a bit messy, and cleaning it up using partials is left as an exercise (<a class="ref" href="user-microposts#sec:micropost_exercises">Section&nbsp;11.5</a>). Filling in the necessary partials from <a class="ref" href="user-microposts#code:microposts_home_page">Listing&nbsp;11.27</a> isn&rsquo;t an exercise, though; we fill in the micropost form partial in <a class="ref" href="user-microposts#code:micropost_form">Listing&nbsp;11.28</a> and the new Home page sidebar in <a class="ref" href="user-microposts#code:user_info">Listing&nbsp;11.29</a>.</p>

<div class="label" id="code:micropost_form"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.28.</span> <span class="description">The form partial for creating microposts. <br /> <code>app/views/shared/_micropost_form.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">form_for</span> <span class="vi">@micropost</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/error_messages&#39;</span><span class="p">,</span> <span class="ss">:object</span> <span class="o">=&gt;</span> <span class="n">f</span><span class="o">.</span><span class="n">object</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;field&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_area</span> <span class="ss">:content</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;actions&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">&quot;Submit&quot;</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>




<div class="label" id="code:user_info"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.29.</span> <span class="description">The partial for the user info sidebar. <br /> <code>app/views/shared/_user_info.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;user_info&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;</span><span class="cp">&lt;%=</span> <span class="n">user_path</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="s">&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="n">current_user</span><span class="p">,</span> <span class="ss">:size</span> <span class="o">=&gt;</span> <span class="mi">30</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;user_name&quot;</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/span&gt;</span>
    <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;microposts&quot;</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">pluralize</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">count</span><span class="p">,</span> <span class="s2">&quot;micropost&quot;</span><span class="p">)</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/span&gt;</span>
  <span class="nt">&lt;/a&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div></div>


<p>Note that, as in the profile sidebar (<a class="ref" href="user-microposts#code:user_show_microposts">Listing&nbsp;11.16</a>), the user info in <a class="ref" href="user-microposts#code:user_info">Listing&nbsp;11.29</a> displays the total number of microposts for the user. There&rsquo;s a slight difference in the display, though; in the profile sidebar, <strong>Microposts</strong> is a label, and showing <strong>Microposts</strong>&nbsp;1 makes perfect sense. In the present case, though, saying &ldquo;1 microposts&rdquo; is ungrammatical, so we arrange to display &ldquo;1 micropost&rdquo; (but &ldquo;2 microposts&rdquo;) using the convenient <code>pluralize</code> helper method.</p>

<p>The form defined in <a class="ref" href="user-microposts#code:micropost_form">Listing&nbsp;11.28</a> is an exact analogue of the signup form in <a class="ref" href="sign-up#code:new_user_form">Listing&nbsp;8.2</a>, which means that it needs an <code>@micropost</code> instance variable. This is supplied in <a class="ref" href="user-microposts#code:micropost_instance_variable">Listing&nbsp;11.30</a>&mdash;but only when the user is signed in.</p>

<div class="label" id="code:micropost_instance_variable"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.30.</span> <span class="description">Adding a micropost instance variable to the <code>home</code> action. <br /> <code>app/controllers/pages_controller.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">PagesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">home</span>
    <span class="vi">@title</span> <span class="o">=</span> <span class="s2">&quot;Home&quot;</span>
    <span class="vi">@micropost</span> <span class="o">=</span> <span class="no">Micropost</span><span class="o">.</span><span class="n">new</span> <span class="k">if</span> <span class="n">signed_in?</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Now the HTML should render properly, showing the form as in <a class="ref" href="user-microposts#fig:home_with_form">Figure&nbsp;11.10</a>, and a form with a submission error as in <a class="ref" href="user-microposts#fig:home_form_errors">Figure&nbsp;11.11</a>. You are invited at this point to create a new post for yourself and verify that everything is working&mdash;but you should probably wait until after <a class="ref" href="user-microposts#sec:a_proto_feed">Section&nbsp;11.3.3</a>.</p>

<div class="label" id="fig:home_with_form"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/home_with_form.png" alt="home_with_form" /></span></div><div class="caption"><span class="header">Figure 11.10: </span><span class="description">The Home page (<a href="http://localhost:3000/"><tt>/</tt></a>) with a new micropost form.&nbsp;<a href="http://railstutorial.org/images/figures/home_with_form-full.png">(full size)</a></span></div></div>




<div class="label" id="fig:home_form_errors"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/home_form_errors.png" alt="home_form_errors" /></span></div><div class="caption"><span class="header">Figure 11.11: </span><span class="description">The home page with form errors.&nbsp;<a href="http://railstutorial.org/images/figures/home_form_errors-full.png">(full size)</a></span></div></div>




<div class="label" id="sec:a_proto_feed"></div>


<h3><a id="sec:11.3.3" href="user-microposts#sec:a_proto_feed" class="heading"><span class="number">11.3.3</span> A proto-feed</a></h3>


<p>The comment at the end of <a class="ref" href="user-microposts#sec:creating_microposts">Section&nbsp;11.3.2</a> alluded to a problem: the current Home page doesn&rsquo;t display any microposts. If you like, you can verify that the form shown in <a class="ref" href="user-microposts#fig:home_with_form">Figure&nbsp;11.10</a> is working by submitting a valid entry and then navigating to the <a href="http://localhost:3000/users/1">profile page</a> to see the post, but that&rsquo;s rather cumbersome. It would be far better to have a <em>feed</em> of microposts that includes the user&rsquo;s own posts, as mocked up in <a class="ref" href="user-microposts#fig:proto_feed_mockup">Figure&nbsp;11.12</a>. (In <a class="ref" href="following-users#top">Chapter&nbsp;12</a>, we&rsquo;ll generalize this feed to include the microposts of users being <em>followed</em> by the current user.)</p>

<div class="label" id="fig:proto_feed_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/proto_feed_mockup.png" alt="proto_feed_mockup" /></span></div><div class="caption"><span class="header">Figure 11.12: </span><span class="description">A mockup of the Home page with a proto-feed.&nbsp;<a href="http://railstutorial.org/images/figures/proto_feed_mockup-full.png">(full size)</a></span></div></div>


<p>Since each user should have a feed, we are led naturally to a <code>feed</code> method in the User model. Eventually, we will test that the feed returns the microposts of the users being followed, but for now we&rsquo;ll just test that the <code>feed</code> method <em>includes</em> the current user&rsquo;s microposts but <em>excludes</em> the posts of a different user. We can express these requirements in code with <a class="ref" href="user-microposts#code:feed_specs">Listing&nbsp;11.31</a>.</p>

<div class="label" id="code:feed_specs"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.31.</span> <span class="description">Tests for the (proto-)status feed. <br /> <code>spec/models/user_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;micropost associations&quot;</span> <span class="k">do</span>

    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="vi">@attr</span><span class="p">)</span>
      <span class="vi">@mp1</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">:created_at</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
      <span class="vi">@mp2</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">:created_at</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;status feed&quot;</span> <span class="k">do</span>

      <span class="n">it</span> <span class="s2">&quot;should have a feed&quot;</span> <span class="k">do</span>
        <span class="vi">@user</span><span class="o">.</span><span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:feed</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should include the user&#39;s microposts&quot;</span> <span class="k">do</span>
        <span class="vi">@user</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="vi">@mp1</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="n">be_true</span>
        <span class="vi">@user</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="vi">@mp2</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="n">be_true</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should not include a different user&#39;s microposts&quot;</span> <span class="k">do</span>
        <span class="n">mp3</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span>
                      <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:user</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="no">Factory</span><span class="o">.</span><span class="n">next</span><span class="p">(</span><span class="ss">:email</span><span class="p">)))</span>
        <span class="vi">@user</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">mp3</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="n">be_false</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>These tests introduce the array <code>include?</code> method, which simply checks if an array includes the given element:<sup class="footnote" id="fnref:11.13"><a href="#fn:11.13">13</a></sup></p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;foo&quot;</span><span class="p">,</span> <span class="ss">:bar</span><span class="o">]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="s2">&quot;foo&quot;</span><span class="p">)</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="ss">:bar</span><span class="p">)</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="s2">&quot;baz&quot;</span><span class="p">)</span>
<span class="go">=&gt; false</span>
</pre></div>
</div>


<p>We can arrange for an appropriate micropost <code>feed</code> by selecting all the microposts with <code>user_id</code> equal to the current user&rsquo;s id, which we accomplish using the <code>where</code> method on the <code>Micropost</code> model, as shown in <a class="ref" href="user-microposts#code:proto_status_feed">Listing&nbsp;11.32</a>.<sup class="footnote" id="fnref:11.14"><a href="#fn:11.14">14</a></sup></p>

<div class="label" id="code:proto_status_feed"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.32.</span> <span class="description">A preliminary implementation for the micropost status feed. <br /> <code>app/models/user.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">feed</span>
    <span class="c1"># This is preliminary. See Chapter 12 for the full implementation.</span>
    <span class="no">Micropost</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;user_id = ?&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>The question mark in</p>

<div class="code"><div class="highlight"><pre><span class="no">Micropost</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;user_id = ?&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
</pre></div>
</div>


<p>ensures that <code>id</code>&nbsp;is properly <em>escaped</em> before being included in the underlying SQL query, thereby avoiding a serious security hole called <a href="http://en.wikipedia.org/wiki/SQL_injection"><em>SQL injection</em></a>. (The&nbsp;<code>id</code> attribute here is just an integer, so there is no danger in this case, but <em>always</em> escaping variables injected into SQL statements is a good habit to cultivate.)</p>

<p>Alert readers might note at this point that the code in <a class="ref" href="user-microposts#code:proto_status_feed">Listing&nbsp;11.32</a> is essentially equivalent to writing</p>

<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">feed</span>
  <span class="n">microposts</span>
<span class="k">end</span>
</pre></div>
</div>


<p>We&rsquo;ve used the code in <a class="ref" href="user-microposts#code:proto_status_feed">Listing&nbsp;11.32</a> instead because it generalizes much more naturally to the full status feed needed in <a class="ref" href="following-users#top">Chapter&nbsp;12</a>.</p>

<p>To use the feed in the sample application, we add an <code>@feed_items</code> instance variable for the current user&rsquo;s (paginated) feed, as in <a class="ref" href="user-microposts#code:feed_instance_variable">Listing&nbsp;11.33</a>, and then add a feed partial (<a class="ref" href="user-microposts#code:feed_partial">Listing&nbsp;11.34</a>) to the Home page (<a class="ref" href="user-microposts#code:home_with_feed">Listing&nbsp;11.36</a>).</p>

<div class="label" id="code:feed_instance_variable"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.33.</span> <span class="description">Adding a feed instance variable to the <code>home</code> action. <br /> <code>app/controllers/pages_controller.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">PagesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">home</span>
    <span class="vi">@title</span> <span class="o">=</span> <span class="s2">&quot;Home&quot;</span>
    <span class="k">if</span> <span class="n">signed_in?</span>
      <span class="vi">@micropost</span> <span class="o">=</span> <span class="no">Micropost</span><span class="o">.</span><span class="n">new</span>
      <span class="vi">@feed_items</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">:page</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="code:feed_partial"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.34.</span> <span class="description">The status feed partial. <br /> <code>app/views/shared/_feed.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">unless</span> <span class="vi">@feed_items</span><span class="o">.</span><span class="n">empty?</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;table</span> <span class="na">class=</span><span class="s">&quot;microposts&quot;</span> <span class="na">summary=</span><span class="s">&quot;User microposts&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="ss">:partial</span> <span class="o">=&gt;</span> <span class="s1">&#39;shared/feed_item&#39;</span><span class="p">,</span> <span class="ss">:collection</span> <span class="o">=&gt;</span> <span class="vi">@feed_items</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/table&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="vi">@feed_items</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p>The status feed partial defers the feed item rendering to a feed item partial using the code</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">render</span> <span class="ss">:partial</span> <span class="o">=&gt;</span> <span class="s1">&#39;shared/feed_item&#39;</span><span class="p">,</span> <span class="ss">:collection</span> <span class="o">=&gt;</span> <span class="vi">@feed_items</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>Here we pass a <code>:collection</code> parameter with the feed items, which causes <code>render</code> to use the given partial (<code>&rsquo;feed_item&rsquo;</code> in this case) to render each item in the collection. (We have omitted the <code>:partial</code> parameter in previous renderings, writing, e.g., <code>render &rsquo;shared/micropost&rsquo;</code>, but with a <code>:collection</code> parameter that syntax doesn&rsquo;t work.) The feed item partial itself appears in <a class="ref" href="user-microposts#code:feed_item_partial">Listing&nbsp;11.35</a>; note the addition of a delete link to the feed item partial, following the example from <a class="ref" href="updating-showing-and-deleting-users#code:delete_links">Listing&nbsp;10.38</a>.</p>

<div class="label" id="code:feed_item_partial"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.35.</span> <span class="description">A partial for a single feed item. <br /> <code>app/views/shared/_feed_item.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;tr&gt;</span>
  <span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">&quot;gravatar&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">gravatar_for</span><span class="p">(</span><span class="n">feed_item</span><span class="o">.</span><span class="n">user</span><span class="p">),</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">user</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/td&gt;</span>
  <span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">&quot;micropost&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;user&quot;</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">user</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/span&gt;</span>
    <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;content&quot;</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">content</span> <span class="cp">%&gt;</span><span class="nt">&lt;/span&gt;</span>
    <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;timestamp&quot;</span><span class="nt">&gt;</span>
      Posted <span class="cp">&lt;%=</span> <span class="n">time_ago_in_words</span><span class="p">(</span><span class="n">feed_item</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span> <span class="cp">%&gt;</span> ago.
    <span class="nt">&lt;/span&gt;</span>
  <span class="nt">&lt;/td&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">current_user?</span><span class="p">(</span><span class="n">feed_item</span><span class="o">.</span><span class="n">user</span><span class="p">)</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;td&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;delete&quot;</span><span class="p">,</span> <span class="n">feed_item</span><span class="p">,</span> <span class="ss">:method</span> <span class="o">=&gt;</span> <span class="ss">:delete</span><span class="p">,</span>
                                     <span class="ss">:confirm</span> <span class="o">=&gt;</span> <span class="s2">&quot;You sure?&quot;</span><span class="p">,</span>
                                     <span class="ss">:title</span> <span class="o">=&gt;</span> <span class="n">feed_item</span><span class="o">.</span><span class="n">content</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/td&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/tr&gt;</span>
</pre></div>
</div></div>


<p>We can then add the feed to the Home page by rendering the feed partial as usual (<a class="ref" href="user-microposts#code:home_with_feed">Listing&nbsp;11.36</a>). The result is a display of the feed on the Home page, as required (<a class="ref" href="user-microposts#fig:home_with_proto_feed">Figure&nbsp;11.13</a>).</p>

<div class="label" id="code:home_with_feed"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.36.</span> <span class="description">Adding a status feed to the Home page. <br /> <code>app/views/pages/home.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">signed_in?</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;table</span> <span class="na">class=</span><span class="s">&quot;front&quot;</span> <span class="na">summary=</span><span class="s">&quot;For signed-in users&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;tr&gt;</span>
      <span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">&quot;main&quot;</span><span class="nt">&gt;</span>
        <span class="nt">&lt;h1</span> <span class="na">class=</span><span class="s">&quot;micropost&quot;</span><span class="nt">&gt;</span>What&#39;s up?<span class="nt">&lt;/h1&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/micropost_form&#39;</span> <span class="cp">%&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/feed&#39;</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/td&gt;</span>
      .
      .
      .
    <span class="nt">&lt;/tr&gt;</span>
  <span class="nt">&lt;/table&gt;</span>

<span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
  .
  .
  .
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>




<div class="label" id="fig:home_with_proto_feed"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/home_with_proto_feed.png" alt="home_with_proto_feed" /></span></div><div class="caption"><span class="header">Figure 11.13: </span><span class="description">The Home page (<a href="http://localhost:3000/"><tt>/</tt></a>) with a proto-feed.&nbsp;<a href="http://railstutorial.org/images/figures/home_with_proto_feed-full.png">(full size)</a></span></div></div>


<p>At this point, creating a new micropost works as expected, as seen in <a class="ref" href="user-microposts#fig:micropost_created">Figure&nbsp;11.14</a>. (We&rsquo;ll write an integration test to this effect in <a class="ref" href="user-microposts#sec:testing_the_new_home_page">Section&nbsp;11.3.5</a>.) There is one subtlety, though: on <em>failed</em> micropost submission, the Home page expects an <code>@feed_items</code> instance variable, so failed submissions currently break (as you should be able to verify by running your test suite). The easiest solution is to suppress the feed entirely by assigning it an empty array, as shown in <a class="ref" href="user-microposts#code:microposts_create_action_with_feed">Listing&nbsp;11.37</a>.<sup class="footnote" id="fnref:11.15"><a href="#fn:11.15">15</a></sup></p>

<div class="label" id="fig:micropost_created"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/micropost_created.png" alt="micropost_created" /></span></div><div class="caption"><span class="header">Figure 11.14: </span><span class="description">The Home page after creating a new micropost.&nbsp;<a href="http://railstutorial.org/images/figures/micropost_created-full.png">(full size)</a></span></div></div>




<div class="label" id="code:microposts_create_action_with_feed"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.37.</span> <span class="description">Adding an (empty) <code>@feed_items</code> instance variable to the <code>create</code> action. <br /> <code>app/controllers/microposts_controller.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MicropostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@micropost</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:micropost</span><span class="o">]</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@micropost</span><span class="o">.</span><span class="n">save</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Micropost created!&quot;</span>
      <span class="n">redirect_to</span> <span class="n">root_path</span>
    <span class="k">else</span>
      <span class="vi">@feed_items</span> <span class="o">=</span> <span class="o">[]</span>
      <span class="n">render</span> <span class="s1">&#39;pages/home&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="sec:destroying_microposts"></div>


<h3><a id="sec:11.3.4" href="user-microposts#sec:destroying_microposts" class="heading"><span class="number">11.3.4</span> Destroying microposts</a></h3>


<p>The last piece of functionality to add to the Microposts resource is the ability to destroy posts. As with user deletion (<a class="ref" href="updating-showing-and-deleting-users#sec:the_destroy_action">Section&nbsp;10.4.2</a>), we accomplish this with &ldquo;delete&rdquo; links, as mocked up in <a class="ref" href="user-microposts#fig:micropost_delete_links_mockup">Figure&nbsp;11.15</a>. Unlike that case, which restricted user destruction to admin users, the delete links will work only for microposts created by the current user.</p>

<div class="label" id="fig:micropost_delete_links_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/micropost_delete_links_mockup.png" alt="micropost_delete_links_mockup" /></span></div><div class="caption"><span class="header">Figure 11.15: </span><span class="description">A mockup of the proto-feed with micropost delete links.&nbsp;<a href="http://railstutorial.org/images/figures/micropost_delete_links_mockup-full.png">(full size)</a></span></div></div>


<p>Our first step is to add a delete link to the micropost partial as in <a class="ref" href="user-microposts#code:feed_item_partial">Listing&nbsp;11.35</a>. The result appears in <a class="ref" href="user-microposts#code:micropost_partial_with_delete">Listing&nbsp;11.38</a>.</p>

<div class="label" id="code:micropost_partial_with_delete"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.38.</span> <span class="description">A partial for showing a single micropost. <br /> <code>app/views/microposts/_micropost.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;tr&gt;</span>
  <span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">&quot;micropost&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;content&quot;</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">micropost</span><span class="o">.</span><span class="n">content</span> <span class="cp">%&gt;</span><span class="nt">&lt;/span&gt;</span>
    <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;timestamp&quot;</span><span class="nt">&gt;</span>
      Posted <span class="cp">&lt;%=</span> <span class="n">time_ago_in_words</span><span class="p">(</span><span class="n">micropost</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span> <span class="cp">%&gt;</span> ago.
    <span class="nt">&lt;/span&gt;</span>
  <span class="nt">&lt;/td&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">current_user?</span><span class="p">(</span><span class="n">micropost</span><span class="o">.</span><span class="n">user</span><span class="p">)</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;td&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="s2">&quot;delete&quot;</span><span class="p">,</span> <span class="n">micropost</span><span class="p">,</span> <span class="ss">:method</span> <span class="o">=&gt;</span> <span class="ss">:delete</span><span class="p">,</span>
                                     <span class="ss">:confirm</span> <span class="o">=&gt;</span> <span class="s2">&quot;You sure?&quot;</span><span class="p">,</span>
                                     <span class="ss">:title</span> <span class="o">=&gt;</span> <span class="n">micropost</span><span class="o">.</span><span class="n">content</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/td&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/tr&gt;</span>
</pre></div>
</div></div>


<p><em>Note:</em> As of the latest version of Rails&nbsp;3.0, I and several other readers sometimes encounter a strange bug, whereby the <code>micropost.user</code> association isn&rsquo;t made properly. The result is that calling <code>micropost.user</code> raises a <code>NoMethodError</code> exception. Until this Rails bug is fixed, as a workaround you can replace the line</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">current_user?</span><span class="p">(</span><span class="n">micropost</span><span class="o">.</span><span class="n">user</span><span class="p">)</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>with the lines</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">user</span> <span class="o">=</span> <span class="n">micropost</span><span class="o">.</span><span class="n">user</span> <span class="k">rescue</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">micropost</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">current_user?</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>When the call to <code>micropost.user</code> raises an exception, this code finds the user based on the micropost&rsquo;s <code>user_id</code>.</p>

<p>The tests for the <code>destroy</code> action are straightforward generalizations of the similar tests for destroying users (<a class="ref" href="updating-showing-and-deleting-users#code:destroy_tests">Listing&nbsp;10.40</a>), as seen in <a class="ref" href="user-microposts#code:micropost_destroy_specs">Listing&nbsp;11.39</a>.</p>

<div class="label" id="code:micropost_destroy_specs"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.39.</span> <span class="description">Tests for the Microposts controller <code>destroy</code> action. <br /> <code>spec/controllers/microposts_controller_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="no">MicropostsController</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;DELETE &#39;destroy&#39;&quot;</span> <span class="k">do</span>

    <span class="n">describe</span> <span class="s2">&quot;for an unauthorized user&quot;</span> <span class="k">do</span>

      <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
        <span class="vi">@user</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
        <span class="n">wrong_user</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:user</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="no">Factory</span><span class="o">.</span><span class="n">next</span><span class="p">(</span><span class="ss">:email</span><span class="p">))</span>
        <span class="n">test_sign_in</span><span class="p">(</span><span class="n">wrong_user</span><span class="p">)</span>
        <span class="vi">@micropost</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should deny access&quot;</span> <span class="k">do</span>
        <span class="n">delete</span> <span class="ss">:destroy</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="vi">@micropost</span>
        <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">root_path</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">&quot;for an authorized user&quot;</span> <span class="k">do</span>

      <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
        <span class="vi">@user</span> <span class="o">=</span> <span class="n">test_sign_in</span><span class="p">(</span><span class="no">Factory</span><span class="p">(</span><span class="ss">:user</span><span class="p">))</span>
        <span class="vi">@micropost</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should destroy the micropost&quot;</span> <span class="k">do</span>
        <span class="nb">lambda</span> <span class="k">do</span> 
          <span class="n">delete</span> <span class="ss">:destroy</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="vi">@micropost</span>
        <span class="k">end</span><span class="o">.</span><span class="n">should</span> <span class="n">change</span><span class="p">(</span><span class="no">Micropost</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>The application code is also analogous to the user case in <a class="ref" href="updating-showing-and-deleting-users#code:admin_destroy_before_filter">Listing&nbsp;10.41</a>; the main difference is that, rather than using an <code>admin_user</code> before filter, in the case of microposts we have an <code>authorized_user</code> before filter to check that the current user is the micropost&rsquo;s user. The code appears in <a class="ref" href="user-microposts#code:microposts_destroy_action">Listing&nbsp;11.40</a>, and the result of destroying the second-most-recent post appears in <a class="ref" href="user-microposts#fig:home_post_delete">Figure&nbsp;11.16</a>.</p>

<div class="label" id="code:microposts_destroy_action"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.40.</span> <span class="description">The Microposts controller <code>destroy</code> action. <br /> <code>app/controllers/microposts_controller.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MicropostsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:authenticate</span><span class="p">,</span> <span class="ss">:only</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
  <span class="n">before_filter</span> <span class="ss">:authorized_user</span><span class="p">,</span> <span class="ss">:only</span> <span class="o">=&gt;</span> <span class="ss">:destroy</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="vi">@micropost</span><span class="o">.</span><span class="n">destroy</span>
    <span class="n">redirect_back_or</span> <span class="n">root_path</span>
  <span class="k">end</span>

  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">authorized_user</span>
      <span class="vi">@micropost</span> <span class="o">=</span> <span class="no">Micropost</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
      <span class="n">redirect_to</span> <span class="n">root_path</span> <span class="k">unless</span> <span class="n">current_user?</span><span class="p">(</span><span class="vi">@micropost</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="fig:home_post_delete"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/home_post_delete.png" alt="home_post_delete" /></span></div><div class="caption"><span class="header">Figure 11.16: </span><span class="description">The user home page after deleting the second-most-recent micropost.&nbsp;<a href="http://railstutorial.org/images/figures/home_post_delete-full.png">(full size)</a></span></div></div>




<div class="label" id="sec:testing_the_new_home_page"></div>


<h3><a id="sec:11.3.5" href="user-microposts#sec:testing_the_new_home_page" class="heading"><span class="number">11.3.5</span> Testing the new home page</a></h3>


<p>Before leaving micropost creation and destruction, we&rsquo;ll write some RSpec integration specs to test that our forms are working properly. As in the case of users (<a class="ref" href="sign-up#sec:rspec_integration_tests">Section&nbsp;8.4</a>), we start by generating a microposts integration spec:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate integration_test microposts
</pre></div>
</div>


<p>Tests for failed and successful micropost creation appear in <a class="ref" href="user-microposts#code:microposts_integration_spec">Listing&nbsp;11.41</a>.</p>

<div class="label" id="code:microposts_integration_spec"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.41.</span> <span class="description">An integration test for the microposts on the <code>home</code> page. <br /> <code>spec/requests/microposts_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Microposts&quot;</span> <span class="k">do</span>

  <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">user</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
    <span class="n">visit</span> <span class="n">signin_path</span>
    <span class="n">fill_in</span> <span class="ss">:email</span><span class="p">,</span>    <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span>
    <span class="n">fill_in</span> <span class="ss">:password</span><span class="p">,</span> <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="n">user</span><span class="o">.</span><span class="n">password</span>
    <span class="n">click_button</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;creation&quot;</span> <span class="k">do</span>

    <span class="n">describe</span> <span class="s2">&quot;failure&quot;</span> <span class="k">do</span>

      <span class="n">it</span> <span class="s2">&quot;should not make a new micropost&quot;</span> <span class="k">do</span>
        <span class="nb">lambda</span> <span class="k">do</span>
          <span class="n">visit</span> <span class="n">root_path</span>
          <span class="n">fill_in</span> <span class="ss">:micropost_content</span><span class="p">,</span> <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span>
          <span class="n">click_button</span>
          <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;pages/home&#39;</span><span class="p">)</span>
          <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;div#error_explanation&quot;</span><span class="p">)</span>
        <span class="k">end</span><span class="o">.</span><span class="n">should_not</span> <span class="n">change</span><span class="p">(</span><span class="no">Micropost</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">&quot;success&quot;</span> <span class="k">do</span>

      <span class="n">it</span> <span class="s2">&quot;should make a new micropost&quot;</span> <span class="k">do</span>
        <span class="n">content</span> <span class="o">=</span> <span class="s2">&quot;Lorem ipsum dolor sit amet&quot;</span>
        <span class="nb">lambda</span> <span class="k">do</span>
          <span class="n">visit</span> <span class="n">root_path</span>
          <span class="n">fill_in</span> <span class="ss">:micropost_content</span><span class="p">,</span> <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="n">content</span>
          <span class="n">click_button</span>
          <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;span.content&quot;</span><span class="p">,</span> <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="n">content</span><span class="p">)</span>
        <span class="k">end</span><span class="o">.</span><span class="n">should</span> <span class="n">change</span><span class="p">(</span><span class="no">Micropost</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Having finished testing the micropost functionality, we are now ready to move on the final feature of our sample application: user following.</p>

<h2><a id="sec:11.4" href="user-microposts#sec:11.4" class="heading"><span class="number">11.4</span> Conclusion</a></h2>


<p>With the addition of the Microposts resource, we are nearly finished with our sample application. All that remains is to add a social layer by letting users follow each other. We&rsquo;ll learn how to model such user relationships, and see the implications for the status feed, in <a class="ref" href="following-users#top">Chapter&nbsp;12</a>.</p>

<p>Before proceeding, be sure to commit and merge your changes if you&rsquo;re using Git for version control:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">&quot;Added user microposts&quot;</span>
<span class="gp">$</span> git checkout master
<span class="gp">$</span> git merge user-microposts
</pre></div>
</div>


<p>You can also push the app up to Heroku at this point. Because the data model has changed through the addition of the <code>microposts</code> table, you will also need to migrate the production database:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git push heroku
<span class="gp">$</span> heroku rake db:migrate
</pre></div>
</div>


<div class="label" id="sec:micropost_exercises"></div>


<h2><a id="sec:11.5" href="user-microposts#sec:micropost_exercises" class="heading"><span class="number">11.5</span> Exercises</a></h2>


<p>We&rsquo;ve covered enough material now that there is a combinatorial explosion of possible extensions to the application. Here are just a few of the many possibilities:</p>

<ol>
<li><strong>(challenging)</strong> Add a JavaScript display to the Home page to count down from&nbsp;140 characters.</li>
<li>Add tests for the sidebar micropost counts (including proper pluralization).</li>
<li><strong>(mainly for designers)</strong> Modify the microposts listing to use an ordered list instead of a table. (<em>Note:</em> this is how Twitter displays its status updates.) Then add the appropriate CSS to make the resulting feed not look like crap.</li>
<li>Add tests for micropost pagination.</li>
<li>Refactor the Home page to use separate partials for the two branches of the <code>if</code>-<code>else</code> statement.</li>
<li>Write a test to make sure delete links do not appear for microposts not created by the current user.</li>
<li>Add a <a href="http://guides.rubyonrails.org/routing.html#nested-routes">nested route</a> so that <tt>/users/1/microposts</tt> shows all the microposts for user&nbsp;1. (You will also have to add a Microposts controller <code>index</code> action and corresponding view.)</li>
<li>Very long words currently break our layout, as shown in <a class="ref" href="user-microposts#fig:long_word_micropost">Figure&nbsp;11.17</a>. Fix this problem using the <code>wrap</code> helper defined in <a class="ref" href="user-microposts#code:wrap">Listing&nbsp;11.42</a>. (Note the use of the <code>raw</code> method to prevent Rails from escaping the resulting HTML, together with the <code>sanitize</code> method needed to prevent cross-site scripting.)</li>
</ol>




<div class="label" id="fig:long_word_micropost"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/long_word_micropost.png" alt="long_word_micropost" /></span></div><div class="caption"><span class="header">Figure 11.17: </span><span class="description">The (broken) site layout with a particularly long word.&nbsp;<a href="http://railstutorial.org/images/figures/long_word_micropost-full.png">(full size)</a></span></div></div>




<div class="label" id="code:wrap"></div>


<div class="codelisting">
<div class="listing"><span class="header">Listing 11.42.</span> <span class="description">A helper to wrap long words. <br /> <code>app/helpers/microposts_helper.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">module</span> <span class="nn">MicropostsHelper</span>

  <span class="k">def</span> <span class="nf">wrap</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
    <span class="n">sanitize</span><span class="p">(</span><span class="n">raw</span><span class="p">(</span><span class="n">content</span><span class="o">.</span><span class="n">split</span><span class="o">.</span><span class="n">map</span><span class="p">{</span> <span class="o">|</span><span class="n">s</span><span class="o">|</span> <span class="n">wrap_long_string</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="p">}</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)))</span>
  <span class="k">end</span>

  <span class="kp">private</span>

    <span class="k">def</span> <span class="nf">wrap_long_string</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">max_width</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span>
      <span class="n">zero_width_space</span> <span class="o">=</span> <span class="s2">&quot;&amp;#8203;&quot;</span>
      <span class="n">regex</span> <span class="o">=</span> <span class="sr">/.{1,</span><span class="si">#{</span><span class="n">max_width</span><span class="si">}</span><span class="sr">}/</span>
      <span class="p">(</span><span class="n">text</span><span class="o">.</span><span class="n">length</span> <span class="o">&lt;</span> <span class="n">max_width</span><span class="p">)</span> <span class="p">?</span> <span class="n">text</span> <span class="p">:</span> 
                                  <span class="n">text</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="n">regex</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">zero_width_space</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="navigation">  <a class="prev_page" href="updating-showing-and-deleting-users#top">
    &laquo;&nbsp;<span class="number">Chapter 10</span> Updating, showing, and deleting users
  </a>
  <a class="next_page" href="following-users#top">
    <span class="number">Chapter 12</span> Following users&nbsp;&raquo;
  </a>
</div><div class="footnotes">
<ol>
<li id="fn:11.1">Technically, we treated sessions as a resource in <a class="ref" href="sign-in-sign-out#top">Chapter&nbsp;9</a>, but they are not saved to the database the way users and microposts are.&nbsp;<a class="arrow" href="#fnref:11.1">&uarr;</a></li>
<li id="fn:11.2">The <code>content</code> attribute will be a <code>string</code>, but, as noted briefly in <a class="ref" href="a-demo-app#sec:modeling_microposts">Section&nbsp;2.1.2</a>, for longer text fields you should use the <code>text</code> data type.&nbsp;<a class="arrow" href="#fnref:11.2">&uarr;</a></li>
<li id="fn:11.3">For more on Factory Girl associations, including the many options available, see the <a href="http://rdoc.info/projects/thoughtbot/factory_girl">Factory Girl documentation</a>.&nbsp;<a class="arrow" href="#fnref:11.3">&uarr;</a></li>
<li id="fn:11.4">Recall that <code>created_at</code> and <code>updated_at</code> are &ldquo;magic&rdquo; columns, so any explicit initialization values are overwritten by the magic.&nbsp;<a class="arrow" href="#fnref:11.4">&uarr;</a></li>
<li id="fn:11.5">In the sense of <a href="http://en.wikipedia.org/wiki/HTML#Semantic_HTML">semantic markup</a>, it would probably be better to use an <a href="http://www.w3.org/MarkUp/html3/seqlists.html"><em>ordered list</em></a>, but in that case the vertical alignment of text and images is much more difficult than with tables. See the exercise in <a class="ref" href="user-microposts#sec:micropost_exercises">Section&nbsp;11.5</a> if you insist on struggling with the semantic version.&nbsp;<a class="arrow" href="#fnref:11.5">&uarr;</a></li>
<li id="fn:11.6">In case you&rsquo;re wondering, the association <code>count</code> method is smart, and performs the count directly in the database. In particular, it does <em>not</em> pull all the microposts out of the database and then call <code>length</code> on the resulting array, as this would become terribly inefficient as the number of microposts grew. Instead, it asks the database to count the microposts with the given <code>user_id</code>. By the way, in the unlikely event that finding the count is still a bottleneck in your application, you can make it even faster with a <a href="http://railscasts.com/episodes/23-counter-cache-column"><em>counter cache</em></a>.&nbsp;<a class="arrow" href="#fnref:11.6">&uarr;</a></li>
<li id="fn:11.7">For convenience, <a class="ref" href="user-microposts#code:micropost_css">Listing&nbsp;11.19</a> actually has <em>all</em> the CSS needed for this chapter.&nbsp;<a class="arrow" href="#fnref:11.7">&uarr;</a></li>
<li id="fn:11.8">(i.e., the five users with custom Gravatars, and one with the default Gravatar)&nbsp;<a class="arrow" href="#fnref:11.8">&uarr;</a></li>
<li id="fn:11.9">Tail your <code>log/development.log</code> file if you&rsquo;re curious about the SQL this method generates.&nbsp;<a class="arrow" href="#fnref:11.9">&uarr;</a></li>
<li id="fn:11.10">By design, the Faker gem&rsquo;s <em>lorem ipsum</em> text is randomized, so the contents of your sample microposts will differ.&nbsp;<a class="arrow" href="#fnref:11.10">&uarr;</a></li>
<li id="fn:11.11">The other two resources are Users in <a class="ref" href="sign-up#sec:signup_form">Section&nbsp;8.1</a> and Sessions in <a class="ref" href="sign-in-sign-out#sec:sessions">Section&nbsp;9.1</a>.&nbsp;<a class="arrow" href="#fnref:11.11">&uarr;</a></li>
<li id="fn:11.12">We noted in <a class="ref" href="sign-in-sign-out#sec:remember_me">Section&nbsp;9.3.2</a> that helper methods are available only in <em>views</em> by default, but we arranged for the Sessions helper methods to be available in the controllers as well by adding <code>include SessionsHelper</code> to the Application controller (<a class="ref" href="sign-in-sign-out#code:sessions_helper_include">Listing&nbsp;9.11</a>).&nbsp;<a class="arrow" href="#fnref:11.12">&uarr;</a></li>
<li id="fn:11.13">Learning about methods such as <code>include?</code> is one reason why, as noted in <a class="ref" href="beginning#sec:comments_for_various_readers">Section&nbsp;1.1.1</a>, I recommend reading a pure Ruby book after finishing this one.&nbsp;<a class="arrow" href="#fnref:11.13">&uarr;</a></li>
<li id="fn:11.14">See the Rails Guide on the <a href="http://guides.rubyonrails.org/active_record_querying.html">Active Record Query Interface</a> for more on <code>where</code> and the like.&nbsp;<a class="arrow" href="#fnref:11.14">&uarr;</a></li>
<li id="fn:11.15">Unfortunately, returning a paginated feed doesn&rsquo;t work in this case. Implement it and click on a pagination link to see why. (The <a href="http://railstutorial.org/screencasts">Rails Tutorial screencasts</a> cover this issue in more depth.)&nbsp;<a class="arrow" href="#fnref:11.15">&uarr;</a></li>
</ol>
</div>




