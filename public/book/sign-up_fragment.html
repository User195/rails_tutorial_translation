<!--
	chapitre : 8
-->

<h1 class="title">Tutoriel Ruby on Rails </h1>


<h1 class="subtitle">  Apprendre Rails par l'exemple</h1>


<h2 class="author">Michael Hartl</h2>



<h1 class="contents">Contenu</h1>


<div id="table_of_contents"><ol>
<li class="chapter"><a href="beginning#top"><span class="number">Chapitre 1</span> De zéro au déploiement</a></li>
<li><ol>
<li class="section"><a href="beginning#sec:introduction"><span class="number">1.1</span> Introduction</a></li>
<li><ol>
<li class="subsection"><a href="beginning#sec:comments_for_various_readers"><span class="number">1.1.1</span> Commentaires pour les lecteurs différents</a></li>
<li class="subsection"><a href="beginning#sec:1.1.2"><span class="number">1.1.2</span> «&nbsp;Dimensionner&nbsp;» Rails</a></li>
<li class="subsection"><a href="beginning#sec:conventions"><span class="number">1.1.3</span> Conventions utilisées dans ce livre</a></li></ol></li>
<li class="section"><a href="beginning#sec:up_and_running"><span class="number">1.2</span> [(Up and running)(En route pour le démarrage)]</a></li>
<li><ol>
<li class="subsection"><a href="beginning#sec:development_tools"><span class="number">1.2.1</span> Environnements de développement</a></li>
<li><ol>
<li class="subsubsection"><a href="beginning#sec:1.2.1.1">IDEs</a></li>
<li class="subsubsection"><a href="beginning#sec:1.2.1.2">Éditeurs de texte et lignes de commande</a></li>
<li class="subsubsection"><a href="beginning#sec:1.2.1.3">Navigateurs</a></li>
<li class="subsubsection"><a href="beginning#sec:1.2.1.4">Note à propos des outils</a></li></ol></li>
<li class="subsection"><a href="beginning#sec:rubygems"><span class="number">1.2.2</span> Ruby, RubyGems, Rails, et Git</a></li>
<li><ol>
<li class="subsubsection"><a href="beginning#sec:rails_installer_windows">Installation de Rails (Windows)</a></li>
<li class="subsubsection"><a href="beginning#sec:install_git">Installer Git</a></li>
<li class="subsubsection"><a href="beginning#sec:install_ruby">Installer Ruby</a></li>
<li class="subsubsection"><a href="beginning#sec:install_rubygems">Installer RubyGems</a></li>
<li class="subsubsection"><a href="beginning#sec:install_rails">Installer Rails</a></li></ol></li>
<li class="subsection"><a href="beginning#sec:the_first_application"><span class="number">1.2.3</span> La première application</a></li>
<li class="subsection"><a href="beginning#sec:bundler"><span class="number">1.2.4</span> Bundler</a></li>
<li class="subsection"><a href="beginning#sec:rails_server"><span class="number">1.2.5</span> <code>Le serveur rails (rails server)</code></a></li>
<li class="subsection"><a href="beginning#sec:mvc"><span class="number">1.2.6</span> Modèles-Vue-Contrôleur (MVC)</a></li></ol></li>
<li class="section"><a href="beginning#sec:version_control"><span class="number">1.3</span> Contrôle de versions avec Git</a></li>
<li><ol>
<li class="subsection"><a href="beginning#sec:git_setup"><span class="number">1.3.1</span> Installation et réglages</a></li>
<li><ol>
<li class="subsubsection"><a href="beginning#sec:1.3.1.1">Initialisation des réglages système</a></li>
<li class="subsubsection"><a href="beginning#sec:1.3.1.2">Initialisation des réglages du dépôt (repository)</a></li></ol></li>
<li class="subsection"><a href="beginning#sec:adding_and_committing"><span class="number">1.3.2</span> Ajout et mandat de dépôt</a></li>
<li class="subsection"><a href="beginning#sec:1.3.3"><span class="number">1.3.3</span> Qu'est-ce que Git peut faire de bien pour vous&nbsp;?</a></li>
<li class="subsection"><a href="beginning#sec:github"><span class="number">1.3.4</span> GitHub</a></li>
<li class="subsection"><a href="beginning#sec:git_commands"><span class="number">1.3.5</span> Branch, edit, commit, merge</a></li>
<li><ol>
<li class="subsubsection"><a href="beginning#sec:git_branch">Branch</a></li>
<li class="subsubsection"><a href="beginning#sec:git_edit">Edit</a></li>
<li class="subsubsection"><a href="beginning#sec:git_commit">Commit</a></li>
<li class="subsubsection"><a href="beginning#sec:git_merge">Merge</a></li>
<li class="subsubsection"><a href="beginning#sec:git_push">Push</a></li></ol></li></ol></li>
<li class="section"><a href="beginning#sec:deploying"><span class="number">1.4</span> Déploiement</a></li>
<li><ol>
<li class="subsection"><a href="beginning#sec:1.4.1"><span class="number">1.4.1</span> Réglages Heroku</a></li>
<li class="subsection"><a href="beginning#sec:heroku_step_one"><span class="number">1.4.2</span> déploiement Heroku, première étape</a></li>
<li class="subsection"><a href="beginning#sec:1.4.3"><span class="number">1.4.3</span> Déploiement Heroku deployment, seconde étape</a></li>
<li class="subsection"><a href="beginning#sec:heroku_commands"><span class="number">1.4.4</span> Commandes Heroku</a></li></ol></li>
<li class="section"><a href="beginning#sec:beginning_conclusion"><span class="number">1.5</span> Conclusion</a></li></ol></li>
<li class="chapter"><a href="a-demo-app#top"><span class="number">Chapitre 2</span> Une application démo</a></li>
<li><ol>
<li class="section"><a href="a-demo-app#sec:planning_the_application"><span class="number">2.1</span> Planifier l'application</a></li>
<li><ol>
<li class="subsection"><a href="a-demo-app#sec:modeling_users"><span class="number">2.1.1</span> Modéliser les utilisateurs</a></li>
<li class="subsection"><a href="a-demo-app#sec:modeling_microposts"><span class="number">2.1.2</span> Modéliser les micro-messages</a></li></ol></li>
<li class="section"><a href="a-demo-app#sec:demo_users_resource"><span class="number">2.2</span> La ressource Utilisateurs (Users)</a></li>
<li><ol>
<li class="subsection"><a href="a-demo-app#sec:a_user_tour"><span class="number">2.2.1</span> Un tour de l'utilisateur</a></li>
<li class="subsection"><a href="a-demo-app#sec:mvc_in_action"><span class="number">2.2.2</span> MVC en action</a></li>
<li class="subsection"><a href="a-demo-app#sec:weaknesses_of_this_users_resource"><span class="number">2.2.3</span> Faiblesses de la ressource Utilisateurs (Users)</a></li></ol></li>
<li class="section"><a href="a-demo-app#sec:microposts_resource"><span class="number">2.3</span> La ressource Micro-messages (Microposts)</a></li>
<li><ol>
<li class="subsection"><a href="a-demo-app#sec:a_micropost_microtour"><span class="number">2.3.1</span> Un petit tour du micro-message</a></li>
<li class="subsection"><a href="a-demo-app#sec:putting_the_micro_in_microposts"><span class="number">2.3.2</span> Appliquer le <em>micro</em> aux micro-messages</a></li>
<li class="subsection"><a href="a-demo-app#sec:demo_user_has_many_microposts"><span class="number">2.3.3</span> Un utilisateur <code>has_many</code> (<code>possède plusieurs</code>) micro-messages</a></li>
<li class="subsection"><a href="a-demo-app#sec:inheritance_hierarchies"><span class="number">2.3.4</span> Hiérarchie des héritages</a></li>
<li class="subsection"><a href="a-demo-app#sec:deploying_the_demo_app"><span class="number">2.3.5</span> Déployer l'application Démo</a></li></ol></li>
<li class="section"><a href="a-demo-app#sec:2.4"><span class="number">2.4</span> Conclusion</a></li></ol></li>
<li class="chapter"><a href="static-pages#top"><span class="number">Chapitre 3</span> Pages statiques courantes</a></li>
<li><ol>
<li class="section"><a href="static-pages#sec:static_pages"><span class="number">3.1</span> Pages statiques</a></li>
<li><ol>
<li class="subsection"><a href="static-pages#sec:truly_static_pages"><span class="number">3.1.1</span> Pages HTML statiques</a></li>
<li class="subsection"><a href="static-pages#sec:static_pages_with_rails"><span class="number">3.1.2</span> Les pages statiques avec Rails</a></li></ol></li>
<li class="section"><a href="static-pages#sec:first_tests"><span class="number">3.2</span> Premiers tests</a></li>
<li><ol>
<li class="subsection"><a href="static-pages#sec:testing_tools"><span class="number">3.2.1</span> Outils de test</a></li>
<li><ol>
<li class="subsubsection"><a href="static-pages#sec:autotest">Auto-test</a></li></ol></li>
<li class="subsection"><a href="static-pages#sec:TDD"><span class="number">3.2.2</span> TDD : Rouge, Vert, Refactor</a></li>
<li><ol>
<li class="subsubsection"><a href="static-pages#sec:spork">Spork</a></li>
<li class="subsubsection"><a href="static-pages#sec:red">Rouge</a></li>
<li class="subsubsection"><a href="static-pages#sec:green">Vert</a></li>
<li class="subsubsection"><a href="static-pages#sec:refactor">Refactor</a></li></ol></li></ol></li>
<li class="section"><a href="static-pages#sec:slightly_dynamic_pages"><span class="number">3.3</span> Pages (un peu) dynamiques</a></li>
<li><ol>
<li class="subsection"><a href="static-pages#sec:testing_a_title_change"><span class="number">3.3.1</span> Test d'un changement de titre</a></li>
<li class="subsection"><a href="static-pages#sec:passing_title_tests"><span class="number">3.3.2</span> Réussir les tests de titre</a></li>
<li class="subsection"><a href="static-pages#sec:instance_variables_embedded_ruby"><span class="number">3.3.3</span> Variables d'instance et Ruby embarqué</a></li>
<li class="subsection"><a href="static-pages#sec:layouts"><span class="number">3.3.4</span> Supprimer les répétitions avec les <em>layouts</em></a></li></ol></li>
<li class="section"><a href="static-pages#sec:static_pages_conclusion"><span class="number">3.4</span> Conclusion</a></li>
<li class="section"><a href="static-pages#sec:static_pages_Exercices"><span class="number">3.5</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="rails-flavored-ruby#top"><span class="number">Chapitre 4</span> [(Rails-flavored Ruby)(Rails au goût Ruby)]</a></li>
<li><ol>
<li class="section"><a href="rails-flavored-ruby#sec:motivation"><span class="number">4.1</span> Motivation</a></li>
<li><ol>
<li class="subsection"><a href="rails-flavored-ruby#sec:title_helper"><span class="number">4.1.1</span> Un « helper » (« aideur ») pour le titre (<code>title</code>)</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:cascading_style_sheets"><span class="number">4.1.2</span> Feuilles de styles (CSS — Cascading Style Sheets)</a></li></ol></li>
<li class="section"><a href="rails-flavored-ruby#sec:strings_and_methods"><span class="number">4.2</span> Chaines de caractères et méthodes</a></li>
<li><ol>
<li class="subsection"><a href="rails-flavored-ruby#sec:comments"><span class="number">4.2.1</span> Commentaires</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:strings"><span class="number">4.2.2</span> Chaines de caractères</a></li>
<li><ol>
<li class="subsubsection"><a href="rails-flavored-ruby#sec:printing">Impression</a></li>
<li class="subsubsection"><a href="rails-flavored-ruby#sec:single_quoted_strings">Chaines de caractères « single-quoté »</a></li></ol></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:objects_and_message_passing"><span class="number">4.2.3</span> Objets et passage de message</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:method_definitions"><span class="number">4.2.4</span> Définition de méthode</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:back_to_the_title_helper"><span class="number">4.2.5</span> Retour à l'« helper » de titre</a></li></ol></li>
<li class="section"><a href="rails-flavored-ruby#sec:other_data_structures"><span class="number">4.3</span> Autres structures de données</a></li>
<li><ol>
<li class="subsection"><a href="rails-flavored-ruby#sec:arrays_and_ranges"><span class="number">4.3.1</span> Tableaux et rangs</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:blocks"><span class="number">4.3.2</span> Blocs</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:hashes_and_symbols"><span class="number">4.3.3</span> Tables de hachage et symboles</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:css_revisited"><span class="number">4.3.4</span> CSS revisitées</a></li></ol></li>
<li class="section"><a href="rails-flavored-ruby#sec:ruby_classes"><span class="number">4.4</span> Classes Ruby</a></li>
<li><ol>
<li class="subsection"><a href="rails-flavored-ruby#sec:constructors"><span class="number">4.4.1</span> Constructeurs</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:a_class_of_our_own"><span class="number">4.4.2</span> Héritages de classes</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:modifying_built_in_classes"><span class="number">4.4.3</span> Modifier les classes d'origine</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:a_controller_class"><span class="number">4.4.4</span> Classe de contrôleur</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:a_user_class"><span class="number">4.4.5</span> Classe utiliateur</a></li></ol></li>
<li class="section"><a href="rails-flavored-ruby#sec:Exercices"><span class="number">4.5</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="filling-in-the-layout#top"><span class="number">Chapitre 5</span> Poursuivre la mise en page</a></li>
<li><ol>
<li class="section"><a href="filling-in-the-layout#sec:structure"><span class="number">5.1</span> Ajout de structure</a></li>
<li><ol>
<li class="subsection"><a href="filling-in-the-layout#sec:adding_to_the_layout"><span class="number">5.1.1</span> Navigation du site</a></li>
<li class="subsection"><a href="filling-in-the-layout#sec:custom_css"><span class="number">5.1.2</span> Personnalisation CSS</a></li>
<li class="subsection"><a href="filling-in-the-layout#sec:partials"><span class="number">5.1.3</span> Partiels (Partials)</a></li></ol></li>
<li class="section"><a href="filling-in-the-layout#sec:layout_links"><span class="number">5.2</span> Liens pour la mise en page</a></li>
<li><ol>
<li class="subsection"><a href="filling-in-the-layout#sec:integration_tests"><span class="number">5.2.1</span> Test d'intégration</a></li>
<li class="subsection"><a href="filling-in-the-layout#sec:rails_routes"><span class="number">5.2.2</span> Routes Rails</a></li>
<li class="subsection"><a href="filling-in-the-layout#sec:named_routes"><span class="number">5.2.3</span> Nommer les routes</a></li></ol></li>
<li class="section"><a href="filling-in-the-layout#sec:user_signup"><span class="number">5.3</span> Inscription de l'utilisateur : une première étape</a></li>
<li><ol>
<li class="subsection"><a href="filling-in-the-layout#sec:users_controller"><span class="number">5.3.1</span> Contrôleur Utilisateur (Users controller)</a></li>
<li class="subsection"><a href="filling-in-the-layout#sec:signup_url"><span class="number">5.3.2</span> URL d'inscription</a></li></ol></li>
<li class="section"><a href="filling-in-the-layout#sec:layout_conclusion"><span class="number">5.4</span> Conclusion</a></li>
<li class="section"><a href="filling-in-the-layout#sec:layout_Exercices"><span class="number">5.5</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="modeling-and-viewing-users-one#top"><span class="number">Chapitre 6</span> Modéliser et afficher les utilisateurs, partie I</a></li>
<li><ol>
<li class="section"><a href="modeling-and-viewing-users-one#sec:user_model"><span class="number">6.1</span> Modèle utilisateur (User model)</a></li>
<li><ol>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:database_migrations"><span class="number">6.1.1</span> Migrations de la base de données</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:the_model_file"><span class="number">6.1.2</span> Le fichier modèle</a></li>
<li><ol>
<li class="subsubsection"><a href="modeling-and-viewing-users-one#sec:model_annotation">[(Model annotation)]</a></li>
<li class="subsubsection"><a href="modeling-and-viewing-users-one#sec:accessible_attributes">Attributs accessibles</a></li></ol></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:creating_user_objects"><span class="number">6.1.3</span> Créer des objets Utilisateur</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:finding_user_objects"><span class="number">6.1.4</span> Recherche dans les objets Utilisateurs (Users)</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:updating_user_objects"><span class="number">6.1.5</span> Actualisation des objets Utilisateurs (Users)</a></li></ol></li>
<li class="section"><a href="modeling-and-viewing-users-one#sec:user_validations"><span class="number">6.2</span> Validations utilisateur</a></li>
<li><ol>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:presence_validation"><span class="number">6.2.1</span> Valider l'existence</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:length_validation"><span class="number">6.2.2</span> Valider la longueur</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:format_validation"><span class="number">6.2.3</span> Valider le format</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:uniqueness_validation"><span class="number">6.2.4</span> Valider l'unicité</a></li>
<li><ol>
<li class="subsubsection"><a href="modeling-and-viewing-users-one#sec:the_caveat">L'avertissement d'unicité</a></li></ol></li></ol></li>
<li class="section"><a href="modeling-and-viewing-users-one#sec:viewing_users"><span class="number">6.3</span> Afficher les utilisateurs</a></li>
<li><ol>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:rails_environments"><span class="number">6.3.1</span> Débuggage et environnements Rails</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:users_show"><span class="number">6.3.2</span> Modèle, Vue et Contrôleur Utilisateur</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:a_users_resource"><span class="number">6.3.3</span> Ressource Utilisateurs</a></li>
<li><ol>
<li class="subsubsection"><a href="modeling-and-viewing-users-one#sec:params_in_debug">[(<code>params</code> in <code>debug</code>)]</a></li></ol></li></ol></li>
<li class="section"><a href="modeling-and-viewing-users-one#sec:6.4"><span class="number">6.4</span> Conclusion</a></li>
<li class="section"><a href="modeling-and-viewing-users-one#sec:6.5"><span class="number">6.5</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="modeling-and-viewing-users-two#top"><span class="number">Chapitre 7</span> Modéliser et afficher les utilisateurs, partie II</a></li>
<li><ol>
<li class="section"><a href="modeling-and-viewing-users-two#sec:insecure_passwords"><span class="number">7.1</span> Mots de passe non sûrs</a></li>
<li><ol>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:password_validations"><span class="number">7.1.1</span> Valider le mot de passe</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:password_migration"><span class="number">7.1.2</span> Migrer un mot de passe</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:an_active_record_fonction de rappel"><span class="number">7.1.3</span> Un <em>fonction de rappel</em> de l'Active Record</a></li></ol></li>
<li class="section"><a href="modeling-and-viewing-users-two#sec:secure_passwords"><span class="number">7.2</span> Sécuriser les mots de passe</a></li>
<li><ol>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:a_secure_password_test"><span class="number">7.2.1</span> Test de mot de passe sûr</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:secure_password_theory"><span class="number">7.2.2</span> Un peu de théorie sur la sécurisation des mots de passe</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:implementing_has_password"><span class="number">7.2.3</span> Implémenter la méthode <code>has_password?</code></a></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:an_authenticate_method"><span class="number">7.2.4</span> Méthode d'authentification</a></li></ol></li>
<li class="section"><a href="modeling-and-viewing-users-two#sec:better_user_views"><span class="number">7.3</span> Meilleures vues d'utilisateurs</a></li>
<li><ol>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:tests_with_factories"><span class="number">7.3.1</span> Tester la page de l'utilisateur (avec <em>factories</em>)</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:a_name_and_a_gravatar"><span class="number">7.3.2</span> Un nom et un Gravatar</a></li>
<li><ol>
<li class="subsubsection"><a href="modeling-and-viewing-users-two#sec:a_gravatar_helper">Un « helper » de Gravatar</a></li></ol></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:a_user_sidebar"><span class="number">7.3.3</span> Une barre utilisateur latérale</a></li></ol></li>
<li class="section"><a href="modeling-and-viewing-users-two#sec:7.4"><span class="number">7.4</span> Conclusion</a></li>
<li><ol>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:7.4.1"><span class="number">7.4.1</span> Dépôt Git</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:heroku_deploy"><span class="number">7.4.2</span> Déploiement Heroku</a></li></ol></li>
<li class="section"><a href="modeling-and-viewing-users-two#sec:more_modeling_users_Exercices"><span class="number">7.5</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="sign-up#top"><span class="number">Chapitre 8</span> Inscription</a></li>
<li><ol>
<li class="section"><a href="sign-up#sec:signup_form"><span class="number">8.1</span> Formulaire d'inscription</a></li>
<li><ol>
<li class="subsection"><a href="sign-up#sec:using_form_for"><span class="number">8.1.1</span> Utiliser  <code>form_for</code></a></li>
<li class="subsection"><a href="sign-up#sec:the_form_html"><span class="number">8.1.2</span> Le formulaire HTML</a></li></ol></li>
<li class="section"><a href="sign-up#sec:signup_failure"><span class="number">8.2</span> Échec de l'inscription</a></li>
<li><ol>
<li class="subsection"><a href="sign-up#sec:testing_failure"><span class="number">8.2.1</span> Test de l'échec</a></li>
<li class="subsection"><a href="sign-up#sec:a_working_form"><span class="number">8.2.2</span> Un formulaire fonctionnel</a></li>
<li class="subsection"><a href="sign-up#sec:signup_error_messages"><span class="number">8.2.3</span> Inscription&nbsp;: messages d'erreur</a></li>
<li class="subsection"><a href="sign-up#sec:filtering_parameter_logging"><span class="number">8.2.4</span> Filtrage des paramètres d'identification</a></li></ol></li>
<li class="section"><a href="sign-up#sec:signup_success"><span class="number">8.3</span> Succès de l'inscription</a></li>
<li><ol>
<li class="subsection"><a href="sign-up#sec:testing_success"><span class="number">8.3.1</span> Tester le succès de l'inscription</a></li>
<li class="subsection"><a href="sign-up#sec:the_finished_signup_form"><span class="number">8.3.2</span> Le formulaire d'inscription finalisé</a></li>
<li class="subsection"><a href="sign-up#sec:the_flash"><span class="number">8.3.3</span> Le message «&nbsp;flash&nbsp;»</a</a></li>
<li class="subsection"><a href="sign-up#sec:the_first_signup"><span class="number">8.3.4</span> La première inscription</a></li></ol></li>
<li class="section"><a href="sign-up#sec:rspec_integration_tests"><span class="number">8.4</span> Test d'intégration RSpec</a></li>
<li><ol>
<li class="subsection"><a href="sign-up#sec:integration_tests_with_style"><span class="number">8.4.1</span> Tests d'intégration avec les styles</a></li>
<li class="subsection"><a href="sign-up#sec:failed_signup"><span class="number">8.4.2</span> Un échec d'inscription ne devrait pas créer un nouvel utilisateur</a></li>
<li class="subsection"><a href="sign-up#sec:successful_signup"><span class="number">8.4.3</span> Le succès d'une inscription devrait créer un nouvel utilisateur</a></li></ol></li>
<li class="section"><a href="sign-up#sec:8.5"><span class="number">8.5</span> Conclusion</a></li>
<li class="section"><a href="sign-up#sec:signup_Exercices"><span class="number">8.6</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="sign-in-sign-out#top"><span class="number">Chapitre 9</span> Connexion, déconnexion</a></li>
<li><ol>
<li class="section"><a href="sign-in-sign-out#sec:sessions"><span class="number">9.1</span> Les sessions</a></li>
<li><ol>
<li class="subsection"><a href="sign-in-sign-out#sec:sessions_controller"><span class="number">9.1.1</span> Le contrôleur de session</a></li>
<li class="subsection"><a href="sign-in-sign-out#sec:signin_form"><span class="number">9.1.2</span> Formulaire d'identification</a></li></ol></li>
<li class="section"><a href="sign-in-sign-out#sec:signin_failure"><span class="number">9.2</span> Échec de l'identification</a></li>
<li><ol>
<li class="subsection"><a href="sign-in-sign-out#sec:reviewing_form_submission"><span class="number">9.2.1</span> Examen de la soumission du formulaire</a></li>
<li class="subsection"><a href="sign-in-sign-out#sec:failed_signin"><span class="number">9.2.2</span> Échec de l'identification (test et code)</a></li></ol></li>
<li class="section"><a href="sign-in-sign-out#sec:signin_success"><span class="number">9.3</span> Succès de l'identification</a></li>
<li><ol>
<li class="subsection"><a href="sign-in-sign-out#sec:the_completed_create_action"><span class="number">9.3.1</span> L'action <code>create</code> («&nbsp;créer&nbsp;») finalisée</a></li>
<li class="subsection"><a href="sign-in-sign-out#sec:remember_me"><span class="number">9.3.2</span> Se souvenir de moi</a></li>
<li class="subsection"><a href="sign-in-sign-out#sec:current_user"><span class="number">9.3.3</span> Utilisateur courant</a></li></ol></li>
<li class="section"><a href="sign-in-sign-out#sec:signing_out"><span class="number">9.4</span> Déconnexion</a></li>
<li><ol>
<li class="subsection"><a href="sign-in-sign-out#sec:destroying_sessions"><span class="number">9.4.1</span> Détruire la session</a></li>
<li class="subsection"><a href="sign-in-sign-out#sec:signin_upon_signup"><span class="number">9.4.2</span> Connection à l'inscription</a></li>
<li class="subsection"><a href="sign-in-sign-out#sec:changing_the_layout_links"><span class="number">9.4.3</span> Changement des liens de la mise en plage</a></li>
<li class="subsection"><a href="sign-in-sign-out#sec:signin_out_integration_tests"><span class="number">9.4.4</span> Test d'intégration de l'identification/déconnexion</a></li></ol></li>
<li class="section"><a href="sign-in-sign-out#sec:9.5"><span class="number">9.5</span> Conclusion</a></li>
<li class="section"><a href="sign-in-sign-out#sec:sign_in_out_Exercices"><span class="number">9.6</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="updating-showing-and-deleting-users#top"><span class="number">Chapitre 10</span> Actualiser, afficher et supprimer de l'utilisateur</a></li>
<li><ol>
<li class="section"><a href="updating-showing-and-deleting-users#sec:updating_users"><span class="number">10.1</span> Actualiser l'utilisateur</a></li>
<li><ol>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:edit_form"><span class="number">10.1.1</span> Formulaire de modification</a></li>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:enabling_edits"><span class="number">10.1.2</span> Permettre les modifications</a></li></ol></li>
<li class="section"><a href="updating-showing-and-deleting-users#sec:protecting_pages"><span class="number">10.2</span> Protéger les pages</a></li>
<li><ol>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:requiring_signed_in_users"><span class="number">10.2.1</span> Utilisateurs identifiés requis</a></li>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:requiring_the_right_user"><span class="number">10.2.2</span> Nécessité du bon utilisateur</a></li>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:friendly_forwarding"><span class="number">10.2.3</span> Redirection conviviale</a></li></ol></li>
<li class="section"><a href="updating-showing-and-deleting-users#sec:showing_users"><span class="number">10.3</span> Afficher les utilisateurs</a></li>
<li><ol>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:user_index"><span class="number">10.3.1</span> Liste des utilisateurs</a></li>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:sample_users"><span class="number">10.3.2</span> Exemples d'utilisateurs</a></li>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:pagination"><span class="number">10.3.3</span> Pagination</a></li>
<li><ol>
<li class="subsubsection"><a href="updating-showing-and-deleting-users#sec:testing_pagination">Test de la pagination</a></li></ol></li>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:partial_refactoring"><span class="number">10.3.4</span> Restructuration des partielles</a></li></ol></li>
<li class="section"><a href="updating-showing-and-deleting-users#sec:destroying_users"><span class="number">10.4</span> Supprimer des utilisateurs</a></li>
<li><ol>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:administrative_users"><span class="number">10.4.1</span> Utilisateurs administrateurs</a></li>
<li><ol>
<li class="subsubsection"><a href="updating-showing-and-deleting-users#sec:revisiting_attr_accessible">Révision de <code>attr_accessible</code></a></li></ol></li>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:the_destroy_action"><span class="number">10.4.2</span> L'action <code>destroy</code> («&nbsp;supprimer&nbsp;»)</a></li></ol></li>
<li class="section"><a href="updating-showing-and-deleting-users#sec:10.5"><span class="number">10.5</span> Conclusion</a></li>
<li class="section"><a href="updating-showing-and-deleting-users#sec:updating_deleting_Exercices"><span class="number">10.6</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="user-microposts#top"><span class="number">Chapitre 11</span> Micro-messages d'utilisateur</a></li>
<li><ol>
<li class="section"><a href="user-microposts#sec:a_micropost_model"><span class="number">11.1</span> Le modèle Micropost («&nbsp;Micro-message&nbsp;»)</a></li>
<li><ol>
<li class="subsection"><a href="user-microposts#sec:the_basic_model"><span class="number">11.1.1</span> Le modèle initial</a></li>
<li><ol>
<li class="subsubsection"><a href="user-microposts#sec:accessible_attribute">Attributs accessibles</a></li></ol></li>
<li class="subsection"><a href="user-microposts#sec:user_micropost_associations"><span class="number">11.1.2</span> Associations Utilisateur/micro-messages</a></li>
<li class="subsection"><a href="user-microposts#sec:ordering_and_dependency"><span class="number">11.1.3</span> Affinements du micro-message</a></li>
<li><ol>
<li class="subsubsection"><a href="user-microposts#sec:default_scope">Portée par défaut</a></li>
<li class="subsubsection"><a href="user-microposts#sec:dependent_destroy">Dependent: destroy (dépendances de la suppression)</a></li></ol></li>
<li class="subsection"><a href="user-microposts#sec:micropost_validations"><span class="number">11.1.4</span> Validations du micro-message</a></li></ol></li>
<li class="section"><a href="user-microposts#sec:showing_microposts"><span class="number">11.2</span> Afficher les micro-messages</a></li>
<li><ol>
<li class="subsection"><a href="user-microposts#sec:augmenting_the_user_show_page"><span class="number">11.2.1</span> Etoffement de la page de l'utilisateur</a></li>
<li class="subsection"><a href="user-microposts#sec:sample_microposts"><span class="number">11.2.2</span> Exemples de micro-messages</a></li></ol></li>
<li class="section"><a href="user-microposts#sec:manipulating_microposts"><span class="number">11.3</span> Manipuler les micro-messages</a></li>
<li><ol>
<li class="subsection"><a href="user-microposts#sec:access_control"><span class="number">11.3.1</span> Contrôle de l'accès</a></li>
<li class="subsection"><a href="user-microposts#sec:creating_microposts"><span class="number">11.3.2</span> Créer des micro-messages</a></li>
<li class="subsection"><a href="user-microposts#sec:a_proto_feed"><span class="number">11.3.3</span> Une proto-alimentation</a></li>
<li class="subsection"><a href="user-microposts#sec:destroying_microposts"><span class="number">11.3.4</span> Supprimer des micro-messages</a></li>
<li class="subsection"><a href="user-microposts#sec:testing_the_new_home_page"><span class="number">11.3.5</span> Test de la nouvelle page d'accueil</a></li></ol></li>
<li class="section"><a href="user-microposts#sec:11.4"><span class="number">11.4</span> Conclusion</a></li>
<li class="section"><a href="user-microposts#sec:micropost_Exercices"><span class="number">11.5</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="following-users#top"><span class="number">Chapitre 12</span> Suivi des utilisateurs</a></li>
<li><ol>
<li class="section"><a href="following-users#sec:the_relationship_model"><span class="number">12.1</span> Le modèle Relation (Relationship model)</a></li>
<li><ol>
<li class="subsection"><a href="following-users#sec:a_problem_with_the_data_model"><span class="number">12.1.1</span> Un problème du modèle de données (et sa solution)</a></li>
<li class="subsection"><a href="following-users#sec:relationship_user_associations"><span class="number">12.1.2</span> Associations Utilisateur/Relations</a></li>
<li class="subsection"><a href="following-users#sec:relationship_validations"><span class="number">12.1.3</span> Validations</a></li>
<li class="subsection"><a href="following-users#sec:following"><span class="number">12.1.4</span> Auteurs suivis</a></li>
<li class="subsection"><a href="following-users#sec:followers"><span class="number">12.1.5</span> Lecteurs</a></li></ol></li>
<li class="section"><a href="following-users#sec:a_web_interface_for_following_and_followers"><span class="number">12.2</span> Une interface web pour les auteurs suivis et les lecteurs</a></li>
<li><ol>
<li class="subsection"><a href="following-users#sec:sample_following_data"><span class="number">12.2.1</span> Exemple de donnée de suivi</a></li>
<li class="subsection"><a href="following-users#sec:stats_and_a_follow_form"><span class="number">12.2.2</span> Statistiques et formulaire de suivi</a></li>
<li class="subsection"><a href="following-users#sec:following_and_followers_pages"><span class="number">12.2.3</span> Pages d'auteurs suivis et de lecteurs</a></li>
<li class="subsection"><a href="following-users#sec:a_working_follow_button_the_standard_way"><span class="number">12.2.4</span> Un bouton de suivi fonctionnant de façon standard</a></li>
<li class="subsection"><a href="following-users#sec:a_working_follow_button_with_ajax"><span class="number">12.2.5</span> Un bouton fonctionnant avec Ajax</a></li></ol></li>
<li class="section"><a href="following-users#sec:the_status_feed"><span class="number">12.3</span> L'état de l'alimention</a></li>
<li><ol>
<li class="subsection"><a href="following-users#sec:motivation_and_strategy"><span class="number">12.3.1</span> Motivation et stratégie</a></li>
<li class="subsection"><a href="following-users#sec:a_first_feed_implementation"><span class="number">12.3.2</span> Une première implémentation de peuplement</a></li>
<li class="subsection"><a href="following-users#sec:scopes_subselects_and_a_lambda"><span class="number">12.3.3</span> Portées, sous-requêtes et fonction <em>lambda</em></a></li>
<li class="subsection"><a href="following-users#sec:the_new_status_feed"><span class="number">12.3.4</span> Nouvel état de l'alimentation</a></li></ol></li>
<li class="section"><a href="following-users#sec:following_conclusion"><span class="number">12.4</span> Conclusion</a></li>
<li><ol>
<li class="subsection"><a href="following-users#sec:extensions_to_the_sample_application"><span class="number">12.4.1</span> Extensions de l'application exemple</a></li>
<li><ol>
<li class="subsubsection"><a href="following-users#sec:replies">Réponses</a></li>
<li class="subsubsection"><a href="following-users#sec:messaging">Notification</a></li>
<li class="subsubsection"><a href="following-users#sec:follower_notifications">Notifications aux lecteurs</a></li>
<li class="subsubsection"><a href="following-users#sec:password_reminders">Rappel du mot de passe</a></li>
<li class="subsubsection"><a href="following-users#sec:signup_confirmation">Confirmation d'inscription</a></li>
<li class="subsubsection"><a href="following-users#sec:rss_feed">Alimentation RSS</a></li>
<li class="subsubsection"><a href="following-users#sec:rest_api">REST API</a></li>
<li class="subsubsection"><a href="following-users#sec:search">Recherche</a></li></ol></li>
<li class="subsection"><a href="following-users#sec:guide_to_further_resources"><span class="number">12.4.2</span> Guide vers d'autres ressources</a></li></ol></li>
<li class="section"><a href="following-users#sec:following_Exercices"><span class="number">12.5</span> Exercices</a></li></ol></li></ol></div>


<div id="main_content"></div>

<p> <span class="preamble">
 <span id="foreword">
<strong> Avant-propos</strong> <br />
 </span>
 </span></p>

<p>Ma précédente compagnie (CD Baby) fut une des premières à basculer intégralement vers Ruby on Rails, et à rebasculer aussi intégralement vers PHP (googlez-moi si vous voulez prendre la mesure du drame). On m'a tellement recommandé ce livre Michael Hartl que je n'ai pu faire autrement que de le lire. C'est ainsi que le <em>Tutoriel Ruby on Rails</em> m'a fait revenir à nouveau à Rails.</p>
<p>Bien qu'ayant parcouru de nombreux livres sur Rails, c'est ce tutoriel-là qui m'a véritablement «&nbsp;mis en possession&nbsp;» de Rails. Tout est fait ici «&nbsp;à la manière de Rails&nbsp;» —&nbsp;une manière qui ne m'avait jamais semblé naturelle avant que je ne lise ce livre. C'est aussi le seul ouvrage sur Rails qui met en place, d'un bout à l'autre, un <em>Développement Dirigé par les Tests</em> (<em>Test-Driven Development</em>), une approche que je savais hautement recommandée par les experts mais dont je n'avais jamais compris aussi bien la pertinence que dans ce livre. Enfin, en incluant Git, GitHub et Heroku dans les exemples de la démonstration, l'auteur vous donne vraiment le goût de ce qu'est le développement d'un projet dans la vie réelle. Et le exemples de code ne sont pas en reste.</p> 
	
<p>La narration linéaire adoptée par ce tutoriel est vraiment un bon format. Personnellement, j'ai étudié <em>Le Tutoriel Rails</em> en trois longues journées, en faisant tous les exemples et les exercices proposés à la fin de chaque chapitre. C'est en lisant ce livre du début à la fin, sans sauter la moindre partie, qu'on en tire tout le bénéfice.</p>

<p>Régalez-vous&nbsp;!</p>

<p><a href="http://sivers.org/">Derek Sivers</a> (<a href="http://sivers.org/">sivers.org</a>) <br />
<em>Précédemment&nbsp;: Fondateur de </em> <a href="http://www.cdbaby.com/"><em>CD Baby</em></a> <br />
<em>Actuellement&nbsp;: Fondateur de </em> <a href="http://thoughts.pro/"><em>Thoughts Ltd.</em></a> <br /></p>

<p> <span class="preamble">
<strong> Remerciements</strong> <br />
 </span></p>

<p>Ce <em>Tutoriel Ruby on Rails</em> doit beaucoup à mon livre précédent sur Rails, <em>RailsSpace</em>, et donc à mon co-auteur <a href="http://aure.com/">Aurelius Prochazka</a>. J'aimerais remercier Aure à la fois pour le travail qu'il a accompli sur ce précédent livre et pour son soutien pour le présent ouvrage. J'aimerais aussi remercier Debra Williams Cauley, mon éditeur pour les deux ouvrages&nbsp;; aussi longtemps qu'elle jouera avec moi au baseball, je continuerai d'écrire des livres pour elle.</p>

<p>J'aimerais remercier une longue liste de Rubyistes qui m'ont parlé et inspiré au cours des années&nbsp;: David Heinemeier Hansson, Yehuda Katz, Carl Lerche, Jeremy Kemper, Xavier Noria, Ryan Bates, Geoffrey Grosenbach, Peter Cooper, Matt Aimonetti, Gregg Pollack, Wayne&nbsp;E. Seguin, Amy Hoy, Dave Chelimsky, Pat Maddox, Tom Preston-Werner, Chris Wanstrath, Chad Fowler, Josh Susser, Obie Fernandez, Ian McFarland, Steven Bristol, Giles Bowkett, Evan Dorn, Long Nguyen, James Lindenbaum, Adam Wiggins, Tikhon Bernstam, Ron Evans, Wyatt Greene, Miles Forrest, les gens bien de Pivotal Labs, le gang Heroku, les mecs de thoughtbot et l'équipe de GitHub. Enfin, tellement, tellement, tellement de lecteurs —&nbsp;beaucoup trop pour les citer tous&nbsp;— qui ont contribué par leur rapport de bogues et leurs suggestions durant l'écriture de ce livre, et je tiens à saluer leur aide sans laquelle ce livre ne serait pas ce qu'il est. <br /></p>

<p> <span class="preamble">
 <span id="author">
<strong> À propos de l'auteur</strong> <br />
 </span>
 </span></p>

<p><a href="http://michaelhartl.com/">Michael Hartl</a> est programmeur, éducateur et entrepreneur. Il est le co-auteur de <em>RailsSpace</em>, un tutoriel Rails publié en 2007, et a été co-fondateur et développeur en chef de <a href="http://insoshi.com/">Insoshi</a>, une plateforme de réseau social <a href="http://github.com/popular/forked">populaire</a> en Ruby on Rails. Précédement, il a enseigné la théorie et la physique informatique au <a href="http://www.caltech.edu/">California Institute of Technology</a> (Caltech), où il a reçu le Lifetime Achievement Award for Excellence en enseignement. Michael est diplômé du <a href="http://college.harvard.edu/">Harvard College</a>, a un <a href="http://resolver.caltech.edu/CaltechETD:etd-05222003-161626">Ph.D. en physique</a> (un doctorat. NdT) de <a href="http://www.caltech.edu/">Caltech</a>, et il est ancien élève du programme des entrepreneurs <a href="http://ycombinator.com/">Y&nbsp;Combinator</a>. <br /></p>

<p> <span id="license" class="preamble">
<strong> Copyright et license</strong> <br />
 </span></p>

<p><em>Le Tutoriel Ruby on Rails&nbsp;: apprendre Rails par l'exemple</em>. Copyright &copy; 2010 par Michael Hartl. Tout le code source du <em>Tutoriel Ruby on Rails</em> est disponible sous la license <a href="http://www.opensource.org/licenses/mit-license.php">MIT License</a> et la licence <a href="http://en.wikipedia.org/wiki/Beerware">Beerware License</a>.</p>

<pre class="verbatim">   Copyright (c) 2010 Michael Hartl

   Permission est accordée, à titre gratuit, à toute personne obtenant
   une copie de ce logiciel et la documentation associée, pour faire des 
   modification dans le logiciel sans restriction et sans limitation des
   droits d’utiliser, copier, modifier, fusionner, publier, distribuer,
   concéder sous licence, et / ou de vendre les copies du Logiciel, et à
   autoriser les personnes auxquelles le Logiciel est meublé de le faire, 
   sous réserve des conditions suivantes:

   L’avis de copyright ci-dessus et cette autorisation doit être inclus
   dans toutes les copies ou parties substantielles du Logiciel.

   LE LOGICIEL EST FOURNI «TEL QUEL», SANS GARANTIE D’AUCUNE SORTE, 
   EXPLICITE OU IMPLICITE, Y COMPRIS, MAIS SANS S’Y LIMITER, LES 
   GARANTIES DE QUALITÉ MARCHANDE, ADAPTATION À UN USAGE PARTICULIER ET
   D’ABSENCE DE CONTREFAÇON. EN AUCUN CAS LES AUTEURS OU TITULAIRES DU
   ETRE TENU RESPONSABLE DE TOUT DOMMAGE, RÉCLAMATION OU AUTRES
   RESPONSABILITÉ, SOIT DANS UNE ACTION DE CONTRAT, UN TORT OU AUTRE,
   PROVENANT DE, DE OU EN RELATION AVEC LE LOGICIEL OU L’UTILISATION OU
   DE TRANSACTIONS AUTRES LE LOGICIEL.
	
</pre>




<pre class="verbatim">/*
 * ------------------------------------------------------------
 * &quot;LA LICENCE BEERWARE&quot; (Révision 42)&nbsp;:
 * Michael Hartl a écrit ce code. Aussi longtemps que vous
 * conservez cette note, vous pouvez faire ce que vous voulez
 * de ce travail. Si nous nous rencontrons un jour, et que vous
 * pensez que ce travail en vaut la peine, vous pourrez me
 * payer une bière en retour.
 * ------------------------------------------------------------
 */</pre>



<div id="top"></div>


<h1 class="chapter"><a id="sec:8" href="sign-up#top" class="heading"><span class="number">chapitre 8</span> Inscription</a></h1>


<p>Maintenant que nous avons un modèle User fonctionnel, il est temps d'ajouter quelques capacités dont ne peut pas se passer un site web&nbsp;: laisser ses utilisateurs s'inscrire &mdash;&nbsp;et ainsi tenir la promesse faite à la <a class="ref" href="filling-in-the-layout#sec:user_signup">section&nbsp;5.3</a>, «&nbsp;Inscription de l'utilisateur&nbsp;: une première étape&nbsp;».
Nous allons utiliser un <em>formulaire</em> HTML pour soumettre les informations d'inscription de l'utilisateur à notre application à la <a class="ref" href="sign-up#sec:signup_form">section&nbsp;8.1</a>, qui serviront à créer un nouvel utilisateur et à savuer ses attributs dans la base de données à la <a class="ref" href="sign-up#sec:signup_success">section&nbsp;8.3</a>. Comme d'habitude, nous allons écrire des tests à mesure que nous développons, et à la <a class="ref" href="sign-up#sec:rspec_integration_tests">section&nbsp;8.4</a> nous utiliserons le support RSpec pour la syntaxe de la navigation web pour écrire des tests d'intégration succincts et expressifs.</p>

<p>Puis nous allons créer un nouvel utilisateur dans ce chapitre, vous voudrez peut-être initialiser la base de données pour supprimer tous les utilisateurs créés à la console (par exemple ceux de la <a class="ref" href="modeling-and-viewing-users-two#sec:a_name_and_a_gravatar">section&nbsp;7.3.2</a>), de telle sorte que vos résultats correspondent à ceux montrés dans ce tutoriel. Vous pouvez faire cela comme suit&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rake db:reset
</pre></div>
</div>


<p>Si vous suivez votre développement en utilisant le contrôle de version, fait une branche sujet comme d'habitude&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout master
<span class="gp">$</span> git checkout -b signing-up
</pre></div>
</div>


<div class="label" id="sec:signup_form"></div>


<h2><a id="sec:8.1" href="sign-up#sec:signup_form" class="heading"><span class="number">8.1</span> Formulaire d'inscription</a></h2>


<p>Souvenez-vous d'après la <a class="ref" href="filling-in-the-layout#sec:users_controller">section&nbsp;5.3.1</a> que nous avons déjà des tests pour la page des nouveaux utilisateurs (<em>signup page</em>), vu à l'origine dans l'<a class="ref" href="filling-in-the-layout#code:signup_title_test">extrait&nbsp;5.26</a> et reproduits dans l'<a class="ref" href="sign-up#code:new_users_tests">extrait&nbsp;8.1</a> (comme promis à la <a class="ref" href="modeling-and-viewing-users-two#sec:tests_with_factories">section&nbsp;7.3.1</a>, nous sommes passés de <code>get &rsquo;new&rsquo;</code> à <code>get :new</code> parce que c'est ce que mes doigts veulent taper). De plus, nous avons vu dans l'<a class="ref" href="filling-in-the-layout#fig:blank_signup_page">illustration&nbsp;5.10</a> (et à nouveau dans l'<a class="ref" href="sign-up#fig:blank_signup_page_recap">illustration&nbsp;8.1</a>) que cette page d'inscription est pour le moment vierge&nbsp;: donc inutile pour inscrire de nouveaux utilisateurs. Le but de cette section sera de commencer à changer ce triste état des choses en produisant la maquette de formulaire d'inscription de l'<a class="ref" href="sign-up#fig:signup_mockup">illustration&nbsp;8.2</a>.</p>

<div class="label" id="code:new_users_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 8.1.</span> <span class="description">Les tests pour la page d'inscription des utilisateurs (vu d'abord dans l'<a class="ref" href="filling-in-the-layout#code:signup_title_test">extrait&nbsp;5.26</a>). <br /> <code>spec/controllers/users_controller_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">UsersController</span> <span class="k">do</span>
  <span class="n">render_views</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;GET &#39;new&#39;&quot;</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">&quot;devrait réussir&quot;</span> <span class="k">do</span>
      <span class="n">get</span> <span class="ss">:new</span>
      <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">be_success</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;devrait avoir le bon titre&quot;</span> <span class="k">do</span>
      <span class="n">get</span> <span class="ss">:new</span>
      <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="s2">&quot;Inscription&quot;</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="fig:blank_signup_page_recap"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/blank_signup_page.png" alt="blank_signup_page" /></span></div><div class="caption"><span class="header">Illustration 8.1: </span><span class="description">L'état actuel de la page d'inscription <a href="http://localhost:3000/signup"><tt>/signup</tt></a>.&nbsp;<a href="http://railstutorial.org/images/figures/blank_signup_page-full.png">(taille normale)</a></span></div></div>




<div class="label" id="fig:signup_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/signup_mockup.png" alt="signup_mockup" /></span></div><div class="caption"><span class="header">Illustration 8.2: </span><span class="description">Une maquette de la page d'inscription .&nbsp;<a href="http://railstutorial.org/images/figures/signup_mockup-full.png">(taille normale)</a></span></div></div>




<div class="label" id="sec:using_form_for"></div>


<h3><a id="sec:8.1.1" href="sign-up#sec:using_form_for" class="heading"><span class="number">8.1.1</span> Utiliser <code>form_for</code></a></h3>


<p>L'élément HTML nécessaire pour soumettre des information à un site à distane est un <em>formulaire</em>, ce qui suggère qu'une bonne première étape vers la registration des utilisateurs est de faire un formulaire acceptant leurs information d'inscription. Nous pouvons accomplir cela en Rails avec la méthode <em>helper</em> <code>form_for</code> (<em>formulaire_pour</em>)&nbsp;; le résultat apparait dans l'<a class="ref" href="sign-up#code:new_user_form">extrait&nbsp;8.2</a> (les lecteurs familiers de Rails&nbsp;2.x doivent noter que <code>form_for</code> utilise maintenant la syntaxe ERb «&nbsp;pourcent-égal&nbsp;» pour insérer le contenu&nbsp;; c'est-à-dire qu'où Rails&nbsp;2.x utilisait <tt class="verb">&lt;% form_for ... %&gt;</tt>, Rails&nbsp;3 utilise maintenant <tt class="verb">&lt;%= form_for ... %&gt;</tt>).</p>

<div class="label" id="code:new_user_form"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 8.2.</span> <span class="description">Un formulaire pour l'inscription de nouveaux utilisateurs. <br /> <code>app/views/users/new.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>Inscription<span class="nt">&lt;/h1&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;field&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:nom</span> <span class="cp">%&gt;</span><span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:nom</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;field&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:email</span> <span class="cp">%&gt;</span><span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:email</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;field&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password</span> <span class="cp">%&gt;</span><span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;field&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password_confirmation</span><span class="p">,</span> <span class="s2">&quot;Confirmation&quot;</span> <span class="cp">%&gt;</span><span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password_confirmation</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;actions&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">&quot;Inscription&quot;</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p>Cassons cela pièce à pièce. La présence du mot-clé <code>do</code> indique que <code>form_for</code> comprend un bloc (<a class="ref" href="rails-flavored-ruby#sec:blocks">section&nbsp;4.3.2</a>), qui possède une variable, que nous avons appelée <code>f</code> pour «&nbsp;formulaire&nbsp;». À l'intérieur de l'<em>helper</em> <code>form_for</code>, <code>f</code> est un objet qui représente une formulaire&nbsp;; comme c'est souvent le cas avec les <em>helpers</em> Rails, nous n'avons pas besoin de connaitre tous les détails de l'implémentation, mais ce que nous avons <em>besoin</em> de connaitre est ce que l'objet <code>f</code> fait&nbsp;: quand appelé avec une méthode correspondant à un <a href="http://www.w3schools.com/html/html_forms.asp">élément formulaire HTML</a> &mdash;&nbsp;tel qu'un champ de texte (<code>text field</code>), un bouton radio ou un champ de mot de passe&nbsp;&mdash; il retourne le code pour cet élément spécifiquement conçu pour définir un attribut de l'objet <code>@user</code>. En d'autres termes&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;field&quot;</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:nom</span> <span class="cp">%&gt;</span><span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:nom</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div>


<p>… crée le code HTML nécessaire pour faire un élément champ de texte labélisé approprié pour définir l'attribut <code>nom</code> d'un modèle User.</p>

<p>Pour voir cela en action, nous avons besoin de naviguer et de regarder le code HTML produit en fait par ce formulaire, mais ici nous avons un problème&nbsp;: la page pour le moment échoue, parce que nous n'avons pas défini la variable <code>@user</code> &mdash;&nbsp;comme toute variable d'instance non définie (<a class="ref" href="rails-flavored-ruby#sec:objects_and_message_passing">section&nbsp;4.2.3</a>), <code>@user</code> est pour le moment <code>nil</code>. De façon appropriée, si vous jouez votre suite de tests maintenant, vous verrez que la page d'inscription échoue. Pour obtenir qu'elle s'affiche et rendre notre formulaire, nous devons définir une variable <code>@user</code> dans l'action du contrôleur correspondant à <code>new.html.erb</code>, c'est-à-dire l'action <code>new</code> dans le contrôleur Users. L'helper <code>form_for</code> attend que <code>@user</code> soit un objet User, et puisque nous créer un <em>nouvel</em> utilisateur nous utiliserons simplement <code>User.new</code>, comme dans l'<a class="ref" href="sign-up#code:new_action_with_user">extrait&nbsp;8.3</a>.</p>

<div class="label" id="code:new_action_with_user"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 8.3.</span> <span class="description">Ajout d'une variable <code>@user</code> à l'action <code>new</code>. <br /> <code>app/controllers/users_controller.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">new</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span>
    <span class="vi">@titre</span> <span class="o">=</span> <span class="s2">&quot;Inscription&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Avec la variable <code>@user</code> ainsi définie, les tests devraient réussir à nouveau,<sup class="footnote" id="fnref:8.1"><a href="#fn:8.1">1</a></sup> et maintenant le formulaire (avec un peu de stylisation qui vient de l'<a class="ref" href="sign-up#code:form_css">extrait&nbsp;8.4</a>) apparait comme dans l'<a class="ref" href="sign-up#fig:signup_form">illustration&nbsp;8.3</a>.</p>

<div class="label" id="code:form_css"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 8.4.</span> <span class="description">Une quantité <a href="http://www.youtube.com/watch?v=MlfcF1I5e_g">wafer-thin</a> de CSS pour le formulaire d'inscription. <br /> <code>public/stylesheets/custom.css</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="nt">div</span><span class="nc">.field</span><span class="o">,</span> <span class="nt">div</span><span class="nc">.actions</span> <span class="p">{</span>
  <span class="k">margin-bottom</span><span class="o">:</span> <span class="m">10px</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div></div>




<div class="label" id="fig:signup_form"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/signup_form.png" alt="signup_form" /></span></div><div class="caption"><span class="header">Illustration 8.3: </span><span class="description">Le formulaire d'inscription  <a href="http://localhost:3000/signup"><tt>/signup</tt></a> pour de nouveaux utilisateurs.&nbsp;<a href="http://railstutorial.org/images/figures/signup_form-full.png">(taille normale)</a></span></div></div>




<div class="label" id="sec:the_form_html"></div>


<h3><a id="sec:8.1.2" href="sign-up#sec:the_form_html" class="heading"><span class="number">8.1.2</span> Le formulaire HTML</a></h3>


<p>Comme indiqué par <a class="ref" href="sign-up#fig:signup_form">illustration&nbsp;8.3</a>, la page d'inscription est maintenant rendue proprement, indiquant que le code <code>form_for</code> dans l'<a class="ref" href="sign-up#code:new_user_form">extrait&nbsp;8.2</a> produit du code HTML valide. Si vous regardez ce code HTML pour le formulaire généré (en utilisant soit <a href="http://getfirebug.com/">Firebug</a> ou le menu «&nbsp;Code source de la page&nbsp;» de votre navigateur), vous devriez voir le balisage tel que dans l'<a class="ref" href="sign-up#code:signup_form_html">extrait&nbsp;8.5</a>. Bien que de nombreux détails ne sont pas utiles à notre propos, prenons un moment pour mettre en évidence les parties les plus importantes de sa structure.</p>

<div class="label" id="code:signup_form_html"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 8.5.</span> <span class="description">Le code HTML pour le formulaire de l'<a class="ref" href="sign-up#fig:signup_form">illustration&nbsp;8.3</a>.</span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">&quot;/users&quot;</span> <span class="na">class=</span><span class="s">&quot;new_user&quot;</span> <span class="na">id=</span><span class="s">&quot;new_user&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;div</span> <span class="na">style=</span><span class="s">&quot;margin:0;padding:0;display:inline&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;input</span> <span class="na">nom=</span><span class="s">&quot;authenticity_token&quot;</span> <span class="na">type=</span><span class="s">&quot;hidden&quot;</span>
       <span class="na">value=</span><span class="s">&quot;rB82sI7Qw5J9J1UMILG/VQL411vH5putR+JwlxLScMQ=&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/div&gt;</span>

  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;field&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;user_nom&quot;</span><span class="nt">&gt;</span>Nom<span class="nt">&lt;/label&gt;&lt;br</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;user_nom&quot;</span> <span class="na">nom=</span><span class="s">&quot;user[nom]&quot;</span> <span class="na">size=</span><span class="s">&quot;30&quot;</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/div&gt;</span>

  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;field&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;user_email&quot;</span><span class="nt">&gt;</span>Email<span class="nt">&lt;/label&gt;&lt;br</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;user_email&quot;</span> <span class="na">nom=</span><span class="s">&quot;user[email]&quot;</span> <span class="na">size=</span><span class="s">&quot;30&quot;</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;field&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;user_password&quot;</span><span class="nt">&gt;</span>Password<span class="nt">&lt;/label&gt;&lt;br</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;user_password&quot;</span> <span class="na">nom=</span><span class="s">&quot;user[password]&quot;</span> <span class="na">size=</span><span class="s">&quot;30&quot;</span> <span class="na">type=</span><span class="s">&quot;password&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/div&gt;</span>

  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;field&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;user_password_confirmation&quot;</span><span class="nt">&gt;</span>Confirmation<span class="nt">&lt;/label&gt;&lt;br</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;user_password_confirmation&quot;</span> <span class="na">nom=</span><span class="s">&quot;user[password_confirmation]&quot;</span>
           <span class="na">size=</span><span class="s">&quot;30&quot;</span> <span class="na">type=</span><span class="s">&quot;password&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;actions&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;user_submit&quot;</span> <span class="na">nom=</span><span class="s">&quot;commit&quot;</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">value=</span><span class="s">&quot;Inscription&quot;</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</pre></div>
</div></div>


<p>Nous allons commencer avec la structure interne. En comparant l'<a class="ref" href="sign-up#code:new_user_form">extrait&nbsp;8.2</a> avec l'<a class="ref" href="sign-up#code:signup_form_html">extrait&nbsp;8.5</a>, nous voyons que le Ruby embarqué&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;field&quot;</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:nom</span> <span class="cp">%&gt;</span><span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:nom</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div>


<p>… produit le code HTML&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;field&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;user_nom&quot;</span><span class="nt">&gt;</span>Nom<span class="nt">&lt;/label&gt;&lt;br</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;user_nom&quot;</span> <span class="na">nom=</span><span class="s">&quot;user[nom]&quot;</span> <span class="na">size=</span><span class="s">&quot;30&quot;</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div>


<p>… et&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;field&quot;</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:password</span> <span class="cp">%&gt;</span><span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:password</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div>


<p>… produit le code HTML&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;field&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;user_password&quot;</span><span class="nt">&gt;</span>Password<span class="nt">&lt;/label&gt;&lt;br</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;user_password&quot;</span> <span class="na">nom=</span><span class="s">&quot;user[password]&quot;</span> <span class="na">size=</span><span class="s">&quot;30&quot;</span> <span class="na">type=</span><span class="s">&quot;password&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div>


<p>Comme vu dans l'<a class="ref" href="sign-up#fig:filled_in_form">illustration&nbsp;8.4</a>, les champs de saisie textuels (<code>type="text"</code>) affichent simplement leur contenu, tandis que les champs mot de passe (<code>type="password"</code>) masquent leur contenu pour des questions de sécurité, comme le montre l'<a class="ref" href="sign-up#fig:filled_in_form">illustration&nbsp;8.4</a>.</p>

<div class="label" id="fig:filled_in_form"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/filled_in_form.png" alt="filled_in_form" /></span></div><div class="caption"><span class="header">Illustration 8.4: </span><span class="description">Un formulaire rempli, montrant la différence entre les champs <code>text</code> et les champs <code>password</code> (<em>mot de passe</em>).&nbsp;<a href="http://railstutorial.org/images/figures/filled_in_form-full.png">(taille normale)</a></span></div></div>


<p>Comme nous le verrons à la <a class="ref" href="sign-up#sec:signup_success">section&nbsp;8.3</a>, la clé pour créer un utilisateur est l'attribut spécial <code>name</code> dans chaque <code>input</code>:</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;user_nom&quot;</span> <span class="na">name=</span><span class="s">&quot;user[nom]&quot;</span> <span class="na">-</span> <span class="na">-</span> <span class="na">-</span> <span class="nt">/&gt;</span>
.
.
.
<span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;user_password&quot;</span> <span class="na">name=</span><span class="s">&quot;user[password]&quot;</span> <span class="na">-</span> <span class="na">-</span> <span class="na">-</span> <span class="nt">/&gt;</span>
</pre></div>
</div>


<p>Ces valeurs <code>name</code> permettent à Rails de construire une table d'initialisation (via la variable <code>params</code> initialement vue à la <a class="ref" href="modeling-and-viewing-users-one#sec:users_show">section&nbsp;6.3.2</a>) pour créer des utilisateurs en utilisant les valeurs entrées par l'utilisateur, comme nous le verrons à la <a class="ref" href="sign-up#sec:signup_failure">section&nbsp;8.2</a>.</p>

<p>Le second élément important est la balise <code>form</code> elle-même. Rails crée la balise <code>form</code> en utilisant l'objet <code>@user</code>&nbsp;: parce que chaque objet Ruby connait sa propre classe (<a class="ref" href="rails-flavored-ruby#sec:constructors">section&nbsp;4.4.1</a>), Rails peut savoir que <code>@user</code> est de classe <code>User</code>&nbsp;; plus encore, puisque <code>@user</code> est un <em>nouvel</em> utilisateur, Rails sait construire un formulaire avec la méthode <code>post</code>, qui est le verbe approprié pour créer un nouvel objet (<a class="ref" href="static-pages#sidebar:get_etc">Box&nbsp;3.1</a>):</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">&quot;/users&quot;</span> <span class="na">class=</span><span class="s">&quot;new_user&quot;</span> <span class="na">id=</span><span class="s">&quot;new_user&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>
</pre></div>
</div>


<p>Ici les attributs <code>class</code> et <code>id</code> ne sont pas très pertinents&nbsp;; ce qui est important c'est <code>action="/users"</code> et <code>method="post"</code>. Ensemble, ils constituent les instructions pour prendre en compte une requête HTML <tt>POST</tt> à l'URL <tt>/users</tt>. Nous allons dans le deux prochaines sections les effets que cela a.</p>

<p>Enfin, notez que le code plutôt obscur pour le «&nbsp;authenticity token&nbsp;»&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">style=</span><span class="s">&quot;margin:0;padding:0;display:inline&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;input</span> <span class="na">nom=</span><span class="s">&quot;authenticity_token&quot;</span> <span class="na">type=</span><span class="s">&quot;hidden&quot;</span>
       <span class="na">value=</span><span class="s">&quot;rB82sI7Qw5J9J1UMILG/VQL411vH5putR+JwlxLScMQ=&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div>


<p>Ici Rails utilise une valeur spéciale unique pour contrecarrer une attaque particulière appelée une <em>contrefaçon</em> (<em>forgery</em>)&nbsp;; consultez <a href="http://stackoverflow.com/questions/941594/understand-rails-authenticity-token">the Stack Overflow entry on the Rails authenticity token</a> si vous êtes intéressé par les détails de son fonctionnement et pourquoi c'est important. Heureusement, Rails prend soin du problème pour nous, et la balise input est <code>hidden</code> (<em>cachée</em>) donc vous n'avez pas à y jeter un coup d'œil plus attentif, mais comme elle sautait aux yeux en consultant le code source, je voulais au moins vous en parler.</p>

<div class="label" id="sec:signup_failure"></div>


<h2><a id="sec:8.2" href="sign-up#sec:signup_failure" class="heading"><span class="number">8.2</span> Échec de l'inscription</a></h2>


<p>Bien que nous ayons brièvement examiné le code HTML du formulaire de l'<a class="ref" href="sign-up#fig:signup_form">illustration&nbsp;8.3</a> (vu dans l'<a class="ref" href="sign-up#code:signup_form_html">extrait&nbsp;8.5</a>),
c'est plus compréhensible dans le contexte d'un <em>échec d'inscription</em>. Juste en donnant un formulaire d'inscription qui accepte une soumission invalide et redonne la page d'inscription (comme maquété dans l'<a class="ref" href="sign-up#fig:signup_failure_mockup">illustration&nbsp;8.5</a>) est un accomplissement significatif, et c'est le but de cette section.</p>

<div class="label" id="fig:signup_failure_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/signup_failure_mockup.png" alt="signup_failure_mockup" /></span></div><div class="caption"><span class="header">Illustration 8.5: </span><span class="description">Une maquette pour l'échec de la page d'inscription.&nbsp;<a href="http://railstutorial.org/images/figures/signup_failure_mockup-full.png">(taille normale)</a></span></div></div>




<div class="label" id="sec:testing_failure"></div>


<h3><a id="sec:8.2.1" href="sign-up#sec:testing_failure" class="heading"><span class="number">8.2.1</span> Tester l'échec</a></h3>


<p>Souvenez-vous de la <a class="ref" href="modeling-and-viewing-users-one#sec:a_users_resource">section&nbsp;6.3.3</a> qu'ajouter <code>resources :users</code> au fichier <code>routes.rb</code> (<a class="ref" href="modeling-and-viewing-users-one#code:users_resource">extrait&nbsp;6.26</a>) permettait de s'assurer automatiquement que notre application Rails répondait aux URLs RESTful de la <a class="ref" href="modeling-and-viewing-users-one#table:RESTful_users">Table&nbsp;6.2</a>. En particulier, cela assurait qu'une requête <tt>POST</tt> pour <tt>/users</tt> était traitée par l'action <code>create</code>. Notre stratégie pour l'action <code>create</code> (<em>créer</em>) est d'utiliser la soumission du formulaire pour fabriquer une nouvel objet utilisateur en utilisant <code>User.new</code>, en essayant (et échouant) de sauver cette utilisateur, et alors de retourner la page d'inscription pour une possible re-soumission. Notre tâche est d'écrire les tests pour cette action, et d'ajouter ensuite <code>create</code> au contrôleur Users pour le faire réussir.</p>

<p>Commençons par revisiter le code du formulaire d'inscription&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">&quot;/users&quot;</span> <span class="na">class=</span><span class="s">&quot;new_user&quot;</span> <span class="na">id=</span><span class="s">&quot;new_user&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>
</pre></div>
</div>


<p>Comme indique à la <a class="ref" href="sign-up#sec:the_form_html">section&nbsp;8.1.2</a>, ce code HTML émet une requête <tt>POST</tt> pour l'URL <tt>/users</tt>. En analogie à la méthode <code>get</code>, qui émet une requête <tt>GET</tt> à l'intérieur des tests, nous utilisons la méthode <code>post</code> pour émettre un requête <tt>POST</tt> pour l'action <code>create</code>. Comme nous allons le voir brièvement, <code>create</code> reçoit une table correspond au type d'objet qui doit être créé&nbsp;; puisque c'est un test pour l'<em>échec</em> de l'inscription, nous allons juste passer la table <code>@attr</code> avec une entrée vierge, comme montré dans l'<a class="ref" href="sign-up#code:failing_create_specs">extrait&nbsp;8.6</a>. C'est essentiellement équivalent à visiter la page d'inscription et de cliquer sur le bouton de soumissions sans avoir rempli aucun des champs de saisie.</p>

<div class="label" id="code:failing_create_specs"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 8.6.</span> <span class="description">Tests pour l'échec de l'inscription de l'utilisateur. <br /> <code>spec/controllers/users_controller_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">UsersController</span> <span class="k">do</span>
  <span class="n">render_views</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>

  <span class="n">describe</span> <span class="s2">&quot;POST &#39;create&#39;&quot;</span> <span class="k">do</span>

    <span class="n">describe</span> <span class="s2">&quot;failure&quot;</span> <span class="k">do</span>

      <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
        <span class="vi">@attr</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:nom</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="ss">:password</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                  <span class="ss">:password_confirmation</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span> <span class="p">}</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;ne devrait pas créer d'utilisateur&quot;</span> <span class="k">do</span>
        <span class="nb">lambda</span> <span class="k">do</span>
          <span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="vi">@attr</span>
        <span class="k">end</span><span class="o">.</span><span class="n">should_not</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;devrait avoir le bon titre&quot;</span> <span class="k">do</span>
        <span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="vi">@attr</span>
        <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;titre&quot;</span><span class="p">,</span> <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="s2">&quot;Inscription&quot;</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;devrait rendre la page &#39;new&#39;&quot;</span> <span class="k">do</span>
        <span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="vi">@attr</span>
        <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;new&#39;</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Les deux tests finaux sont relativement simples&nbsp;: nous nous assurons que le titre est correct, et puis nous vérifions qu'une inscription défectueuse renvoie bien à nouveau la page d'inscription d'un nouvel utilisateur (en utilisant la méthode RSpec <code>render_template</code>). Le premier test, en revanche, est un peu plus délicat.</p>

<p>Le but du test&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="s2">&quot;ne devrait pas créer d'utilisateur&quot;</span> <span class="k">do</span>
  <span class="nb">lambda</span> <span class="k">do</span>
    <span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="vi">@attr</span>
  <span class="k">end</span><span class="o">.</span><span class="n">should_not</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>


<p>… est censé vérifier que l'échec de l'action <code>create</code> ne crée pas d'utilisateur dans la base de données. Pour ce faire, il introduit deux éléments nouveaux. D'abord, nous utilisons la méthode RSpec <code>change</code> pour retourner le changement du nombre d'utilisateurs dans la base de données&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span>
</pre></div>
</div>


<p>Cela diffère de la méthode Active Record <code>count</code>, qui retourne simplement combien d'enregistrement du type demandé sont dans la base de données. Par exemple, si vous avez réinitialisé la base de données de développement au début de ce chapitre, ce compte devrait à présent être de&nbsp;<code>0</code>&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">count</span>
<span class="go">=&gt; 0</span>
</pre></div>
</div>


<p>La seconde nouvelle idée est d'enrouler l'étape <code>post :create</code> dans un «&nbsp;package&nbsp;» en utilisant la construction Ruby appelée un <code>lambda</code>,<sup class="footnote" id="fnref:8.2"><a href="#fn:8.2">2</a></sup> qui nous permet de vérifier qu'elle ne change pas le compte de <code>User</code>&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="nb">lambda</span> <span class="k">do</span>
  <span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="vi">@attr</span>
<span class="k">end</span><span class="o">.</span><span class="n">should_not</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span>
</pre></div>
</div>


<p>Bien que ce <code>lambda</code> peut semble étrange pour le moment, il y en aura d'autres exemple dans les tests à venir, et le modèle deviendra rapidement clair pour vous.</p>

<div class="label" id="sec:a_working_form"></div>


<h3><a id="sec:8.2.2" href="sign-up#sec:a_working_form" class="heading"><span class="number">8.2.2</span> Un formulaire fonctionnel</a></h3>


<p>Nous pouvons faire réussir les tests de la <a class="ref" href="sign-up#sec:testing_failure">section&nbsp;8.2.1</a> avec le code de l'<a class="ref" href="sign-up#code:first_create_action">extrait&nbsp;8.7</a>. Cet extrait inclut une seconde utilisation de la méthode <code>render</code>, que nous avons vue pour la première fois dans le contexte des <em>partiels</em> (<a class="ref" href="filling-in-the-layout#sec:partials">section&nbsp;5.1.3</a>)&nbsp;; comme vous pouvez le voir, <code>render</code> fonctionne aussi bien dans les actions de contrôleur . Notez que nous avons pris la liberté d'introduire une structure <code>if</code>-<code>else</code> (<em>si</em>-<em>sinon</em>) qui nous permet de traiter les cas d'échec et de succès séparément en se basant sur la valeur de <code>@user.save</code>.</p>

<div class="label" id="code:first_create_action"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 8.7.</span> <span class="description">Une action <code>create</code> qui peut traiter les échec d'inscription (mais pas les succès). <br /> <code>app/controllers/users_controller.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
      <span class="c1"># Traite un succès d'enregistrement.</span>
    <span class="k">else</span>
      <span class="vi">@titre</span> <span class="o">=</span> <span class="s2">&quot;Inscription&quot;</span>
      <span class="n">render</span> <span class="s1">&#39;new&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>La meilleure façon de comprendre le fonctionnement du code de l'<a class="ref" href="sign-up#code:first_create_action">extrait&nbsp;8.7</a> est de <em>soumettre</em> le formulaire avec des données d'inscription invalides&nbsp;; le résultat apparait dans l'<a class="ref" href="sign-up#fig:signup_failure_rails_3">illustration&nbsp;8.6</a>.</p>

<div class="label" id="fig:signup_failure_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/signup_failure_rails_3.png" alt="signup_failure_rails_3" /></span></div><div class="caption"><span class="header">Illustration 8.6: </span><span class="description">Échec d'inscription avec une table <code>params</code>.&nbsp;<a href="http://railstutorial.org/images/figures/signup_failure_rails_3-full.png">(taille normale)</a></span></div></div>


<p>Pour obtenir une image plus claire de comment Rails traite la soumission, jetons un coup d'œil plus précis à la table <code>params</code> dans les informations de débuggage en bas de la page de l'<a class="ref" href="sign-up#fig:signup_failure_rails_3">illustration&nbsp;8.6</a>:</p>

<div class="code"><div class="highlight"><pre><span class="nn">---</span> <span class="kt">!map</span><span class="l-Scalar-Plain">:ActiveSupport::HashWithIndifferentAccess</span> 
<span class="l-Scalar-Plain">commit</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Inscription</span>
<span class="l-Scalar-Plain">authenticity_token</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">rB82sI7Qw5J9J1UMILG/VQL411vH5puR+Jw1xL5cMQ=</span>
<span class="l-Scalar-Plain">action</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">create</span>
<span class="l-Scalar-Plain">controller</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">users</span>
<span class="l-Scalar-Plain">user</span><span class="p-Indicator">:</span> <span class="kt">!map</span><span class="l-Scalar-Plain">:ActiveSupport::HashWithIndifferentAccess</span> 
  <span class="l-Scalar-Plain">nom</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Foo Bar</span>
  <span class="l-Scalar-Plain">password_confirmation</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">dude</span>
  <span class="l-Scalar-Plain">password</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">dude</span>
  <span class="l-Scalar-Plain">email</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">foo@invalid</span>
</pre></div>
</div>


<p>Nous avons vu en abordant la <a class="ref" href="modeling-and-viewing-users-one#sec:users_show">section&nbsp;6.3.2</a> que la table <code>params</code> contenanit des informations sur chaque requête&nbsp;; dans le cas d'une URL comme <tt>/users/1</tt>, la valeur de <code>params[:id]</code> est l'<code>id</code> de l'utilisateur correspondant (<code>1</code>&nbsp;dans ce exemple). Dans le cas d'un <em>POST</em>ing du formulaire d'inscription, <code>params</code> contiennent plutôt une table de tableaux, une construction que nous avons vue pour la première fois à la <a class="ref" href="rails-flavored-ruby#sec:hashes_and_symbols">section&nbsp;4.3.3</a>, qui introduisait la variable stratégiquement appelée <code>params</code> dans la session de console. L'information de débuggage ci-dessus montre que la soumissions du formulaire résulte en une table <code>user</code> avec des attributs correspondants aux valeurs soumises, où les clés viennent des attributs <code>name</code> des balises <code>input</code> vues dans l'<a class="ref" href="sign-up#code:new_user_form">extrait&nbsp;8.2</a>&nbsp;; par exemple, la valeur de&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;user_email&quot;</span> <span class="na">name=</span><span class="s">&quot;user[email]&quot;</span> <span class="na">size=</span><span class="s">&quot;30&quot;</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>


<p>… avec name <code>"user[email]"</code> est précisément l'attribut <code>email</code> de la table <code>user</code>.</p>

<p>Bien que les clés de la table apparaissent comme des chaines de caractère dans le message de débuggage, Rails utilise en interne des symboles, de telle sorte que <code>params[:user]</code> est la table des attributs de l'utilisateur &mdash;&nbsp;en fait, exactement, les attributs nécessaires comme argument pour <code>User.new</code>, comme nous l'avons initialement vu à la <a class="ref" href="rails-flavored-ruby#sec:a_user_class">section&nbsp;4.4.5</a> et revu dans l'<a class="ref" href="sign-up#code:first_create_action">extrait&nbsp;8.7</a>. Cela signifie que la ligne&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">)</span>
</pre></div>
</div>


<p>… est équivalente à&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:nom</span> <span class="o">=&gt;</span> <span class="s2">&quot;Foo Bar&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;foo@invalid&quot;</span><span class="p">,</span>
                 <span class="ss">:password</span> <span class="o">=&gt;</span> <span class="s2">&quot;dude&quot;</span><span class="p">,</span> <span class="ss">:password_confirmation</span> <span class="o">=&gt;</span> <span class="s2">&quot;dude&quot;</span><span class="p">)</span>
</pre></div>
</div>


<p>C'est exactement le format nécessaire pour initialiser le modèle objet User avec les attributs donnés.</p>

<p>Bien entendu, instancier une telle variable a des implications dans le succès de l'inscription &mdash;&nbsp;comme nous le verrons à la <a class="ref" href="sign-up#sec:signup_success">section&nbsp;8.3</a>, une fois que <code>@user</code> est défini proprement, appeler <code>@user.save</code> est tout ce qu'il y a à faire pour achever l'enregistrement&nbsp;&mdash; mais cela a des conséquences même dans l'échec d'inscription considéré ici. Notez dans l'<a class="ref" href="sign-up#fig:signup_failure_rails_3">illustration&nbsp;8.6</a> que les champs sont <em>pré-remplis</em> avec les données de la soumission défectueuse. C'est parce que <code>form_for</code> remplit automatiquement dans les champs avec les attributs de l'objet <code>@user</code>, donc, par exemple, si <code>@user.nom</code> vaut <code>"Foo"</code> alors&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;field&quot;</span><span class="nt">&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:nom</span> <span class="cp">%&gt;</span><span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">text_field</span> <span class="ss">:nom</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  .
  .
  .
</pre></div>
</div>


<p>… produira le code HTML&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">&quot;/users&quot;</span> <span class="na">class=</span><span class="s">&quot;new_user&quot;</span> <span class="na">id=</span><span class="s">&quot;new_user&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>

  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;field&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;user_nom&quot;</span><span class="nt">&gt;</span>Nom<span class="nt">&lt;/label&gt;&lt;br</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;user_nom&quot;</span> <span class="na">name=</span><span class="s">&quot;user[nom]&quot;</span> <span class="na">size=</span><span class="s">&quot;30&quot;</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">value=</span><span class="s">&quot;Foo&quot;</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
  .
  .
  .
</pre></div>
</div>


<p>Ici le <code>value</code> de la balise <code>input</code> vaut <code>"Foo"</code>, donc c'est ce qui apparait dans le champ de texte.</p>

<div class="label" id="sec:signup_error_messages"></div>


<h3><a id="sec:8.2.3" href="sign-up#sec:signup_error_messages" class="heading"><span class="number">8.2.3</span> Message d'erreur à l'inscription</a></h3>


<p>Bien que ce ne soit pas strictement nécessaire, il est utile de retourner à l'utilisateur des messages d'erreur en cas d'échec de l'inscription pour indiquer les problèmes qui lui permettront de réussir son enregistrement. Rails fournit de tel messsages basé sur des validations du modèle User. Par exemple, essayons de sauver un utilisateur avec une adresse mail invalide et un mot de passe trop court&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:nom</span> <span class="o">=&gt;</span> <span class="s2">&quot;Foo Bar&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;foo@invalid&quot;</span><span class="p">,</span>
<span class="gp">?&gt; </span>                <span class="ss">:password</span> <span class="o">=&gt;</span> <span class="s2">&quot;dude&quot;</span><span class="p">,</span> <span class="ss">:password_confirmation</span> <span class="o">=&gt;</span> <span class="s2">&quot;dude&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">save</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">full_messages</span>
<span class="go">=&gt; [&quot;Email is invalid&quot;, &quot;Password is too short (minimum is 6 characters)&quot;]</span>
</pre></div>
</div>

<p>Ici, l'objet <code>errors.full_messages</code> (que nous avons vu brièvement à la <a class="ref" href="modeling-and-viewing-users-one#sec:presence_validation">section&nbsp;6.2.1</a>) contient un tableau de messages d'erreurs.</p>

<p>Comme dans la console ci-dessus, l'échec de l'enregistrement de l'<a class="ref" href="sign-up#code:first_create_action">extrait&nbsp;8.7</a> génère une liste de messages d'erreurs associée à l'objet <code>@user</code>. Pour afficher les messages dans le navigateur, nous allons rendre un <em>partiel</em> de messages d'erreur sur la page <code>new</code> (<a class="ref" href="sign-up#code:f_error_messages">extrait&nbsp;8.8</a>).<sup class="footnote" id="fnref:8.3"><a href="#fn:8.3">3</a></sup></p>

<div class="label" id="code:f_error_messages"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 8.8.</span> <span class="description">Code pour afficher les messages d'erreur sur le formulaire d'inscription. <br /> <code>app/views/users/new.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span>Inscription<span class="nt">&lt;/h1&gt;</span>

<span class="cp">&lt;%=</span> <span class="n">form_for</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/error_messages&#39;</span> <span class="cp">%&gt;</span>
  .
  .
  .
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p>Notez ici que nous <em>rendons</em> (<code>render</code>) un partiel appelé <code>&rsquo;shared/error_messages&rsquo;</code>&nbsp;; cela reflète une convention Rails courante qui définit que les partiels à utiliser par de multiples contrôleurs se trouvent dans le dossier dédié <code>shared/</code> (<em>partagé</em>) (nous verrons cette convention pleinement remplie à la <a class="ref" href="updating-showing-and-deleting-users#sec:edit_form">section&nbsp;10.1.1</a>). Cela signifie que nous devons créer ce nouveau dossier en même temps que le fichier du partiel <code>_error_messages.html.erb</code>. Le partiel lui-même est présenté dans l'<a class="ref" href="sign-up#code:errors_partial">extrait&nbsp;8.9</a>.</p>

<div class="label" id="code:errors_partial"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 8.9.</span> <span class="description">Un partiel pour afficher les messages d'erreur à la soumissions du formulaire. <br /> <code>app/views/shared/_error_messages.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">any?</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;error_explanation&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;h2&gt;</span><span class="cp">&lt;%=</span> <span class="n">pluralize</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">count</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span> <span class="cp">%&gt;</span> 
        prohibited this user from being saved:<span class="nt">&lt;/h2&gt;</span>
    <span class="nt">&lt;p&gt;</span>Problème avec ces champs&nbsp;:<span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;ul&gt;</span>
    <span class="cp">&lt;%</span> <span class="vi">@user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">full_messages</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">msg</span><span class="o">|</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;li&gt;</span><span class="cp">&lt;%=</span> <span class="n">msg</span> <span class="cp">%&gt;</span><span class="nt">&lt;/li&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/ul&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p>Ce partiel introduit plusieurs nouvelles construction Rails et Ruby, incluant deux méthodes pour les objets de classe <code>Array</code> (<em>Tableau</em>). Ouvrons une session de conols pour voir comment ils fonctionnent. La première méthode est <code>count</code> (<em>compter</em>), qui retourne simplement le nombre d'éléments dans l'objet&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="o">]</span>
<span class="go">=&gt; [1, 2, 3]</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">count</span>
<span class="go">=&gt; 3</span>
</pre></div>
</div>


<p>L'autre nouvelle méthode est <code>any?</code>, l'une des deux méthodes complémentaires&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="o">[].</span><span class="n">empty?</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="o">[].</span><span class="n">any?</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">empty?</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="n">a</span><span class="o">.</span><span class="n">any?</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p>Nous voyons ici que la méthode <code>empty?</code>, que nous avons vue initialement à la <a class="ref" href="rails-flavored-ruby#sec:objects_and_message_passing">section&nbsp;4.2.3</a> dans le contexte des chaines de caractères, qui fonctionne aussi sur les tableaux, retourne <code>true</code> (<em>vrai</em>) sur un tableau vide et <code>false</code> (<em>faux</em>) dans le cas contraire. La méthode <code>any?</code> est simplement l'opposée de la méthode <code>empty?</code>, retournant <code>true</code> s'il y a au moins un élément et <code>false</code> dans le cas contraire..</p>

<p>L'autre nouvelle idée est l'<em>helper</em> de texte <code>pluralize</code> (<em>mettre_au_pluriel</em>). Elle n'est pas accessible par la console, mais nous pouvons l'inclure explicitement par la module <code>ActionView::Helpers::TextHelper</code>&nbsp;:<sup class="footnote" id="fnref:8.4"><a href="#fn:8.4">4</a></sup></p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="kp">include</span> <span class="no">ActionView</span><span class="o">::</span><span class="no">Helpers</span><span class="o">::</span><span class="no">TextHelper</span>
<span class="go">=&gt; Object </span>
<span class="gp">&gt;&gt; </span><span class="n">pluralize</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span>
<span class="go">=&gt; &quot;1 error&quot; </span>
<span class="gp">&gt;&gt; </span><span class="n">pluralize</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span>
<span class="go">=&gt; &quot;5 errors&quot;</span>
</pre></div>
</div>


<p>Nous voyons ici que <code>pluralize</code> prend un entier comme argument et retourne alors le nombre avec une version plurielle adéquate de son second argument. Sous cette méthode se trouve un puissant <em>inflecteur</em> qui sait comment pluraliser un grand nombre de mots (qui incluent de nombreux pluriels irrégulers)&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">pluralize</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;woman&quot;</span><span class="p">)</span>
<span class="go">=&gt; &quot;2 women&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">pluralize</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;erratum&quot;</span><span class="p">)</span>
<span class="go">=&gt; &quot;3 errata&quot;</span>
</pre></div>
</div>


<p>Comme résultat, le code&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">pluralize</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">count</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">)</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>… retourne <code>"1 error"</code> ou <code>"2 errors"</code> (etc.) en fonction du nombre d'erreurs.</p>

<p>Notez que l''<a class="ref" href="sign-up#code:errors_partial">extrait&nbsp;8.9</a> inclue l'id CSS <code>error_explanation</code> pour styliser les messages d'erreur (souvenez-vous que nous avons vu à la <a class="ref" href="filling-in-the-layout#sec:custom_css">section&nbsp;5.1.2</a> que CSS utilise le signe dièse&nbsp;<code>#</code> pour styliser les ids). De plus, sur les pages d'erreur, Rails encadre automatiquement les champs d'un <code>div</code> de classe CSS <code>field_with_errors</code>. Ces labels nous permettent alors de styliser les messages d'erreur avec le code CSS montré dans l'<a class="ref" href="sign-up#code:error_messages_css">extrait&nbsp;8.10</a>. Comme résultat, en cas d'échec de la soumission les messages d'erreur apparaissent comme dans l'<a class="ref" href="sign-up#fig:signup_error_messages">illustration&nbsp;8.7</a>. Comme les messages sont générés par les validations du modèle, ils changeront automatiquement si vous changez d'avis, disons, sur le format des adresses mail ou la longueur minimum pour les mots de passe.</p>

<div class="label" id="code:error_messages_css"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 8.10.</span> <span class="description">CSS pour styliser les messages d'erreur. <br /> <code>public/stylesheets/custom.css</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="nc">.field_with_errors</span> <span class="p">{</span>
  <span class="k">margin-top</span><span class="o">:</span> <span class="m">10px</span><span class="p">;</span>
  <span class="k">padding</span><span class="o">:</span> <span class="m">2px</span><span class="p">;</span>
  <span class="k">background-color</span><span class="o">:</span> <span class="nb">red</span><span class="p">;</span>
  <span class="k">display</span><span class="o">:</span> <span class="n">table</span><span class="p">;</span>
<span class="p">}</span>

<span class="nc">.field_with_errors</span> <span class="nt">label</span> <span class="p">{</span>
  <span class="k">color</span><span class="o">:</span> <span class="m">#fff</span><span class="p">;</span>
<span class="p">}</span>

<span class="nf">#error_explanation</span> <span class="p">{</span>
  <span class="k">width</span><span class="o">:</span> <span class="m">400px</span><span class="p">;</span>
  <span class="k">border</span><span class="o">:</span> <span class="m">2px</span> <span class="k">solid</span> <span class="nb">red</span><span class="p">;</span>
  <span class="k">padding</span><span class="o">:</span> <span class="m">7px</span><span class="p">;</span>
  <span class="k">padding-bottom</span><span class="o">:</span> <span class="m">12px</span><span class="p">;</span>
  <span class="k">margin-bottom</span><span class="o">:</span> <span class="m">20px</span><span class="p">;</span>
  <span class="k">background-color</span><span class="o">:</span> <span class="m">#f0f0f0</span><span class="p">;</span>
<span class="p">}</span>

<span class="nf">#error_explanation</span> <span class="nt">h2</span> <span class="p">{</span>
  <span class="k">text-align</span><span class="o">:</span> <span class="k">left</span><span class="p">;</span>
  <span class="k">font-weight</span><span class="o">:</span> <span class="k">bold</span><span class="p">;</span>
  <span class="k">padding</span><span class="o">:</span> <span class="m">5px</span> <span class="m">5px</span> <span class="m">5px</span> <span class="m">15px</span><span class="p">;</span>
  <span class="k">font-size</span><span class="o">:</span> <span class="m">12px</span><span class="p">;</span>
  <span class="k">margin</span><span class="o">:</span> <span class="m">-7px</span><span class="p">;</span>
  <span class="k">background-color</span><span class="o">:</span> <span class="m">#c00</span><span class="p">;</span>
  <span class="k">color</span><span class="o">:</span> <span class="m">#fff</span><span class="p">;</span>
<span class="p">}</span>

<span class="nf">#error_explanation</span> <span class="nt">p</span> <span class="p">{</span>
  <span class="k">color</span><span class="o">:</span> <span class="m">#333</span><span class="p">;</span>
  <span class="k">margin-bottom</span><span class="o">:</span> <span class="m">0</span><span class="p">;</span>
  <span class="k">padding</span><span class="o">:</span> <span class="m">5px</span><span class="p">;</span>
<span class="p">}</span>

<span class="nf">#error_explanation</span> <span class="nt">ul</span> <span class="nt">li</span> <span class="p">{</span>
  <span class="k">font-size</span><span class="o">:</span> <span class="m">12px</span><span class="p">;</span>
  <span class="k">list-style</span><span class="o">:</span> <span class="k">square</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div></div>




<div class="label" id="fig:signup_error_messages"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/signup_error_messages.png" alt="signup_error_messages" /></span></div><div class="caption"><span class="header">Illustration 8.7: </span><span class="description">Échec d'inscription avec les messages d'erreur.&nbsp;<a href="http://railstutorial.org/images/figures/signup_error_messages-full.png">(taille normale)</a></span></div></div>




<div class="label" id="sec:filtering_parameter_logging"></div>


<h3><a id="sec:8.2.4" href="sign-up#sec:filtering_parameter_logging" class="heading"><span class="number">8.2.4</span> Filtrer les paramètres d'identification</a></h3>


<p>Avant de pousuivre vers la réussite des l'inscription, il reste une chose à considérer. Vous avez peut-être noté que, même si nous nous sommes évertués à crypter le mot de passe au <a class="ref" href="modeling-and-viewing-users-two#top">chapitre&nbsp;7</a>, le mot de passe et sa confirmation apparaissent tous deux en «&nbsp;texte clair&nbsp;» (<a href="http://www.computerhope.com/jargon/c/cleartex.htm">cleartext</a>) dans l'information de débuggage. Ce n'est pas un problème en soi &mdash;&nbsp;dans l'<a class="ref" href="modeling-and-viewing-users-one#code:rails_debug">extrait&nbsp;6.23</a> nous avons vu que ces informations n'apparaissaient que pour les application en mode <code>development</code> (<em>développement</em>), donc les utilisateurs ne devraient pas les voir&nbsp;&mdash; mais ça peut conduire à un problème éventuel&nbsp;: les mots de passe peuvent aussi apparaitre de façon non cryptés dans le <em>log file</em> (le <em>fichier journal</em>) que Rails utilise pour enregistrer des informations sur l'activité de l'application. En effet, dans les versions précédente de Rails, le fichier journal de développement, dans ce cas, contiendrait des lignes comme celles montrées dans l'<a class="ref" href="sign-up#code:development_log_file_with_passwords">extrait&nbsp;8.11</a>.</p>

<div class="label" id="code:development_log_file_with_passwords"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 8.11.</span> <span class="description">Le fichier journal de développement, avant Rails&nbsp;3, avec des mots de passe <em>en clair</em>. <br /> <code>log/development.log</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="no">Parameters</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;commit&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;Inscription&quot;</span><span class="p">,</span> <span class="s2">&quot;action&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;create&quot;</span><span class="p">,</span>
<span class="s2">&quot;authenticity_token&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;K1HchFF8uYE8ZaQKz5DVG9vF2KGoXJu4JGp/VE3NMjA=&quot;</span><span class="p">,</span>
<span class="s2">&quot;controller&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;users&quot;</span><span class="p">,</span> 
  <span class="s2">&quot;user&quot;</span><span class="o">=&gt;</span><span class="p">{</span><span class="s2">&quot;nom&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;Foo Bar&quot;</span><span class="p">,</span> <span class="s2">&quot;password_confirmation&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;dude&quot;</span><span class="p">,</span>
           <span class="s2">&quot;password&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;dude&quot;</span><span class="p">,</span> <span class="s2">&quot;email&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;foo@invalid&quot;</span><span class="p">}}</span>
</pre></div>
</div></div>


<p>Ce serait un trou de sécurité dramatique d'enregistrer les mots de passe non cryptés dans les fichiers journaux &mdash;&nbsp;si quiconque avait accès à ces fichiers, il pourrait obtenir les mots de passe de tous les utilisateurs du système. (Bien entendu, ici l'inscription échoue, mais le problème est exactement le même pour une soumission réussie.) Puis ce problème était tellement courant dans les application Rails, Rails&nbsp;3 implémente un nouveau comportement par défaut&nbsp;: tous les attributs <code>password</code> (<em>mot de passe</em>) sont filtrés automatiquement, comme le montre l'<a class="ref" href="sign-up#code:development_log_file_with_filtered_passwords">extrait&nbsp;8.12</a>. Nous voyons que la chaine <code>"[FILTERED]"</code> prend la place du mot de passe et de sa confirmation (en mode production, le fichier journal sera <code>log/production.log</code>, et le filtrage fonctionne de la même manière).</p>

<div class="label" id="code:development_log_file_with_filtered_passwords"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 8.12.</span> <span class="description">Le journal de développement avec les mots de passe filtrés. <br /> <code>log/development.log</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="no">Parameters</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;commit&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;Inscription&quot;</span><span class="p">,</span> <span class="s2">&quot;action&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;create&quot;</span><span class="p">,</span>
<span class="s2">&quot;authenticity_token&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;K1HchFF8uYE8ZaQKz5DVG9vF2KGoXJu4JGp/VE3NMjA=&quot;</span><span class="p">,</span>
<span class="s2">&quot;controller&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;users&quot;</span><span class="p">,</span>
  <span class="s2">&quot;user&quot;</span><span class="o">=&gt;</span><span class="p">{</span><span class="s2">&quot;nom&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;Foo Bar&quot;</span><span class="p">,</span> <span class="s2">&quot;password_confirmation&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;[FILTERED]&quot;</span><span class="p">,</span>
           <span class="s2">&quot;password&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;[FILTERED]&quot;</span><span class="p">,</span> <span class="s2">&quot;email&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;foo@invalid&quot;</span><span class="p">}}</span>
</pre></div>
</div></div>


<p>Le filtrage du mot de passe lui-même est accompli via un réglage dans le fichier de configuration <code>application.rb</code> (<a class="ref" href="sign-up#code:password_filtering">extrait&nbsp;8.13</a>).</p>

<div class="label" id="code:password_filtering"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 8.13.</span> <span class="description">Filtrage des mots de passe par défaut. <br /> <code>config/application.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="s1">&#39;../boot&#39;</span><span class="p">,</span> <span class="bp">__FILE__</span><span class="p">)</span>

<span class="nb">require</span> <span class="s1">&#39;rails/all&#39;</span>

<span class="c1"># If you have a Gemfile, require the gems listed there, including any gems</span>
<span class="c1"># you&#39;ve limited to :test, :development, or :production.</span>
<span class="no">Bundler</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:default</span><span class="p">,</span> <span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="p">)</span> <span class="k">if</span> <span class="n">defined?</span><span class="p">(</span><span class="no">Bundler</span><span class="p">)</span>

<span class="k">module</span> <span class="nn">SampleApp</span>
  <span class="k">class</span> <span class="nc">Application</span> <span class="o">&lt;</span> <span class="no">Rails</span><span class="o">::</span><span class="no">Application</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="c1"># Configure sensitive parameters which will be filtered from the log file.</span>
    <span class="n">config</span><span class="o">.</span><span class="n">filter_parameters</span> <span class="o">+=</span> <span class="o">[</span><span class="ss">:password</span><span class="o">]</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Si vous écrivez jamais une application Rails avec un paramètre à sécuriser qui porte une <em>autre</em> nom que <code>password</code>, vous aurez besoin de l'ajouter à la liste des paramètres filtrés. Par exemple, si vous incluez un code secret comme partie du processus d'inscription, vous devez inclure une ligne comme&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;field&quot;</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">label</span> <span class="ss">:secret_code</span> <span class="cp">%&gt;</span><span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">password_field</span> <span class="ss">:secret_code</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div>


<p>… dans le formulaire d'inscription. Vous aurez aussi alors besoin d'ajouter <code>:secret_code</code> à <code>application.rb</code> comme suit&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="n">config</span><span class="o">.</span><span class="n">filter_parameters</span> <span class="o">+=</span> <span class="o">[</span><span class="ss">:password</span><span class="p">,</span> <span class="ss">:secret_code</span><span class="o">]</span>
</pre></div>
</div>




<div class="label" id="sec:signup_success"></div>


<h2><a id="sec:8.3" href="sign-up#sec:signup_success" class="heading"><span class="number">8.3</span> Réussite de l'inscription</a></h2>


<p>Ayant traité les soumission de formulaire invalide, il est temps maintenant d'achever le formulaire d'inscription en enregistrant réellement un nouvel utilisateur (valide) dans la base de données. D'abord, nous essayons de sauver un utilisateur&nbsp;; si l'enregistrement fonctionne, les informations de l'utilisateur sont écrites dans la base de données automatiquement, et nous pouvons alors <em>rediriger</em> (<code>redirect</code>) le navigateur pour afficher le profil de l'utilisateur (avec un sympathique message de bienvenue), comme le montre la maquette dans l'<a class="ref" href="sign-up#fig:signup_success_mockup">illustration&nbsp;8.8</a>. Si ça rate, nous retournons simplement au comportement développé à la <a class="ref" href="sign-up#sec:signup_failure">section&nbsp;8.2</a>.</p>

<div class="label" id="fig:signup_success_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/signup_success_mockup.png" alt="signup_success_mockup" /></span></div><div class="caption"><span class="header">Illustration 8.8: </span><span class="description">Une maquette d'une inscription réussie.&nbsp;<a href="http://railstutorial.org/images/figures/signup_success_mockup-full.png">(taille normale)</a></span></div></div>




<div class="label" id="sec:testing_success"></div>


<h3><a id="sec:8.3.1" href="sign-up#sec:testing_success" class="heading"><span class="number">8.3.1</span> Tester la réussite</a></h3>


<p>Les tests pour une inscription réussie suivent le même chemin que les tests de l'échec de l'inscription de l'<a class="ref" href="sign-up#code:failing_create_specs">extrait&nbsp;8.6</a>. Jetons un coup d'œil au résultat présenté dans l'<a class="ref" href="sign-up#code:signup_success_tests">extrait&nbsp;8.14</a>.</p>

<div class="label" id="code:signup_success_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 8.14.</span> <span class="description">Tests pour une inscription réussie. <br /> <code>spec/controllers/users_controller_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">UsersController</span> <span class="k">do</span>
  <span class="n">render_views</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;POST &#39;create&#39;&quot;</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;success&quot;</span> <span class="k">do</span>

      <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
        <span class="vi">@attr</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:nom</span> <span class="o">=&gt;</span> <span class="s2">&quot;New User&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;user@example.com&quot;</span><span class="p">,</span>
                  <span class="ss">:password</span> <span class="o">=&gt;</span> <span class="s2">&quot;foobar&quot;</span><span class="p">,</span> <span class="ss">:password_confirmation</span> <span class="o">=&gt;</span> <span class="s2">&quot;foobar&quot;</span> <span class="p">}</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;devrait créer un utilisateur&quot;</span> <span class="k">do</span>
        <span class="nb">lambda</span> <span class="k">do</span>
          <span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="vi">@attr</span>
        <span class="k">end</span><span class="o">.</span><span class="n">should</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;devrait rediriger vers la page d'affichage de l'utilisateur&quot;</span> <span class="k">do</span>
        <span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="vi">@attr</span>
        <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">user_path</span><span class="p">(</span><span class="n">assigns</span><span class="p">(</span><span class="ss">:user</span><span class="p">)))</span>
      <span class="k">end</span>    
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Comme avec les tests de l'échec de l'inscription (<a class="ref" href="sign-up#code:failing_create_specs">extrait&nbsp;8.6</a>), nous utilisons ici <code>post :create</code> pour atteindre l'action <code>create</code> avec la requête HTML <tt>POST</tt>. Comme dans les tests d'un échec de création de l'<a class="ref" href="sign-up#code:failing_create_specs">extrait&nbsp;8.6</a>, le premier test «&nbsp;enroule&nbsp;» la création de l'utilisateur dans un bloc <code>lambda</code> et utilise la méthode <code>count</code> pour vérifier que la base de données a changé de façon adéquate&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="s2">&quot;devrait créer un utilisateur&quot;</span> <span class="k">do</span>
  <span class="nb">lambda</span> <span class="k">do</span>
    <span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="vi">@attr</span>
  <span class="k">end</span><span class="o">.</span><span class="n">should</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>


<p>Ici, au lieu du <code>should_not change(User, :count)</code> utilisé dans le cas d'une création d'utilisateur défectueuse, nous avons <code>should change(User, :count).by(1)</code>, qui attend du bloc <code>lambda</code> qu'il change le compte <code>User</code> de&nbsp;1.</p>

<p>Le second test utilise la méthode <code>assigns</code> vue initialement dans l'<a class="ref" href="modeling-and-viewing-users-two#code:get_show_test">extrait&nbsp;7.17</a> pour vérifier que l'action <code>create</code> redirige le tout nouvel utilisateur vers sa page <code>show</code>&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="s2">&quot;devrait rediriger vers la page d'affichage de l'utilisateur&quot;</span> <span class="k">do</span>
  <span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="vi">@attr</span>
  <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">user_path</span><span class="p">(</span><span class="n">assigns</span><span class="p">(</span><span class="ss">:user</span><span class="p">)))</span>
<span class="k">end</span>   
</pre></div>
</div>


<p>C'est le genre de redirection qui se produit dans presque toutes réussites de soumissions de formulaires sur le web, et avec la syntaxe assistée de RSpec vous n'avez rien besoin de savoir sur le code de réponse HTML sous-jacent.<sup class="footnote" id="fnref:8.5"><a href="#fn:8.5">5</a></sup> L'URL elle-même est générée en utilisant la route nommée  <code>user_path</code> présentée dans la <a class="ref" href="modeling-and-viewing-users-two#table:named_routes">Table&nbsp;7.1</a>.</p>

<div class="label" id="sec:the_finished_signup_form"></div>


<h3><a id="sec:8.3.2" href="sign-up#sec:the_finished_signup_form" class="heading"><span class="number">8.3.2</span> Le formulaire d'inscription final</a></h3>


<p>Pour obtenir la réussite de ces tests et ainsi achever un formulaire d'inscription fonctionnel, remplissez la section décommentée de l'<a class="ref" href="sign-up#code:first_create_action">extrait&nbsp;8.7</a> avec une redirection, comme montré dans l'<a class="ref" href="sign-up#code:user_create_action">extrait&nbsp;8.15</a>.</p>

<div class="label" id="code:user_create_action"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 8.15.</span> <span class="description">L'action utilisateur <code>create</code> avec une sauvegarde et une redirection. <br /> <code>app/controllers/users_controller.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
      <span class="n">redirect_to</span> <span class="vi">@user</span>
    <span class="k">else</span>
      <span class="vi">@titre</span> <span class="o">=</span> <span class="s2">&quot;Inscription&quot;</span>
      <span class="n">render</span> <span class="s1">&#39;new&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Notez que nous pouvons omettre le <code>user_path</code> dans la redirection, en écrivant simplement <code>redirect_to @user</code> pour rediriger l'utilisateur vers sa page d'affichage (<code>show</code> ), une convention que nous avons vu précédemment avec <code>link_to</code> dans l'<a class="ref" href="modeling-and-viewing-users-two#code:user_show_with_sidebar">extrait&nbsp;7.25</a>. Cette syntaxe est joliment succincte, mais malheureusement RSpec ne la comprend pas, donc nous devons utiliser l'expression plus bavarde <code>user_path(@user)</code> dans ce cas.</p>

<div class="label" id="sec:the_flash"></div>


<h3><a id="sec:8.3.3" href="sign-up#sec:the_flash" class="heading"><span class="number">8.3.3</span> Le message «&nbsp;flash&nbsp;»</a></h3>


<p>Avant de soumettre une registration valide dans le navigateur, nous allons ajouter quelque chose de très courant dans les applications web&nbsp;: un message qui apparait temporairement et disparait au rechargement de la page (si ce n'est pas clair, soyez patient&nbsp;: un exemple concret va être présenté rapidement). La manière de Rails d'accomplir cela consiste à utiliser une variable spéciale appelée le <em>flash</em>, qui opère comme <a href="http://fr.wikipedia.org/wiki/M%C3%A9moire_flash">mémoire flash</a> dans laquelle il consigne temporairement ses données. La variable <code>flash</code> est en fait une table de hachage&nbsp;; vous pouvez même vous souvenir de l'exemple console de la <a class="ref" href="rails-flavored-ruby#sec:hashes_and_symbols">section&nbsp;4.3.3</a>, où nous avions vu comment boucler sur une table en utilisant une table stratégiquement appelée <code>flash</code>. Pour résumer, essayez cette session de console&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="n">flash</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:success</span> <span class="o">=&gt;</span> <span class="s2">&quot;It worked!&quot;</span><span class="p">,</span> <span class="ss">:error</span> <span class="o">=&gt;</span> <span class="s2">&quot;It failed. :-(&quot;</span> <span class="p">}</span>
<span class="go">=&gt; {:success=&gt;&quot;It worked!&quot;, :error =&gt; &quot;It failed. :-(&quot;}</span>
<span class="gp">&gt;&gt; </span><span class="n">flash</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span>
<span class="gp">?&gt; </span>  <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="gp">?&gt; </span>  <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">success</span>
<span class="go">It worked!</span>
<span class="go">error</span>
<span class="go">It failed. :-(</span>
</pre></div>
</div>


<p>Nous pouvons nous arranger pour afficher le contenu du flash sur le site en l'incluant au <em>layout</em> de notre application, comme dans l'<a class="ref" href="sign-up#code:layout_flash">extrait&nbsp;8.16</a>.</p>

<div class="label" id="code:layout_flash"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 8.16.</span> <span class="description">Ajout du contenu de la variable <code>flash</code> au layout du site. <br /> <code>app/views/layouts/application.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
      .
      .
      .
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;layouts/header&#39;</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;section</span> <span class="na">class=</span><span class="s">&quot;round&quot;</span><span class="nt">&gt;</span>
        <span class="cp">&lt;%</span> <span class="n">flash</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span> <span class="cp">%&gt;</span>
          <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;flash </span><span class="cp">&lt;%=</span> <span class="n">key</span> <span class="cp">%&gt;</span><span class="s">&quot;</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">value</span> <span class="cp">%&gt;</span><span class="nt">&lt;/div&gt;</span>
        <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
        <span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/section&gt;</span>
      .
      .
      .
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div></div>


<p>Ce code s'arrange pour insérer une balise <code>div</code> pour chaque élément du flahs, avec une classe CSS indiquant le type du message. Par exemple, si <code>flash[:success] = "Bienvenue dans l'Application Exemple&nbsp;!"</code>, alors le code&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="n">flash</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;flash </span><span class="cp">&lt;%=</span> <span class="n">key</span> <span class="cp">%&gt;</span><span class="s">&quot;</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">value</span> <span class="cp">%&gt;</span><span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span> 
</pre></div>
</div>


<p>… produira le code HTML&nbsp;:<sup class="footnote" id="fnref:8.6"><a href="#fn:8.6">6</a></sup></p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;flash success&quot;</span><span class="nt">&gt;</span>Bienvenue dans l'Application Exemple&nbsp;!<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div>


<p>La raison pour laquelle nous bouclons sur toutes les paires clé/valeur possible permet d'inclure les autres types de messages flash&nbsp;; par exemple, dans l'<a class="ref" href="sign-in-sign-out#code:signin_failure">extrait&nbsp;9.8</a> nous verrons <code>flash[:error]</code> utilisé pour indiquer un échec d'identification.<sup class="footnote" id="fnref:8.7"><a href="#fn:8.7">7</a></sup></p>

<p>Testons le bon message flash en nous assurant que le message adéquat apparait sous la clé <code>:success</code> (<a class="ref" href="sign-up#code:signup_flash_test">extrait&nbsp;8.17</a>).</p>

<div class="label" id="code:signup_flash_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 8.17.</span> <span class="description">A test du message flash en cas de succès de l'inscription de l'utilisateur. <br /> <code>spec/controllers/users_controller_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">UsersController</span> <span class="k">do</span>
  <span class="n">render_views</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;POST &#39;create&#39;&quot;</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>

    <span class="n">describe</span> <span class="s2">&quot;success&quot;</span> <span class="k">do</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="o">.</span>
      <span class="n">it</span> <span class="s2">&quot;devrait avoir un message de bienvenue&quot;</span> <span class="k">do</span>
        <span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="vi">@attr</span>
        <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">].</span><span class="n">should</span> <span class="o">=~</span> <span class="sr">/Bienvenue dans l'Application Exemple/i</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Cela introduit l'opération «&nbsp;égale-tilde&nbsp;» <tt class="verb">=~</tt> pour comparer les chaines de caractère par expression régulière (vous avons parlé des expressions régulières avec le <code>email_regex</code> de l'<a class="ref" href="modeling-and-viewing-users-one#code:validates_format_of_email">extrait&nbsp;6.17</a>). Plutôt que de tester tout le message flash, nous testons simplement que le «&nbsp;Bienvenue dans l'Application Exemple&nbsp;» soit présent (notez que nous ne testons pas encore l'apparence du code HTML du message flash&nbsp;; nous réglerons cela en testant la balise <code>div</code> à la <a class="ref" href="sign-up#sec:successful_signup">section&nbsp;8.4.3</a>.)</p>

<p>Si vous avez déjà beaucoup programmé, vous devez être familier des expressions régulières, mais voilà une rapide session de console dans le cas où vous auriez besoin d'une introduction&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s2">&quot;foo bar&quot;</span> <span class="o">=~</span> <span class="sr">/Foo/</span>     <span class="c1"># Les comparaisons Regex sont sensibles à la casse, par défaut</span>
<span class="go">=&gt; nil</span>
<span class="gp">&gt;&gt; </span><span class="s2">&quot;foo bar&quot;</span> <span class="o">=~</span> <span class="sr">/foo/</span>
<span class="go">=&gt; 0</span>
</pre></div>
</div>


<p>Ici les valeurs de retour de la console peuvent sembler étranges&nbsp;: pour aucune correspondance, la comparaison régulière retourne <code>nil</code>&nbsp;; pour une correspondance, elle retourne l'<em>index</em> (la position) dans la chaine où la correspondance commence.<sup class="footnote" id="fnref:8.8"><a href="#fn:8.8">8</a></sup> Habituellement, cependant, l'index exact n'est pas très important, puisque la comparaison est le plus souvent utilisé dans un context booléen&nbsp;: en vous souvenant de la <a class="ref" href="rails-flavored-ruby#sec:objects_and_message_passing">section&nbsp;4.2.3</a>, <code>nil</code> est <code>false</code> (<em>faux</em>) dans un contexte booléen et tout autre valeur, même&nbsp;<code>0</code>, est <code>true</code> (<em>vrai</em>). Ainsi, nous pouvons écrire le code ainsi&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">success</span> <span class="o">=</span> <span class="s2">&quot;Bienvenue dans l'Application Exemple&nbsp;!&quot;</span>
<span class="go">=&gt; &quot;Bienvenue dans l'Application Exemple&nbsp;!&quot;</span>
<span class="gp">&gt;&gt; </span><span class="s2">&quot;It&#39;s a match!&quot;</span> <span class="k">if</span> <span class="n">success</span> <span class="o">=~</span> <span class="sr">/bienvenue dans l'application exemple/</span>
<span class="go">=&gt; nil</span>
</pre></div>
</div>


<p>Il n'y a aucune correspondance ici parce que les expressions régulières sont sensibles à la casse (minuscule/MAJUSCULE) par défaut, mais nous pouvons être plus permissifs dans la recherche en utilisant&nbsp;<code>/.../i</code> qui force une recherche non sensible à la casse&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="s2">&quot;It&#39;s a match!&quot;</span> <span class="k">if</span> <span class="n">success</span> <span class="o">=~</span> <span class="sr">/bienvenue dans l'application exemple/i</span>
<span class="go">=&gt; &quot;Trouvé&nbsp;!&quot;</span>
</pre></div>
</div>


<p>Maintenant que nous comprenons comment fonctionne le test du message flash, nous pouvons obtenir qu'il réussisse en assignant <code>flash[:success]</code> dans l'action <code>create</code> comme dans l'<a class="ref" href="sign-up#code:signup_flash">extrait&nbsp;8.18</a>. Le message utilise une  capitalisation différente de celle du test, mais le test réussit quand même grâce au&nbsp;<code>i</code> à la fin de l'expression régulière. De cette façon nous ne cassons pas le test si nous écrivons, par exemple, <code>application exemple</code> au lieu de <code>Application Exemple</code>.</p>

<div class="label" id="code:signup_flash"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 8.18.</span> <span class="description">Ajout d'un message flash message lors de l'inscription de l'utilisateur. <br /> <code>app/controllers/users_controller.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:user</span><span class="o">]</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
      <span class="n">flash</span><span class="o">[</span><span class="ss">:success</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;Bienvenue dans l'Application Exemple!&quot;</span>
      <span class="n">redirect_to</span> <span class="vi">@user</span>
    <span class="k">else</span>
      <span class="vi">@titre</span> <span class="o">=</span> <span class="s2">&quot;Inscription&quot;</span>
      <span class="n">render</span> <span class="s1">&#39;new&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="sec:the_first_signup"></div>


<h3><a id="sec:8.3.4" href="sign-up#sec:the_first_signup" class="heading"><span class="number">8.3.4</span> La première inscription</a></h3>


<p>Nous pouvons voir le résultat de tout ce travail en inscrivant notre premier utilisateur (sous le nom «&nbsp;Rails Tutorial&nbsp;» et l'adresse mail «&nbsp;<tt>example@railstutorial.org</tt>&nbsp;»), qui affiche un message convivial au succès de l'inscription, comme montré dans l'<a class="ref" href="sign-up#fig:signup_flash">illustration&nbsp;8.9</a> (la jolie stylisation verte pour la classe <code>success</code> vient du framework CSS Blueprint de la <a class="ref" href="rails-flavored-ruby#sec:cascading_style_sheets">section&nbsp;4.1.2</a>). Ensuite, en rechargeant la page d'affichage de l'utilisateur, le message flash disparait comme promis (<a class="ref" href="sign-up#fig:signup_flash_reloaded">illustration&nbsp;8.10</a>).</p>

<div class="label" id="fig:signup_flash"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/signup_flash.png" alt="signup_flash" /></span></div><div class="caption"><span class="header">Illustration 8.9: </span><span class="description">Le résultat d'une inscription réussie, avec le message flash.&nbsp;<a href="http://railstutorial.org/images/figures/signup_flash-full.png">(taille normale)</a></span></div></div>




<div class="label" id="fig:signup_flash_reloaded"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/signup_flash_reloaded.png" alt="signup_flash_reloaded" /></span></div><div class="caption"><span class="header">Illustration 8.10: </span><span class="description">La page de profil sans le message flash après le rechargement éventuel de la page.&nbsp;<a href="http://railstutorial.org/images/figures/signup_flash_reloaded-full.png">(taille normale)</a></span></div></div>


<p>Nous pouvons maintenant interroger notre base de données juste pour nous assurer par deux fois que le nouvel utilisateur a bien été créé&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">first</span>
<span class="go">=&gt; #&lt;User id: 1, nom: &quot;Rails Tutorial&quot;, email: &quot;example@railstutorial.org&quot;,</span>
<span class="go">created_at: &quot;2010-02-17 03:07:53&quot;, updated_at: &quot;2010-02-17 03:07:53&quot;,</span>
<span class="go">encrypted_password: &quot;48aa8f4444b71f3f713d87d051819b0d44cd89f4a963949f201...&quot;,</span>
<span class="go">salt: &quot;f52924ba502d4f92a634d4f9647622ccce26205176cceca2adc...&quot;&gt;</span>
</pre></div>
</div>


<p>C'est un triomphe&nbsp;!</p>

<div class="label" id="sec:rspec_integration_tests"></div>


<h2><a id="sec:8.4" href="sign-up#sec:rspec_integration_tests" class="heading"><span class="number">8.4</span> Les tests d'intégration RSpec</a></h2>


<p>En principe, 
<p>In principle, we are done with user signup at this point, but you may have noticed that we haven&rsquo;t tested the structure of the signup form, nor have we tested that submissions actually work. Of course, we <em>have</em> checked these things by viewing the pages in our browser, but the whole point of automated testing is to make sure that once things work they stay that way. Making such tests is the goal of this section&mdash;and the results are pretty sweet.</p>

<p>One testing method would be to check the HTML structure of the form (using <code>render_views</code> and the <code>have_selector</code> method), and indeed this is a good way to test-drive views. (<a class="ref" href="sign-up#sec:signup_exercises">section&nbsp;8.6</a> has an exercise to this effect.) But I prefer not to test the detailed HTML structure of views&mdash;I don&rsquo;t see any reason why we should have to know that Rails implements user email submission using <code>nom="user[email]"</code>, and indeed any test of that structure would break if a future Rails version changed this convention. Moreover, it would be nice to have a test for the entire signup process: visiting the signup page, filling in the form values, clicking the button, and making sure (if the submission is valid) that a new user gets created in the (test) database.</p>

<p>Though it&rsquo;s not the only way (see <a class="ref" href="sign-up#sidebar:integration_alternatives">Box&nbsp;8.1</a>), my preferred solution to this problem is to use an RSpec integration test, which we first used in <a class="ref" href="filling-in-the-layout#sec:integration_tests">section&nbsp;5.2.1</a> to test the custom routes (such as <tt>/about</tt> for the About page). In that section, we saw only a tiny fraction of the power of integration tests; starting in this section, we&rsquo;ll see just how amazing they can be.</p>

<div class="label" id="sidebar:integration_alternatives"></div>


<div class="sidebar"><span class="title"><span class="header">Box 8.1.</span><span class="description">Integration alternatives</span></span>
<p>As we&rsquo;ve seen in this and previous chapters, <em>Ruby on Rails Tutorial</em> uses RSpec for all its tests, including integration tests. In my view, there is no match for the simplicity and power of RSpec integration tests. There are a couple of viable alternatives, though. One is the Rails default, integration testing with <tt>Test::Unit</tt>. This is fine if you use <tt>Test::Unit</tt> elsewhere, but we&rsquo;re using RSpec in this tutorial, and I prefer not to mix RSpec and <tt>Test::Unit</tt> in a single project.</p>

<p>A second option is <a href="http://cukes.info">Cucumber</a>, which works nicely with RSpec and allows the definition of plain-text stories describing application behavior. Many Rails programmers find Cucumber especially convenient when doing client work; since they can be read even by non-technical users, Cucumber tests, or «&nbsp;scenarios&nbsp;», can be shared with (and can sometimes even be written by) the client. Of course, using a testing framework that isn&rsquo;t pure Ruby has a downside, and I find that the plain-text stories can be a bit verbose and (cu)cumbersome. Since we don&rsquo;t have any client requirements in <em>Rails Tutorial</em>, and since I strongly prefer a pure-Ruby testing approach in any case, we&rsquo;ll stick to RSpec integration tests in this book. Nevertheless, I suggest taking a look at some <a href="http://wiki.github.com/aslakhellesoy/cucumber/tutorials-and-related-blog-posts">Cucumber tutorials</a> to see if it suits you.</p>
</div>




<div class="label" id="sec:integration_tests_with_style"></div>


<h3><a id="sec:8.4.1" href="sign-up#sec:integration_tests_with_style" class="heading"><span class="number">8.4.1</span> Integration tests with style</a></h3>


<p>We saw in <a class="ref" href="filling-in-the-layout#code:layout_links_spec">extrait&nbsp;5.13</a> that RSpec integration tests support controller-test&ndash;style constructions such as</p>

<div class="code"><div class="highlight"><pre><span class="n">get</span> <span class="s1">&#39;/&#39;</span>
<span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s1">&#39;titre&#39;</span><span class="p">,</span> <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="s2">&quot;Home&quot;</span><span class="p">)</span>
</pre></div>
</div>


<p>This is not the only kind of syntax supported, though; RSpec integration tests also support a highly expressive web-navigation syntax.<sup class="footnote" id="fnref:8.9"><a href="#fn:8.9">9</a></sup> In this section, we&rsquo;ll see how to use this syntax to simulate filling out the signin form using code like</p>

<div class="code"><div class="highlight"><pre><span class="n">visit</span> <span class="n">signin_path</span>
<span class="n">fill_in</span> <span class="s2">&quot;Nom&quot;</span><span class="p">,</span> <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="s2">&quot;Example User&quot;</span>
<span class="n">click_button</span>
</pre></div>
</div>




<div class="label" id="sec:failed_signup"></div>


<h3><a id="sec:8.4.2" href="sign-up#sec:failed_signup" class="heading"><span class="number">8.4.2</span> Users signup failure should not make a new user</a></h3>


<p>Now we&rsquo;re ready to make an integration test for signing up users. As we saw in <a class="ref" href="filling-in-the-layout#sec:integration_tests">section&nbsp;5.2.1</a>, RSpec comes with a generator to make such integration specs; in the present case, our integration tests will contain various actions taken by users, so we&rsquo;ll name the test <code>users</code> accordingly:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate integration_test users
<span class="go">      invoke  rspec</span>
<span class="go">      create    spec/requests/users_spec.rb</span>
</pre></div>
</div>


<p>As in <a class="ref" href="filling-in-the-layout#sec:integration_tests">section&nbsp;5.2.1</a>, the generator automatically appends a spec identifier, yielding <code>users_spec.rb</code>.<sup class="footnote" id="fnref:8.10"><a href="#fn:8.10">10</a></sup></p>

<p>We start with signup failure. A simple way to arrange a failing signup is to visit the signup URL and just click the button, resulting in a page as in <a class="ref" href="sign-up#fig:blank_signup">illustration&nbsp;8.11</a>. Upon failed submission, the response should render the <code>users/new</code> template.  If you inspect the resulting HTML, you should see something like the markup in <a class="ref" href="sign-up#code:error_explanation">extrait&nbsp;8.19</a>. This means that we can test for the presence of error messages by looking for a <code>div</code> tag with the CSS id <code>"error_explanation"</code>. A test for these steps appears in <a class="ref" href="sign-up#code:signup_failure_test">extrait&nbsp;8.20</a>.</p>

<div class="label" id="fig:blank_signup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/blank_signup.png" alt="blank_signup" /></span></div><div class="caption"><span class="header">Illustration 8.11: </span><span class="description">The result of visiting  <a href="http://localhost:3000/signup"><tt>/signup</tt></a> and just clicking «&nbsp;Inscription&nbsp;».&nbsp;<a href="http://railstutorial.org/images/figures/blank_signup-full.png">(taille normale)</a></span></div></div>




<div class="label" id="code:error_explanation"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 8.19.</span> <span class="description">The error explanation <code>div</code> from the page in <a class="ref" href="sign-up#fig:blank_signup">illustration&nbsp;8.11</a>.</span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;error_explanation&quot;</span> <span class="na">id=</span><span class="s">&quot;error_explanation&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;h2&gt;</span>5 errors prohibited this user from being saved<span class="nt">&lt;/h2&gt;</span>
  <span class="nt">&lt;p&gt;</span>Problème avec ces champs&nbsp;:<span class="nt">&lt;/p&gt;</span>
  <span class="nt">&lt;ul&gt;</span>
    <span class="nt">&lt;li&gt;</span>Nom can&#39;t be blank<span class="nt">&lt;/li&gt;</span>
    <span class="nt">&lt;li&gt;</span>Email can&#39;t be blank<span class="nt">&lt;/li&gt;</span>
    <span class="nt">&lt;li&gt;</span>Email is invalid<span class="nt">&lt;/li&gt;</span>
    <span class="nt">&lt;li&gt;</span>Password can&#39;t be blank<span class="nt">&lt;/li&gt;</span>
    <span class="nt">&lt;li&gt;</span>Password is too short (minimum is 6 characters)<span class="nt">&lt;/li&gt;</span>
  <span class="nt">&lt;/ul&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div></div>




<div class="label" id="code:signup_failure_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 8.20.</span> <span class="description">Testing signup failure. <br /> <code>spec/requests/users_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Users&quot;</span> <span class="k">do</span>

  <span class="n">describe</span> <span class="s2">&quot;signup&quot;</span> <span class="k">do</span>

    <span class="n">describe</span> <span class="s2">&quot;failure&quot;</span> <span class="k">do</span>

      <span class="n">it</span> <span class="s2">&quot;should not make a new user&quot;</span> <span class="k">do</span>
        <span class="n">visit</span> <span class="n">signup_path</span>
        <span class="n">fill_in</span> <span class="s2">&quot;Nom&quot;</span><span class="p">,</span>         <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span>
        <span class="n">fill_in</span> <span class="s2">&quot;Email&quot;</span><span class="p">,</span>        <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span>
        <span class="n">fill_in</span> <span class="s2">&quot;Password&quot;</span><span class="p">,</span>     <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span>
        <span class="n">fill_in</span> <span class="s2">&quot;Confirmation&quot;</span><span class="p">,</span> <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span>
        <span class="n">click_button</span>
        <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;users/new&#39;</span><span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;div#error_explanation&quot;</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Here <code>"div#error_explanation"</code> is CSS-inspired shorthand for</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;error_explanation&quot;</span><span class="nt">&gt;</span>...<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div>


<p>Notice how natural the language is in <a class="ref" href="sign-up#code:signup_failure_test">extrait&nbsp;8.20</a>. The only problem is that it doesn&rsquo;t <em>quite</em> test what we want: we&rsquo;re not actually testing that a failed submission fails to create a new user. To do so, we need to wrap the test steps in a single package, and then check that it doesn&rsquo;t change the <code>User</code> count. As we saw in <a class="ref" href="sign-up#code:failing_create_specs">extrait&nbsp;8.6</a> and <a class="ref" href="sign-up#code:signup_success_tests">extrait&nbsp;8.14</a>, this can be accomplished with a <code>lambda</code>. In those cases, the <code>lambda</code> block only contained a single line, but we see in <a class="ref" href="sign-up#code:signup_failure_test_lambda">extrait&nbsp;8.21</a> that it can wrap multiple lines just as easily.</p>

<div class="label" id="code:signup_failure_test_lambda"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 8.21.</span> <span class="description">Testing signup failure with a <code>lambda</code>. <br /> <code>spec/requests/users_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Users&quot;</span> <span class="k">do</span>

  <span class="n">describe</span> <span class="s2">&quot;signup&quot;</span> <span class="k">do</span>

    <span class="n">describe</span> <span class="s2">&quot;failure&quot;</span> <span class="k">do</span>

      <span class="n">it</span> <span class="s2">&quot;should not make a new user&quot;</span> <span class="k">do</span>
        <span class="nb">lambda</span> <span class="k">do</span>
          <span class="n">visit</span> <span class="n">signup_path</span>
          <span class="n">fill_in</span> <span class="s2">&quot;Nom&quot;</span><span class="p">,</span>         <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span>
          <span class="n">fill_in</span> <span class="s2">&quot;Email&quot;</span><span class="p">,</span>        <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span>
          <span class="n">fill_in</span> <span class="s2">&quot;Password&quot;</span><span class="p">,</span>     <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span>
          <span class="n">fill_in</span> <span class="s2">&quot;Confirmation&quot;</span><span class="p">,</span> <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span>
          <span class="n">click_button</span>
          <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;users/new&#39;</span><span class="p">)</span>
          <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;div#error_explanation&quot;</span><span class="p">)</span>
        <span class="k">end</span><span class="o">.</span><span class="n">should_not</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>As in <a class="ref" href="sign-up#code:failing_create_specs">extrait&nbsp;8.6</a>, this uses</p>

<div class="code"><div class="highlight"><pre><span class="n">should_not</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span>
</pre></div>
</div>


<p>to verify that the code inside the <code>lambda</code> block doesn&rsquo;t change the value of <code>User.count</code>.</p>

<p>The integration test in <a class="ref" href="sign-up#code:signup_failure_test_lambda">extrait&nbsp;8.21</a> ties together all the different parts of Rails, including models, views, controllers, routing, and helpers. It provides an end-to-end verification that our signup machinery is working, at least for failed submissions.</p>

<div class="label" id="sec:successful_signup"></div>


<h3><a id="sec:8.4.3" href="sign-up#sec:successful_signup" class="heading"><span class="number">8.4.3</span> Users signup success should make a new user</a></h3>


<p>We come now to the integration test for successful signup. In this case, we need to fill in the signup fields with valid user data. When we do, the result should be the user show page with a «&nbsp;flash success&nbsp;» <code>div</code> tag, and it should change the User count by&nbsp;1. <a class="ref" href="sign-up#code:signup_success_test">extrait&nbsp;8.22</a> shows how to do it.</p>

<div class="label" id="code:signup_success_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 8.22.</span> <span class="description">Testing signup success. <br /> <code>spec/requests/users_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="s2">&quot;Users&quot;</span> <span class="k">do</span>

  <span class="n">describe</span> <span class="s2">&quot;signup&quot;</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;success&quot;</span> <span class="k">do</span>

      <span class="n">it</span> <span class="s2">&quot;should make a new user&quot;</span> <span class="k">do</span>
        <span class="nb">lambda</span> <span class="k">do</span>
          <span class="n">visit</span> <span class="n">signup_path</span>
          <span class="n">fill_in</span> <span class="s2">&quot;Nom&quot;</span><span class="p">,</span>         <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="s2">&quot;Example User&quot;</span>
          <span class="n">fill_in</span> <span class="s2">&quot;Email&quot;</span><span class="p">,</span>        <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="s2">&quot;user@example.com&quot;</span>
          <span class="n">fill_in</span> <span class="s2">&quot;Password&quot;</span><span class="p">,</span>     <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="s2">&quot;foobar&quot;</span>
          <span class="n">fill_in</span> <span class="s2">&quot;Confirmation&quot;</span><span class="p">,</span> <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="s2">&quot;foobar&quot;</span>
          <span class="n">click_button</span>
          <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;div.flash.success&quot;</span><span class="p">,</span>
                                        <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="s2">&quot;Welcome&quot;</span><span class="p">)</span>
          <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;users/show&#39;</span><span class="p">)</span>
        <span class="k">end</span><span class="o">.</span><span class="n">should</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>By the way, although it&rsquo;s not obvious from the RSpec documentation, you can use the CSS id of the text box instead of the label, so <code>fill_in :user_nom</code> also works.<sup class="footnote" id="fnref:8.11"><a href="#fn:8.11">11</a></sup> (This is especially nice for forms that don&rsquo;t use labels.)</p>

<p>I hope you agree that this web navigation syntax is incredibly natural and succinct. For example, to fill in a field with a value, we just use code like this:</p>

<div class="code"><div class="highlight"><pre><span class="n">fill_in</span> <span class="s2">&quot;Nom&quot;</span><span class="p">,</span>         <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="s2">&quot;Example User&quot;</span>
<span class="n">fill_in</span> <span class="s2">&quot;Email&quot;</span><span class="p">,</span>        <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="s2">&quot;user@example.com&quot;</span>
<span class="n">fill_in</span> <span class="s2">&quot;Password&quot;</span><span class="p">,</span>     <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="s2">&quot;foobar&quot;</span>
<span class="n">fill_in</span> <span class="s2">&quot;Confirmation&quot;</span><span class="p">,</span> <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="s2">&quot;foobar&quot;</span>
</pre></div>
</div>


<p>Here the first arguments to <code>fill_in</code> are the label values, i.e., exactly the text the user sees in the browser; there&rsquo;s no need to know anything about the underlying HTML structure generated by the Rails <code>form_for</code> helper.</p>

<p>Finally, we come to the coup de gr&acirc;ce&mdash;testing that successful signup actually creates a user in the database:</p>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="s2">&quot;should make a new user&quot;</span> <span class="k">do</span>
  <span class="nb">lambda</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span><span class="o">.</span><span class="n">should</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>


<p>As in <a class="ref" href="sign-up#code:signup_failure_test_lambda">extrait&nbsp;8.21</a>, we&rsquo;ve wrapped the code for a successful signup in a <code>lambda</code> block. In this case, instead of making sure that the User count <em>doesn&rsquo;t</em> change, we verify that it increases by&nbsp;1 due to a User record being created in the test database. The result is as follows:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rspec spec/requests/users_spec.rb 
<span class="go">..</span>


<span class="go">Finished in 2.14 seconds</span>
<span class="go">2 examples, 0 failures</span>
</pre></div>
</div>


<p>With that, our signup integration tests are complete, and we can be confident that, if users don&rsquo;t join our site, it&rsquo;s not because the signup form is broken.</p>

<h2><a id="sec:8.5" href="sign-up#sec:8.5" class="heading"><span class="number">8.5</span> Conclusion</a></h2>


<p>Being able to sign up users is a major milestone for our application. Though the sample app has yet to accomplish anything useful, we have laid an essential foundation for all future development. In the next two chapters, we will complete two more major milestones: first, in <a class="ref" href="sign-in-sign-out#top">chapitre&nbsp;9</a> we will complete our authentication machinery by allowing users to sign in and out of the application; second, in <a class="ref" href="updating-showing-and-deleting-users#top">chapitre&nbsp;10</a> we will allow all users to update their account information and will allow site administrators to delete users, while also adding page protection to enforce a site security model, thereby completing the full suite of the Users resource REST actions from <a class="ref" href="modeling-and-viewing-users-one#table:RESTful_users">Table&nbsp;6.2</a>.</p>

<p>As usual, if you&rsquo;re using Git, you should merge your changes into the <code>master</code> branch at this point:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">&quot;User signup complete&quot;</span>
<span class="gp">$</span> git checkout master
<span class="gp">$</span> git merge signing-up
</pre></div>
</div>


<div class="label" id="sec:signup_exercises"></div>


<h2><a id="sec:8.6" href="sign-up#sec:signup_exercises" class="heading"><span class="number">8.6</span> Exercises</a></h2>




<ol>

<li>Using the model in <a class="ref" href="sign-up#code:field_tests">extrait&nbsp;8.23</a>, write tests to check for the presence of each field on the signup form. (Don&rsquo;t forget the <code>render_views</code> line, which is essential for this to work.)</li>

<li>Oftentimes signup forms will clear the password field for failed submissions, as shown in <a class="ref" href="sign-up#fig:cleared_password">illustration&nbsp;8.12</a>. Modify the Users controller <code>create</code> action to replicate this behavior. <em>Hint:</em> Reset <code>@user.password</code>.</li>

<li>The flash HTML in <a class="ref" href="sign-up#code:layout_flash">extrait&nbsp;8.16</a> is a particularly ugly combination of HTML and ERb. Verify by running the test suite that the cleaner code in <a class="ref" href="sign-up#code:layout_flash_content_tag">extrait&nbsp;8.24</a>, which uses the Rails <code>content_tag</code> helper, also works.</li>

</ol>




<div class="label" id="code:field_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 8.23.</span> <span class="description">A template for testing for each field on the signup form. <br /> <code>spec/controllers/users_controller_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">UsersController</span> <span class="k">do</span>
  <span class="n">render_views</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;GET &#39;new&#39;&quot;</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>

    <span class="n">it</span> <span class="s2">&quot;should have a name field&quot;</span> <span class="k">do</span>
      <span class="n">get</span> <span class="ss">:new</span>
      <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;input[nom=&#39;user[nom]&#39;][type=&#39;text&#39;]&quot;</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should have an email field&quot;</span>

    <span class="n">it</span> <span class="s2">&quot;should have a password field&quot;</span>

    <span class="n">it</span> <span class="s2">&quot;should have a password confirmation field&quot;</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="fig:cleared_password"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/cleared_password.png" alt="cleared_password" /></span></div><div class="caption"><span class="header">Illustration 8.12: </span><span class="description">A failed signup form submission with the password field cleared.&nbsp;<a href="http://railstutorial.org/images/figures/cleared_password-full.png">(taille normale)</a></span></div></div>




<div class="label" id="code:layout_flash_content_tag"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 8.24.</span> <span class="description">The <code>flash</code> ERb in the site layout using <code>content_tag</code>. <br /> <code>app/views/layouts/application.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
      .
      .
      .
      <span class="nt">&lt;section</span> <span class="na">class=</span><span class="s">&quot;round&quot;</span><span class="nt">&gt;</span>
        <span class="cp">&lt;%</span> <span class="n">flash</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span> <span class="cp">%&gt;</span>
          <span class="cp">&lt;%=</span> <span class="n">content_tag</span><span class="p">(</span><span class="ss">:div</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="ss">:class</span> <span class="o">=&gt;</span> <span class="s2">&quot;flash </span><span class="si">#{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="cp">%&gt;</span>
        <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span> 
        <span class="cp">&lt;%=</span> <span class="k">yield</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/section&gt;</span>
      .
      .
      .
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div></div>


<div class="navigation">  <a class="prev_page" href="modeling-and-viewing-users-two#top">
    &laquo;&nbsp;<span class="number">chapitre 7</span> Modeling and viewing users, part II
  </a>
  <a class="next_page" href="sign-in-sign-out#top">
    <span class="number">chapitre 9</span> Sign in, sign out&nbsp;&raquo;
  </a>
</div><div class="footnotes">
<ol>
<li id="fn:8.1">Si vous rencontrez une erreur comme <code>views/users/new.html.erb_spec.rb fails</code>, supprimer ces maudits specs vues avec <code>$ rm -rf spec/views</code>.&nbsp;<a class="arrow" href="#fnref:8.1">&uarr;</a></li>
<li id="fn:8.2">Le nom vient de <a href="http://en.wikipedia.org/wiki/Lambda_calculus">the lambda calculus</a>, un système mathématique pour représenter les fonctions et leurs opérations.&nbsp;<a class="arrow" href="#fnref:8.2">&uarr;</a></li>
<li id="fn:8.3">Avant Rails&nbsp;3, l'affichage des messages d'erreur se faisait par un appel magique à une méthode spéciale <code>error_messages</code> sur l'objet formulaire&nbsp;<code>f</code>, comme suit&nbsp;: <tt class="verb">&lt;%= f.error_messages %&gt;</tt>. Bien que souvent efficace, cette méthode magique était difficilement personnalisable, donc l'équipe Rails a décidé de recommander d'utiliser du Ruby embarqué pour afficher les erreurs à la main.&nbsp;<a class="arrow" href="#fnref:8.3">&uarr;</a></li>
<li id="fn:8.4">Je l'ai compris en consultant <code>pluralize</code> dans l'API Rails.&nbsp;<a class="arrow" href="#fnref:8.4">&uarr;</a></li>
<li id="fn:8.5">Dans le cas où vous seriez curieux, le code de réponse eest le <tt>302</tt>, en contraste avec la redirection «&nbsp;permanente&nbsp;» <tt>301</tt> exposée brièvement dans le <a class="ref" href="static-pages#sidebar:response_codes">Box&nbsp;3.2</a>.&nbsp;<a class="arrow" href="#fnref:8.5">&uarr;</a></li>
<li id="fn:8.6">Notez que la clé <code>:success</code> est un symbole, mais le code Ruby embarqué le convertit automatiquement en une chaine <code>"success"</code> avant de l'insérer dans le.&nbsp;<a class="arrow" href="#fnref:8.6">&uarr;</a></li>
<li id="fn:8.7">Actually, we&rsquo;ll use the closely related <code>flash.now</code>, but we&rsquo;ll defer that subtlety until we need it.&nbsp;<a class="arrow" href="#fnref:8.7">&uarr;</a></li>
<li id="fn:8.8">The indices are zero-offset, as with arrays (<a class="ref" href="rails-flavored-ruby#sec:arrays_and_ranges">section&nbsp;4.3.1</a>), so a return value of <code>0</code> means the string matches the regular expression starting with the first character.&nbsp;<a class="arrow" href="#fnref:8.8">&uarr;</a></li>
<li id="fn:8.9">Au moment où j'écris ces lignes, cette syntaxe est disponible grâce à <a href="http://github.com/brynary/webrat">Webrat</a>, qui est apparue comme une dépendance gem de <tt>rspec-rails</tt>, mais que Webrat a écrit avant l'adoption généralisée de <a href="http://rack.rubyforge.org/">Rack</a> et sera peut-être supplantée par le projet  <a href="http://github.com/jnicklas/capybara">Capybara</a>. Heureusement,, Capybara est conçu comme une solution de remplacement de Webrat, donc la syntaxe devrait rester la même.&nbsp;<a class="arrow" href="#fnref:8.9">&uarr;</a></li>
<li id="fn:8.10">Note the plural; this is <em>not</em> the User spec <code>user_spec.rb</code>, which is a model test, not an integration test.&nbsp;<a class="arrow" href="#fnref:8.10">&uarr;</a></li>
<li id="fn:8.11">You can use Firebug or your browser&rsquo;s «&nbsp;view source&nbsp;» if you need to figure out the id. Or you can note that Rails uses the name of the resource and the name of the attribute separated with an underscore, yielding <code>user_nom</code>, <code>user_email</code>, etc.&nbsp;<a class="arrow" href="#fnref:8.11">&uarr;</a></li>
</ol>
</div>




