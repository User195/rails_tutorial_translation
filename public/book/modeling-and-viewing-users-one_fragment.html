

<h1 class="title">Tutoriel Ruby on Rails </h1>


<h1 class="subtitle">  Apprendre Rails par l'exemple</h1>


<h2 class="author">Michael Hartl</h2>




<h1 class="contents">Contenu</h1>


<div id="table_of_contents"><ol>
<li class="chapter"><a href="beginning#top"><span class="number">Chapitre 1</span> De zéro au déploiement</a></li>
<li><ol>
<li class="section"><a href="beginning#sec:introduction"><span class="number">1.1</span> Introduction</a></li>
<li><ol>
<li class="subsection"><a href="beginning#sec:comments_for_various_readers"><span class="number">1.1.1</span> Commentaires pour les lecteurs différents</a></li>
<li class="subsection"><a href="beginning#sec:1.1.2"><span class="number">1.1.2</span> &ldquo;Dimensionner&rdquo; Rails</a></li>
<li class="subsection"><a href="beginning#sec:conventions"><span class="number">1.1.3</span> Conventions utilisées dans ce livre</a></li></ol></li>
<li class="section"><a href="beginning#sec:up_and_running"><span class="number">1.2</span> [(Up and running)(En route pour le démarrage)]</a></li>
<li><ol>
<li class="subsection"><a href="beginning#sec:development_tools"><span class="number">1.2.1</span> Environnements de développement</a></li>
<li><ol>
<li class="subsubsection"><a href="beginning#sec:1.2.1.1">IDEs</a></li>
<li class="subsubsection"><a href="beginning#sec:1.2.1.2">Éditeurs de texte et lignes de commande</a></li>
<li class="subsubsection"><a href="beginning#sec:1.2.1.3">Navigateurs</a></li>
<li class="subsubsection"><a href="beginning#sec:1.2.1.4">Note à propos des outils</a></li></ol></li>
<li class="subsection"><a href="beginning#sec:rubygems"><span class="number">1.2.2</span> Ruby, RubyGems, Rails, et Git</a></li>
<li><ol>
<li class="subsubsection"><a href="beginning#sec:rails_installer_windows">Installation de Rails (Windows)</a></li>
<li class="subsubsection"><a href="beginning#sec:install_git">Installer Git</a></li>
<li class="subsubsection"><a href="beginning#sec:install_ruby">Installer Ruby</a></li>
<li class="subsubsection"><a href="beginning#sec:install_rubygems">Installer RubyGems</a></li>
<li class="subsubsection"><a href="beginning#sec:install_rails">Installer Rails</a></li></ol></li>
<li class="subsection"><a href="beginning#sec:the_first_application"><span class="number">1.2.3</span> La première application</a></li>
<li class="subsection"><a href="beginning#sec:bundler"><span class="number">1.2.4</span> Bundler</a></li>
<li class="subsection"><a href="beginning#sec:rails_server"><span class="number">1.2.5</span> <code>Le serveur rails (rails server)</code></a></li>
<li class="subsection"><a href="beginning#sec:mvc"><span class="number">1.2.6</span> Modèles-Vue-Contrôleur (MVC)</a></li></ol></li>
<li class="section"><a href="beginning#sec:version_control"><span class="number">1.3</span> Contrôle de versions avec Git</a></li>
<li><ol>
<li class="subsection"><a href="beginning#sec:git_setup"><span class="number">1.3.1</span> Installation et réglages</a></li>
<li><ol>
<li class="subsubsection"><a href="beginning#sec:1.3.1.1">Initialisation des réglages système</a></li>
<li class="subsubsection"><a href="beginning#sec:1.3.1.2">Initialisation des réglages du dépôt (repository)</a></li></ol></li>
<li class="subsection"><a href="beginning#sec:adding_and_committing"><span class="number">1.3.2</span> Ajout et mandat de dépôt</a></li>
<li class="subsection"><a href="beginning#sec:1.3.3"><span class="number">1.3.3</span> Qu'est-ce que Git peut faire de bien pour vous&nbsp;?</a></li>
<li class="subsection"><a href="beginning#sec:github"><span class="number">1.3.4</span> GitHub</a></li>
<li class="subsection"><a href="beginning#sec:git_commands"><span class="number">1.3.5</span> Branch, edit, commit, merge</a></li>
<li><ol>
<li class="subsubsection"><a href="beginning#sec:git_branch">Branch</a></li>
<li class="subsubsection"><a href="beginning#sec:git_edit">Edit</a></li>
<li class="subsubsection"><a href="beginning#sec:git_commit">Commit</a></li>
<li class="subsubsection"><a href="beginning#sec:git_merge">Merge</a></li>
<li class="subsubsection"><a href="beginning#sec:git_push">Push</a></li></ol></li></ol></li>
<li class="section"><a href="beginning#sec:deploying"><span class="number">1.4</span> Déploiement</a></li>
<li><ol>
<li class="subsection"><a href="beginning#sec:1.4.1"><span class="number">1.4.1</span> Réglages Heroku</a></li>
<li class="subsection"><a href="beginning#sec:heroku_step_one"><span class="number">1.4.2</span> déploiement Heroku, première étape</a></li>
<li class="subsection"><a href="beginning#sec:1.4.3"><span class="number">1.4.3</span> Déploiement Heroku deployment, seconde étape</a></li>
<li class="subsection"><a href="beginning#sec:heroku_commands"><span class="number">1.4.4</span> Commandes Heroku</a></li></ol></li>
<li class="section"><a href="beginning#sec:beginning_conclusion"><span class="number">1.5</span> Conclusion</a></li></ol></li>
<li class="chapter"><a href="a-demo-app#top"><span class="number">Chapitre 2</span> Une application démo</a></li>
<li><ol>
<li class="section"><a href="a-demo-app#sec:planning_the_application"><span class="number">2.1</span> Planifier l'application</a></li>
<li><ol>
<li class="subsection"><a href="a-demo-app#sec:modeling_users"><span class="number">2.1.1</span> Modéliser les utilisateurs</a></li>
<li class="subsection"><a href="a-demo-app#sec:modeling_microposts"><span class="number">2.1.2</span> Modéliser les micro-messages</a></li></ol></li>
<li class="section"><a href="a-demo-app#sec:demo_users_resource"><span class="number">2.2</span> La ressource Utilisateurs (Users)</a></li>
<li><ol>
<li class="subsection"><a href="a-demo-app#sec:a_user_tour"><span class="number">2.2.1</span> Un tour de l'utilisateur</a></li>
<li class="subsection"><a href="a-demo-app#sec:mvc_in_action"><span class="number">2.2.2</span> MVC en action</a></li>
<li class="subsection"><a href="a-demo-app#sec:weaknesses_of_this_users_resource"><span class="number">2.2.3</span> Faiblesses de la ressource Utilisateurs (Users)</a></li></ol></li>
<li class="section"><a href="a-demo-app#sec:microposts_resource"><span class="number">2.3</span> La ressource Micro-messages (Microposts)</a></li>
<li><ol>
<li class="subsection"><a href="a-demo-app#sec:a_micropost_microtour"><span class="number">2.3.1</span> Un petit tour du micro-message</a></li>
<li class="subsection"><a href="a-demo-app#sec:putting_the_micro_in_microposts"><span class="number">2.3.2</span> Appliquer le <em>micro</em> aux micro-messages</a></li>
<li class="subsection"><a href="a-demo-app#sec:demo_user_has_many_microposts"><span class="number">2.3.3</span> Un utilisateur <code>has_many</code> (<code>possède plusieurs</code>) micro-messages</a></li>
<li class="subsection"><a href="a-demo-app#sec:inheritance_hierarchies"><span class="number">2.3.4</span> Hiérarchie des héritages</a></li>
<li class="subsection"><a href="a-demo-app#sec:deploying_the_demo_app"><span class="number">2.3.5</span> Déployer l'application Démo</a></li></ol></li>
<li class="section"><a href="a-demo-app#sec:2.4"><span class="number">2.4</span> Conclusion</a></li></ol></li>
<li class="chapter"><a href="static-pages#top"><span class="number">Chapitre 3</span> Pages statiques courantes</a></li>
<li><ol>
<li class="section"><a href="static-pages#sec:static_pages"><span class="number">3.1</span> Pages statiques</a></li>
<li><ol>
<li class="subsection"><a href="static-pages#sec:truly_static_pages"><span class="number">3.1.1</span> Pages HTML statiques</a></li>
<li class="subsection"><a href="static-pages#sec:static_pages_with_rails"><span class="number">3.1.2</span> Les pages statiques avec Rails</a></li></ol></li>
<li class="section"><a href="static-pages#sec:first_tests"><span class="number">3.2</span> Premiers tests</a></li>
<li><ol>
<li class="subsection"><a href="static-pages#sec:testing_tools"><span class="number">3.2.1</span> Outils de test</a></li>
<li><ol>
<li class="subsubsection"><a href="static-pages#sec:autotest">Auto-test</a></li></ol></li>
<li class="subsection"><a href="static-pages#sec:TDD"><span class="number">3.2.2</span> TDD : Rouge, Vert, Refactor</a></li>
<li><ol>
<li class="subsubsection"><a href="static-pages#sec:spork">Spork</a></li>
<li class="subsubsection"><a href="static-pages#sec:red">Rouge</a></li>
<li class="subsubsection"><a href="static-pages#sec:green">Vert</a></li>
<li class="subsubsection"><a href="static-pages#sec:refactor">Refactor</a></li></ol></li></ol></li>
<li class="section"><a href="static-pages#sec:slightly_dynamic_pages"><span class="number">3.3</span> Pages (un peu) dynamiques</a></li>
<li><ol>
<li class="subsection"><a href="static-pages#sec:testing_a_title_change"><span class="number">3.3.1</span> Test d'un changement de titre</a></li>
<li class="subsection"><a href="static-pages#sec:passing_title_tests"><span class="number">3.3.2</span> Réussir les tests de titre</a></li>
<li class="subsection"><a href="static-pages#sec:instance_variables_embedded_ruby"><span class="number">3.3.3</span> Variables d'instance et Ruby embarqué</a></li>
<li class="subsection"><a href="static-pages#sec:layouts"><span class="number">3.3.4</span> Supprimer les répétitions avec les <em>layouts</em></a></li></ol></li>
<li class="section"><a href="static-pages#sec:static_pages_conclusion"><span class="number">3.4</span> Conclusion</a></li>
<li class="section"><a href="static-pages#sec:static_pages_Exercices"><span class="number">3.5</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="rails-flavored-ruby#top"><span class="number">Chapitre 4</span> [(Rails-flavored Ruby)(Rails au goût Ruby)]</a></li>
<li><ol>
<li class="section"><a href="rails-flavored-ruby#sec:motivation"><span class="number">4.1</span> Motivation</a></li>
<li><ol>
<li class="subsection"><a href="rails-flavored-ruby#sec:title_helper"><span class="number">4.1.1</span> Un « helper » (« aideur ») pour le titre (<code>title</code>)</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:cascading_style_sheets"><span class="number">4.1.2</span> Feuilles de styles (CSS — Cascading Style Sheets)</a></li></ol></li>
<li class="section"><a href="rails-flavored-ruby#sec:strings_and_methods"><span class="number">4.2</span> Chaines de caractères et méthodes</a></li>
<li><ol>
<li class="subsection"><a href="rails-flavored-ruby#sec:comments"><span class="number">4.2.1</span> Commentaires</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:strings"><span class="number">4.2.2</span> Chaines de caractères</a></li>
<li><ol>
<li class="subsubsection"><a href="rails-flavored-ruby#sec:printing">Impression</a></li>
<li class="subsubsection"><a href="rails-flavored-ruby#sec:single_quoted_strings">Chaines de caractères « single-quoté »</a></li></ol></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:objects_and_message_passing"><span class="number">4.2.3</span> Objets et passage de message</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:method_definitions"><span class="number">4.2.4</span> Définition de méthode</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:back_to_the_title_helper"><span class="number">4.2.5</span> Retour à l'« helper » de titre</a></li></ol></li>
<li class="section"><a href="rails-flavored-ruby#sec:other_data_structures"><span class="number">4.3</span> Autres structures de données</a></li>
<li><ol>
<li class="subsection"><a href="rails-flavored-ruby#sec:arrays_and_ranges"><span class="number">4.3.1</span> Tableaux et rangs</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:blocks"><span class="number">4.3.2</span> Blocs</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:hashes_and_symbols"><span class="number">4.3.3</span> Tables de hachage et symboles</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:css_revisited"><span class="number">4.3.4</span> CSS revisitées</a></li></ol></li>
<li class="section"><a href="rails-flavored-ruby#sec:ruby_classes"><span class="number">4.4</span> Classes Ruby</a></li>
<li><ol>
<li class="subsection"><a href="rails-flavored-ruby#sec:constructors"><span class="number">4.4.1</span> Constructeurs</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:a_class_of_our_own"><span class="number">4.4.2</span> Héritages de classes</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:modifying_built_in_classes"><span class="number">4.4.3</span> Modifier les classes d'origine</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:a_controller_class"><span class="number">4.4.4</span> Classe de contrôleur</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:a_user_class"><span class="number">4.4.5</span> Classe utiliateur</a></li></ol></li>
<li class="section"><a href="rails-flavored-ruby#sec:Exercices"><span class="number">4.5</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="filling-in-the-layout#top"><span class="number">Chapitre 5</span> Poursuivre la mise en page</a></li>
<li><ol>
<li class="section"><a href="filling-in-the-layout#sec:structure"><span class="number">5.1</span> Ajout de structure</a></li>
<li><ol>
<li class="subsection"><a href="filling-in-the-layout#sec:adding_to_the_layout"><span class="number">5.1.1</span> Navigation du site</a></li>
<li class="subsection"><a href="filling-in-the-layout#sec:custom_css"><span class="number">5.1.2</span> Personnalisation CSS</a></li>
<li class="subsection"><a href="filling-in-the-layout#sec:partials"><span class="number">5.1.3</span> Partiels (Partials)</a></li></ol></li>
<li class="section"><a href="filling-in-the-layout#sec:layout_links"><span class="number">5.2</span> Liens pour la mise en page</a></li>
<li><ol>
<li class="subsection"><a href="filling-in-the-layout#sec:integration_tests"><span class="number">5.2.1</span> Test d'intégration</a></li>
<li class="subsection"><a href="filling-in-the-layout#sec:rails_routes"><span class="number">5.2.2</span> Routes Rails</a></li>
<li class="subsection"><a href="filling-in-the-layout#sec:nomd_routes"><span class="number">5.2.3</span> Nommer les routes</a></li></ol></li>
<li class="section"><a href="filling-in-the-layout#sec:user_signup"><span class="number">5.3</span> Inscription de l'utilisateur : une première étape</a></li>
<li><ol>
<li class="subsection"><a href="filling-in-the-layout#sec:users_controller"><span class="number">5.3.1</span> Contrôleur Utilisateur (Users controller)</a></li>
<li class="subsection"><a href="filling-in-the-layout#sec:signup_url"><span class="number">5.3.2</span> URL d'inscription</a></li></ol></li>
<li class="section"><a href="filling-in-the-layout#sec:layout_conclusion"><span class="number">5.4</span> Conclusion</a></li>
<li class="section"><a href="filling-in-the-layout#sec:layout_Exercices"><span class="number">5.5</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="modeling-and-viewing-users-one#top"><span class="number">Chapitre 6</span> Modéliser et afficher les utilisateurs, partie I</a></li>
<li><ol>
<li class="section"><a href="modeling-and-viewing-users-one#sec:user_model"><span class="number">6.1</span> Modèle utilisateur (User model)</a></li>
<li><ol>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:database_migrations"><span class="number">6.1.1</span> Migrations de la base de données</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:the_model_file"><span class="number">6.1.2</span> Le fichier modèle</a></li>
<li><ol>
<li class="subsubsection"><a href="modeling-and-viewing-users-one#sec:model_annotation">[(Model annotation)]</a></li>
<li class="subsubsection"><a href="modeling-and-viewing-users-one#sec:accessible_attributes">Attributs accessibles</a></li></ol></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:creating_user_objects"><span class="number">6.1.3</span> Créer des objets Utilisateur</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:finding_user_objects"><span class="number">6.1.4</span> Recherche dans les objets Utilisateurs (Users)</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:updating_user_objects"><span class="number">6.1.5</span> Actualisation des objets Utilisateurs (Users)</a></li></ol></li>
<li class="section"><a href="modeling-and-viewing-users-one#sec:user_validations"><span class="number">6.2</span> Validations utilisateur</a></li>
<li><ol>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:presence_validation"><span class="number">6.2.1</span> Valider l'existence</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:length_validation"><span class="number">6.2.2</span> Valider la longueur</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:format_validation"><span class="number">6.2.3</span> Valider le format</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:uniqueness_validation"><span class="number">6.2.4</span> Valider l'unicité</a></li>
<li><ol>
<li class="subsubsection"><a href="modeling-and-viewing-users-one#sec:the_caveat">L'avertissement d'unicité</a></li></ol></li></ol></li>
<li class="section"><a href="modeling-and-viewing-users-one#sec:viewing_users"><span class="number">6.3</span> Afficher les utilisateurs</a></li>
<li><ol>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:rails_environments"><span class="number">6.3.1</span> Débuggage et environnements Rails</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:users_show"><span class="number">6.3.2</span> Modèle, Vue et Contrôleur Utilisateur</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:a_users_resource"><span class="number">6.3.3</span> Ressource Utilisateurs</a></li>
<li><ol>
<li class="subsubsection"><a href="modeling-and-viewing-users-one#sec:params_in_debug">[(<code>params</code> in <code>debug</code>)]</a></li></ol></li></ol></li>
<li class="section"><a href="modeling-and-viewing-users-one#sec:6.4"><span class="number">6.4</span> Conclusion</a></li>
<li class="section"><a href="modeling-and-viewing-users-one#sec:6.5"><span class="number">6.5</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="modeling-and-viewing-users-two#top"><span class="number">Chapitre 7</span> Modéliser et afficher les utilisateurs, partie II</a></li>
<li><ol>
<li class="section"><a href="modeling-and-viewing-users-two#sec:insecure_passwords"><span class="number">7.1</span> Mots de passe non sûrs</a></li>
<li><ol>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:password_validations"><span class="number">7.1.1</span> Valider le mot de passe</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:password_migration"><span class="number">7.1.2</span> Migrer un mot de passe</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:an_active_record_callback"><span class="number">7.1.3</span> Un <em>callback</em> de l'Active Record</a></li></ol></li>
<li class="section"><a href="modeling-and-viewing-users-two#sec:secure_passwords"><span class="number">7.2</span> Sécuriser les mots de passe</a></li>
<li><ol>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:a_secure_password_test"><span class="number">7.2.1</span> Test de mot de passe sûr</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:secure_password_theory"><span class="number">7.2.2</span> Un peu de théorie sur les mots de passe sécurisés</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:implementing_has_password"><span class="number">7.2.3</span> Implémenter la méthode <code>has_password?</code></a></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:an_authenticate_method"><span class="number">7.2.4</span> Méthode d'authentification</a></li></ol></li>
<li class="section"><a href="modeling-and-viewing-users-two#sec:better_user_views"><span class="number">7.3</span> Meilleures vues d'utilisateurs</a></li>
<li><ol>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:tests_with_factories"><span class="number">7.3.1</span> Tester la page de l'utilisateur (avec factories)</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:a_nom_and_a_gravatar"><span class="number">7.3.2</span> Un nom et un Gravatar</a></li>
<li><ol>
<li class="subsubsection"><a href="modeling-and-viewing-users-two#sec:a_gravatar_helper">Un « helper » de Gravatar</a></li></ol></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:a_user_sidebar"><span class="number">7.3.3</span> Une barre utilisateur latérale</a></li></ol></li>
<li class="section"><a href="modeling-and-viewing-users-two#sec:7.4"><span class="number">7.4</span> Conclusion</a></li>
<li><ol>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:7.4.1"><span class="number">7.4.1</span> Commit Git</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:heroku_deploy"><span class="number">7.4.2</span> Déploiement Heroku</a></li></ol></li>
<li class="section"><a href="modeling-and-viewing-users-two#sec:more_modeling_users_Exercices"><span class="number">7.5</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="sign-up#top"><span class="number">Chapitre 8</span> Inscription</a></li>
<li><ol>
<li class="section"><a href="sign-up#sec:signup_form"><span class="number">8.1</span> Formulaire d'inscription</a></li>
<li><ol>
<li class="subsection"><a href="sign-up#sec:using_form_for"><span class="number">8.1.1</span> Utiliser  <code>form_for</code></a></li>
<li class="subsection"><a href="sign-up#sec:the_form_html"><span class="number">8.1.2</span> Le formulaire HTML</a></li></ol></li>
<li class="section"><a href="sign-up#sec:signup_failure"><span class="number">8.2</span> Échec de l'inscription</a></li>
<li><ol>
<li class="subsection"><a href="sign-up#sec:testing_failure"><span class="number">8.2.1</span> Test de l'échec</a></li>
<li class="subsection"><a href="sign-up#sec:a_working_form"><span class="number">8.2.2</span> Un formulaire fonctionnel</a></li>
<li class="subsection"><a href="sign-up#sec:signup_error_messages"><span class="number">8.2.3</span> Inscription&nbsp;: messages d'erreur</a></li>
<li class="subsection"><a href="sign-up#sec:filtering_parameter_logging"><span class="number">8.2.4</span> Filtrage des paramètres d'identification</a></li></ol></li>
<li class="section"><a href="sign-up#sec:signup_success"><span class="number">8.3</span> Succès de l'inscription</a></li>
<li><ol>
<li class="subsection"><a href="sign-up#sec:testing_success"><span class="number">8.3.1</span> Tester le succès de l'inscription</a></li>
<li class="subsection"><a href="sign-up#sec:the_finished_signup_form"><span class="number">8.3.2</span> Le formulaire d'inscription finalisé</a></li>
<li class="subsection"><a href="sign-up#sec:the_flash"><span class="number">8.3.3</span> Le message «&nbsp;flash&nbsp;»</a</a></li>
<li class="subsection"><a href="sign-up#sec:the_first_signup"><span class="number">8.3.4</span> La première inscription</a></li></ol></li>
<li class="section"><a href="sign-up#sec:rspec_integration_tests"><span class="number">8.4</span> Test d'intégration RSpec</a></li>
<li><ol>
<li class="subsection"><a href="sign-up#sec:integration_tests_with_style"><span class="number">8.4.1</span> Tests d'intégration avec les styles</a></li>
<li class="subsection"><a href="sign-up#sec:failed_signup"><span class="number">8.4.2</span> Un échec d'inscription ne devrait pas créer un nouvel utilisateur</a></li>
<li class="subsection"><a href="sign-up#sec:successful_signup"><span class="number">8.4.3</span> Le succès d'une inscription devrait créer un nouvel utilisateur</a></li></ol></li>
<li class="section"><a href="sign-up#sec:8.5"><span class="number">8.5</span> Conclusion</a></li>
<li class="section"><a href="sign-up#sec:signup_Exercices"><span class="number">8.6</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="sign-in-sign-out#top"><span class="number">Chapitre 9</span> Connexion, déconnexion</a></li>
<li><ol>
<li class="section"><a href="sign-in-sign-out#sec:sessions"><span class="number">9.1</span> Les sessions</a></li>
<li><ol>
<li class="subsection"><a href="sign-in-sign-out#sec:sessions_controller"><span class="number">9.1.1</span> Le contrôleur de session</a></li>
<li class="subsection"><a href="sign-in-sign-out#sec:signin_form"><span class="number">9.1.2</span> Formulaire d'identification</a></li></ol></li>
<li class="section"><a href="sign-in-sign-out#sec:signin_failure"><span class="number">9.2</span> Échec de l'identification</a></li>
<li><ol>
<li class="subsection"><a href="sign-in-sign-out#sec:reviewing_form_submission"><span class="number">9.2.1</span> Examen de la soumission du formulaire</a></li>
<li class="subsection"><a href="sign-in-sign-out#sec:failed_signin"><span class="number">9.2.2</span> Échec de l'identification (test et code)</a></li></ol></li>
<li class="section"><a href="sign-in-sign-out#sec:signin_success"><span class="number">9.3</span> Succès de l'identification</a></li>
<li><ol>
<li class="subsection"><a href="sign-in-sign-out#sec:the_completed_create_action"><span class="number">9.3.1</span> L'action <code>create</code> («&nbsp;créer&nbsp;») finalisée</a></li>
<li class="subsection"><a href="sign-in-sign-out#sec:remember_me"><span class="number">9.3.2</span> Se souvenir de moi</a></li>
<li class="subsection"><a href="sign-in-sign-out#sec:current_user"><span class="number">9.3.3</span> Utilisateur courant</a></li></ol></li>
<li class="section"><a href="sign-in-sign-out#sec:signing_out"><span class="number">9.4</span> Déconnexion</a></li>
<li><ol>
<li class="subsection"><a href="sign-in-sign-out#sec:destroying_sessions"><span class="number">9.4.1</span> Détruire la session</a></li>
<li class="subsection"><a href="sign-in-sign-out#sec:signin_upon_signup"><span class="number">9.4.2</span> Connection à l'inscription</a></li>
<li class="subsection"><a href="sign-in-sign-out#sec:changing_the_layout_links"><span class="number">9.4.3</span> Changement des liens de la mise en plage</a></li>
<li class="subsection"><a href="sign-in-sign-out#sec:signin_out_integration_tests"><span class="number">9.4.4</span> Test d'intégration de l'identification/déconnexion</a></li></ol></li>
<li class="section"><a href="sign-in-sign-out#sec:9.5"><span class="number">9.5</span> Conclusion</a></li>
<li class="section"><a href="sign-in-sign-out#sec:sign_in_out_Exercices"><span class="number">9.6</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="updating-showing-and-deleting-users#top"><span class="number">Chapitre 10</span> Actualiser, afficher et supprimer de l'utilisateur</a></li>
<li><ol>
<li class="section"><a href="updating-showing-and-deleting-users#sec:updating_users"><span class="number">10.1</span> Actualiser l'utilisateur</a></li>
<li><ol>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:edit_form"><span class="number">10.1.1</span> Formulaire de modification</a></li>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:enabling_edits"><span class="number">10.1.2</span> Permettre les modifications</a></li></ol></li>
<li class="section"><a href="updating-showing-and-deleting-users#sec:protecting_pages"><span class="number">10.2</span> Protéger les pages</a></li>
<li><ol>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:requiring_signed_in_users"><span class="number">10.2.1</span> Utilisateurs identifiés requis</a></li>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:requiring_the_right_user"><span class="number">10.2.2</span> Nécessité du bon utilisateur</a></li>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:friendly_forwarding"><span class="number">10.2.3</span> Redirection conviviale</a></li></ol></li>
<li class="section"><a href="updating-showing-and-deleting-users#sec:showing_users"><span class="number">10.3</span> Afficher les utilisateurs</a></li>
<li><ol>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:user_index"><span class="number">10.3.1</span> Liste des utilisateurs</a></li>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:sample_users"><span class="number">10.3.2</span> Exemples d'utilisateurs</a></li>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:pagination"><span class="number">10.3.3</span> Pagination</a></li>
<li><ol>
<li class="subsubsection"><a href="updating-showing-and-deleting-users#sec:testing_pagination">Test de la pagination</a></li></ol></li>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:partial_refactoring"><span class="number">10.3.4</span> Restructuration des partielles</a></li></ol></li>
<li class="section"><a href="updating-showing-and-deleting-users#sec:destroying_users"><span class="number">10.4</span> Supprimer des utilisateurs</a></li>
<li><ol>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:administrative_users"><span class="number">10.4.1</span> Utilisateurs administrateurs</a></li>
<li><ol>
<li class="subsubsection"><a href="updating-showing-and-deleting-users#sec:revisiting_attr_accessible">Révision de <code>attr_accessible</code></a></li></ol></li>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:the_destroy_action"><span class="number">10.4.2</span> L'action <code>destroy</code> («&nbsp;supprimer&nbsp;»)</a></li></ol></li>
<li class="section"><a href="updating-showing-and-deleting-users#sec:10.5"><span class="number">10.5</span> Conclusion</a></li>
<li class="section"><a href="updating-showing-and-deleting-users#sec:updating_deleting_Exercices"><span class="number">10.6</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="user-microposts#top"><span class="number">Chapitre 11</span> Micro-messages d'utilisateur</a></li>
<li><ol>
<li class="section"><a href="user-microposts#sec:a_micropost_model"><span class="number">11.1</span> Le modèle Micropost («&nbsp;Micro-message&nbsp;»)</a></li>
<li><ol>
<li class="subsection"><a href="user-microposts#sec:the_basic_model"><span class="number">11.1.1</span> Le modèle initial</a></li>
<li><ol>
<li class="subsubsection"><a href="user-microposts#sec:accessible_attribute">Attributs accessibles</a></li></ol></li>
<li class="subsection"><a href="user-microposts#sec:user_micropost_associations"><span class="number">11.1.2</span> Associations Utilisateur/micro-messages</a></li>
<li class="subsection"><a href="user-microposts#sec:ordering_and_dependency"><span class="number">11.1.3</span> Affinements du micro-message</a></li>
<li><ol>
<li class="subsubsection"><a href="user-microposts#sec:default_scope">Portée par défaut</a></li>
<li class="subsubsection"><a href="user-microposts#sec:dependent_destroy">Dependent: destroy (dépendances de la suppression)</a></li></ol></li>
<li class="subsection"><a href="user-microposts#sec:micropost_validations"><span class="number">11.1.4</span> Validations du micro-message</a></li></ol></li>
<li class="section"><a href="user-microposts#sec:showing_microposts"><span class="number">11.2</span> Afficher les micro-messages</a></li>
<li><ol>
<li class="subsection"><a href="user-microposts#sec:augmenting_the_user_show_page"><span class="number">11.2.1</span> Etoffement de la page de l'utilisateur</a></li>
<li class="subsection"><a href="user-microposts#sec:sample_microposts"><span class="number">11.2.2</span> Exemples de micro-messages</a></li></ol></li>
<li class="section"><a href="user-microposts#sec:manipulating_microposts"><span class="number">11.3</span> Manipuler les micro-messages</a></li>
<li><ol>
<li class="subsection"><a href="user-microposts#sec:access_control"><span class="number">11.3.1</span> Contrôle de l'accès</a></li>
<li class="subsection"><a href="user-microposts#sec:creating_microposts"><span class="number">11.3.2</span> Créer des micro-messages</a></li>
<li class="subsection"><a href="user-microposts#sec:a_proto_feed"><span class="number">11.3.3</span> Une proto-alimentation</a></li>
<li class="subsection"><a href="user-microposts#sec:destroying_microposts"><span class="number">11.3.4</span> Supprimer des micro-messages</a></li>
<li class="subsection"><a href="user-microposts#sec:testing_the_new_home_page"><span class="number">11.3.5</span> Test de la nouvelle page d'accueil</a></li></ol></li>
<li class="section"><a href="user-microposts#sec:11.4"><span class="number">11.4</span> Conclusion</a></li>
<li class="section"><a href="user-microposts#sec:micropost_Exercices"><span class="number">11.5</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="following-users#top"><span class="number">Chapitre 12</span> Suivi des utilisateurs</a></li>
<li><ol>
<li class="section"><a href="following-users#sec:the_relationship_model"><span class="number">12.1</span> Le modèle Relation (Relationship model)</a></li>
<li><ol>
<li class="subsection"><a href="following-users#sec:a_problem_with_the_data_model"><span class="number">12.1.1</span> Un problème du modèle de données (et sa solution)</a></li>
<li class="subsection"><a href="following-users#sec:relationship_user_associations"><span class="number">12.1.2</span> Associations Utilisateur/Relations</a></li>
<li class="subsection"><a href="following-users#sec:relationship_validations"><span class="number">12.1.3</span> Validations</a></li>
<li class="subsection"><a href="following-users#sec:following"><span class="number">12.1.4</span> Auteurs suivis</a></li>
<li class="subsection"><a href="following-users#sec:followers"><span class="number">12.1.5</span> Lecteurs</a></li></ol></li>
<li class="section"><a href="following-users#sec:a_web_interface_for_following_and_followers"><span class="number">12.2</span> Une interface web pour les auteurs suivis et les lecteurs</a></li>
<li><ol>
<li class="subsection"><a href="following-users#sec:sample_following_data"><span class="number">12.2.1</span> Exemple de donnée de suivi</a></li>
<li class="subsection"><a href="following-users#sec:stats_and_a_follow_form"><span class="number">12.2.2</span> Statistiques et formulaire de suivi</a></li>
<li class="subsection"><a href="following-users#sec:following_and_followers_pages"><span class="number">12.2.3</span> Pages d'auteurs suivis et de lecteurs</a></li>
<li class="subsection"><a href="following-users#sec:a_working_follow_button_the_standard_way"><span class="number">12.2.4</span> Un bouton de suivi fonctionnant de façon standard</a></li>
<li class="subsection"><a href="following-users#sec:a_working_follow_button_with_ajax"><span class="number">12.2.5</span> Un bouton fonctionnant avec Ajax</a></li></ol></li>
<li class="section"><a href="following-users#sec:the_status_feed"><span class="number">12.3</span> L'état de l'alimention</a></li>
<li><ol>
<li class="subsection"><a href="following-users#sec:motivation_and_strategy"><span class="number">12.3.1</span> Motivation et stratégie</a></li>
<li class="subsection"><a href="following-users#sec:a_first_feed_implementation"><span class="number">12.3.2</span> Une première implémentation de peuplement</a></li>
<li class="subsection"><a href="following-users#sec:scopes_subselects_and_a_lambda"><span class="number">12.3.3</span> Portées, sous-requêtes et fonction <em>lambda</em></a></li>
<li class="subsection"><a href="following-users#sec:the_new_status_feed"><span class="number">12.3.4</span> Nouvel état de l'alimentation</a></li></ol></li>
<li class="section"><a href="following-users#sec:following_conclusion"><span class="number">12.4</span> Conclusion</a></li>
<li><ol>
<li class="subsection"><a href="following-users#sec:extensions_to_the_sample_application"><span class="number">12.4.1</span> Extensions de l'application exemple</a></li>
<li><ol>
<li class="subsubsection"><a href="following-users#sec:replies">Réponses</a></li>
<li class="subsubsection"><a href="following-users#sec:messaging">Notification</a></li>
<li class="subsubsection"><a href="following-users#sec:follower_notifications">Notifications aux lecteurs</a></li>
<li class="subsubsection"><a href="following-users#sec:password_reminders">Rappel du mot de passe</a></li>
<li class="subsubsection"><a href="following-users#sec:signup_confirmation">Confirmation d'inscription</a></li>
<li class="subsubsection"><a href="following-users#sec:rss_feed">Alimentation RSS</a></li>
<li class="subsubsection"><a href="following-users#sec:rest_api">REST API</a></li>
<li class="subsubsection"><a href="following-users#sec:search">Recherche</a></li></ol></li>
<li class="subsection"><a href="following-users#sec:guide_to_further_resources"><span class="number">12.4.2</span> Guide vers d'autres ressources</a></li></ol></li>
<li class="section"><a href="following-users#sec:following_Exercices"><span class="number">12.5</span> Exercices</a></li></ol></li></ol></div>

<div id="main_content"></div>

<p> <span class="preamble">
 <span id="foreword">
<strong> Avant-propos</strong> <br />
 </span>
 </span></p>

<p>Ma précédente compagnie (CD Baby) fut une des premières à basculer complètement vers Ruby on Rails, et à rebasculer aussi complètement vers PHP (googlez-moi pour prendre la mesure du drama). Ce livre de Michael Hartl m'est arrivé avec tant de recommandation que je ne pouvais faire autrement que de le lire. C'est ainsi que <em>Ruby on Rails Tutorial</em> m'a fait retourner à Rails à nouveau </p>
<p>Bien qu'ayant parcouru de nombreux livre sur Rails, c'est celui qui m'a fait vraiment &ldquo;posséder&rdquo; Rails. Tout est fait “à la manière de Rails” —&nbsp;une manière qui ne me semblait pas naturelle avant avant d'avoir terminer ce livre. C'est aussi le seul livre sur Rails qui opère un Développement conduit par le test (“test-driven development”) d'un bout à l'autre, une approche hautement recommandée par les experts mais qui n'a jamais été aussi démontrée avant. Enfin, en incluant Git, GitHub et Heroku dans les exemples en démonstration, l'auteur vous donne vraiment le goût de ce que c'est que faire un projet dans la vraie vie. Les exemples de code du tutoriel ne sont pas de reste.</p> 
	
<p>La narration linéaire est vraiment un bon format. Personnellement, j'ai étudié <em>Le Tutoriel Rails</em> en trois longues journées, en faisant tous les exemples et les exercices proposés à la fin de chaque chapitre. Lisez du début à la fin, en ne sautant aucune partie, et vous en tirerez tout le bénéfice.</p>

<p>Régalez-vous&nbsp;!</p>

<p><a href="http://sivers.org/">Derek Sivers</a> (<a href="http://sivers.org/">sivers.org</a>) <br />
<em>Précédemment&nbsp;: Fondateur de </em> <a href="http://www.cdbaby.com/"><em>CD Baby</em></a> <br />
<em>Actuellement&nbsp;: Fondateur de </em> <a href="http://thoughts.pro/"><em>Thoughts Ltd.</em></a> <br /></p>

<p> <span class="preamble">
<strong> Remerciements</strong> <br />
 </span></p>

<p>Ce <em>Tutoriel Ruby on Rails</em> doit beaucoup à mon livre précédent sur Rails, <em>RailsSpace</em>, et donc à mon co-auteur <a href="http://aure.com/">Aurelius Prochazka</a>. J'aimerais remercier Aure à la fois pour le travail qu'il a accompli sur ce précédent livre et pour son soutien pour le présent ouvrage. J'aimerais aussi remercier Debra Williams Cauley, mon éditeur pour les deux ouvrages&nbsp;; aussi longtemps qu'[elle me prendra au baseball][she keeps taking me to baseball games], je continuerai d'écrire des livres pour elle.</p>

<p>J'aimerais remerciement une longue liste de Rubyistes qui m'ont parlé et inspiré au cours des années&nbsp;; David Heinemeier Hansson, Yehuda Katz, Carl Lerche, Jeremy Kemper, Xavier Noria, Ryan Bates, Geoffrey Grosenbach, Peter Cooper, Matt Aimonetti, Gregg Pollack, Wayne&nbsp;E. Seguin, Amy Hoy, Dave Chelimsky, Pat Maddox, Tom Preston-Werner, Chris Wanstrath, Chad Fowler, Josh Susser, Obie Fernandez, Ian McFarland, Steven Bristol, Giles Bowkett, Evan Dorn, Long Nguyen, James Lindenbaum, Adam Wiggins, Tikhon Bernstam, Ron Evans, Wyatt Greene, Miles Forrest, les gens bien de Pivotal Labs, le gang Heroku, les mecs de thoughtbot, et l'équipe de GitHub. Enfin, tellement, tellement, tellement de lecteurs —&nbsp;beaucoup trop pour les citer tous&nbsp;— qui ont contribuer par leur rapport de bogues et leurs suggestions durant l'écriture de ce livre, et je tiens à saluer leur aide pour rendre ce livre aussi bon qu'il pouvait être. <br /></p>

<p> <span class="preamble">
 <span id="author">
<strong> À propos de l'auteur</strong> <br />
 </span>
 </span></p>

<p><a href="http://michaelhartl.com/">Michael Hartl</a> est programmeur, éducateur et entrepreneur. Il est le co-auteur de <em>RailsSpace</em>, un tutoriel Rails [qui s'est bien vendu] publié en 2007, et a été co-fondateur et développeur en chef de <a href="http://insoshi.com/">Insoshi</a>, une plateforme de réseau social <a href="http://github.com/popular/forked">populaire</a> en Ruby on Rails. Précédement, il a enseigné la théorie et [l'application informatique][computational physics] en physique au <a href="http://www.caltech.edu/">California Institute of Technology</a> (Caltech), où il a reçu le Lifetime Achievement Award for Excellence en enseignement. Michael est diplômé du <a href="http://college.harvard.edu/">Harvard College</a>, a un <a href="http://resolver.caltech.edu/CaltechETD:etd-05222003-161626">Ph.D. en physique</a> (NdT. Un doctorat) de <a href="http://www.caltech.edu/">Caltech</a>, et est ancien élève du programme   des entrepreneurs <a href="http://ycombinator.com/">Y&nbsp;Combinator</a>. <br /></p>

<p> <span id="license" class="preamble">
<strong> Copyright et license</strong> <br />
 </span></p>

<p><em>Le Tutoriel Ruby on Rails&nbsp;: apprendre Rails par l'exemple</em>. Copyright &copy; 2010 par Michael Hartl. Tout le code source du <em>Tutoriel Ruby on Rails</em> est disponible sour la license <a href="http://www.opensource.org/licenses/mit-license.php">MIT License</a> et la licence <a href="http://en.wikipedia.org/wiki/Beerware">Beerware License</a>.</p>

<pre class="verbatim">   Copyright (c) 2010 Michael Hartl

   [La permission est accordée ici, à titre gratuit, à toute
   personne obtenant une copie de ce logiciel et sa documentation
   associés (le “Software”), 
   Permission is hereby granted, free of charge, to any person
   obtaining a copy of this software and associated documentation
   files (the &quot;Software&quot;), de traiter dans le Software
   sans restriction, d'inclure sans limitation de droits à utiliser,
   copier, modifier, ajouter, publier, distribuer, sous-licensier,
   et/ou vendre des copies de ce Software, et de permettre au gens
   à qui ce Software est fourni d'en faire de même, assujetti aux
   conditions suivantes&nbsp;:

   La note de copyright ci-dessous et cette notice de permission
   doivent être inclues à toute copie ou portion substantielle
   du logiciel.

   LE LOGICIEL EST FOURNI “TEL QUEL”, SANS AUCUNE GARANTIE D'AUCUNE
   ESPÈCE, ESPRESSE OU IMPLICITE, INCLUANT MAIS NE LIMITANT PAS LES
   GARANTIES MARCHANDES, À PROPOS D'UN BUT PARTICULIER ET ABSENCE
   DE CONTREFAÇON. EN AUCUN CAS LES AUTEURS OU LES DÉTENTEURS DU 
   COPYRIGHT NE POURRONT ÊTRE TENUS RESPONSABLE DE DOMMAGE OU AUTRE
   RESPONSABILITÉ, SI EN UNE ACTION DE CONTRAT, TORT OU AUTREMENT,
   DÉCOULANT DIRECTEMENT OU INDIRECTEMENT DE L'UTILISATION OU DE LA
   MODIFICATION DE CE LOGICIEL.]</pre>




<pre class="verbatim">/*
 * ------------------------------------------------------------
 * &quot;THE BEERWARE LICENSE&quot; (Revision 42):
 * Michael Hartl a écrit ce code. Aussi longtemps que vous
 * conservez cette note, vous pouvez faire ce que vous voulez
 * de ce travail. Si nous nous rencontrons un jour, et que vous
 * pensez que ce travail en vaut la peine, vous pourrez me
 * payer une bière en retour.
 * ------------------------------------------------------------
 */</pre>



<div id="top"></div>


<h1 class="chapter"><a id="sec:6" href="modeling-and-viewing-users-one#top" class="heading"><span class="number">Chapitre 6</span> Modéliser et afficher les utilisateurs, partie I</a></h1>


<p>Au chapitre <a class="ref" href="filling-in-the-layout#top">chapitre&nbsp;5</a>, nous avons terminé avec une page sommaire pour créer de nouveaux utilisateur (<a class="ref" href="filling-in-the-layout#sec:user_signup">section&nbsp;5.3</a>)&nbsp;; tout au long des trois prochains chapitres, nous allons nous attacher à tenir la promesse implicite que contient l'amorce de cette page. La première étape critique est de créer un <em>modèle de données</em> pour les utilisateurs de notre site, ainsi qu'une façon de conserver ces données. Accomplir cette tâche est le but de ce chapitre et du suivant (<a class="ref" href="modeling-and-viewing-users-two#top">chapitre&nbsp;7</a>), et nous allons donner aux utilisateurs la possibilité de s'inscrire au <a class="ref" href="sign-up#top">chapitre&nbsp;8</a>.  Une fois que l'application exemple pourra créer de nouveaux utilisateurs, nous leur offrirons la possibilité de s'identifier (de se connecter) et de se déconnecter (<a class="ref" href="sign-in-sign-out#top">chapitre&nbsp;9</a>), et au <a class="ref" href="updating-showing-and-deleting-users#top">chapitre&nbsp;10</a> (<a class="ref" href="updating-showing-and-deleting-users#sec:protecting_pages">section&nbsp;10.2</a>) nous apprendrons à protéger nos pages contre les accès malveillants.</p>

<p>Pris ensemble, le matériel du <a class="ref" href="modeling-and-viewing-users-one#top">chapitre&nbsp;6</a> au chapitre <a class="ref" href="updating-showing-and-deleting-users#top">chapitre&nbsp;10</a> développe un système Rails complet de login et d'authentification. Comme vous le savez peut-être, il existe une variété de solutions d'authentification clé-en-main dans le monde Rails&nbsp;; Le <a class="ref" href="modeling-and-viewing-users-one#sidebar:roll_your_own">Box&nbsp;6.1</a> explique pourquoi (au moins dans un premier temps) il est bon de composer la vôtre.</p>

<div class="label" id="sidebar:roll_your_own"></div>


<div class="sidebar"><span class="title"><span class="header">Box 6.1.</span><span class="description">Composer votre propre système d'authentification</span></span>
<p>Virtuellement, toutes les applications web, de nos jours, requièrent un système de login et d'authentification. De façon non surprenant, la plupart des framewords web contiennent une pléthore d'options pour implémenter de tels système, et Rails ne fait pas exception. Les exemples de systèmes d'authentification et d'autorisation incluent <a href="http://github.com/thoughtbot/clearance">Clearance</a>, <a href="http://github.com/binarylogic/authlogic">Authlogic</a>, <a href="http://github.com/plataformatec/devise">Devise</a> ou <a href="http://railscasts.com/episodes/192-authorization-with-cancan">CanCan</a> (tout comme les solutions non spécifiquement Rails construites au sommet de <a href="http://en.wikipedia.org/wiki/OpenID">OpenID</a> ou <a href="http://en.wikipedia.org/wiki/Oauth">OAuth</a>). Il est raisonnable de se demander pourquoi nous devrions réinventer la roue. Pourquoi ne pas tout simplement utiliser une solution clé-en-main plutôt qu'en composer une nous-même&nbsp;?</p>

<p>Il y a plusieurs raisons à ça. D'abord, il n'existe pas de réponse standard authentifications Rails&nbsp;; lier ce tutoriel à une solution spécifique laisserait grand ouvert le risque que notre choix particulier devienne dépassé et hors de mode. Plus encore, même si nous tombons juste, le code de base du projet utilisé devrait continuer à évoluer, rendant toute explication rapidement obsolète dans le tutoriel. Enfin, introduire toute la machinerie d'authentification d'un seul coup serait un désastre pédagogique &mdash;&nbsp;pour prendre un seul exemple, Clearance contient plus de 1000 ligne de code et crée un modèle de donnée compliqué dès le départ. Les systèmes d'authentification sont des challenges de programmation riches&nbsp;; composer notre propre solution signifie que nous pouvons considérer chaque petite partie à la fois, nous conduisant à une bien plus profonde compréhension aussi bien de l'authentification que de Rails.</p>

<p>Je vous encourage à étudier du <a class="ref" href="modeling-and-viewing-users-one#top">chapitre&nbsp;6</a> au <a class="ref" href="updating-showing-and-deleting-users#top">chapitre&nbsp;10</a> pour vous donner une bonne fondation pour vos projets futurs. En temps venu, si vous décidez d'utiliser un système d'authentification clé-en-main pour votre application, vous serez en mesure d'une part de le comprendre et d'autre part de l'adapter à vos besoins spécifiques.</p>
</div>


<p>En parallèle de notre modélisation des données, nous développerons une page web pour <em>afficher</em> les utilisateurs, ce qui nous servira de première étape vers l'implémentation de l'architecture REST pour les utilisateurs (discutée brièvement à la <a class="ref" href="a-demo-app#sec:mvc_in_action">section&nbsp;2.2.2</a>). Mais nous n'irons pas profondément dans ce chapitre, notre but final pour les pages de profil d'utilisateur étant de montrer l'avatar (le <em>gravatar</em>) de l'utilisateur, ses données basiques et une liste de micro-messages, comme le montre la maquette de l'<a class="ref" href="modeling-and-viewing-users-one#fig:profile_mockup">illustration&nbsp;6.1</a>.<sup class="footnote" id="fnref:6.1"><a href="#fn:6.1">1</a></sup> (<a class="ref" href="modeling-and-viewing-users-one#fig:profile_mockup">illustration&nbsp;6.1</a> contient notre premier exemple de texte <em>lorem ipsum</em>, texte qui connait une <a href="http://www.straightdope.com/columns/read/2290/what-does-the-filler-text-lorem-ipsum-mean">histoire fascinante</a> que vous devriez lire un jour). Dans ce chapitre, nous coucherons les fondations essentielles de notre page d'affichage de l'utilisateur, et nous la commencerons dans le détail au <a class="ref" href="modeling-and-viewing-users-two#top">chapitre&nbsp;7</a>.</p>

<div class="label" id="fig:profile_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/profile_mockup.png" alt="profile_mockup" /></span></div><div class="caption"><span class="header">Illustration 6.1: </span><span class="description">Une maquette de notre meilleure estimation de la page d'affichage de l'utilisateur.&nbsp;<a href="http://railstutorial.org/images/figures/profile_mockup-full.png">(taille normale)</a></span></div></div>


<p>Comme d'habitude, si vous utilisez le contrôle de version Git, il est temps de faire une nouvelle branche pour la modélisation des utilisateurs&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout master
<span class="gp">$</span> git checkout -b modeling-users
</pre></div>
</div>


<p>(La première ligne ici sert uniquement à s'assure que vous partiez bien de la branche maitresse, pour que le sujet <tt>modeling-users</tt> soit bien basé sur la branche <tt>master</tt>. Vous pouvez sauter cette commande si vous vous trouvez déjà sur la branche maitressse.)</p>

<div class="label" id="sec:user_model"></div>


<h2><a id="sec:6.1" href="modeling-and-viewing-users-one#sec:user_model" class="heading"><span class="number">6.1</span> Modèle User (<em>utilisateur</em>)</a></h2>


<p>Bien que le but ultime des trois prochains chapitres soit de créer une page d'inscription au site, il peut être bien de pouvoir accepter les informations d'inscription dès à présent, [(it would do little good to accept signup information now)(il ne serait pas très judicieux d'accepter les informations d'inscription tout de suite)], puisque nous n'avons pour le moment aucun endroit où les déposer. Ainsi, la première étape dans l'inscription des utilisateurs va être de faire une structure de données pour capturer et consigner leurs informations. En Rails, la structure de données par défaut pour un modèle de données est appelée, assez naturellement, un <em>modèle</em> (<em>model</em>) (c'est le «&nbsp;M&nbsp;» de «&nbsp;MVC&nbsp;» de la <a class="ref" href="beginning#sec:mvc">section&nbsp;1.2.6</a>). La solution par défaut de Rails au problème de la persistence consiste à utiliser une <em>base de données</em> pour la consignation à long terme des données, et la librairie par défaut pour interagir avec cette base de données est appelée <em>Active Record</em>.<sup class="footnote" id="fnref:6.2"><a href="#fn:6.2">2</a></sup></p>

<p>Active Record vient avec une foule de méthodes pour créer, sauver et chercher des objets-données, toutes sans avoir à utiliser le langage structure de requête (SQL)<sup class="footnote" id="fnref:6.3"><a href="#fn:6.3">3</a></sup> utilisé par les <a href="http://en.wikipedia.org/wiki/Relational_database">base de données relationnelles</a>. Plus encore, Rails possède une fonctionnalité appelée <em>migrations</em> pour permettre les définitions des données d'être écrites en pur Ruby, sans avoir à apprendre le langage de définition des données SQL (DDL).<sup class="footnote" id="fnref:6.4"><a href="#fn:6.4">4</a></sup> L'effet est que Rails vous épargent tout ce qui concerne les détails de la consignation des données. Dans ce livre, en utilisant SQLite pour le développement et Heroku pour le déploiement (<a class="ref" href="beginning#sec:deploying">section&nbsp;1.4</a>), nous avons poussé ce sujet encore plus loin, jusqu'au point où nous n'avons plus du tout à nous pré-occuper de comment Rails consigne les données, même pour les applications en mode production.<sup class="footnote" id="fnref:6.5"><a href="#fn:6.5">5</a></sup></p>

<div class="label" id="sec:database_migrations"></div>


<h3><a id="sec:6.1.1" href="modeling-and-viewing-users-one#sec:database_migrations" class="heading"><span class="number">6.1.1</span> Migrations de la base de données</a></h3>


<p>Vous vous souvenez peut-être, de la <a class="ref" href="rails-flavored-ruby#sec:a_user_class">section&nbsp;4.4.5</a>, que nous avons déjà rencontré, via la construction personnalisée d'une classe <code>User</code> (<em>Utilisateur</em>), des objets utilisateur avec les attributs <code>nom</code> et <code>email</code>. Cette classe a servi d'exemple utile, mais elle manquait de la propriété critique de <em>persistence</em>&nbsp;: quand nous avions créé un objet utilisateur à la console Rails, il disparaissait aussitôt que nous quittions cette console. Notre but dans cette section sera de créer un modèle pour les utilisateurs qui ne disparaisse pas aussi facilement.</p>

<p>Comme avec la classe User à la <a class="ref" href="rails-flavored-ruby#sec:a_user_class">section&nbsp;4.4.5</a>, nous allons commencer par modéliser l'utilisateur avec deux attributs,  <code>nom</code> et <code>email</code>, dont le dernier sera utilisé comme <em>username</em> unique.<sup class="footnote" id="fnref:6.6"><a href="#fn:6.6">6</a></sup> (nous ajouterons un attribut «&nbsp;mot de passe&nbsp;» à la <a class="ref" href="modeling-and-viewing-users-two#sec:insecure_passwords">section&nbsp;7.1</a>). Dans l'<a class="ref" href="rails-flavored-ruby#code:example_user">extrait&nbsp;4.8</a>, nous avons réalisé cela avec la méthode Ruby <code>attr_accessor</code>&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span>
  <span class="kp">attr_accessor</span> <span class="ss">:nom</span><span class="p">,</span> <span class="ss">:email</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div>


<p>En constraste, en utilisant Rails pour modéliser les utilisateurs nous n'avons pas besoin d'identifier explicitement les attributs. Comme noté brièvement plus haut, pour consigner les données, Rails utilise la base de données relationnelle par défaut, qui consiste en des <em>tables</em> composées de <em>rangées</em> de données, où chaque <em>rangée</em> possède des <em>colonnes</em> pour chaque attribut de la donnée. Par exemple, pour consigner des utilisateurs avec des noms et des emails, nous créerons une table <code>users</code> (<em>utilisateurs</em>) avec les colonnes <code>nom</code> et <code>email</code> dont chaque <em>rangée</em> correspondra à un utilisateur particulier. En nommant les colonnes de cette façon, nous laissons Active Record deviner les attributs de l'objet utilisateur par lui-même.</p>



<p>Voyons comment il fonctionne (si cette discussion vous semble trop abstraite, soyez patient&nbsp;; les exemples en ligne de commande commençant à la <a class="ref" href="modeling-and-viewing-users-one#sec:creating_user_objects">section&nbsp;6.1.3</a> et les copies d'écran du navigateur de base de données de l'<a class="ref" href="modeling-and-viewing-users-one#fig:sqlite_database_browser">illustration&nbsp;6.3</a> et de l'<a class="ref" href="modeling-and-viewing-users-one#fig:sqlite_user_row">illustration&nbsp;6.8</a> devraient rendre les choses plus claires). À la <a class="ref" href="filling-in-the-layout#sec:users_controller">section&nbsp;5.3.1</a>, vous vous souvenez (<a class="ref" href="filling-in-the-layout#code:generate_users_controller">extrait&nbsp;5.23</a>) que nous avons créé un contrôleur pour les utilisateurs (avec une action <code>new</code>) en utilisant la commande&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate controller Users new
</pre></div>
</div>


<p>Il existe une commande analogue pour faire un modèle&nbsp;: <code>generate model</code>&nbsp;; l<a class="ref" href="modeling-and-viewing-users-one#code:generate_user_model">extrait&nbsp;6.1</a> montre la commande pour générer un modèle <code>User</code> (<em>Utilisateur</em>) avec deux attributs, <code>nom</code> et <code>email</code>.</p>

<div class="label" id="code:generate_user_model"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 6.1.</span> <span class="description">Générer un modèle User.</span> </div>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate model User nom:string email:string
<span class="go">      invoke  active_record</span>
<span class="go">      create    db/migrate/&lt;timestamp&gt;_create_users.rb</span>
<span class="go">      create    app/models/user.rb</span>
<span class="go">      invoke    rspec</span>
<span class="go">      create      spec/models/user_spec.rb</span>
</pre></div>
</div></div>


<p>(Notez que, contrairement à la convention du <em>pluriel</em> pour les noms de contrôleur, les noms des modèles sont <em>singulier</em>&nbsp;: un contrôleur <em>Users</em> mais un modèle <em>User</em>.) En passant les paramètres optionnels <code>nom:string</code> et <code>email:string</code>, nous précisons à Rails les deux attributs que nous voulons, en précisant le type de ces attributs (dans ce cas, le type <em>string</em>, c'est-à-dire <em>chaine de caractère</em>). Compareez cela avec l'inclusion des noms d'acions dans l'<a class="ref" href="static-pages#code:generating_pages">extrait&nbsp;3.4</a> et l<a class="ref" href="filling-in-the-layout#code:generate_users_controller">extrait&nbsp;5.23</a>.</p>

<p>L'un des résultats de la commande <code>generate</code> de l'<a class="ref" href="modeling-and-viewing-users-one#code:generate_user_model">extrait&nbsp;6.1</a> est un nouveau fichier appelé une <em>migration</em>.  Les <em>migrations</em> fournissent un moyen d'altérer la structure de la base de données de façon incrémentielle, de telle sorte que notre modèle de données peut adapter les changements requis. Dans le cas du modèle User, la migration est créée automatiquement par le script de génération de modèle&nbsp;; il crée une table <code>users</code> (<em>utilisateurs</em>) avec deux colonnes, <code>nom</code> et <code>email</code>, comme le montre l'<a class="ref" href="modeling-and-viewing-users-one#code:users_migration">extrait&nbsp;6.2</a> (nous verrons à la <a class="ref" href="modeling-and-viewing-users-one#sec:uniqueness_validation">section&nbsp;6.2.4</a> comment faire une migration à partir de rien).</p>

<div class="label" id="code:users_migration"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 6.2.</span> <span class="description">Migration pour le modèle User (pour créer une table  <code>users</code>). <br /> <code>db/migrate/&lt;timestamp&gt;_create_users.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">CreateUsers</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">up</span>
    <span class="n">create_table</span> <span class="ss">:users</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="o">.</span><span class="n">string</span> <span class="ss">:nom</span>
      <span class="n">t</span><span class="o">.</span><span class="n">string</span> <span class="ss">:email</span>

      <span class="n">t</span><span class="o">.</span><span class="n">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">down</span>
    <span class="n">drop_table</span> <span class="ss">:users</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Notez que le nom de la migration est préfixé par un temps (<em>timestamp</em>) basé sur le temps de création de la migration. Dans les tout premiers jours des migrations, les noms de fichier étaient préfixés par un entier incrémenté, ce qui provoquait des conflits dans une équipe de collaborateurs quand les différents programmeur se retrouvaient avec des numéros identiques. Sauf très improbable concordance de création à la milliseconde près, utiliser les <em>timestamps</em> évite efficacement de telles collisions.</p>

<p>Concentrons-nous sur la méthode <code>self.up</code>, qui utilise une méthode Rails appelée <code>create_table</code> (<em>créer_table</em>) pour créer une <em>table</em> dans la base de données pour consigner les utilisateurs (l'utilisation de <code>self</code> —&nbsp;<em>soi-même</em>&nbsp;—&nbsp;dans <code>self.up</code> l'identifie comme une <em>méthode de classe</em>. Ça n'a pas d'importance pour le présent, mais nous étudierons les méthodes de classe quand nous en inventerons à la <a class="ref" href="modeling-and-viewing-users-two#sec:an_authenticate_method">section&nbsp;7.2.4</a>). La méthode <code>create_table</code> accepte un bloc (<a class="ref" href="rails-flavored-ruby#sec:blocks">section&nbsp;4.3.2</a>) avec un variable de bloc, dans ce cas appelée <code>t</code> («&nbsp;t&nbsp;» pour «&nbsp;table&nbsp;»). À l'intérieur du bloc, la méthode <code>create_table</code> utilise l'objet&nbsp;<code>t</code> pour créer les colonnes <code>nom</code> et <code>email</code> dans la base de données, tous deux de type <code>string</code>.<sup class="footnote" id="fnref:6.7"><a href="#fn:6.7">7</a></sup> Ici le nom de la table est pluriel (<code>users</code>) même si le nom du modèle, lui, est singulier, ce qui reflète la convention linguistique suivie par Rails&nbsp;: un modèle représente un <em>simple</em> utilisateur, tandis que la table de la base de données consiste en plusieurs utilisateurs. La dernière ligne du bloc, <code>t.timestamps</code>, est une commande spéciale qui crée deux colonnes <em>magiques</em> appelées <code>created_at</code> (<em>créé_le</em> ) et <code>updated_at</code> (<em>actualisé_le</em> ), qui sont des signatures de temps qui enregistrenet automatiquement quand un utilisateur donné est créé ou modifié (nous verrons des exemples concrets de ces colonnes magiques en abordant la <a class="ref" href="modeling-and-viewing-users-one#sec:creating_user_objects">section&nbsp;6.1.3</a>). Le modèle de données complet représenté par sa migration est affiché dans l'<a class="ref" href="modeling-and-viewing-users-one#fig:user_model_initial">illustration&nbsp;6.2</a>.</p>

<div class="label" id="fig:user_model_initial"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_model_initial.png" alt="user_model_initial" /></span></div><div class="caption"><span class="header">Illustration 6.2: </span><span class="description">Le modèle de données des utilisateurs produit par l'<a class="ref" href="modeling-and-viewing-users-one#code:users_migration">extrait&nbsp;6.2</a>.</span></div></div>


<p>Nous pouvons lancer la migration, opération connue sous le nom anglais «&nbsp;migration up&nbsp;» en utilisant la commande <code>rake</code> (<a class="ref" href="a-demo-app#sidebar:rake">Box&nbsp;2.1</a>) comme suit&nbsp;:<sup class="footnote" id="fnref:6.8"><a href="#fn:6.8">8</a></sup></p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rake db:migrate
</pre></div>
</div>


<p>(Vous pouvez vous souvenir que nous avons déjà eu à jouer cette commande, à la <a class="ref" href="beginning#sec:rails_server">section&nbsp;1.2.5</a> ou encore au <a class="ref" href="a-demo-app#top">chapitre&nbsp;2</a>.) La première fois que <code>db:migrate</code> est lancé, un fichier <code>db/development.sqlite3</code> est créé, qui est une base de données <a href="http://sqlite.org/">SQLite</a><sup class="footnote" id="fnref:6.9"><a href="#fn:6.9">9</a></sup>. Nous pouvons voir la structure de la base de données en utilisant l'exemple <a href="http://sqlitebrowser.sourceforge.net/">Navigateur de données SQLite</a> pour ouvrir le fichier <code>db/development.sqlite3</code> (<a class="ref" href="modeling-and-viewing-users-one#fig:sqlite_database_browser">illustration&nbsp;6.3</a>)&nbsp;; comparez-le avec le diagramme de l'<a class="ref" href="modeling-and-viewing-users-one#fig:user_model_initial">illustration&nbsp;6.2</a>. Vous pouvez noter qu'il y a une colonne dans l'<a class="ref" href="modeling-and-viewing-users-one#fig:sqlite_database_browser">illustration&nbsp;6.3</a> qui n'a pas été prise en compte par la migration&nbsp;: la colonne <code>id</code> (<em>identifiant</em>). Comme indiqué brièvement à la <a class="ref" href="a-demo-app#sec:demo_users_resource">section&nbsp;2.2</a>, cette colonne est créée automatiquement, et est utilisée par Rails pour identifier de façon unique une rangée.</p>

<div class="label" id="fig:sqlite_database_browser"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/sqlite_database_browser.png" alt="sqlite_database_browser" /></span></div><div class="caption"><span class="header">Illustration 6.3: </span><span class="description">The  <a href="http://sqlitebrowser.sourceforge.net/">Navigateur de base de données SQLite</a> avec notre nouvelle table <code>users</code>.&nbsp;<a href="http://railstutorial.org/images/figures/sqlite_database_browser-full.png">(taille normale)</a></span></div></div>


<p>Vous avez probablement deviné que lancer <code>db:migrate</code> exécute la commande <code>self.up</code> dans le fichier migration. Qu'en est-il, donc, du code <code>self.down</code> (<em>soi-même.en-bas</em> )&nbsp;? Comme vous pouvez le deviner, <code>down</code> migre vers le <em>base</em>, inversant les effets de la migration. Dans notre cas, cela signifie <em>retirer</em>  la table <code>users</code> de la base de données&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">CreateUsers</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">down</span>
    <span class="n">drop_table</span> <span class="ss">:users</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>


<p>Vous pouvez exécuter <code>down</code> avec <code>rake</code> en utilisant l'argument <code>db:rollback</code>&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rake db:rollback
</pre></div>
</div>


<p>C'est souvent utile quand vous réalisez qu'il y a une autre colonne que vous voulez ajouter mais que vous ne voulez pas vous embêter à faire une nouvelle migration&nbsp;: vous pouvez revenir en arrière, ajouter la colonne souhaitée, et reprocéder alors à la migration (ce n'est pas toujours pratique, et nous apprendrons comment ajouter une colonne à une table existante à la <a class="ref" href="modeling-and-viewing-users-two#sec:password_migration">section&nbsp;7.1.2</a>).</p>

<p>Si vous êtes revenu en arrière pour la base de données, procédez à nouveau à sa migration&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rake db:migrate
</pre></div>
</div>




<div class="label" id="sec:the_model_file"></div>


<h3><a id="sec:6.1.2" href="modeling-and-viewing-users-one#sec:the_model_file" class="heading"><span class="number">6.1.2</span> Le fichier modèle</a></h3>


<p>Nous avons vu comment la génération du modèle User de l'<a class="ref" href="modeling-and-viewing-users-one#code:generate_user_model">extrait&nbsp;6.1</a> générait un fichier de migration (<a class="ref" href="modeling-and-viewing-users-one#code:users_migration">extrait&nbsp;6.2</a>), et nous avons vu dans l'<a class="ref" href="modeling-and-viewing-users-one#fig:sqlite_database_browser">illustration&nbsp;6.3</a> les résultats de lancer la migration&nbsp;: cela actualise un fichier appelé <code>development.sqlite3</code> en créant une table <code>users</code> avec les colonnes <code>id</code>, <code>nom</code>, <code>email</code>, <code>created_at</code>, et <code>updated_at</code>. L<a class="ref" href="modeling-and-viewing-users-one#code:generate_user_model">extrait&nbsp;6.1</a> a créé aussi le modèle lui-même&nbsp;; la suite de cette section est dédié à le comprendre.</p>

<p>Nous commençons par regarder le code du modèle User, qui se trouve dans le fichier <code>user.rb</code> à l'intérieur du dossier <code>app/models/</code>&nbsp;; il est, pour ne pas dire, très compact (<a class="ref" href="modeling-and-viewing-users-one#code:raw_user_model">extrait&nbsp;6.3</a>).</p>

<div class="label" id="code:raw_user_model"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 6.3.</span> <span class="description">Le tout nouveau modèle User. <br /> <code>app/models/user.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Si vous vous souvenez de la <a class="ref" href="rails-flavored-ruby#sec:a_class_of_our_own">section&nbsp;4.4.2</a>, la syntaxe <code>class User &lt; ActiveRecord::Base</code> signifie que la classe <code>User</code> <em>hérite</em> de <code>ActiveRecord::Base</code>, de telle sorte que le modèle User possède automatiquement les fonctionnalités de la classe <code>ActiveRecord::Base</code>. Bien entendu, la connaissance de cet héritage ne fait rien de bien tant que nous ne savons pas ce que <code>ActiveRecord::Base</code> contient, et nous allons en avoir un avant-goût dans un moment. Mais avant de continuer, il y a deux tâches à accomplir.</p>

<div class="label" id="sec:model_annotation"></div>


<h4><a id="sec:6.1.2.1" href="modeling-and-viewing-users-one#sec:model_annotation" class="heading">Annotation du modèle</a></h4>


<p>Bien que cela ne soit pas strictement nécessaire, vous pourriez trouver utile d'<em>annoter</em> vos modèles Rails en utilisant le gem <tt>annotate-models</tt> (<a class="ref" href="modeling-and-viewing-users-one#code:gemfile_annotate">extrait&nbsp;6.4</a>).</p>

<div class="label" id="code:gemfile_annotate"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 6.4.</span> <span class="description">Ajout du gem <tt>annotate-models</tt> au fichier <code>Gemfile</code>.</span>       
</div>
<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">&#39;http://rubygems.org&#39;</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="n">group</span> <span class="ss">:development</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;rspec-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;2.5.0&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;annotate-models&#39;</span><span class="p">,</span> <span class="s1">&#39;1.0.4&#39;</span>
<span class="k">end</span>

<span class="n">group</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>(Nous plaçons le gem <tt>annotate-models</tt> gem dans le bloc <code>group :development</code> (comme pour <code>group :test</code>) parce que les annotations ne sont pas nécessaire dans les applications en mode production.) Nous l'installons ensuite avec <code>bundle</code>&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle install
</pre></div>
</div>


<p>Cela nous ajoute une commande appelée <code>annotate</code>, qui ajoute simplement des commentaires contenant le modèle de données dans le fichier du modèle&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> annotate
<span class="go">Annotated User</span>
</pre></div>
</div>


<p>Le résultat apparait dans l'<a class="ref" href="modeling-and-viewing-users-one#code:annotated_user_model">extrait&nbsp;6.5</a>.</p>

<div class="label" id="code:annotated_user_model"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 6.5.</span> <span class="description">Le modèle User annoté. <br /> <code>app/models/user.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="c1"># == Schema Information</span>
<span class="c1"># Schema version: &lt;timestamp&gt;</span>
<span class="c1">#</span>
<span class="c1"># Table nom: users</span>
<span class="c1">#</span>
<span class="c1">#  id         :integer         not null, primary key</span>
<span class="c1">#  nom       :string(255)</span>
<span class="c1">#  email      :string(255)</span>
<span class="c1">#  created_at :datetime</span>
<span class="c1">#  updated_at :datetime</span>
<span class="c1">#</span>

<span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Je trouve qu'avoir un modèle de données visible dans les fichiers de modèle aide à se souvenir des attributs que le modèle possède, mais les extraits de code présentés ici omettrons souvent cette information, pour la brièveté.</p>

<div class="label" id="sec:accessible_attributes"></div>


<h4><a id="sec:6.1.2.2" href="modeling-and-viewing-users-one#sec:accessible_attributes" class="heading">Attributs accessibles.</a></h4>


<p>Une autre étpae qui n'est pas strictement nécessaire, mais qui est une vraiment bonne idée, est de dire à Rails quels attributs du modèle sont accessibles, c'est-à-dire quels attributs peuvent être modifiés par des utilisateurs extérieurs (tels que les utilisateurs soumettant des requêtes à l'aide de leur navigateur internet). Nous faisons cela avec la méthode <code>attr_accessible</code> (<a class="ref" href="modeling-and-viewing-users-one#code:attr_accessible">extrait&nbsp;6.6</a>). Nous verrons au <a class="ref" href="updating-showing-and-deleting-users#top">chapitre&nbsp;10</a> qu'utiliser <code>attr_accessible</code> est important pour prévenir le <em>mass assignment</em> (<em>assignement en masse</em>), un trou de sécurité désepérément courant et souvent sérieux dans beaucoup d'applications Rails.</p>

<div class="label" id="code:attr_accessible"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 6.6.</span> <span class="description">Rendre les attributs <code>nom</code> et <code>email</code> accessibles. <br /> <code>app/models/user.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:nom</span><span class="p">,</span> <span class="ss">:email</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="sec:creating_user_objects"></div>


<h3><a id="sec:6.1.3" href="modeling-and-viewing-users-one#sec:creating_user_objects" class="heading"><span class="number">6.1.3</span> Créer des objets utilisateur</a></h3>


<p>Nous avons accompli un beau boulot préparatoire, et il est temps à présent d'en tirer profit et d'en apprendre plus sur <em>Active Record</em> en jouant avec notre nouveau modèle User créé. Comme au <a class="ref" href="rails-flavored-ruby#top">chapitre&nbsp;4</a>, notre outil de choix est la console Rails. Puisque nous ne voulons pas (encore) faire des changements dans notre base de données, nous allons démarrer la console dans un <em>bac à sable</em> (<em>sandbox</em>)&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console --sandbox</span>
<span class="go">Loading development environment in sandbox (Rails 3.0.7)</span>
<span class="go">Any modifications you make will be rolled back on exit</span>
<span class="gp">&gt;&gt; </span>
</pre></div>
</div>


<p>Comme l'indique le message &ldquo;&nbsp;Any modifications you make will be rolled back on exit&nbsp;&rdquo; (<em>Toute modification que vous ferez sera effacée en quittant le bac à sable</em>. NdT ), en commençant dans un bac à sable, la console annulera tous les changements opérés sur la base de données à la fin de la session d'utilisation du bac à sable.</p>

<p>En travaillant à la console, il est utile de garder un œil sur le <em>journal de développement</em> (<em>development log</em>), qui enregistre les états de bas niveau de SQL renvoyés par Active Record, comme montrés à <a class="ref" href="modeling-and-viewing-users-one#fig:development_log">illustration&nbsp;6.4</a>. La façon d'obtenir cette sortie par une commande en ligne Unix est de <code>tail</code>er le journal&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> tail -f log/development.log
</pre></div>
</div>


<p>Le drapeau <code>-f</code> assure que <code>tail</code> affichera les lines additionnelles comme elles sont écrites. Je recommande de garder une fenêtre de Terminal ouverte pour suivre le journal en travaillant à la console.</p>

<div class="label" id="fig:development_log"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/development_log.png" alt="development_log" /></span></div><div class="caption"><span class="header">Illustration 6.4: </span><span class="description">Suivre le journal de développement.&nbsp;<a href="http://railstutorial.org/images/figures/development_log-full.png">(taille normale)</a></span></div></div>


<p>Dans la session de console de la <a class="ref" href="rails-flavored-ruby#sec:a_user_class">section&nbsp;4.4.5</a>, nous avons créé un nouvel objet utilisateur avec <code>User.new</code>, auquel nous n'avions accès qu'après avoir appelé le fichier de l'utilisateur exemple de l'<a class="ref" href="rails-flavored-ruby#code:example_user">extrait&nbsp;4.8</a>. Avec les modèles, la situation est différentes&nbsp;; comme vous pouvez vous en souvenir de la <a class="ref" href="rails-flavored-ruby#sec:a_controller_class">section&nbsp;4.4.4</a>, la console Rails charge automatiquement l'environnement Rails, ce qui inclut les modèles. Cela signifie que nous pouvons créer un nouvel objet utilisateur sans travail supplémentaire&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">new</span>
<span class="go">=&gt; #&lt;User id: nil, nom: nil, email: nil, created_at: nil, updated_at: nil&gt;</span>
</pre></div>
</div>


<p>Nous voyons ici la représentation par défaut d'un objet utilisateur, qui affiche les mêmes attributs que dans l'<a class="ref" href="modeling-and-viewing-users-one#fig:sqlite_database_browser">illustration&nbsp;6.3</a> et l'<a class="ref" href="modeling-and-viewing-users-one#code:annotated_user_model">extrait&nbsp;6.5</a>.</p>

<p>Appelé sans arguments, <code>User.new</code> retourne un objet dont tous les attributs en la valeur nulle (<code>nil</code>). À la <a class="ref" href="rails-flavored-ruby#sec:a_user_class">section&nbsp;4.4.5</a>, nous nous sommes arrangés avec l'exemple de la classe User pour qu'elle utilise une <em>table d'initialisation</em> pour définir les attributs de l'objet&nbsp;; ce choix était motivé par Active Record, qui permet aux objets d'être initialisés de cette façon&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:nom</span> <span class="o">=&gt;</span> <span class="s2">&quot;Michael Hartl&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;mhartl@example.com&quot;</span><span class="p">)</span>
<span class="go">=&gt; #&lt;User id: nil, nom: &quot;Michael Hartl&quot;, email: &quot;mhartl@example.com&quot;,</span>
<span class="go">created_at: nil, updated_at: nil&gt;</span>
</pre></div>
</div>


<p>Ici nous voyons que les attributs <code>nom</code> et <code>email</code> ont été définis comme voulu.</p>

<p>Si vous suivez le journal de développement, vous avez peut-être noté qu'aucune nouvelle ligne n'a été affichée. Ceci parce qu'appeler <code>User.new</code> n'affecte pas la base de données&nbsp;; ça crée simplement un nouvelle objet Ruby en mémoire. Pour savuer l'objet utilisateur dans la base de données, nous appelons la méthode <code>save</code> de la variable d'instance <code>user</code>&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">save</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p>La méthode <code>save</code> retourne <code>true</code> (<em>vrai</em>) si elle réussit et <code>false</code> (<em>faux</em>) dans le cas contraire (actuellement, toutes les sauvegardes doivent réussir&nbsp;; nous verrons des cas à la <a class="ref" href="modeling-and-viewing-users-one#sec:user_validations">section&nbsp;6.2</a> où certains échouent). Dès que vous sauvez, vous devez voir une ligne du journal de développeent avec une commande SQL pour <code>INSERT INTO "users"</code> (<em>INSÉRER DANS "users"</em>). Grâce aux nombreuses méthodes fournies par Active Record, nous n'aurons jamais besoin de requête SQL dans ce livre, et j'omettrai donc de commenter les commandes SQL. Mais vous pouvez apprendre beaucoup en surveillant le journal de développement.</p>

<p>Vous avez peut-être noté que le nouvel objet utilisateur possédait les valeurs <code>nil</code> pour les attributs <code>id</code> et les colonnes magiques <code>created_at</code> et <code>updated_at</code>. Voyons si notre  <code>save</code> y a changé quelque chose&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span>
<span class="go">=&gt; #&lt;User id: 1, nom: &quot;Michael Hartl&quot;, email: &quot;mhartl@example.com&quot;,</span>
<span class="go">created_at: &quot;2010-01-05 00:57:46&quot;, updated_at: &quot;2010-01-05 00:57:46&quot;&gt;</span>
</pre></div>
</div>


<p>Nous voyons qu'à l'attribut <code>id</code> a été assigné la valeur&nbsp;<code>1</code>, et que les colonnes magiques se sont vues assignées le temps et la date courants.<sup class="footnote" id="fnref:6.10"><a href="#fn:6.10">10</a></sup> Pour le moment, les timestamps de création et de modification sont identiques&nbsp;; nous verrons qu'ils différeront à la <a class="ref" href="modeling-and-viewing-users-one#sec:updating_user_objects">section&nbsp;6.1.5</a>.</p>

<p>Comme avec la classe User de la <a class="ref" href="rails-flavored-ruby#sec:a_user_class">section&nbsp;4.4.5</a>, les instances du modèle User permettent un accès à leurs attributs en utilisant la notation par point&nbsp;:<sup class="footnote" id="fnref:6.11"><a href="#fn:6.11">11</a></sup></p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">nom</span>
<span class="go">=&gt; &quot;Michael Hartl&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">email</span>
<span class="go">=&gt; &quot;mhartl@example.com&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">updated_at</span>
<span class="go">=&gt; Tue, 05 Jan 2010 00:57:46 UTC +00:00</span>
</pre></div>
</div>


<p>Comme nous le verrons au <a class="ref" href="sign-up#top">chapitre&nbsp;8</a>, il est souvent pratique de créer et de sauver un modèle en deux étapes comme nous l'avons fait ci-dessus, mais Active Record nous laisse aussi les combiner en une seule étape avec <code>User.create</code> (<code>Utilisateur.créer</code>)&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:nom</span> <span class="o">=&gt;</span> <span class="s2">&quot;A Nother&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;another@example.org&quot;</span><span class="p">)</span>
<span class="go">=&gt; #&lt;User id: 2, nom: &quot;A Nother&quot;, email: &quot;another@example.org&quot;, created_at:</span>
<span class="go">&quot;2010-01-05 01:05:24&quot;, updated_at: &quot;2010-01-05 01:05:24&quot;&gt;</span>
<span class="gp">&gt;&gt; </span><span class="n">foo</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:nom</span> <span class="o">=&gt;</span> <span class="s2">&quot;Foo&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;foo@bar.com&quot;</span><span class="p">)</span>
<span class="go">=&gt; #&lt;User id: 3, nom: &quot;Foo&quot;, email: &quot;foo@bar.com&quot;, created_at: &quot;2010-01-05</span>
<span class="go">01:05:42&quot;, updated_at: &quot;2010-01-05 01:05:42&quot;&gt;</span>
</pre></div>
</div>


<p>Notez que <code>User.create</code>, plutôt que de retourner <code>true</code> ou <code>false</code>, retourne l'objet User lui-même, que nous pouvons optionnellement assigner à une variable (comme la variable <code>foo</code> dans le seconde commande ci-dessus).</p>

<p>L'inverse de la méthode <code>create</code> (<em>créer</em>) est la méthode <code>destroy</code> (<em>détruire</em>)&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">foo</span><span class="o">.</span><span class="n">destroy</span>
<span class="go">=&gt; #&lt;User id: 3, nom: &quot;Foo&quot;, email: &quot;foo@bar.com&quot;, created_at: &quot;2010-01-05</span>
<span class="go">01:05:42&quot;, updated_at: &quot;2010-01-05 01:05:42&quot;&gt;</span>
</pre></div>
</div>


<p>Bizarrement, <code>destroy</code>, comme <code>create</code>, retourne l'objet en question, bien que je ne puisse me souvenir d'avoir jamais utiliser le retour d'une méthode <code>destroy</code>. Encore plus bizarrement peut-être, l'objet pourtant détruit par <code>destroy</code> existe toujours en mémoire&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">foo</span>
<span class="go">=&gt; #&lt;User id: 3, nom: &quot;Foo&quot;, email: &quot;foo@bar.com&quot;, created_at: &quot;2010-01-05</span>
<span class="go">01:05:42&quot;, updated_at: &quot;2010-01-05 01:05:42&quot;&gt;</span>
</pre></div>
</div>


<p>Comment pouvons-nous être sûrs, alors, d'avoir détruit un objet&nbsp;? Et pour les objets sauvés et non-détruits, comment pouvons-nous récupérer les utilisateurs de la base de données&nbsp;? Il est temps d'apprendre à utiliser Active Record pour y répondre.</p>

<div class="label" id="sec:finding_user_objects"></div>

<!-- FIN FRENCH -->
<h3><a id="sec:6.1.4" href="modeling-and-viewing-users-one#sec:finding_user_objects" class="heading"><span class="number">6.1.4</span> Recherche dans les objets Utilisateurs (Users)</a></h3>


<p>Active Record provides several options for finding objects. Let&rsquo;s use them to find the first user we created while verifying that the third user (<code>foo</code>) has been destroyed. We&rsquo;ll start with the existing user:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="go">=&gt; #&lt;User id: 1, nom: &quot;Michael Hartl&quot;, email: &quot;mhartl@example.com&quot;,</span>
<span class="go">created_at: &quot;2010-01-05 00:57:46&quot;, updated_at: &quot;2010-01-05 00:57:46&quot;&gt;</span>
</pre></div>
</div>


<p>Here we&rsquo;ve passed the id of the user to <code>User.find</code>; Active Record returns the user with that <code>id</code> attribute.</p>

<p>Let&rsquo;s see if the user with an <code>id</code> of&nbsp;<code>3</code> still exists in the database:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="go">ActiveRecord::RecordNotFound: Couldn&#39;t find User with ID=3</span>
</pre></div>
</div>


<p>Since we destroyed our third user in <a class="ref" href="modeling-and-viewing-users-one#sec:creating_user_objects">section&nbsp;6.1.3</a>, Active Record can&rsquo;t find it in the database. Instead, <code>find</code> raises an <em>exception</em>, which is a way of indicating an exceptional event in the execution of a program&mdash;in this case, a nonexistent Active Record id, which causes <code>find</code> to raise an <code>ActiveRecord::RecordNotFound</code> exception.<sup class="footnote" id="fnref:6.12"><a href="#fn:6.12">12</a></sup></p>

<p>In addition to the generic <code>find</code>, Active Record also allows us to find users by specific attributes:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="s2">&quot;mhartl@example.com&quot;</span><span class="p">)</span>
<span class="go">=&gt; #&lt;User id: 1, nom: &quot;Michael Hartl&quot;, email: &quot;mhartl@example.com&quot;,</span>
<span class="go">created_at: &quot;2010-01-05 00:57:46&quot;, updated_at: &quot;2010-01-05 00:57:46&quot;&gt;</span>
</pre></div>
</div>


<p>Since we will be using email addresses as usernames, this sort of find will be useful when we learn how to let users sign in to our site (<a class="ref" href="sign-up#top">chapitre&nbsp;8</a>).<sup class="footnote" id="fnref:6.13"><a href="#fn:6.13">13</a></sup></p>

<p>We&rsquo;ll end with a couple of more general ways of finding users. First, there&rsquo;s <code>first</code>:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">first</span>
<span class="go">=&gt; #&lt;User id: 1, nom: &quot;Michael Hartl&quot;, email: &quot;mhartl@example.com&quot;,</span>
<span class="go">created_at: &quot;2010-01-05 00:57:46&quot;, updated_at: &quot;2010-01-05 00:57:46&quot;&gt;</span>
</pre></div>
</div>


<p>Naturally, <code>first</code> just returns the first user in the database. There&rsquo;s also <code>all</code>:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">all</span>
<span class="go">=&gt; [#&lt;User id: 1, nom: &quot;Michael Hartl&quot;, email: &quot;mhartl@example.com&quot;,</span>
<span class="go">created_at: &quot;2010-01-05 00:57:46&quot;, updated_at: &quot;2010-01-05 00:57:46&quot;&gt;,</span>
<span class="go">#&lt;User id: 2, nom: &quot;A Nother&quot;, email: &quot;another@example.org&quot;, created_at:</span>
<span class="go">&quot;2010-01-05 01:05:24&quot;, updated_at: &quot;2010-01-05 01:05:24&quot;&gt;]</span>
</pre></div>
</div>


<p>No prizes for inferring that <code>all</code> returns an array (<a class="ref" href="rails-flavored-ruby#sec:arrays_and_ranges">section&nbsp;4.3.1</a>) of all users in the database.</p>

<div class="label" id="sec:updating_user_objects"></div>


<h3><a id="sec:6.1.5" href="modeling-and-viewing-users-one#sec:updating_user_objects" class="heading"><span class="number">6.1.5</span> Actualisation des objets Utilisateurs (Users)</a></h3>


<p>Once we&rsquo;ve created objects, we often want to update them. There are two basic ways to do this. First, we can assign attributes individually, as we did in <a class="ref" href="rails-flavored-ruby#sec:a_user_class">section&nbsp;4.4.5</a>:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span>           <span class="c1"># Just a reminder about our user&#39;s attributes</span>
<span class="go">=&gt; #&lt;User id: 1, nom: &quot;Michael Hartl&quot;, email: &quot;mhartl@example.com&quot;,</span>
<span class="go">created_at: &quot;2010-01-05 00:57:46&quot;, updated_at: &quot;2010-01-05 00:57:46&quot;&gt;</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="s2">&quot;mhartl@example.net&quot;</span>
<span class="go">=&gt; &quot;mhartl@example.net&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">save</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p>Note that the final step is necessary to write the changes to the database. We can see what happens without a save by using <code>reload</code>, which reloads the object based on the database information:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">email</span>
<span class="go">=&gt; &quot;mhartl@example.net&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="s2">&quot;foo@bar.com&quot;</span>
<span class="go">=&gt; &quot;foo@bar.com&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">reload</span><span class="o">.</span><span class="n">email</span>
<span class="go">=&gt; &quot;mhartl@example.net&quot;</span>
</pre></div>
</div>


<p>Now that we&rsquo;ve updated the user, the magic columns differ, as promised in <a class="ref" href="modeling-and-viewing-users-one#sec:creating_user_objects">section&nbsp;6.1.3</a>:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">created_at</span>
<span class="go">=&gt; &quot;2010-01-05 00:57:46&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">updated_at</span>
<span class="go">=&gt; &quot;2010-01-05 01:37:32&quot;</span>
</pre></div>
</div>


<p>The second way to update attributes is to use <code>update_attributes</code>:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">update_attributes</span><span class="p">(</span><span class="ss">:nom</span> <span class="o">=&gt;</span> <span class="s2">&quot;The Dude&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;dude@abides.org&quot;</span><span class="p">)</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">nom</span>
<span class="go">=&gt; &quot;The Dude&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">email</span>
<span class="go">=&gt; &quot;dude@abides.org&quot;</span>
</pre></div>
</div>


<p>The <code>update_attributes</code> method accepts a hash of attributes, and on success performs both the update and the save in one step (returning <code>true</code> to indicate that the save went through). It&rsquo;s worth noting that, once you have defined some attributes as accessible using <code>attr_accessible</code> (<a class="ref" href="modeling-and-viewing-users-one#sec:accessible_attributes">section&nbsp;6.1.2.2</a>), <em>only</em> those attributes can be modified using <code>update_attributes</code>. If you ever find that your models mysteriously start refusing to update certain columns, check to make sure that those columns are included in the call to <code>attr_accessible</code>.</p>

<div class="label" id="sec:user_validations"></div>


<h2><a id="sec:6.2" href="modeling-and-viewing-users-one#sec:user_validations" class="heading"><span class="number">6.2</span> User validations</a></h2>


<p>The User model we created in <a class="ref" href="modeling-and-viewing-users-one#sec:user_model">section&nbsp;6.1</a> now has working <code>nom</code> and <code>email</code> attributes, but they are completely generic: any string (including an empty one) is currently valid in either case. And yet, noms and email addresses are more specific than this. For example, <code>nom</code> should be non-blank, and <code>email</code> should match the specific format characteristic of email addresses. Moreover, since we&rsquo;ll be using email addresses as unique usernames when users sign in, we shouldn&rsquo;t allow email duplicates in the database.</p>

<p>In short, we shouldn&rsquo;t allow <code>nom</code> and <code>email</code> to be just any strings; we should enforce certain constraints on their values. Active Record allows us to impose such constraints using <em>validations</em>. In this section, we&rsquo;ll cover several of the most common cases, validating <em>presence</em>, <em>length</em>, <em>format</em> and <em>uniqueness</em>. In <a class="ref" href="modeling-and-viewing-users-two#sec:password_validations">section&nbsp;7.1.1</a> we&rsquo;ll add a final common validation, <em>confirmation</em>. And we&rsquo;ll see in <a class="ref" href="sign-up#sec:signup_failure">section&nbsp;8.2</a> how validations give us convenient error messages when users make submissions that violate them.</p>

<p>As with the other features of our sample app, we&rsquo;ll add User model validations using test-driven development. Since we&rsquo;ve changed the data model, it&rsquo;s a good idea to prepare the test database before proceeding:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rake db:test:prepare
</pre></div>
</div>


<p>This just ensures that the data model from the development database, <code>db/development.sqlite3</code>, is reflected in the test database, <code>db/test.sqlite3</code>.</p>

<div class="label" id="sec:presence_validation"></div>


<h3><a id="sec:6.2.1" href="modeling-and-viewing-users-one#sec:presence_validation" class="heading"><span class="number">6.2.1</span> Validating presence</a></h3>


<p>We&rsquo;ll start with a test for the presence of a <code>nom</code> attribute. Although the first step in TDD is to write a <em>failing</em> test (<a class="ref" href="static-pages#sec:TDD">section&nbsp;3.2.2</a>), in this case we don&rsquo;t yet know enough about validations to write the proper test, so we&rsquo;ll write the validation first, using the console to understand it. Then we&rsquo;ll comment out the validation, write a failing test, and verify that uncommenting the validation gets the test to pass. This procedure may seem pedantic for such a simple test, but I have seen<sup class="footnote" id="fnref:6.14"><a href="#fn:6.14">14</a></sup> <em>many</em> &ldquo;simple&rdquo; tests that test the wrong thing; being meticulous about TDD is simply the <em>only</em> way to be confident that we&rsquo;re testing the right thing. (This comment-out technique is also useful when rescuing an application whose application code is already written but&mdash;<a href="http://en.wiktionary.org/wiki/quelle_horreur"><em>quelle horreur!</em></a>&mdash;has no tests.)</p>

<p>The way to validate the presence of the nom attribute is to use the <code>validates</code> method with argument <code>:presence =&gt; true</code>, as shown in  <a class="ref" href="modeling-and-viewing-users-one#code:validates_presence_of_nom">extrait&nbsp;6.7</a>. The <code>:presence =&gt; true</code> argument is a one-element <em>options hash</em>; recall from <a class="ref" href="rails-flavored-ruby#sec:css_revisited">section&nbsp;4.3.4</a> that curly braces are optional when passing hashes as the final argument in a method. (As noted in <a class="ref" href="filling-in-the-layout#sec:adding_to_the_layout">section&nbsp;5.1.1</a>, the use of options hashes is a recurring theme in Rails.)</p>

<div class="label" id="code:validates_presence_of_nom"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 6.7.</span> <span class="description">Validating the presence of a <code>nom</code> attribute. <br /> <code>app/models/user.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span> 
  <span class="n">attr_accessible</span> <span class="ss">:nom</span><span class="p">,</span> <span class="ss">:email</span>

  <span class="n">validates</span> <span class="ss">:nom</span><span class="p">,</span> <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>As discussed briefly in <a class="ref" href="a-demo-app#sec:putting_the_micro_in_microposts">section&nbsp;2.3.2</a>, the use of <code>validates</code> is characteristic of Rails&nbsp;3. (In Rails&nbsp;2.3, we would write <code>validates_presence_of :nom</code> instead.)</p>

<p><a class="ref" href="modeling-and-viewing-users-one#code:validates_presence_of_nom">extrait&nbsp;6.7</a> may look like magic, but <code>validates</code> is just a method, as indeed is <code>attr_accessible</code>. An equivalent formulation of <a class="ref" href="modeling-and-viewing-users-one#code:validates_presence_of_nom">extrait&nbsp;6.7</a> using parentheses is as follows:</p>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span> 
  <span class="n">attr_accessible</span><span class="p">(</span><span class="ss">:nom</span><span class="p">,</span> <span class="ss">:email</span><span class="p">)</span>

  <span class="n">validates</span><span class="p">(</span><span class="ss">:nom</span><span class="p">,</span> <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>


<p>Let&rsquo;s drop into the console to see the effects of adding a validation to our User model:<sup class="footnote" id="fnref:6.15"><a href="#fn:6.15">15</a></sup></p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console --sandbox</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:nom</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;mhartl@example.com&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">save</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">valid?</span>
<span class="go">=&gt; false</span>
</pre></div>
</div>


<p>Here <code>user.save</code> returns <code>false</code>, indicating a failed save. In the final command, we use the <code>valid?</code> method, which returns <code>false</code> when the object fails one or more validations, and <code>true</code> when all validations pass. (Recall from <a class="ref" href="rails-flavored-ruby#sec:objects_and_message_passing">section&nbsp;4.2.3</a> that Ruby uses a question mark to indicate such true/false <em>boolean</em> methods.) In this case, we only have one validation, so we know which one failed, but it can still be helpful to check using the <code>errors</code> object generated on failure:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">full_messages</span>
<span class="go">=&gt; [&quot;Name can&#39;t be blank&quot;]</span>
</pre></div>
</div>


<p>(The error message is a hint that Rails validates the presence of an attribute using the <code>blank?</code> method, which we saw at the end of <a class="ref" href="rails-flavored-ruby#sec:modifying_built_in_classes">section&nbsp;4.4.3</a>.)</p>

<p>Now for the failing test. To ensure that our incipient test will fail, let&rsquo;s comment out the validation at this point (<a class="ref" href="modeling-and-viewing-users-one#code:commented_out_validation">extrait&nbsp;6.8</a>).</p>

<div class="label" id="code:commented_out_validation"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 6.8.</span> <span class="description">Commenting out a validation to ensure a failing test. <br /> <code>app/models/user.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span> 
  <span class="n">attr_accessible</span> <span class="ss">:nom</span><span class="p">,</span> <span class="ss">:email</span>

  <span class="c1"># validates :nom, :presence =&gt; true</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>As in the case of controller generation (e.g., <a class="ref" href="filling-in-the-layout#code:generate_users_controller">extrait&nbsp;5.23</a>), the model generate command in <a class="ref" href="modeling-and-viewing-users-one#code:generate_user_model">extrait&nbsp;6.1</a> produces an initial spec for testing users, but in this case it&rsquo;s practically blank (<a class="ref" href="modeling-and-viewing-users-one#code:default_user_spec">extrait&nbsp;6.9</a>).</p>

<div class="label" id="code:default_user_spec"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 6.9.</span> <span class="description">The practically blank default User spec. <br /> <code>spec/models/user_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="n">pending</span> <span class="s2">&quot;add some examples to (or delete) </span><span class="si">#{</span><span class="bp">__FILE__</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>This simply uses the <code>pending</code> method to indicate that we should fill the spec with something useful. We can see its effect by running the User model spec:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rspec spec/models/user_spec.rb 
<span class="go">*</span>


<span class="go">Finished in 0.01999 seconds</span>
<span class="go">1 example, 0 failures, 1 pending</span>

<span class="go">Pending:</span>
<span class="go">  User add some examples to (or delete)</span>
<span class="go">  /Users/mhartl/rails_projects/sample_app/spec/models/user_spec.rb</span>
<span class="go">  (Not Yet Implemented)</span>
</pre></div>
</div>


<p>We&rsquo;ll follow the advice of the default spec by filling it in with some RSpec examples, shown in <a class="ref" href="modeling-and-viewing-users-one#code:raw_user_spec">extrait&nbsp;6.10</a>.</p>

<div class="label" id="code:raw_user_spec"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 6.10.</span> <span class="description">The initial user spec. <br /> <code>spec/models/user_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
    <span class="vi">@attr</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:nom</span> <span class="o">=&gt;</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;user@example.com&quot;</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s2">&quot;should create a new instance given valid attributes&quot;</span> <span class="k">do</span>
    <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="vi">@attr</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s2">&quot;should require a nom&quot;</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>We&rsquo;ve seen <code>require</code> and <code>describe</code> before, most recently in <a class="ref" href="filling-in-the-layout#code:user_signup_spec">extrait&nbsp;5.28</a>. The next line is a <code>before(:each)</code> block; this was covered briefly in an exercise (<a class="ref" href="static-pages#code:pages_controller_spec_exercise">extrait&nbsp;3.33</a>), and all it does is run the code inside the block before each example&mdash;in this case setting the <code>@attr</code> instance variable to an initialization hash.</p>

<p>The first example is just a sanity check, verifying that the User model is basically working. It uses <code>User.create!</code> (read &ldquo;create bang&rdquo;), which works just like the <code>create</code> method we saw in <a class="ref" href="modeling-and-viewing-users-one#sec:creating_user_objects">section&nbsp;6.1.3</a> except that it raises an <code>ActiveRecord::RecordInvalid</code> exception if the creation fails (similar to the <code>ActiveRecord::RecordNotFound</code> exception we saw in <a class="ref" href="modeling-and-viewing-users-one#sec:finding_user_objects">section&nbsp;6.1.4</a>). As long as the attributes are valid, it won&rsquo;t raise any exceptions, and the test will pass.</p>

<p>The final line is the test for the presence of the <code>nom</code> attribute&mdash;or rather, it <em>would</em> be the actual test, if it had anything in it. Instead, the test is just a stub, but a useful stub it is: it&rsquo;s a <em>pending spec</em>, which is a way to write a description of the application&rsquo;s behavior without worrying yet about the implementation. <a class="ref" href="modeling-and-viewing-users-one#code:default_user_spec">extrait&nbsp;6.9</a> shows an example of a pending spec using an explicit call to the <code>pending</code> method; in this case, since we have included only the&nbsp;<code>it</code> part of the example,</p>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="s2">&quot;should require a nom&quot;</span>
</pre></div>
</div>


<p>RSpec infers the existence of a pending spec.</p>

<p>Pending specs are handled well by programs for running specs, as seen for Autotest in <a class="ref" href="modeling-and-viewing-users-one#fig:autotest_pending_spec">illustration&nbsp;6.5</a>, and the output of <code>rspec spec/</code> is similarly useful. Pending specs are useful as placeholders for tests we know we need to write at some point but don&rsquo;t want to deal with right now.</p>

<div class="label" id="fig:autotest_pending_spec"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/autotest_pending_spec.png" alt="autotest_pending_spec" /></span></div><div class="caption"><span class="header">Illustration 6.5: </span><span class="description">Autotest (via <code>autotest</code>) with a pending User spec.&nbsp;<a href="http://railstutorial.org/images/figures/autotest_pending_spec-full.png">(taille normale)</a></span></div></div>


<p>In order to fill in the pending spec, we need a way to make an attributes hash with an invalid nom. (The <code>@attr</code> hash is valid by construction, with a non-blank <code>nom</code> attribute.) The <code>Hash</code> method <code>merge</code> does the trick, as we can see with <code>rails console</code>:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="vi">@attr</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:nom</span> <span class="o">=&gt;</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;user@example.com&quot;</span> <span class="p">}</span>
<span class="go">=&gt; {:nom =&gt; &quot;Example User&quot;, :email =&gt; &quot;user@example.com&quot;}</span>
<span class="gp">&gt;&gt; </span><span class="vi">@attr</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="ss">:nom</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="go">=&gt; {:nom =&gt; &quot;&quot;, :email =&gt; &quot;user@example.com&quot;}</span>
</pre></div>
</div>


<p>With <code>merge</code> in hand, we&rsquo;re ready to make the new spec (using a trick I&rsquo;ll explain momentarily), as seen in <a class="ref" href="modeling-and-viewing-users-one#code:failing_validates_nom_spec">extrait&nbsp;6.11</a>.</p>

<div class="label" id="code:failing_validates_nom_spec"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 6.11.</span> <span class="description">A failing test for validation of the <code>nom</code> attribute. <br /> <code>spec/models/user_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
    <span class="vi">@attr</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:nom</span> <span class="o">=&gt;</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;user@example.com&quot;</span> <span class="p">}</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="s2">&quot;should require a nom&quot;</span> <span class="k">do</span>
    <span class="n">no_nom_user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@attr</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="ss">:nom</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
    <span class="n">no_nom_user</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_valid</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Here we use <code>merge</code> to make a new user called <code>no_nom_user</code> with a blank nom. The second line then uses the RSpec <code>should_not</code> method to verify that the resulting user is <em>not</em> valid. The trick I alluded to above is related to <code>be_valid</code>: we know from earlier in this section that a User object responds to the <code>valid?</code> boolean method. RSpec adopts the useful convention of allowing us to test <em>any</em> boolean method by dropping the question mark and prepending <code>be_</code>. In other words,</p>

<div class="code"><div class="highlight"><pre><span class="n">no_nom_user</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_valid</span>
</pre></div>
</div>


<p>is equivalent to</p>

<div class="code"><div class="highlight"><pre><span class="n">no_nom_user</span><span class="o">.</span><span class="n">valid?</span><span class="o">.</span><span class="n">should_not</span> <span class="o">==</span> <span class="kp">true</span>
</pre></div>
</div>


<p>Since it sounds more like natural language, writing <code>should_not be_valid</code> is definitely more idiomatically correct RSpec.</p>

<p>With that, our new test should fail, which we can verify with Autotest or by running the <code>user_spec.rb</code> file using the <code>spec</code> script:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rspec spec/models/user_spec.rb
<span class="go">.F</span>

<span class="go">1)</span>
<span class="go">&#39;User should require a nom&#39; FAILED</span>
<span class="go">expected valid? to return false, got true</span>
<span class="go">./spec/models/user_spec.rb:14:</span>

<span class="go">2 examples, 1 failure</span>
</pre></div>
</div>


<p>Now uncomment the validation (i.e., revert <a class="ref" href="modeling-and-viewing-users-one#code:commented_out_validation">extrait&nbsp;6.8</a> back to <a class="ref" href="modeling-and-viewing-users-one#code:validates_presence_of_nom">extrait&nbsp;6.7</a>) to get the test to pass:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rspec spec/models/user_spec.rb
<span class="go">..</span>

<span class="go">2 examples, 0 failures</span>
</pre></div>
</div>


<p>Of course, we also want to validate the presence of email addresses. The test (<a class="ref" href="modeling-and-viewing-users-one#code:validates_email_spec">extrait&nbsp;6.12</a>) is analogous to the one for the <code>nom</code> attribute.</p>

<div class="label" id="code:validates_email_spec"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 6.12.</span> <span class="description">A test for presence of the <code>email</code> attribute. <br /> <code>spec/models/user_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
    <span class="vi">@attr</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:nom</span> <span class="o">=&gt;</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;user@example.com&quot;</span> <span class="p">}</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="s2">&quot;should require an email address&quot;</span> <span class="k">do</span>
    <span class="n">no_email_user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@attr</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
    <span class="n">no_email_user</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_valid</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>The implementation is also virtually the same, as seen in <a class="ref" href="modeling-and-viewing-users-one#code:validates_presence_of_email">extrait&nbsp;6.13</a>.</p>

<div class="label" id="code:validates_presence_of_email"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 6.13.</span> <span class="description">Validating the presence of the <code>nom</code> and <code>email</code> attributes. <br /> <code>app/models/user.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span> 
  <span class="n">attr_accessible</span> <span class="ss">:nom</span><span class="p">,</span> <span class="ss">:email</span>

  <span class="n">validates</span> <span class="ss">:nom</span><span class="p">,</span>  <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Now all the tests should pass, and the &ldquo;presence&rdquo; validations are complete.</p>

<div class="label" id="sec:length_validation"></div>


<h3><a id="sec:6.2.2" href="modeling-and-viewing-users-one#sec:length_validation" class="heading"><span class="number">6.2.2</span> Length validation</a></h3>


<p>We&rsquo;ve constrained our User model to require a nom for each user, but we should go further: the user&rsquo;s noms will be displayed on the sample site, so we should enforce some limit on their length. With all the work we did in <a class="ref" href="modeling-and-viewing-users-one#sec:presence_validation">section&nbsp;6.2.1</a>, this step is easy.</p>

<p>We start with a test. There&rsquo;s no science to picking a maximum length; we&rsquo;ll just pull&nbsp;<code>50</code> out of thin air as a reasonable upper bound, which means verifying that noms of&nbsp;<code>51</code> characters are too long   (<a class="ref" href="modeling-and-viewing-users-one#code:length_validation_test">extrait&nbsp;6.14</a>).</p>

<div class="label" id="code:length_validation_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 6.14.</span> <span class="description">A test for <code>nom</code> length validation. <br /> <code>spec/models/user_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
    <span class="vi">@attr</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:nom</span> <span class="o">=&gt;</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;user@example.com&quot;</span> <span class="p">}</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="s2">&quot;should reject noms that are too long&quot;</span> <span class="k">do</span>
    <span class="n">long_nom</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span> <span class="o">*</span> <span class="mi">51</span>
    <span class="n">long_nom_user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@attr</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="ss">:nom</span> <span class="o">=&gt;</span> <span class="n">long_nom</span><span class="p">))</span>
    <span class="n">long_nom_user</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_valid</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>For convenience, we&rsquo;ve used &ldquo;string multiplication&rdquo; in <a class="ref" href="modeling-and-viewing-users-one#code:length_validation_test">extrait&nbsp;6.14</a> to make a string 51 characters long. We can see how this works using the console:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span> <span class="o">*</span> <span class="mi">51</span>
<span class="go">=&gt; &quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">length</span>
<span class="go">=&gt; 51</span>
</pre></div>
</div>


<p>The test in <a class="ref" href="modeling-and-viewing-users-one#code:length_validation_test">extrait&nbsp;6.14</a> should fail. To get it to pass, we need to know about the validation argument to constrain length, <code>:length</code>, along with the <code>:maximum</code> parameter to enforce the upper bound (<a class="ref" href="modeling-and-viewing-users-one#code:length_validation">extrait&nbsp;6.15</a>).</p>

<div class="label" id="code:length_validation"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 6.15.</span> <span class="description">Adding a length validation for the <code>nom</code> attribute. <br /> <code>app/models/user.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span> 
  <span class="n">attr_accessible</span> <span class="ss">:nom</span><span class="p">,</span> <span class="ss">:email</span>

  <span class="n">validates</span> <span class="ss">:nom</span><span class="p">,</span>  <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span>
                    <span class="ss">:length</span>   <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:maximum</span> <span class="o">=&gt;</span> <span class="mi">50</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>With our test suite passing again, we can move on to a more challenging validation: email format.</p>

<div class="label" id="sec:format_validation"></div>


<h3><a id="sec:6.2.3" href="modeling-and-viewing-users-one#sec:format_validation" class="heading"><span class="number">6.2.3</span> Format validation</a></h3>


<p>Our validations for the <code>nom</code> attribute enforce only minimal constraints&mdash;any non-blank nom under 51 characters will do&mdash;but of course the <code>email</code> attribute must satisfy more stringent requirements. So far we&rsquo;ve only rejected blank email addresses; in this section, we&rsquo;ll require email addresses to conform to the familiar pattern <code>user@example.com</code>.</p>

<p>Neither the tests nor the validation will be exhaustive, just good enough to accept most valid email addresses and reject most invalid ones. We&rsquo;ll start with a couple tests involving collections of valid and invalid addresses. To make these collections, it&rsquo;s worth knowing about a useful method for making arrays of strings, as seen in this console session:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="sx">%w[foo bar baz]</span>
<span class="go">=&gt; [&quot;foo&quot;, &quot;bar&quot;, &quot;baz&quot;]</span>
<span class="gp">&gt;&gt; </span><span class="n">addresses</span> <span class="o">=</span> <span class="sx">%w[user@foo.com THE_USER@foo.bar.org first.last@foo.jp]</span>
<span class="go">=&gt; [&quot;user@foo.com&quot;, &quot;THE_USER@foo.bar.org&quot;, &quot;first.last@foo.jp&quot;]</span>
<span class="gp">&gt;&gt; </span><span class="n">addresses</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">address</span><span class="o">|</span>
<span class="gp">?&gt; </span>  <span class="nb">puts</span> <span class="n">address</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">user@foo.com</span>
<span class="go">THE_USER@foo.bar.org</span>
<span class="go">first.last@foo.jp</span>
</pre></div>
</div>


<p>Here we&rsquo;ve iterated over the elements of the <code>addresses</code> array using the <code>each</code> method (<a class="ref" href="rails-flavored-ruby#sec:blocks">section&nbsp;4.3.2</a>). With this technique in hand, we&rsquo;re ready to write some basic email format validation tests (<a class="ref" href="modeling-and-viewing-users-one#code:email_format_validation_tests">extrait&nbsp;6.16</a>).</p>

<div class="label" id="code:email_format_validation_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 6.16.</span> <span class="description">Tests for email format validation. <br /> <code>spec/models/user_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
    <span class="vi">@attr</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:nom</span> <span class="o">=&gt;</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;user@example.com&quot;</span> <span class="p">}</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="s2">&quot;should accept valid email addresses&quot;</span> <span class="k">do</span>
    <span class="n">addresses</span> <span class="o">=</span> <span class="sx">%w[user@foo.com THE_USER@foo.bar.org first.last@foo.jp]</span>
    <span class="n">addresses</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">address</span><span class="o">|</span>
      <span class="n">valid_email_user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@attr</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="ss">:email</span> <span class="o">=&gt;</span> <span class="n">address</span><span class="p">))</span>
      <span class="n">valid_email_user</span><span class="o">.</span><span class="n">should</span> <span class="n">be_valid</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s2">&quot;should reject invalid email addresses&quot;</span> <span class="k">do</span>
    <span class="n">addresses</span> <span class="o">=</span> <span class="sx">%w[user@foo,com user_at_foo.org example.user@foo.]</span>
    <span class="n">addresses</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">address</span><span class="o">|</span>
      <span class="n">invalid_email_user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@attr</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="ss">:email</span> <span class="o">=&gt;</span> <span class="n">address</span><span class="p">))</span>
      <span class="n">invalid_email_user</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_valid</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>As noted above, these are far from exhaustive, but we do check the common valid email forms <code>user@foo.com</code>, <code>THE_USER@foo.bar.org </code> (uppercase, underscores, and compound domains), and <code>first.last@foo.jp</code> (the standard corporate username <code>first.last</code>, with a two-letter top-level domain&nbsp;<code>jp</code>), along with several invalid forms.</p>

<p>The application code for email format validation uses a <em>regular expression</em> (or <em>regex</em>) to define the format, along with the <code>:format</code> argument to the <code>validates</code> method (<a class="ref" href="modeling-and-viewing-users-one#code:validates_format_of_email">extrait&nbsp;6.17</a>).</p>

<div class="label" id="code:validates_format_of_email"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 6.17.</span> <span class="description">Validating the email format with a regular expression. <br /> <code>app/models/user.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:nom</span><span class="p">,</span> <span class="ss">:email</span>

  <span class="n">email_regex</span> <span class="o">=</span> <span class="sr">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</span>

  <span class="n">validates</span> <span class="ss">:nom</span><span class="p">,</span>  <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span>
                    <span class="ss">:length</span>   <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:maximum</span> <span class="o">=&gt;</span> <span class="mi">50</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span>
                    <span class="ss">:format</span>   <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="n">email_regex</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Here <code>email_regex</code> is a <em>regular expression</em>, also known as a <em>regex</em>. The code</p>

<div class="code"><div class="highlight"><pre>  <span class="n">email_regex</span> <span class="o">=</span> <span class="sr">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span>
                    <span class="ss">:format</span>   <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="n">email_regex</span> <span class="p">}</span>
</pre></div>
</div>


<p>ensures that only email addresses that match the pattern will be considered valid.</p>

<p>So, where does the pattern come from? Regular expressions consist of a terse (some would say <a href="http://catb.org/jargon/html/L/line-noise.html">unreadable</a>) language for matching text patterns; learning to construct regexes is an art, and to get you started I&rsquo;ve broken <code>email_regex</code> into bite-sized pieces (<a class="ref" href="modeling-and-viewing-users-one#table:email_regex">Table&nbsp;6.1</a>).<sup class="footnote" id="fnref:6.16"><a href="#fn:6.16">16</a></sup> To really learn about regular expressions, though, I consider the amazing <a href="http://www.rubular.com/">Rubular</a> regular expression editor (<a class="ref" href="modeling-and-viewing-users-one#fig:rubular">illustration&nbsp;6.6</a>) to be simply essential.<sup class="footnote" id="fnref:6.17"><a href="#fn:6.17">17</a></sup> The Rubular website has a beautiful interactive interface for making regular expressions, along with a handy regex quick reference. I encourage you to study <a class="ref" href="modeling-and-viewing-users-one#table:email_regex">Table&nbsp;6.1</a> with a browser window open to Rubular&mdash;no amount of reading about regular expressions can replace a couple of hours playing with Rubular.</p>

<div class="label" id="table:email_regex"></div>


<div class="table"><div class="center"><table class="tabular"><tr><th class="align_left"><strong>Expression</strong></th><th class="align_left"><strong>Meaning</strong></th></tr><tr class="top_bar"><td class="align_left"><tt class="verb">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</tt></td><td class="align_left">full regex</td></tr><tr><td class="align_left"><tt class="verb">/</tt></td><td class="align_left">start of regex</td></tr><tr><td class="align_left"><tt class="verb">\A</tt></td><td class="align_left">match start of a string</td></tr><tr><td class="align_left"><tt class="verb">[\w+\-.]+</tt></td><td class="align_left">at least one word character, plus, hyphen, or dot</td></tr><tr><td class="align_left"><tt class="verb">@</tt></td><td class="align_left">literal &ldquo;at sign&rdquo;</td></tr><tr><td class="align_left"><tt class="verb">[a-z\d\-.]+</tt></td><td class="align_left">at least one letter, digit, hyphen, or dot</td></tr><tr><td class="align_left"><tt class="verb">\.</tt></td><td class="align_left">literal dot</td></tr><tr><td class="align_left"><tt class="verb">[a-z]+</tt></td><td class="align_left">at least one letter</td></tr><tr><td class="align_left"><tt class="verb">\z</tt></td><td class="align_left">match end of a string</td></tr><tr><td class="align_left"><tt class="verb">/</tt></td><td class="align_left">end of regex</td></tr><tr><td class="align_left"><tt class="verb">i</tt></td><td class="align_left">case insensitive</td></tr></table></div><div class="caption"><span class="header">Table 6.1: </span><span class="description">Breaking down the email regex from <a class="ref" href="modeling-and-viewing-users-one#code:validates_format_of_email">extrait&nbsp;6.17</a>.</span></div></div>


<p>By the way, there actually exists a full regex for matching email addresses according to the official standard, but it&rsquo;s really not worth the trouble. The one in <a class="ref" href="modeling-and-viewing-users-one#code:validates_format_of_email">extrait&nbsp;6.17</a> is fine, maybe even better than the official one.<sup class="footnote" id="fnref:6.18"><a href="#fn:6.18">18</a></sup></p>

<div class="label" id="fig:rubular"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/rubular.png" alt="rubular" /></span></div><div class="caption"><span class="header">Illustration 6.6: </span><span class="description">The awesome  <a href="http://www.rubular.com/">Rubular</a> regular expression editor.&nbsp;<a href="http://railstutorial.org/images/figures/rubular-full.png">(taille normale)</a></span></div></div>


<p>The tests should all be passing now. (In fact, the tests for valid email addresses should have been passing all along; since regexes are notoriously error-prone, the valid email tests are there mainly as a sanity check on <code>email_regex</code>.) This means that there&rsquo;s only one constraint left: enforcing the email addresses to be unique.</p>

<div class="label" id="sec:uniqueness_validation"></div>


<h3><a id="sec:6.2.4" href="modeling-and-viewing-users-one#sec:uniqueness_validation" class="heading"><span class="number">6.2.4</span> Uniqueness validation</a></h3>


<p>To enforce uniqueness of email addresses (so that we can use them as usernames), we&rsquo;ll be using the <code>:unique</code> option to the <code>validates</code> method. But be warned: there&rsquo;s a <em>major</em> caveat, so don&rsquo;t just skim this section&mdash;read it carefully.</p>

<p>We&rsquo;ll start, as usual, with our tests. In our previous model tests, we&rsquo;ve mainly used <code>User.new</code>, which just creates a Ruby object in memory, but for uniqueness tests we actually need to put a record into the database.<sup class="footnote" id="fnref:6.19"><a href="#fn:6.19">19</a></sup> The (first) duplicate email test appears in <a class="ref" href="modeling-and-viewing-users-one#code:validates_uniqueness_of_email_test">extrait&nbsp;6.18</a>.</p>

<div class="label" id="code:validates_uniqueness_of_email_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 6.18.</span> <span class="description">A test for the rejection of duplicate email addresses. <br /> <code>spec/models/user_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
    <span class="vi">@attr</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:nom</span> <span class="o">=&gt;</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;user@example.com&quot;</span> <span class="p">}</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="s2">&quot;should reject duplicate email addresses&quot;</span> <span class="k">do</span>
    <span class="c1"># Put a user with given email address into the database.</span>
    <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="vi">@attr</span><span class="p">)</span>
    <span class="n">user_with_duplicate_email</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@attr</span><span class="p">)</span>
    <span class="n">user_with_duplicate_email</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_valid</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>The method here is to create a user and then try to make another one with the same email address. (We use the noisy method <code>create!</code>, first seen in <a class="ref" href="modeling-and-viewing-users-one#code:raw_user_spec">extrait&nbsp;6.10</a>, so that it will raise an exception if anything goes wrong. Using <code>create</code>, without the bang&nbsp;<code>!</code>, risks having a silent error in our test, a potential source of elusive bugs.) We can get this test to pass with the code in <a class="ref" href="modeling-and-viewing-users-one#code:validates_uniqueness_of_email">extrait&nbsp;6.19</a>.<sup class="footnote" id="fnref:6.20"><a href="#fn:6.20">20</a></sup></p>

<div class="label" id="code:validates_uniqueness_of_email"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 6.19.</span> <span class="description">Validating the uniqueness of email addresses. <br /> <code>app/models/user.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:presence</span>   <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span>
                    <span class="ss">:format</span>     <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="n">email_regex</span> <span class="p">},</span>
                    <span class="ss">:uniqueness</span> <span class="o">=&gt;</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>We&rsquo;re not quite done, though. Email addresses are case-insensitive&mdash;<code>foo@bar.com</code> goes to the same place as <code>FOO@BAR.COM</code> or <code>FoO@BAr.coM</code>&mdash;so our validation should cover this case as well. We test for this with the code in <a class="ref" href="modeling-and-viewing-users-one#code:validates_uniqueness_of_email_case_insensitive_test">extrait&nbsp;6.20</a>.</p>

<div class="label" id="code:validates_uniqueness_of_email_case_insensitive_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 6.20.</span> <span class="description">A test for the rejection of duplicate email addresses, insensitive to case. <br /> <code>spec/models/user_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
    <span class="vi">@attr</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:nom</span> <span class="o">=&gt;</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;user@example.com&quot;</span> <span class="p">}</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="s2">&quot;should reject email addresses identical up to case&quot;</span> <span class="k">do</span>
    <span class="n">upcased_email</span> <span class="o">=</span> <span class="vi">@attr</span><span class="o">[</span><span class="ss">:email</span><span class="o">].</span><span class="n">upcase</span>
    <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="vi">@attr</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="ss">:email</span> <span class="o">=&gt;</span> <span class="n">upcased_email</span><span class="p">))</span>
    <span class="n">user_with_duplicate_email</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@attr</span><span class="p">)</span>
    <span class="n">user_with_duplicate_email</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_valid</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Here we are using the <code>upcase</code> method on strings (seen briefly in <a class="ref" href="rails-flavored-ruby#sec:blocks">section&nbsp;4.3.2</a>). This test does the same thing as the first duplicate email test, but with an upper-case email address instead. If this test feels a little abstract, go ahead and fire up the console:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console --sandbox</span>
<span class="gp">&gt;&gt; </span><span class="vi">@attr</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:nom</span> <span class="o">=&gt;</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;user@example.com&quot;</span> <span class="p">}</span>
<span class="go">=&gt; {:nom =&gt; &quot;Example User&quot;, :email =&gt; &quot;user@example.com&quot;}</span>
<span class="gp">&gt;&gt; </span><span class="n">upcased_email</span> <span class="o">=</span> <span class="vi">@attr</span><span class="o">[</span><span class="ss">:email</span><span class="o">].</span><span class="n">upcase</span>
<span class="go">=&gt; &quot;USER@EXAMPLE.COM&quot;</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="vi">@attr</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="ss">:email</span> <span class="o">=&gt;</span> <span class="n">upcased_email</span><span class="p">))</span>
<span class="gp">&gt;&gt; </span><span class="n">user_with_duplicate_email</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@attr</span><span class="p">)</span>
<span class="gp">&gt;&gt; </span><span class="n">user_with_duplicate_email</span><span class="o">.</span><span class="n">valid?</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p>Of course, currently <code>user_with_duplicate_email.valid?</code> is <code>true</code>, since this is a failing test, but we want it to be <code>false</code>. Fortunately, <code>:uniqueness</code> accepts an option, <code>:case_sensitive</code>, for just this purpose (<a class="ref" href="modeling-and-viewing-users-one#code:validates_uniqueness_of_email_case_insensitive">extrait&nbsp;6.21</a>).</p>

<div class="label" id="code:validates_uniqueness_of_email_case_insensitive"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 6.21.</span> <span class="description">Validating the uniqueness of email addresses, ignoring case. <br /> <code>app/models/user.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:presence</span>   <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span>
                    <span class="ss">:format</span>     <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="n">email_regex</span> <span class="p">},</span>
                    <span class="ss">:uniqueness</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:case_sensitive</span> <span class="o">=&gt;</span> <span class="kp">false</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Note that we have simply replaced <code>true</code> with <code>:case_sensitive =&gt; false</code>; Rails infers in this case that <code>:uniqueness</code> should be <code>true</code>. At this point, our application (sort-of) enforces email uniqueness, and our test suite should pass.</p>

<div class="label" id="sec:the_caveat"></div>


<h4><a id="sec:6.2.4.1" href="modeling-and-viewing-users-one#sec:the_caveat" class="heading">L'avertissement d'unicité</a></h4>


<p>There&rsquo;s just one small problem, the caveat alluded to above:</p>

<p><strong>Using <code>validates :uniqueness</code> does not guarantee uniqueness.</strong></p>

<p>D&rsquo;oh! But what can go wrong? Here&rsquo;s what:</p>

<ol>
<li>Alice signs up for the sample app, with address <code>alice@wonderland.com</code>.</li>
<li>Alice accidentally clicks on &ldquo;Submit&rdquo; <em>twice</em>, sending two requests in quick succession.</li>
<li>The following sequence occurs: request 1 creates a user in memory that passes validation, request 2 does the same, request&nbsp;1&rsquo;s user gets saved, request&nbsp;2&rsquo;s user gets saved.</li>
<li>Result: two user records with the exact same email address, despite the uniqueness validation.</li>
</ol>


<p>If the above sequence seems implausible, believe me, it isn&rsquo;t: it happens on any Rails website with significant traffic.<sup class="footnote" id="fnref:6.21"><a href="#fn:6.21">21</a></sup> Luckily, the solution is straightforward to implement; we just need to enforce uniqueness at the database level as well. Our method is to create a database <em>index</em> on the email column, and then require that the index be unique.</p>

<p>The email index represents an update to our data modeling requirements, which (as discussed in <a class="ref" href="modeling-and-viewing-users-one#sec:database_migrations">section&nbsp;6.1.1</a>) is handled in Rails using migrations. We saw in <a class="ref" href="modeling-and-viewing-users-one#sec:database_migrations">section&nbsp;6.1.1</a> that generating the User model automatically created a new migration (<a class="ref" href="modeling-and-viewing-users-one#code:users_migration">extrait&nbsp;6.2</a>); in the present case, we are adding structure to an existing model, so we need to create a migration directly using the <code>migration</code> generator:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate migration add_email_uniqueness_index
</pre></div>
</div>


<p>Unlike the migration for users, the email uniqueness migration is not pre-defined, so we need to fill in its contents with <a class="ref" href="modeling-and-viewing-users-one#code:email_uniqueness_index">extrait&nbsp;6.22</a>.<sup class="footnote" id="fnref:6.22"><a href="#fn:6.22">22</a></sup></p>

<div class="label" id="code:email_uniqueness_index"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 6.22.</span> <span class="description">The migration for enforcing email uniqueness. <br /> <code>db/migrate/&lt;timestamp&gt;_add_email_uniqueness_index.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">AddEmailUniquenessIndex</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">up</span>
    <span class="n">add_index</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:unique</span> <span class="o">=&gt;</span> <span class="kp">true</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">down</span>
    <span class="n">remove_index</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:email</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>This uses a Rails method called <code>add_index</code> to add an index on the <code>email</code> column of the <code>users</code> table. The index by itself doesn&rsquo;t enforce uniqueness, but the option <code>:unique =&gt; true</code> does.</p>

<p>The final step is to migrate the database:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rake db:migrate
</pre></div>
</div>


<p>Now the Alice scenario above will work fine: the database will save a user record based on the first request, and will reject the second save for violating the uniqueness constraint. (An error will appear in the Rails log, but that doesn&rsquo;t do any harm. You can actually catch the <code>ActiveRecord::StatementInvalid</code> exception that gets raised&mdash;see <a href="http://github.com/insoshi/insoshi/blob/master/app/controllers/people_controller.rb">Insoshi</a> for an example&mdash;but in this tutorial we won&rsquo;t bother with this step.) Adding this index on the email attribute accomplishes a second goal, alluded to briefly in <a class="ref" href="modeling-and-viewing-users-one#sec:finding_user_objects">section&nbsp;6.1.4</a>: it fixes an efficiency problem in <code>find_by_email</code> (<a class="ref" href="modeling-and-viewing-users-one#sidebar:database_indices">Box&nbsp;6.2</a>).</p>

<div class="label" id="sidebar:database_indices"></div>


<div class="sidebar"><span class="title"><span class="header">Box 6.2.</span><span class="description">Database indices</span></span>
<p>When creating a column in a database, it is important to consider if we will need to <em>find</em> records by that column. Consider, for example, the <code>email</code> attribute created by the migration in <a class="ref" href="modeling-and-viewing-users-one#code:users_migration">extrait&nbsp;6.2</a>. When we allow users to sign in to the sample app starting in <a class="ref" href="sign-up#top">chapitre&nbsp;8</a>, we will need to find the user record corresponding to the submitted email address; unfortunately, based on the na&iuml;ve data model, the only way to find a user by email address is to look through <em>each</em> user row in the database and compare its email attribute to the given email. This is known in the database business as a <em>full-table scan</em>, and for a real site with thousands of users it is a <a href="http://catb.org/jargon/html/B/Bad-Thing.html">Bad Thing</a>.</p>

<p>Putting an index on the email column fixes the problem. To understand a database index, it&rsquo;s helpful to consider the analogy of a book index. In a book, to find all the occurrences of a given string, say &ldquo;foobar&rdquo;, you would have to scan each page for &ldquo;foobar&rdquo;. With a book index, on the other hand, you can just look up &ldquo;foobar&rdquo; in the index to see all the pages containing &ldquo;foobar&rdquo;. A database index works essentially the same way.</p>
</div>




<div class="label" id="sec:viewing_users"></div>


<h2><a id="sec:6.3" href="modeling-and-viewing-users-one#sec:viewing_users" class="heading"><span class="number">6.3</span> Viewing users</a></h2>


<p>We&rsquo;re not quite done with the basic user model&mdash;we still need to add passwords, a task for <a class="ref" href="modeling-and-viewing-users-two#top">chapitre&nbsp;7</a>&mdash;but we do have enough in place to make a minimalist page for showing user information. This will allow a gentle introduction to the REST style of organizing the actions for our site&rsquo;s users. Since this is just a rough demonstration for now, there are no tests in this section; we&rsquo;ll add tests when we flesh out the user view in <a class="ref" href="modeling-and-viewing-users-two#sec:better_user_views">section&nbsp;7.3</a>.</p>

<div class="label" id="sec:rails_environments"></div>


<h3><a id="sec:6.3.1" href="modeling-and-viewing-users-one#sec:rails_environments" class="heading"><span class="number">6.3.1</span> Debug and Rails environments</a></h3>


<p>As preparation for adding dynamic pages to our sample application, now is a good time to add some debug information to our site layout (<a class="ref" href="modeling-and-viewing-users-one#code:rails_debug">extrait&nbsp;6.23</a>). This displays some useful information about each page using the built-in <code>debug</code> method and <code>params</code> variable (which we&rsquo;ll learn more about in <a class="ref" href="modeling-and-viewing-users-one#sec:users_show">section&nbsp;6.3.2</a>), as seen in <a class="ref" href="modeling-and-viewing-users-one#fig:home_page_with_debug_rails_3">illustration&nbsp;6.7</a>.</p>

<div class="label" id="code:rails_debug"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 6.23.</span> <span class="description">Adding some debug information to the site layout. <br /> <code>app/views/layouts/application.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  .
  .
  .
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
      .
      .
      .
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;layouts/footer&#39;</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">debug</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="k">if</span> <span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">development?</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div></div>


<p>Since we don&rsquo;t want to display debug information to users of a deployed application, we use</p>

<div class="code"><div class="highlight"><pre><span class="k">if</span> <span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">development?</span>
</pre></div>
</div>


<p>to restrict the debug information to the <em>development environment</em>. Though we&rsquo;ve seen evidence of Rails environments before (most recently in <a class="ref" href="modeling-and-viewing-users-one#sec:creating_user_objects">section&nbsp;6.1.3</a>), this is the first time it has mattered to us.</p>

<div class="label" id="fig:home_page_with_debug_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/home_page_with_debug_rails_3.png" alt="home_page_with_debug_rails_3" /></span></div><div class="caption"><span class="header">Illustration 6.7: </span><span class="description">The sample application Home page (<a href="http://localhost:3000/"><tt>/</tt></a>) with debug information at the bottom.&nbsp;<a href="http://railstutorial.org/images/figures/home_page_with_debug_rails_3-full.png">(taille normale)</a></span></div></div>


<p>Rails comes equipped with three environments: <code>test</code>, <code>development</code>, and <code>production</code>.<sup class="footnote" id="fnref:6.23"><a href="#fn:6.23">23</a></sup> The default environment for the Rails console is <code>development</code>:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console </span>
<span class="go">Loading development environment (Rails 3.0.7)</span>
<span class="gp">&gt;&gt; </span><span class="no">Rails</span><span class="o">.</span><span class="n">env</span>
<span class="go">=&gt; &quot;development&quot;</span>
<span class="gp">&gt;&gt; </span><span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">development?</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">test?</span>
<span class="go">=&gt; false</span>
</pre></div>
</div>


<p>As you can see, Rails provides a <code>Rails</code> object with an <code>env</code> attribute and associated environment boolean methods. In particular, <code>Rails.env.development?</code> is <code>true</code> only in a development environment, so the Embedded Ruby</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">debug</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="k">if</span> <span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">development?</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>won&rsquo;t be inserted into production applications or tests. (Inserting the debug information into tests probably doesn&rsquo;t do any harm, but it probably doesn&rsquo;t do any good, either, so it&rsquo;s best to restrict the debug display to development only.)</p>

<p>If you ever need to run a console in a different environment (to debug a test, for example), you can pass the environment as a parameter to the <code>console</code> script:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console test</span>
<span class="go">Loading test environment (Rails 3.0.7)</span>
<span class="gp">&gt;&gt; </span><span class="no">Rails</span><span class="o">.</span><span class="n">env</span>
<span class="go">=&gt; &quot;test&quot;</span>
</pre></div>
</div>


<p>As with the console, <code>development</code> is the default environment for the local Rails server, but you can also run it in a different environment:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails server --environment production
</pre></div>
</div>


<p>If you view your app running in production, it won&rsquo;t work without a production database, which we can create by running <code>rake db:migrate</code> in production:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rake db:migrate <span class="nv">RAILS_ENV</span><span class="o">=</span>production
</pre></div>
</div>


<p>(I find it confusing that the console, server, and migrate commands specify non-default environments in three mutually incompatible ways, which is why I bothered showing all three.)</p>

<p>By the way, if you have deployed your sample app to Heroku, you can see its environment using the <code>heroku</code> command, which provides its own (remote) console:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ heroku console</span>
<span class="go">Ruby console for yourapp.heroku.com</span>
<span class="gp">&gt;&gt; </span><span class="no">Rails</span><span class="o">.</span><span class="n">env</span>
<span class="go">=&gt; &quot;production&quot;</span>
<span class="gp">&gt;&gt; </span><span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">production?</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p>Naturally, since Heroku is a platform for production sites, it runs each application in a production environment.</p>

<div class="label" id="sec:users_show"></div>


<h3><a id="sec:6.3.2" href="modeling-and-viewing-users-one#sec:users_show" class="heading"><span class="number">6.3.2</span> User model, view, controller</a></h3>


<p>In order to make a page to view a user, we&rsquo;ll use the User <em>model</em> to put a user into the database, make a <em>view</em> to display some user information, and then add an action to the Users <em>controller</em> to handle the browser request. In other words, for the first time in this tutorial, we&rsquo;ll see in one place all three elements of the model-view-controller architecture first discussed in <a class="ref" href="beginning#sec:mvc">section&nbsp;1.2.6</a>.</p>

<p>Our first step is to create a user using the console, which we&rsquo;ll take care <em>not</em> to start in a sandbox since this time the whole point is to save a record to the database:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="go">Loading development environment (Rails 3.0.7)</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">:nom</span> <span class="o">=&gt;</span> <span class="s2">&quot;Michael Hartl&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;mhartl@example.com&quot;</span><span class="p">)</span>
<span class="go">=&gt; #&lt;User id: 1, nom: &quot;Michael Hartl&quot;, email: &quot;mhartl@example.com&quot;,</span>
<span class="go">created_at: &quot;2010-01-07 23:05:14&quot;, updated_at: &quot;2010-01-07 23:05:14&quot;&gt;</span>
</pre></div>
</div>


<p>To double-check that this worked, let&rsquo;s look at the row in the development database using the SQLite Database Browser (<a class="ref" href="modeling-and-viewing-users-one#fig:sqlite_user_row">illustration&nbsp;6.8</a>). Note that the columns correspond to the attributes of the data model defined in <a class="ref" href="modeling-and-viewing-users-one#sec:user_model">section&nbsp;6.1</a>.</p>

<div class="label" id="fig:sqlite_user_row"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/sqlite_user_row.png" alt="sqlite_user_row" /></span></div><div class="caption"><span class="header">Illustration 6.8: </span><span class="description">A user row in the SQLite database <code>db/development.sqlite3</code>.&nbsp;<a href="http://railstutorial.org/images/figures/sqlite_user_row-full.png">(taille normale)</a></span></div></div>


<p>Next comes the view, which is minimalist to emphasize that this is just a demonstration (<a class="ref" href="modeling-and-viewing-users-one#code:stub_user_view">extrait&nbsp;6.24</a>). We use the standard Rails location for showing a user, <code>app/views/users/show.html.erb</code>; unlike the <code>new.html.erb</code> view, which we created with the generator in <a class="ref" href="filling-in-the-layout#code:generate_users_controller">extrait&nbsp;5.23</a>, the <code>show.html.erb</code> file doesn&rsquo;t currently exist, so you&rsquo;ll have to create it by hand.</p>

<div class="label" id="code:stub_user_view"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 6.24.</span> <span class="description">A stub view for showing user information. <br /> <code>app/views/users/show.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">nom</span> <span class="cp">%&gt;</span>, <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p>This view uses Embedded Ruby to display the user&rsquo;s nom and email address, assuming the existence of an instance variable called <code>@user</code>. Of course, eventually the real user show page will look very different, and won&rsquo;t display the email address publicly.</p>

<p>Finally, we&rsquo;ll add the <code>show</code> action to the Users controller (corresponding to the <code>show.html.erb</code> view) with the code in <a class="ref" href="modeling-and-viewing-users-one#code:user_show_action">extrait&nbsp;6.25</a>, which defines the <code>@user</code> instance variable needed by the view.</p>

<div class="label" id="code:user_show_action"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 6.25.</span> <span class="description">The Users controller with a <code>show</code> action. <br /> <code>app/controllers/users_controller.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">show</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">new</span>
    <span class="vi">@title</span> <span class="o">=</span> <span class="s2">&quot;Sign up&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Here we&rsquo;ve gotten a little ahead of ourselves by using the standard Rails <code>params</code> object to retrieve the user&nbsp;id. When we make the appropriate request to the Users controller, <code>params[:id]</code> will be the user id&nbsp;<code>1</code>, so the effect is the same as the <code>find</code> command</p>

<div class="code"><div class="highlight"><pre><span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>


<p>we saw in <a class="ref" href="modeling-and-viewing-users-one#sec:finding_user_objects">section&nbsp;6.1.4</a>.</p>

<p>Although the <code>show</code> view and action are now both defined, we still don&rsquo;t have a way to view the page itself. This requires defining the proper rule in the Rails routes file, as we&rsquo;ll see in the next section.</p>

<div class="label" id="sec:a_users_resource"></div>


<h3><a id="sec:6.3.3" href="modeling-and-viewing-users-one#sec:a_users_resource" class="heading"><span class="number">6.3.3</span> A Users resource</a></h3>


<p>Our method for displaying the user show page will follow the conventions of the REST architecture favored in Rails applications. This style is based on the ideas of <em>representational state transfer</em> identified and nomd by computer scientist <a href="http://en.wikipedia.org/wiki/Roy_Fielding">Roy Fielding</a> in his doctoral dissertation <em>Architectural Styles and the Design of Network-based Software Architectures</em>.<sup class="footnote" id="fnref:6.24"><a href="#fn:6.24">24</a></sup> The REST design style emphasizes representing data as <em>resources</em> that can be created, shown, updated, or destroyed&mdash;four actions corresponding to the four fundamental operations <tt>POST</tt>, <tt>GET</tt>, <tt>PUT</tt>, and <tt>DELETE</tt> defined by the <a href="http://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol">HTTP standard</a> (<a class="ref" href="static-pages#sidebar:get_etc">Box&nbsp;3.1</a>).</p>

<p>When following REST principles, resources are typically referenced using the resource nom and a unique identifier. What this means in the context of users&mdash;which we&rsquo;re now thinking of as a Users <em>resource</em>&mdash;is that we should view the user with id&nbsp;<code>1</code> by issuing a <tt>GET</tt> request to the URL <tt>/users/1</tt>. Here the <code>show</code> action is <em>implicit</em> in the type of request&mdash;when Rails&rsquo; REST features are activated, <tt>GET</tt> requests are automatically handled by the <code>show</code> action.</p>

<div class="label" id="fig:user_show_exception_caught"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_show_exception_caught.png" alt="user_show_exception_caught" /></span></div><div class="caption"><span class="header">Illustration 6.9: </span><span class="description">The initial effect of hitting  <a href="http://localhost:3000/users/1"><tt>/users/1</tt></a>.&nbsp;<a href="http://railstutorial.org/images/figures/user_show_exception_caught-full.png">(taille normale)</a></span></div></div>


<p>Unfortunately, the URL <a href="http://localhost:3000/users/1"><tt>/users/1</tt></a> doesn&rsquo;t work quite yet due to a routing error (<a class="ref" href="modeling-and-viewing-users-one#fig:user_show_exception_caught">illustration&nbsp;6.9</a>). We can get the REST-style Users URL to work by adding users as a resource to <code>config/routes.rb</code>, as seen in <a class="ref" href="modeling-and-viewing-users-one#code:users_resource">extrait&nbsp;6.26</a>.</p>

<div class="label" id="code:users_resource"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 6.26.</span> <span class="description">Adding a Users resource to the routes file. <br /> <code>config/routes.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="no">SampleApp</span><span class="o">::</span><span class="no">Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">resources</span> <span class="ss">:users</span>

  <span class="n">match</span> <span class="s1">&#39;/signup&#39;</span><span class="p">,</span>  <span class="ss">:to</span> <span class="o">=&gt;</span> <span class="s1">&#39;users#new&#39;</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>After adding the routes for the Users resource, the URL <a href="http://localhost:3000/users/1"><tt>/users/1</tt></a> works perfectly (<a class="ref" href="modeling-and-viewing-users-one#fig:user_show_rails_3">illustration&nbsp;6.10</a>).</p>

<div class="label" id="fig:user_show_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_show_rails_3.png" alt="user_show_rails_3" /></span></div><div class="caption"><span class="header">Illustration 6.10: </span><span class="description">The user show page at  <a href="http://localhost:3000/users/1"><tt>/users/1</tt></a> after adding a Users resource.&nbsp;<a href="http://railstutorial.org/images/figures/user_show_rails_3-full.png">(taille normale)</a></span></div></div>


<p>You might have noticed that <a class="ref" href="modeling-and-viewing-users-one#code:users_resource">extrait&nbsp;6.26</a> removed the line</p>

<div class="code"><div class="highlight"><pre><span class="n">get</span> <span class="s2">&quot;users/new&quot;</span>
</pre></div>
</div>


<p>last seen in <a class="ref" href="filling-in-the-layout#code:signup_route">extrait&nbsp;5.29</a>. This is because the one additional resource line in <a class="ref" href="modeling-and-viewing-users-one#code:users_resource">extrait&nbsp;6.26</a> doesn&rsquo;t just add a working <tt>/users/1</tt> URL; it endows our sample application with all the actions needed for a RESTful Users resource,<sup class="footnote" id="fnref:6.25"><a href="#fn:6.25">25</a></sup> along with a large number of nomd routes (<a class="ref" href="filling-in-the-layout#sec:nomd_routes">section&nbsp;5.2.3</a>) for generating user URLs. The resulting correspondence of URLs, actions, and nomd routes is shown in <a class="ref" href="modeling-and-viewing-users-one#table:RESTful_users">Table&nbsp;6.2</a>. (Compare to <a class="ref" href="a-demo-app#table:demo_RESTful_users">Table&nbsp;2.2</a>.) Over the course of the next three chapters, we&rsquo;ll cover all of the other entries in <a class="ref" href="modeling-and-viewing-users-one#table:RESTful_users">Table&nbsp;6.2</a> as we fill in all the actions necessary to make Users a fully RESTful resource.</p>

<div class="label" id="table:RESTful_users"></div>


<div class="table"><div class="center"><table class="tabular"><tr><th class="align_left"><strong>HTTP request</strong></th><th class="align_left"><strong>URL</strong></th><th class="align_left"><strong>Action</strong></th><th class="align_left"><strong>Named route</strong></th><th class="align_left"><strong>Purpose</strong></th></tr><tr class="top_bar"><td class="align_left"><tt>GET</tt></td><td class="align_left"><tt>/users</tt></td><td class="align_left"><code>index</code></td><td class="align_left"><code>users_path</code></td><td class="align_left">page to list all users</td></tr><tr><td class="align_left"><tt>GET</tt></td><td class="align_left"><tt>/users/1</tt></td><td class="align_left"><code>show</code></td><td class="align_left"><code>user_path(1)</code></td><td class="align_left">page to show user with id <code>1</code></td></tr><tr><td class="align_left"><tt>GET</tt></td><td class="align_left"><tt>/users/new</tt></td><td class="align_left"><code>new</code></td><td class="align_left"><code>new_user_path</code></td><td class="align_left">page to make a new user (signup)</td></tr><tr><td class="align_left"><tt>POST</tt></td><td class="align_left"><tt>/users</tt></td><td class="align_left"><code>create</code></td><td class="align_left"><code>users_path</code></td><td class="align_left">create a new user</td></tr><tr><td class="align_left"><tt>GET</tt></td><td class="align_left"><tt>/users/1/edit</tt></td><td class="align_left"><code>edit</code></td><td class="align_left"><code>edit_user_path(1)</code></td><td class="align_left">page to edit user with id <code>1</code></td></tr><tr><td class="align_left"><tt>PUT</tt></td><td class="align_left"><tt>/users/1</tt></td><td class="align_left"><code>update</code></td><td class="align_left"><code>user_path(1)</code></td><td class="align_left">update user with id <code>1</code></td></tr><tr><td class="align_left"><tt>DELETE</tt></td><td class="align_left"><tt>/users/1</tt></td><td class="align_left"><code>destroy</code></td><td class="align_left"><code>user_path(1)</code></td><td class="align_left">delete user with id <code>1</code></td></tr></table></div><div class="caption"><span class="header">Table 6.2: </span><span class="description">RESTful routes provided by the Users resource in <a class="ref" href="modeling-and-viewing-users-one#code:users_resource">extrait&nbsp;6.26</a>.</span></div></div>




<div class="label" id="sec:params_in_debug"></div>


<h4><a id="sec:6.3.3.1" href="modeling-and-viewing-users-one#sec:params_in_debug" class="heading"><code>params</code> in <code>debug</code></a></h4>


<p>Before leaving the user show page, we&rsquo;ll take a moment to examine the debug information produced by <a class="ref" href="modeling-and-viewing-users-one#code:rails_debug">extrait&nbsp;6.23</a>. If you look closely at <a class="ref" href="modeling-and-viewing-users-one#fig:user_show_rails_3">illustration&nbsp;6.10</a>, you&rsquo;ll see that it includes useful information about the page being rendered:<sup class="footnote" id="fnref:6.26"><a href="#fn:6.26">26</a></sup></p>

<div class="code"><div class="highlight"><pre><span class="nn">---</span> <span class="kt">!map</span><span class="l-Scalar-Plain">:ActiveSupport::HashWithIndifferentAccess</span>
<span class="l-Scalar-Plain">action</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">show</span>
<span class="l-Scalar-Plain">id</span><span class="p-Indicator">:</span> <span class="s">&quot;1&quot;</span>
<span class="l-Scalar-Plain">controller</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">users</span>
</pre></div>
</div>


<p>This is a YAML<sup class="footnote" id="fnref:6.27"><a href="#fn:6.27">27</a></sup> representation of <code>params</code>, which (as hinted at by the nom <code>HashWithIndifferentAccess</code>) is basically a hash.  We see that its
controller is <code>users</code>, its action is <code>show</code>, and its <code>id</code> attribute is <code>"1"</code>. Although you will rarely have occasion to use <code>params[:controller]</code> or <code>params[:action]</code>, using <code>params[:id]</code> to pull out the&nbsp;id from the URL is a common Rails idiom. In particular, we used the code</p>

<div class="code"><div class="highlight"><pre><span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</pre></div>
</div>


<p>in <a class="ref" href="modeling-and-viewing-users-one#code:user_show_action">extrait&nbsp;6.25</a> to find the user with id&nbsp;<code>1</code>. (The <code>find</code> method knows how to convert the string&nbsp;<code>"1"</code> into the integer&nbsp;<code>1</code>.)</p>

<p>The <code>debug</code> information often provides useful feedback when developing Rails application, and I suggest getting in the habit of checking it whenever your application doesn&rsquo;t behave as expected.</p>

<h2><a id="sec:6.4" href="modeling-and-viewing-users-one#sec:6.4" class="heading"><span class="number">6.4</span> Conclusion</a></h2>


<p>This chapter is the first half of the two-step process of creating a working User model. Our users now have <code>nom</code> and <code>email</code> attributes, together with validations enforcing several important constraints on their values. We&rsquo;ve also taken a first small step toward a working user show page and a Users resource based on the principles of representational state transfer (REST). In <a class="ref" href="modeling-and-viewing-users-two#top">chapitre&nbsp;7</a>, we&rsquo;ll complete the process by adding user passwords and a more useful user view.</p>

<p>If you&rsquo;re using Git, now would be a good time to commit if you haven&rsquo;t done so in a while:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">&quot;Finished first cut of the User model&quot;</span>
</pre></div>
</div>


<h2><a id="sec:6.5" href="modeling-and-viewing-users-one#sec:6.5" class="heading"><span class="number">6.5</span> Exercises</a></h2>




<ol>
<li>Read through the Rails API entry for <code>ActiveRecord::Base</code> to get a sense of its capabilities.</li>
<li>Study the entry in the Rails API for the <code>validates</code> method to learn more about its capabilities and options.</li>
<li>Spend a couple hours playing with <a href="http://www.rubular.com/">Rubular</a>.</li>

</ol>




<div class="navigation">  <a class="prev_page" href="filling-in-the-layout#top">
    &laquo;&nbsp;<span class="number">chapitre 5</span> Filling in the layout
  </a>
  <a class="next_page" href="modeling-and-viewing-users-two#top">
    <span class="number">chapitre 7</span> Modeling and viewing users, part II&nbsp;&raquo;
  </a>
</div><div class="footnotes">
<ol>
<li id="fn:6.1"><a href="http://gomockingbird.com/">Mockingbird</a> doesn&rsquo;t support custom images like the profile photo in <a class="ref" href="modeling-and-viewing-users-one#fig:profile_mockup">illustration&nbsp;6.1</a>; I put that in by hand using <a href="http://www.adobe.com/products/fireworks/">Adobe Fireworks</a>. The hippo here is from <a href="http://www.flickr.com/photos/43803060@N00/24308857/">http://www.flickr.com/photos/43803060@N00/24308857/</a>.&nbsp;<a class="arrow" href="#fnref:6.1">&uarr;</a></li>
<li id="fn:6.2">Ce nom (Active Record) vient de la &ldquo;<a href="http://en.wikipedia.org/wiki/Active_record_pattern">pattern active record</a>&rdquo;, identifiée et nommée dans <em>Patterns of Enterprise Application Architecture</em> par Martin Fowler.&nbsp;<a class="arrow" href="#fnref:6.2">&uarr;</a></li>
<li id="fn:6.3">Proconcé &ldquo;ess-quiou-elle&rdquo;, bien que la prononciation alternative &ldquo;sequel&rdquo; (en anglais) est aussi courante.&nbsp;<a class="arrow" href="#fnref:6.3">&uarr;</a></li>
<li id="fn:6.4">Dans ses toutes premières incarnations, Rails requiérait la connaissance des DLL de SQL. Même après que Rails eut ajouté les migrations,  Even after Rails added migrations, mettre en place l'ancien base de données par défaut (MySQL) était nécessaire. Heureusement, comme noté à la <a class="ref" href="beginning#sec:rails_server">section&nbsp;1.2.5</a>, Rails utilise maintenant SQLite par défaut, ce qui enregistre les données sous la forme de simples fichiers &mdash;&nbsp;aucun réglage n'est nécessaire.&nbsp;<a class="arrow" href="#fnref:6.4">&uarr;</a></li>
<li id="fn:6.5">Occasionally, it is necessary to pierce this abstraction layer, but one design goal of this tutorial is to make all the code database-independent. (Indeed, this is a worthy goal in general.) In case you ever do need to write database-specific code to deploy on Heroku, you should know that they use the excellent <a href="http://www.postgresql.org/">PostgreSQL</a> (&ldquo;post-gres-cue-ell&rdquo;) database. PostgreSQL is free, open-source, and cross-platform; if you develop PostgreSQL-specific applications, you can install it locally, and configure Rails to use it in development by editing the <code>config/database.yml</code> file. Such configuration is beyond the scope of this tutorial, but there are lots of resources on the web; use a search engine to find the most up-to-date information for your platform.&nbsp;<a class="arrow" href="#fnref:6.5">&uarr;</a></li>
<li id="fn:6.6">En utilisant une adresse email comme <em>username</em>, nous offrons la possibilité théorique de communiquer avec nos utilisateuers dans le futur.&nbsp;<a class="arrow" href="#fnref:6.6">&uarr;</a></li>
<li id="fn:6.7">Ne vous souciez pas de comment l'objet <code>t</code> s'arrange exactement pour faire ça&nbsp;; la beauté des <em>couches d'abstraction</em> tient à ce que nous n'avons pas besoin de le savoir. Nous pouvons juste faire confiance à l'objet&nbsp;<code>t</code> pour faire son travail.&nbsp;<a class="arrow" href="#fnref:6.7">&uarr;</a></li>
<li id="fn:6.8">We&rsquo;ll see how to migrate up on a remote Heroku server in <a class="ref" href="modeling-and-viewing-users-two#sec:heroku_deploy">section&nbsp;7.4.2</a>.&nbsp;<a class="arrow" href="#fnref:6.8">&uarr;</a></li>
<li id="fn:6.9">Officially pronounced &ldquo;ess-cue-ell-ite&rdquo;, although the (mis)pronunciation &ldquo;sequel-ite&rdquo; is also common.&nbsp;<a class="arrow" href="#fnref:6.9">&uarr;</a></li>
<li id="fn:6.10">Dans le cas où vous seriez surpris par <code>"2010-01-05 00:57:46"</code>, je n'ai pas écrit ce code après minuit&nbsp;; les <em>timestamps</em> sont enregistrés en <a href="http://en.wikipedia.org/wiki/Coordinated_Universal_Time">Coordonnées de Temps Unversel</a> (UTC), qui pour la plupart des propos est le même que le <a href="http://en.wikipedia.org/wiki/Greenwich_Mean_Time">Temps de Greenwich</a>. Tiré du <a href="http://tf.nist.gov/general/misc.htm">NIST Time and Frequency FAQ</a>:   <strong>Question&nbsp;:</strong> Pourquoi UTC est utilisé comme acronyme de <em>Coordinated Universal Time</em> plutôt que CUT&nbsp;? <strong>Réponse&nbsp;:</strong> En 1970 le système <em>Coordinated Universal Time</em> a été conçu par un groupe consultatif d'experts internationaux à l'intérieur de l'Union Internationale de Communication (International Telecommunication Union, ITU). l'ITU a pensé qu'il serait mieux d'utiliser une simple abréviation pour l'usage dans tous les langages dans le but de minimiser la confusion. Puisqu'aucun accord unanime n'a pu être trouvé sur l'utilisation de soit l'ordre des mots anglais, CUT, soit l'ordre des mots français, TUC, l'acronyme UTC a utilisé en guise de compromis.&nbsp;<a class="arrow" href="#fnref:6.10">&uarr;</a></li>
<li id="fn:6.11">Notez la valeur de <code>user.updated_at</code>. Dites-vous bien que le timestamp était en UTC.&nbsp;<a class="arrow" href="#fnref:6.11">&uarr;</a></li>
<li id="fn:6.12">Exceptions and exception handling are somewhat advanced Ruby subjects, and we won&rsquo;t need them much in this book. They are important, though, and I suggest learning about them using one of the Ruby books recommended in <a class="ref" href="beginning#sec:comments_for_various_readers">section&nbsp;1.1.1</a>.&nbsp;<a class="arrow" href="#fnref:6.12">&uarr;</a></li>
<li id="fn:6.13">To those worried that <code>find_by_email</code> will be inefficient if there are a large number of users, you&rsquo;re ahead of the game. We&rsquo;ll cover this issue, and its solution via database indices, in <a class="ref" href="modeling-and-viewing-users-one#sec:uniqueness_validation">section&nbsp;6.2.4</a>.&nbsp;<a class="arrow" href="#fnref:6.13">&uarr;</a></li>
<li id="fn:6.14">(and written)&nbsp;<a class="arrow" href="#fnref:6.14">&uarr;</a></li>
<li id="fn:6.15">I&rsquo;ll omit the output of console commands when they are not particularly instructive&mdash;for example, the results of <code>User.new</code>.&nbsp;<a class="arrow" href="#fnref:6.15">&uarr;</a></li>
<li id="fn:6.16">Note that, in <a class="ref" href="modeling-and-viewing-users-one#table:email_regex">Table&nbsp;6.1</a>, &ldquo;letter&rdquo; really means &ldquo;lower-case letter&rdquo;, but the <code>i</code> at the end of the regex enforces case-insensitive matching.&nbsp;<a class="arrow" href="#fnref:6.16">&uarr;</a></li>
<li id="fn:6.17">If you find it as useful as I do, I encourage you to <a href="http://bit.ly/donate-to-rubular">donate to Rubular</a> to reward developer <a href="http://lovitt.net/">Michael Lovitt</a> for his wonderful work.&nbsp;<a class="arrow" href="#fnref:6.17">&uarr;</a></li>
<li id="fn:6.18">Did you know that <code>"Michael Hartl"@example.com</code>, with quotation marks and a space in the middle, is a valid email address according to the standard? Incredibly, it is&mdash;but it&rsquo;s absurd. If you don&rsquo;t have an email address that contains only letters, numbers, underscores, and dots, then get one. N.B. The regex in <a class="ref" href="modeling-and-viewing-users-one#code:validates_format_of_email">extrait&nbsp;6.17</a> allows plus signs, too, because Gmail (and possibly other email services) does something useful with them:  for example, to filter orders from Amazon, you can use <tt>username+amazon@gmail.com</tt>, which will go to the Gmail address <tt>username@gmail.com</tt>, allowing you to filter on the string <tt>amazon</tt>.&nbsp;<a class="arrow" href="#fnref:6.18">&uarr;</a></li>
<li id="fn:6.19">As noted briefly in the introduction to this section, there is a dedicated test database, <code>db/test.sqlite3</code>, for this purpose.&nbsp;<a class="arrow" href="#fnref:6.19">&uarr;</a></li>
<li id="fn:6.20">If you&rsquo;re wondering why the <code>create!</code> line in <a class="ref" href="modeling-and-viewing-users-one#code:raw_user_spec">extrait&nbsp;6.10</a> doesn&rsquo;t cause this to fail by creating a duplicate user, it&rsquo;s because Rails tests are <em>transactional</em>: each test is wrapped in a <a href="http://en.wikipedia.org/wiki/Database_transaction">transaction</a>, which <em>rolls back</em> the database after the test executes. This way, each test runs against a fresh database.&nbsp;<a class="arrow" href="#fnref:6.20">&uarr;</a></li>
<li id="fn:6.21">Yes, it happened to me. How do you think I found out about this issue?&nbsp;<a class="arrow" href="#fnref:6.21">&uarr;</a></li>
<li id="fn:6.22">Of course, we could just edit the migration file for the <code>users</code> table in <a class="ref" href="modeling-and-viewing-users-one#code:users_migration">extrait&nbsp;6.2</a> but that would require rolling back and then migrating back up. The Rails Way is to use migrations every time we discover that our data model needs to change.&nbsp;<a class="arrow" href="#fnref:6.22">&uarr;</a></li>
<li id="fn:6.23">You can define your own custom environments as well; see the <a href="http://railscasts.com/episodes/72-adding-an-environment">Railscast on adding an environment</a> for details.&nbsp;<a class="arrow" href="#fnref:6.23">&uarr;</a></li>
<li id="fn:6.24">Fielding, Roy Thomas. <em>Architectural Styles and the Design of Network-based Software Architectures</em>. Doctoral dissertation, University of California, Irvine, 2000.&nbsp;<a class="arrow" href="#fnref:6.24">&uarr;</a></li>
<li id="fn:6.25">This means that the <em>routing</em> works, but the corresponding pages don&rsquo;t necessarily work at this point. For example, <tt>/users/1/edit</tt> gets routed properly to the <code>edit</code> action of the Users controller, but since the <code>edit</code> action doesn&rsquo;t exist yet actually hitting that URL will return an error.&nbsp;<a class="arrow" href="#fnref:6.25">&uarr;</a></li>
<li id="fn:6.26">Some of this tutorial&rsquo;s screenshots show debug information with output like <code>!map:HashWithIndifferentAccess</code> instead of <code>!map:ActiveSupport::HashWithIndifferentAccess</code>. This is simply a minor difference between Rails&nbsp;2.3 and Rails&nbsp;3. Since the rendered web pages are otherwise identical between Rails versions, this one footnote saves me the trouble of redoing all the screenshots.&nbsp;<a class="arrow" href="#fnref:6.26">&uarr;</a></li>
<li id="fn:6.27">The Rails <code>debug</code> information is shown as <a href="http://www.yaml.org/">YAML</a> (a <a href="http://catb.org/jargon/html/R/recursive-acronym.html">recursive acronym</a> standing for &ldquo;YAML Ain&rsquo;t Markup Language&rdquo;), which is a friendly data format designed to be both machine- <em>and</em> human-readable.&nbsp;<a class="arrow" href="#fnref:6.27">&uarr;</a></li>
</ol>
</div>




