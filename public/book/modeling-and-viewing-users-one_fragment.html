

<h1 class="title">Tutoriel Ruby on Rails </h1>


<h1 class="subtitle">  Apprendre Rails par l'exemple</h1>


<h2 class="author">Michael Hartl</h2>




<h1 class="contents">Contenu</h1>


<div id="table_of_contents"><ol>
<li class="chapter"><a href="beginning#top"><span class="number">Chapitre 1</span> De zéro au déploiement</a></li>
<li><ol>
<li class="section"><a href="beginning#sec:introduction"><span class="number">1.1</span> Introduction</a></li>
<li><ol>
<li class="subsection"><a href="beginning#sec:comments_for_various_readers"><span class="number">1.1.1</span> Commentaires pour les lecteurs différents</a></li>
<li class="subsection"><a href="beginning#sec:1.1.2"><span class="number">1.1.2</span> &ldquo;Dimensionner&rdquo; Rails</a></li>
<li class="subsection"><a href="beginning#sec:conventions"><span class="number">1.1.3</span> Conventions utilisées dans ce livre</a></li></ol></li>
<li class="section"><a href="beginning#sec:up_and_running"><span class="number">1.2</span> [(Up and running)(En route pour le démarrage)]</a></li>
<li><ol>
<li class="subsection"><a href="beginning#sec:development_tools"><span class="number">1.2.1</span> Environnements de développement</a></li>
<li><ol>
<li class="subsubsection"><a href="beginning#sec:1.2.1.1">IDEs</a></li>
<li class="subsubsection"><a href="beginning#sec:1.2.1.2">Éditeurs de texte et lignes de commande</a></li>
<li class="subsubsection"><a href="beginning#sec:1.2.1.3">Navigateurs</a></li>
<li class="subsubsection"><a href="beginning#sec:1.2.1.4">Note à propos des outils</a></li></ol></li>
<li class="subsection"><a href="beginning#sec:rubygems"><span class="number">1.2.2</span> Ruby, RubyGems, Rails, et Git</a></li>
<li><ol>
<li class="subsubsection"><a href="beginning#sec:rails_installer_windows">Installation de Rails (Windows)</a></li>
<li class="subsubsection"><a href="beginning#sec:install_git">Installer Git</a></li>
<li class="subsubsection"><a href="beginning#sec:install_ruby">Installer Ruby</a></li>
<li class="subsubsection"><a href="beginning#sec:install_rubygems">Installer RubyGems</a></li>
<li class="subsubsection"><a href="beginning#sec:install_rails">Installer Rails</a></li></ol></li>
<li class="subsection"><a href="beginning#sec:the_first_application"><span class="number">1.2.3</span> La première application</a></li>
<li class="subsection"><a href="beginning#sec:bundler"><span class="number">1.2.4</span> Bundler</a></li>
<li class="subsection"><a href="beginning#sec:rails_server"><span class="number">1.2.5</span> <code>Le serveur rails (rails server)</code></a></li>
<li class="subsection"><a href="beginning#sec:mvc"><span class="number">1.2.6</span> Modèles-Vue-Contrôleur (MVC)</a></li></ol></li>
<li class="section"><a href="beginning#sec:version_control"><span class="number">1.3</span> Contrôle de versions avec Git</a></li>
<li><ol>
<li class="subsection"><a href="beginning#sec:git_setup"><span class="number">1.3.1</span> Installation et réglages</a></li>
<li><ol>
<li class="subsubsection"><a href="beginning#sec:1.3.1.1">Initialisation des réglages système</a></li>
<li class="subsubsection"><a href="beginning#sec:1.3.1.2">Initialisation des réglages du dépôt (repository)</a></li></ol></li>
<li class="subsection"><a href="beginning#sec:adding_and_committing"><span class="number">1.3.2</span> Ajout et mandat de dépôt</a></li>
<li class="subsection"><a href="beginning#sec:1.3.3"><span class="number">1.3.3</span> Qu'est-ce que Git peut faire de bien pour vous&nbsp;?</a></li>
<li class="subsection"><a href="beginning#sec:github"><span class="number">1.3.4</span> GitHub</a></li>
<li class="subsection"><a href="beginning#sec:git_commands"><span class="number">1.3.5</span> Branch, edit, commit, merge</a></li>
<li><ol>
<li class="subsubsection"><a href="beginning#sec:git_branch">Branch</a></li>
<li class="subsubsection"><a href="beginning#sec:git_edit">Edit</a></li>
<li class="subsubsection"><a href="beginning#sec:git_commit">Commit</a></li>
<li class="subsubsection"><a href="beginning#sec:git_merge">Merge</a></li>
<li class="subsubsection"><a href="beginning#sec:git_push">Push</a></li></ol></li></ol></li>
<li class="section"><a href="beginning#sec:deploying"><span class="number">1.4</span> Déploiement</a></li>
<li><ol>
<li class="subsection"><a href="beginning#sec:1.4.1"><span class="number">1.4.1</span> Réglages Heroku</a></li>
<li class="subsection"><a href="beginning#sec:heroku_step_one"><span class="number">1.4.2</span> déploiement Heroku, première étape</a></li>
<li class="subsection"><a href="beginning#sec:1.4.3"><span class="number">1.4.3</span> Déploiement Heroku deployment, seconde étape</a></li>
<li class="subsection"><a href="beginning#sec:heroku_commands"><span class="number">1.4.4</span> Commandes Heroku</a></li></ol></li>
<li class="section"><a href="beginning#sec:beginning_conclusion"><span class="number">1.5</span> Conclusion</a></li></ol></li>
<li class="chapter"><a href="a-demo-app#top"><span class="number">Chapitre 2</span> Une application démo</a></li>
<li><ol>
<li class="section"><a href="a-demo-app#sec:planning_the_application"><span class="number">2.1</span> Planifier l'application</a></li>
<li><ol>
<li class="subsection"><a href="a-demo-app#sec:modeling_users"><span class="number">2.1.1</span> Modéliser les utilisateurs</a></li>
<li class="subsection"><a href="a-demo-app#sec:modeling_microposts"><span class="number">2.1.2</span> Modéliser les micro-messages</a></li></ol></li>
<li class="section"><a href="a-demo-app#sec:demo_users_resource"><span class="number">2.2</span> La ressource Utilisateurs (Users)</a></li>
<li><ol>
<li class="subsection"><a href="a-demo-app#sec:a_user_tour"><span class="number">2.2.1</span> Un tour de l'utilisateur</a></li>
<li class="subsection"><a href="a-demo-app#sec:mvc_in_action"><span class="number">2.2.2</span> MVC en action</a></li>
<li class="subsection"><a href="a-demo-app#sec:weaknesses_of_this_users_resource"><span class="number">2.2.3</span> Faiblesses de la ressource Utilisateurs (Users)</a></li></ol></li>
<li class="section"><a href="a-demo-app#sec:microposts_resource"><span class="number">2.3</span> La ressource Micro-messages (Microposts)</a></li>
<li><ol>
<li class="subsection"><a href="a-demo-app#sec:a_micropost_microtour"><span class="number">2.3.1</span> Un petit tour du micro-message</a></li>
<li class="subsection"><a href="a-demo-app#sec:putting_the_micro_in_microposts"><span class="number">2.3.2</span> Appliquer le <em>micro</em> aux micro-messages</a></li>
<li class="subsection"><a href="a-demo-app#sec:demo_user_has_many_microposts"><span class="number">2.3.3</span> Un utilisateur <code>has_many</code> (<code>possède plusieurs</code>) micro-messages</a></li>
<li class="subsection"><a href="a-demo-app#sec:inheritance_hierarchies"><span class="number">2.3.4</span> Hiérarchie des héritages</a></li>
<li class="subsection"><a href="a-demo-app#sec:deploying_the_demo_app"><span class="number">2.3.5</span> Déployer l'application Démo</a></li></ol></li>
<li class="section"><a href="a-demo-app#sec:2.4"><span class="number">2.4</span> Conclusion</a></li></ol></li>
<li class="chapter"><a href="static-pages#top"><span class="number">Chapitre 3</span> Pages statiques courantes</a></li>
<li><ol>
<li class="section"><a href="static-pages#sec:static_pages"><span class="number">3.1</span> Pages statiques</a></li>
<li><ol>
<li class="subsection"><a href="static-pages#sec:truly_static_pages"><span class="number">3.1.1</span> Pages HTML statiques</a></li>
<li class="subsection"><a href="static-pages#sec:static_pages_with_rails"><span class="number">3.1.2</span> Les pages statiques avec Rails</a></li></ol></li>
<li class="section"><a href="static-pages#sec:first_tests"><span class="number">3.2</span> Premiers tests</a></li>
<li><ol>
<li class="subsection"><a href="static-pages#sec:testing_tools"><span class="number">3.2.1</span> Outils de test</a></li>
<li><ol>
<li class="subsubsection"><a href="static-pages#sec:autotest">Auto-test</a></li></ol></li>
<li class="subsection"><a href="static-pages#sec:TDD"><span class="number">3.2.2</span> TDD : Rouge, Vert, Refactor</a></li>
<li><ol>
<li class="subsubsection"><a href="static-pages#sec:spork">Spork</a></li>
<li class="subsubsection"><a href="static-pages#sec:red">Rouge</a></li>
<li class="subsubsection"><a href="static-pages#sec:green">Vert</a></li>
<li class="subsubsection"><a href="static-pages#sec:refactor">Refactor</a></li></ol></li></ol></li>
<li class="section"><a href="static-pages#sec:slightly_dynamic_pages"><span class="number">3.3</span> Pages (un peu) dynamiques</a></li>
<li><ol>
<li class="subsection"><a href="static-pages#sec:testing_a_title_change"><span class="number">3.3.1</span> Test d'un changement de titre</a></li>
<li class="subsection"><a href="static-pages#sec:passing_title_tests"><span class="number">3.3.2</span> Réussir les tests de titre</a></li>
<li class="subsection"><a href="static-pages#sec:instance_variables_embedded_ruby"><span class="number">3.3.3</span> Variables d'instance et Ruby embarqué</a></li>
<li class="subsection"><a href="static-pages#sec:layouts"><span class="number">3.3.4</span> Supprimer les répétitions avec les <em>layouts</em></a></li></ol></li>
<li class="section"><a href="static-pages#sec:static_pages_conclusion"><span class="number">3.4</span> Conclusion</a></li>
<li class="section"><a href="static-pages#sec:static_pages_Exercices"><span class="number">3.5</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="rails-flavored-ruby#top"><span class="number">Chapitre 4</span> [(Rails-flavored Ruby)(Rails au goût Ruby)]</a></li>
<li><ol>
<li class="section"><a href="rails-flavored-ruby#sec:motivation"><span class="number">4.1</span> Motivation</a></li>
<li><ol>
<li class="subsection"><a href="rails-flavored-ruby#sec:title_helper"><span class="number">4.1.1</span> Un « helper » (« aideur ») pour le titre (<code>title</code>)</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:cascading_style_sheets"><span class="number">4.1.2</span> Feuilles de styles (CSS — Cascading Style Sheets)</a></li></ol></li>
<li class="section"><a href="rails-flavored-ruby#sec:strings_and_methods"><span class="number">4.2</span> Chaines de caractères et méthodes</a></li>
<li><ol>
<li class="subsection"><a href="rails-flavored-ruby#sec:comments"><span class="number">4.2.1</span> Commentaires</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:strings"><span class="number">4.2.2</span> Chaines de caractères</a></li>
<li><ol>
<li class="subsubsection"><a href="rails-flavored-ruby#sec:printing">Impression</a></li>
<li class="subsubsection"><a href="rails-flavored-ruby#sec:single_quoted_strings">Chaines de caractères « single-quoté »</a></li></ol></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:objects_and_message_passing"><span class="number">4.2.3</span> Objets et passage de message</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:method_definitions"><span class="number">4.2.4</span> Définition de méthode</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:back_to_the_title_helper"><span class="number">4.2.5</span> Retour à l'« helper » de titre</a></li></ol></li>
<li class="section"><a href="rails-flavored-ruby#sec:other_data_structures"><span class="number">4.3</span> Autres structures de données</a></li>
<li><ol>
<li class="subsection"><a href="rails-flavored-ruby#sec:arrays_and_ranges"><span class="number">4.3.1</span> Tableaux et rangs</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:blocks"><span class="number">4.3.2</span> Blocs</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:hashes_and_symbols"><span class="number">4.3.3</span> Tables de hachage et symboles</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:css_revisited"><span class="number">4.3.4</span> CSS revisitées</a></li></ol></li>
<li class="section"><a href="rails-flavored-ruby#sec:ruby_classes"><span class="number">4.4</span> Classes Ruby</a></li>
<li><ol>
<li class="subsection"><a href="rails-flavored-ruby#sec:constructors"><span class="number">4.4.1</span> Constructeurs</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:a_class_of_our_own"><span class="number">4.4.2</span> Héritages de classes</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:modifying_built_in_classes"><span class="number">4.4.3</span> Modifier les classes d'origine</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:a_controller_class"><span class="number">4.4.4</span> Classe de contrôleur</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:a_user_class"><span class="number">4.4.5</span> Classe utiliateur</a></li></ol></li>
<li class="section"><a href="rails-flavored-ruby#sec:Exercices"><span class="number">4.5</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="filling-in-the-layout#top"><span class="number">Chapitre 5</span> Poursuivre la mise en page</a></li>
<li><ol>
<li class="section"><a href="filling-in-the-layout#sec:structure"><span class="number">5.1</span> Ajout de structure</a></li>
<li><ol>
<li class="subsection"><a href="filling-in-the-layout#sec:adding_to_the_layout"><span class="number">5.1.1</span> Navigation du site</a></li>
<li class="subsection"><a href="filling-in-the-layout#sec:custom_css"><span class="number">5.1.2</span> Personnalisation CSS</a></li>
<li class="subsection"><a href="filling-in-the-layout#sec:partials"><span class="number">5.1.3</span> Partiels (Partials)</a></li></ol></li>
<li class="section"><a href="filling-in-the-layout#sec:layout_links"><span class="number">5.2</span> Liens pour la mise en page</a></li>
<li><ol>
<li class="subsection"><a href="filling-in-the-layout#sec:integration_tests"><span class="number">5.2.1</span> Test d'intégration</a></li>
<li class="subsection"><a href="filling-in-the-layout#sec:rails_routes"><span class="number">5.2.2</span> Routes Rails</a></li>
<li class="subsection"><a href="filling-in-the-layout#sec:nomd_routes"><span class="number">5.2.3</span> Nommer les routes</a></li></ol></li>
<li class="section"><a href="filling-in-the-layout#sec:user_signup"><span class="number">5.3</span> Inscription de l'utilisateur : une première étape</a></li>
<li><ol>
<li class="subsection"><a href="filling-in-the-layout#sec:users_controller"><span class="number">5.3.1</span> Contrôleur Utilisateur (Users controller)</a></li>
<li class="subsection"><a href="filling-in-the-layout#sec:signup_url"><span class="number">5.3.2</span> URL d'inscription</a></li></ol></li>
<li class="section"><a href="filling-in-the-layout#sec:layout_conclusion"><span class="number">5.4</span> Conclusion</a></li>
<li class="section"><a href="filling-in-the-layout#sec:layout_Exercices"><span class="number">5.5</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="modeling-and-viewing-users-one#top"><span class="number">Chapitre 6</span> Modéliser et afficher les utilisateurs, partie I</a></li>
<li><ol>
<li class="section"><a href="modeling-and-viewing-users-one#sec:user_model"><span class="number">6.1</span> Modèle utilisateur (User model)</a></li>
<li><ol>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:database_migrations"><span class="number">6.1.1</span> Migrations de la base de données</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:the_model_file"><span class="number">6.1.2</span> Le fichier modèle</a></li>
<li><ol>
<li class="subsubsection"><a href="modeling-and-viewing-users-one#sec:model_annotation">[(Model annotation)]</a></li>
<li class="subsubsection"><a href="modeling-and-viewing-users-one#sec:accessible_attributes">Attributs accessibles</a></li></ol></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:creating_user_objects"><span class="number">6.1.3</span> Créer des objets Utilisateur</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:finding_user_objects"><span class="number">6.1.4</span> Recherche dans les objets Utilisateurs (Users)</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:updating_user_objects"><span class="number">6.1.5</span> Actualisation des objets Utilisateurs (Users)</a></li></ol></li>
<li class="section"><a href="modeling-and-viewing-users-one#sec:user_validations"><span class="number">6.2</span> Validations utilisateur</a></li>
<li><ol>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:presence_validation"><span class="number">6.2.1</span> Valider l'existence</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:length_validation"><span class="number">6.2.2</span> Valider la longueur</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:format_validation"><span class="number">6.2.3</span> Valider le format</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:uniqueness_validation"><span class="number">6.2.4</span> Valider l'unicité</a></li>
<li><ol>
<li class="subsubsection"><a href="modeling-and-viewing-users-one#sec:the_caveat">L'avertissement d'unicité</a></li></ol></li></ol></li>
<li class="section"><a href="modeling-and-viewing-users-one#sec:viewing_users"><span class="number">6.3</span> Afficher les utilisateurs</a></li>
<li><ol>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:rails_environments"><span class="number">6.3.1</span> Débuggage et environnements Rails</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:users_show"><span class="number">6.3.2</span> Modèle, Vue et Contrôleur Utilisateur</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:a_users_resource"><span class="number">6.3.3</span> Ressource Utilisateurs</a></li>
<li><ol>
<li class="subsubsection"><a href="modeling-and-viewing-users-one#sec:params_in_debug">[(<code>params</code> in <code>debug</code>)]</a></li></ol></li></ol></li>
<li class="section"><a href="modeling-and-viewing-users-one#sec:6.4"><span class="number">6.4</span> Conclusion</a></li>
<li class="section"><a href="modeling-and-viewing-users-one#sec:6.5"><span class="number">6.5</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="modeling-and-viewing-users-two#top"><span class="number">Chapitre 7</span> Modéliser et afficher les utilisateurs, partie II</a></li>
<li><ol>
<li class="section"><a href="modeling-and-viewing-users-two#sec:insecure_passwords"><span class="number">7.1</span> Mots de passe non sûrs</a></li>
<li><ol>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:password_validations"><span class="number">7.1.1</span> Valider le mot de passe</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:password_migration"><span class="number">7.1.2</span> Migrer un mot de passe</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:an_active_record_callback"><span class="number">7.1.3</span> Un <em>callback</em> de l'Active Record</a></li></ol></li>
<li class="section"><a href="modeling-and-viewing-users-two#sec:secure_passwords"><span class="number">7.2</span> Sécuriser les mots de passe</a></li>
<li><ol>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:a_secure_password_test"><span class="number">7.2.1</span> Test de mot de passe sûr</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:secure_password_theory"><span class="number">7.2.2</span> Un peu de théorie sur les mots de passe sécurisés</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:implementing_has_password"><span class="number">7.2.3</span> Implémenter la méthode <code>has_password?</code></a></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:an_authenticate_method"><span class="number">7.2.4</span> Méthode d'authentification</a></li></ol></li>
<li class="section"><a href="modeling-and-viewing-users-two#sec:better_user_views"><span class="number">7.3</span> Meilleures vues d'utilisateurs</a></li>
<li><ol>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:tests_with_factories"><span class="number">7.3.1</span> Tester la page de l'utilisateur (avec factories)</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:a_nom_and_a_gravatar"><span class="number">7.3.2</span> Un nom et un Gravatar</a></li>
<li><ol>
<li class="subsubsection"><a href="modeling-and-viewing-users-two#sec:a_gravatar_helper">Un « helper » de Gravatar</a></li></ol></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:a_user_sidebar"><span class="number">7.3.3</span> Une barre utilisateur latérale</a></li></ol></li>
<li class="section"><a href="modeling-and-viewing-users-two#sec:7.4"><span class="number">7.4</span> Conclusion</a></li>
<li><ol>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:7.4.1"><span class="number">7.4.1</span> Commit Git</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:heroku_deploy"><span class="number">7.4.2</span> Déploiement Heroku</a></li></ol></li>
<li class="section"><a href="modeling-and-viewing-users-two#sec:more_modeling_users_Exercices"><span class="number">7.5</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="sign-up#top"><span class="number">Chapitre 8</span> Inscription</a></li>
<li><ol>
<li class="section"><a href="sign-up#sec:signup_form"><span class="number">8.1</span> Formulaire d'inscription</a></li>
<li><ol>
<li class="subsection"><a href="sign-up#sec:using_form_for"><span class="number">8.1.1</span> Utiliser  <code>form_for</code></a></li>
<li class="subsection"><a href="sign-up#sec:the_form_html"><span class="number">8.1.2</span> Le formulaire HTML</a></li></ol></li>
<li class="section"><a href="sign-up#sec:signup_failure"><span class="number">8.2</span> Échec de l'inscription</a></li>
<li><ol>
<li class="subsection"><a href="sign-up#sec:testing_failure"><span class="number">8.2.1</span> Test de l'échec</a></li>
<li class="subsection"><a href="sign-up#sec:a_working_form"><span class="number">8.2.2</span> Un formulaire fonctionnel</a></li>
<li class="subsection"><a href="sign-up#sec:signup_error_messages"><span class="number">8.2.3</span> Inscription&nbsp;: messages d'erreur</a></li>
<li class="subsection"><a href="sign-up#sec:filtering_parameter_logging"><span class="number">8.2.4</span> Filtrage des paramètres d'identification</a></li></ol></li>
<li class="section"><a href="sign-up#sec:signup_success"><span class="number">8.3</span> Succès de l'inscription</a></li>
<li><ol>
<li class="subsection"><a href="sign-up#sec:testing_success"><span class="number">8.3.1</span> Tester le succès de l'inscription</a></li>
<li class="subsection"><a href="sign-up#sec:the_finished_signup_form"><span class="number">8.3.2</span> Le formulaire d'inscription finalisé</a></li>
<li class="subsection"><a href="sign-up#sec:the_flash"><span class="number">8.3.3</span> Le message «&nbsp;flash&nbsp;»</a</a></li>
<li class="subsection"><a href="sign-up#sec:the_first_signup"><span class="number">8.3.4</span> La première inscription</a></li></ol></li>
<li class="section"><a href="sign-up#sec:rspec_integration_tests"><span class="number">8.4</span> Test d'intégration RSpec</a></li>
<li><ol>
<li class="subsection"><a href="sign-up#sec:integration_tests_with_style"><span class="number">8.4.1</span> Tests d'intégration avec les styles</a></li>
<li class="subsection"><a href="sign-up#sec:failed_signup"><span class="number">8.4.2</span> Un échec d'inscription ne devrait pas créer un nouvel utilisateur</a></li>
<li class="subsection"><a href="sign-up#sec:successful_signup"><span class="number">8.4.3</span> Le succès d'une inscription devrait créer un nouvel utilisateur</a></li></ol></li>
<li class="section"><a href="sign-up#sec:8.5"><span class="number">8.5</span> Conclusion</a></li>
<li class="section"><a href="sign-up#sec:signup_Exercices"><span class="number">8.6</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="sign-in-sign-out#top"><span class="number">Chapitre 9</span> Connexion, déconnexion</a></li>
<li><ol>
<li class="section"><a href="sign-in-sign-out#sec:sessions"><span class="number">9.1</span> Les sessions</a></li>
<li><ol>
<li class="subsection"><a href="sign-in-sign-out#sec:sessions_controller"><span class="number">9.1.1</span> Le contrôleur de session</a></li>
<li class="subsection"><a href="sign-in-sign-out#sec:signin_form"><span class="number">9.1.2</span> Formulaire d'identification</a></li></ol></li>
<li class="section"><a href="sign-in-sign-out#sec:signin_failure"><span class="number">9.2</span> Échec de l'identification</a></li>
<li><ol>
<li class="subsection"><a href="sign-in-sign-out#sec:reviewing_form_submission"><span class="number">9.2.1</span> Examen de la soumission du formulaire</a></li>
<li class="subsection"><a href="sign-in-sign-out#sec:failed_signin"><span class="number">9.2.2</span> Échec de l'identification (test et code)</a></li></ol></li>
<li class="section"><a href="sign-in-sign-out#sec:signin_success"><span class="number">9.3</span> Succès de l'identification</a></li>
<li><ol>
<li class="subsection"><a href="sign-in-sign-out#sec:the_completed_create_action"><span class="number">9.3.1</span> L'action <code>create</code> («&nbsp;créer&nbsp;») finalisée</a></li>
<li class="subsection"><a href="sign-in-sign-out#sec:remember_me"><span class="number">9.3.2</span> Se souvenir de moi</a></li>
<li class="subsection"><a href="sign-in-sign-out#sec:current_user"><span class="number">9.3.3</span> Utilisateur courant</a></li></ol></li>
<li class="section"><a href="sign-in-sign-out#sec:signing_out"><span class="number">9.4</span> Déconnexion</a></li>
<li><ol>
<li class="subsection"><a href="sign-in-sign-out#sec:destroying_sessions"><span class="number">9.4.1</span> Détruire la session</a></li>
<li class="subsection"><a href="sign-in-sign-out#sec:signin_upon_signup"><span class="number">9.4.2</span> Connection à l'inscription</a></li>
<li class="subsection"><a href="sign-in-sign-out#sec:changing_the_layout_links"><span class="number">9.4.3</span> Changement des liens de la mise en plage</a></li>
<li class="subsection"><a href="sign-in-sign-out#sec:signin_out_integration_tests"><span class="number">9.4.4</span> Test d'intégration de l'identification/déconnexion</a></li></ol></li>
<li class="section"><a href="sign-in-sign-out#sec:9.5"><span class="number">9.5</span> Conclusion</a></li>
<li class="section"><a href="sign-in-sign-out#sec:sign_in_out_Exercices"><span class="number">9.6</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="updating-showing-and-deleting-users#top"><span class="number">Chapitre 10</span> Actualiser, afficher et supprimer de l'utilisateur</a></li>
<li><ol>
<li class="section"><a href="updating-showing-and-deleting-users#sec:updating_users"><span class="number">10.1</span> Actualiser l'utilisateur</a></li>
<li><ol>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:edit_form"><span class="number">10.1.1</span> Formulaire de modification</a></li>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:enabling_edits"><span class="number">10.1.2</span> Permettre les modifications</a></li></ol></li>
<li class="section"><a href="updating-showing-and-deleting-users#sec:protecting_pages"><span class="number">10.2</span> Protéger les pages</a></li>
<li><ol>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:requiring_signed_in_users"><span class="number">10.2.1</span> Utilisateurs identifiés requis</a></li>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:requiring_the_right_user"><span class="number">10.2.2</span> Nécessité du bon utilisateur</a></li>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:friendly_forwarding"><span class="number">10.2.3</span> Redirection conviviale</a></li></ol></li>
<li class="section"><a href="updating-showing-and-deleting-users#sec:showing_users"><span class="number">10.3</span> Afficher les utilisateurs</a></li>
<li><ol>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:user_index"><span class="number">10.3.1</span> Liste des utilisateurs</a></li>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:sample_users"><span class="number">10.3.2</span> Exemples d'utilisateurs</a></li>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:pagination"><span class="number">10.3.3</span> Pagination</a></li>
<li><ol>
<li class="subsubsection"><a href="updating-showing-and-deleting-users#sec:testing_pagination">Test de la pagination</a></li></ol></li>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:partial_refactoring"><span class="number">10.3.4</span> Restructuration des partielles</a></li></ol></li>
<li class="section"><a href="updating-showing-and-deleting-users#sec:destroying_users"><span class="number">10.4</span> Supprimer des utilisateurs</a></li>
<li><ol>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:administrative_users"><span class="number">10.4.1</span> Utilisateurs administrateurs</a></li>
<li><ol>
<li class="subsubsection"><a href="updating-showing-and-deleting-users#sec:revisiting_attr_accessible">Révision de <code>attr_accessible</code></a></li></ol></li>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:the_destroy_action"><span class="number">10.4.2</span> L'action <code>destroy</code> («&nbsp;supprimer&nbsp;»)</a></li></ol></li>
<li class="section"><a href="updating-showing-and-deleting-users#sec:10.5"><span class="number">10.5</span> Conclusion</a></li>
<li class="section"><a href="updating-showing-and-deleting-users#sec:updating_deleting_Exercices"><span class="number">10.6</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="user-microposts#top"><span class="number">Chapitre 11</span> Micro-messages d'utilisateur</a></li>
<li><ol>
<li class="section"><a href="user-microposts#sec:a_micropost_model"><span class="number">11.1</span> Le modèle Micropost («&nbsp;Micro-message&nbsp;»)</a></li>
<li><ol>
<li class="subsection"><a href="user-microposts#sec:the_basic_model"><span class="number">11.1.1</span> Le modèle initial</a></li>
<li><ol>
<li class="subsubsection"><a href="user-microposts#sec:accessible_attribute">Attributs accessibles</a></li></ol></li>
<li class="subsection"><a href="user-microposts#sec:user_micropost_associations"><span class="number">11.1.2</span> Associations Utilisateur/micro-messages</a></li>
<li class="subsection"><a href="user-microposts#sec:ordering_and_dependency"><span class="number">11.1.3</span> Affinements du micro-message</a></li>
<li><ol>
<li class="subsubsection"><a href="user-microposts#sec:default_scope">Portée par défaut</a></li>
<li class="subsubsection"><a href="user-microposts#sec:dependent_destroy">Dependent: destroy (dépendances de la suppression)</a></li></ol></li>
<li class="subsection"><a href="user-microposts#sec:micropost_validations"><span class="number">11.1.4</span> Validations du micro-message</a></li></ol></li>
<li class="section"><a href="user-microposts#sec:showing_microposts"><span class="number">11.2</span> Afficher les micro-messages</a></li>
<li><ol>
<li class="subsection"><a href="user-microposts#sec:augmenting_the_user_show_page"><span class="number">11.2.1</span> Etoffement de la page de l'utilisateur</a></li>
<li class="subsection"><a href="user-microposts#sec:sample_microposts"><span class="number">11.2.2</span> Exemples de micro-messages</a></li></ol></li>
<li class="section"><a href="user-microposts#sec:manipulating_microposts"><span class="number">11.3</span> Manipuler les micro-messages</a></li>
<li><ol>
<li class="subsection"><a href="user-microposts#sec:access_control"><span class="number">11.3.1</span> Contrôle de l'accès</a></li>
<li class="subsection"><a href="user-microposts#sec:creating_microposts"><span class="number">11.3.2</span> Créer des micro-messages</a></li>
<li class="subsection"><a href="user-microposts#sec:a_proto_feed"><span class="number">11.3.3</span> Une proto-alimentation</a></li>
<li class="subsection"><a href="user-microposts#sec:destroying_microposts"><span class="number">11.3.4</span> Supprimer des micro-messages</a></li>
<li class="subsection"><a href="user-microposts#sec:testing_the_new_home_page"><span class="number">11.3.5</span> Test de la nouvelle page d'accueil</a></li></ol></li>
<li class="section"><a href="user-microposts#sec:11.4"><span class="number">11.4</span> Conclusion</a></li>
<li class="section"><a href="user-microposts#sec:micropost_Exercices"><span class="number">11.5</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="following-users#top"><span class="number">Chapitre 12</span> Suivi des utilisateurs</a></li>
<li><ol>
<li class="section"><a href="following-users#sec:the_relationship_model"><span class="number">12.1</span> Le modèle Relation (Relationship model)</a></li>
<li><ol>
<li class="subsection"><a href="following-users#sec:a_problem_with_the_data_model"><span class="number">12.1.1</span> Un problème du modèle de données (et sa solution)</a></li>
<li class="subsection"><a href="following-users#sec:relationship_user_associations"><span class="number">12.1.2</span> Associations Utilisateur/Relations</a></li>
<li class="subsection"><a href="following-users#sec:relationship_validations"><span class="number">12.1.3</span> Validations</a></li>
<li class="subsection"><a href="following-users#sec:following"><span class="number">12.1.4</span> Auteurs suivis</a></li>
<li class="subsection"><a href="following-users#sec:followers"><span class="number">12.1.5</span> Lecteurs</a></li></ol></li>
<li class="section"><a href="following-users#sec:a_web_interface_for_following_and_followers"><span class="number">12.2</span> Une interface web pour les auteurs suivis et les lecteurs</a></li>
<li><ol>
<li class="subsection"><a href="following-users#sec:sample_following_data"><span class="number">12.2.1</span> Exemple de donnée de suivi</a></li>
<li class="subsection"><a href="following-users#sec:stats_and_a_follow_form"><span class="number">12.2.2</span> Statistiques et formulaire de suivi</a></li>
<li class="subsection"><a href="following-users#sec:following_and_followers_pages"><span class="number">12.2.3</span> Pages d'auteurs suivis et de lecteurs</a></li>
<li class="subsection"><a href="following-users#sec:a_working_follow_button_the_standard_way"><span class="number">12.2.4</span> Un bouton de suivi fonctionnant de façon standard</a></li>
<li class="subsection"><a href="following-users#sec:a_working_follow_button_with_ajax"><span class="number">12.2.5</span> Un bouton fonctionnant avec Ajax</a></li></ol></li>
<li class="section"><a href="following-users#sec:the_status_feed"><span class="number">12.3</span> L'état de l'alimention</a></li>
<li><ol>
<li class="subsection"><a href="following-users#sec:motivation_and_strategy"><span class="number">12.3.1</span> Motivation et stratégie</a></li>
<li class="subsection"><a href="following-users#sec:a_first_feed_implementation"><span class="number">12.3.2</span> Une première implémentation de peuplement</a></li>
<li class="subsection"><a href="following-users#sec:scopes_subselects_and_a_lambda"><span class="number">12.3.3</span> Portées, sous-requêtes et fonction <em>lambda</em></a></li>
<li class="subsection"><a href="following-users#sec:the_new_status_feed"><span class="number">12.3.4</span> Nouvel état de l'alimentation</a></li></ol></li>
<li class="section"><a href="following-users#sec:following_conclusion"><span class="number">12.4</span> Conclusion</a></li>
<li><ol>
<li class="subsection"><a href="following-users#sec:extensions_to_the_sample_application"><span class="number">12.4.1</span> Extensions de l'application exemple</a></li>
<li><ol>
<li class="subsubsection"><a href="following-users#sec:replies">Réponses</a></li>
<li class="subsubsection"><a href="following-users#sec:messaging">Notification</a></li>
<li class="subsubsection"><a href="following-users#sec:follower_notifications">Notifications aux lecteurs</a></li>
<li class="subsubsection"><a href="following-users#sec:password_reminders">Rappel du mot de passe</a></li>
<li class="subsubsection"><a href="following-users#sec:signup_confirmation">Confirmation d'inscription</a></li>
<li class="subsubsection"><a href="following-users#sec:rss_feed">Alimentation RSS</a></li>
<li class="subsubsection"><a href="following-users#sec:rest_api">REST API</a></li>
<li class="subsubsection"><a href="following-users#sec:search">Recherche</a></li></ol></li>
<li class="subsection"><a href="following-users#sec:guide_to_further_resources"><span class="number">12.4.2</span> Guide vers d'autres ressources</a></li></ol></li>
<li class="section"><a href="following-users#sec:following_Exercices"><span class="number">12.5</span> Exercices</a></li></ol></li></ol></div>

<div id="main_content"></div>

<p> <span class="preamble">
 <span id="foreword">
<strong> Avant-propos</strong> <br />
 </span>
 </span></p>

<p>Ma précédente compagnie (CD Baby) fut une des premières à basculer complètement vers Ruby on Rails, et à rebasculer aussi complètement vers PHP (googlez-moi pour prendre la mesure du drama). Ce livre de Michael Hartl m'est arrivé avec tant de recommandation que je ne pouvais faire autrement que de le lire. C'est ainsi que <em>Ruby on Rails Tutorial</em> m'a fait retourner à Rails à nouveau </p>
<p>Bien qu'ayant parcouru de nombreux livre sur Rails, c'est celui qui m'a fait vraiment &ldquo;posséder&rdquo; Rails. Tout est fait “à la manière de Rails” —&nbsp;une manière qui ne me semblait pas naturelle avant avant d'avoir terminer ce livre. C'est aussi le seul livre sur Rails qui opère un Développement conduit par le test (“test-driven development”) d'un bout à l'autre, une approche hautement recommandée par les experts mais qui n'a jamais été aussi démontrée avant. Enfin, en incluant Git, GitHub et Heroku dans les exemples en démonstration, l'auteur vous donne vraiment le goût de ce que c'est que faire un projet dans la vraie vie. Les exemples de code du tutoriel ne sont pas de reste.</p> 
	
<p>La narration linéaire est vraiment un bon format. Personnellement, j'ai étudié <em>Le Tutoriel Rails</em> en trois longues journées, en faisant tous les exemples et les exercices proposés à la fin de chaque chapitre. Lisez du début à la fin, en ne sautant aucune partie, et vous en tirerez tout le bénéfice.</p>

<p>Régalez-vous&nbsp;!</p>

<p><a href="http://sivers.org/">Derek Sivers</a> (<a href="http://sivers.org/">sivers.org</a>) <br />
<em>Précédemment&nbsp;: Fondateur de </em> <a href="http://www.cdbaby.com/"><em>CD Baby</em></a> <br />
<em>Actuellement&nbsp;: Fondateur de </em> <a href="http://thoughts.pro/"><em>Thoughts Ltd.</em></a> <br /></p>

<p> <span class="preamble">
<strong> Remerciements</strong> <br />
 </span></p>

<p>Ce <em>Tutoriel Ruby on Rails</em> doit beaucoup à mon livre précédent sur Rails, <em>RailsSpace</em>, et donc à mon co-auteur <a href="http://aure.com/">Aurelius Prochazka</a>. J'aimerais remercier Aure à la fois pour le travail qu'il a accompli sur ce précédent livre et pour son soutien pour le présent ouvrage. J'aimerais aussi remercier Debra Williams Cauley, mon éditeur pour les deux ouvrages&nbsp;; aussi longtemps qu'[elle me prendra au baseball][she keeps taking me to baseball games], je continuerai d'écrire des livres pour elle.</p>

<p>J'aimerais remerciement une longue liste de Rubyistes qui m'ont parlé et inspiré au cours des années&nbsp;; David Heinemeier Hansson, Yehuda Katz, Carl Lerche, Jeremy Kemper, Xavier Noria, Ryan Bates, Geoffrey Grosenbach, Peter Cooper, Matt Aimonetti, Gregg Pollack, Wayne&nbsp;E. Seguin, Amy Hoy, Dave Chelimsky, Pat Maddox, Tom Preston-Werner, Chris Wanstrath, Chad Fowler, Josh Susser, Obie Fernandez, Ian McFarland, Steven Bristol, Giles Bowkett, Evan Dorn, Long Nguyen, James Lindenbaum, Adam Wiggins, Tikhon Bernstam, Ron Evans, Wyatt Greene, Miles Forrest, les gens bien de Pivotal Labs, le gang Heroku, les mecs de thoughtbot, et l'équipe de GitHub. Enfin, tellement, tellement, tellement de lecteurs —&nbsp;beaucoup trop pour les citer tous&nbsp;— qui ont contribuer par leur rapport de bogues et leurs suggestions durant l'écriture de ce livre, et je tiens à saluer leur aide pour rendre ce livre aussi bon qu'il pouvait être. <br /></p>

<p> <span class="preamble">
 <span id="author">
<strong> À propos de l'auteur</strong> <br />
 </span>
 </span></p>

<p><a href="http://michaelhartl.com/">Michael Hartl</a> est programmeur, éducateur et entrepreneur. Il est le co-auteur de <em>RailsSpace</em>, un tutoriel Rails [qui s'est bien vendu] publié en 2007, et a été co-fondateur et développeur en chef de <a href="http://insoshi.com/">Insoshi</a>, une plateforme de réseau social <a href="http://github.com/popular/forked">populaire</a> en Ruby on Rails. Précédement, il a enseigné la théorie et [l'application informatique][computational physics] en physique au <a href="http://www.caltech.edu/">California Institute of Technology</a> (Caltech), où il a reçu le Lifetime Achievement Award for Excellence en enseignement. Michael est diplômé du <a href="http://college.harvard.edu/">Harvard College</a>, a un <a href="http://resolver.caltech.edu/CaltechETD:etd-05222003-161626">Ph.D. en physique</a> (NdT. Un doctorat) de <a href="http://www.caltech.edu/">Caltech</a>, et est ancien élève du programme   des entrepreneurs <a href="http://ycombinator.com/">Y&nbsp;Combinator</a>. <br /></p>

<p> <span id="license" class="preamble">
<strong> Copyright et license</strong> <br />
 </span></p>

<p><em>Le Tutoriel Ruby on Rails&nbsp;: apprendre Rails par l'exemple</em>. Copyright &copy; 2010 par Michael Hartl. Tout le code source du <em>Tutoriel Ruby on Rails</em> est disponible sour la license <a href="http://www.opensource.org/licenses/mit-license.php">MIT License</a> et la licence <a href="http://en.wikipedia.org/wiki/Beerware">Beerware License</a>.</p>

<pre class="verbatim">   Copyright (c) 2010 Michael Hartl

   [La permission est accordée ici, à titre gratuit, à toute
   personne obtenant une copie de ce logiciel et sa documentation
   associés (le “Software”), 
   Permission is hereby granted, free of charge, to any person
   obtaining a copy of this software and associated documentation
   files (the &quot;Software&quot;), de traiter dans le Software
   sans restriction, d'inclure sans limitation de droits à utiliser,
   copier, modifier, ajouter, publier, distribuer, sous-licensier,
   et/ou vendre des copies de ce Software, et de permettre au gens
   à qui ce Software est fourni d'en faire de même, assujetti aux
   conditions suivantes&nbsp;:

   La note de copyright ci-dessous et cette notice de permission
   doivent être inclues à toute copie ou portion substantielle
   du logiciel.

   LE LOGICIEL EST FOURNI “TEL QUEL”, SANS AUCUNE GARANTIE D'AUCUNE
   ESPÈCE, ESPRESSE OU IMPLICITE, INCLUANT MAIS NE LIMITANT PAS LES
   GARANTIES MARCHANDES, À PROPOS D'UN BUT PARTICULIER ET ABSENCE
   DE CONTREFAÇON. EN AUCUN CAS LES AUTEURS OU LES DÉTENTEURS DU 
   COPYRIGHT NE POURRONT ÊTRE TENUS RESPONSABLE DE DOMMAGE OU AUTRE
   RESPONSABILITÉ, SI EN UNE ACTION DE CONTRAT, TORT OU AUTREMENT,
   DÉCOULANT DIRECTEMENT OU INDIRECTEMENT DE L'UTILISATION OU DE LA
   MODIFICATION DE CE LOGICIEL.]</pre>




<pre class="verbatim">/*
 * ------------------------------------------------------------
 * &quot;THE BEERWARE LICENSE&quot; (Revision 42):
 * Michael Hartl a écrit ce code. Aussi longtemps que vous
 * conservez cette note, vous pouvez faire ce que vous voulez
 * de ce travail. Si nous nous rencontrons un jour, et que vous
 * pensez que ce travail en vaut la peine, vous pourrez me
 * payer une bière en retour.
 * ------------------------------------------------------------
 */</pre>



<div id="top"></div>


<h1 class="chapter"><a id="sec:6" href="modeling-and-viewing-users-one#top" class="heading"><span class="number">Chapitre 6</span> Modéliser et afficher les utilisateurs, partie I</a></h1>


<p>Au chapitre <a class="ref" href="filling-in-the-layout#top">chapitre&nbsp;5</a>, nous avons terminé avec une page sommaire pour créer de nouveaux utilisateur (<a class="ref" href="filling-in-the-layout#sec:user_signup">section&nbsp;5.3</a>)&nbsp;; tout au long des trois prochains chapitres, nous allons nous attacher à tenir la promesse implicite que contient l'amorce de cette page. La première étape critique est de créer un <em>modèle de données</em> pour les utilisateurs de notre site, ainsi qu'une façon de conserver ces données. Accomplir cette tâche est le but de ce chapitre et du suivant (<a class="ref" href="modeling-and-viewing-users-two#top">chapitre&nbsp;7</a>), et nous allons donner aux utilisateurs la possibilité de s'inscrire au <a class="ref" href="sign-up#top">chapitre&nbsp;8</a>.  Une fois que l'application exemple pourra créer de nouveaux utilisateurs, nous leur offrirons la possibilité de s'identifier (de se connecter) et de se déconnecter (<a class="ref" href="sign-in-sign-out#top">chapitre&nbsp;9</a>), et au <a class="ref" href="updating-showing-and-deleting-users#top">chapitre&nbsp;10</a> (<a class="ref" href="updating-showing-and-deleting-users#sec:protecting_pages">section&nbsp;10.2</a>) nous apprendrons à protéger nos pages contre les accès malveillants.</p>

<p>Pris ensemble, le matériel du <a class="ref" href="modeling-and-viewing-users-one#top">chapitre&nbsp;6</a> au chapitre <a class="ref" href="updating-showing-and-deleting-users#top">chapitre&nbsp;10</a> développe un système Rails complet de login et d'authentification. Comme vous le savez peut-être, il existe une variété de solutions d'authentification clé-en-main dans le monde Rails&nbsp;; Le <a class="ref" href="modeling-and-viewing-users-one#sidebar:roll_your_own">Box&nbsp;6.1</a> explique pourquoi (au moins dans un premier temps) il est bon de composer la vôtre.</p>

<div class="label" id="sidebar:roll_your_own"></div>


<div class="sidebar"><span class="title"><span class="header">Box 6.1.</span><span class="description">Composer votre propre système d'authentification</span></span>
<p>Virtuellement, toutes les applications web, de nos jours, requièrent un système de login et d'authentification. De façon non surprenant, la plupart des framewords web contiennent une pléthore d'options pour implémenter de tels système, et Rails ne fait pas exception. Les exemples de systèmes d'authentification et d'autorisation incluent <a href="http://github.com/thoughtbot/clearance">Clearance</a>, <a href="http://github.com/binarylogic/authlogic">Authlogic</a>, <a href="http://github.com/plataformatec/devise">Devise</a> ou <a href="http://railscasts.com/episodes/192-authorization-with-cancan">CanCan</a> (tout comme les solutions non spécifiquement Rails construites au sommet de <a href="http://en.wikipedia.org/wiki/OpenID">OpenID</a> ou <a href="http://en.wikipedia.org/wiki/Oauth">OAuth</a>). Il est raisonnable de se demander pourquoi nous devrions réinventer la roue. Pourquoi ne pas tout simplement utiliser une solution clé-en-main plutôt qu'en composer une nous-même&nbsp;?</p>

<p>Il y a plusieurs raisons à ça. D'abord, il n'existe pas de réponse standard authentifications Rails&nbsp;; lier ce tutoriel à une solution spécifique laisserait grand ouvert le risque que notre choix particulier devienne dépassé et hors de mode. Plus encore, même si nous tombons juste, le code de base du projet utilisé devrait continuer à évoluer, rendant toute explication rapidement obsolète dans le tutoriel. Enfin, introduire toute la machinerie d'authentification d'un seul coup serait un désastre pédagogique &mdash;&nbsp;pour prendre un seul exemple, Clearance contient plus de 1000 ligne de code et crée un modèle de donnée compliqué dès le départ. Les systèmes d'authentification sont des challenges de programmation riches&nbsp;; composer notre propre solution signifie que nous pouvons considérer chaque petite partie à la fois, nous conduisant à une bien plus profonde compréhension aussi bien de l'authentification que de Rails.</p>

<p>Je vous encourage à étudier du <a class="ref" href="modeling-and-viewing-users-one#top">chapitre&nbsp;6</a> au <a class="ref" href="updating-showing-and-deleting-users#top">chapitre&nbsp;10</a> pour vous donner une bonne fondation pour vos projets futurs. En temps venu, si vous décidez d'utiliser un système d'authentification clé-en-main pour votre application, vous serez en mesure d'une part de le comprendre et d'autre part de l'adapter à vos besoins spécifiques.</p>
</div>


<p>En parallèle de notre modélisation des données, nous développerons une page web pour <em>afficher</em> les utilisateurs, ce qui nous servira de première étape vers l'implémentation de l'architecture REST pour les utilisateurs (discutée brièvement à la <a class="ref" href="a-demo-app#sec:mvc_in_action">section&nbsp;2.2.2</a>). Mais nous n'irons pas profondément dans ce chapitre, notre but final pour les pages de profil d'utilisateur étant de montrer l'avatar (le <em>gravatar</em>) de l'utilisateur, ses données basiques et une liste de micro-messages, comme le montre la maquette de l'<a class="ref" href="modeling-and-viewing-users-one#fig:profile_mockup">illustration&nbsp;6.1</a>.<sup class="footnote" id="fnref:6.1"><a href="#fn:6.1">1</a></sup> (<a class="ref" href="modeling-and-viewing-users-one#fig:profile_mockup">illustration&nbsp;6.1</a> contient notre premier exemple de texte <em>lorem ipsum</em>, texte qui connait une <a href="http://www.straightdope.com/columns/read/2290/what-does-the-filler-text-lorem-ipsum-mean">histoire fascinante</a> que vous devriez lire un jour). Dans ce chapitre, nous coucherons les fondations essentielles de notre page d'affichage de l'utilisateur, et nous la commencerons dans le détail au <a class="ref" href="modeling-and-viewing-users-two#top">chapitre&nbsp;7</a>.</p>

<div class="label" id="fig:profile_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/profile_mockup.png" alt="profile_mockup" /></span></div><div class="caption"><span class="header">Illustration 6.1: </span><span class="description">Une maquette de notre meilleure estimation de la page d'affichage de l'utilisateur.&nbsp;<a href="http://railstutorial.org/images/figures/profile_mockup-full.png">(taille normale)</a></span></div></div>


<p>Comme d'habitude, si vous utilisez le contrôle de version Git, il est temps de faire une nouvelle branche pour la modélisation des utilisateurs&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout master
<span class="gp">$</span> git checkout -b modeling-users
</pre></div>
</div>


<p>(La première ligne ici sert uniquement à s'assure que vous partiez bien de la branche maitresse, pour que le sujet <tt>modeling-users</tt> soit bien basé sur la branche <tt>master</tt>. Vous pouvez sauter cette commande si vous vous trouvez déjà sur la branche maitressse.)</p>

<div class="label" id="sec:user_model"></div>


<h2><a id="sec:6.1" href="modeling-and-viewing-users-one#sec:user_model" class="heading"><span class="number">6.1</span> Modèle User (<em>utilisateur</em>)</a></h2>


<p>Bien que le but ultime des trois prochains chapitres soit de créer une page d'inscription au site, il peut être bien de pouvoir accepter les informations d'inscription dès à présent, [(it would do little good to accept signup information now)(il ne serait pas très judicieux d'accepter les informations d'inscription tout de suite)], puisque nous n'avons pour le moment aucun endroit où les déposer. Ainsi, la première étape dans l'inscription des utilisateurs va être de faire une structure de données pour capturer et consigner leurs informations. En Rails, la structure de données par défaut pour un modèle de données est appelée, assez naturellement, un <em>modèle</em> (<em>model</em>) (c'est le «&nbsp;M&nbsp;» de «&nbsp;MVC&nbsp;» de la <a class="ref" href="beginning#sec:mvc">section&nbsp;1.2.6</a>). La solution par défaut de Rails au problème de la persistence consiste à utiliser une <em>base de données</em> pour la consignation à long terme des données, et la librairie par défaut pour interagir avec cette base de données est appelée <em>Active Record</em>.<sup class="footnote" id="fnref:6.2"><a href="#fn:6.2">2</a></sup></p>

<p>Active Record vient avec une foule de méthodes pour créer, sauver et chercher des objets-données, toutes sans avoir à utiliser le langage structure de requête (SQL)<sup class="footnote" id="fnref:6.3"><a href="#fn:6.3">3</a></sup> utilisé par les <a href="http://en.wikipedia.org/wiki/Relational_database">base de données relationnelles</a>. Plus encore, Rails possède une fonctionnalité appelée <em>migrations</em> pour permettre les définitions des données d'être écrites en pur Ruby, sans avoir à apprendre le langage de définition des données SQL (DDL).<sup class="footnote" id="fnref:6.4"><a href="#fn:6.4">4</a></sup> L'effet est que Rails vous épargent tout ce qui concerne les détails de la consignation des données. Dans ce livre, en utilisant SQLite pour le développement et Heroku pour le déploiement (<a class="ref" href="beginning#sec:deploying">section&nbsp;1.4</a>), nous avons poussé ce sujet encore plus loin, jusqu'au point où nous n'avons plus du tout à nous pré-occuper de comment Rails consigne les données, même pour les applications en mode production.<sup class="footnote" id="fnref:6.5"><a href="#fn:6.5">5</a></sup></p>

<div class="label" id="sec:database_migrations"></div>


<h3><a id="sec:6.1.1" href="modeling-and-viewing-users-one#sec:database_migrations" class="heading"><span class="number">6.1.1</span> Migrations de la base de données</a></h3>


<p>Vous vous souvenez peut-être, de la <a class="ref" href="rails-flavored-ruby#sec:a_user_class">section&nbsp;4.4.5</a>, que nous avons déjà rencontré, via la construction personnalisée d'une classe <code>User</code> (<em>Utilisateur</em>), des objets utilisateur avec les attributs <code>nom</code> et <code>email</code>. Cette classe a servi d'exemple utile, mais elle manquait de la propriété critique de <em>persistence</em>&nbsp;: quand nous avions créé un objet utilisateur à la console Rails, il disparaissait aussitôt que nous quittions cette console. Notre but dans cette section sera de créer un modèle pour les utilisateurs qui ne disparaisse pas aussi facilement.</p>

<p>Comme avec la classe User à la <a class="ref" href="rails-flavored-ruby#sec:a_user_class">section&nbsp;4.4.5</a>, nous allons commencer par modéliser l'utilisateur avec deux attributs,  <code>nom</code> et <code>email</code>, dont le dernier sera utilisé comme <em>username</em> unique.<sup class="footnote" id="fnref:6.6"><a href="#fn:6.6">6</a></sup> (nous ajouterons un attribut «&nbsp;mot de passe&nbsp;» à la <a class="ref" href="modeling-and-viewing-users-two#sec:insecure_passwords">section&nbsp;7.1</a>). Dans l'<a class="ref" href="rails-flavored-ruby#code:example_user">extrait&nbsp;4.8</a>, nous avons réalisé cela avec la méthode Ruby <code>attr_accessor</code>&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span>
  <span class="kp">attr_accessor</span> <span class="ss">:nom</span><span class="p">,</span> <span class="ss">:email</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div>


<p>En constraste, en utilisant Rails pour modéliser les utilisateurs nous n'avons pas besoin d'identifier explicitement les attributs. Comme noté brièvement plus haut, pour consigner les données, Rails utilise la base de données relationnelle par défaut, qui consiste en des <em>tables</em> composées de <em>rangées</em> de données, où chaque <em>rangée</em> possède des <em>colonnes</em> pour chaque attribut de la donnée. Par exemple, pour consigner des utilisateurs avec des noms et des emails, nous créerons une table <code>users</code> (<em>utilisateurs</em>) avec les colonnes <code>nom</code> et <code>email</code> dont chaque <em>rangée</em> correspondra à un utilisateur particulier. En nommant les colonnes de cette façon, nous laissons Active Record deviner les attributs de l'objet utilisateur par lui-même.</p>



<p>Voyons comment il fonctionne (si cette discussion vous semble trop abstraite, soyez patient&nbsp;; les exemples en ligne de commande commençant à la <a class="ref" href="modeling-and-viewing-users-one#sec:creating_user_objects">section&nbsp;6.1.3</a> et les copies d'écran du navigateur de base de données de l'<a class="ref" href="modeling-and-viewing-users-one#fig:sqlite_database_browser">illustration&nbsp;6.3</a> et de l'<a class="ref" href="modeling-and-viewing-users-one#fig:sqlite_user_row">illustration&nbsp;6.8</a> devraient rendre les choses plus claires). À la <a class="ref" href="filling-in-the-layout#sec:users_controller">section&nbsp;5.3.1</a>, vous vous souvenez (<a class="ref" href="filling-in-the-layout#code:generate_users_controller">extrait&nbsp;5.23</a>) que nous avons créé un contrôleur pour les utilisateurs (avec une action <code>new</code>) en utilisant la commande&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate controller Users new
</pre></div>
</div>


<p>Il existe une commande analogue pour faire un modèle&nbsp;: <code>generate model</code>&nbsp;; l<a class="ref" href="modeling-and-viewing-users-one#code:generate_user_model">extrait&nbsp;6.1</a> montre la commande pour générer un modèle <code>User</code> (<em>Utilisateur</em>) avec deux attributs, <code>nom</code> et <code>email</code>.</p>

<div class="label" id="code:generate_user_model"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 6.1.</span> <span class="description">Générer un modèle User.</span> </div>
<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate model User nom:string email:string
<span class="go">      invoke  active_record</span>
<span class="go">      create    db/migrate/&lt;timestamp&gt;_create_users.rb</span>
<span class="go">      create    app/models/user.rb</span>
<span class="go">      invoke    rspec</span>
<span class="go">      create      spec/models/user_spec.rb</span>
</pre></div>
</div></div>


<p>(Notez que, contrairement à la convention du <em>pluriel</em> pour les noms de contrôleur, les noms des modèles sont <em>singulier</em>&nbsp;: un contrôleur <em>Users</em> mais un modèle <em>User</em>.) En passant les paramètres optionnels <code>nom:string</code> et <code>email:string</code>, nous précisons à Rails les deux attributs que nous voulons, en précisant le type de ces attributs (dans ce cas, le type <em>string</em>, c'est-à-dire <em>chaine de caractère</em>). Compareez cela avec l'inclusion des noms d'acions dans l'<a class="ref" href="static-pages#code:generating_pages">extrait&nbsp;3.4</a> et l<a class="ref" href="filling-in-the-layout#code:generate_users_controller">extrait&nbsp;5.23</a>.</p>

<p>L'un des résultats de la commande <code>generate</code> de l'<a class="ref" href="modeling-and-viewing-users-one#code:generate_user_model">extrait&nbsp;6.1</a> est un nouveau fichier appelé une <em>migration</em>.  Les <em>migrations</em> fournissent un moyen d'altérer la structure de la base de données de façon incrémentielle, de telle sorte que notre modèle de données peut adapter les changements requis. Dans le cas du modèle User, la migration est créée automatiquement par le script de génération de modèle&nbsp;; il crée une table <code>users</code> (<em>utilisateurs</em>) avec deux colonnes, <code>nom</code> et <code>email</code>, comme le montre l'<a class="ref" href="modeling-and-viewing-users-one#code:users_migration">extrait&nbsp;6.2</a> (nous verrons à la <a class="ref" href="modeling-and-viewing-users-one#sec:uniqueness_validation">section&nbsp;6.2.4</a> comment faire une migration à partir de rien).</p>

<div class="label" id="code:users_migration"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 6.2.</span> <span class="description">Migration pour le modèle User (pour créer une table  <code>users</code>). <br /> <code>db/migrate/&lt;timestamp&gt;_create_users.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">CreateUsers</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">up</span>
    <span class="n">create_table</span> <span class="ss">:users</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="o">.</span><span class="n">string</span> <span class="ss">:nom</span>
      <span class="n">t</span><span class="o">.</span><span class="n">string</span> <span class="ss">:email</span>

      <span class="n">t</span><span class="o">.</span><span class="n">timestamps</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">down</span>
    <span class="n">drop_table</span> <span class="ss">:users</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Notez que le nom de la migration est préfixé par un temps (<em>timestamp</em>) basé sur le temps de création de la migration. Dans les tout premiers jours des migrations, les noms de fichier étaient préfixés par un entier incrémenté, ce qui provoquait des conflits dans une équipe de collaborateurs quand les différents programmeur se retrouvaient avec des numéros identiques. Sauf très improbable concordance de création à la milliseconde près, utiliser les <em>timestamps</em> évite efficacement de telles collisions.</p>

<p>Concentrons-nous sur la méthode <code>self.up</code>, qui utilise une méthode Rails appelée <code>create_table</code> (<em>créer_table</em>) pour créer une <em>table</em> dans la base de données pour consigner les utilisateurs (l'utilisation de <code>self</code> —&nbsp;<em>soi-même</em>&nbsp;—&nbsp;dans <code>self.up</code> l'identifie comme une <em>méthode de classe</em>. Ça n'a pas d'importance pour le présent, mais nous étudierons les méthodes de classe quand nous en inventerons à la <a class="ref" href="modeling-and-viewing-users-two#sec:an_authenticate_method">section&nbsp;7.2.4</a>). La méthode <code>create_table</code> accepte un bloc (<a class="ref" href="rails-flavored-ruby#sec:blocks">section&nbsp;4.3.2</a>) avec un variable de bloc, dans ce cas appelée <code>t</code> («&nbsp;t&nbsp;» pour «&nbsp;table&nbsp;»). À l'intérieur du bloc, la méthode <code>create_table</code> utilise l'objet&nbsp;<code>t</code> pour créer les colonnes <code>nom</code> et <code>email</code> dans la base de données, tous deux de type <code>string</code>.<sup class="footnote" id="fnref:6.7"><a href="#fn:6.7">7</a></sup> Ici le nom de la table est pluriel (<code>users</code>) même si le nom du modèle, lui, est singulier, ce qui reflète la convention linguistique suivie par Rails&nbsp;: un modèle représente un <em>simple</em> utilisateur, tandis que la table de la base de données consiste en plusieurs utilisateurs. La dernière ligne du bloc, <code>t.timestamps</code>, est une commande spéciale qui crée deux colonnes <em>magiques</em> appelées <code>created_at</code> (<em>créé_le</em> ) et <code>updated_at</code> (<em>actualisé_le</em> ), qui sont des signatures de temps qui enregistrenet automatiquement quand un utilisateur donné est créé ou modifié (nous verrons des exemples concrets de ces colonnes magiques en abordant la <a class="ref" href="modeling-and-viewing-users-one#sec:creating_user_objects">section&nbsp;6.1.3</a>). Le modèle de données complet représenté par sa migration est affiché dans l'<a class="ref" href="modeling-and-viewing-users-one#fig:user_model_initial">illustration&nbsp;6.2</a>.</p>

<div class="label" id="fig:user_model_initial"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_model_initial.png" alt="user_model_initial" /></span></div><div class="caption"><span class="header">Illustration 6.2: </span><span class="description">Le modèle de données des utilisateurs produit par l'<a class="ref" href="modeling-and-viewing-users-one#code:users_migration">extrait&nbsp;6.2</a>.</span></div></div>


<p>Nous pouvons lancer la migration, opération connue sous le nom anglais «&nbsp;migration up&nbsp;» en utilisant la commande <code>rake</code> (<a class="ref" href="a-demo-app#sidebar:rake">Box&nbsp;2.1</a>) comme suit&nbsp;:<sup class="footnote" id="fnref:6.8"><a href="#fn:6.8">8</a></sup></p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rake db:migrate
</pre></div>
</div>


<p>(Vous pouvez vous souvenir que nous avons déjà eu à jouer cette commande, à la <a class="ref" href="beginning#sec:rails_server">section&nbsp;1.2.5</a> ou encore au <a class="ref" href="a-demo-app#top">chapitre&nbsp;2</a>.) La première fois que <code>db:migrate</code> est lancé, un fichier <code>db/development.sqlite3</code> est créé, qui est une base de données <a href="http://sqlite.org/">SQLite</a><sup class="footnote" id="fnref:6.9"><a href="#fn:6.9">9</a></sup>. Nous pouvons voir la structure de la base de données en utilisant l'exemple <a href="http://sqlitebrowser.sourceforge.net/">Navigateur de données SQLite</a> pour ouvrir le fichier <code>db/development.sqlite3</code> (<a class="ref" href="modeling-and-viewing-users-one#fig:sqlite_database_browser">illustration&nbsp;6.3</a>)&nbsp;; comparez-le avec le diagramme de l'<a class="ref" href="modeling-and-viewing-users-one#fig:user_model_initial">illustration&nbsp;6.2</a>. Vous pouvez noter qu'il y a une colonne dans l'<a class="ref" href="modeling-and-viewing-users-one#fig:sqlite_database_browser">illustration&nbsp;6.3</a> qui n'a pas été prise en compte par la migration&nbsp;: la colonne <code>id</code> (<em>identifiant</em>). Comme indiqué brièvement à la <a class="ref" href="a-demo-app#sec:demo_users_resource">section&nbsp;2.2</a>, cette colonne est créée automatiquement, et est utilisée par Rails pour identifier de façon unique une rangée.</p>

<div class="label" id="fig:sqlite_database_browser"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/sqlite_database_browser.png" alt="sqlite_database_browser" /></span></div><div class="caption"><span class="header">Illustration 6.3: </span><span class="description">The  <a href="http://sqlitebrowser.sourceforge.net/">Navigateur de base de données SQLite</a> avec notre nouvelle table <code>users</code>.&nbsp;<a href="http://railstutorial.org/images/figures/sqlite_database_browser-full.png">(taille normale)</a></span></div></div>


<p>Vous avez probablement deviné que lancer <code>db:migrate</code> exécute la commande <code>self.up</code> dans le fichier migration. Qu'en est-il, donc, du code <code>self.down</code> (<em>soi-même.en-bas</em> )&nbsp;? Comme vous pouvez le deviner, <code>down</code> migre vers le <em>base</em>, inversant les effets de la migration. Dans notre cas, cela signifie <em>retirer</em>  la table <code>users</code> de la base de données&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">CreateUsers</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">down</span>
    <span class="n">drop_table</span> <span class="ss">:users</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>


<p>Vous pouvez exécuter <code>down</code> avec <code>rake</code> en utilisant l'argument <code>db:rollback</code>&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rake db:rollback
</pre></div>
</div>


<p>C'est souvent utile quand vous réalisez qu'il y a une autre colonne que vous voulez ajouter mais que vous ne voulez pas vous embêter à faire une nouvelle migration&nbsp;: vous pouvez revenir en arrière, ajouter la colonne souhaitée, et reprocéder alors à la migration (ce n'est pas toujours pratique, et nous apprendrons comment ajouter une colonne à une table existante à la <a class="ref" href="modeling-and-viewing-users-two#sec:password_migration">section&nbsp;7.1.2</a>).</p>

<p>Si vous êtes revenu en arrière pour la base de données, procédez à nouveau à sa migration&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rake db:migrate
</pre></div>
</div>




<div class="label" id="sec:the_model_file"></div>


<h3><a id="sec:6.1.2" href="modeling-and-viewing-users-one#sec:the_model_file" class="heading"><span class="number">6.1.2</span> Le fichier modèle</a></h3>


<p>Nous avons vu comment la génération du modèle User de l'<a class="ref" href="modeling-and-viewing-users-one#code:generate_user_model">extrait&nbsp;6.1</a> générait un fichier de migration (<a class="ref" href="modeling-and-viewing-users-one#code:users_migration">extrait&nbsp;6.2</a>), et nous avons vu dans l'<a class="ref" href="modeling-and-viewing-users-one#fig:sqlite_database_browser">illustration&nbsp;6.3</a> les résultats de lancer la migration&nbsp;: cela actualise un fichier appelé <code>development.sqlite3</code> en créant une table <code>users</code> avec les colonnes <code>id</code>, <code>nom</code>, <code>email</code>, <code>created_at</code>, et <code>updated_at</code>. L<a class="ref" href="modeling-and-viewing-users-one#code:generate_user_model">extrait&nbsp;6.1</a> a créé aussi le modèle lui-même&nbsp;; la suite de cette section est dédié à le comprendre.</p>

<p>Nous commençons par regarder le code du modèle User, qui se trouve dans le fichier <code>user.rb</code> à l'intérieur du dossier <code>app/models/</code>&nbsp;; il est, pour ne pas dire, très compact (<a class="ref" href="modeling-and-viewing-users-one#code:raw_user_model">extrait&nbsp;6.3</a>).</p>

<div class="label" id="code:raw_user_model"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 6.3.</span> <span class="description">Le tout nouveau modèle User. <br /> <code>app/models/user.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Si vous vous souvenez de la <a class="ref" href="rails-flavored-ruby#sec:a_class_of_our_own">section&nbsp;4.4.2</a>, la syntaxe <code>class User &lt; ActiveRecord::Base</code> signifie que la classe <code>User</code> <em>hérite</em> de <code>ActiveRecord::Base</code>, de telle sorte que le modèle User possède automatiquement les fonctionnalités de la classe <code>ActiveRecord::Base</code>. Bien entendu, la connaissance de cet héritage ne fait rien de bien tant que nous ne savons pas ce que <code>ActiveRecord::Base</code> contient, et nous allons en avoir un avant-goût dans un moment. Mais avant de continuer, il y a deux tâches à accomplir.</p>

<div class="label" id="sec:model_annotation"></div>


<h4><a id="sec:6.1.2.1" href="modeling-and-viewing-users-one#sec:model_annotation" class="heading">Annotation du modèle</a></h4>


<p>Bien que cela ne soit pas strictement nécessaire, vous pourriez trouver utile d'<em>annoter</em> vos modèles Rails en utilisant le gem <tt>annotate-models</tt> (<a class="ref" href="modeling-and-viewing-users-one#code:gemfile_annotate">extrait&nbsp;6.4</a>).</p>

<div class="label" id="code:gemfile_annotate"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 6.4.</span> <span class="description">Ajout du gem <tt>annotate-models</tt> au fichier <code>Gemfile</code>.</span>       
</div>
<div class="code"><div class="highlight"><pre><span class="n">source</span> <span class="s1">&#39;http://rubygems.org&#39;</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="o">.</span>
<span class="n">group</span> <span class="ss">:development</span> <span class="k">do</span>
  <span class="n">gem</span> <span class="s1">&#39;rspec-rails&#39;</span><span class="p">,</span> <span class="s1">&#39;2.5.0&#39;</span>
  <span class="n">gem</span> <span class="s1">&#39;annotate-models&#39;</span><span class="p">,</span> <span class="s1">&#39;1.0.4&#39;</span>
<span class="k">end</span>

<span class="n">group</span> <span class="ss">:test</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>(Nous plaçons le gem <tt>annotate-models</tt> gem dans le bloc <code>group :development</code> (comme pour <code>group :test</code>) parce que les annotations ne sont pas nécessaire dans les applications en mode production.) Nous l'installons ensuite avec <code>bundle</code>&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> bundle install
</pre></div>
</div>


<p>Cela nous ajoute une commande appelée <code>annotate</code>, qui ajoute simplement des commentaires contenant le modèle de données dans le fichier du modèle&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> annotate
<span class="go">Annotated User</span>
</pre></div>
</div>


<p>Le résultat apparait dans l'<a class="ref" href="modeling-and-viewing-users-one#code:annotated_user_model">extrait&nbsp;6.5</a>.</p>

<div class="label" id="code:annotated_user_model"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 6.5.</span> <span class="description">Le modèle User annoté. <br /> <code>app/models/user.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="c1"># == Schema Information</span>
<span class="c1"># Schema version: &lt;timestamp&gt;</span>
<span class="c1">#</span>
<span class="c1"># Table nom: users</span>
<span class="c1">#</span>
<span class="c1">#  id         :integer         not null, primary key</span>
<span class="c1">#  nom       :string(255)</span>
<span class="c1">#  email      :string(255)</span>
<span class="c1">#  created_at :datetime</span>
<span class="c1">#  updated_at :datetime</span>
<span class="c1">#</span>

<span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Je trouve qu'avoir un modèle de données visible dans les fichiers de modèle aide à se souvenir des attributs que le modèle possède, mais les extraits de code présentés ici omettrons souvent cette information, pour la brièveté.</p>

<div class="label" id="sec:accessible_attributes"></div>


<h4><a id="sec:6.1.2.2" href="modeling-and-viewing-users-one#sec:accessible_attributes" class="heading">Attributs accessibles.</a></h4>


<p>Une autre étpae qui n'est pas strictement nécessaire, mais qui est une vraiment bonne idée, est de dire à Rails quels attributs du modèle sont accessibles, c'est-à-dire quels attributs peuvent être modifiés par des utilisateurs extérieurs (tels que les utilisateurs soumettant des requêtes à l'aide de leur navigateur internet). Nous faisons cela avec la méthode <code>attr_accessible</code> (<a class="ref" href="modeling-and-viewing-users-one#code:attr_accessible">extrait&nbsp;6.6</a>). Nous verrons au <a class="ref" href="updating-showing-and-deleting-users#top">chapitre&nbsp;10</a> qu'utiliser <code>attr_accessible</code> est important pour prévenir le <em>mass assignment</em> (<em>assignement en masse</em>), un trou de sécurité désepérément courant et souvent sérieux dans beaucoup d'applications Rails.</p>

<div class="label" id="code:attr_accessible"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 6.6.</span> <span class="description">Rendre les attributs <code>nom</code> et <code>email</code> accessibles. <br /> <code>app/models/user.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:nom</span><span class="p">,</span> <span class="ss">:email</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="sec:creating_user_objects"></div>


<h3><a id="sec:6.1.3" href="modeling-and-viewing-users-one#sec:creating_user_objects" class="heading"><span class="number">6.1.3</span> Créer des objets utilisateur</a></h3>


<p>Nous avons accompli un beau boulot préparatoire, et il est temps à présent d'en tirer profit et d'en apprendre plus sur <em>Active Record</em> en jouant avec notre nouveau modèle User créé. Comme au <a class="ref" href="rails-flavored-ruby#top">chapitre&nbsp;4</a>, notre outil de choix est la console Rails. Puisque nous ne voulons pas (encore) faire des changements dans notre base de données, nous allons démarrer la console dans un <em>bac à sable</em> (<em>sandbox</em>)&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console --sandbox</span>
<span class="go">Loading development environment in sandbox (Rails 3.0.7)</span>
<span class="go">Any modifications you make will be rolled back on exit</span>
<span class="gp">&gt;&gt; </span>
</pre></div>
</div>


<p>Comme l'indique le message &ldquo;&nbsp;Any modifications you make will be rolled back on exit&nbsp;&rdquo; (<em>Toute modification que vous ferez sera effacée en quittant le bac à sable</em>. NdT ), en commençant dans un bac à sable, la console annulera tous les changements opérés sur la base de données à la fin de la session d'utilisation du bac à sable.</p>

<p>En travaillant à la console, il est utile de garder un œil sur le <em>journal de développement</em> (<em>development log</em>), qui enregistre les états de bas niveau de SQL renvoyés par Active Record, comme montrés à <a class="ref" href="modeling-and-viewing-users-one#fig:development_log">illustration&nbsp;6.4</a>. La façon d'obtenir cette sortie par une commande en ligne Unix est de <code>tail</code>er le journal&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> tail -f log/development.log
</pre></div>
</div>


<p>Le drapeau <code>-f</code> assure que <code>tail</code> affichera les lines additionnelles comme elles sont écrites. Je recommande de garder une fenêtre de Terminal ouverte pour suivre le journal en travaillant à la console.</p>

<div class="label" id="fig:development_log"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/development_log.png" alt="development_log" /></span></div><div class="caption"><span class="header">Illustration 6.4: </span><span class="description">Suivre le journal de développement.&nbsp;<a href="http://railstutorial.org/images/figures/development_log-full.png">(taille normale)</a></span></div></div>


<p>Dans la session de console de la <a class="ref" href="rails-flavored-ruby#sec:a_user_class">section&nbsp;4.4.5</a>, nous avons créé un nouvel objet utilisateur avec <code>User.new</code>, auquel nous n'avions accès qu'après avoir appelé le fichier de l'utilisateur exemple de l'<a class="ref" href="rails-flavored-ruby#code:example_user">extrait&nbsp;4.8</a>. Avec les modèles, la situation est différentes&nbsp;; comme vous pouvez vous en souvenir de la <a class="ref" href="rails-flavored-ruby#sec:a_controller_class">section&nbsp;4.4.4</a>, la console Rails charge automatiquement l'environnement Rails, ce qui inclut les modèles. Cela signifie que nous pouvons créer un nouvel objet utilisateur sans travail supplémentaire&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">new</span>
<span class="go">=&gt; #&lt;User id: nil, nom: nil, email: nil, created_at: nil, updated_at: nil&gt;</span>
</pre></div>
</div>


<p>Nous voyons ici la représentation par défaut d'un objet utilisateur, qui affiche les mêmes attributs que dans l'<a class="ref" href="modeling-and-viewing-users-one#fig:sqlite_database_browser">illustration&nbsp;6.3</a> et l'<a class="ref" href="modeling-and-viewing-users-one#code:annotated_user_model">extrait&nbsp;6.5</a>.</p>

<p>Appelé sans arguments, <code>User.new</code> retourne un objet dont tous les attributs en la valeur nulle (<code>nil</code>). À la <a class="ref" href="rails-flavored-ruby#sec:a_user_class">section&nbsp;4.4.5</a>, nous nous sommes arrangés avec l'exemple de la classe User pour qu'elle utilise une <em>table d'initialisation</em> pour définir les attributs de l'objet&nbsp;; ce choix était motivé par Active Record, qui permet aux objets d'être initialisés de cette façon&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:nom</span> <span class="o">=&gt;</span> <span class="s2">&quot;Michael Hartl&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;mhartl@example.com&quot;</span><span class="p">)</span>
<span class="go">=&gt; #&lt;User id: nil, nom: &quot;Michael Hartl&quot;, email: &quot;mhartl@example.com&quot;,</span>
<span class="go">created_at: nil, updated_at: nil&gt;</span>
</pre></div>
</div>


<p>Ici nous voyons que les attributs <code>nom</code> et <code>email</code> ont été définis comme voulu.</p>

<p>Si vous suivez le journal de développement, vous avez peut-être noté qu'aucune nouvelle ligne n'a été affichée. Ceci parce qu'appeler <code>User.new</code> n'affecte pas la base de données&nbsp;; ça crée simplement un nouvelle objet Ruby en mémoire. Pour savuer l'objet utilisateur dans la base de données, nous appelons la méthode <code>save</code> de la variable d'instance <code>user</code>&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">save</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p>La méthode <code>save</code> retourne <code>true</code> (<em>vrai</em>) si elle réussit et <code>false</code> (<em>faux</em>) dans le cas contraire (actuellement, toutes les sauvegardes doivent réussir&nbsp;; nous verrons des cas à la <a class="ref" href="modeling-and-viewing-users-one#sec:user_validations">section&nbsp;6.2</a> où certains échouent). Dès que vous sauvez, vous devez voir une ligne du journal de développeent avec une commande SQL pour <code>INSERT INTO "users"</code> (<em>INSÉRER DANS "users"</em>). Grâce aux nombreuses méthodes fournies par Active Record, nous n'aurons jamais besoin de requête SQL dans ce livre, et j'omettrai donc de commenter les commandes SQL. Mais vous pouvez apprendre beaucoup en surveillant le journal de développement.</p>

<p>Vous avez peut-être noté que le nouvel objet utilisateur possédait les valeurs <code>nil</code> pour les attributs <code>id</code> et les colonnes magiques <code>created_at</code> et <code>updated_at</code>. Voyons si notre  <code>save</code> y a changé quelque chose&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span>
<span class="go">=&gt; #&lt;User id: 1, nom: &quot;Michael Hartl&quot;, email: &quot;mhartl@example.com&quot;,</span>
<span class="go">created_at: &quot;2010-01-05 00:57:46&quot;, updated_at: &quot;2010-01-05 00:57:46&quot;&gt;</span>
</pre></div>
</div>


<p>Nous voyons qu'à l'attribut <code>id</code> a été assigné la valeur&nbsp;<code>1</code>, et que les colonnes magiques se sont vues assignées le temps et la date courants.<sup class="footnote" id="fnref:6.10"><a href="#fn:6.10">10</a></sup> Pour le moment, les timestamps de création et de modification sont identiques&nbsp;; nous verrons qu'ils différeront à la <a class="ref" href="modeling-and-viewing-users-one#sec:updating_user_objects">section&nbsp;6.1.5</a>.</p>

<p>Comme avec la classe User de la <a class="ref" href="rails-flavored-ruby#sec:a_user_class">section&nbsp;4.4.5</a>, les instances du modèle User permettent un accès à leurs attributs en utilisant la notation par point&nbsp;:<sup class="footnote" id="fnref:6.11"><a href="#fn:6.11">11</a></sup></p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">nom</span>
<span class="go">=&gt; &quot;Michael Hartl&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">email</span>
<span class="go">=&gt; &quot;mhartl@example.com&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">updated_at</span>
<span class="go">=&gt; Tue, 05 Jan 2010 00:57:46 UTC +00:00</span>
</pre></div>
</div>


<p>Comme nous le verrons au <a class="ref" href="sign-up#top">chapitre&nbsp;8</a>, il est souvent pratique de créer et de sauver un modèle en deux étapes comme nous l'avons fait ci-dessus, mais Active Record nous laisse aussi les combiner en une seule étape avec <code>User.create</code> (<code>Utilisateur.créer</code>)&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:nom</span> <span class="o">=&gt;</span> <span class="s2">&quot;A Nother&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;another@example.org&quot;</span><span class="p">)</span>
<span class="go">=&gt; #&lt;User id: 2, nom: &quot;A Nother&quot;, email: &quot;another@example.org&quot;, created_at:</span>
<span class="go">&quot;2010-01-05 01:05:24&quot;, updated_at: &quot;2010-01-05 01:05:24&quot;&gt;</span>
<span class="gp">&gt;&gt; </span><span class="n">foo</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:nom</span> <span class="o">=&gt;</span> <span class="s2">&quot;Foo&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;foo@bar.com&quot;</span><span class="p">)</span>
<span class="go">=&gt; #&lt;User id: 3, nom: &quot;Foo&quot;, email: &quot;foo@bar.com&quot;, created_at: &quot;2010-01-05</span>
<span class="go">01:05:42&quot;, updated_at: &quot;2010-01-05 01:05:42&quot;&gt;</span>
</pre></div>
</div>


<p>Notez que <code>User.create</code>, plutôt que de retourner <code>true</code> ou <code>false</code>, retourne l'objet User lui-même, que nous pouvons optionnellement assigner à une variable (comme la variable <code>foo</code> dans le seconde commande ci-dessus).</p>

<p>L'inverse de la méthode <code>create</code> (<em>créer</em>) est la méthode <code>destroy</code> (<em>détruire</em>)&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">foo</span><span class="o">.</span><span class="n">destroy</span>
<span class="go">=&gt; #&lt;User id: 3, nom: &quot;Foo&quot;, email: &quot;foo@bar.com&quot;, created_at: &quot;2010-01-05</span>
<span class="go">01:05:42&quot;, updated_at: &quot;2010-01-05 01:05:42&quot;&gt;</span>
</pre></div>
</div>


<p>Bizarrement, <code>destroy</code>, comme <code>create</code>, retourne l'objet en question, bien que je ne puisse me souvenir d'avoir jamais utiliser le retour d'une méthode <code>destroy</code>. Encore plus bizarrement peut-être, l'objet pourtant détruit par <code>destroy</code> existe toujours en mémoire&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">foo</span>
<span class="go">=&gt; #&lt;User id: 3, nom: &quot;Foo&quot;, email: &quot;foo@bar.com&quot;, created_at: &quot;2010-01-05</span>
<span class="go">01:05:42&quot;, updated_at: &quot;2010-01-05 01:05:42&quot;&gt;</span>
</pre></div>
</div>


<p>Comment pouvons-nous être sûrs, alors, d'avoir détruit un objet&nbsp;? Et pour les objets sauvés et non-détruits, comment pouvons-nous récupérer les utilisateurs de la base de données&nbsp;? Il est temps d'apprendre à utiliser Active Record pour y répondre.</p>

<div class="label" id="sec:finding_user_objects"></div>


<h3><a id="sec:6.1.4" href="modeling-and-viewing-users-one#sec:finding_user_objects" class="heading"><span class="number">6.1.4</span> Recherche dans les objets Utilisateurs (Users)</a></h3>


<p>Active Record fournit plusieurs options pour retrouver des objets. Utilisons-les pour retrouver le premier utilisateur que nous avons créé puis nous vérifierons que le troisième (<code>foo</code>) a été détruit. Nous allons commencer avec l'utilisateur existant&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="go">=&gt; #&lt;User id: 1, nom: &quot;Michael Hartl&quot;, email: &quot;mhartl@example.com&quot;,</span>
<span class="go">created_at: &quot;2010-01-05 00:57:46&quot;, updated_at: &quot;2010-01-05 00:57:46&quot;&gt;</span>
</pre></div>
</div>


<p>Ici nous avons passé l'identifiant de l'utilisateur à <code>User.find</code>&nbsp;; Active Record retourne l'utilisateur correspondant à cet attribut <code>id</code>.</p>

<p>Voyons si l'utilisateur avec un identifiant de 3 existe toujours dans la base de données&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="go">ActiveRecord::RecordNotFound: Couldn&#39;t find User with ID=3</span>
</pre></div>
</div>


<p>Puisque nous avons détruit notre troisième utilisateur à la <a class="ref" href="modeling-and-viewing-users-one#sec:creating_user_objects">section&nbsp;6.1.3</a>, Active Record ne peut pas le retrouver dans la base de données. Ou plus exactement, <code>find</code> a provoqué une <em>exception</em>, qui est une manière d'indiquer un évènement exceptionnel dans l'exécution d'un programme &mdash;&nbsp;dans ce cas, un id Active Record inexistant, ce qui a conduit <code>find</code> à provoquer une exception <code>ActiveRecord::RecordNotFound</code>.<sup class="footnote" id="fnref:6.12"><a href="#fn:6.12">12</a></sup></p>

<p>En addition au <code>find</code> générique, Active Record nous permet aussi de retrouver des utilisateurs par des valeurs d'attributs spécifiques&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">find_by_email</span><span class="p">(</span><span class="s2">&quot;mhartl@example.com&quot;</span><span class="p">)</span>
<span class="go">=&gt; #&lt;User id: 1, nom: &quot;Michael Hartl&quot;, email: &quot;mhartl@example.com&quot;,</span>
<span class="go">created_at: &quot;2010-01-05 00:57:46&quot;, updated_at: &quot;2010-01-05 00:57:46&quot;&gt;</span>
</pre></div>
</div>


<p>Puisque nous utiliserons l'adresse email comme nom d'utilisateur (<em>usernames</em>), cette façon de recherche sera utile quand nous apprendrons à permettre aux utilisateurs de s'identifier à notre site (<a class="ref" href="sign-up#top">chapitre&nbsp;8</a>).<sup class="footnote" id="fnref:6.13"><a href="#fn:6.13">13</a></sup></p>

<p>Nous allons terminer avec deux des façons générales de retrouver des utilisateurs. D'abord, il y a la méthode <code>first</code> (<em>premier</em>)&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">first</span>
<span class="go">=&gt; #&lt;User id: 1, nom: &quot;Michael Hartl&quot;, email: &quot;mhartl@example.com&quot;,</span>
<span class="go">created_at: &quot;2010-01-05 00:57:46&quot;, updated_at: &quot;2010-01-05 00:57:46&quot;&gt;</span>
</pre></div>
</div>


<p>Naturellement, <code>first</code> retourne simplement le premier utilisateur de la base de données. Il y a aussi <code>all</code> (<em>tous</em>)&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">all</span>
<span class="go">=&gt; [#&lt;User id: 1, nom: &quot;Michael Hartl&quot;, email: &quot;mhartl@example.com&quot;,</span>
<span class="go">created_at: &quot;2010-01-05 00:57:46&quot;, updated_at: &quot;2010-01-05 00:57:46&quot;&gt;,</span>
<span class="go">#&lt;User id: 2, nom: &quot;A Nother&quot;, email: &quot;another@example.org&quot;, created_at:</span>
<span class="go">&quot;2010-01-05 01:05:24&quot;, updated_at: &quot;2010-01-05 01:05:24&quot;&gt;]</span>
</pre></div>
</div>


<p>Il n'est pas difficile de devenir que <code>all</code> (<em>tous</em>) retourne un tableau (<a class="ref" href="rails-flavored-ruby#sec:arrays_and_ranges">section&nbsp;4.3.1</a>) de tous les utilisateurs consignés dans la base de données.</p>

<div class="label" id="sec:updating_user_objects"></div>


<h3><a id="sec:6.1.5" href="modeling-and-viewing-users-one#sec:updating_user_objects" class="heading"><span class="number">6.1.5</span> Actualisation des objets Utilisateurs (Users)</a></h3>


<p>Une fois que nous avons créé des objets, nous voulons souvent les actualisr. Il existe deux façons basique de le faire. D'abord, nous pouvons assigner les attributs individuellement, comme nous l'avons fait à la <a class="ref" href="rails-flavored-ruby#sec:a_user_class">section&nbsp;4.4.5</a>&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span>           <span class="c1"># Just a reminder about our user&#39;s attributes</span>
<span class="go">=&gt; #&lt;User id: 1, nom: &quot;Michael Hartl&quot;, email: &quot;mhartl@example.com&quot;,</span>
<span class="go">created_at: &quot;2010-01-05 00:57:46&quot;, updated_at: &quot;2010-01-05 00:57:46&quot;&gt;</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="s2">&quot;mhartl@example.net&quot;</span>
<span class="go">=&gt; &quot;mhartl@example.net&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">save</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p>Notez que l'étape finale est nécessaire pour écrire les changements dans la base de donées. Nous pouvons voir ce qu'il arrive en cas d'oubli de sauvegarde en utilisant <code>reload</code>, qui recharge l'objet en fonction des informations contenues dans la base de données&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">email</span>
<span class="go">=&gt; &quot;mhartl@example.net&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="s2">&quot;foo@bar.com&quot;</span>
<span class="go">=&gt; &quot;foo@bar.com&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">reload</span><span class="o">.</span><span class="n">email</span>
<span class="go">=&gt; &quot;mhartl@example.net&quot;</span>
</pre></div>
</div>


<p>Maintenant que nous avons actualisé l'utilisateur, les colonnes magiques diffèrent, comme promis à la <a class="ref" href="modeling-and-viewing-users-one#sec:creating_user_objects">section&nbsp;6.1.3</a>&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">created_at</span>
<span class="go">=&gt; &quot;2010-01-05 00:57:46&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">updated_at</span>
<span class="go">=&gt; &quot;2010-01-05 01:37:32&quot;</span>
</pre></div>
</div>


<p>La seconde façon d'actualiser les attribut est d'utiliser <code>update_attributes</code>:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">update_attributes</span><span class="p">(</span><span class="ss">:nom</span> <span class="o">=&gt;</span> <span class="s2">&quot;The Dude&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;dude@abides.org&quot;</span><span class="p">)</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">nom</span>
<span class="go">=&gt; &quot;The Dude&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">email</span>
<span class="go">=&gt; &quot;dude@abides.org&quot;</span>
</pre></div>
</div>


<p>La méthode <code>update_attributes</code> accepte une table d'attributs, et en cas de succès accomplit d'un coup l'actualisation et la sauvegarde (en retournant <code>true</code> pour indiquer que la sauvegarde a pu se faire). Il est important de noter que, une fois que vous avez défini l'accessibilité de certains attributs avec <code>attr_accessible</code> (<a class="ref" href="modeling-and-viewing-users-one#sec:accessible_attributes">section&nbsp;6.1.2.2</a>), <em>seuls</em> ces attributs peuvent être modifiés en utilisant la méthode <code>update_attributes</code>. Si vous trouvez que votre modèle commence mystérieusement à refuser d'actualiser certaines colonnes, assurez-vous que ces colonnes soient bien incluses dans l'appel à <code>attr_accessible</code>.</p>

<div class="label" id="sec:user_validations"></div>


<h2><a id="sec:6.2" href="modeling-and-viewing-users-one#sec:user_validations" class="heading"><span class="number">6.2</span> Validations de l'utilisateur</a></h2>


<p>Le modèle User que nous avons créé à la <a class="ref" href="modeling-and-viewing-users-one#sec:user_model">section&nbsp;6.1</a> possède maintenant des attributs <code>nom</code> et <code>email</code> qui fonctionnent, mais ils sont complètement «&nbsp;génériques&nbsp;»&nbsp;: n'importe quelle chaine de caractères (incluant l'espace) est en ce moment valide dans tous les cas. Et pourtant, les noms et les adresses email sont plus spécifiques que ça. Par exemple, le <code>nom</code> ne devrait pas être vierge, et l'<code>email</code> devrait être conforme au format caractéristique des adresses email. Plus encore, puisque nous allons utiliser l'adresse comme unique nom d'utilisateur (username) quand l'utilisateur s'identifiera, nous ne devrions pas permettre d'avoir deux fois la même adresse dans la base de données.</p>

<p>En bref, nous ne devrions pas permettre que <code>nom</code> et <code>email</code> soit n'importe quelle chaine de caractères&nbsp;; nous devrions forcer certaines contraintes sur ces valeurs. Active Record nous permet d'imposer de telles contraintes en utilisant les <em>validations</em>. Dans cette section, nous couvrions plusieurs des cas les plus courants, en validant la  <em>présence</em> (<em>presence</em>), la <em>longueur</em> (<em>length</em>), le <em>format</em> et l'<em>unicité</em> (<em>uniqueness</em>). Nous ajouterons à la <a class="ref" href="modeling-and-viewing-users-two#sec:password_validations">section&nbsp;7.1.1</a> une validation finale courante, la <em>confirmation</em>. Et nous verrons à la <a class="ref" href="sign-up#sec:signup_failure">section&nbsp;8.2</a> comment les validations nous nous renvoient des messages d'erreur pratiques quand l'utilisateur soumet des données qui les violent.</p>

<p>Comme pour les autres fonctionnalités de notre application exemple, nous allons ajouter les validations au modèle User en utilisant le «&nbsp;développement conduit par les tests&nbsp;». Puisque nous avons changé le modèle de données, c'est une bonne idée de préparer le test de la base de données avant de poursuivre&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rake db:test:prepare
</pre></div>
</div>


<p>Cela s'assure simplement que le modèle de données de la base de données en mode test, <code>db/test.sqlite3</code>, reflète la base de données en mode de développement, <code>db/development.sqlite3</code>.</p>

<div class="label" id="sec:presence_validation"></div>


<h3><a id="sec:6.2.1" href="modeling-and-viewing-users-one#sec:presence_validation" class="heading"><span class="number">6.2.1</span> Valider la présence</a></h3>


<p>Nous allons commencer par un test de la présence de l'attribut <code>nom</code> attribute. Bien que la première étape en TDD consiste à écrire un test <em>échouant</em> (<a class="ref" href="static-pages#sec:TDD">section&nbsp;3.2.2</a>), nous n'en savons pas encore assez dans ce cas à propos des validations pour écrire le test approprié, donc nous allons d'abord écrire la validation, en utilisant la console pour la comprendre. Ensuite nous commenterons la validation pour l'exclure, écrirons un test échouant, et vérifierons que décommenter les validations fait bien réussir le test. Cette procédure peut paraitre pédante pour un test aussi simple, mais j'ai <em>trop</em> vu<sup class="footnote" id="fnref:6.14"><a href="#fn:6.14">14</a></sup>  de «&nbsp;simples&nbsp;» tests échouer&nbsp;; être méticuleux à propos de la TDD est simplement la  <em>seule</em> manière d'être confiant sur le fait que nous testons la bonne chose à tester (la technique d'exclusion par commentaire est utile, aussi, quand on vient au secours d'une application dont le code est déjà écrit mais qu'elle ne possède &mdash;&nbsp;<em>quelle horreur&nbsp;!</em>&nbsp;&mdash; aucun test).</p>

<p>La façon de valider la présence d'un attribut <code>nom</code> est d'utiliser la méthode <code>validates</code> avec l'argument <code>:presence =&gt; true</code>, comme montré dans l'<a class="ref" href="modeling-and-viewing-users-one#code:validates_presence_of_nom">extrait&nbsp;6.7</a>. L'argument <code>:presence =&gt; true</code> est une table d'options à un élément&nbsp;; souvenez-vous, <a class="ref" href="rails-flavored-ruby#sec:css_revisited">section&nbsp;4.3.4</a>, que les accolades sont optionnelles lorsque les tableaux sont les arguments finaux d'une méthode (comme noté à la <a class="ref" href="filling-in-the-layout#sec:adding_to_the_layout">section&nbsp;5.1.1</a>, l'utilisation de tables d'options est un théme récurrent en Rails).</p>

<div class="label" id="code:validates_presence_of_nom"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 6.7.</span> <span class="description">Valider la présence d'un attribut <code>nom</code>. <br /> <code>app/models/user.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span> 
  <span class="n">attr_accessible</span> <span class="ss">:nom</span><span class="p">,</span> <span class="ss">:email</span>

  <span class="n">validates</span> <span class="ss">:nom</span><span class="p">,</span> <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Comme discuté brièvement à la <a class="ref" href="a-demo-app#sec:putting_the_micro_in_microposts">section&nbsp;2.3.2</a>, l'utilisation de <code>validates</code> est caractéristique de Rails&nbsp;3 (en Rails&nbsp;2.3, nous aurions dû plutôt écrire <code>validates_presence_of :nom</code>).</p>

<p>L'<a class="ref" href="modeling-and-viewing-users-one#code:validates_presence_of_nom">extrait&nbsp;6.7</a> peut sembler quelque peu, mais <code>validates</code> est juste une méthode, telle que l'est aussi <code>attr_accessible</code>. Une formulation équivalent de l'<a class="ref" href="modeling-and-viewing-users-one#code:validates_presence_of_nom">extrait&nbsp;6.7</a> en utilisant les parenthèses serait&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span> 
  <span class="n">attr_accessible</span><span class="p">(</span><span class="ss">:nom</span><span class="p">,</span> <span class="ss">:email</span><span class="p">)</span>

  <span class="n">validates</span><span class="p">(</span><span class="ss">:nom</span><span class="p">,</span> <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>


<p>Utilisons la console pour voir les effets de l'ajout de la validation sur notre modèle User&nbsp;:<sup class="footnote" id="fnref:6.15"><a href="#fn:6.15">15</a></sup></p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console --sandbox</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:nom</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;mhartl@example.com&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">save</span>
<span class="go">=&gt; false</span>
<span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">valid?</span>
<span class="go">=&gt; false</span>
</pre></div>
</div>


<p>Ici, <code>user.save</code> retourne <code>false</code> (<em>faux</em>), indiquant un sauvegarde défectueuse. Dans la commande finale, nous utilisons la méthode <code>valid?</code>, qui retourne <code>false</code> (<em>false</em>) quand l'objet rate une ou plus validations, et <code>true</code> (<em>vrai</em>) quand toutes les validations réussissent (Souvenez-nous de la <a class="ref" href="rails-flavored-ruby#sec:objects_and_message_passing">section&nbsp;4.2.3</a>, que Ruby utilise le point d'interrogation pour signifier les méthodes <em>booléennes</em>). Dans ce cas, nous n'avons qu'une seule validation, donc nous savons laquelle échoue, mais il peut toujours être utile de vérifier en utilisant l'objet <code>errors</code> (<em>erreurs</em>) généré par l'échec&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">full_messages</span>
<span class="go">=&gt; [&quot;Name can&#39;t be blank&quot;]</span>
</pre></div>
</div>


<p>(Le message d'erreur est une trace que Rails valide la présence d'un attribut en utilisant la méthode <code>blank?</code>, ce que nous avons vu à la fin de la <a class="ref" href="rails-flavored-ruby#sec:modifying_built_in_classes">section&nbsp;4.4.3</a>.)</p>

<p>Voilà pour les tests échouant. Pour s'assurer que notre test naissant échouera, commentons pour l'exclure la validation (<a class="ref" href="modeling-and-viewing-users-one#code:commented_out_validation">extrait&nbsp;6.8</a>).</p>

<div class="label" id="code:commented_out_validation"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 6.8.</span> <span class="description">Exclure en la commentant une valide pour s'assure que le test échoue. <br /> <code>app/models/user.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span> 
  <span class="n">attr_accessible</span> <span class="ss">:nom</span><span class="p">,</span> <span class="ss">:email</span>

  <span class="c1"># validates :nom, :presence =&gt; true</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Comme dans le cas de la génération de contrôleur (par exemple l'<a class="ref" href="filling-in-the-layout#code:generate_users_controller">extrait&nbsp;5.23</a>), la commande de génération de modèle dans l'<a class="ref" href="modeling-and-viewing-users-one#code:generate_user_model">extrait&nbsp;6.1</a> prodiut une spec intiale pour tester les utilisateurs, mais dans ce cas elle est pratiquement vierge (<a class="ref" href="modeling-and-viewing-users-one#code:default_user_spec">extrait&nbsp;6.9</a>).</p>

<div class="label" id="code:default_user_spec"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 6.9.</span> <span class="description">Le spec User par défaut, pratiquement vierge. <br /> <code>spec/models/user_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="n">pending</span> <span class="s2">&quot;add some examples to (or delete) </span><span class="si">#{</span><span class="bp">__FILE__</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Cela utilise simplement la méthode <code>pending</code> (<em>en attendant</em>) pour indiquer que nous devriez remplir le spec avec quelque chose de plus utile. Nous pouvons en voir les effets en jouant le spec du modèle User&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rspec spec/models/user_spec.rb 
<span class="go">*</span>


<span class="go">Finished in 0.01999 seconds</span>
<span class="go">1 example, 0 failures, 1 pending</span>

<span class="go">Pending:</span>
<span class="go">  User add some examples to (or delete)</span>
<span class="go">  /Users/mhartl/rails_projects/sample_app/spec/models/user_spec.rb</span>
<span class="go">  (Not Yet Implemented)</span>
</pre></div>
</div>


<p>Nous suivrons le conseil du spec par défaut en le remplissant avec des exemples RSpec, montrés dans l'<a class="ref" href="modeling-and-viewing-users-one#code:raw_user_spec">extrait&nbsp;6.10</a>.</p>

<div class="label" id="code:raw_user_spec"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 6.10.</span> <span class="description">Le spec User initial. <br /> <code>spec/models/user_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
    <span class="vi">@attr</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:nom</span> <span class="o">=&gt;</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;user@example.com&quot;</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s2">&quot;devrait créer une nouvelle instance  should create a new instance dotée des attributs valides&quot;</span> <span class="k">do</span>
    <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="vi">@attr</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s2">&quot;devrait exiger un nom&quot;</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Nous avons vu <code>require</code> et <code>describe</code> auparavant, le plus récemment dans l'<a class="ref" href="filling-in-the-layout#code:user_signup_spec">extrait&nbsp;5.28</a>. La ligne suivante est un bloc <code>before(:each)</code>&nbsp;; ceci a été couvert brièvement par un exercice (<a class="ref" href="static-pages#code:pages_controller_spec_exercise">extrait&nbsp;3.33</a>), et tout ce qu'il fait est de jouer le code à l'intérieur du bloc avant chaque exemple &mdash;&nbsp;dant ce cas en définissant l'instance de variable <code>@attr</code> comme tableau d'initialisation.</p>

<p>Le premier exemple est juste un «&nbsp;check de santé&nbsp;» vérifiant que le modèle User fonctionne. Il utilise <code>User.create!</code> (lire &ldquo;create bang&rdquo;, «&nbsp;créer bang&nbsp;» ), qui fonctionne comme la méthode <code>create</code> vue à la <a class="ref" href="modeling-and-viewing-users-one#sec:creating_user_objects">section&nbsp;6.1.3</a> à la différence près qu'elle provoque une exception (une erreur) <code>ActiveRecord::RecordInvalid</code> si la création échoue (similairement à l'exception <code>ActiveRecord::RecordNotFound</code> que nous avons pu voir à la <a class="ref" href="modeling-and-viewing-users-one#sec:finding_user_objects">section&nbsp;6.1.4</a>). Aussi longtemps que les attributs sont valides, elle ne provoque aucune erreur, et le test réussira.</p>

<p>La ligne finale est le test pour la présence de l'attribut <code>nom</code> &mdash;&nbsp;ou plutôt, il <em>devrait</em> être le test effectif, s'il y avait quelque chose dans cette attribut. Au lieu de ça, le test est juste une esquisse, mais une esquisse utile&nbsp;: c'est une <em>spec de mise en attente</em>, qui est un moyen d'écrire une description du comportement de l'application sans se soucier encore de son implémentation. L'<a class="ref" href="modeling-and-viewing-users-one#code:default_user_spec">extrait&nbsp;6.9</a> montre un exemple spec de mise en attente utilisant un appel explicite à la méthode <code>pending</code> (<em>mise en attente</em>)&nbsp;; dans ce cas, puisque nous avons inclus seulement la partie&nbsp;<code>it</code> de l'exemple…</p>

<div class="code"><div class="highlight"><pre><span class="n">it</span> <span class="s2">&quot;devrait exigé un nom&quot;</span>
</pre></div>
</div>


<p>… RSpec déduit l'existence d'une spec de mise en attente.</p>

<p>Les specs de mise en attente sont bien traités par les programmes pour jouer des specs, comme vu pour Autotest dans l'<a class="ref" href="modeling-and-viewing-users-one#fig:autotest_pending_spec">illustration&nbsp;6.5</a>, et la sortie de <code>rspec spec/</code> est utile de la même façon. Les specs de mise en attente sont utiles en tant qu'emplacements réservés pour des tests que nous savons avoir à écrire mais que nous ne voulons pas gérer tout de suite.</p>

<div class="label" id="fig:autotest_pending_spec"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/autotest_pending_spec.png" alt="autotest_pending_spec" /></span></div><div class="caption"><span class="header">Illustration 6.5: </span><span class="description">Autotest (via <code>autotest</code>) avec un spec User de mise en attente.&nbsp;<a href="http://railstutorial.org/images/figures/autotest_pending_spec-full.png">(taille normale)</a></span></div></div>


<p>Dans le but de remplir le spec de mise en attente, nous avons besoin d'une manière de créer une table d'attributs avec un nom invalide (la table <code>@attr</code> est valide par construction, avec un attribut <code>nom</code> non vierge). La méthode <code>Hash</code> <code>merge</code> (<em>fusion</em> de <em>Table de hachage</em>) accomplit la chose, comme nous pouvons le voir dans la <code>console rails</code>&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="vi">@attr</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:nom</span> <span class="o">=&gt;</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;user@example.com&quot;</span> <span class="p">}</span>
<span class="go">=&gt; {:nom =&gt; &quot;Example User&quot;, :email =&gt; &quot;user@example.com&quot;}</span>
<span class="gp">&gt;&gt; </span><span class="vi">@attr</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="ss">:nom</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
<span class="go">=&gt; {:nom =&gt; &quot;&quot;, :email =&gt; &quot;user@example.com&quot;}</span>
</pre></div>
</div>


<p>Avec <code>merge</code> (<em>fusionne</em>) en main, nous sommes prêts à faire une nouvelle spec (utilisant une astuce que j'expliquerai dans un instant) comme le montre l'<a class="ref" href="modeling-and-viewing-users-one#code:failing_validates_nom_spec">extrait&nbsp;6.11</a>.</p>

<div class="label" id="code:failing_validates_nom_spec"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 6.11.</span> <span class="description">Un test échouant pour la validation de l'attribut <code>nom</code>. <br /> <code>spec/models/user_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
    <span class="vi">@attr</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:nom</span> <span class="o">=&gt;</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;user@example.com&quot;</span> <span class="p">}</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="s2">&quot;exige un nom&quot;</span> <span class="k">do</span>
    <span class="n">no_nom_user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@attr</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="ss">:nom</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
    <span class="n">no_nom_user</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_valid</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Ici nous utilisons <code>merge</code> pour créer un nouvelle utilisation appelée <code>no_nom_user</code> (<em>utilisateur_sans_nom</em>) avec un nom vierge. La deuxième ligne utilise alors la méthode RSpec <code>should_not</code> (<em>ne_devrait_pas</em>) pour vérifier que l'utilisateur en résultant n'est <em>pas</em> valide. L'astuce à laquelle je faisait allusion ci-dessus fait référence à <code>be_valid</code> (<em>être_valide</em>)&nbsp;: nous avons appris plus haut dans cette section qu'un objet utilisateur (user) répondait à la méthode booléenne <code>valid?</code>. RSpec adopte une convention utile qui nous permettait de tester <em>n'importe</em> quelle méthode booléenne en supprimant le point d'interrogation et en préfixant la méthode avec <code>be_</code> (<em>être</em>). En d'autres mots…</p>

<div class="code"><div class="highlight"><pre><span class="n">no_nom_user</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_valid</span>
</pre></div>
</div>


<p>… est équivalent à&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="n">no_nom_user</span><span class="o">.</span><span class="n">valid?</span><span class="o">.</span><span class="n">should_not</span> <span class="o">==</span> <span class="kp">true</span>
</pre></div>
</div>


<p>Puisque ça sonne plus proche du langage naturel (au moins pour les anglophones. NdT), écrire <code>should_not be_valid</code> (<em>ne_devrait_pas_etre_valide</em>) est définitivement plus idiomatiquement correct en RSpec.</p>

<p>Avec ça, notre nouveau test devrait échoué, ce que nous pouvons vérifier avec Autotest ou en jouant le fichier <code>user_spec.rb</code> en utilisant le script <code>spec</code>&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rspec spec/models/user_spec.rb
<span class="go">.F</span>

<span class="go">1)</span>
<span class="go">&#39;User exige un nom&#39; FAILED</span>
<span class="go">expected valid? to return false, got true</span>
<span class="go">./spec/models/user_spec.rb:14:</span>

<span class="go">2 examples, 1 failure</span>
</pre></div>
</div>


<p>Maintenant décommentons la validation (c'est-à-dire que de l'<a class="ref" href="modeling-and-viewing-users-one#code:commented_out_validation">extrait&nbsp;6.8</a> nous allons revenir à l'<a class="ref" href="modeling-and-viewing-users-one#code:validates_presence_of_nom">extrait&nbsp;6.7</a>) pour faire réussir le test&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rspec spec/models/user_spec.rb
<span class="go">..</span>

<span class="go">2 examples, 0 failures</span>
</pre></div>
</div>


<p>Bien sûr, nous voulons aussi valider la présence de l'adresse email. Le test (<a class="ref" href="modeling-and-viewing-users-one#code:validates_email_spec">extrait&nbsp;6.12</a>) est analogue à celui pour l'attribut <code>nom</code>.</p>

<div class="label" id="code:validates_email_spec"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 6.12.</span> <span class="description">Un test de présence de l'attribut <code>email</code>. <br /> <code>spec/models/user_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
    <span class="vi">@attr</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:nom</span> <span class="o">=&gt;</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;user@example.com&quot;</span> <span class="p">}</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="s2">&quot;exige une adresse email&quot;</span> <span class="k">do</span>
    <span class="n">no_email_user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@attr</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
    <span class="n">no_email_user</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_valid</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>L'implémentation est aussi virtuellement la même, comme vu dans l'<a class="ref" href="modeling-and-viewing-users-one#code:validates_presence_of_email">extrait&nbsp;6.13</a>.</p>

<div class="label" id="code:validates_presence_of_email"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 6.13.</span> <span class="description">Valider la présence des attributs <code>nom</code> et <code>email</code>. <br /> <code>app/models/user.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span> 
  <span class="n">attr_accessible</span> <span class="ss">:nom</span><span class="p">,</span> <span class="ss">:email</span>

  <span class="n">validates</span> <span class="ss">:nom</span><span class="p">,</span>  <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>À présent, tous les tests devraient réussir, dans les validations de «&nbsp;présence&nbsp;» sont complets.</p>

<div class="label" id="sec:length_validation"></div>


<h3><a id="sec:6.2.2" href="modeling-and-viewing-users-one#sec:length_validation" class="heading"><span class="number">6.2.2</span> Validation de la longueur (<em>Length</em>)</a></h3>


<p>Nous avons contraint notre modèle utilisateur d'exiger un nom pour chaque utilisateur, mais nous devons aller plus loin&nbsp;: les noms d'utilisateur seront affiché sur le site exemple, donc nous devons introduire quelques limites de longueur. Avec tout le travail que nous avons accompli à la <a class="ref" href="modeling-and-viewing-users-one#sec:presence_validation">section&nbsp;6.2.1</a>, cette étape est facile.</p>

<p>Nous commençons par un test. Il n'y a pas de science pour choisir une longueur maximum&nbsp;; nous allons déclarer que <code>50</code>&nbsp;caractères sont une limite maximale acceptable, ce qui signifie que les noms de 51&nbsp;caractères seront trop longs (<a class="ref" href="modeling-and-viewing-users-one#code:length_validation_test">extrait&nbsp;6.14</a>).</p>

<div class="label" id="code:length_validation_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 6.14.</span> <span class="description">Un test pour la validation de longueur du <code>nom</code>. <br /> <code>spec/models/user_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
    <span class="vi">@attr</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:nom</span> <span class="o">=&gt;</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;user@example.com&quot;</span> <span class="p">}</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="s2">&quot;devrait rejeter les noms trop longs&quot;</span> <span class="k">do</span>
    <span class="n">long_nom</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span> <span class="o">*</span> <span class="mi">51</span>
    <span class="n">long_nom_user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@attr</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="ss">:nom</span> <span class="o">=&gt;</span> <span class="n">long_nom</span><span class="p">))</span>
    <span class="n">long_nom_user</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_valid</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>De façon pratique, nous avons utilisé la «&nbsp;multiplication de chaine&nbsp;» dans l'<a class="ref" href="modeling-and-viewing-users-one#code:length_validation_test">extrait&nbsp;6.14</a> pour construire une chaine de 51&nbsp;caractères. Nous pouvons voir comment cela fonctionne en utilisant la console&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span> <span class="o">*</span> <span class="mi">51</span>
<span class="go">=&gt; &quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;</span>
<span class="gp">&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">length</span>
<span class="go">=&gt; 51</span>
</pre></div>
</div>


<p>Le test de l'<a class="ref" href="modeling-and-viewing-users-one#code:length_validation_test">extrait&nbsp;6.14</a> devrait échouer. Pour le voir réussir, nous avons besoin de connaitre l'argument de validation pour contraindre la longueur, <code>:length</code>, qui s'utilise avec le paramètre <code>:maximum</code> pour placer la limite supérieure (<a class="ref" href="modeling-and-viewing-users-one#code:length_validation">extrait&nbsp;6.15</a>).</p>

<div class="label" id="code:length_validation"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 6.15.</span> <span class="description">Ajout d'une validation de longueur pour l'attribut <code>nom</code>. <br /> <code>app/models/user.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span> 
  <span class="n">attr_accessible</span> <span class="ss">:nom</span><span class="p">,</span> <span class="ss">:email</span>

  <span class="n">validates</span> <span class="ss">:nom</span><span class="p">,</span>  <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span>
                    <span class="ss">:length</span>   <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:maximum</span> <span class="o">=&gt;</span> <span class="mi">50</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Avec la réussite de notre suite de tests, nous pouvons avancer vers une validation plus difficile&nbsp;: le format de l'email..</p>

<div class="label" id="sec:format_validation"></div>


<h3><a id="sec:6.2.3" href="modeling-and-viewing-users-one#sec:format_validation" class="heading"><span class="number">6.2.3</span> Validation de format</a></h3>


<p>Nos validations pour l'attribut <code>nom</code> force seulement des contraintes minimale &mdash;&nbsp;seuls les noms non-vierge et inférieurs à 51&nbsp;caractères seront acceptés&nbsp;&mdash; mais bien sûr l'attribut <code>email</code> doit satisfaire des exigences plus strictes. Jusqu'ici nous n'avons rejeté que l'adresse vierge&nbsp;; dans cette section, nous exigerons des adresses email qu'elles soient conforme au modèle familier <code>user@example.com</code>.</p>

<p>Ni les tests ni la validation ne seront exhaustive, mais juste assez bonne pour accepter les adresses les plus valides et rejeter les plus invalides. Nous allons commencer avec une paire de tests impliquant une collection d'adresses valides et d'adresses invalides. Pour faire ces collections, ça vaut la peine de connaitre une méthode utile pour faire des listes de strings, comme on l'a vu dans la session de console&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="sx">%w[foo bar baz]</span>
<span class="go">=&gt; [&quot;foo&quot;, &quot;bar&quot;, &quot;baz&quot;]</span>
<span class="gp">&gt;&gt; </span><span class="n">addresses</span> <span class="o">=</span> <span class="sx">%w[user@foo.com THE_USER@foo.bar.org first.last@foo.jp]</span>
<span class="go">=&gt; [&quot;user@foo.com&quot;, &quot;THE_USER@foo.bar.org&quot;, &quot;first.last@foo.jp&quot;]</span>
<span class="gp">&gt;&gt; </span><span class="n">addresses</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">address</span><span class="o">|</span>
<span class="gp">?&gt; </span>  <span class="nb">puts</span> <span class="n">address</span>
<span class="gp">&gt;&gt; </span><span class="k">end</span>
<span class="go">user@foo.com</span>
<span class="go">THE_USER@foo.bar.org</span>
<span class="go">first.last@foo.jp</span>
</pre></div>
</div>


<p>Ici, nous «&nbsp;bouclons&nbsp;» sur les éléments du tableau <code>addresses</code> en utilisant la méthode <code>each</code> (<a class="ref" href="rails-flavored-ruby#sec:blocks">section&nbsp;4.3.2</a>). Cette tehnique bien en main, nous sommes prêts à écrire quelques tests de validation de format basique d'adresses (<a class="ref" href="modeling-and-viewing-users-one#code:email_format_validation_tests">extrait&nbsp;6.16</a>).</p>

<div class="label" id="code:email_format_validation_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 6.16.</span> <span class="description">Tests pour la validation du format des adresses mail. <br /> <code>spec/models/user_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
    <span class="vi">@attr</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:nom</span> <span class="o">=&gt;</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;user@example.com&quot;</span> <span class="p">}</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="s2">&quot;devrait accepter une adresse email valide&quot;</span> <span class="k">do</span>
    <span class="n">addresses</span> <span class="o">=</span> <span class="sx">%w[user@foo.com THE_USER@foo.bar.org first.last@foo.jp]</span>
    <span class="n">addresses</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">address</span><span class="o">|</span>
      <span class="n">valid_email_user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@attr</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="ss">:email</span> <span class="o">=&gt;</span> <span class="n">address</span><span class="p">))</span>
      <span class="n">valid_email_user</span><span class="o">.</span><span class="n">should</span> <span class="n">be_valid</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s2">&quot;devrait rejeter une adresse email invalide&quot;</span> <span class="k">do</span>
    <span class="n">addresses</span> <span class="o">=</span> <span class="sx">%w[user@foo,com user_at_foo.org example.user@foo.]</span>
    <span class="n">addresses</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">address</span><span class="o">|</span>
      <span class="n">invalid_email_user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@attr</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="ss">:email</span> <span class="o">=&gt;</span> <span class="n">address</span><span class="p">))</span>
      <span class="n">invalid_email_user</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_valid</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Comme noté ci-dessus, c'est loin d'être exhaustif, mais nous vérifions les formes d'adresse email valide courantes <code>user@foo.com</code>, <code>THE_USER@foo.bar.org </code> (capitales, tiret plat et domaines composés), et <code>first.last@foo.jp</code> (le nom d'utilisateur standard de l'entreprise <code>first.last</code>, avec un domaine de deux lettres&nbsp;<code>jp</code>), en plus de quelques adresses de forme invalide.</p>

<p>Le code de l'application pour la validation du format des emails utilise une <em>expression régulière</em> (ou <em>regex</em>, pour «&nbsp;regular expression&nbsp;» en anglais) pour définir le format, aux côtés de l'argument <code>:format</code> pour la méthode <code>validates</code> (<a class="ref" href="modeling-and-viewing-users-one#code:validates_format_of_email">extrait&nbsp;6.17</a>).</p>

<div class="label" id="code:validates_format_of_email"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 6.17.</span> <span class="description">Valider le format de l'email avec une expression régulière. <br /> <code>app/models/user.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:nom</span><span class="p">,</span> <span class="ss">:email</span>

  <span class="n">email_regex</span> <span class="o">=</span> <span class="sr">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</span>

  <span class="n">validates</span> <span class="ss">:nom</span><span class="p">,</span>  <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span>
                    <span class="ss">:length</span>   <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:maximum</span> <span class="o">=&gt;</span> <span class="mi">50</span> <span class="p">}</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span>
                    <span class="ss">:format</span>   <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="n">email_regex</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Ici, <code>email_regex</code> est une  <em>expression régulière</em>, appelé aussi <em>regex</em>. Le code&nbsp;:</p>

<div class="code"><div class="highlight"><pre>  <span class="n">email_regex</span> <span class="o">=</span> <span class="sr">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span>
                    <span class="ss">:format</span>   <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="n">email_regex</span> <span class="p">}</span>
</pre></div>
</div>


<p>… s'assure que seules les adresses mail que correspondent au modèle seront considérées comme valides.</p>

<p>Mais d'où vient ce modèle&nbsp;?… Les expressions régulières consistent en un langage concis (certains diraient <a href="http://catb.org/jargon/html/L/line-noise.html">illisible</a>) pour «&nbsp;matcher&nbsp;» les modèles de texte&nbsp;; apprendre à construire une expression régulière est un art, et pour commencer, j'ai mis <code>email_regex</code> en pièces into bite-sized pieces (<a class="ref" href="modeling-and-viewing-users-one#table:email_regex">Table&nbsp;6.1</a>).<sup class="footnote" id="fnref:6.16"><a href="#fn:6.16">16</a></sup> Pour apprendre vraiment les expressions régulière, cependant, je considère que le formidable éditeur d'expression régulières <a href="http://www.rubular.com/">Rubular</a> (<a class="ref" href="modeling-and-viewing-users-one#fig:rubular">illustration&nbsp;6.6</a>) est simplement essentiel.<sup class="footnote" id="fnref:6.17"><a href="#fn:6.17">17</a></sup> Le site Rubular est une magnifique interface interactif pour fabriquer des expressions régulières, tout autant qu'un site de référence rapide et pratique aux expressions. Je vous encourage à étudier la <a class="ref" href="modeling-and-viewing-users-one#table:email_regex">Table&nbsp;6.1</a> avec une fenêtre de navigateur ouverte sur Rubular &mdash;&nbsp;aucune lecture conséquente sur les expressions régulières ne pourra remplacer une ou deux heures passées à jouer avec Rubular.</p>

<div class="label" id="table:email_regex"></div>


<div class="table"><div class="center"><table class="tabular"><tr><th class="align_left"><strong>Expression</strong></th><th class="align_left"><strong>Sens</strong></th></tr><tr class="top_bar"><td class="align_left"><tt class="verb">/\A[\w+\-.]+@[a-z\d\-.]+\.[a-z]+\z/i</tt></td><td class="align_left">full regex</td></tr><tr><td class="align_left"><tt class="verb">/</tt></td><td class="align_left">début de l'expression</td></tr><tr><td class="align_left"><tt class="verb">\A</tt></td><td class="align_left">cherche le début de la chaine</td></tr><tr><td class="align_left"><tt class="verb">[\w+\-.]+</tt></td><td class="align_left">au moins un caractère de mot, le signe «&nbsp;+&nbsp;», le signe «&nbsp;-&nbsp;» ou le point</td></tr><tr><td class="align_left"><tt class="verb">@</tt></td><td class="align_left">arobase</td></tr><tr><td class="align_left"><tt class="verb">[a-z\d\-.]+</tt></td><td class="align_left">au moins une lettre, un chiffre, un tiret ou un point</td></tr><tr><td class="align_left"><tt class="verb">\.</tt></td><td class="align_left">un point</td></tr><tr><td class="align_left"><tt class="verb">[a-z]+</tt></td><td class="align_left">au moins une lettre</td></tr><tr><td class="align_left"><tt class="verb">\z</tt></td><td class="align_left">cherche la fin de la chaine</td></tr><tr><td class="align_left"><tt class="verb">/</tt></td><td class="align_left">fin de l'expression régulière</td></tr><tr><td class="align_left"><tt class="verb">i</tt></td><td class="align_left">insensible à la casse</td></tr></table></div><div class="caption"><span class="header">Table 6.1: </span><span class="description">Détail de l'expression régulière pour les emails de l'<a class="ref" href="modeling-and-viewing-users-one#code:validates_format_of_email">extrait&nbsp;6.17</a>.</span></div></div>


<p>En passant, il existe enfait une expression régulière complète pour vérifier les adresses emails en concordance avec le standard officielle, mais ça ne vaut vraiment pas la peine. Celle de l'<a class="ref" href="modeling-and-viewing-users-one#code:validates_format_of_email">extrait&nbsp;6.17</a> est bien, peut-être même meilleure que l'expression officielle.<sup class="footnote" id="fnref:6.18"><a href="#fn:6.18">18</a></sup></p>

<div class="label" id="fig:rubular"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/rubular.png" alt="rubular" /></span></div><div class="caption"><span class="header">Illustration 6.6: </span><span class="description">L'impressionnant éditeur d'expressions régulières <a href="http://www.rubular.com/">Rubular</a>.&nbsp;<a href="http://railstutorial.org/images/figures/rubular-full.png">(taille normale)</a></span></div></div>


<p>Les tests devraient tous réussir maintenant (en fait, les tests pour les adresses mails valides auraient dû toutes réussir&nbsp;; puisque les expressions régulières sont notoirement sujettes à erreur, les tests de validation de l'email sont ici à titre de test de cohérence sur <code>email_regex</code>). Cela signifie qu'il ne reste qu'une seule contrainte de côté&nbsp;: forcer l'adresse email à être unique.</p>

<div class="label" id="sec:uniqueness_validation"></div>


<h3><a id="sec:6.2.4" href="modeling-and-viewing-users-one#sec:uniqueness_validation" class="heading"><span class="number">6.2.4</span> Validation d'unicité</a></h3>


<p>Pour forcer l'unicité des adresses email (de telle sorte que nous puissons les utiliser comme username —&nbsp;nom d'utilisateur), nous allons utiliser l'option <code>:unique</code> de la méthode <code>validates</code>. Mais soyez averti&nbsp;: il existe un piège <em>majeur</em>, donc ne survolez pas cette section, lisez-là soigneusement.</p>

<p>Nous commencerons, comme d'habitude, avec nos tests. Dans nos précédents tests de modèle, nous avons principalement utilisé <code>User.new</code>, qui crée juste un objet Ruby en mémoire, mais pour les tests d'unicité nous avons besoin en fait de déposer un enregistrement dans la base de données.<sup class="footnote" id="fnref:6.19"><a href="#fn:6.19">19</a></sup> Le (premier) test de duplication d'email apparait dans l'<a class="ref" href="modeling-and-viewing-users-one#code:validates_uniqueness_of_email_test">extrait&nbsp;6.18</a>.</p>

<div class="label" id="code:validates_uniqueness_of_email_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 6.18.</span> <span class="description">Un test pour le rejet de la duplication d'une adresse mail. <br /> <code>spec/models/user_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
    <span class="vi">@attr</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:nom</span> <span class="o">=&gt;</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;user@example.com&quot;</span> <span class="p">}</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="s2">&quot;devrait rejeter un email double&quot;</span> <span class="k">do</span>
    <span class="c1"># Place un utilisateur avec un email donné dans la BD.</span>
    <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="vi">@attr</span><span class="p">)</span>
    <span class="n">user_with_duplicate_email</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@attr</span><span class="p">)</span>
    <span class="n">user_with_duplicate_email</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_valid</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>La méthode ici est de créer un utilisateur et alors d'essayer de faire un autre utilisateur qui possèderait la même adresse email (nous utilisons la méthode «&nbsp;bruyante&nbsp;» <code>create!</code>, d'abord vue à l'<a class="ref" href="modeling-and-viewing-users-one#code:raw_user_spec">extrait&nbsp;6.10</a>, de telle sorte qu'elle provoquera une exception, une erreur, si quelque chose ne tourne pas rond. En utilisant <code>create</code>, sans le «&nbsp;bang&nbsp;»&nbsp;<code>!</code>, les risques d'obtenir une erreur silencieuse dans nos tests, une source potentielle de bogue insaisissable). Nous pouvons obtenir que ce test réussisse avec le code de l'<a class="ref" href="modeling-and-viewing-users-one#code:validates_uniqueness_of_email">extrait&nbsp;6.19</a>.<sup class="footnote" id="fnref:6.20"><a href="#fn:6.20">20</a></sup></p>

<div class="label" id="code:validates_uniqueness_of_email"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 6.19.</span> <span class="description">Valider l'unicité de l'adresse mail. <br /> <code>app/models/user.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:presence</span>   <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span>
                    <span class="ss">:format</span>     <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="n">email_regex</span> <span class="p">},</span>
                    <span class="ss">:uniqueness</span> <span class="o">=&gt;</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Nous n'en avons pas fini, cependant. Les adresses mails sont sensible à la casse &mdash;&nbsp;<code>foo@bar.com</code> se rend au même endroit que <code>FOO@BAR.COM</code> ou <code>FoO@BAr.coM</code>&nbsp;&mdash; donc nos validations doivent aussi couvrir ce cas. Nous testons cela avec le code de l'<a class="ref" href="modeling-and-viewing-users-one#code:validates_uniqueness_of_email_case_insensitive_test">extrait&nbsp;6.20</a>.</p>

<div class="label" id="code:validates_uniqueness_of_email_case_insensitive_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 6.20.</span> <span class="description">Un test pour le rejet d'une adresse mail existente, insensible à la casse. <br /> <code>spec/models/user_spec.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>

  <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
    <span class="vi">@attr</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:nom</span> <span class="o">=&gt;</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;user@example.com&quot;</span> <span class="p">}</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">it</span> <span class="s2">&quot;devrait rejeter une adresse email invalide jusqu'à la casse&quot;</span> <span class="k">do</span>
    <span class="n">upcased_email</span> <span class="o">=</span> <span class="vi">@attr</span><span class="o">[</span><span class="ss">:email</span><span class="o">].</span><span class="n">upcase</span>
    <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="vi">@attr</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="ss">:email</span> <span class="o">=&gt;</span> <span class="n">upcased_email</span><span class="p">))</span>
    <span class="n">user_with_duplicate_email</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@attr</span><span class="p">)</span>
    <span class="n">user_with_duplicate_email</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_valid</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Ici nous utilisons la méthode <code>upcase</code> sur les chaines (vue brièvement à la <a class="ref" href="rails-flavored-ruby#sec:blocks">section&nbsp;4.3.2</a>). Ce test fait la même chose que le premier, mais plutôt sur une adresse capitalisée. Si ce test vous semble un petit peu abstrait, prenez votre console et tapez&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console --sandbox</span>
<span class="gp">&gt;&gt; </span><span class="vi">@attr</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:nom</span> <span class="o">=&gt;</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;user@example.com&quot;</span> <span class="p">}</span>
<span class="go">=&gt; {:nom =&gt; &quot;Example User&quot;, :email =&gt; &quot;user@example.com&quot;}</span>
<span class="gp">&gt;&gt; </span><span class="n">upcased_email</span> <span class="o">=</span> <span class="vi">@attr</span><span class="o">[</span><span class="ss">:email</span><span class="o">].</span><span class="n">upcase</span>
<span class="go">=&gt; &quot;USER@EXAMPLE.COM&quot;</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="vi">@attr</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="ss">:email</span> <span class="o">=&gt;</span> <span class="n">upcased_email</span><span class="p">))</span>
<span class="gp">&gt;&gt; </span><span class="n">user_with_duplicate_email</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@attr</span><span class="p">)</span>
<span class="gp">&gt;&gt; </span><span class="n">user_with_duplicate_email</span><span class="o">.</span><span class="n">valid?</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p>Bien entendu, pour le moment, <code>user_with_duplicate_email.valid?</code> est <code>true</code> (<em>vrai</em>), puisque c'est un test d'échec, mais nous voulons qu'il retourne <code>false</code> (<em>faux</em>). Heureusement, <code>:uniqueness</code> (<em>unicité</em>) accepte une option, <code>:case_sensitive</code>, justement dans ce but (<a class="ref" href="modeling-and-viewing-users-one#code:validates_uniqueness_of_email_case_insensitive">extrait&nbsp;6.21</a>).</p>

<div class="label" id="code:validates_uniqueness_of_email_case_insensitive"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 6.21.</span> <span class="description">CValider l'unicité de l'adresse mail, en ignorant la casse. <br /> <code>app/models/user.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">validates</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:presence</span>   <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span>
                    <span class="ss">:format</span>     <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:with</span> <span class="o">=&gt;</span> <span class="n">email_regex</span> <span class="p">},</span>
                    <span class="ss">:uniqueness</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:case_sensitive</span> <span class="o">=&gt;</span> <span class="kp">false</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Notez que nous avons simplement remplacer <code>true</code> par <code>:case_sensitive =&gt; false</code>&nbsp;; Rails en déduit que <code>:uniqueness</code> (<em>l'unicité</em> ) devrait être <code>true</code> (<em>vraie</em>). À ce point, notre application fait (quelque peu) en sorte que l'adresse mail soit unique, et notre suite de tests devrait réussir.</p>

<div class="label" id="sec:the_caveat"></div>


<h4><a id="sec:6.2.4.1" href="modeling-and-viewing-users-one#sec:the_caveat" class="heading">L'avertissement d'unicité</a></h4>


<p>Il y a juste un petit problème, le piège auquel je faisais allusion ci-dessus&nbsp;:</p>

<p><strong>Utiliser <code>validates :uniqueness</code> ne garantit en rien l'unicité.</strong></p>

<p>&rsquo;oh&nbsp;! Mais qu'est-ce qui peut bien mal tourner&nbsp;?… Cela&nbsp;:</p>

<ol>
<li>Alice s'inscrit à l'application exemple, avec l'adresse mail <code>alice@wonderland.com</code>&nbsp;;</li>
<li>Accidentellement, Alice clique <em>deux fois</em> sur le bouton &ldquo;Soumettre&rdquo;, envoyant <em>deux</em> requêtes en succession rapide&nbsp;;</li>
<li>La séquence suivante se produit&nbsp;: la requête 1 crée un utilisateur en mémoire qui réussit la validation, la requête 2 fait de même, l'utilisateur de la requête&nbsp;1 (Alice) est enregistré, l'utilisateur de la requête&nbsp;2 (ALice) est aussi enregistré&nbsp;;</li>
<li>Résultat&nbsp;: deux enregistrements d'utilisateur avec la même adresse email, malgré la validation d'unicité.</li>
</ol>


<p>Si la séquence ci-dessus ne vous semble pas plausible, croyez-moi, elle l'est. Cela survient sur n'importe quel site Rails connaissant un trafic important.<sup class="footnote" id="fnref:6.21"><a href="#fn:6.21">21</a></sup> Heureusement, la solution est simple à implémenter&nbsp;; nous avons juste besoin de force l'unicité au niveau de la base de données elle-même. Notre méthode consiste à créer un <em>index</em> de base de données sur la colonne <code>email</code>, et ensuite d'exiger que cet index soit unique.</p>

<p>L'index email représente une actualisation à nos impératifs du modèle de données, ce qui (comme discuté à la <a class="ref" href="modeling-and-viewing-users-one#sec:database_migrations">section&nbsp;6.1.1</a>) est traité par Rails en utilisant les migrations. Nous avons vu à la <a class="ref" href="modeling-and-viewing-users-one#sec:database_migrations">section&nbsp;6.1.1</a> que générer le modèle User créait automatiquement une nouvelle migration (<a class="ref" href="modeling-and-viewing-users-one#code:users_migration">extrait&nbsp;6.2</a>)&nbsp;; dans le cas présent, nous ajoutons de la structure à un modèle existant, donc nous avons besoin de créer une migration directement en utilisant le générateur <code>migration</code>&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate migration add_email_uniqueness_index
</pre></div>
</div>


<p>Contrairement à la migration pour les utilisateurs, la migration pour l'unicité de l'adresse mail n'est pas pré-définie, donc nous avons besoin de remplir son contenu par le code de l'<a class="ref" href="modeling-and-viewing-users-one#code:email_uniqueness_index">extrait&nbsp;6.22</a>.<sup class="footnote" id="fnref:6.22"><a href="#fn:6.22">22</a></sup></p>

<div class="label" id="code:email_uniqueness_index"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 6.22.</span> <span class="description">La migration pour forcer l'unicité de l'adresse mail. <br /> <code>db/migrate/&lt;timestamp&gt;_add_email_uniqueness_index.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">AddEmailUniquenessIndex</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">up</span>
    <span class="n">add_index</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:email</span><span class="p">,</span> <span class="ss">:unique</span> <span class="o">=&gt;</span> <span class="kp">true</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">down</span>
    <span class="n">remove_index</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">:email</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Ce code utilise une méthode Rails appelée <code>add_index</code> pour ajouter l'index sur la colonne <code>email</code> de la table <code>users</code>. L'index par lui-même ne contraint pas l'unicité, mais c'est l'option <code>:unique =&gt; true</code> qui le fait.</p>

<p>L'étape finale est de migrer la base de données&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rake db:migrate
</pre></div>
</div>


<p>Maintenant, le scénario d'Alice fonctionnera parfaitement&nbsp;: la base de données sauvera l'enregistrement basé sur la première requête, et rejettera la seconde pour violation de la contrainte d'unicité de l'adresse mail (une erreur apparaitra dans le journal Rails, mais elle ne provoque aucun dommage. Vous pouvez bien entendu saisir l'exception <code>ActiveRecord::StatementInvalid</code> qui est provoquée &mdash;&nbsp;voyez <a href="http://github.com/insoshi/insoshi/blob/master/app/controllers/people_controller.rb">Insoshi</a> pour un exemple&nbsp;&mdash; mais dans ce tutoriel nous ne nous occuperons pas de cette étape). L'ajout de l'index sur l'attribut email accomplit un second but, auquel j'ai fait brièvement allusion à la <a class="ref" href="modeling-and-viewing-users-one#sec:finding_user_objects">section&nbsp;6.1.4</a>&nbsp;: il fixe (au sens de «&nbsp;régler&nbsp;». NdT) aussi un problème sérieux de <code>find_by_email</code> (<a class="ref" href="modeling-and-viewing-users-one#sidebar:database_indices">Box&nbsp;6.2</a>).</p>

<div class="label" id="sidebar:database_indices"></div>


<div class="sidebar"><span class="title"><span class="header">Box 6.2.</span><span class="description">Database indices</span></span>
<p>En créant une colonne dans la base de données, il est important de considérer si nous aurons besoin de <em>trouver</em> les enregistremens par cette colonne. Considérez, par exemple, l'attribut <code>email</code> créé par la migration dans l'<a class="ref" href="modeling-and-viewing-users-one#code:users_migration">extrait&nbsp;6.2</a>. Quand nous permettrons les utilisateurs de s'identifier à l'application exemple, en abordant le <a class="ref" href="sign-up#top">chapitre&nbsp;8</a>, nous aurons besoin de trouver l'enregistrement de l'utilisateur correspondant à l'adresse email soumise&nbsp;; malheureusement, basé sur le modèle de données na&iuml;f, la seule façon de trouver un user par son adresse email est de passer en revue <em>chaque</em> rangée d'utilisateur dans la base de données et de comparer son email à celui donné. C'est connu dans le business des base de données comme un <em>full-table scan</em> (<em>scanner complet de la table</em>), et pour un site réel contenant des milliers d'utilisateurs, c'est une très mauvaise chose (une <a href="http://catb.org/jargon/html/B/Bad-Thing.html">Bad Thing</a> en anglais).</p>

<p>Placer un index sur la colonne de l'email fixe ce problème. Pour comprendre un index de base de données, il est utile de considérer l'analogie avec un index de livre. Dans un livre, pour trouver toutes les occurences d'un mot donné, dions &ldquo;foobar&rdquo;, vous aurez à consulter chaque page, une par une, pour trouver chaque &ldquo;foobar&rdquo;. Avec un index de livre, d'un autre côté, vous pouvez juste chercher &ldquo;foobar&rdquo; dans l'index et voir toutes les pages qui contiennent ce mot. Un index de base de données fonctionne essentiellement de la même façon.</p>
</div>



<div class="label" id="sec:viewing_users"></div>


<h2><a id="sec:6.3" href="modeling-and-viewing-users-one#sec:viewing_users" class="heading"><span class="number">6.3</span> Affichage des utilisateurs</a></h2>


<p>Nous n'en avons pas tout à fait fini avec le modèle utilisateur de base &mdash;&nbsp;nous avons encore besoin d'ajouter des mots de passe, tâche qui sera accomplie au <a class="ref" href="modeling-and-viewing-users-two#top">chapitre&nbsp;7</a>&nbsp;&mdash; mais nous en avons fait suffisamment pour faire une page minimale pour pouvoir afficher les informations de l'utilisateur. Cela permettra une introduction en douceur dans l'organisation de type REST des actions utilisateur de notre site. Puisque c'est juste un démonstration grossière pour le moment, il n'y aura pas de tests dans cette section&nbsp;; nous les ajouterons quand nous étofferons la vue de l'utilisater à la <a class="ref" href="modeling-and-viewing-users-two#sec:better_user_views">section&nbsp;7.3</a>.</p>

<div class="label" id="sec:rails_environments"></div>


<h3><a id="sec:6.3.1" href="modeling-and-viewing-users-one#sec:rails_environments" class="heading"><span class="number">6.3.1</span> Débuggae et environnement Rails</a></h3>


<p>À titre de préparation de l'ajout de pages dynamique dans notre application exemple, il est temps à présent d'ajouter des informations de débuggage au layout de notre site (<a class="ref" href="modeling-and-viewing-users-one#code:rails_debug">extrait&nbsp;6.23</a>). Cela affiche des informations utiles sur chaque page en utilisant la méthode intégrée <code>debug</code> et la variable <code>params</code> (que nous étudierons plus en détail à la <a class="ref" href="modeling-and-viewing-users-one#sec:users_show">section&nbsp;6.3.2</a>), comme le montre l'<a class="ref" href="modeling-and-viewing-users-one#fig:home_page_with_debug_rails_3">illustration&nbsp;6.7</a>.</p>

<div class="label" id="code:rails_debug"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 6.23.</span> <span class="description">Ajout d'information de débuggage au layout du site. <br /> <code>app/views/layouts/application.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>
  .
  .
  .
  <span class="nt">&lt;body&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
      .
      .
      .
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;layouts/footer&#39;</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">debug</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="k">if</span> <span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">development?</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>
</div></div>


<p>Puise nous ne voulons pas afficher les informations de débuggage à l'utilisateurs de l'application déployée online, nous utilisons&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="k">if</span> <span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">development?</span>
</pre></div>
</div>


<p>… pour les restreindre à l'<em>environnement de développement</em>. Bien que nous ayons déjà abordé l'évidence des environnements Rails précédemment (tout récemment à la <a class="ref" href="modeling-and-viewing-users-one#sec:creating_user_objects">section&nbsp;6.1.3</a>), c'est la première fois que cela nous importe vraiment.</p>

<div class="label" id="fig:home_page_with_debug_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/home_page_with_debug_rails_3.png" alt="home_page_with_debug_rails_3" /></span></div><div class="caption"><span class="header">Illustration 6.7: </span><span class="description">La page d'accueil de l'application exemple (<a href="http://localhost:3000/"><tt>/</tt></a>) avec des informations de débuggage en bas de page.&nbsp;<a href="http://railstutorial.org/images/figures/home_page_with_debug_rails_3-full.png">(taille normale)</a></span></div></div>


<p>Rails arrive équipé de trois environnements&nbsp;: <code>test</code>, <code>development</code>, et <code>production</code>.<sup class="footnote" id="fnref:6.23"><a href="#fn:6.23">23</a></sup> L'environnement par défaut de la console est l'environnement <code>développement</code>&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console </span>
<span class="go">Loading development environment (Rails 3.0.7)</span>
<span class="gp">&gt;&gt; </span><span class="no">Rails</span><span class="o">.</span><span class="n">env</span>
<span class="go">=&gt; &quot;development&quot;</span>
<span class="gp">&gt;&gt; </span><span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">development?</span>
<span class="go">=&gt; true</span>
<span class="gp">&gt;&gt; </span><span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">test?</span>
<span class="go">=&gt; false</span>
</pre></div>
</div>


<p>Comme vous pouvez le voir, Rails fournit un objet <code>Rails</code> avec un attribut <code>env</code> et des méthodes booléennes associées. En particulier, <code>Rails.env.development?</code> est <code>true</code> (<em>vrai</em>) seulement dans l'environnement développement, donc le code Ruby embarqué&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">debug</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="k">if</span> <span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">development?</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>… ne sera pas inséré dans les applications en mode production ou test (insérer les informations de débuggage pour les tests ne cause probablement pas de dommage, mais ça n'est probablement pas bon non plus, donc il est mieux de restreindre l'affichage des débuggage à l'environnement de développement seulement).</p>

<p>Nous vous avez jamais besoin de jouer la console dans un environnement différent (pour débugguer un test par exemple), vous pouvez passer l'environnement en paramètre au script <code>console</code>&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console test</span>
<span class="go">Loading test environment (Rails 3.0.7)</span>
<span class="gp">&gt;&gt; </span><span class="no">Rails</span><span class="o">.</span><span class="n">env</span>
<span class="go">=&gt; &quot;test&quot;</span>
</pre></div>
</div>


<p>Comme pour la console, <code>development</code> (<em>développement</em>) est l'environnement par défaut du server Rails local, mais vous pouvez aussi le faire jouer dans un environnement différent&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails server --environment production
</pre></div>
</div>


<p>Si vous voyez votre application jouer en mode production, elle ne fonctionnera pas sans base de données, laquelle peut être créée en jouant <code>rake db:migrate</code> en mode production&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rake db:migrate <span class="nv">RAILS_ENV</span><span class="o">=</span>production
</pre></div>
</div>


<p>(Je trouve déroutant que la console, le serveur, et les commandes de migration précisent l'environnement, quand ce n'est pas l'environnement par défaut, de trois façons mutuellement incompatibles, c'est pourquoi j'ai pris le soin de les montrer les trois.)</p>

<p>En passant, si vous avez déployé votre application exemple sur Heroku, vous pouvez voir son environnement en utilisant la commande <code>heroku</code> qui fournit sa propre console à distance&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ heroku console</span>
<span class="go">Ruby console for yourapp.heroku.com</span>
<span class="gp">&gt;&gt; </span><span class="no">Rails</span><span class="o">.</span><span class="n">env</span>
<span class="go">=&gt; &quot;production&quot;</span>
<span class="gp">&gt;&gt; </span><span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">production?</span>
<span class="go">=&gt; true</span>
</pre></div>
</div>


<p>Naturellement, puisque Heroku est une plateforme pour les sites en mode production, il joue chaque application dans cette environnement production.</p>

<div class="label" id="sec:users_show"></div>


<h3><a id="sec:6.3.2" href="modeling-and-viewing-users-one#sec:users_show" class="heading"><span class="number">6.3.2</span> Modèle User, Vue, Contrôleur</a></h3>


<p>Afin de faire une page pour voir un utilisateur, nous allons utiliser le <em>modèle</em> User pour créer un utilisateur dans la base de données, créer une vue (<em>View</em>) pour afficher quelques unes de ses informations, et ajouter alors une action au contrôleur (<em>Controller</em>) pour traiter les requête de navigateur. En d'autres termes, pour la première fois dans ce tutoriel, nous allons voir en un seul endroit les trois éléments de l'architecture MVC (<em>Modèle-Vue-Contrôleur</em>) discutée pour la première fois à la <a class="ref" href="beginning#sec:mvc">section&nbsp;1.2.6</a>.</p>

<p>Notre première étape consiste à créer un utilisateur en utilisant la console, que nous prendrons soin de ne <em>pas</em> démarrer en mode <em>bac à sable</em> puisque cette fois le but est de sauver l'enregistrement dans la base de données&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="go">Loading development environment (Rails 3.0.7)</span>
<span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">:nom</span> <span class="o">=&gt;</span> <span class="s2">&quot;Michael Hartl&quot;</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;mhartl@example.com&quot;</span><span class="p">)</span>
<span class="go">=&gt; #&lt;User id: 1, nom: &quot;Michael Hartl&quot;, email: &quot;mhartl@example.com&quot;,</span>
<span class="go">created_at: &quot;2010-01-07 23:05:14&quot;, updated_at: &quot;2010-01-07 23:05:14&quot;&gt;</span>
</pre></div>
</div>


<p>Pour vérifier deux fois que ça a marché, regardons la rangée dans la base de données de développement en utilisant le Navigateur de base de données (<a class="ref" href="modeling-and-viewing-users-one#fig:sqlite_user_row">illustration&nbsp;6.8</a>). Notez que les colonnes correspondent aux attributs du modèle de données défini à la <a class="ref" href="modeling-and-viewing-users-one#sec:user_model">section&nbsp;6.1</a>.</p>

<div class="label" id="fig:sqlite_user_row"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/sqlite_user_row.png" alt="sqlite_user_row" /></span></div><div class="caption"><span class="header">Illustration 6.8: </span><span class="description">Une rangée utilisateur dans la base de données SQLite <code>db/development.sqlite3</code>.&nbsp;<a href="http://railstutorial.org/images/figures/sqlite_user_row-full.png">(taille normale)</a></span></div></div>


<p>Ensuite vient la vue, qui est minimale pour mettre l'accent sur le fait que c'est juste une démonstration (<a class="ref" href="modeling-and-viewing-users-one#code:stub_user_view">extrait&nbsp;6.24</a>). Nous utilisons le fichier standard de Rails pour afficher un utilisateur, <code>app/views/users/show.html.erb</code>&nbsp;; contrairement à la vue <code>new.html.erb</code>, que nous avons créée avec le générateur de l'<a class="ref" href="filling-in-the-layout#code:generate_users_controller">extrait&nbsp;5.23</a>, le fichier <code>show.html.erb</code> n'existe pas encore, donc vous devez le créer à la main.</p>

<div class="label" id="code:stub_user_view"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 6.24.</span> <span class="description">Une vue brute pour afficher les informations de l'utilisateur. <br /> <code>app/views/users/show.html.erb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">nom</span> <span class="cp">%&gt;</span>, <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">email</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p>Cette vue utilise du code Ruby embarqué pour afficher le nom et l'adresse mail de l'utilisateur, en assumant l'existence d'une variable d'instance appelée <code>@user</code>. Bien sûr, la page finale d'affichage de l'utilisateur sera très différente, et n'affichera pas publiquement l'adresse email.</p>

<p>Enfin, nous ajouterons l'action <code>show</code> au contrôleur Users (correspondant à la vue <code>show.html.erb</code>) avec le code de l'<a class="ref" href="modeling-and-viewing-users-one#code:user_show_action">extrait&nbsp;6.25</a>, qui définit la variable d'instance <code>@user</code> nécessaire à la vue.</p>

<div class="label" id="code:user_show_action"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 6.25.</span> <span class="description">Le contrôleur Users avec une action <code>show</code>. <br /> <code>app/controllers/users_controller.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">show</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">new</span>
    <span class="vi">@title</span> <span class="o">=</span> <span class="s2">&quot;S'inscrire&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Ici nous avons donné [(a little ahead of ourselves)(un peu plus de nous-mêmes)] en utilisant le paramètre (<code>params</code>) objet standard de Rails pour récupérer l'identifiant (<code>id</code>) de l'utilisateur. Quand nous ferons la requête appropriée au contrôleur User, <code>params[:id]</code> sera l'id&nbsp;utilisateur&nbsp;<code>1</code>, donc l'effet est le même que la commande <code>find</code> (<em>trouver</em>)&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>


<p>… que nous avons vu à la <a class="ref" href="modeling-and-viewing-users-one#sec:finding_user_objects">section&nbsp;6.1.4</a>.</p>

<p>Bien que la vue et l'action <code>show</code> soient maintenant toutes deux définies, nous n'avons toujours pas de moyen de voir la page elle-même. Cela nécessite de définir la règle adéquate dans le fichier de routage de Rails, comme nous allons le voir dans la section suivante.</p>

<div class="label" id="sec:a_users_resource"></div>


<h3><a id="sec:6.3.3" href="modeling-and-viewing-users-one#sec:a_users_resource" class="heading"><span class="number">6.3.3</span> Une ressource Users</a></h3>


<p>Nous méthode pour afficher la page d'affichage de l'utilisateur va suivre les conventions de l'architecture RESTE préconisée pour les applications Rails. Ce style est basé sur les idées de <em>transfer d'état représentationnel</em> (<em>representational state transfer</em>) identifié et nommé par l'expert en informatique <a href="http://en.wikipedia.org/wiki/Roy_Fielding">Roy Fielding</a> dans sa dissertation doctorale <em>Architectural Styles and the Design of Network-based Software Architectures</em> (<em>Styles architecturaux et conception des architectures de logiciels de réseau</em>).<sup class="footnote" id="fnref:6.24"><a href="#fn:6.24">24</a></sup> Le style de conception REST met l'accent sur la représentation des données en tant que <em>ressources</em> qui peuvent être créées, affichées, actualisées et détruites &mdash;&nbsp;quatre actions correspondant au quatre opérations fondamentales <tt>POST</tt>, <tt>GET</tt>, <tt>PUT</tt> et <tt>DELETE</tt> définies par le <a href="http://en.wikipedia.org/wiki/Hypertext_Transfer_Protocol">standard HTTP</a> (<a class="ref" href="static-pages#sidebar:get_etc">Box&nbsp;3.1</a>).</p>

<p>Quand on suit les principes REST, les ressources sont typiquement référencées en utlisant des noms de ressource et un identifiant unique. Qu'est-ce que ça signifie dans le contexte des utilisateurs &mdash;&nbsp;auxquels nous penserons en tant que «&nbsp;<em>ressource</em> Users&nbsp;» (<em>ressource Utilisateurs</em>)&nbsp;&mdash; est que nous devrions voir l'utilisateur avec un identifiant de&nbsp;<code>1</code> en envoyant une requête <tt>GET</tt> à l'URL <tt>/users/1</tt>. Ici, l'action <code>show</code> est <em>implicite</em> dans le type de requête &mdash;&nbsp;quand les fonctionnalités REST de Rails sont activées, les requêtes <tt>GET</tt> sont automatiquement traitées par l'action <code>show</code> action.</p>

<div class="label" id="fig:user_show_exception_caught"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_show_exception_caught.png" alt="user_show_exception_caught" /></span></div><div class="caption"><span class="header">Illustration 6.9: </span><span class="description">L'effet initial de l'URL <a href="http://localhost:3000/users/1"><tt>/users/1</tt></a>.&nbsp;<a href="http://railstutorial.org/images/figures/user_show_exception_caught-full.png">(taille normale)</a></span></div></div>


<p>Malheureusement, l'URL <a href="http://localhost:3000/users/1"><tt>/users/1</tt></a> ne fonctionne pas encore, à cause d'une erreur de routage (<a class="ref" href="modeling-and-viewing-users-one#fig:user_show_exception_caught">illustration&nbsp;6.9</a>). Nous pouvons faire fonctionner l'URL utilisateur de style REST en ajoutant <em>users</em> (<em>utilisateurs</em>) comme ressource au fichier <code>config/routes.rb</code>, comme vu dans l'<a class="ref" href="modeling-and-viewing-users-one#code:users_resource">extrait&nbsp;6.26</a>.</p>

<div class="label" id="code:users_resource"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 6.26.</span> <span class="description">Ajout d'une ressource Users au fichier de routage. <br /> <code>config/routes.rb</code></span>       
</div>
<div class="code"><div class="highlight"><pre><span class="no">SampleApp</span><span class="o">::</span><span class="no">Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">resources</span> <span class="ss">:users</span>

  <span class="n">match</span> <span class="s1">&#39;/signup&#39;</span><span class="p">,</span>  <span class="ss">:to</span> <span class="o">=&gt;</span> <span class="s1">&#39;users#new&#39;</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Après avoir ajouter les routes pour la ressource Users, l'URL <a href="http://localhost:3000/users/1"><tt>/users/1</tt></a> fonctionne parfaitement (<a class="ref" href="modeling-and-viewing-users-one#fig:user_show_rails_3">illustration&nbsp;6.10</a>).</p>

<div class="label" id="fig:user_show_rails_3"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_show_rails_3.png" alt="user_show_rails_3" /></span></div><div class="caption"><span class="header">Illustration 6.10: </span><span class="description">La page d'affichage de l'utilisateur à l'URL <a href="http://localhost:3000/users/1"><tt>/users/1</tt></a> après avoir ajouté une ressource Users.&nbsp;<a href="http://railstutorial.org/images/figures/user_show_rails_3-full.png">(taille normale)</a></span></div></div>


<p>Vous avez peut-être noté que l'<a class="ref" href="modeling-and-viewing-users-one#code:users_resource">extrait&nbsp;6.26</a> a effacé la ligne&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="n">get</span> <span class="s2">&quot;users/new&quot;</span>
</pre></div>
</div>


<p>… vue auparavant dans l'<a class="ref" href="filling-in-the-layout#code:signup_route">extrait&nbsp;5.29</a>. C'est parce que la ligne de ressource ajoutée dans l'<a class="ref" href="modeling-and-viewing-users-one#code:users_resource">extrait&nbsp;6.26</a> n'ajoute pas seulement une URL <tt>/users/1</tt> fonctionnelle&nbsp;; elle confère à notre application exemple toutes les actions nécessaire à une ressource Users <em>RESTful</em>,<sup class="footnote" id="fnref:6.25"><a href="#fn:6.25">25</a></sup> accompagnées d'une grand nombre de routes nommées (<a class="ref" href="filling-in-the-layout#sec:nomd_routes">section&nbsp;5.2.3</a>) pour générer les URLs utilisateur. La résultante de correspondances entre URLs, actions et routes nommées est montrée dans la <a class="ref" href="modeling-and-viewing-users-one#table:RESTful_users">Table&nbsp;6.2</a> (à comparer avec la <a class="ref" href="a-demo-app#table:demo_RESTful_users">Table&nbsp;2.2</a>). Au cours des trois prochains chapitres, nous couvrions toutes les autres entrées de la <a class="ref" href="modeling-and-viewing-users-one#table:RESTful_users">Table&nbsp;6.2</a> à mesure que nous remplirons toutes les actions nécessaires pour faire de Users une ressource pleinement conforme à REST.</p>

<div class="label" id="table:RESTful_users"></div>


<div class="table"><div class="center"><table class="tabular"><tr><th class="align_left"><strong>HTTP request</strong></th><th class="align_left"><strong>URL</strong></th><th class="align_left"><strong>Action</strong></th><th class="align_left"><strong>Route nommée</strong></th><th class="align_left"><strong>But</strong></th></tr><tr class="top_bar"><td class="align_left"><tt>GET</tt></td><td class="align_left"><tt>/users</tt></td><td class="align_left"><code>index</code></td><td class="align_left"><code>users_path</code></td><td class="align_left">liste des utilisateurs</td></tr><tr><td class="align_left"><tt>GET</tt></td><td class="align_left"><tt>/users/1</tt></td><td class="align_left"><code>show</code></td><td class="align_left"><code>user_path(1)</code></td><td class="align_left">page affichant l'utilisateur d'id <code>1</code></td></tr><tr><td class="align_left"><tt>GET</tt></td><td class="align_left"><tt>/users/new</tt></td><td class="align_left"><code>new</code></td><td class="align_left"><code>new_user_path</code></td><td class="align_left">page créant un nouvel utilisateur (signup)</td></tr><tr><td class="align_left"><tt>POST</tt></td><td class="align_left"><tt>/users</tt></td><td class="align_left"><code>create</code></td><td class="align_left"><code>users_path</code></td><td class="align_left">créer un nouvel utilisateur</td></tr><tr><td class="align_left"><tt>GET</tt></td><td class="align_left"><tt>/users/1/edit</tt></td><td class="align_left"><code>edit</code></td><td class="align_left"><code>edit_user_path(1)</code></td><td class="align_left">page d'édition de l'utilisateur d'id <code>1</code></td></tr><tr><td class="align_left"><tt>PUT</tt></td><td class="align_left"><tt>/users/1</tt></td><td class="align_left"><code>update</code></td><td class="align_left"><code>user_path(1)</code></td><td class="align_left">actualiser l'utilisateur d'id <code>1</code></td></tr><tr><td class="align_left"><tt>DELETE</tt></td><td class="align_left"><tt>/users/1</tt></td><td class="align_left"><code>destroy</code></td><td class="align_left"><code>user_path(1)</code></td><td class="align_left">détruire l'utilisateur d'id <code>1</code></td></tr></table></div><div class="caption"><span class="header">Table 6.2: </span><span class="description">Routes RESTful fournies par la ressource Users dans l'<a class="ref" href="modeling-and-viewing-users-one#code:users_resource">extrait&nbsp;6.26</a>.</span></div></div>




<div class="label" id="sec:params_in_debug"></div>


<h4>Les <a id="sec:6.3.3.1" href="modeling-and-viewing-users-one#sec:params_in_debug" class="heading"><code>params</code> en débuggage (<code>debug</code>)</a></h4>


<p>Avant de quitter la page d'affichage de l'utilisateur, nous allons prendre un moment pour examiner les informations de débuggage produite par l'<a class="ref" href="modeling-and-viewing-users-one#code:rails_debug">extrait&nbsp;6.23</a>. Si vous regardez attentivement l'<a class="ref" href="modeling-and-viewing-users-one#fig:user_show_rails_3">illustration&nbsp;6.10</a>, vous verrez qu'elle fournit des informations utiles à propos de la page rendue&nbsp;:<sup class="footnote" id="fnref:6.26"><a href="#fn:6.26">26</a></sup></p>

<div class="code"><div class="highlight"><pre><span class="nn">---</span> <span class="kt">!map</span><span class="l-Scalar-Plain">:ActiveSupport::HashWithIndifferentAccess</span>
<span class="l-Scalar-Plain">action</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">show</span>
<span class="l-Scalar-Plain">id</span><span class="p-Indicator">:</span> <span class="s">&quot;1&quot;</span>
<span class="l-Scalar-Plain">controller</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">users</span>
</pre></div>
</div>


<p>C'est une représentation YAML<sup class="footnote" id="fnref:6.27"><a href="#fn:6.27">27</a></sup> des <code>params</code>, laquelle (comme suggéré par le nom <code>HashWithIndifferentAccess</code>) est basiquement une table de hachage. Nous voyons que son contrôleur est <code>users</code>, son action est <code>show</code>, et son attribut <code>id</code> est <code>"1"</code>. Bien que vous aurez rarement l'occasion d'utiliser <code>params[:controller]</code> ou <code>params[:action]</code>, utiliser <code>params[:id]</code> pour extraire l'identifiant de l'URL est un idiom Rails courant. En particulier, nous utilisons le code&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
</pre></div>
</div>


<p>… dans l'<a class="ref" href="modeling-and-viewing-users-one#code:user_show_action">extrait&nbsp;6.25</a> pour trouver l'utilisateur d'id&nbsp;<code>1</code> (la méthode <code>find</code> sait comment convertir la chaine de caractères&nbsp;<code>"1"</code> en entier&nbsp;<code>1</code>).</p>

<p>L'information <code>debug</code> fournit souvent des retours utiles au cours du développement des applications Rails et je vous suggère d'adopter l'habitude de le consulter chaque fois que votre application se comporte de façon inattendue.</p>

<h2><a id="sec:6.4" href="modeling-and-viewing-users-one#sec:6.4" class="heading"><span class="number">6.4</span> Conclusion</a></h2>


<p>Ce chapitre est la première moitié du processus en deux temps de la création d'un modèle utilisateur (<em>User</em>) fonctionnel. Nos utilisateurs ont maintenant des attributs <code>nom</code> et <code>email</code>, chacun armé de validations contraignant leur valeur. Nous avons aussi amorcé une page d'affichage de l'utilisateur et une ressource utilistaur basée sur l'architecture REST. Au <a class="ref" href="modeling-and-viewing-users-two#top">chapitre&nbsp;7</a>, nous achèverons le processus en ajouter des mots de passe et des vues de l'utilisateur plus utiles.</p>

<p>Si vous utilisez Git, il serait bien de <em>commettre</em> un nouveau dépôt si vous ne l'avez pas fait depuis un moment&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">&quot;Finished first cut of the User model&quot;</span>
</pre></div>
</div>


<h2><a id="sec:6.5" href="modeling-and-viewing-users-one#sec:6.5" class="heading"><span class="number">6.5</span> Exercises</a></h2>




<ol>
<li>Lisez l'API Rails à l'entrée pour <code>ActiveRecord::Base</code> pour avoir une idée de ses capacités.</li>
<li>Étudiez l'entrée pour la méthode <code>validates</code> pour en apprendre plus sur ses capacités et ses options.</li>
<li>Passer un peu de temps (une ou deux heures) à vous amuser avec <a href="http://www.rubular.com/">Rubular</a>.</li>
</ol>




<div class="navigation">  <a class="prev_page" href="filling-in-the-layout#top">
    &laquo;&nbsp;<span class="number">chapitre 5</span> Poursuivre la mise en page
  </a>
  <a class="next_page" href="modeling-and-viewing-users-two#top">
    <span class="number">chapitre 7</span> Modéliser et afficher les utilisateurs, partie II&nbsp;&raquo;
  </a>
</div><div class="footnotes">
<ol>
<li id="fn:6.1"><a href="http://gomockingbird.com/">Mockingbird</a> ne support pas les images personnalisées comme la photo de profil de l'<a class="ref" href="modeling-and-viewing-users-one#fig:profile_mockup">illustration&nbsp;6.1</a>&nbsp;; je l'ai déposé à la main en utilisant <a href="http://www.adobe.com/products/fireworks/">Adobe Fireworks</a>. L'hippo ici vient de <a href="http://www.flickr.com/photos/43803060@N00/24308857/">http://www.flickr.com/photos/43803060@N00/24308857/</a>.&nbsp;<a class="arrow" href="#fnref:6.1">&uarr;</a></li>
<li id="fn:6.2">Ce nom (Active Record) vient de la &ldquo;<a href="http://en.wikipedia.org/wiki/Active_record_pattern">pattern active record</a>&rdquo;, identifiée et nommée dans <em>Patterns of Enterprise Application Architecture</em> par Martin Fowler.&nbsp;<a class="arrow" href="#fnref:6.2">&uarr;</a></li>
<li id="fn:6.3">Proconcé &ldquo;ess-quiou-elle&rdquo;, bien que la prononciation alternative &ldquo;sequel&rdquo; (en anglais) est aussi courante.&nbsp;<a class="arrow" href="#fnref:6.3">&uarr;</a></li>
<li id="fn:6.4">Dans ses toutes premières incarnations, Rails requiérait la connaissance des DLL de SQL. Même après que Rails eut ajouté les migrations,  Even after Rails added migrations, mettre en place l'ancien base de données par défaut (MySQL) était nécessaire. Heureusement, comme noté à la <a class="ref" href="beginning#sec:rails_server">section&nbsp;1.2.5</a>, Rails utilise maintenant SQLite par défaut, ce qui enregistre les données sous la forme de simples fichiers &mdash;&nbsp;aucun réglage n'est nécessaire.&nbsp;<a class="arrow" href="#fnref:6.4">&uarr;</a></li>
<li id="fn:6.5">Occasionnellement, il est nécessaire de comprendre la couche d'abstraction, mais l'un des but de ce tutoriel est de rendre tout le code indépendant de la base de données (je vous assure que c'est un but qui vaut le coup, en général). Dans le cas où vous auriez à écrire le code d'une base de données spécifique pour un déploiement sur Heroku, sachez qu'ils utilisent l'excellent base de données <a href="http://www.postgresql.org/">PostgreSQL</a> (&ldquo;post-gres-cue-ell&rdquo;). PostgreSQL est libre, open-source, et cross-plateforme&nbsp;; si vous développez des applications spécifiquement PostgreSQL, vous pouvez l'installer localement, et configurer Rails pour l'utiliser en mode de développement en éditant le fichier <code>config/database.yml</code>. Une telle configuration dépasse le cadre de ce tutoriel, mais vous trouverez de nombreuses ressources sur le web&nbsp;; utilisez un moteur de recherche pour chercher de l'information actualisée en fonction de votre plateforme.&nbsp;<a class="arrow" href="#fnref:6.5">&uarr;</a></li>
<li id="fn:6.6">En utilisant une adresse email comme <em>username</em>, nous offrons la possibilité théorique de communiquer avec nos utilisateuers dans le futur.&nbsp;<a class="arrow" href="#fnref:6.6">&uarr;</a></li>
<li id="fn:6.7">Ne vous souciez pas de comment l'objet <code>t</code> s'arrange exactement pour faire ça&nbsp;; la beauté des <em>couches d'abstraction</em> tient à ce que nous n'avons pas besoin de le savoir. Nous pouvons juste faire confiance à l'objet&nbsp;<code>t</code> pour faire son travail.&nbsp;<a class="arrow" href="#fnref:6.7">&uarr;</a></li>
<li id="fn:6.8">Nous verrons comment migrer sur un serveur à distance Heroku à la <a class="ref" href="modeling-and-viewing-users-two#sec:heroku_deploy">section&nbsp;7.4.2</a>.&nbsp;<a class="arrow" href="#fnref:6.8">&uarr;</a></li>
<li id="fn:6.9">Officiellement prononcé &ldquo;ess-cue-ell-ite&rdquo; (en anglais.NdT), bien que la (mauvaise)prononciation &ldquo;sequel-ite&rdquo; (en anglais. NdT) soit aussi courante.&nbsp;<a class="arrow" href="#fnref:6.9">&uarr;</a></li>
<li id="fn:6.10">Dans le cas où vous seriez surpris par <code>"2010-01-05 00:57:46"</code>, je n'ai pas écrit ce code après minuit&nbsp;; les <em>timestamps</em> sont enregistrés en <a href="http://en.wikipedia.org/wiki/Coordinated_Universal_Time">Coordonnées de Temps Unversel</a> (UTC), qui pour la plupart des propos est le même que le <a href="http://en.wikipedia.org/wiki/Greenwich_Mean_Time">Temps de Greenwich</a>. Tiré du <a href="http://tf.nist.gov/general/misc.htm">NIST Time and Frequency FAQ</a>:   <strong>Question&nbsp;:</strong> Pourquoi UTC est utilisé comme acronyme de <em>Coordinated Universal Time</em> plutôt que CUT&nbsp;? <strong>Réponse&nbsp;:</strong> En 1970 le système <em>Coordinated Universal Time</em> a été conçu par un groupe consultatif d'experts internationaux à l'intérieur de l'Union Internationale de Communication (International Telecommunication Union, ITU). l'ITU a pensé qu'il serait mieux d'utiliser une simple abréviation pour l'usage dans tous les langages dans le but de minimiser la confusion. Puisqu'aucun accord unanime n'a pu être trouvé sur l'utilisation de soit l'ordre des mots anglais, CUT, soit l'ordre des mots français, TUC, l'acronyme UTC a utilisé en guise de compromis.&nbsp;<a class="arrow" href="#fnref:6.10">&uarr;</a></li>
<li id="fn:6.11">Notez la valeur de <code>user.updated_at</code>. Dites-vous bien que le timestamp était en UTC.&nbsp;<a class="arrow" href="#fnref:6.11">&uarr;</a></li>
<li id="fn:6.12">Les exceptions et la gestion des exceptions est un des sujets avancés de Ruby, et nous n'en aurons pas vraiment besoin dans ce livre. Ils sont importants cependant, et je vous suggère de les étudier en utilisant un livre sur Ruby recommandé à la <a class="ref" href="beginning#sec:comments_for_various_readers">section&nbsp;1.1.1</a>.&nbsp;<a class="arrow" href="#fnref:6.12">&uarr;</a></li>
<li id="fn:6.13">À ceux qui s'inquièteraient que <code>find_by_email</code> serait inefficace s'il y avait une grande quantité d'utilisateurs, je dirais que vous êtes en avance sur la musique. Nous couvrirons ce problème, et sa solution, par le biais des indices de base de données, à la <a class="ref" href="modeling-and-viewing-users-one#sec:uniqueness_validation">section&nbsp;6.2.4</a>.&nbsp;<a class="arrow" href="#fnref:6.13">&uarr;</a></li>
<li id="fn:6.14">(et écrits)&nbsp;<a class="arrow" href="#fnref:6.14">&uarr;</a></li>
<li id="fn:6.15">J'omettrai la sortie des commandes de la console quand elles ne sont pas particulièrement instrutivs &mdash;&nbsp;par exemple, les résultats de <code>User.new</code>.&nbsp;<a class="arrow" href="#fnref:6.15">&uarr;</a></li>
<li id="fn:6.16">Notez que, dans la <a class="ref" href="modeling-and-viewing-users-one#table:email_regex">Table&nbsp;6.1</a>, &ldquo;letter&rdquo; (<em>lettre</em>) signifie en réalité &ldquo;lettre minuscules&rdquo;, mais le <code>i</code> à la fin de l'expression régulière force à ne pas tenir compte de la casse (minuscule/majuscule).&nbsp;<a class="arrow" href="#fnref:6.16">&uarr;</a></li>
<li id="fn:6.17">Si vous le trouvez aussi utile que moi, je vous encourage à <a href="http://bit.ly/donate-to-rubular">faire un don à Rubular</a> pour remercier le développeur <a href="http://lovitt.net/">Michael Lovitt</a> pour son formidable travail.&nbsp;<a class="arrow" href="#fnref:6.17">&uarr;</a></li>
<li id="fn:6.18">Saviez-vous que <code>"Michael Hartl"@example.com</code>, avec des guillemets et une espace<!-- "espace" est féminine en type --> au milieu est une adresse valide, conformément au standard&nbsp;? Aussi surprenant que ça paraisse, c'est vrai &mdash;&nbsp;mais c'est absurde. Si vous n'avez pas une adresse mail ne contenant que des lettres, des nombres, des tirets plats et des points, alors fais l'acquisition d'une autre. N.B. L'expression régulière de l'<a class="ref" href="modeling-and-viewing-users-one#code:validates_format_of_email">extrait&nbsp;6.17</a> permet plus de signes aussi, parce que Gmail (et possiblement d'autres services d'email) font quelque chose d'utile pour eux&nbsp;:  par exemple, pour filtrer les ordres d'Amazon, vous pouvez utiliser <tt>username+amazon@gmail.com</tt>, qui se rendra vers l'adresse Gmail <tt>username@gmail.com</tt>, vous permettant de filtrer la chaine <tt>amazon</tt>.&nbsp;<a class="arrow" href="#fnref:6.18">&uarr;</a></li>
<li id="fn:6.19">Comme indiqué brièvement dans l'introduction de cette section, il existe une base de données de test dédiée, <code>db/test.sqlite3</code>, dans ce but.&nbsp;<a class="arrow" href="#fnref:6.19">&uarr;</a></li>
<li id="fn:6.20">Si vous vous demandez pourquoi la ligne <code>create!</code> de l'<a class="ref" href="modeling-and-viewing-users-one#code:raw_user_spec">extrait&nbsp;6.10</a> ne conduit pas à une erreur en créant une duplication d'utilisateur, c'est parce que les tests Rails sont <em>transactionnels</em>&nbsp;: chaque test est enroulé dans une <a href="http://en.wikipedia.org/wiki/Database_transaction">transaction</a>, qui repart de l'état précédent de la base de données après l'exécution des tests. De cette façon, chaque test s'applique à une base de données fraiche.&nbsp;<a class="arrow" href="#fnref:6.20">&uarr;</a></li>
<li id="fn:6.21">Oui, ça m'est arrivé. Comment croyez-vous que j'ai découvert cette explication&nbsp;?&nbsp;<a class="arrow" href="#fnref:6.21">&uarr;</a></li>
<li id="fn:6.22">Bien sûr, nous pourrions juste éditer le fichier de migration pour la table <code>users</code> de l'<a class="ref" href="modeling-and-viewing-users-one#code:users_migration">extrait&nbsp;6.2</a> mmais ça exigerait de revenir en arrière puis à nouveau en avant. La façon Rails est d'utiliser des migrations différentes chaque fois que nous découvrons que notre modèle de data doit changer.&nbsp;<a class="arrow" href="#fnref:6.22">&uarr;</a></li>
<li id="fn:6.23">Vous pouvez même définir votre propre environnement personnalisé; voyez le <a href="http://railscasts.com/episodes/72-adding-an-environment">Railscast pour ajouter un environement</a> pour les détails.&nbsp;<a class="arrow" href="#fnref:6.23">&uarr;</a></li>
<li id="fn:6.24">Fielding, Roy Thomas. <em>Architectural Styles and the Design of Network-based Software Architectures</em>. Doctoral dissertation, University of California, Irvine, 2000.&nbsp;<a class="arrow" href="#fnref:6.24">&uarr;</a></li>
<li id="fn:6.25">Cela signifie que le <em>routage</em> fonctionne, mais que les pages correspondantes ne fonctionnent pas, elle, à ce point du développement. Par exemple, <tt>/users/1/edit</tt> sera proprement routé vers l'action <code>edit</code> du contrôleur Users, mais puisque l'action <code>edit</code> n'existe pas encore, en fait, invoquer l'URL retournera une erreur.&nbsp;<a class="arrow" href="#fnref:6.25">&uarr;</a></li>
<li id="fn:6.26">Certaines des copies-écran de ce tutoriel montre des informations de débuggage avec des sorties comme <code>!map:HashWithIndifferentAccess</code> au lieu de <code>!map:ActiveSupport::HashWithIndifferentAccess</code>. C'est simplement une différence mineure entre Rails&nbsp;2.3 et Rails&nbsp;3. Puisque les page web rendues sont en grande partie identique entre les deux versions, cette note de bas de page me permet de ne pas avoir à refaire toutes ces copies-écran.&nbsp;<a class="arrow" href="#fnref:6.26">&uarr;</a></li>
<li id="fn:6.27">L'information <code>debug</code> Rails est affichée au format <a href="http://www.yaml.org/">YAML</a> (un <a href="http://catb.org/jargon/html/R/recursive-acronym.html">acronyme récursif</a> signifiant &ldquo;YAML Ain&rsquo;t Markup Language&rdquo;), qui est un format de donnée convivial conçu pour être lu aussi facilement par les  machines <em>que</em> par les humains.&nbsp;<a class="arrow" href="#fnref:6.27">&uarr;</a></li>
</ol>
</div>




