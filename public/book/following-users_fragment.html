<!--
	chapitre : 12 Suivi des utilisateurs
	fichier : following-users_fragment.html
-->

<h1 class="title">Tutoriel Ruby on Rails </h1>


<h1 class="subtitle">  Apprendre Rails par l'exemple</h1>


<h2 class="author">Michael Hartl</h2>



<h1 class="contents">Contenu</h1>


<div id="table_of_contents"><ol>
<li class="chapter"><a href="beginning#top"><span class="number">Chapitre 1</span> De zéro au déploiement</a></li>
<li><ol>
<li class="section"><a href="beginning#sec:introduction"><span class="number">1.1</span> Introduction</a></li>
<li><ol>
<li class="subsection"><a href="beginning#sec:comments_for_various_readers"><span class="number">1.1.1</span> Commentaires pour les lecteurs différents</a></li>
<li class="subsection"><a href="beginning#sec:1.1.2"><span class="number">1.1.2</span> &ldquo;Dimensionner&rdquo; Rails</a></li>
<li class="subsection"><a href="beginning#sec:conventions"><span class="number">1.1.3</span> Conventions utilisées dans ce livre</a></li></ol></li>
<li class="section"><a href="beginning#sec:up_and_running"><span class="number">1.2</span> [(Up and running)(En route pour le démarrage)]</a></li>
<li><ol>
<li class="subsection"><a href="beginning#sec:development_tools"><span class="number">1.2.1</span> Environnements de développement</a></li>
<li><ol>
<li class="subsubsection"><a href="beginning#sec:1.2.1.1">IDEs</a></li>
<li class="subsubsection"><a href="beginning#sec:1.2.1.2">Éditeurs de texte et lignes de commande</a></li>
<li class="subsubsection"><a href="beginning#sec:1.2.1.3">Navigateurs</a></li>
<li class="subsubsection"><a href="beginning#sec:1.2.1.4">Note à propos des outils</a></li></ol></li>
<li class="subsection"><a href="beginning#sec:rubygems"><span class="number">1.2.2</span> Ruby, RubyGems, Rails, et Git</a></li>
<li><ol>
<li class="subsubsection"><a href="beginning#sec:rails_installer_windows">Installation de Rails (Windows)</a></li>
<li class="subsubsection"><a href="beginning#sec:install_git">Installer Git</a></li>
<li class="subsubsection"><a href="beginning#sec:install_ruby">Installer Ruby</a></li>
<li class="subsubsection"><a href="beginning#sec:install_rubygems">Installer RubyGems</a></li>
<li class="subsubsection"><a href="beginning#sec:install_rails">Installer Rails</a></li></ol></li>
<li class="subsection"><a href="beginning#sec:the_first_application"><span class="number">1.2.3</span> La première application</a></li>
<li class="subsection"><a href="beginning#sec:bundler"><span class="number">1.2.4</span> Bundler</a></li>
<li class="subsection"><a href="beginning#sec:rails_server"><span class="number">1.2.5</span> <code>Le serveur rails (rails server)</code></a></li>
<li class="subsection"><a href="beginning#sec:mvc"><span class="number">1.2.6</span> Modèles-Vue-Contrôleur (MVC)</a></li></ol></li>
<li class="section"><a href="beginning#sec:version_control"><span class="number">1.3</span> Contrôle de versions avec Git</a></li>
<li><ol>
<li class="subsection"><a href="beginning#sec:git_setup"><span class="number">1.3.1</span> Installation et réglages</a></li>
<li><ol>
<li class="subsubsection"><a href="beginning#sec:1.3.1.1">Initialisation des réglages système</a></li>
<li class="subsubsection"><a href="beginning#sec:1.3.1.2">Initialisation des réglages du dépôt (repository)</a></li></ol></li>
<li class="subsection"><a href="beginning#sec:adding_and_committing"><span class="number">1.3.2</span> Ajout et mandat de dépôt</a></li>
<li class="subsection"><a href="beginning#sec:1.3.3"><span class="number">1.3.3</span> Qu'est-ce que Git peut faire de bien pour vous&nbsp;?</a></li>
<li class="subsection"><a href="beginning#sec:github"><span class="number">1.3.4</span> GitHub</a></li>
<li class="subsection"><a href="beginning#sec:git_commands"><span class="number">1.3.5</span> Branch, edit, commit, merge</a></li>
<li><ol>
<li class="subsubsection"><a href="beginning#sec:git_branch">Branch</a></li>
<li class="subsubsection"><a href="beginning#sec:git_edit">Edit</a></li>
<li class="subsubsection"><a href="beginning#sec:git_commit">Commit</a></li>
<li class="subsubsection"><a href="beginning#sec:git_merge">Merge</a></li>
<li class="subsubsection"><a href="beginning#sec:git_push">Push</a></li></ol></li></ol></li>
<li class="section"><a href="beginning#sec:deploying"><span class="number">1.4</span> Déploiement</a></li>
<li><ol>
<li class="subsection"><a href="beginning#sec:1.4.1"><span class="number">1.4.1</span> Réglages Heroku</a></li>
<li class="subsection"><a href="beginning#sec:heroku_step_one"><span class="number">1.4.2</span> déploiement Heroku, première étape</a></li>
<li class="subsection"><a href="beginning#sec:1.4.3"><span class="number">1.4.3</span> Déploiement Heroku deployment, seconde étape</a></li>
<li class="subsection"><a href="beginning#sec:heroku_commands"><span class="number">1.4.4</span> Commandes Heroku</a></li></ol></li>
<li class="section"><a href="beginning#sec:beginning_conclusion"><span class="number">1.5</span> Conclusion</a></li></ol></li>
<li class="chapter"><a href="a-demo-app#top"><span class="number">Chapitre 2</span> Une application démo</a></li>
<li><ol>
<li class="section"><a href="a-demo-app#sec:planning_the_application"><span class="number">2.1</span> Planifier l'application</a></li>
<li><ol>
<li class="subsection"><a href="a-demo-app#sec:modeling_users"><span class="number">2.1.1</span> Modéliser les utilisateurs</a></li>
<li class="subsection"><a href="a-demo-app#sec:modeling_microposts"><span class="number">2.1.2</span> Modéliser les micro-messages</a></li></ol></li>
<li class="section"><a href="a-demo-app#sec:demo_users_resource"><span class="number">2.2</span> La ressource Utilisateurs (Users)</a></li>
<li><ol>
<li class="subsection"><a href="a-demo-app#sec:a_user_tour"><span class="number">2.2.1</span> Un tour de l'utilisateur</a></li>
<li class="subsection"><a href="a-demo-app#sec:mvc_in_action"><span class="number">2.2.2</span> MVC en action</a></li>
<li class="subsection"><a href="a-demo-app#sec:weaknesses_of_this_users_resource"><span class="number">2.2.3</span> Faiblesses de la ressource Utilisateurs (Users)</a></li></ol></li>
<li class="section"><a href="a-demo-app#sec:microposts_resource"><span class="number">2.3</span> La ressource Micro-messages (Microposts)</a></li>
<li><ol>
<li class="subsection"><a href="a-demo-app#sec:a_micropost_microtour"><span class="number">2.3.1</span> Un petit tour du micro-message</a></li>
<li class="subsection"><a href="a-demo-app#sec:putting_the_micro_in_microposts"><span class="number">2.3.2</span> Appliquer le <em>micro</em> aux micro-messages</a></li>
<li class="subsection"><a href="a-demo-app#sec:demo_user_has_many_microposts"><span class="number">2.3.3</span> Un utilisateur <code>has_many</code> (<code>possède plusieurs</code>) micro-messages</a></li>
<li class="subsection"><a href="a-demo-app#sec:inheritance_hierarchies"><span class="number">2.3.4</span> Hiérarchie des héritages</a></li>
<li class="subsection"><a href="a-demo-app#sec:deploying_the_demo_app"><span class="number">2.3.5</span> Déployer l'application Démo</a></li></ol></li>
<li class="section"><a href="a-demo-app#sec:2.4"><span class="number">2.4</span> Conclusion</a></li></ol></li>
<li class="chapter"><a href="static-pages#top"><span class="number">Chapitre 3</span> Pages statiques courantes</a></li>
<li><ol>
<li class="section"><a href="static-pages#sec:static_pages"><span class="number">3.1</span> Pages statiques</a></li>
<li><ol>
<li class="subsection"><a href="static-pages#sec:truly_static_pages"><span class="number">3.1.1</span> Pages HTML statiques</a></li>
<li class="subsection"><a href="static-pages#sec:static_pages_with_rails"><span class="number">3.1.2</span> Les pages statiques avec Rails</a></li></ol></li>
<li class="section"><a href="static-pages#sec:first_tests"><span class="number">3.2</span> Premiers tests</a></li>
<li><ol>
<li class="subsection"><a href="static-pages#sec:testing_tools"><span class="number">3.2.1</span> Outils de test</a></li>
<li><ol>
<li class="subsubsection"><a href="static-pages#sec:autotest">Auto-test</a></li></ol></li>
<li class="subsection"><a href="static-pages#sec:TDD"><span class="number">3.2.2</span> TDD : Rouge, Vert, Refactor</a></li>
<li><ol>
<li class="subsubsection"><a href="static-pages#sec:spork">Spork</a></li>
<li class="subsubsection"><a href="static-pages#sec:red">Rouge</a></li>
<li class="subsubsection"><a href="static-pages#sec:green">Vert</a></li>
<li class="subsubsection"><a href="static-pages#sec:refactor">Refactor</a></li></ol></li></ol></li>
<li class="section"><a href="static-pages#sec:slightly_dynamic_pages"><span class="number">3.3</span> Pages (un peu) dynamiques</a></li>
<li><ol>
<li class="subsection"><a href="static-pages#sec:testing_a_title_change"><span class="number">3.3.1</span> Test d'un changement de titre</a></li>
<li class="subsection"><a href="static-pages#sec:passing_title_tests"><span class="number">3.3.2</span> Réussir les tests de titre</a></li>
<li class="subsection"><a href="static-pages#sec:instance_variables_embedded_ruby"><span class="number">3.3.3</span> Variables d'instance et Ruby embarqué</a></li>
<li class="subsection"><a href="static-pages#sec:layouts"><span class="number">3.3.4</span> Supprimer les répétitions avec les <em>layouts</em></a></li></ol></li>
<li class="section"><a href="static-pages#sec:static_pages_conclusion"><span class="number">3.4</span> Conclusion</a></li>
<li class="section"><a href="static-pages#sec:static_pages_Exercices"><span class="number">3.5</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="rails-flavored-ruby#top"><span class="number">Chapitre 4</span> [(Rails-flavored Ruby)(Rails au goût Ruby)]</a></li>
<li><ol>
<li class="section"><a href="rails-flavored-ruby#sec:motivation"><span class="number">4.1</span> Motivation</a></li>
<li><ol>
<li class="subsection"><a href="rails-flavored-ruby#sec:title_helper"><span class="number">4.1.1</span> Un « helper » (« aideur ») pour le titre (<code>title</code>)</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:cascading_style_sheets"><span class="number">4.1.2</span> Feuilles de styles (CSS — Cascading Style Sheets)</a></li></ol></li>
<li class="section"><a href="rails-flavored-ruby#sec:strings_and_methods"><span class="number">4.2</span> Chaines de caractères et méthodes</a></li>
<li><ol>
<li class="subsection"><a href="rails-flavored-ruby#sec:comments"><span class="number">4.2.1</span> Commentaires</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:strings"><span class="number">4.2.2</span> Chaines de caractères</a></li>
<li><ol>
<li class="subsubsection"><a href="rails-flavored-ruby#sec:printing">Impression</a></li>
<li class="subsubsection"><a href="rails-flavored-ruby#sec:single_quoted_strings">Chaines de caractères « single-quoté »</a></li></ol></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:objects_and_message_passing"><span class="number">4.2.3</span> Objets et passage de message</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:method_definitions"><span class="number">4.2.4</span> Définition de méthode</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:back_to_the_title_helper"><span class="number">4.2.5</span> Retour à l'« helper » de titre</a></li></ol></li>
<li class="section"><a href="rails-flavored-ruby#sec:other_data_structures"><span class="number">4.3</span> Autres structures de données</a></li>
<li><ol>
<li class="subsection"><a href="rails-flavored-ruby#sec:arrays_and_ranges"><span class="number">4.3.1</span> Tableaux et rangs</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:blocks"><span class="number">4.3.2</span> Blocs</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:hashes_and_symbols"><span class="number">4.3.3</span> Tables de hachage et symboles</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:css_revisited"><span class="number">4.3.4</span> CSS revisitées</a></li></ol></li>
<li class="section"><a href="rails-flavored-ruby#sec:ruby_classes"><span class="number">4.4</span> Classes Ruby</a></li>
<li><ol>
<li class="subsection"><a href="rails-flavored-ruby#sec:constructors"><span class="number">4.4.1</span> Constructeurs</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:a_class_of_our_own"><span class="number">4.4.2</span> Héritages de classes</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:modifying_built_in_classes"><span class="number">4.4.3</span> Modifier les classes d'origine</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:a_controller_class"><span class="number">4.4.4</span> Classe de contrôleur</a></li>
<li class="subsection"><a href="rails-flavored-ruby#sec:a_user_class"><span class="number">4.4.5</span> Classe utiliateur</a></li></ol></li>
<li class="section"><a href="rails-flavored-ruby#sec:Exercices"><span class="number">4.5</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="filling-in-the-layout#top"><span class="number">Chapitre 5</span> Poursuivre la mise en page</a></li>
<li><ol>
<li class="section"><a href="filling-in-the-layout#sec:structure"><span class="number">5.1</span> Ajout de structure</a></li>
<li><ol>
<li class="subsection"><a href="filling-in-the-layout#sec:adding_to_the_layout"><span class="number">5.1.1</span> Navigation du site</a></li>
<li class="subsection"><a href="filling-in-the-layout#sec:custom_css"><span class="number">5.1.2</span> Personnalisation CSS</a></li>
<li class="subsection"><a href="filling-in-the-layout#sec:partials"><span class="number">5.1.3</span> Partiels (Partials)</a></li></ol></li>
<li class="section"><a href="filling-in-the-layout#sec:layout_links"><span class="number">5.2</span> Liens pour la mise en page</a></li>
<li><ol>
<li class="subsection"><a href="filling-in-the-layout#sec:integration_tests"><span class="number">5.2.1</span> Test d'intégration</a></li>
<li class="subsection"><a href="filling-in-the-layout#sec:rails_routes"><span class="number">5.2.2</span> Routes Rails</a></li>
<li class="subsection"><a href="filling-in-the-layout#sec:named_routes"><span class="number">5.2.3</span> Nommer les routes</a></li></ol></li>
<li class="section"><a href="filling-in-the-layout#sec:user_signup"><span class="number">5.3</span> Inscription de l'utilisateur : une première étape</a></li>
<li><ol>
<li class="subsection"><a href="filling-in-the-layout#sec:users_controller"><span class="number">5.3.1</span> Contrôleur Utilisateur (Users controller)</a></li>
<li class="subsection"><a href="filling-in-the-layout#sec:signup_url"><span class="number">5.3.2</span> URL d'inscription</a></li></ol></li>
<li class="section"><a href="filling-in-the-layout#sec:layout_conclusion"><span class="number">5.4</span> Conclusion</a></li>
<li class="section"><a href="filling-in-the-layout#sec:layout_Exercices"><span class="number">5.5</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="modeling-and-viewing-users-one#top"><span class="number">Chapitre 6</span> Modéliser et afficher les utilisateurs, partie I</a></li>
<li><ol>
<li class="section"><a href="modeling-and-viewing-users-one#sec:user_model"><span class="number">6.1</span> Modèle utilisateur (User model)</a></li>
<li><ol>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:database_migrations"><span class="number">6.1.1</span> Migrations de la base de données</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:the_model_file"><span class="number">6.1.2</span> Le fichier modèle</a></li>
<li><ol>
<li class="subsubsection"><a href="modeling-and-viewing-users-one#sec:model_annotation">[(Model annotation)]</a></li>
<li class="subsubsection"><a href="modeling-and-viewing-users-one#sec:accessible_attributes">Attributs accessibles</a></li></ol></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:creating_user_objects"><span class="number">6.1.3</span> Créer des objets Utilisateur</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:finding_user_objects"><span class="number">6.1.4</span> Recherche dans les objets Utilisateurs (Users)</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:updating_user_objects"><span class="number">6.1.5</span> Actualisation des objets Utilisateurs (Users)</a></li></ol></li>
<li class="section"><a href="modeling-and-viewing-users-one#sec:user_validations"><span class="number">6.2</span> Validations utilisateur</a></li>
<li><ol>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:presence_validation"><span class="number">6.2.1</span> Valider l'existence</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:length_validation"><span class="number">6.2.2</span> Valider la longueur</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:format_validation"><span class="number">6.2.3</span> Valider le format</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:uniqueness_validation"><span class="number">6.2.4</span> Valider l'unicité</a></li>
<li><ol>
<li class="subsubsection"><a href="modeling-and-viewing-users-one#sec:the_caveat">L'avertissement d'unicité</a></li></ol></li></ol></li>
<li class="section"><a href="modeling-and-viewing-users-one#sec:viewing_users"><span class="number">6.3</span> Afficher les utilisateurs</a></li>
<li><ol>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:rails_environments"><span class="number">6.3.1</span> Débuggage et environnements Rails</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:users_show"><span class="number">6.3.2</span> Modèle, Vue et Contrôleur Utilisateur</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-one#sec:a_users_resource"><span class="number">6.3.3</span> Ressource Utilisateurs</a></li>
<li><ol>
<li class="subsubsection"><a href="modeling-and-viewing-users-one#sec:params_in_debug">[(<code>params</code> in <code>debug</code>)]</a></li></ol></li></ol></li>
<li class="section"><a href="modeling-and-viewing-users-one#sec:6.4"><span class="number">6.4</span> Conclusion</a></li>
<li class="section"><a href="modeling-and-viewing-users-one#sec:6.5"><span class="number">6.5</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="modeling-and-viewing-users-two#top"><span class="number">Chapitre 7</span> Modéliser et afficher les utilisateurs, partie II</a></li>
<li><ol>
<li class="section"><a href="modeling-and-viewing-users-two#sec:insecure_passwords"><span class="number">7.1</span> Mots de passe non sûrs</a></li>
<li><ol>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:password_validations"><span class="number">7.1.1</span> Valider le mot de passe</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:password_migration"><span class="number">7.1.2</span> Migrer un mot de passe</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:an_active_record_callback"><span class="number">7.1.3</span> Un <em>callback</em> de l'Active Record</a></li></ol></li>
<li class="section"><a href="modeling-and-viewing-users-two#sec:secure_passwords"><span class="number">7.2</span> Sécuriser les mots de passe</a></li>
<li><ol>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:a_secure_password_test"><span class="number">7.2.1</span> Test de mot de passe sûr</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:secure_password_theory"><span class="number">7.2.2</span> Un peu de théorie sur la sécurisation des mots de passe</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:implementing_has_password"><span class="number">7.2.3</span> Implémenter la méthode <code>has_password?</code></a></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:an_authenticate_method"><span class="number">7.2.4</span> Méthode d'authentification</a></li></ol></li>
<li class="section"><a href="modeling-and-viewing-users-two#sec:better_user_views"><span class="number">7.3</span> Meilleures vues d'utilisateurs</a></li>
<li><ol>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:tests_with_factories"><span class="number">7.3.1</span> Tester la page de l'utilisateur (avec <em>factories</em>)</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:a_name_and_a_gravatar"><span class="number">7.3.2</span> Un nom et un Gravatar</a></li>
<li><ol>
<li class="subsubsection"><a href="modeling-and-viewing-users-two#sec:a_gravatar_helper">Un « helper » de Gravatar</a></li></ol></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:a_user_sidebar"><span class="number">7.3.3</span> Une barre utilisateur latérale</a></li></ol></li>
<li class="section"><a href="modeling-and-viewing-users-two#sec:7.4"><span class="number">7.4</span> Conclusion</a></li>
<li><ol>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:7.4.1"><span class="number">7.4.1</span> Dépôt Git</a></li>
<li class="subsection"><a href="modeling-and-viewing-users-two#sec:heroku_deploy"><span class="number">7.4.2</span> Déploiement Heroku</a></li></ol></li>
<li class="section"><a href="modeling-and-viewing-users-two#sec:more_modeling_users_Exercices"><span class="number">7.5</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="sign-up#top"><span class="number">Chapitre 8</span> Inscription</a></li>
<li><ol>
<li class="section"><a href="sign-up#sec:signup_form"><span class="number">8.1</span> Formulaire d'inscription</a></li>
<li><ol>
<li class="subsection"><a href="sign-up#sec:using_form_for"><span class="number">8.1.1</span> Utiliser  <code>form_for</code></a></li>
<li class="subsection"><a href="sign-up#sec:the_form_html"><span class="number">8.1.2</span> Le formulaire HTML</a></li></ol></li>
<li class="section"><a href="sign-up#sec:signup_failure"><span class="number">8.2</span> Échec de l'inscription</a></li>
<li><ol>
<li class="subsection"><a href="sign-up#sec:testing_failure"><span class="number">8.2.1</span> Test de l'échec</a></li>
<li class="subsection"><a href="sign-up#sec:a_working_form"><span class="number">8.2.2</span> Un formulaire fonctionnel</a></li>
<li class="subsection"><a href="sign-up#sec:signup_error_messages"><span class="number">8.2.3</span> Inscription&nbsp;: messages d'erreur</a></li>
<li class="subsection"><a href="sign-up#sec:filtering_parameter_logging"><span class="number">8.2.4</span> Filtrer les paramètres d'identification</a></li></ol></li>
<li class="section"><a href="sign-up#sec:signup_success"><span class="number">8.3</span> Succès de l'inscription</a></li>
<li><ol>
<li class="subsection"><a href="sign-up#sec:testing_success"><span class="number">8.3.1</span> Tester le succès de l'inscription</a></li>
<li class="subsection"><a href="sign-up#sec:the_finished_signup_form"><span class="number">8.3.2</span> Le formulaire d'inscription finalisé</a></li>
<li class="subsection"><a href="sign-up#sec:the_flash"><span class="number">8.3.3</span> Le message «&nbsp;flash&nbsp;»</a</a></li>
<li class="subsection"><a href="sign-up#sec:the_first_signup"><span class="number">8.3.4</span> La première inscription</a></li></ol></li>
<li class="section"><a href="sign-up#sec:rspec_integration_tests"><span class="number">8.4</span> Test d'intégration RSpec</a></li>
<li><ol>
<li class="subsection"><a href="sign-up#sec:integration_tests_with_style"><span class="number">8.4.1</span> Tests d'intégration avec les styles</a></li>
<li class="subsection"><a href="sign-up#sec:failed_signup"><span class="number">8.4.2</span> Un échec d'inscription ne devrait pas créer un nouvel utilisateur</a></li>
<li class="subsection"><a href="sign-up#sec:successful_signup"><span class="number">8.4.3</span> Le succès d'une inscription devrait créer un nouvel utilisateur</a></li></ol></li>
<li class="section"><a href="sign-up#sec:8.5"><span class="number">8.5</span> Conclusion</a></li>
<li class="section"><a href="sign-up#sec:signup_Exercices"><span class="number">8.6</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="sign-in-sign-out#top"><span class="number">Chapitre 9</span> Connexion, déconnexion</a></li>
<li><ol>
<li class="section"><a href="sign-in-sign-out#sec:sessions"><span class="number">9.1</span> Les sessions</a></li>
<li><ol>
<li class="subsection"><a href="sign-in-sign-out#sec:sessions_controller"><span class="number">9.1.1</span> Le contrôleur de session</a></li>
<li class="subsection"><a href="sign-in-sign-out#sec:signin_form"><span class="number">9.1.2</span> Formulaire d'identification</a></li></ol></li>
<li class="section"><a href="sign-in-sign-out#sec:signin_failure"><span class="number">9.2</span> Échec de l'identification</a></li>
<li><ol>
<li class="subsection"><a href="sign-in-sign-out#sec:reviewing_form_submission"><span class="number">9.2.1</span> Examen de la soumission du formulaire</a></li>
<li class="subsection"><a href="sign-in-sign-out#sec:failed_signin"><span class="number">9.2.2</span> Échec de l'identification (test et code)</a></li></ol></li>
<li class="section"><a href="sign-in-sign-out#sec:signin_success"><span class="number">9.3</span> Succès de l'identification</a></li>
<li><ol>
<li class="subsection"><a href="sign-in-sign-out#sec:the_completed_create_action"><span class="number">9.3.1</span> L'action <code>create</code> («&nbsp;créer&nbsp;») finalisée</a></li>
<li class="subsection"><a href="sign-in-sign-out#sec:remember_me"><span class="number">9.3.2</span> Se souvenir de moi</a></li>
<li class="subsection"><a href="sign-in-sign-out#sec:current_user"><span class="number">9.3.3</span> Utilisateur courant</a></li></ol></li>
<li class="section"><a href="sign-in-sign-out#sec:signing_out"><span class="number">9.4</span> Déconnexion</a></li>
<li><ol>
<li class="subsection"><a href="sign-in-sign-out#sec:destroying_sessions"><span class="number">9.4.1</span> Détruire la session</a></li>
<li class="subsection"><a href="sign-in-sign-out#sec:signin_upon_signup"><span class="number">9.4.2</span> Connection à l'inscription</a></li>
<li class="subsection"><a href="sign-in-sign-out#sec:changing_the_layout_links"><span class="number">9.4.3</span> Changement des liens de la mise en plage</a></li>
<li class="subsection"><a href="sign-in-sign-out#sec:signin_out_integration_tests"><span class="number">9.4.4</span> Test d'intégration de l'identification/déconnexion</a></li></ol></li>
<li class="section"><a href="sign-in-sign-out#sec:9.5"><span class="number">9.5</span> Conclusion</a></li>
<li class="section"><a href="sign-in-sign-out#sec:sign_in_out_Exercices"><span class="number">9.6</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="updating-showing-and-deleting-users#top"><span class="number">Chapitre 10</span> Actualiser, afficher et supprimer de l'utilisateur</a></li>
<li><ol>
<li class="section"><a href="updating-showing-and-deleting-users#sec:updating_users"><span class="number">10.1</span> Actualiser l'utilisateur</a></li>
<li><ol>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:edit_form"><span class="number">10.1.1</span> Formulaire de modification</a></li>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:enabling_edits"><span class="number">10.1.2</span> Permettre les modifications</a></li></ol></li>
<li class="section"><a href="updating-showing-and-deleting-users#sec:protecting_pages"><span class="number">10.2</span> Protéger les pages</a></li>
<li><ol>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:requiring_signed_in_users"><span class="number">10.2.1</span> Utilisateurs identifiés requis</a></li>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:requiring_the_right_user"><span class="number">10.2.2</span> Nécessité du bon utilisateur</a></li>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:friendly_forwarding"><span class="number">10.2.3</span> Redirection conviviale</a></li></ol></li>
<li class="section"><a href="updating-showing-and-deleting-users#sec:showing_users"><span class="number">10.3</span> Afficher les utilisateurs</a></li>
<li><ol>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:user_index"><span class="number">10.3.1</span> Liste des utilisateurs</a></li>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:sample_users"><span class="number">10.3.2</span> Exemples d'utilisateurs</a></li>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:pagination"><span class="number">10.3.3</span> Pagination</a></li>
<li><ol>
<li class="subsubsection"><a href="updating-showing-and-deleting-users#sec:testing_pagination">Test de la pagination</a></li></ol></li>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:partial_refactoring"><span class="number">10.3.4</span> Restructuration des partielles</a></li></ol></li>
<li class="section"><a href="updating-showing-and-deleting-users#sec:destroying_users"><span class="number">10.4</span> Supprimer des utilisateurs</a></li>
<li><ol>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:administrative_users"><span class="number">10.4.1</span> Utilisateurs administrateurs</a></li>
<li><ol>
<li class="subsubsection"><a href="updating-showing-and-deleting-users#sec:revisiting_attr_accessible">Révision de <code>attr_accessible</code></a></li></ol></li>
<li class="subsection"><a href="updating-showing-and-deleting-users#sec:the_destroy_action"><span class="number">10.4.2</span> L'action <code>destroy</code> («&nbsp;supprimer&nbsp;»)</a></li></ol></li>
<li class="section"><a href="updating-showing-and-deleting-users#sec:10.5"><span class="number">10.5</span> Conclusion</a></li>
<li class="section"><a href="updating-showing-and-deleting-users#sec:updating_deleting_Exercices"><span class="number">10.6</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="user-microposts#top"><span class="number">Chapitre 11</span> Micro-messages d'utilisateur</a></li>
<li><ol>
<li class="section"><a href="user-microposts#sec:a_micropost_model"><span class="number">11.1</span> Le modèle Micropost («&nbsp;Micro-message&nbsp;»)</a></li>
<li><ol>
<li class="subsection"><a href="user-microposts#sec:the_basic_model"><span class="number">11.1.1</span> Le modèle initial</a></li>
<li><ol>
<li class="subsubsection"><a href="user-microposts#sec:accessible_attribute">Attributs accessibles</a></li></ol></li>
<li class="subsection"><a href="user-microposts#sec:user_micropost_associations"><span class="number">11.1.2</span> Associations Utilisateur/micro-messages</a></li>
<li class="subsection"><a href="user-microposts#sec:ordering_and_dependency"><span class="number">11.1.3</span> Affinements du micro-message</a></li>
<li><ol>
<li class="subsubsection"><a href="user-microposts#sec:default_scope">Portée par défaut</a></li>
<li class="subsubsection"><a href="user-microposts#sec:dependent_destroy">Dependent: destroy (dépendances de la suppression)</a></li></ol></li>
<li class="subsection"><a href="user-microposts#sec:micropost_validations"><span class="number">11.1.4</span> Validations du micro-message</a></li></ol></li>
<li class="section"><a href="user-microposts#sec:showing_microposts"><span class="number">11.2</span> Afficher les micro-messages</a></li>
<li><ol>
<li class="subsection"><a href="user-microposts#sec:augmenting_the_user_show_page"><span class="number">11.2.1</span> Etoffement de la page de l'utilisateur</a></li>
<li class="subsection"><a href="user-microposts#sec:sample_microposts"><span class="number">11.2.2</span> Exemples de micro-messages</a></li></ol></li>
<li class="section"><a href="user-microposts#sec:manipulating_microposts"><span class="number">11.3</span> Manipuler les micro-messages</a></li>
<li><ol>
<li class="subsection"><a href="user-microposts#sec:access_control"><span class="number">11.3.1</span> Contrôle de l'accès</a></li>
<li class="subsection"><a href="user-microposts#sec:creating_microposts"><span class="number">11.3.2</span> Créer des micro-messages</a></li>
<li class="subsection"><a href="user-microposts#sec:a_proto_feed"><span class="number">11.3.3</span> Une proto-alimentation</a></li>
<li class="subsection"><a href="user-microposts#sec:destroying_microposts"><span class="number">11.3.4</span> Supprimer des micro-messages</a></li>
<li class="subsection"><a href="user-microposts#sec:testing_the_new_home_page"><span class="number">11.3.5</span> Test de la nouvelle page d'accueil</a></li></ol></li>
<li class="section"><a href="user-microposts#sec:11.4"><span class="number">11.4</span> Conclusion</a></li>
<li class="section"><a href="user-microposts#sec:micropost_Exercices"><span class="number">11.5</span> Exercices</a></li></ol></li>
<li class="chapter"><a href="following-users#top"><span class="number">Chapitre 12</span> Suivi des utilisateurs</a></li>
<li><ol>
<li class="section"><a href="following-users#sec:the_relationship_model"><span class="number">12.1</span> Le modèle Relation (Relationship model)</a></li>
<li><ol>
<li class="subsection"><a href="following-users#sec:a_problem_with_the_data_model"><span class="number">12.1.1</span> Un problème du modèle de données (et sa solution)</a></li>
<li class="subsection"><a href="following-users#sec:relationship_user_associations"><span class="number">12.1.2</span> Associations Utilisateur/Relations</a></li>
<li class="subsection"><a href="following-users#sec:relationship_validations"><span class="number">12.1.3</span> Validations</a></li>
<li class="subsection"><a href="following-users#sec:following"><span class="number">12.1.4</span> Auteurs suivis</a></li>
<li class="subsection"><a href="following-users#sec:followers"><span class="number">12.1.5</span> Lecteurs</a></li></ol></li>
<li class="section"><a href="following-users#sec:a_web_interface_for_following_and_followers"><span class="number">12.2</span> Une interface web pour les auteurs suivis et les lecteurs</a></li>
<li><ol>
<li class="subsection"><a href="following-users#sec:sample_following_data"><span class="number">12.2.1</span> Exemple de donnée de suivi</a></li>
<li class="subsection"><a href="following-users#sec:stats_and_a_follow_form"><span class="number">12.2.2</span> Statistiques et formulaire de suivi</a></li>
<li class="subsection"><a href="following-users#sec:following_and_followers_pages"><span class="number">12.2.3</span> Pages d'auteurs suivis et de lecteurs</a></li>
<li class="subsection"><a href="following-users#sec:a_working_follow_button_the_standard_way"><span class="number">12.2.4</span> Un bouton de suivi fonctionnant de façon standard</a></li>
<li class="subsection"><a href="following-users#sec:a_working_follow_button_with_ajax"><span class="number">12.2.5</span> Un bouton fonctionnant avec Ajax</a></li></ol></li>
<li class="section"><a href="following-users#sec:the_status_feed"><span class="number">12.3</span> L'état de l'alimention</a></li>
<li><ol>
<li class="subsection"><a href="following-users#sec:motivation_and_strategy"><span class="number">12.3.1</span> Motivation et stratégie</a></li>
<li class="subsection"><a href="following-users#sec:a_first_feed_implementation"><span class="number">12.3.2</span> Une première implémentation de peuplement</a></li>
<li class="subsection"><a href="following-users#sec:scopes_subselects_and_a_lambda"><span class="number">12.3.3</span> Portées, sous-requêtes et fonction <em>lambda</em></a></li>
<li class="subsection"><a href="following-users#sec:the_new_status_feed"><span class="number">12.3.4</span> Nouvel état de l'alimentation</a></li></ol></li>
<li class="section"><a href="following-users#sec:following_conclusion"><span class="number">12.4</span> Conclusion</a></li>
<li><ol>
<li class="subsection"><a href="following-users#sec:extensions_to_the_sample_application"><span class="number">12.4.1</span> Extensions de l'application exemple</a></li>
<li><ol>
<li class="subsubsection"><a href="following-users#sec:replies">Réponses</a></li>
<li class="subsubsection"><a href="following-users#sec:messaging">Notification</a></li>
<li class="subsubsection"><a href="following-users#sec:follower_notifications">Notifications aux lecteurs</a></li>
<li class="subsubsection"><a href="following-users#sec:password_reminders">Rappel du mot de passe</a></li>
<li class="subsubsection"><a href="following-users#sec:signup_confirmation">Confirmation d'inscription</a></li>
<li class="subsubsection"><a href="following-users#sec:rss_feed">Alimentation RSS</a></li>
<li class="subsubsection"><a href="following-users#sec:rest_api">REST API</a></li>
<li class="subsubsection"><a href="following-users#sec:search">Recherche</a></li></ol></li>
<li class="subsection"><a href="following-users#sec:guide_to_further_resources"><span class="number">12.4.2</span> Guide vers d'autres ressources</a></li></ol></li>
<li class="section"><a href="following-users#sec:following_Exercices"><span class="number">12.5</span> Exercices</a></li></ol></li></ol></div>


<div id="main_content"></div>

<p> <span class="preamble">
 <span id="foreword">
<strong> Avant-propos</strong> <br />
 </span>
 </span></p>

<p>Ma précédente compagnie (CD Baby) fut une des premières à basculer intégralement vers Ruby on Rails, et à rebasculer aussi intégralement vers PHP (googlez-moi si vous voulez prendre la mesure du drame). On m'a tellement recommandé ce livre Michael Hartl que je n'ai pu faire autrement que de le lire. C'est ainsi que le <em>Tutoriel Ruby on Rails</em> m'a fait revenir à nouveau à Rails.</p>
<p>Bien qu'ayant parcouru de nombreux livres sur Rails, c'est ce tutoriel-là qui m'a véritablement «&nbsp;mis en possession&nbsp;» de Rails. Tout est fait ici «&nbsp;à la manière de Rails&nbsp;» —&nbsp;une manière qui ne m'avait jamais semblé naturelle avant que je ne lise ce livre. C'est aussi le seul ouvrage sur Rails qui met en place, d'un bout à l'autre, un <em>Développement Dirigé par les Tests</em> (<em>Test-Driven Development</em>), une approche que je savais hautement recommandée par les experts mais dont je n'avais jamais compris aussi bien la pertinence que dans ce livre. Enfin, en incluant Git, GitHub et Heroku dans les exemples de la démonstration, l'auteur vous donne vraiment le goût de ce qu'est le développement d'un projet dans la vie réelle. Et le exemples de code ne sont pas en reste.</p> 
	
<p>La narration linéaire adoptée par ce tutoriel est vraiment un bon format. Personnellement, j'ai étudié <em>Le Tutoriel Rails</em> en trois longues journées, en faisant tous les exemples et les exercices proposés à la fin de chaque chapitre. C'est en lisant ce livre du début à la fin, sans sauter la moindre partie, qu'on en tire tout le bénéfice.</p>

<p>Régalez-vous&nbsp;!</p>

<p><a href="http://sivers.org/">Derek Sivers</a> (<a href="http://sivers.org/">sivers.org</a>) <br />
<em>Précédemment&nbsp;: Fondateur de </em> <a href="http://www.cdbaby.com/"><em>CD Baby</em></a> <br />
<em>Actuellement&nbsp;: Fondateur de </em> <a href="http://thoughts.pro/"><em>Thoughts Ltd.</em></a> <br /></p>

<p> <span class="preamble">
<strong> Remerciements</strong> <br />
 </span></p>

<p>Ce <em>Tutoriel Ruby on Rails</em> doit beaucoup à mon livre précédent sur Rails, <em>RailsSpace</em>, et donc à mon co-auteur <a href="http://aure.com/">Aurelius Prochazka</a>. J'aimerais remercier Aure à la fois pour le travail qu'il a accompli sur ce précédent livre et pour son soutien pour le présent ouvrage. J'aimerais aussi remercier Debra Williams Cauley, mon éditeur pour les deux ouvrages&nbsp;; aussi longtemps qu'elle jouera avec moi au baseball, je continuerai d'écrire des livres pour elle.</p>

<p>J'aimerais remercier une longue liste de Rubyistes qui m'ont parlé et inspiré au cours des années&nbsp;: David Heinemeier Hansson, Yehuda Katz, Carl Lerche, Jeremy Kemper, Xavier Noria, Ryan Bates, Geoffrey Grosenbach, Peter Cooper, Matt Aimonetti, Gregg Pollack, Wayne&nbsp;E. Seguin, Amy Hoy, Dave Chelimsky, Pat Maddox, Tom Preston-Werner, Chris Wanstrath, Chad Fowler, Josh Susser, Obie Fernandez, Ian McFarland, Steven Bristol, Giles Bowkett, Evan Dorn, Long Nguyen, James Lindenbaum, Adam Wiggins, Tikhon Bernstam, Ron Evans, Wyatt Greene, Miles Forrest, les gens bien de Pivotal Labs, le gang Heroku, les mecs de thoughtbot et l'équipe de GitHub. Enfin, tellement, tellement, tellement de lecteurs —&nbsp;beaucoup trop pour les citer tous&nbsp;— qui ont contribué par leur rapport de bogues et leurs suggestions durant l'écriture de ce livre, et je tiens à saluer leur aide sans laquelle ce livre ne serait pas ce qu'il est. <br /></p>

<p> <span class="preamble">
 <span id="author">
<strong> À propos de l'auteur</strong> <br />
 </span>
 </span></p>

<p><a href="http://michaelhartl.com/">Michael Hartl</a> est programmeur, éducateur et entrepreneur. Il est le co-auteur de <em>RailsSpace</em>, un tutoriel Rails publié en 2007, et a été co-fondateur et développeur en chef de <a href="http://insoshi.com/">Insoshi</a>, une plateforme de réseau social <a href="http://github.com/popular/forked">populaire</a> en Ruby on Rails. Précédement, il a enseigné la théorie et la physique informatique au <a href="http://www.caltech.edu/">California Institute of Technology</a> (Caltech), où il a reçu le Lifetime Achievement Award for Excellence en enseignement. Michael est diplômé du <a href="http://college.harvard.edu/">Harvard College</a>, a un <a href="http://resolver.caltech.edu/CaltechETD:etd-05222003-161626">Ph.D. en physique</a> (un doctorat. NdT) de <a href="http://www.caltech.edu/">Caltech</a>, et il est ancien élève du programme des entrepreneurs <a href="http://ycombinator.com/">Y&nbsp;Combinator</a>. <br /></p>

<p> <span id="license" class="preamble">
<strong> Copyright et license</strong> <br />
 </span></p>

<p><em>Le Tutoriel Ruby on Rails&nbsp;: apprendre Rails par l'exemple</em>. Copyright &copy; 2010 par Michael Hartl. Tout le code source du <em>Tutoriel Ruby on Rails</em> est disponible sous la license <a href="http://www.opensource.org/licenses/mit-license.php">MIT License</a> et la licence <a href="http://en.wikipedia.org/wiki/Beerware">Beerware License</a>.</p>

<pre class="verbatim">   Copyright (c) 2010 Michael Hartl

   Permission est accordée, à titre gratuit, à toute personne obtenant
   une copie de ce logiciel et la documentation associée, pour faire des 
   modification dans le logiciel sans restriction et sans limitation des
   droits d’utiliser, copier, modifier, fusionner, publier, distribuer,
   concéder sous licence, et / ou de vendre les copies du Logiciel, et à
   autoriser les personnes auxquelles le Logiciel est meublé de le faire, 
   sous réserve des conditions suivantes:

   L’avis de copyright ci-dessus et cette autorisation doit être inclus
   dans toutes les copies ou parties substantielles du Logiciel.

   LE LOGICIEL EST FOURNI «TEL QUEL», SANS GARANTIE D’AUCUNE SORTE, 
   EXPLICITE OU IMPLICITE, Y COMPRIS, MAIS SANS S’Y LIMITER, LES 
   GARANTIES DE QUALITÉ MARCHANDE, ADAPTATION À UN USAGE PARTICULIER ET
   D’ABSENCE DE CONTREFAÇON. EN AUCUN CAS LES AUTEURS OU TITULAIRES DU
   ETRE TENU RESPONSABLE DE TOUT DOMMAGE, RÉCLAMATION OU AUTRES
   RESPONSABILITÉ, SOIT DANS UNE ACTION DE CONTRAT, UN TORT OU AUTRE,
   PROVENANT DE, DE OU EN RELATION AVEC LE LOGICIEL OU L’UTILISATION OU
   DE TRANSACTIONS AUTRES LE LOGICIEL.
	
</pre>




<pre class="verbatim">/*
 * ------------------------------------------------------------
 * &quot;LA LICENCE BEERWARE&quot; (Révision 42)&nbsp;:
 * Michael Hartl a écrit ce code. Aussi longtemps que vous
 * conservez cette note, vous pouvez faire ce que vous voulez
 * de ce travail. Si nous nous rencontrons un jour, et que vous
 * pensez que ce travail en vaut la peine, vous pourrez me
 * payer une bière en retour.
 * ------------------------------------------------------------
 */</pre>


<div id="top"></div>


<h1 class="chapter"><a id="sec:12" href="following-users#top" class="heading"><span class="number">Chapitre 12</span> Suivi des utilisateurs</a></h1>


<p>Dans ce chapitre, nous allons achever le cœur de l'application exemple en ajoutant une “couche sociale” qui permet aux utilisateurs de suivre (et d'arrêter de suivre) d'autres utilisateurs, conduisant à une page d'accueil de chaque utilisateur affichant un état d'alimentation des micro-messages des utilisateurs suivis. Nous ferons aussi des vues pour afficher d'une part les utilisateurs “suiveurs” et d'autre part les utilisateurs que chaque utilisateur suit. Nous apprendrons comment modéliser le siuvi de l'utilisateur dans la <a class="ref" href="following-users#sec:the_relationship_model">section&nbsp;12.1</a>, et faire alors l'interface web dans la <a class="ref" href="following-users#sec:a_web_interface_for_following_and_followers">section&nbsp;12.2</a> (incluant une introducton à la technique Ajax). Pour finir, nous terminerons en développant un état d'alimentation pleinement fonctionnel dans la <a class="ref" href="following-users#sec:the_status_feed">section&nbsp;12.3</a>.</p>

<p>Ce chapitre final contient l'étude du matériau le plus difficile du tutoriel, incluant uns modélisation de données complexe et quelques ruses Ruby/SQL pour créer l'état d'alimentation. Au travers de ces exemples, nous verrons comment Rails peut manipuler et même intriquer les modèles de donées, ce qui devrait bien vous servir quand vous poursuivrez par le développement de vos propres applications et leurs exigences particulières. Pour faciliter la transition du tutoriel au développement indépendant, la <a class="ref" href="following-users#sec:following_conclusion">section&nbsp;12.4</a> contient quelques suggestions d'extensions du cœur de l'application-exemple, accompagné de conseils à propos de ressources plus avancées.</p>

<p>Comme d'habitude, les utilisateurs de Git devraient créer une nouvelle branche sujet&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git checkout -b following-users
</pre></div>
</div>


<p>Parce que les concepts abordés dans ce chapitre sont particulièrement délicats, avant d'écrire la moindre ligne de code, nous allons nous arrêter un moment pour faire un tour d'horizon du suivi d'utilisateur. Comme dans les chapitres précédent, à ce point de départ, nous allons représenter les pages à l'aide de maquettes.<sup class="footnote" id="fnref:12.1"><a href="#fn:12.1">1</a></sup>  Le flux de la page complète fonctionne comme suit&nbsp;: un utilisateur (ici John Calvin) part de sa page de profil (<a class="ref" href="following-users#fig:page_flow_profile_mockup">Illustration&nbsp;12.1</a>) et navigue sur les pages des autres utilisateurs (<a class="ref" href="following-users#fig:page_flow_user_index_mockup">Illustration&nbsp;12.2</a>) pour choisir un utilisateur à suivre. John Calvin navigue sur la page de profil d'un second utilisateur, Thomas Hobbes (<a class="ref" href="following-users#fig:page_flow_other_profile_follow_button_mockup">Illustration&nbsp;12.3</a>), clique sur le bouton “Suivre” (“follow”) pour suivre cet utilisateur. Cela change le bouton &ldquo;Suivre&rdquo; en bouton  &ldquo;Ne plus suivre&rdquo;, et incrémente de 1 le nombre de “lecteurs” (“suiveurs”) de Thomas Hobbes (<a class="ref" href="following-users#fig:page_flow_other_profile_unfollow_button_mockup">Illustration&nbsp;12.4</a>). Retournant à sa page d'accueil, John Calvin voit maintenant le nombre de ses &ldquo;suivis&rdquo; et trouve les micro-messages de Thomas Hobbes dans son état d'alimentation (<a class="ref" href="following-users#fig:page_flow_home_page_feed_mockup">Illustration&nbsp;12.5</a>). Le reste de ce chapitre est dédié à faire fonctionner ce flux de page.</p>

<div class="label" id="fig:page_flow_profile_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/page_flow_profile_mockup.png" alt="page_flow_profile_mockup" /></span></div><div class="caption"><span class="header">Illustration 12.1: </span><span class="description">Maquette de la page de profil de l'utilisateur courant.&nbsp;<a href="http://railstutorial.org/images/figures/page_flow_profile_mockup-full.png">(taille normale)</a></span></div></div>




<div class="label" id="fig:page_flow_user_index_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/page_flow_user_index_mockup.png" alt="page_flow_user_index_mockup" /></span></div><div class="caption"><span class="header">Illustration 12.2: </span><span class="description">Maquette de la recherche d'un utilisateur à suivre.&nbsp;<a href="http://railstutorial.org/images/figures/page_flow_user_index_mockup-full.png">(taille normale)</a></span></div></div>




<div class="label" id="fig:page_flow_other_profile_follow_button_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/page_flow_other_profile_follow_button_mockup.png" alt="page_flow_other_profile_follow_button_mockup" /></span></div><div class="caption"><span class="header">Illustration 12.3: </span><span class="description">Maqquette du profil d'un autre utilisateur, avec le bouton de suivi.&nbsp;<a href="http://railstutorial.org/images/figures/page_flow_other_profile_follow_button_mockup-full.png">(taille normale)</a></span></div></div>




<div class="label" id="fig:page_flow_other_profile_unfollow_button_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/page_flow_other_profile_unfollow_button_mockup.png" alt="page_flow_other_profile_unfollow_button_mockup" /></span></div><div class="caption"><span class="header">Illustration 12.4: </span><span class="description">Maquette du profil avec un bouton pour arrêter de suivre l'utilisateur et incrémentation du nombre de lecteurs.&nbsp;<a href="http://railstutorial.org/images/figures/page_flow_other_profile_unfollow_button_mockup-full.png">(taille normale)</a></span></div></div>




<div class="label" id="fig:page_flow_home_page_feed_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/page_flow_home_page_feed_mockup.png" alt="page_flow_home_page_feed_mockup" /></span></div><div class="caption"><span class="header">Illustration 12.5: </span><span class="description">Maquette de la page d'accueil de l'utilisateur courant, avec l'état de l'alimentation et le compteur d'utilisateurs suivis.&nbsp;<a href="http://railstutorial.org/images/figures/page_flow_home_page_feed_mockup-full.png">(taille normale)</a></span></div></div>




<div class="label" id="sec:the_relationship_model"></div>


<h2><a id="sec:12.1" href="following-users#sec:the_relationship_model" class="heading"><span class="number">12.1</span> Le modèle de relation</a></h2>


<p>Notre première étape dans l'implémentation du suivi de l'utilisateur consiste à construire un modèle de données, ce qui n'est pas aussi simple qu'il peut le paraitre. Naïvement, on pourrait penser qu'une relation <code>has_many</code> pourrait faire l'affaire&nbsp;: <code>has_many</code> (“possède plusieurs…”) utilisateurs suivis et un <code>has_many</code> (“possède plusieurs…”) lecteurs. Comme nous le verrons, cette approche recèle un problème sérieux, et nous apprendrons comment le régler en utilisant plutôt  <code>has_many :through</code> (“possède plusieurs :à travers”). C'est comme si beaucoup d'idées de cette section semblaient évidentes de prime abord, [et qu'il fallait un temps pour ne pas sombre dans le plutôt compliqué modèle de données][and it may take a while for the rather complicated data model to sink in]. Si vous sentez que les choses deviennent confuses, essaie de poursuivre jusqu'à la fin&nbsp;; puis, relisez cette section pour voir si les choses deviennent plus claires.</p>

<div class="label" id="sec:a_problem_with_the_data_model"></div>


<h3><a id="sec:12.1.1" href="following-users#sec:a_problem_with_the_data_model" class="heading"><span class="number">12.1.1</span> Problème avec le modèle de données (et ses solutions)</a></h3>


<p>En guise de première étape vers la construction d'un modèle de données pour le suivi des utilisateurs, examinons un cas typique. Par exemple, considérons un utilisateur en suivant un autre&nbsp;: nous pourrions dire que, par exemple, notre John Calvin suit notre Thomas Hobbes, et donc que notre Thomas  Hobbes est suivi par John Calvin, donc que John Calvin est le <em>lecteur</em> (<em>suiveur</em>) et que Thomas Hobbes est le <em>suivi</em> (<em>followed</em>). En utilisant les conventions de pluriels de Rails, l'ensemble de tous ces <em>utilisateurs suivis</em> (<em>followed</em>) devrait s'appeler les <em>suivis</em> (<em>followeds</em>), mais c'est incorrect grammaticalement [NdT&nbsp;: en anglais]  et maladroit&nbsp;; à la place, nous allons contourner la convention et les appeler <em>Le suivi</em> (<em>following</em>), de telle sorte que <code>user.following</code> contiendra une liste (array) d'utilisateurs suivis. De façon similaire, l'ensemble des utilisateurs suivant un utilisateur donné sont ses “lecteurs” (<em>followers</em>), et <code>user.followers</code> sera une liste (array) de ces lecteurs.</p>

<p>Cela suggère de modeler les utilisateurs “suivants” (<em>following</em> users) comme dans l'<a class="ref" href="following-users#fig:naive_user_has_many_following">illustration&nbsp;12.6</a>, avec une table <code>following</code> et une association <code>has_many</code>. Puisque <code>user.following</code> devrait être une liste (array) d'utilisateur, chaque rangée de la table <code>following</code> devrait avoir besoin d'être un utilisateur, comme identifié par l'identifiant <code>followed_id</code>, avec un identifiant <code>follower_id</code> pour établir l'association.<sup class="footnote" id="fnref:12.2"><a href="#fn:12.2">2</a></sup> En addition, puisque chaque rangée est un utilisateur, nous devrions avoir besoin d'inclure les autres attributs de l'utilisateur, nom, mot de passe, etc.</p>

<div class="label" id="fig:naive_user_has_many_following"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/naive_user_has_many_following.png" alt="naive_user_has_many_following" /></span></div><div class="caption"><span class="header">Illustration 12.6: </span><span class="description">Implémentation naïve du suivi d'utilisateur.</span></div></div>


<p>Le problème avec le modèle de données de l'<a class="ref" href="following-users#fig:naive_user_has_many_following">illustration&nbsp;12.6</a> est qu'il est terriblement redondant&nbsp;: chaque rangée contient non seulement chaque identifiant d'utilisateur suivi, mais aussi toutes ses autres informations &mdash;&nbsp;toute informations qui se trouve <em>déjà</em> dans la table <code>users</code>. Pire encore, pour modeler les “lecteurs” (<em>followers</em>), nous aurions besoin d'une autre table “lecteurs” (<code>followers</code>). Enfin, ce modèle de données est un cauchemar à maintenir, puisque chaque fois qu'un utilisateur a changé (disons) son nom, nous avons besoin d'actualiser pas seulement l'enregistrement de l'utilisateur dans la table <code>users</code> mais aussi <em>chaque rangée contenant l'utilisateur</em> dans nos deux tables <code>following</code> et <code>followers</code>.</p>

<p>Le problème ici est que nous avons manqué un abstraction sous-jacente. Une façon de trouver l'abstraction adéquate est de considérer comment nous pouvons implémenter <em>following</em> dans une application web. Rappelez-vous, d'apèrs la <a class="ref" href="modeling-and-viewing-users-one#sec:a_users_resource">section&nbsp;6.3.3</a>, que l'architecture REST comprend des <em>ressources</em> qui sont créées et détruites. Cela nous conduit à nous poser deux questions&nbsp;: quand un utilisateur suit un autre utilisateur, qu'est-ce qui est créé&nbsp;? Quand un utilisateur <em>ne</em> suit </em>plus</em> un autre utilisateur, qu'est-ce qui est détruit&nbsp;?</p>

<p>Après réflexion, nous voyons que dans ces cas l'application devrait soit créer ou détruire une <em>relation</em> (ou une <em>connexion</em><sup class="footnote" id="fnref:12.3"><a href="#fn:12.3">3</a></sup>) entre deux utilisateurs. Un utilisateur, donc, “possèdes plusieurs :relations” (<code>has_many :relationships</code>), et possèdent plusieurs <code>following</code> (ou <code>followers</code>, <em>lecteurs</em>) <em>à travers</em> ces relations. Effectivement, l'<a class="ref" href="following-users#fig:naive_user_has_many_following">illustration&nbsp;12.6</a> contient déjà le plus gros de l'implémentation&nbsp;: puisque chaque utilisateur suivi est uniquement identifié par son <code>followed_id</code>, nous pourrions convertir <code>following</code> (les <em>lecteurs</em>) en une table <code>relationships</code> (“relations”), omettre les détails de l'utilisateur, et utiliser l'identifiant <code>followed_id</code> pour retrouver l'utilisateur suivi dans la table <code>users</code> (“utilisateurs”). Plus encore, en considérant la relation <em>inverse</em>, nous pourrions utiliser la colonne <code>follower_id</code> pour extraire une liste des lecteurs de l'utilisateur.</p>

<p>Pour faire une liste <code>following</code> des utilisateurs, il serait possible d'extraire une liste des attributs <code>followed_id</code> puis de trouver chaque utilisateur associé à chaque identifiant relevé. Comme vous pouvez vous en douter cependant, Rails possède une façon de rendre cette procédure plus pratique&nbsp;; la technique en question est connue sous le nom <code>has_many :through</code> (“possède plusieurs :à travers”).<sup class="footnote" id="fnref:12.4"><a href="#fn:12.4">4</a></sup> Comme nous le verrons dans la <a class="ref" href="following-users#sec:following">section&nbsp;12.1.4</a>, Rails nous permet de dire qu'un utilisateur donné suit plusieurs utilisateurs <em>à travers</em> (<em>through</em>) une table de relations, en utilisant le code succint&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="n">has_many</span> <span class="ss">:following</span><span class="p">,</span> <span class="ss">:through</span> <span class="o">=&gt;</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="ss">:source</span> <span class="o">=&gt;</span> <span class="s2">&quot;followed_id&quot;</span>
</pre></div>
</div>


<p>Ce code peuple automatiquement <code>user.following</code> avec une liste (array) des utilisateurs suivis. Un diagramme du modèle de données est présenté dans l'<a class="ref" href="following-users#fig:user_has_many_following">illustration&nbsp;12.7</a>.</p>

<div class="label" id="fig:user_has_many_following"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_has_many_following.png" alt="user_has_many_following" /></span></div><div class="caption"><span class="header">Illustration 12.7: </span><span class="description">Modèle du suivi d'utilisateur à travers un modèle de relation intermédiaire.&nbsp;<a href="http://railstutorial.org/images/figures/user_has_many_following-full.png">(taille normale)</a></span></div></div>


<p>Pour commencer l'implémentation, nous générons d'abord un modèle `Relationship` (“Relations”) comme suit&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rails generate model Relationship follower_id:integer followed_id:integer
</pre></div>
</div>


<p>Puis nous devrons retrouver les relations grâce à l'identifiant <code>follower_id</code> et l'identifiant <code>followed_id</code>, nous devrions, pour l'efficacité de la recherche, ajouter une indexation sur chaque colonne, comme montré dans l'<a class="ref" href="following-users#code:relationships_migration">extrait&nbsp;12.1</a>.</p>

<div class="label" id="code:relationships_migration"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 12.1.</span> <span class="description">Ajout d'indexaction à la table <code>relationships</code>. <br /> <code>db/migrate/&lt;timestamp&gt;_create_relationships.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_91ff25aac161add0be9aee1048838120d2d5a496">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=class%20CreateRelationships%20%3C%20ActiveRecord::Migration%0A%20%20def%20self.up%0A%20%20%20%20create_table%20:relationships%20do%20%7Ct%7C%0A%20%20%20%20%20%20t.integer%20:follower_id%0A%20%20%20%20%20%20t.integer%20:followed_id%0A%0A%20%20%20%20%20%20t.timestamps%0A%20%20%20%20end%0A%20%20%20%20add_index%20:relationships,%20:follower_id%0A%20%20%20%20add_index%20:relationships,%20:followed_id%0A%20%20%20%20add_index%20:relationships,%20[:follower_id,%20:followed_id],%20:unique%20=%3E%20true%0A%20%20end%0A%0A%20%20def%20self.down%0A%20%20%20%20drop_table%20:relationships%0A%20%20end%0Aend%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=class%20CreateRelationships%20%3C%20ActiveRecord::Migration%0A%20%20def%20self.up%0A%20%20%20%20create_table%20:relationships%20do%20%7Ct%7C%0A%20%20%20%20%20%20t.integer%20:follower_id%0A%20%20%20%20%20%20t.integer%20:followed_id%0A%0A%20%20%20%20%20%20t.timestamps%0A%20%20%20%20end%0A%20%20%20%20add_index%20:relationships,%20:follower_id%0A%20%20%20%20add_index%20:relationships,%20:followed_id%0A%20%20%20%20add_index%20:relationships,%20[:follower_id,%20:followed_id],%20:unique%20=%3E%20true%0A%20%20end%0A%0A%20%20def%20self.down%0A%20%20%20%20drop_table%20:relationships%0A%20%20end%0Aend%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">CreateRelationships</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">up</span>
    <span class="n">create_table</span> <span class="ss">:relationships</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
      <span class="n">t</span><span class="o">.</span><span class="n">integer</span> <span class="ss">:follower_id</span>
      <span class="n">t</span><span class="o">.</span><span class="n">integer</span> <span class="ss">:followed_id</span>

      <span class="n">t</span><span class="o">.</span><span class="n">timestamps</span>
    <span class="k">end</span>
    <span class="n">add_index</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="ss">:follower_id</span>
    <span class="n">add_index</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="ss">:followed_id</span>
    <span class="n">add_index</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="o">[</span><span class="ss">:follower_id</span><span class="p">,</span> <span class="ss">:followed_id</span><span class="o">]</span><span class="p">,</span> <span class="ss">:unique</span> <span class="o">=&gt;</span> <span class="kp">true</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">down</span>
    <span class="n">drop_table</span> <span class="ss">:relationships</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>L''<a class="ref" href="following-users#code:relationships_migration">extrait&nbsp;12.1</a> inclut également un index <em>composite</em> qui force l'unicité des pairs de (<code>follower_id</code>, <code>followed_id</code>), de telle sorte qu'un utilisateur ne peut pas en suivre un autre plus d'une fois&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="n">add_index</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="o">[</span><span class="ss">:follower_id</span><span class="p">,</span> <span class="ss">:followed_id</span><span class="o">]</span><span class="p">,</span> <span class="ss">:unique</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</pre></div>
</div>


<p>(Comparez ce code à l'unicité de l'adresse email de l'<a class="ref" href="modeling-and-viewing-users-one#code:email_uniqueness_index">extrait&nbsp;6.22</a>.) Comme nous le verrons en commençant la <a class="ref" href="following-users#sec:following">section&nbsp;12.1.4</a>, notre interface utilisateur ne permettra pas cela de se produire, mais ajouter cette unicité permet de générer une erreur si un utilisateur tente de forcer la création d'une duplication de la relation (en utilisant par exemple un outil de commande en ligne comme cURL). Nous pourrions aussi ajouter une validation d'unicité au modèle `Relationship`, mais puisque c'est <em>toujours</em> une erreur de créer la duplication d'une relation, l'indexation unique est suffisante dans notre cas.</p>

<p>Pour créer la table <code>relationships</code>, nous migrons la base de données et préparons le test de cette base de données comme à notre habitude&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rake db:migrate
<span class="gp">$</span> rake db:test:prepare
</pre></div>
</div>


<p>Le résultat est un modèle de données `Relationship` comme montré dans l'<a class="ref" href="following-users#fig:relationship_model">illustration&nbsp;12.8</a>.</p>

<div class="label" id="fig:relationship_model"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/relationship_model.png" alt="relationship_model" /></span></div><div class="caption"><span class="header">Illustration 12.8: </span><span class="description">Le modèle de données `Relationship`.</span></div></div>


<p>Comme pour tout nouveau modèle, avant de poursuivre, nous devrions définir ses attributs accessibles. Dans le case de modèle `Relationship`, l'attribut <code>followed_id</code> (identifiant de l'utilisateur suivi) devrait être accessible, puisque les utilisateurs vont créer des relations par le biais du  web, mais l'attribut <code>follower_id</code> (cet attribut ne doit pas être accessible par le web&nbsp;; dans le cas contraire, des utilisateurs mal intentionnés pourraient “forcer” des lecteurs à les suivre. Le résultat apparait dans l'<a class="ref" href="following-users#code:relationship_attr_accessible">extrait&nbsp;12.2</a>.</p>

<div class="label" id="code:relationship_attr_accessible"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 12.2.</span> <span class="description">Créer une relation avec un attribut <code>followed_id</code> accessible (pas <em>pas avec</em> <code>follower_id</code>). <br /> <code>app/models/relationship.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_35e7b70dfe12fdbbd8a0db2bc65ba35b8d81de3e">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=class%20Relationship%20%3C%20ActiveRecord::Base%0A%20%20attr_accessible%20:followed_id%0Aend%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=class%20Relationship%20%3C%20ActiveRecord::Base%0A%20%20attr_accessible%20:followed_id%0Aend%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Relationship</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:followed_id</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="sec:relationship_user_associations"></div>


<h3><a id="sec:12.1.2" href="following-users#sec:relationship_user_associations" class="heading"><span class="number">12.1.2</span> Association Utilisateur/Relations</a></h3>


<p>Avant d'implémenter les suivis et les suiveurs (lecteurs), nous avons d'abord besoin d'établir l'association entre les utilisateurs et les relations. Un utilisateur <code>has_many</code> (“possède plusieurs…”) relations, et —&nbsp;puisqu'une relation implique </em>deux</em> utilisateurs&nbsp;— une Relation <code>belongs_to</code> (“appartient à…”) l'utilisateur suiveur (le lecteur) et l'utilisateur suivi (l'auteur).</p>

<p>Comme avec les micro-messages dans la <a class="ref" href="user-microposts#sec:user_micropost_associations">section&nbsp;11.1.2</a>, nous créerons de nouvelles relations en utilisant l'association d'utilisateur, avec un code tel que&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="n">user</span><span class="o">.</span><span class="n">relationships</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:followed_id</span> <span class="o">=&gt;</span> <span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="p">)</span>
</pre></div>
</div>


<p>Nous commençons avec un test, montré dans l'<a class="ref" href="following-users#code:relationship_create_test">extrait&nbsp;12.3</a>, qui construit une variable d'instance <code>@relationships</code> (utilisé plus ci-dessous) en s'assurant qu'elle puisse être enregistrée en utilisant la méthode <code>save!</code> (“sauver!”). Comme pour la méthode <code>create!</code> (“créer!”), la méthode <code>save!</code> entraine une erreur, une exception, (grâce au point d'exclamation)  si l'enregistrement échoue&nbsp;; comparez cela à l'utilisation de <code>create!</code> dans l'<a class="ref" href="user-microposts#code:micropost_belongs_to_user_spec">extrait&nbsp;11.4</a>.</p>

<div class="label" id="code:relationship_create_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 12.3.</span> <span class="description">Test de la création de la Relation avec la méthode <code>save!</code>. <br /> <code>spec/models/relationship_spec.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_d0581e36d403877e5a4a0b2778200f4da7fefec0">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=require%20'spec_helper'%0A%0Adescribe%20Relationship%20do%0A%0A%20%20before(:each)%20do%0A%20%20%20%20@follower%20=%20Factory(:user)%0A%20%20%20%20@followed%20=%20Factory(:user,%20:email%20=%3E%20Factory.next(:email))%0A%20%20%20%20%0A%20%20%20%20@relationship%20=%20@follower.relationships.build(:followed_id%20=%3E%20@followed.id)%0A%20%20end%0A%0A%20%20it%20%22should%20create%20a%20new%20instance%20given%20valid%20attributes%22%20do%0A%20%20%20%20@relationship.save!%0A%20%20end%0Aend%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=require%20'spec_helper'%0A%0Adescribe%20Relationship%20do%0A%0A%20%20before(:each)%20do%0A%20%20%20%20@follower%20=%20Factory(:user)%0A%20%20%20%20@followed%20=%20Factory(:user,%20:email%20=%3E%20Factory.next(:email))%0A%20%20%20%20%0A%20%20%20%20@relationship%20=%20@follower.relationships.build(:followed_id%20=%3E%20@followed.id)%0A%20%20end%0A%0A%20%20it%20%22should%20create%20a%20new%20instance%20given%20valid%20attributes%22%20do%0A%20%20%20%20@relationship.save!%0A%20%20end%0Aend%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">Relationship</span> <span class="k">do</span>

  <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
    <span class="vi">@follower</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
    <span class="vi">@followed</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:user</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="no">Factory</span><span class="o">.</span><span class="n">next</span><span class="p">(</span><span class="ss">:email</span><span class="p">))</span>

    <span class="vi">@relationship</span> <span class="o">=</span> <span class="vi">@follower</span><span class="o">.</span><span class="n">relationships</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="ss">:followed_id</span> <span class="o">=&gt;</span> <span class="vi">@followed</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="n">it</span> <span class="s2">&quot;devrait créer une nouvelle instance en donnant des attributs valides&quot;</span> <span class="k">do</span>
    <span class="vi">@relationship</span><span class="o">.</span><span class="n">save!</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Nous derions également tester le modèle `User`pour l'existence de l'attribut <code>relationships</code>, comme montré dans l'<a class="ref" href="following-users#code:user_relationships_method_test">extrait&nbsp;12.4</a>.</p>

<div class="label" id="code:user_relationships_method_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 12.4.</span> <span class="description">Test de l'attribut <code>user.relationships</code>. <br /> <code>spec/models/user_spec.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_1e06b84d3a2234676e1ed75236a825da0e0b47ab">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=describe%20User%20do%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20describe%20%22relationships%22%20do%0A%20%20%20%20%0A%20%20%20%20before(:each)%20do%0A%20%20%20%20%20%20@user%20=%20User.create!(@attr)%0A%20%20%20%20%20%20@followed%20=%20Factory(:user)%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20it%20%22should%20have%20a%20relationships%20method%22%20do%0A%20%20%20%20%20%20@user.should%20respond_to(:relationships)%0A%20%20%20%20end%0A%20%20end%0Aend%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=describe%20User%20do%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20describe%20%22relationships%22%20do%0A%20%20%20%20%0A%20%20%20%20before(:each)%20do%0A%20%20%20%20%20%20@user%20=%20User.create!(@attr)%0A%20%20%20%20%20%20@followed%20=%20Factory(:user)%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20it%20%22should%20have%20a%20relationships%20method%22%20do%0A%20%20%20%20%20%20@user.should%20respond_to(:relationships)%0A%20%20%20%20end%0A%20%20end%0Aend%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;relationships&quot;</span> <span class="k">do</span>

    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="vi">@attr</span><span class="p">)</span>
      <span class="vi">@followed</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;devrait avoir une méthode relashionships&quot;</span> <span class="k">do</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:relationships</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Arrivés à ce point, [vous pouvez vous attendre à ce que le code de l'application soit comme dans la][you might expect application code as in] <a class="ref" href="user-microposts#sec:user_micropost_associations">section&nbsp;11.1.2</a>, et il est similaire, mais il y a une différence critique&nbsp;: dans le cas du modèle `Micropost` (modèle des micro-messages) nous pouvions dire…</p>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">belongs_to</span> <span class="ss">:user</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div>


<p>… et…</p>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">has_many</span> <span class="ss">:microposts</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div>


<p>… parce que la table <code>microposts</code> (table des micro-messages) possède un attribut <code>user_id</code> pour identifier l'utilisateur (<a class="ref" href="user-microposts#sec:the_basic_model">section&nbsp;11.1.1</a>). Un identifiant utilisé de cette manière pour connecter les tables de la base de données est connu sous le nom de <em>Clé étrangère</em> (<em>foreign key</em>), et puisque la clé étrangère pour le modèle `User` est <code>user_id</code>, Rails peut déduire l'association automatiquement&nbsp;: par défaut, Rails attend une clé étrangère de la forme <code>&lt;class&gt;_id</code>, où <code>&lt;class&gt;</code> est la version minuscule du nom de la classe (NdT&nbsp;: classe <code>User</code> => clé étrangère <code>user</code>).<sup class="footnote" id="fnref:12.5"><a href="#fn:12.5">5</a></sup> Dans le cas présent, bien que nous traitions encore les utilisateurs, ils sont identifiés maintenant avec la clé étrangère <code>follower_id</code> (identifiant du suiveur), donc nous devons le dire explicitement à Rails, comme le montre l'<a class="ref" href="following-users#code:user_relationships_association">extrait&nbsp;12.5</a>.<sup class="footnote" id="fnref:12.6"><a href="#fn:12.6">6</a></sup></p>

<div class="label" id="code:user_relationships_association"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 12.5.</span> <span class="description">Implémentation de l'association <code>has_many</code> de la relation utilisateur/relations. <br /> <code>app/models/user.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_34758c53808111a731b8beca2cda31c8b5e5da13">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=class%20User%20%3C%20ActiveRecord::Base%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20has_many%20:microposts,%20:dependent%20=%3E%20:destroy%0A%20%20has_many%20:relationships,%20:foreign_key%20=%3E%20%22follower_id%22,%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:dependent%20=%3E%20:destroy%0A%20%20.%0A%20%20.%0A%20%20.%0Aend%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=class%20User%20%3C%20ActiveRecord::Base%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20has_many%20:microposts,%20:dependent%20=%3E%20:destroy%0A%20%20has_many%20:relationships,%20:foreign_key%20=%3E%20%22follower_id%22,%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:dependent%20=%3E%20:destroy%0A%20%20.%0A%20%20.%0A%20%20.%0Aend%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">has_many</span> <span class="ss">:microposts</span><span class="p">,</span> <span class="ss">:dependent</span> <span class="o">=&gt;</span> <span class="ss">:destroy</span>
  <span class="n">has_many</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="ss">:foreign_key</span> <span class="o">=&gt;</span> <span class="s2">&quot;follower_id&quot;</span><span class="p">,</span>
                           <span class="ss">:dependent</span> <span class="o">=&gt;</span> <span class="ss">:destroy</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>(Puisque détruire un utilisateur devrait aussi détruire ses relations, nous prenons de l'avance et ajoutons <code>:dependent =&gt; :destroy</code> à l'association&nbsp;; l'écriture d'un test pour ce point en laissé à titre d'exercice (<a class="ref" href="following-users#sec:following_exercises">section&nbsp;12.5</a>).) À ce point, les tests d'association de l'<a class="ref" href="following-users#code:relationship_create_test">extrait&nbsp;12.3</a> et l'<a class="ref" href="following-users#code:user_relationships_method_test">extrait&nbsp;12.4</a> devraient réussir.</p>

<p>Comme pour le modèle `Micropost`, le modèle `Relationship` possède avec les utilisateurs une relation <code>belongs_to</code> (“appartient à…”)&nbsp;; dans ce cas, un objet `relationship` appartient d'une part un utilisateur lecteur (<code>follower</code>, “suiveur”) et un utilisateur auteur (<code>followed</code>, “suivi”), ce que nous testons dans l'<a class="ref" href="following-users#code:relationships_belongs_to_test">extrait&nbsp;12.6</a>.</p>

<div class="label" id="code:relationships_belongs_to_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 12.6.</span> <span class="description">Test de l'asscotion Testing du <code>belongs_to</code> de l'association utilisateur/relation. <br /> <code>spec/models/relationship_spec.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_edc16d6cb9f9482be9ee32f17d136584bf74ed47">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=describe%20Relationship%20do%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20describe%20%22follow%20methods%22%20do%0A%0A%20%20%20%20before(:each)%20do%0A%20%20%20%20%20%20@relationship.save%0A%20%20%20%20end%0A%0A%20%20%20%20it%20%22should%20have%20a%20follower%20attribute%22%20do%0A%20%20%20%20%20%20@relationship.should%20respond_to(:follower)%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20it%20%22should%20have%20the%20right%20follower%22%20do%0A%20%20%20%20%20%20@relationship.follower.should%20==%20@follower%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20it%20%22should%20have%20a%20followed%20attribute%22%20do%0A%20%20%20%20%20%20@relationship.should%20respond_to(:followed)%0A%20%20%20%20end%0A%0A%20%20%20%20it%20%22should%20have%20the%20right%20followed%20user%22%20do%0A%20%20%20%20%20%20@relationship.followed.should%20==%20@followed%0A%20%20%20%20end%0A%20%20end%0Aend%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=describe%20Relationship%20do%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20describe%20%22follow%20methods%22%20do%0A%0A%20%20%20%20before(:each)%20do%0A%20%20%20%20%20%20@relationship.save%0A%20%20%20%20end%0A%0A%20%20%20%20it%20%22should%20have%20a%20follower%20attribute%22%20do%0A%20%20%20%20%20%20@relationship.should%20respond_to(:follower)%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20it%20%22should%20have%20the%20right%20follower%22%20do%0A%20%20%20%20%20%20@relationship.follower.should%20==%20@follower%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20it%20%22should%20have%20a%20followed%20attribute%22%20do%0A%20%20%20%20%20%20@relationship.should%20respond_to(:followed)%0A%20%20%20%20end%0A%0A%20%20%20%20it%20%22should%20have%20the%20right%20followed%20user%22%20do%0A%20%20%20%20%20%20@relationship.followed.should%20==%20@followed%0A%20%20%20%20end%0A%20%20end%0Aend%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="no">Relationship</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;follow methods&quot;</span> <span class="k">do</span>

    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="vi">@relationship</span><span class="o">.</span><span class="n">save</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;devrait avoir un attribut follower (lecteur)&quot;</span> <span class="k">do</span>
      <span class="vi">@relationship</span><span class="o">.</span><span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:follower</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;devrait avoir le bon lecteur&quot;</span> <span class="k">do</span>
      <span class="vi">@relationship</span><span class="o">.</span><span class="n">follower</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="vi">@follower</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;devrait avoir un attribut  followed (suivi)&quot;</span> <span class="k">do</span>
      <span class="vi">@relationship</span><span class="o">.</span><span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:followed</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;devrait avoir le bon utilisateur suivi (auteur)&quot;</span> <span class="k">do</span>
      <span class="vi">@relationship</span><span class="o">.</span><span class="n">followed</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="vi">@followed</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Pour écrire le code de l'application, nous définision la relation <code>belongs_to</code> comme habituellement. Rails déduit les noms des clé étrangères des symboles correspondants (c'est-à-dire l'identifiant <code>follower_id</code> de <code>:follower</code>, et l'identifiant <code>followed_id</code> de <code>:followed</code>), mais puisqu'il n'y a pas plus de modèle `Followed` que de modèle `Follower` nous avons aussi besoin de fournir le nom de classe <code>User</code>. Le résultat est montré dans l'<a class="ref" href="following-users#code:relationship_belongs_to">extrait&nbsp;12.7</a>.</p>

<div class="label" id="code:relationship_belongs_to"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 12.7.</span> <span class="description">Ajout des associations <code>belongs_to</code> au modèle `Relationship`. <br /> <code>app/models/relationship.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_fc74a3504c7c0f48b1d4a752c9e66df1c08be44e">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=class%20Relationship%20%3C%20ActiveRecord::Base%0A%20%20attr_accessible%20:followed_id%0A%20%20%0A%20%20belongs_to%20:follower,%20:class_name%20=%3E%20%22User%22%0A%20%20belongs_to%20:followed,%20:class_name%20=%3E%20%22User%22%0Aend%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=class%20Relationship%20%3C%20ActiveRecord::Base%0A%20%20attr_accessible%20:followed_id%0A%20%20%0A%20%20belongs_to%20:follower,%20:class_name%20=%3E%20%22User%22%0A%20%20belongs_to%20:followed,%20:class_name%20=%3E%20%22User%22%0Aend%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Relationship</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:followed_id</span>

  <span class="n">belongs_to</span> <span class="ss">:follower</span><span class="p">,</span> <span class="ss">:class_name</span> <span class="o">=&gt;</span> <span class="s2">&quot;User&quot;</span>
  <span class="n">belongs_to</span> <span class="ss">:followed</span><span class="p">,</span> <span class="ss">:class_name</span> <span class="o">=&gt;</span> <span class="s2">&quot;User&quot;</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>L'associaiton <code>followed</code> (“suivi”) n'est en fait pas nécessaire jusqu'à la <a class="ref" href="following-users#sec:followers">section&nbsp;12.1.5</a>, même la structure parallèle follower/followed est plus claire si nous implémentons les deux en même temps.</p>

<div class="label" id="sec:relationship_validations"></div>


<h3><a id="sec:12.1.3" href="following-users#sec:relationship_validations" class="heading"><span class="number">12.1.3</span> Validations</a></h3>


<p>Avant de poursuivre, nous allons ajouter quelque validations au modèle 
`Relationship` pour le compléter. Les tests (<a class="ref" href="following-users#code:relationship_validation_tests">Extrait&nbsp;12.8</a>) et le code de l'application (<a class="ref" href="following-users#code:relationship_validations">Extrait&nbsp;12.9</a>) sont évidents.</p>

<div class="label" id="code:relationship_validation_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 12.8.</span> <span class="description">Test des validations du modèle `Relationship`. <br /> <code>spec/models/relationship_spec.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_4da8f59520887362a256f0df7716ed8fd5efb0e8">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=describe%20Relationship%20do%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20describe%20%22validations%22%20do%0A%0A%20%20%20%20it%20%22should%20require%20a%20follower_id%22%20do%0A%20%20%20%20%20%20@relationship.follower_id%20=%20nil%0A%20%20%20%20%20%20@relationship.should_not%20be_valid%0A%20%20%20%20end%0A%0A%20%20%20%20it%20%22should%20require%20a%20followed_id%22%20do%0A%20%20%20%20%20%20@relationship.followed_id%20=%20nil%0A%20%20%20%20%20%20@relationship.should_not%20be_valid%0A%20%20%20%20end%0A%20%20end%0Aend%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=describe%20Relationship%20do%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20describe%20%22validations%22%20do%0A%0A%20%20%20%20it%20%22should%20require%20a%20follower_id%22%20do%0A%20%20%20%20%20%20@relationship.follower_id%20=%20nil%0A%20%20%20%20%20%20@relationship.should_not%20be_valid%0A%20%20%20%20end%0A%0A%20%20%20%20it%20%22should%20require%20a%20followed_id%22%20do%0A%20%20%20%20%20%20@relationship.followed_id%20=%20nil%0A%20%20%20%20%20%20@relationship.should_not%20be_valid%0A%20%20%20%20end%0A%20%20end%0Aend%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="no">Relationship</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;validations&quot;</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">&quot;devrait exiger un attribut follower_id&quot;</span> <span class="k">do</span>
      <span class="vi">@relationship</span><span class="o">.</span><span class="n">follower_id</span> <span class="o">=</span> <span class="kp">nil</span>
      <span class="vi">@relationship</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_valid</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;devrait exiger un attribut followed_id&quot;</span> <span class="k">do</span>
      <span class="vi">@relationship</span><span class="o">.</span><span class="n">followed_id</span> <span class="o">=</span> <span class="kp">nil</span>
      <span class="vi">@relationship</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_valid</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="code:relationship_validations"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 12.9.</span> <span class="description">Ajout des validations du modèle `Relationship`. <br /> <code>app/models/relationship.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_03bec3ce3890b11172dd230aaf99122facc8e8e7">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=class%20Relationship%20%3C%20ActiveRecord::Base%0A%20%20attr_accessible%20:followed_id%0A%20%20%0A%20%20belongs_to%20:follower,%20:class_name%20=%3E%20%22User%22%0A%20%20belongs_to%20:followed,%20:class_name%20=%3E%20%22User%22%0A%20%20%0A%20%20validates%20:follower_id,%20:presence%20=%3E%20true%0A%20%20validates%20:followed_id,%20:presence%20=%3E%20true%0Aend%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=class%20Relationship%20%3C%20ActiveRecord::Base%0A%20%20attr_accessible%20:followed_id%0A%20%20%0A%20%20belongs_to%20:follower,%20:class_name%20=%3E%20%22User%22%0A%20%20belongs_to%20:followed,%20:class_name%20=%3E%20%22User%22%0A%20%20%0A%20%20validates%20:follower_id,%20:presence%20=%3E%20true%0A%20%20validates%20:followed_id,%20:presence%20=%3E%20true%0Aend%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Relationship</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">attr_accessible</span> <span class="ss">:followed_id</span>

  <span class="n">belongs_to</span> <span class="ss">:follower</span><span class="p">,</span> <span class="ss">:class_name</span> <span class="o">=&gt;</span> <span class="s2">&quot;User&quot;</span>
  <span class="n">belongs_to</span> <span class="ss">:followed</span><span class="p">,</span> <span class="ss">:class_name</span> <span class="o">=&gt;</span> <span class="s2">&quot;User&quot;</span>

  <span class="n">validates</span> <span class="ss">:follower_id</span><span class="p">,</span> <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span>
  <span class="n">validates</span> <span class="ss">:followed_id</span><span class="p">,</span> <span class="ss">:presence</span> <span class="o">=&gt;</span> <span class="kp">true</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="sec:following"></div>


<h3><a id="sec:12.1.4" href="following-users#sec:following" class="heading"><span class="number">12.1.4</span> Suivi (“Following”)</a></h3>


<p>Nous en arrivons maintenant au cœur des associations `Relationship`&nbsp;: <code>following</code> (auteurs) et <code>followers</code> (lecteurs). Nous commençons avec <code>following</code>, comme dans l'<a class="ref" href="following-users#code:user_following_test">extrait&nbsp;12.10</a>.</p>

<div class="label" id="code:user_following_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 12.10.</span> <span class="description">Un test pour l'attribut <code>user.following</code>. <br /> <code>spec/models/user_spec.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_803a7ea740888df8bdd2d9ce5f5b9f780ad33826">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=describe%20User%20do%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20describe%20%22relationships%22%20do%0A%20%20%20%20%0A%20%20%20%20before(:each)%20do%0A%20%20%20%20%20%20@user%20=%20User.create!(@attr)%0A%20%20%20%20%20%20@followed%20=%20Factory(:user)%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20it%20%22should%20have%20a%20relationships%20method%22%20do%0A%20%20%20%20%20%20@user.should%20respond_to(:relationships)%0A%20%20%20%20end%0A%0A%20%20%20%20it%20%22should%20have%20a%20following%20method%22%20do%0A%20%20%20%20%20%20@user.should%20respond_to(:following)%0A%20%20%20%20end%0A%20%20end%0Aend%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=describe%20User%20do%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20describe%20%22relationships%22%20do%0A%20%20%20%20%0A%20%20%20%20before(:each)%20do%0A%20%20%20%20%20%20@user%20=%20User.create!(@attr)%0A%20%20%20%20%20%20@followed%20=%20Factory(:user)%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20it%20%22should%20have%20a%20relationships%20method%22%20do%0A%20%20%20%20%20%20@user.should%20respond_to(:relationships)%0A%20%20%20%20end%0A%0A%20%20%20%20it%20%22should%20have%20a%20following%20method%22%20do%0A%20%20%20%20%20%20@user.should%20respond_to(:following)%0A%20%20%20%20end%0A%20%20end%0Aend%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;relationships&quot;</span> <span class="k">do</span>

    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="vi">@attr</span><span class="p">)</span>
      <span class="vi">@followed</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;devrait posséder une méthode `relationships`&quot;</span> <span class="k">do</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:relationships</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;devrait posséder une méthode `following&quot;</span> <span class="k">do</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:following</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>L'implémentation utilise <code>has_many :through</code> (<em>possède_plusieurs :à_travers</em>) pour la première fois&nbsp;: un utilisateur possède plusieurs lecteurs <em>à travers</em> la relation, comme le montre l'<a class="ref" href="following-users#fig:user_has_many_following">illustration&nbsp;12.7</a>. Par défaut, dans une association <code>has_many :through</code> Rails regarde pour une clé étrangère correspondant à la version singulier de l'association&nbsp;; en d'autres termes, un code comme&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="n">has_many</span> <span class="ss">:followeds</span><span class="p">,</span> <span class="ss">:through</span> <span class="o">=&gt;</span> <span class="ss">:relationships</span>
</pre></div>
</div>


<p>… devrait assembler un tableau en utilisant le <code>followed_id</code> dans la table <code>relationships</code>. Mais, comme indiqué à la <a class="ref" href="following-users#sec:a_problem_with_the_data_model">section&nbsp;12.1.1</a>, <code>user.followeds</code> est plutôt maladroit&nbsp;; il est de loin plus naturel de traiter «&nbsp;following&nbsp;» comme la forme plurielle de «&nbsp;followed&nbsp;», et d'écrire plutôt <code>user.following</code> pour la table des utilisateurs suivis. Naturellement, Rails nous permet de sur-écrire la valeur par défaut, dans ce cas en utilisant le paramètre <code>:source</code> (<a class="ref" href="following-users#code:has_many_following_through_relationships">extrait&nbsp;12.11</a>), qui dit explicitement à Rails que la source de la table <code>following</code> est le set des ids de <code>followed</code>.</p>

<div class="label" id="code:has_many_following_through_relationships"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 12.11.</span> <span class="description">Ajout de l'association <code>following</code> du modèle User avec <code>has_many :through</code>. <br /> <code>app/models/user.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_43ca4671bb54e14356e02a6a798c294847f38f35">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=class%20User%20%3C%20ActiveRecord::Base%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20has_many%20:microposts,%20:dependent%20=%3E%20:destroy%0A%20%20has_many%20:relationships,%20:foreign_key%20=%3E%20%22follower_id%22,%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:dependent%20=%3E%20:destroy%0A%20%20has_many%20:following,%20:through%20=%3E%20:relationships,%20:source%20=%3E%20:followed%0A%20%20.%0A%20%20.%0A%20%20.%0Aend%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=class%20User%20%3C%20ActiveRecord::Base%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20has_many%20:microposts,%20:dependent%20=%3E%20:destroy%0A%20%20has_many%20:relationships,%20:foreign_key%20=%3E%20%22follower_id%22,%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:dependent%20=%3E%20:destroy%0A%20%20has_many%20:following,%20:through%20=%3E%20:relationships,%20:source%20=%3E%20:followed%0A%20%20.%0A%20%20.%0A%20%20.%0Aend%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">has_many</span> <span class="ss">:microposts</span><span class="p">,</span> <span class="ss">:dependent</span> <span class="o">=&gt;</span> <span class="ss">:destroy</span>
  <span class="n">has_many</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="ss">:foreign_key</span> <span class="o">=&gt;</span> <span class="s2">&quot;follower_id&quot;</span><span class="p">,</span>
                           <span class="ss">:dependent</span> <span class="o">=&gt;</span> <span class="ss">:destroy</span>
  <span class="n">has_many</span> <span class="ss">:following</span><span class="p">,</span> <span class="ss">:through</span> <span class="o">=&gt;</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="ss">:source</span> <span class="o">=&gt;</span> <span class="ss">:followed</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Pour créer la relation following, nous allons introduire une méthode utilisataire <code>follow!</code> de telle sorte que nous puissions écrire  <code>user.follow!(other_user)</code>.<sup class="footnote" id="fnref:12.7"><a href="#fn:12.7">7</a></sup> Nous allons aussi ajouter une méthode booléen associée <code>following?</code> pour tester si un 	utilisateur en suit un autre.<sup class="footnote" id="fnref:12.8"><a href="#fn:12.8">8</a></sup> Les tests dans l'<a class="ref" href="following-users#code:utility_method_tests">extrait&nbsp;12.12</a> montrent comment nous pouvons nous attendre à ce que ces méthodes soient utilisées dans la pratique.</p>

<div class="label" id="code:utility_method_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 12.12.</span> <span class="description">Tests pour quelques méthode utilitaires &ldquo;following&rdquo;. <br /> <code>spec/models/user_spec.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_319c7d1fcaaab8b8c29e0b7f6e5d7738ddfcbb47">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=describe%20User%20do%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20describe%20%22relationships%22%20do%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20%20%20it%20%22should%20have%20a%20following?%20method%22%20do%0A%20%20%20%20%20%20@user.should%20respond_to(:following?)%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20it%20%22should%20have%20a%20follow!%20method%22%20do%0A%20%20%20%20%20%20@user.should%20respond_to(:follow!)%0A%20%20%20%20end%0A%0A%20%20%20%20it%20%22should%20follow%20another%20user%22%20do%0A%20%20%20%20%20%20@user.follow!(@followed)%0A%20%20%20%20%20%20@user.should%20be_following(@followed)%0A%20%20%20%20end%0A%0A%20%20%20%20it%20%22should%20include%20the%20followed%20user%20in%20the%20following%20array%22%20do%0A%20%20%20%20%20%20@user.follow!(@followed)%0A%20%20%20%20%20%20@user.following.should%20include(@followed)%0A%20%20%20%20end%0A%20%20end%0Aend%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=describe%20User%20do%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20describe%20%22relationships%22%20do%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20%20%20it%20%22should%20have%20a%20following?%20method%22%20do%0A%20%20%20%20%20%20@user.should%20respond_to(:following?)%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20it%20%22should%20have%20a%20follow!%20method%22%20do%0A%20%20%20%20%20%20@user.should%20respond_to(:follow!)%0A%20%20%20%20end%0A%0A%20%20%20%20it%20%22should%20follow%20another%20user%22%20do%0A%20%20%20%20%20%20@user.follow!(@followed)%0A%20%20%20%20%20%20@user.should%20be_following(@followed)%0A%20%20%20%20end%0A%0A%20%20%20%20it%20%22should%20include%20the%20followed%20user%20in%20the%20following%20array%22%20do%0A%20%20%20%20%20%20@user.follow!(@followed)%0A%20%20%20%20%20%20@user.following.should%20include(@followed)%0A%20%20%20%20end%0A%20%20end%0Aend%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;relationships&quot;</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">it</span> <span class="s2">&quot;devrait avoir une méthode following?&quot;</span> <span class="k">do</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:following?</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;devrait avoir une méthode follow!&quot;</span> <span class="k">do</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:follow!</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;devrait suivre une autre utilisateur&quot;</span> <span class="k">do</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="vi">@followed</span><span class="p">)</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">should</span> <span class="n">be_following</span><span class="p">(</span><span class="vi">@followed</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;devrait inclure l'utilisateur suivi dans le tableau following&quot;</span> <span class="k">do</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="vi">@followed</span><span class="p">)</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">following</span><span class="o">.</span><span class="n">should</span> <span class="kp">include</span><span class="p">(</span><span class="vi">@followed</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Notez que nous avons remplacé la méthode <code>include?</code> vu dans l'<a class="ref" href="user-microposts#code:feed_specs">extrait&nbsp;11.31</a> par <code>should include</code>, en transformant effectivement&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="vi">@user</span><span class="o">.</span><span class="n">following</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="vi">@followed</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="n">be_true</span>
</pre></div>
</div>


<p>… en le code plus clair et succinct&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="vi">@user</span><span class="o">.</span><span class="n">following</span><span class="o">.</span><span class="n">should</span> <span class="kp">include</span><span class="p">(</span><span class="vi">@followed</span><span class="p">)</span>
</pre></div>
</div>


<p>Cet exemple montre juste la flexibilité des conventions booléenne de RSpec&nbsp;; même si <code>include</code> est déjà un mot-clé Ruby (utilisé pour inclure un module, comme nous l'avons vu, par exemple, dans l'<a class="ref" href="sign-in-sign-out#code:sessions_helper_include">extrait&nbsp;9.11</a>), RSpec devine dans ce contexte que nous voulons tester une inclusion de tableau.</p>

<p>Dans le code de l'application, la méthode <code>following?</code> prend un utilisateur, appelle <code>followed</code> et vérifie de voir si un <em>follower</em> (un lecteur) avec cet identifiant existe dans la base de données&nbsp;; la méthode <code>follow!</code> appelle <code>create!</code> à travers l'association <code>relationships</code> pour créer la relation de suivi. Le résultat apparait dans l'<a class="ref" href="following-users#code:following_p_follow_bang">extrait&nbsp;12.13</a>.<sup class="footnote" id="fnref:12.9"><a href="#fn:12.9">9</a></sup></p>

<div class="label" id="code:following_p_follow_bang"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 12.13.</span> <span class="description">Les méthode utilitaires <code>following?</code> et <code>follow!</code>. <br /> <code>app/models/user.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_285a23ca308a4ee08722756ed2a6cd6c22cddccc">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=class%20User%20%3C%20ActiveRecord::Base%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20def%20self.authenticate_with_salt(id,%20stored_salt)%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20end%0A%0A%20%20def%20following?(followed)%0A%20%20%20%20relationships.find_by_followed_id(followed)%0A%20%20end%0A%0A%20%20def%20follow!(followed)%0A%20%20%20%20relationships.create!(:followed_id%20=%3E%20followed.id)%0A%20%20end%0A%20%20.%0A%20%20.%0A%20%20.%0Aend%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=class%20User%20%3C%20ActiveRecord::Base%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20def%20self.authenticate_with_salt(id,%20stored_salt)%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20end%0A%0A%20%20def%20following?(followed)%0A%20%20%20%20relationships.find_by_followed_id(followed)%0A%20%20end%0A%0A%20%20def%20follow!(followed)%0A%20%20%20%20relationships.create!(:followed_id%20=%3E%20followed.id)%0A%20%20end%0A%20%20.%0A%20%20.%0A%20%20.%0Aend%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">authenticate_with_salt</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">stored_salt</span><span class="p">)</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">following?</span><span class="p">(</span><span class="n">followed</span><span class="p">)</span>
    <span class="n">relationships</span><span class="o">.</span><span class="n">find_by_followed_id</span><span class="p">(</span><span class="n">followed</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">follow!</span><span class="p">(</span><span class="n">followed</span><span class="p">)</span>
    <span class="n">relationships</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">:followed_id</span> <span class="o">=&gt;</span> <span class="n">followed</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Notez que dans l'<a class="ref" href="following-users#code:following_p_follow_bang">extrait&nbsp;12.13</a> nous avons omis l'utilisateur lui-même, en écrivant juste&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="n">relationships</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="p">)</span>
</pre></div>
</div>


<p>… au lieu du code équivalent&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="nb">self</span><span class="o">.</span><span class="n">relationships</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="p">)</span>
</pre></div>
</div>


<p>Que ce soit pour inclure le <code>self</code> explicite est largement une question de goût.</p>

<p>Bien entendu, les utilisateurs devraient être capable de ne plus suivre les autres utilisateurs autant que de les suivre, ce qui nous conduit à la quelque peu méthode prévisible <code>unfollow!</code>, présentée dans l'<a class="ref" href="following-users#code:user_unfollow_test">extrait&nbsp;12.14</a>.<sup class="footnote" id="fnref:12.10"><a href="#fn:12.10">10</a></sup></p>

<div class="label" id="code:user_unfollow_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 12.14.</span> <span class="description">Un test pour le non-suivi d'un utilisateur. <br /> <code>spec/models/user_spec.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_9cfc4c72018580be6c8ae727877334a33093b377">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=describe%20User%20do%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20describe%20%22relationships%22%20do%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20%20%20it%20%22should%20have%20an%20unfollow!%20method%22%20do%0A%20%20%20%20%20%20@followed.should%20respond_to(:unfollow!)%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20it%20%22should%20unfollow%20a%20user%22%20do%0A%20%20%20%20%20%20@user.follow!(@followed)%0A%20%20%20%20%20%20@user.unfollow!(@followed)%0A%20%20%20%20%20%20@user.should_not%20be_following(@followed)%0A%20%20%20%20end%0A%20%20end%0Aend%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=describe%20User%20do%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20describe%20%22relationships%22%20do%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20%20%20it%20%22should%20have%20an%20unfollow!%20method%22%20do%0A%20%20%20%20%20%20@followed.should%20respond_to(:unfollow!)%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20it%20%22should%20unfollow%20a%20user%22%20do%0A%20%20%20%20%20%20@user.follow!(@followed)%0A%20%20%20%20%20%20@user.unfollow!(@followed)%0A%20%20%20%20%20%20@user.should_not%20be_following(@followed)%0A%20%20%20%20end%0A%20%20end%0Aend%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;relationships&quot;</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">it</span> <span class="s2">&quot;devrait avoir une méthode unfollow!&quot;</span> <span class="k">do</span>
      <span class="vi">@followed</span><span class="o">.</span><span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:unfollow!</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;devrait arrêter de suivre un utilisateur&quot;</span> <span class="k">do</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="vi">@followed</span><span class="p">)</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">unfollow!</span><span class="p">(</span><span class="vi">@followed</span><span class="p">)</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">should_not</span> <span class="n">be_following</span><span class="p">(</span><span class="vi">@followed</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Le code pour <code>unfollow!</code> est très simples&nbsp;: il trouve juste la relation par l'<code>id</code> followed et le détruit (<a class="ref" href="following-users#code:user_unfollow">extrait&nbsp;12.15</a>).<sup class="footnote" id="fnref:12.11"><a href="#fn:12.11">11</a></sup></p>

<div class="label" id="code:user_unfollow"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 12.15.</span> <span class="description">Arrêter le suivi d'un utilisateur en détruisant une relation utilisateur. <br /> <code>app/models/user.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_50ac52f762ffcd4715394fa0b8032912056c1753">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=class%20User%20%3C%20ActiveRecord::Base%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20def%20following?(followed)%0A%20%20%20%20relationships.find_by_followed_id(followed)%0A%20%20end%0A%0A%20%20def%20follow!(followed)%0A%20%20%20%20relationships.create!(:followed_id%20=%3E%20followed.id)%0A%20%20end%0A%20%20%0A%20%20def%20unfollow!(followed)%0A%20%20%20%20relationships.find_by_followed_id(followed).destroy%0A%20%20end%0A%20%20.%0A%20%20.%0A%20%20.%0Aend%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=class%20User%20%3C%20ActiveRecord::Base%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20def%20following?(followed)%0A%20%20%20%20relationships.find_by_followed_id(followed)%0A%20%20end%0A%0A%20%20def%20follow!(followed)%0A%20%20%20%20relationships.create!(:followed_id%20=%3E%20followed.id)%0A%20%20end%0A%20%20%0A%20%20def%20unfollow!(followed)%0A%20%20%20%20relationships.find_by_followed_id(followed).destroy%0A%20%20end%0A%20%20.%0A%20%20.%0A%20%20.%0Aend%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">following?</span><span class="p">(</span><span class="n">followed</span><span class="p">)</span>
    <span class="n">relationships</span><span class="o">.</span><span class="n">find_by_followed_id</span><span class="p">(</span><span class="n">followed</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">follow!</span><span class="p">(</span><span class="n">followed</span><span class="p">)</span>
    <span class="n">relationships</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">:followed_id</span> <span class="o">=&gt;</span> <span class="n">followed</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">unfollow!</span><span class="p">(</span><span class="n">followed</span><span class="p">)</span>
    <span class="n">relationships</span><span class="o">.</span><span class="n">find_by_followed_id</span><span class="p">(</span><span class="n">followed</span><span class="p">)</span><span class="o">.</span><span class="n">destroy</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="sec:followers"></div>


<h3><a id="sec:12.1.5" href="following-users#sec:followers" class="heading"><span class="number">12.1.5</span> Les Lecteurs (<em>Followers</em>)</a></h3>


<p>La dernière pièce du puzzle relationnel est d'ajouter une méthode <code>user.followers</code> marchant avec <code>user.following</code>. Vous avez peut-être noté, d'après l'<a class="ref" href="following-users#fig:user_has_many_following">illustration&nbsp;12.7</a> que toutes les informations nécessaires pour extraire un tableau des lecteurs (<em>followers</em>) est déjà présent dans la table <code>relationships</code>. En effet, la technique est exactement la même comme pour les utilisateur suivis, avec les rôles de <code>follower_id</code> et <code>followed_id</code> simplement inversé. Cela suggère que, si nous pouvions arranger une table <code>reverse_relationships</code> avec ces colonnes inversées (<a class="ref" href="following-users#fig:user_has_many_followers">illustration&nbsp;12.9</a>), nous pourrions implémenter <code>user.followers</code> avec peu d'effort.</p>

<div class="label" id="fig:user_has_many_followers"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_has_many_followers.png" alt="user_has_many_followers" /></span></div><div class="caption"><span class="header">Illustration 12.9: </span><span class="description">Un modèle pour les utilisateurs lecteurs en utilisant un modèle Relationship inversé.&nbsp;<a href="http://railstutorial.org/images/figures/user_has_many_followers-full.png">(taille normale)</a></span></div></div>


<p>Nous commençons avec les tests, en ayant la foi que la magie de Rails viendra à notre aide (<a class="ref" href="following-users#code:reverse_relationships_test">extrait&nbsp;12.16</a>).</p>

<div class="label" id="code:reverse_relationships_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 12.16.</span> <span class="description">Tester pour la relation inversée. <br /> <code>spec/models/user_spec.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_7c14c493a65f79e113d9d61901739c776daf5cb0">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=describe%20User%20do%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20describe%20%22relationships%22%20do%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20%20%20.%20%20%20%20%0A%20%20%20%20it%20%22should%20have%20a%20reverse_relationships%20method%22%20do%0A%20%20%20%20%20%20@user.should%20respond_to(:reverse_relationships)%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20it%20%22should%20have%20a%20followers%20method%22%20do%0A%20%20%20%20%20%20@user.should%20respond_to(:followers)%0A%20%20%20%20end%0A%0A%20%20%20%20it%20%22should%20include%20the%20follower%20in%20the%20followers%20array%22%20do%0A%20%20%20%20%20%20@user.follow!(@followed)%0A%20%20%20%20%20%20@followed.followers.should%20include(@user)%0A%20%20%20%20end%0A%20%20end%0Aend%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=describe%20User%20do%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20describe%20%22relationships%22%20do%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20%20%20.%20%20%20%20%0A%20%20%20%20it%20%22should%20have%20a%20reverse_relationships%20method%22%20do%0A%20%20%20%20%20%20@user.should%20respond_to(:reverse_relationships)%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20it%20%22should%20have%20a%20followers%20method%22%20do%0A%20%20%20%20%20%20@user.should%20respond_to(:followers)%0A%20%20%20%20end%0A%0A%20%20%20%20it%20%22should%20include%20the%20follower%20in%20the%20followers%20array%22%20do%0A%20%20%20%20%20%20@user.follow!(@followed)%0A%20%20%20%20%20%20@followed.followers.should%20include(@user)%0A%20%20%20%20end%0A%20%20end%0Aend%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;relationships&quot;</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>    
    <span class="n">it</span> <span class="s2">&quot;devrait avoir un méthode reverse_relationship&quot;</span> <span class="k">do</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:reverse_relationships</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;devrait avoir une méthode followers&quot;</span> <span class="k">do</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:followers</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;devrait inclure le lecteur dans le tableau des lecteurs&quot;</span> <span class="k">do</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="vi">@followed</span><span class="p">)</span>
      <span class="vi">@followed</span><span class="o">.</span><span class="n">followers</span><span class="o">.</span><span class="n">should</span> <span class="kp">include</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Comme vous le suspectez certainement, nous ne ferons pas une table complète de base de données juste pour conserver la relation inversée. Plutôt, nous exploiterons la symétrie sous-jaccente entre lecteurs et auteurs pour simuler une table <code>reverse_relationships</code> en passant <code>followed_id</code> (<em>auteur_id</em>) comme clé primaire. En d'autres termes, là où l'association <code>relationship</code> utilise la clé étrangère <code>follower_id</code> (<em>lecteur_id</em>)&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="n">has_many</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="ss">:foreign_key</span> <span class="o">=&gt;</span> <span class="s2">&quot;follower_id&quot;</span>
</pre></div>
</div>


<p>… l'association <code>reverse_relationships</code> utilise <code>followed_id</code> (<em>auteur_id</em>)&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="n">has_many</span> <span class="ss">:reverse_relationships</span><span class="p">,</span> <span class="ss">:foreign_key</span> <span class="o">=&gt;</span> <span class="s2">&quot;followed_id&quot;</span>
</pre></div>
</div>


<p>L'association <code>followers</code> (<em>lecteurs</em>) se contruit alors à travers la relationship inversée, comme le montre l'<a class="ref" href="following-users#code:user_reverse_relationships">extrait&nbsp;12.17</a>.</p>

<div class="label" id="code:user_reverse_relationships"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 12.17.</span> <span class="description">Implémenter <code>user.followers</code> en utilisant la relation inversée. <br /> <code>app/models/user.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_132806d32e044ce44aa1289d43b9cb3b503dcf6f">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=class%20User%20%3C%20ActiveRecord::Base%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20has_many%20:reverse_relationships,%20:foreign_key%20=%3E%20%22followed_id%22,%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:class_name%20=%3E%20%22Relationship%22,%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:dependent%20=%3E%20:destroy%0A%20%20has_many%20:followers,%20:through%20=%3E%20:reverse_relationships,%20:source%20=%3E%20:follower%0A%20%20.%0A%20%20.%0A%20%20.%0Aend%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=class%20User%20%3C%20ActiveRecord::Base%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20has_many%20:reverse_relationships,%20:foreign_key%20=%3E%20%22followed_id%22,%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:class_name%20=%3E%20%22Relationship%22,%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:dependent%20=%3E%20:destroy%0A%20%20has_many%20:followers,%20:through%20=%3E%20:reverse_relationships,%20:source%20=%3E%20:follower%0A%20%20.%0A%20%20.%0A%20%20.%0Aend%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">has_many</span> <span class="ss">:reverse_relationships</span><span class="p">,</span> <span class="ss">:foreign_key</span> <span class="o">=&gt;</span> <span class="s2">&quot;followed_id&quot;</span><span class="p">,</span>
                                   <span class="ss">:class_name</span> <span class="o">=&gt;</span> <span class="s2">&quot;Relationship&quot;</span><span class="p">,</span>
                                   <span class="ss">:dependent</span> <span class="o">=&gt;</span> <span class="ss">:destroy</span>
  <span class="n">has_many</span> <span class="ss">:followers</span><span class="p">,</span> <span class="ss">:through</span> <span class="o">=&gt;</span> <span class="ss">:reverse_relationships</span><span class="p">,</span> <span class="ss">:source</span> <span class="o">=&gt;</span> <span class="ss">:follower</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>(Comme dans l'<a class="ref" href="following-users#code:user_relationships_association">extrait&nbsp;12.5</a>, le test de <code>dependent :destroy</code> est laissé en exercice (<a class="ref" href="following-users#sec:following_exercises">section&nbsp;12.5</a>).) Notez que nous avons en fait à inclure le nom de <em>classe</em> pour cette association, c'est-à-dire&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="n">has_many</span> <span class="ss">:reverse_relationships</span><span class="p">,</span> <span class="ss">:foreign_key</span> <span class="o">=&gt;</span> <span class="s2">&quot;followed_id&quot;</span><span class="p">,</span>
                                 <span class="ss">:class_name</span> <span class="o">=&gt;</span> <span class="s2">&quot;Relationship&quot;</span>
</pre></div>
</div>


<p>… sinon, Rails cherchera une classe <code>ReverseRelationship</code>, qui n'existe pas.</p>

<p>Il est important de noter aussi que nous pourrions en fait omettre la clé <code>:source</code> dans ce cas, en utilisant simplement&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="n">has_many</span> <span class="ss">:followers</span><span class="p">,</span> <span class="ss">:through</span> <span class="o">=&gt;</span> <span class="ss">:reverse_relationships</span>
</pre></div>
</div>


<p>… puisque Rails cherchera automatiquement une clé étrangère  <code>follower_id</code> dans ce cas. J'ai gardé la clé <code>:source</code> pour mettre l'accent sur le parallèle de structure avec l'association <code>has_many :following</code>, mais vous êtes libre de ne pas l'utiliser.</p>

<p>Avec le code de l'<a class="ref" href="following-users#code:user_reverse_relationships">extrait&nbsp;12.17</a>, les associations lecteurs/auteur sont achevées, et tous les tests devraient réussir. Cette section a fait appel de façon intensive à vos compétence en matière de modélisation de données, [(and it&rsquo;s fine if it takes a while to soak in)(et c'est bien si ça prend un moment pour vous y tremper)]. En fait, l'une des meilleures façon de comprendre les associations est de les utiliser dans l'interface web, comme nous le verrons dans la prochaine section.</p>

<div class="label" id="sec:a_web_interface_for_following_and_followers"></div>


<h2><a id="sec:12.2" href="following-users#sec:a_web_interface_for_following_and_followers" class="heading"><span class="number">12.2</span> Une interface web pour les auteurs et les lecteurs</a></h2>


<p>Dans l'introduction de ce chapitre, nous avons vu un aperçu du flux de page pour les utilisateurs-lecteurs. Dans cette section, nous implémenterons l'interface de base et les fonctionnalités de suivi/arrêt de suivi montrées dans ces maquettes. Nous ferons aussi des pages séparées pour montrer les lecteurs de l'auteur et les tableaux d'auteurs suivis. À la <a class="ref" href="following-users#sec:the_status_feed">section&nbsp;12.3</a>, nous achèverons notre <em>Application Exemple</em> en ajoutant l'état d'alimentation de l'utilisateur.</p>

<div class="label" id="sec:sample_following_data"></div>


<h3><a id="sec:12.2.1" href="following-users#sec:sample_following_data" class="heading"><span class="number">12.2.1</span> Données de simple lecteur</a></h3>


<p>Comme dans les chapitres précédents, nous trouvons pratique d'utiliser la tâche Rake d'exemple de données pour remplir la base de données avec des échantillons de relations. Cela nous permettra de concevoir l'aspect et la convivialité des pages web d'abord, différant les fonctionnalités de back-end pour plus tard dans cette section.</p>

<p>Quand nous avons abandonné le peupleur d'échantillons de données de l'<a class="ref" href="user-microposts#code:sample_microposts">extrait&nbsp;11.20</a>, il était devenu plutôt encombré, donc nous allons commencer par définir des méthodes séparées pour créer des utilisateurs et des micro-messages, et ajouter alors des échantillons de données relationship en utilisant une nouvelle méthode <code>make_relationships</code>. Le résultat est montré dans l'<a class="ref" href="following-users#code:sample_relationships">extrait&nbsp;12.18</a>.</p>

<div class="label" id="code:sample_relationships"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 12.18.</span> <span class="description">Ajout des relations auteurs/lecteur pour les échantillons de données. <br /> <code>lib/tasks/sample_data.rake</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_819faa856237c44090fb85afa11bfc1fc8fc0ed4">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=require%20'faker'%0A%0Anamespace%20:db%20do%0A%20%20desc%20%22Fill%20database%20with%20sample%20data%22%0A%20%20task%20:populate%20=%3E%20:environment%20do%0A%20%20%20%20Rake::Task['db:reset'].invoke%0A%20%20%20%20make_users%0A%20%20%20%20make_microposts%0A%20%20%20%20make_relationships%0A%20%20end%0Aend%0A%0Adef%20make_users%0A%20%20admin%20=%20User.create!(:name%20=%3E%20%22Example%20User%22,%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:email%20=%3E%20%22example@railstutorial.org%22,%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:password%20=%3E%20%22foobar%22,%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:password_confirmation%20=%3E%20%22foobar%22)%0A%20%20admin.toggle!(:admin)%0A%20%2099.times%20do%20%7Cn%7C%0A%20%20%20%20name%20%20=%20Faker::Name.name%0A%20%20%20%20email%20=%20%22example%2D%23%7Bn%2B1%7D@railstutorial.org%22%0A%20%20%20%20password%20%20=%20%22password%22%0A%20%20%20%20User.create!(:name%20=%3E%20name,%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:email%20=%3E%20email,%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:password%20=%3E%20password,%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:password_confirmation%20=%3E%20password)%0A%20%20end%0Aend%0A%0Adef%20make_microposts%0A%20%20User.all(:limit%20=%3E%206).each%20do%20%7Cuser%7C%0A%20%20%20%2050.times%20do%0A%20%20%20%20%20%20content%20=%20Faker::Lorem.sentence(5)%0A%20%20%20%20%20%20user.microposts.create!(:content%20=%3E%20content)%0A%20%20%20%20end%0A%20%20end%0Aend%0A%0Adef%20make_relationships%0A%20%20users%20=%20User.all%0A%20%20user%20%20=%20users.first%0A%20%20following%20=%20users[1..50]%0A%20%20followers%20=%20users[3..40]%0A%20%20following.each%20%7B%20%7Cfollowed%7C%20user.follow!(followed)%20%7D%0A%20%20followers.each%20%7B%20%7Cfollower%7C%20follower.follow!(user)%20%7D%0Aend%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=require%20'faker'%0A%0Anamespace%20:db%20do%0A%20%20desc%20%22Fill%20database%20with%20sample%20data%22%0A%20%20task%20:populate%20=%3E%20:environment%20do%0A%20%20%20%20Rake::Task['db:reset'].invoke%0A%20%20%20%20make_users%0A%20%20%20%20make_microposts%0A%20%20%20%20make_relationships%0A%20%20end%0Aend%0A%0Adef%20make_users%0A%20%20admin%20=%20User.create!(:name%20=%3E%20%22Example%20User%22,%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:email%20=%3E%20%22example@railstutorial.org%22,%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:password%20=%3E%20%22foobar%22,%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:password_confirmation%20=%3E%20%22foobar%22)%0A%20%20admin.toggle!(:admin)%0A%20%2099.times%20do%20%7Cn%7C%0A%20%20%20%20name%20%20=%20Faker::Name.name%0A%20%20%20%20email%20=%20%22example%2D%23%7Bn%2B1%7D@railstutorial.org%22%0A%20%20%20%20password%20%20=%20%22password%22%0A%20%20%20%20User.create!(:name%20=%3E%20name,%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:email%20=%3E%20email,%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:password%20=%3E%20password,%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:password_confirmation%20=%3E%20password)%0A%20%20end%0Aend%0A%0Adef%20make_microposts%0A%20%20User.all(:limit%20=%3E%206).each%20do%20%7Cuser%7C%0A%20%20%20%2050.times%20do%0A%20%20%20%20%20%20content%20=%20Faker::Lorem.sentence(5)%0A%20%20%20%20%20%20user.microposts.create!(:content%20=%3E%20content)%0A%20%20%20%20end%0A%20%20end%0Aend%0A%0Adef%20make_relationships%0A%20%20users%20=%20User.all%0A%20%20user%20%20=%20users.first%0A%20%20following%20=%20users[1..50]%0A%20%20followers%20=%20users[3..40]%0A%20%20following.each%20%7B%20%7Cfollowed%7C%20user.follow!(followed)%20%7D%0A%20%20followers.each%20%7B%20%7Cfollower%7C%20follower.follow!(user)%20%7D%0Aend%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;faker&#39;</span>

<span class="n">namespace</span> <span class="ss">:db</span> <span class="k">do</span>
  <span class="n">desc</span> <span class="s2">&quot;Fill database with sample data&quot;</span>
  <span class="n">task</span> <span class="ss">:populate</span> <span class="o">=&gt;</span> <span class="ss">:environment</span> <span class="k">do</span>
    <span class="no">Rake</span><span class="o">::</span><span class="no">Task</span><span class="o">[</span><span class="s1">&#39;db:reset&#39;</span><span class="o">].</span><span class="n">invoke</span>
    <span class="n">make_users</span>
    <span class="n">make_microposts</span>
    <span class="n">make_relationships</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">make_users</span>
  <span class="n">admin</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="s2">&quot;Example User&quot;</span><span class="p">,</span>
                       <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="s2">&quot;example@railstutorial.org&quot;</span><span class="p">,</span>
                       <span class="ss">:password</span> <span class="o">=&gt;</span> <span class="s2">&quot;foobar&quot;</span><span class="p">,</span>
                       <span class="ss">:password_confirmation</span> <span class="o">=&gt;</span> <span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
  <span class="n">admin</span><span class="o">.</span><span class="n">toggle!</span><span class="p">(</span><span class="ss">:admin</span><span class="p">)</span>
  <span class="mi">99</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span>
    <span class="nb">name</span>  <span class="o">=</span> <span class="no">Faker</span><span class="o">::</span><span class="no">Name</span><span class="o">.</span><span class="n">name</span>
    <span class="n">email</span> <span class="o">=</span> <span class="s2">&quot;example-</span><span class="si">#{</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">@railstutorial.org&quot;</span>
    <span class="n">password</span>  <span class="o">=</span> <span class="s2">&quot;password&quot;</span>
    <span class="no">User</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">:name</span> <span class="o">=&gt;</span> <span class="nb">name</span><span class="p">,</span>
                 <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="n">email</span><span class="p">,</span>
                 <span class="ss">:password</span> <span class="o">=&gt;</span> <span class="n">password</span><span class="p">,</span>
                 <span class="ss">:password_confirmation</span> <span class="o">=&gt;</span> <span class="n">password</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">make_microposts</span>
  <span class="no">User</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="ss">:limit</span> <span class="o">=&gt;</span> <span class="mi">6</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span>
    <span class="mi">50</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span>
      <span class="n">content</span> <span class="o">=</span> <span class="no">Faker</span><span class="o">::</span><span class="no">Lorem</span><span class="o">.</span><span class="n">sentence</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
      <span class="n">user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">:content</span> <span class="o">=&gt;</span> <span class="n">content</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">def</span> <span class="nf">make_relationships</span>
  <span class="n">users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">all</span>
  <span class="n">user</span>  <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">first</span>
  <span class="n">following</span> <span class="o">=</span> <span class="n">users</span><span class="o">[</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="mi">50</span><span class="o">]</span>
  <span class="n">followers</span> <span class="o">=</span> <span class="n">users</span><span class="o">[</span><span class="mi">3</span><span class="o">.</span><span class="n">.</span><span class="mi">40</span><span class="o">]</span>
  <span class="n">following</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">followed</span><span class="o">|</span> <span class="n">user</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="n">followed</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">followers</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">follower</span><span class="o">|</span> <span class="n">follower</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Ici, les échantillons de relation sont créées en utilisant le code&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">make_relationships</span>
  <span class="n">users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">all</span>
  <span class="n">user</span>  <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">first</span>
  <span class="n">following</span> <span class="o">=</span> <span class="n">users</span><span class="o">[</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="mi">50</span><span class="o">]</span>
  <span class="n">followers</span> <span class="o">=</span> <span class="n">users</span><span class="o">[</span><span class="mi">3</span><span class="o">.</span><span class="n">.</span><span class="mi">40</span><span class="o">]</span>
  <span class="n">following</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">followed</span><span class="o">|</span> <span class="n">user</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="n">followed</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">followers</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">follower</span><span class="o">|</span> <span class="n">follower</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>
<span class="k">end</span>
</pre></div>
</div>


<p>Nous nous arrangeons un peu arbitrairement pour que le premier utilisateur suive les 50 utilisateurs suivants, et puis avoir que les utilisateurs entre les <code>ids</code> 4 à 41 suivent cet utilisateur en retour. La relation en résultant sera suffisante pour développer l'interface de l'application.</p>

<p>Pour exécuter le code de l'<a class="ref" href="following-users#code:sample_relationships">extrait&nbsp;12.18</a>, peuplons la base de données comme d'habitude&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> rake db:populate
</pre></div>
</div>




<div class="label" id="sec:stats_and_a_follow_form"></div>


<h3><a id="sec:12.2.2" href="following-users#sec:stats_and_a_follow_form" class="heading"><span class="number">12.2.2</span> Statistiques et un formulaire de suivi</a></h3>


<p>Maintenant que nos échantillons d'utilisateurs ont des tableaux de lecteurs et suivent des auteurs, nous avons besoin d'actualiser les pages de profil et d'accueil pour le refléter. Nous allons commencer par faire un partiel pour afficher les statistiques sur les pages de profil et d'accueil, comme le montre la maquette de l'<a class="ref" href="following-users#fig:page_flow_profile_mockup">illustration&nbsp;12.1</a> et de l'<a class="ref" href="following-users#fig:page_flow_home_page_feed_mockup">illustration&nbsp;12.5</a>.Le résultat affichera le nombre d'auteurs suivis et de lecteurs, mis avec des liens vers leurs pages respectives. Nous ajouterons ensuite le formulaire suivre/arrêter de suivre, et fabriquerons ensuite les pages dédiées pour afficher les utilisateurs suivis et les utilisateurs qui suivent l'utilisateur courant.</p>

<div class="label" id="fig:stats_partial_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/stats_partial_mockup.png" alt="stats_partial_mockup" /></span></div><div class="caption"><span class="header">Illustration 12.10: </span><span class="description">Maquette du partiel pour les statistiques.</span></div></div>


<p>Un gros plan de la zone des statistiques, prise de la maquette de l'<a class="ref" href="following-users#fig:page_flow_profile_mockup">illustration&nbsp;12.1</a>, est montré dans l'<a class="ref" href="following-users#fig:stats_partial_mockup">illustration&nbsp;12.10</a>. Ces statistiques consistent en un compte des utilisateurs que l'utilisateur courant suit et du nombre d'utilisateurs qui le suivent, chacun d'eux devant être un lien vers sa page d'affichage respective. Au <a class="ref" href="filling-in-the-layout#top">chapitre&nbsp;5</a>, nous avons esquissé de tels liens avec un texte fictif&nbsp;<code>&rsquo;#&rsquo;</code>, mais c'était avant que nous ayons plus d'expérience des routes. Cette fois, bien que nous différerons les pages réelles à la <a class="ref" href="following-users#sec:following_and_followers_pages">section&nbsp;12.2.3</a>, nous allons faire les routes maintenant, comme montré dans l'<a class="ref" href="following-users#code:following_followers_actions_routes">extrait&nbsp;12.19</a>. Ce code utilise la méthode <code>:member</code> à l'intérieur d'un <em>bloc</em> <code>resource</code>, que nous n'avons jamais vu avant, mais voyons si vous pouvez deviner ce qu'il fait.</p>

<div class="label" id="code:following_followers_actions_routes"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 12.19.</span> <span class="description">Ajout des actions <code>following</code> et <code>followers</code> au contrôleur Users. <br /> <code>config/routes.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_62203487439e8b98201bbc676fd51750b13e44c7">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=SampleApp::Application.routes.draw%20do%0A%20%20resources%20:users%20do%0A%20%20%20%20member%20do%0A%20%20%20%20%20%20get%20:following,%20:followers%0A%20%20%20%20end%0A%20%20end%0A%20%20.%0A%20%20.%0A%20%20.%0Aend%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=SampleApp::Application.routes.draw%20do%0A%20%20resources%20:users%20do%0A%20%20%20%20member%20do%0A%20%20%20%20%20%20get%20:following,%20:followers%0A%20%20%20%20end%0A%20%20end%0A%20%20.%0A%20%20.%0A%20%20.%0Aend%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="no">SampleApp</span><span class="o">::</span><span class="no">Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">resources</span> <span class="ss">:users</span> <span class="k">do</span>
    <span class="n">member</span> <span class="k">do</span>
      <span class="n">get</span> <span class="ss">:following</span><span class="p">,</span> <span class="ss">:followers</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Vous pouvez imaginer que les URLs pour l'utilisateur suivant (<em>following</em>) et suiveur (<em>followers</em>) ressembleront à <tt>/users/1/following</tt> et <tt>/users/1/followers</tt> et c'est exactement ce que fait le code dans l'<a class="ref" href="following-users#code:following_followers_actions_routes">extrait&nbsp;12.19</a>. Puisque les deux pages affichera des données, nous utilisons <code>get</code> pour faire en sorte que les URLs répondent à la requête <tt>GET</tt> (comme requis par la convention REST pour de telles pages), et la méthode <code>member</code> signifie que les routes répondent aux URLs contenant l'<code>id</code> de l'utilisateur (l'autre possibilité, <code>collection</code>, fonctionne sans <code>id</code>, de telle sorte que&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="n">resources</span> <span class="ss">:users</span> <span class="k">do</span>
  <span class="n">collection</span> <span class="k">do</span>
    <span class="n">get</span> <span class="ss">:tigers</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>


<p>… devra répondre à l'URL <tt>/users/tigers</tt> &mdash;vraisemblablement pour afficher tous les tigres dans notre application. Pour plus de détails sur de telles options de routage, voyez l'<a href="http://guides.rubyonrails.org/routing.html">article du Rails Guides à propos de &ldquo;Rails Routing from the Outside In&rdquo;</a>). Une table des routes généré par l'<a class="ref" href="following-users#code:following_followers_actions_routes">extrait&nbsp;12.19</a> est présentée dans la <a class="ref" href="following-users#table:following_routes">table&nbsp;12.1</a>&nbsp;; notez les routes nommées pour les pages lecteurs (<em>following</em>) et auteurs (<em>followers</em>) que nous serons amenés à utiliser dans un instant.</p>

<div class="label" id="table:following_routes"></div>


<div class="table"><div class="center"><table class="tabular"><tr><th class="align_left"><strong>Requête HTTP</strong></th><th class="align_left"><strong>URL</strong></th><th class="align_left"><strong>Action</strong></th><th class="align_left"><strong>Route nommé</strong></th></tr><tr class="top_bar"><td class="align_left"><tt>GET</tt></td><td class="align_left"><tt>/users/1/following</tt></td><td class="align_left"><code>following</code></td><td class="align_left"><code>following_user_path(1)</code></td></tr><tr><td class="align_left"><tt>GET</tt></td><td class="align_left"><tt>/users/1/followers</tt></td><td class="align_left"><code>followers</code></td><td class="align_left"><code>followers_user_path(1)</code></td></tr></table></div><div class="caption"><span class="header">Table 12.1: </span><span class="description">Routes RESTful fournies par les règles personnalisées dans la ressource de l'<a class="ref" href="following-users#code:following_followers_actions_routes">extrait&nbsp;12.19</a>.</span></div></div>


<p>Les routes une fois définies, nous sommes maintenant en mesure de construire les tests pour le partiel statistiques (nous aurions pu écrire les tests d'abord, mais les routes nommées auraient été difficiles à motiver sans le fichier routes actualisé). Nous pourrions écrire les tests pour la page de profil de l'utilisateur, puisque le partiel des statistiques apparaitra là, mais il apparaitra aussi sur la page d'accueil, et c'est une bonne opportunité pour restructurer les tests de la page d'accueil pour prendre en compte les utilisateur identifiés. Le résultat apparait dans l'<a class="ref" href="following-users#code:stats_view_test">extrait&nbsp;12.20</a>.</p>

<div class="label" id="code:stats_view_test"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 12.20.</span> <span class="description">Testes les statistiques auteurs/lecteurs sur la page d'accueil. <br /> <code>spec/controllers/pages_controller_spec.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_2863142d450d001da4a6c3af840f777a2a0bd98c">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=describe%20PagesController%20do%0A%20%20render_views%0A%0A%20%20before(:each)%20do%0A%20%20%20%20@base_title%20=%20%22Ruby%20on%20Rails%20Tutorial%20Sample%20App%22%0A%20%20end%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20describe%20%22GET%20'home'%22%20do%0A%20%20%20%20%0A%20%20%20%20describe%20%22when%20not%20signed%20in%22%20do%0A%0A%20%20%20%20%20%20before(:each)%20do%0A%20%20%20%20%20%20%20%20get%20:home%0A%20%20%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20%20%20it%20%22should%20be%20successful%22%20do%0A%20%20%20%20%20%20%20%20response.should%20be_success%0A%20%20%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20%20%20it%20%22should%20have%20the%20right%20title%22%20do%0A%20%20%20%20%20%20%20%20response.should%20have_selector(%22title%22,%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:content%20=%3E%20%22%23%7B@base_title%7D%20%7C%20Home%22)%0A%20%20%20%20%20%20end%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20describe%20%22when%20signed%20in%22%20do%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20before(:each)%20do%0A%20%20%20%20%20%20%20%20@user%20=%20test_sign_in(Factory(:user))%0A%20%20%20%20%20%20%20%20other_user%20=%20Factory(:user,%20:email%20=%3E%20Factory.next(:email))%0A%20%20%20%20%20%20%20%20other_user.follow!(@user)%0A%20%20%20%20%20%20end%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20it%20%22should%20have%20the%20right%20follower/following%20counts%22%20do%0A%20%20%20%20%20%20%20%20get%20:home%0A%20%20%20%20%20%20%20%20response.should%20have_selector(%22a%22,%20:href%20=%3E%20following_user_path(@user),%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:content%20=%3E%20%220%20following%22)%0A%20%20%20%20%20%20%20%20response.should%20have_selector(%22a%22,%20:href%20=%3E%20followers_user_path(@user),%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:content%20=%3E%20%221%20follower%22)%0A%20%20%20%20%20%20end%0A%20%20%20%20end%0A%20%20end%0Aend%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=describe%20PagesController%20do%0A%20%20render_views%0A%0A%20%20before(:each)%20do%0A%20%20%20%20@base_title%20=%20%22Ruby%20on%20Rails%20Tutorial%20Sample%20App%22%0A%20%20end%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20describe%20%22GET%20'home'%22%20do%0A%20%20%20%20%0A%20%20%20%20describe%20%22when%20not%20signed%20in%22%20do%0A%0A%20%20%20%20%20%20before(:each)%20do%0A%20%20%20%20%20%20%20%20get%20:home%0A%20%20%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20%20%20it%20%22should%20be%20successful%22%20do%0A%20%20%20%20%20%20%20%20response.should%20be_success%0A%20%20%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20%20%20it%20%22should%20have%20the%20right%20title%22%20do%0A%20%20%20%20%20%20%20%20response.should%20have_selector(%22title%22,%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:content%20=%3E%20%22%23%7B@base_title%7D%20%7C%20Home%22)%0A%20%20%20%20%20%20end%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20describe%20%22when%20signed%20in%22%20do%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20before(:each)%20do%0A%20%20%20%20%20%20%20%20@user%20=%20test_sign_in(Factory(:user))%0A%20%20%20%20%20%20%20%20other_user%20=%20Factory(:user,%20:email%20=%3E%20Factory.next(:email))%0A%20%20%20%20%20%20%20%20other_user.follow!(@user)%0A%20%20%20%20%20%20end%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20it%20%22should%20have%20the%20right%20follower/following%20counts%22%20do%0A%20%20%20%20%20%20%20%20get%20:home%0A%20%20%20%20%20%20%20%20response.should%20have_selector(%22a%22,%20:href%20=%3E%20following_user_path(@user),%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:content%20=%3E%20%220%20following%22)%0A%20%20%20%20%20%20%20%20response.should%20have_selector(%22a%22,%20:href%20=%3E%20followers_user_path(@user),%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:content%20=%3E%20%221%20follower%22)%0A%20%20%20%20%20%20end%0A%20%20%20%20end%0A%20%20end%0Aend%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="no">PagesController</span> <span class="k">do</span>
  <span class="n">render_views</span>

  <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
    <span class="vi">@base_title</span> <span class="o">=</span> <span class="s2">&quot;Ruby on Rails Tutorial Sample App&quot;</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;GET &#39;home&#39;&quot;</span> <span class="k">do</span>

    <span class="n">describe</span> <span class="s2">&quot;quand pas identifié&quot;</span> <span class="k">do</span>

      <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
        <span class="n">get</span> <span class="ss">:home</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;devrait réussir&quot;</span> <span class="k">do</span>
        <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">be_success</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;devrait avoir le bon titre&quot;</span> <span class="k">do</span>
        <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span>
                                      <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@base_title</span><span class="si">}</span><span class="s2"> | Home&quot;</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">&quot;quand identifié&quot;</span> <span class="k">do</span>

      <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
        <span class="vi">@user</span> <span class="o">=</span> <span class="n">test_sign_in</span><span class="p">(</span><span class="no">Factory</span><span class="p">(</span><span class="ss">:user</span><span class="p">))</span>
        <span class="n">other_user</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:user</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="no">Factory</span><span class="o">.</span><span class="n">next</span><span class="p">(</span><span class="ss">:email</span><span class="p">))</span>
        <span class="n">other_user</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;devrait avoir le bon compte d'auteurs et de lecteurs&quot;</span> <span class="k">do</span>
        <span class="n">get</span> <span class="ss">:home</span>
        <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="ss">:href</span> <span class="o">=&gt;</span> <span class="n">following_user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">),</span>
                                           <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="s2">&quot;0 following&quot;</span><span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="ss">:href</span> <span class="o">=&gt;</span> <span class="n">followers_user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">),</span>
                                           <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="s2">&quot;1 follower&quot;</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Le cœur de ce test est l'attente que le compte de lecteurs et d'auteurs suivi apparaisse sur la page, accompagnés des bonnes URLs&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="ss">:href</span> <span class="o">=&gt;</span> <span class="n">following_user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">),</span>
                                   <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="s2">&quot;0 following&quot;</span><span class="p">)</span>
<span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="ss">:href</span> <span class="o">=&gt;</span> <span class="n">followers_user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">),</span>
                                   <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="s2">&quot;1 follower&quot;</span><span class="p">)</span>
</pre></div>
</div>


<p>Nous avons utilisé ici la route nommée de la <a class="ref" href="following-users#table:following_routes">table&nbsp;12.1</a> pour vérifier que les liens avaient les bons URLs.</p>

<p>Le code de l'application pour le partiel des statistiques est just une <code>table</code> à l'intérieur d'un <code>div</code> comme le montre l'<a class="ref" href="following-users#code:stats_partial">extrait&nbsp;12.21</a>.</p>

<div class="label" id="code:stats_partial"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 12.21.</span> <span class="description">Un partile pour afficher les statistiques lecteur. <br /> <code>app/views/shared/_stats.html.erb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_a7dbd5097cb60ae7e786df8047bd5133445b432a">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=%3C%25%20@user%20%7C%7C=%20current_user%20%25%3E%0A%3Cdiv%20class=%22stats%22%3E%0A%20%20%3Ctable%20summary=%22User%20stats%22%3E%0A%20%20%20%20%3Ctr%3E%0A%20%20%20%20%20%20%3Ctd%3E%0A%20%20%20%20%20%20%20%20%3Ca%20href=%22%3C%25=%20following_user_path(@user)%20%25%3E%22%3E%0A%20%20%20%20%20%20%20%20%20%20%3Cspan%20id=%22following%22%20class=%22stat%22%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%3C%25=%20@user.following.count%20%25%3E%20following%0A%20%20%20%20%20%20%20%20%20%20%3C/span%3E%0A%20%20%20%20%20%20%20%20%3C/a%3E%0A%20%20%20%20%20%20%3C/td%3E%0A%20%20%20%20%20%20%3Ctd%3E%0A%20%20%20%20%20%20%20%20%3Ca%20href=%22%3C%25=%20followers_user_path(@user)%20%25%3E%22%3E%0A%20%20%20%20%20%20%20%20%20%20%3Cspan%20id=%22followers%22%20class=%22stat%22%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%3C%25=%20pluralize(@user.followers.count,%20%22follower%22)%20%25%3E%0A%20%20%20%20%20%20%20%20%20%20%3C/span%3E%0A%20%20%20%20%20%20%20%20%3C/a%3E%0A%20%20%20%20%20%20%3C/td%3E%0A%20%20%20%20%3C/tr%3E%0A%20%20%3C/table%3E%0A%3C/div%3E%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=%3C%25%20@user%20%7C%7C=%20current_user%20%25%3E%0A%3Cdiv%20class=%22stats%22%3E%0A%20%20%3Ctable%20summary=%22User%20stats%22%3E%0A%20%20%20%20%3Ctr%3E%0A%20%20%20%20%20%20%3Ctd%3E%0A%20%20%20%20%20%20%20%20%3Ca%20href=%22%3C%25=%20following_user_path(@user)%20%25%3E%22%3E%0A%20%20%20%20%20%20%20%20%20%20%3Cspan%20id=%22following%22%20class=%22stat%22%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%3C%25=%20@user.following.count%20%25%3E%20following%0A%20%20%20%20%20%20%20%20%20%20%3C/span%3E%0A%20%20%20%20%20%20%20%20%3C/a%3E%0A%20%20%20%20%20%20%3C/td%3E%0A%20%20%20%20%20%20%3Ctd%3E%0A%20%20%20%20%20%20%20%20%3Ca%20href=%22%3C%25=%20followers_user_path(@user)%20%25%3E%22%3E%0A%20%20%20%20%20%20%20%20%20%20%3Cspan%20id=%22followers%22%20class=%22stat%22%3E%0A%20%20%20%20%20%20%20%20%20%20%20%20%3C%25=%20pluralize(@user.followers.count,%20%22follower%22)%20%25%3E%0A%20%20%20%20%20%20%20%20%20%20%3C/span%3E%0A%20%20%20%20%20%20%20%20%3C/a%3E%0A%20%20%20%20%20%20%3C/td%3E%0A%20%20%20%20%3C/tr%3E%0A%20%20%3C/table%3E%0A%3C/div%3E%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="vi">@user</span> <span class="o">||=</span> <span class="n">current_user</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;stats&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;table</span> <span class="na">summary=</span><span class="s">&quot;User stats&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;tr&gt;</span>
      <span class="nt">&lt;td&gt;</span>
        <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;</span><span class="cp">&lt;%=</span> <span class="n">following_user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="s">&quot;</span><span class="nt">&gt;</span>
          <span class="nt">&lt;span</span> <span class="na">id=</span><span class="s">&quot;following&quot;</span> <span class="na">class=</span><span class="s">&quot;stat&quot;</span><span class="nt">&gt;</span>
            <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">following</span><span class="o">.</span><span class="n">count</span> <span class="cp">%&gt;</span> following
          <span class="nt">&lt;/span&gt;</span>
        <span class="nt">&lt;/a&gt;</span>
      <span class="nt">&lt;/td&gt;</span>
      <span class="nt">&lt;td&gt;</span>
        <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;</span><span class="cp">&lt;%=</span> <span class="n">followers_user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="s">&quot;</span><span class="nt">&gt;</span>
          <span class="nt">&lt;span</span> <span class="na">id=</span><span class="s">&quot;followers&quot;</span> <span class="na">class=</span><span class="s">&quot;stat&quot;</span><span class="nt">&gt;</span>
            <span class="cp">&lt;%=</span> <span class="n">pluralize</span><span class="p">(</span><span class="vi">@user</span><span class="o">.</span><span class="n">followers</span><span class="o">.</span><span class="n">count</span><span class="p">,</span> <span class="s2">&quot;follower&quot;</span><span class="p">)</span> <span class="cp">%&gt;</span>
          <span class="nt">&lt;/span&gt;</span>
        <span class="nt">&lt;/a&gt;</span>
      <span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;/tr&gt;</span>
  <span class="nt">&lt;/table&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</pre></div>
</div></div>


<p>Ici les comptes utilisateur de lecteurs et d'auteurs suivis sont calculés à travers l'association en utilisant&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="vi">@user</span><span class="o">.</span><span class="n">following</span><span class="o">.</span><span class="n">count</span>
</pre></div>
</div>


<p>… et&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="vi">@user</span><span class="o">.</span><span class="n">followers</span><span class="o">.</span><span class="n">count</span>
</pre></div>
</div>


<p>Comparez ceci aux comptes de micro-messages de l'<a class="ref" href="user-microposts#code:user_show_microposts">extrait&nbsp;11.16</a>, où nous avions écrit&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">count</span>
</pre></div>
</div>


<p>… pour compter les micro-messages.</p>

<p>Puisque nous inclurons les statistiques sur la page d'affichage ainsi que sur la page d'accueil de l'utilisateur, la première ligne de l'<a class="ref" href="following-users#code:stats_partial">extrait&nbsp;12.21</a> choisit la bonne en utilisant&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="vi">@user</span> <span class="o">||=</span> <span class="n">current_user</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>Comme discuté dans la <a class="ref" href="sign-in-sign-out#sidebar:or_equals">Box&nbsp;9.4</a>, cela ne fait rien quand <code>@user</code> n'est pas <code>nil</code> (comme sur la page de profil), mais quand il l'est (comme sur la page d'accueil), il règle la valeur de <code>@user</code> à l'utilisateur courant.</p>

<p>Un détail final qui vaut le coup d'être noté eset la présence des ids CSS sur certains éléments, comme dans&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;span</span> <span class="na">id=</span><span class="s">&quot;following&quot;</span> <span class="na">class=</span><span class="s">&quot;stat&quot;</span><span class="nt">&gt;</span>
...
<span class="nt">&lt;/span&gt;</span>
</pre></div>
</div>


<p>C'est pour le bénéfice de l'implémentation Ajax à la <a class="ref" href="following-users#sec:a_working_follow_button_with_ajax">section&nbsp;12.2.5</a>, qui accède aux élément de la page en utilisant leur identifiant unique.</p>

<p>Avec le partiel en main, inclure les statistiques sur la page d'accueil est facile, comme montré dans l'<a class="ref" href="following-users#code:home_page_stats">extrait&nbsp;12.22</a> (ce fait aussi réussir le test de l'<a class="ref" href="following-users#code:stats_view_test">extrait&nbsp;12.20</a>). Le résultat est présenté dans l'<a class="ref" href="following-users#fig:home_page_follow_stats">illustration&nbsp;12.11</a>.</p>

<div class="label" id="code:home_page_stats"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 12.22.</span> <span class="description">Ajouté les statistiques lecteur à la page d'accueil. <br /> <code>app/views/pages/home.html.erb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_a04967c56a233cc858e284e66c959ec0d6d189e2">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=%3C%25%20if%20signed_in?%20%25%3E%0A%20%20%20%20%20%20%20%20.%0A%20%20%20%20%20%20%20%20.%0A%20%20%20%20%20%20%20%20.%0A%20%20%20%20%20%20%20%20%3C%25=%20render%20'shared/user_info'%20%25%3E%0A%20%20%20%20%20%20%20%20%3C%25=%20render%20'shared/stats'%20%25%3E%0A%20%20%20%20%20%20%3C/td%3E%0A%20%20%20%20%3C/tr%3E%0A%20%20%3C/table%3E%0A%3C%25%20else%20%25%3E%0A%20%20.%0A%20%20.%0A%20%20.%0A%3C%25%20end%20%25%3E%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=%3C%25%20if%20signed_in?%20%25%3E%0A%20%20%20%20%20%20%20%20.%0A%20%20%20%20%20%20%20%20.%0A%20%20%20%20%20%20%20%20.%0A%20%20%20%20%20%20%20%20%3C%25=%20render%20'shared/user_info'%20%25%3E%0A%20%20%20%20%20%20%20%20%3C%25=%20render%20'shared/stats'%20%25%3E%0A%20%20%20%20%20%20%3C/td%3E%0A%20%20%20%20%3C/tr%3E%0A%20%20%3C/table%3E%0A%3C%25%20else%20%25%3E%0A%20%20.%0A%20%20.%0A%20%20.%0A%3C%25%20end%20%25%3E%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">signed_in?</span> <span class="cp">%&gt;</span>
        .
        .
        .
        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/user_info&#39;</span> <span class="cp">%&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/stats&#39;</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;/tr&gt;</span>
  <span class="nt">&lt;/table&gt;</span>
<span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
  .
  .
  .
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>




<div class="label" id="fig:home_page_follow_stats"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/home_page_follow_stats.png" alt="home_page_follow_stats" /></span></div><div class="caption"><span class="header">Illustration 12.11: </span><span class="description">La page d'accueil (<a href="http://localhost:3000/"><tt>/</tt></a>) avec les statistiques de suivi.&nbsp;<a href="http://railstutorial.org/images/figures/home_page_follow_stats-full.png">(taille normale)</a></span></div></div>


<p>Nous rendrons le partiel des statistiques sur la page de profil dans un moment, mais d'abord faisant un partiel pour le bouton suivre/ne plus suivre comme montré dans l'<a class="ref" href="following-users#code:follow_form_partial">extrait&nbsp;12.23</a>.</p>

<div class="label" id="code:follow_form_partial"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 12.23.</span> <span class="description">Un partiel pour le formulaire suivre/ne plus suivre. <br /> <code>app/views/users/_follow_form.html.erb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_2337bfec11e8c2f2a07030f34310328d20202f20">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=%3C%25%20unless%20current_user?(@user)%20%25%3E%0A%20%20%3Cdiv%20id=%22follow_form%22%3E%0A%20%20%3C%25%20if%20current_user.following?(@user)%20%25%3E%0A%20%20%20%20%3C%25=%20render%20'unfollow'%20%25%3E%0A%20%20%3C%25%20else%20%25%3E%0A%20%20%20%20%3C%25=%20render%20'follow'%20%25%3E%0A%20%20%3C%25%20end%20%25%3E%0A%20%20%3C/div%3E%0A%3C%25%20end%20%25%3E%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=%3C%25%20unless%20current_user?(@user)%20%25%3E%0A%20%20%3Cdiv%20id=%22follow_form%22%3E%0A%20%20%3C%25%20if%20current_user.following?(@user)%20%25%3E%0A%20%20%20%20%3C%25=%20render%20'unfollow'%20%25%3E%0A%20%20%3C%25%20else%20%25%3E%0A%20%20%20%20%3C%25=%20render%20'follow'%20%25%3E%0A%20%20%3C%25%20end%20%25%3E%0A%20%20%3C/div%3E%0A%3C%25%20end%20%25%3E%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%</span> <span class="k">unless</span> <span class="n">current_user?</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;follow_form&quot;</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">following?</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;unfollow&#39;</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">else</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;follow&#39;</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p>Cela ne fait rien d'autre que différer le vrai travail aux partiels <code>follow</code> (<em>suivre</em>) et <code>unfollow</code> (<em>ne plus suivre</em>), qui ont besoin de nouvelles routes avec des règles pour la ressource Relationships, qui suivent l'exemple de la ressource Microposts (<a class="ref" href="user-microposts#code:microposts_resource">extrait&nbsp;11.21</a>), comme présenté dans l'<a class="ref" href="following-users#code:relationships_resource">extrait&nbsp;12.24</a>.</p>

<div class="label" id="code:relationships_resource"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 12.24.</span> <span class="description">Ajout des routes pour les relations de l'utilisateur. <br /> <code>config/routes.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_90ba233fff15a344697da7a6de491ab912922262">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=SampleApp::Application.routes.draw%20do%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20resources%20:sessions,%20%20%20%20%20%20:only%20=%3E%20[:new,%20:create,%20:destroy]%0A%20%20resources%20:microposts,%20%20%20%20:only%20=%3E%20[:create,%20:destroy]%0A%20%20resources%20:relationships,%20:only%20=%3E%20[:create,%20:destroy]%0A%20%20.%0A%20%20.%0A%20%20.%0Aend%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=SampleApp::Application.routes.draw%20do%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20resources%20:sessions,%20%20%20%20%20%20:only%20=%3E%20[:new,%20:create,%20:destroy]%0A%20%20resources%20:microposts,%20%20%20%20:only%20=%3E%20[:create,%20:destroy]%0A%20%20resources%20:relationships,%20:only%20=%3E%20[:create,%20:destroy]%0A%20%20.%0A%20%20.%0A%20%20.%0Aend%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="no">SampleApp</span><span class="o">::</span><span class="no">Application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">resources</span> <span class="ss">:sessions</span><span class="p">,</span>      <span class="ss">:only</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:new</span><span class="p">,</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
  <span class="n">resources</span> <span class="ss">:microposts</span><span class="p">,</span>    <span class="ss">:only</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
  <span class="n">resources</span> <span class="ss">:relationships</span><span class="p">,</span> <span class="ss">:only</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Les partiels suivre/ne plus suivre eux-mêmes sont montrés dans l'<a class="ref" href="following-users#code:follow_form">extrait&nbsp;12.25</a> et l'<a class="ref" href="following-users#code:unfollow_form">extrait&nbsp;12.26</a>.</p>

<div class="label" id="code:follow_form"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 12.25.</span> <span class="description">Un formulaire pour suivre un utilisateur. <br /> <code>app/views/users/_follow.html.erb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_d16e8264b318f6d997a97ad0b07ccaefea055276">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=%3C%25=%20form_for%20current_user.relationships.%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20build(:followed_id%20=%3E%20@user.id)%20do%20%7Cf%7C%20%25%3E%0A%20%20%3Cdiv%3E%3C%25=%20f.hidden_field%20:followed_id%20%25%3E%3C/div%3E%0A%20%20%3Cdiv%20class=%22actions%22%3E%3C%25=%20f.submit%20%22Follow%22%20%25%3E%3C/div%3E%0A%3C%25%20end%20%25%3E%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=%3C%25=%20form_for%20current_user.relationships.%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20build(:followed_id%20=%3E%20@user.id)%20do%20%7Cf%7C%20%25%3E%0A%20%20%3Cdiv%3E%3C%25=%20f.hidden_field%20:followed_id%20%25%3E%3C/div%3E%0A%20%20%3Cdiv%20class=%22actions%22%3E%3C%25=%20f.submit%20%22Follow%22%20%25%3E%3C/div%3E%0A%3C%25%20end%20%25%3E%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">form_for</span> <span class="n">current_user</span><span class="o">.</span><span class="n">relationships</span><span class="o">.</span>
                          <span class="n">build</span><span class="p">(</span><span class="ss">:followed_id</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div&gt;</span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">hidden_field</span> <span class="ss">:followed_id</span> <span class="cp">%&gt;</span><span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;actions&quot;</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">&quot;Follow&quot;</span> <span class="cp">%&gt;</span><span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>




<div class="label" id="code:unfollow_form"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 12.26.</span> <span class="description">Un formulaire pour ne plus suivre un utilisateur. <br /> <code>app/views/users/_unfollow.html.erb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_2fe424f6ab189771960f228241a2f4b9b6b0f413">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=%3C%25=%20form_for%20current_user.relationships.find_by_followed_id(@user),%0A%20%20%20%20%20%20%20%20%20%20%20%20%20:html%20=%3E%20%7B%20:method%20=%3E%20:delete%20%7D%20do%20%7Cf%7C%20%25%3E%0A%20%20%3Cdiv%20class=%22actions%22%3E%3C%25=%20f.submit%20%22Unfollow%22%20%25%3E%3C/div%3E%0A%3C%25%20end%20%25%3E%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=%3C%25=%20form_for%20current_user.relationships.find_by_followed_id(@user),%0A%20%20%20%20%20%20%20%20%20%20%20%20%20:html%20=%3E%20%7B%20:method%20=%3E%20:delete%20%7D%20do%20%7Cf%7C%20%25%3E%0A%20%20%3Cdiv%20class=%22actions%22%3E%3C%25=%20f.submit%20%22Unfollow%22%20%25%3E%3C/div%3E%0A%3C%25%20end%20%25%3E%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">form_for</span> <span class="n">current_user</span><span class="o">.</span><span class="n">relationships</span><span class="o">.</span><span class="n">find_by_followed_id</span><span class="p">(</span><span class="vi">@user</span><span class="p">),</span>
             <span class="ss">:html</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:method</span> <span class="o">=&gt;</span> <span class="ss">:delete</span> <span class="p">}</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;actions&quot;</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">&quot;Unfollow&quot;</span> <span class="cp">%&gt;</span><span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p>Ces formulaires utilisent tous deux <code>form_for</code> pour manipuler objet de modèle Relationship&nbsp;; la différence principale entre les deux est que l'<a class="ref" href="following-users#code:follow_form">extrait&nbsp;12.25</a> construit une  <em>nouvelle</em> relation, tandis que l'<a class="ref" href="following-users#code:unfollow_form">extrait&nbsp;12.26</a> cherche la relation existente. Naturellement, la première envoie une requête <tt>POST</tt> au contrôleur Relationships pour créer (<code>create</code>) une relation, tandis que la seconde envoie une requête <tt>DELETE</tt> pour détruire (<code>destroy</code>) une relation (nous écrirons ces actions à la <a class="ref" href="following-users#sec:a_working_follow_button_the_standard_way">section&nbsp;12.2.4</a>) Enfin, vous noterez que le formulaire suivre/ne plus suivre n'a aucun contenu autre que le bouton, mais il a encore besoin d'envoyer le <code>followed_id</code>, ce que nous accomplirons avec <code>hidden_field</code>&nbsp;; cela produit un code HTML de la forme&nbsp;:</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">&quot;relationship_followed_id&quot;</span> <span class="na">name=</span><span class="s">&quot;relationship[followed_id]&quot;</span>
<span class="na">type=</span><span class="s">&quot;hidden&quot;</span> <span class="na">value=</span><span class="s">&quot;3&quot;</span> <span class="nt">/&gt;</span>
</pre></div>
</div>


<p>… qui place l'information voulu sur la page sans l'afficher dans le navigateur.</p>

<p>Nous pouvons maintenant inclure le formulaire de suivi et les statistiques de suivi sur la page de profil simplement en rendant les partiels, comme montré dans l'<a class="ref" href="following-users#code:user_follow_form_profile_stats">extrait&nbsp;12.27</a>. Les profils avec les boutons «&nbsp;suivre&nbsp;» et «&nbsp;ne plus suivre&nbsp;», respectivement, apparaissent dans l'<a class="ref" href="following-users#fig:profile_follow_button">illustration&nbsp;12.12</a> et l'<a class="ref" href="following-users#fig:profile_unfollow_button">illustration&nbsp;12.13</a>.</p>

<div class="label" id="code:user_follow_form_profile_stats"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 12.27.</span> <span class="description">Ajout du formulaire de suivi et des statistiques de suivi à la page profil de l'utilisateur. <br /> <code>app/views/users/show.html.erb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_e53fcc86528f05f01a71c16f583e4a20a89e82c2">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=%3Ctable%20class=%22profile%22%20summary=%22Profile%20information%22%3E%0A%20%20%3Ctr%3E%0A%20%20%20%20%3Ctd%20class=%22main%22%3E%0A%20%20%20%20%20%20%3Ch1%3E%0A%20%20%20%20%20%20%20%20%3C%25=%20gravatar_for%20@user%20%25%3E%0A%20%20%20%20%20%20%20%20%3C%25=%20@user.name%20%25%3E%0A%20%20%20%20%20%20%3C/h1%3E%0A%20%20%20%20%20%20%3C%25=%20render%20'follow_form'%20if%20signed_in?%20%25%3E%0A%20%20%20%20%20%20.%0A%20%20%20%20%20%20.%0A%20%20%20%20%20%20.%0A%20%20%20%20%3C/td%3E%0A%20%20%20%20%3Ctd%20class=%22sidebar%20round%22%3E%0A%20%20%20%20%20%20%3Cstrong%3EName%3C/strong%3E%20%3C%25=%20@user.name%20%25%3E%3Cbr%20/%3E%0A%20%20%20%20%20%20%3Cstrong%3EURL%3C/strong%3E%20%3C%25=%20link_to%20user_path(@user),%20@user%20%25%3E%3Cbr%20/%3E%0A%20%20%20%20%20%20%3Cstrong%3EMicroposts%3C/strong%3E%20%3C%25=%20@user.microposts.count%20%25%3E%0A%20%20%20%20%20%20%3C%25=%20render%20'shared/stats'%20%25%3E%0A%20%20%20%20%3C/td%3E%0A%20%20%3C/tr%3E%0A%3C/table%3E%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=%3Ctable%20class=%22profile%22%20summary=%22Profile%20information%22%3E%0A%20%20%3Ctr%3E%0A%20%20%20%20%3Ctd%20class=%22main%22%3E%0A%20%20%20%20%20%20%3Ch1%3E%0A%20%20%20%20%20%20%20%20%3C%25=%20gravatar_for%20@user%20%25%3E%0A%20%20%20%20%20%20%20%20%3C%25=%20@user.name%20%25%3E%0A%20%20%20%20%20%20%3C/h1%3E%0A%20%20%20%20%20%20%3C%25=%20render%20'follow_form'%20if%20signed_in?%20%25%3E%0A%20%20%20%20%20%20.%0A%20%20%20%20%20%20.%0A%20%20%20%20%20%20.%0A%20%20%20%20%3C/td%3E%0A%20%20%20%20%3Ctd%20class=%22sidebar%20round%22%3E%0A%20%20%20%20%20%20%3Cstrong%3EName%3C/strong%3E%20%3C%25=%20@user.name%20%25%3E%3Cbr%20/%3E%0A%20%20%20%20%20%20%3Cstrong%3EURL%3C/strong%3E%20%3C%25=%20link_to%20user_path(@user),%20@user%20%25%3E%3Cbr%20/%3E%0A%20%20%20%20%20%20%3Cstrong%3EMicroposts%3C/strong%3E%20%3C%25=%20@user.microposts.count%20%25%3E%0A%20%20%20%20%20%20%3C%25=%20render%20'shared/stats'%20%25%3E%0A%20%20%20%20%3C/td%3E%0A%20%20%3C/tr%3E%0A%3C/table%3E%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;table</span> <span class="na">class=</span><span class="s">&quot;profile&quot;</span> <span class="na">summary=</span><span class="s">&quot;Profile information&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;tr&gt;</span>
    <span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">&quot;main&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;h1&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">gravatar_for</span> <span class="vi">@user</span> <span class="cp">%&gt;</span>
        <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/h1&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;follow_form&#39;</span> <span class="k">if</span> <span class="n">signed_in?</span> <span class="cp">%&gt;</span>
      .
      .
      .
    <span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">&quot;sidebar round&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;strong&gt;</span>Name<span class="nt">&lt;/strong&gt;</span> <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span><span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;strong&gt;</span>URL<span class="nt">&lt;/strong&gt;</span> <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">),</span> <span class="vi">@user</span> <span class="cp">%&gt;</span><span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;strong&gt;</span>Microposts<span class="nt">&lt;/strong&gt;</span> <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">count</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/stats&#39;</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/td&gt;</span>
  <span class="nt">&lt;/tr&gt;</span>
<span class="nt">&lt;/table&gt;</span>
</pre></div>
</div></div>




<div class="label" id="fig:profile_follow_button"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/profile_follow_button.png" alt="profile_follow_button" /></span></div><div class="caption"><span class="header">Illustration 12.12: </span><span class="description">Un profil d'utilisateur avec un bouton «&nbsp;suivre&nbsp;» (<a href="http://localhost:3000/users/8"><tt>/users/8</tt></a>).&nbsp;<a href="http://railstutorial.org/images/figures/profile_follow_button-full.png">(taille normale)</a></span></div></div>




<div class="label" id="fig:profile_unfollow_button"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/profile_unfollow_button.png" alt="profile_unfollow_button" /></span></div><div class="caption"><span class="header">Illustration 12.13: </span><span class="description">Un profil d'utilisateur avec un bouton «&nbsp;ne plus suivre&nbsp;» (<a href="http://localhost:3000/users/8"><tt>/users/6</tt></a>).&nbsp;<a href="http://railstutorial.org/images/figures/profile_unfollow_button-full.png">(taille normale)</a></span></div></div>


<p>Nous obtiendrons le fonctionnement de ces boutons bien assez tôt &mdash;&nbsp;en fait, nous le ferons de deux manières, la façon stardard (<a class="ref" href="following-users#sec:a_working_follow_button_the_standard_way">section&nbsp;12.2.4</a>) et celle en utilisant Ajax (<a class="ref" href="following-users#sec:a_working_follow_button_with_ajax">section&nbsp;12.2.5</a>)&nbsp;&mdash; mais d'abord nous allons finir le code HTML de l'interface en construisant les pages des lecteurs et des auteurs de l'utilisateur.</p>

<div class="label" id="sec:following_and_followers_pages"></div>

<!-- FIN FRENCH -->
<h3><a id="sec:12.2.3" href="following-users#sec:following_and_followers_pages" class="heading"><span class="number">12.2.3</span> Following and followers pages</a></h3>


<p>Pages to display user following and followers will resemble a hybrid of the user profile page and the user index page (<a class="ref" href="updating-showing-and-deleting-users#sec:user_index">section&nbsp;10.3.1</a>), with a sidebar of user information (including the following stats) and a table of users. In addition, we&rsquo;ll include a raster of user profile image links in the sidebar. Mockups matching these requirements appear in <a class="ref" href="following-users#fig:following_mockup">illustration&nbsp;12.14</a> (following) and <a class="ref" href="following-users#fig:followers_mockup">illustration&nbsp;12.15</a> (followers).</p>

<div class="label" id="fig:following_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/following_mockup.png" alt="following_mockup" /></span></div><div class="caption"><span class="header">Illustration 12.14: </span><span class="description">A mockup of the user following page.&nbsp;<a href="http://railstutorial.org/images/figures/following_mockup-full.png">(taille normale)</a></span></div></div>




<div class="label" id="fig:followers_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/followers_mockup.png" alt="followers_mockup" /></span></div><div class="caption"><span class="header">Illustration 12.15: </span><span class="description">A mockup of the user followers page.&nbsp;<a href="http://railstutorial.org/images/figures/followers_mockup-full.png">(taille normale)</a></span></div></div>


<p>Our first step is to get the following and followers links to work. We&rsquo;ll follow Twitter&rsquo;s lead and have both pages to require user signin. For signed-in users, the pages should have links for following and followers, respectively. <a class="ref" href="following-users#code:following_followers_tests">extrait&nbsp;12.28</a> expresses these expectations in code.<sup class="footnote" id="fnref:12.12"><a href="#fn:12.12">12</a></sup></p>

<div class="label" id="code:following_followers_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 12.28.</span> <span class="description">Test for the <code>following</code> and <code>followers</code> actions. <br /> <code>spec/controllers/users_controller_spec.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_04a4aa6b0115df17434a57768a1bca0b3212f283">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=describe%20UsersController%20do%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20describe%20%22follow%20pages%22%20do%0A%20%20%20%20%0A%20%20%20%20describe%20%22when%20not%20signed%20in%22%20do%0A%0A%20%20%20%20%20%20it%20%22should%20protect%20'following'%22%20do%0A%20%20%20%20%20%20%20%20get%20:following,%20:id%20=%3E%201%0A%20%20%20%20%20%20%20%20response.should%20redirect_to(signin_path)%0A%20%20%20%20%20%20end%0A%0A%20%20%20%20%20%20it%20%22should%20protect%20'followers'%22%20do%0A%20%20%20%20%20%20%20%20get%20:followers,%20:id%20=%3E%201%0A%20%20%20%20%20%20%20%20response.should%20redirect_to(signin_path)%0A%20%20%20%20%20%20end%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20describe%20%22when%20signed%20in%22%20do%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20before(:each)%20do%0A%20%20%20%20%20%20%20%20@user%20=%20test_sign_in(Factory(:user))%0A%20%20%20%20%20%20%20%20@other_user%20=%20Factory(:user,%20:email%20=%3E%20Factory.next(:email))%0A%20%20%20%20%20%20%20%20@user.follow!(@other_user)%0A%20%20%20%20%20%20end%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20it%20%22should%20show%20user%20following%22%20do%0A%20%20%20%20%20%20%20%20get%20:following,%20:id%20=%3E%20@user%0A%20%20%20%20%20%20%20%20response.should%20have_selector(%22a%22,%20:href%20=%3E%20user_path(@other_user),%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:content%20=%3E%20@other_user.name)%0A%20%20%20%20%20%20end%0A%0A%20%20%20%20%20%20it%20%22should%20show%20user%20followers%22%20do%0A%20%20%20%20%20%20%20%20get%20:followers,%20:id%20=%3E%20@other_user%0A%20%20%20%20%20%20%20%20response.should%20have_selector(%22a%22,%20:href%20=%3E%20user_path(@user),%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:content%20=%3E%20@user.name)%0A%20%20%20%20%20%20end%0A%20%20%20%20end%0A%20%20end%0Aend%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=describe%20UsersController%20do%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20describe%20%22follow%20pages%22%20do%0A%20%20%20%20%0A%20%20%20%20describe%20%22when%20not%20signed%20in%22%20do%0A%0A%20%20%20%20%20%20it%20%22should%20protect%20'following'%22%20do%0A%20%20%20%20%20%20%20%20get%20:following,%20:id%20=%3E%201%0A%20%20%20%20%20%20%20%20response.should%20redirect_to(signin_path)%0A%20%20%20%20%20%20end%0A%0A%20%20%20%20%20%20it%20%22should%20protect%20'followers'%22%20do%0A%20%20%20%20%20%20%20%20get%20:followers,%20:id%20=%3E%201%0A%20%20%20%20%20%20%20%20response.should%20redirect_to(signin_path)%0A%20%20%20%20%20%20end%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20describe%20%22when%20signed%20in%22%20do%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20before(:each)%20do%0A%20%20%20%20%20%20%20%20@user%20=%20test_sign_in(Factory(:user))%0A%20%20%20%20%20%20%20%20@other_user%20=%20Factory(:user,%20:email%20=%3E%20Factory.next(:email))%0A%20%20%20%20%20%20%20%20@user.follow!(@other_user)%0A%20%20%20%20%20%20end%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20it%20%22should%20show%20user%20following%22%20do%0A%20%20%20%20%20%20%20%20get%20:following,%20:id%20=%3E%20@user%0A%20%20%20%20%20%20%20%20response.should%20have_selector(%22a%22,%20:href%20=%3E%20user_path(@other_user),%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:content%20=%3E%20@other_user.name)%0A%20%20%20%20%20%20end%0A%0A%20%20%20%20%20%20it%20%22should%20show%20user%20followers%22%20do%0A%20%20%20%20%20%20%20%20get%20:followers,%20:id%20=%3E%20@other_user%0A%20%20%20%20%20%20%20%20response.should%20have_selector(%22a%22,%20:href%20=%3E%20user_path(@user),%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:content%20=%3E%20@user.name)%0A%20%20%20%20%20%20end%0A%20%20%20%20end%0A%20%20end%0Aend%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="no">UsersController</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;follow pages&quot;</span> <span class="k">do</span>

    <span class="n">describe</span> <span class="s2">&quot;quand pas identifié&quot;</span> <span class="k">do</span>

      <span class="n">it</span> <span class="s2">&quot;should protect &#39;following&#39;&quot;</span> <span class="k">do</span>
        <span class="n">get</span> <span class="ss">:following</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="mi">1</span>
        <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">signin_path</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should protect &#39;followers&#39;&quot;</span> <span class="k">do</span>
        <span class="n">get</span> <span class="ss">:followers</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="mi">1</span>
        <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">signin_path</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">describe</span> <span class="s2">&quot;quand identifié&quot;</span> <span class="k">do</span>

      <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
        <span class="vi">@user</span> <span class="o">=</span> <span class="n">test_sign_in</span><span class="p">(</span><span class="no">Factory</span><span class="p">(</span><span class="ss">:user</span><span class="p">))</span>
        <span class="vi">@other_user</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:user</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="no">Factory</span><span class="o">.</span><span class="n">next</span><span class="p">(</span><span class="ss">:email</span><span class="p">))</span>
        <span class="vi">@user</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="vi">@other_user</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should show user following&quot;</span> <span class="k">do</span>
        <span class="n">get</span> <span class="ss">:following</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="vi">@user</span>
        <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="ss">:href</span> <span class="o">=&gt;</span> <span class="n">user_path</span><span class="p">(</span><span class="vi">@other_user</span><span class="p">),</span>
                                           <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="vi">@other_user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should show user followers&quot;</span> <span class="k">do</span>
        <span class="n">get</span> <span class="ss">:followers</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="vi">@other_user</span>
        <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">have_selector</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="ss">:href</span> <span class="o">=&gt;</span> <span class="n">user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">),</span>
                                           <span class="ss">:content</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>The only tricky part of the implementation is realizing that we need to add two new actions to the Users controller; based on the routes defined in <a class="ref" href="following-users#code:following_followers_actions_routes">extrait&nbsp;12.19</a>, we need to call them <code>following</code> and <code>followers</code>. Each action needs to set a title, find the user, retrieve either <code>@user.following</code> or <code>@user.followers</code> (in paginated form), and then render the page. The result appears in <a class="ref" href="following-users#code:following_followers_actions">extrait&nbsp;12.29</a>.</p>

<div class="label" id="code:following_followers_actions"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 12.29.</span> <span class="description">The <code>following</code> and <code>followers</code> actions. <br /> <code>app/controllers/users_controller.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_c634255abf6c0b429341c6e98aa424bf524dfd64">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=class%20UsersController%20%3C%20ApplicationController%0A%20%20before_filter%20:authenticate,%20:except%20=%3E%20[:show,%20:new,%20:create]%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20def%20following%0A%20%20%20%20@title%20=%20%22Following%22%0A%20%20%20%20@user%20=%20User.find(params[:id])%0A%20%20%20%20@users%20=%20@user.following.paginate(:page%20=%3E%20params[:page])%0A%20%20%20%20render%20'show_follow'%0A%20%20end%0A%0A%20%20def%20followers%0A%20%20%20%20@title%20=%20%22Followers%22%0A%20%20%20%20@user%20=%20User.find(params[:id])%0A%20%20%20%20@users%20=%20@user.followers.paginate(:page%20=%3E%20params[:page])%0A%20%20%20%20render%20'show_follow'%0A%20%20end%0A%20%20.%0A%20%20.%0A%20%20.%0Aend%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=class%20UsersController%20%3C%20ApplicationController%0A%20%20before_filter%20:authenticate,%20:except%20=%3E%20[:show,%20:new,%20:create]%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20def%20following%0A%20%20%20%20@title%20=%20%22Following%22%0A%20%20%20%20@user%20=%20User.find(params[:id])%0A%20%20%20%20@users%20=%20@user.following.paginate(:page%20=%3E%20params[:page])%0A%20%20%20%20render%20'show_follow'%0A%20%20end%0A%0A%20%20def%20followers%0A%20%20%20%20@title%20=%20%22Followers%22%0A%20%20%20%20@user%20=%20User.find(params[:id])%0A%20%20%20%20@users%20=%20@user.followers.paginate(:page%20=%3E%20params[:page])%0A%20%20%20%20render%20'show_follow'%0A%20%20end%0A%20%20.%0A%20%20.%0A%20%20.%0Aend%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:authenticate</span><span class="p">,</span> <span class="ss">:except</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:show</span><span class="p">,</span> <span class="ss">:new</span><span class="p">,</span> <span class="ss">:create</span><span class="o">]</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">following</span>
    <span class="vi">@title</span> <span class="o">=</span> <span class="s2">&quot;Following&quot;</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
    <span class="vi">@users</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">following</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">:page</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">)</span>
    <span class="n">render</span> <span class="s1">&#39;show_follow&#39;</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">followers</span>
    <span class="vi">@title</span> <span class="o">=</span> <span class="s2">&quot;Followers&quot;</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
    <span class="vi">@users</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">followers</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">:page</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">)</span>
    <span class="n">render</span> <span class="s1">&#39;show_follow&#39;</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Note here that both actions make an <em>explicit</em> call to <code>render</code>, in this case rendering a view called <code>show_follow</code>, which we must create. The reason for the common view is that the ERb is nearly identical for the two cases, and <a class="ref" href="following-users#code:show_follow_view">extrait&nbsp;12.30</a> covers them both.</p>

<div class="label" id="code:show_follow_view"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 12.30.</span> <span class="description">The <code>show_follow</code> view used to render following and followers. <br /> <code>app/views/users/show_follow.html.erb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_b3e76dd08b784ede6d1f05b441b5f30ca0d8b762">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=%3Ctable%20summary=%22Information%20about%20following/followers%22%3E%0A%20%20%3Ctr%3E%0A%20%20%20%20%3Ctd%20class=%22main%22%3E%0A%20%20%20%20%20%20%3Ch1%3E%3C%25=%20@title%20%25%3E%3C/h1%3E%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20%3C%25%20unless%20@users.empty?%20%25%3E%0A%20%20%20%20%20%20%20%20%3Cul%20class=%22users%22%3E%0A%20%20%20%20%20%20%20%20%20%20%3C%25=%20render%20@users%20%25%3E%0A%20%20%20%20%20%20%20%20%3C/ul%3E%0A%20%20%20%20%20%20%20%20%3C%25=%20will_paginate%20@users%20%25%3E%0A%20%20%20%20%20%20%3C%25%20end%20%25%3E%0A%20%20%20%20%3C/td%3E%0A%20%20%20%20%3Ctd%20class=%22sidebar%20round%22%3E%0A%20%20%20%20%20%20%3Cstrong%3EName%3C/strong%3E%20%3C%25=%20@user.name%20%25%3E%3Cbr%20/%3E%0A%20%20%20%20%20%20%3Cstrong%3EURL%3C/strong%3E%20%3C%25=%20link_to%20user_path(@user),%20@user%20%25%3E%3Cbr%20/%3E%0A%20%20%20%20%20%20%3Cstrong%3EMicroposts%3C/strong%3E%20%3C%25=%20@user.microposts.count%20%25%3E%0A%20%20%20%20%20%20%3C%25=%20render%20'shared/stats'%20%25%3E%0A%20%20%20%20%20%20%3C%25%20unless%20@users.empty?%20%25%3E%0A%20%20%20%20%20%20%20%20%3C%25%20@users.each%20do%20%7Cuser%7C%20%25%3E%0A%20%20%20%20%20%20%20%20%20%20%3C%25=%20link_to%20gravatar_for(user,%20:size%20=%3E%2030),%20user%20%25%3E%0A%20%20%20%20%20%20%20%20%3C%25%20end%20%25%3E%0A%20%20%20%20%20%20%3C%25%20end%20%25%3E%0A%20%20%20%20%3C/td%3E%0A%20%20%3C/tr%3E%0A%3C/table%3E%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=%3Ctable%20summary=%22Information%20about%20following/followers%22%3E%0A%20%20%3Ctr%3E%0A%20%20%20%20%3Ctd%20class=%22main%22%3E%0A%20%20%20%20%20%20%3Ch1%3E%3C%25=%20@title%20%25%3E%3C/h1%3E%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20%3C%25%20unless%20@users.empty?%20%25%3E%0A%20%20%20%20%20%20%20%20%3Cul%20class=%22users%22%3E%0A%20%20%20%20%20%20%20%20%20%20%3C%25=%20render%20@users%20%25%3E%0A%20%20%20%20%20%20%20%20%3C/ul%3E%0A%20%20%20%20%20%20%20%20%3C%25=%20will_paginate%20@users%20%25%3E%0A%20%20%20%20%20%20%3C%25%20end%20%25%3E%0A%20%20%20%20%3C/td%3E%0A%20%20%20%20%3Ctd%20class=%22sidebar%20round%22%3E%0A%20%20%20%20%20%20%3Cstrong%3EName%3C/strong%3E%20%3C%25=%20@user.name%20%25%3E%3Cbr%20/%3E%0A%20%20%20%20%20%20%3Cstrong%3EURL%3C/strong%3E%20%3C%25=%20link_to%20user_path(@user),%20@user%20%25%3E%3Cbr%20/%3E%0A%20%20%20%20%20%20%3Cstrong%3EMicroposts%3C/strong%3E%20%3C%25=%20@user.microposts.count%20%25%3E%0A%20%20%20%20%20%20%3C%25=%20render%20'shared/stats'%20%25%3E%0A%20%20%20%20%20%20%3C%25%20unless%20@users.empty?%20%25%3E%0A%20%20%20%20%20%20%20%20%3C%25%20@users.each%20do%20%7Cuser%7C%20%25%3E%0A%20%20%20%20%20%20%20%20%20%20%3C%25=%20link_to%20gravatar_for(user,%20:size%20=%3E%2030),%20user%20%25%3E%0A%20%20%20%20%20%20%20%20%3C%25%20end%20%25%3E%0A%20%20%20%20%20%20%3C%25%20end%20%25%3E%0A%20%20%20%20%3C/td%3E%0A%20%20%3C/tr%3E%0A%3C/table%3E%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="nt">&lt;table</span> <span class="na">summary=</span><span class="s">&quot;Information about following/followers&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;tr&gt;</span>
    <span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">&quot;main&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;h1&gt;</span><span class="cp">&lt;%=</span> <span class="vi">@title</span> <span class="cp">%&gt;</span><span class="nt">&lt;/h1&gt;</span>

      <span class="cp">&lt;%</span> <span class="k">unless</span> <span class="vi">@users</span><span class="o">.</span><span class="n">empty?</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;users&quot;</span><span class="nt">&gt;</span>
          <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@users</span> <span class="cp">%&gt;</span>
        <span class="nt">&lt;/ul&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">will_paginate</span> <span class="vi">@users</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/td&gt;</span>
    <span class="nt">&lt;td</span> <span class="na">class=</span><span class="s">&quot;sidebar round&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;strong&gt;</span>Name<span class="nt">&lt;/strong&gt;</span> <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">name</span> <span class="cp">%&gt;</span><span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;strong&gt;</span>URL<span class="nt">&lt;/strong&gt;</span> <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">user_path</span><span class="p">(</span><span class="vi">@user</span><span class="p">),</span> <span class="vi">@user</span> <span class="cp">%&gt;</span><span class="nt">&lt;br</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;strong&gt;</span>Microposts<span class="nt">&lt;/strong&gt;</span> <span class="cp">&lt;%=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">count</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s1">&#39;shared/stats&#39;</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">unless</span> <span class="vi">@users</span><span class="o">.</span><span class="n">empty?</span> <span class="cp">%&gt;</span>
        <span class="cp">&lt;%</span> <span class="vi">@users</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="cp">%&gt;</span>
          <span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="n">gravatar_for</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="ss">:size</span> <span class="o">=&gt;</span> <span class="mi">30</span><span class="p">),</span> <span class="n">user</span> <span class="cp">%&gt;</span>
        <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/td&gt;</span>
  <span class="nt">&lt;/tr&gt;</span>
<span class="nt">&lt;/table&gt;</span>
</pre></div>
</div></div>


<p>There&rsquo;s a second detail in <a class="ref" href="following-users#code:following_followers_actions">extrait&nbsp;12.29</a> worth noting: in order to protect the pages for following and followers from unauthorized access, we have changed the authentication before filter to use <code>:except</code> instead of <code>:only</code>. So far in this tutorial, we have used <code>:only</code> to indicate which actions the filter gets applied to; with the addition of the new protected actions, the balance has shifted, and it is simpler to indicate which actions <em>shouldn&rsquo;t</em> be filtered. We do this with the <code>:except</code> option to the <code>authenticate</code> before filter:</p>

<div class="code"><div class="highlight"><pre><span class="n">before_filter</span> <span class="ss">:authenticate</span><span class="p">,</span> <span class="ss">:except</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:show</span><span class="p">,</span> <span class="ss">:new</span><span class="p">,</span> <span class="ss">:create</span><span class="o">]</span>
</pre></div>
</div>


<p>With that, the tests should now be passing, and the pages should render as shown in <a class="ref" href="following-users#fig:user_following">illustration&nbsp;12.16</a> (following) and <a class="ref" href="following-users#fig:user_followers">illustration&nbsp;12.17</a> (followers).</p>

<div class="label" id="fig:user_following"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_following.png" alt="user_following" /></span></div><div class="caption"><span class="header">Illustration 12.16: </span><span class="description">Showing the users being followed by the current user.&nbsp;<a href="http://railstutorial.org/images/figures/user_following-full.png">(taille normale)</a></span></div></div>




<div class="label" id="fig:user_followers"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_followers.png" alt="user_followers" /></span></div><div class="caption"><span class="header">Illustration 12.17: </span><span class="description">Showing the current user&rsquo;s followers.&nbsp;<a href="http://railstutorial.org/images/figures/user_followers-full.png">(taille normale)</a></span></div></div>


<p>You might note that, even with the common <code>show_followers</code> partial, the <code>following</code> and <code>followers</code> actions still have a lot of duplication. Moreover, the <code>show_followers</code> partial itself shares common features with the user show page. <a class="ref" href="following-users#sec:following_exercises">section&nbsp;12.5</a> includes exercises to eliminate these sources of duplication.</p>

<div class="label" id="sec:a_working_follow_button_the_standard_way"></div>


<h3><a id="sec:12.2.4" href="following-users#sec:a_working_follow_button_the_standard_way" class="heading"><span class="number">12.2.4</span> A working follow button the standard way</a></h3>


<p>Now that our views are in order, it&rsquo;s time to get the follow/unfollow buttons working. Since following a user creates a relationship, and unfollowing a user destroys a relationship, this involves writing the <code>create</code> and <code>destroy</code> actions for the Relationships controller. Naturally, both actions should be protected; for signed-in users, we will use the <code>follow!</code> and <code>unfollow!</code> utility methods defined in <a class="ref" href="following-users#sec:following">section&nbsp;12.1.4</a> to create and destroy the relevant relationships. These requirements lead to the tests in <a class="ref" href="following-users#code:relationships_controller_spec">extrait&nbsp;12.31</a>.</p>

<div class="label" id="code:relationships_controller_spec"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 12.31.</span> <span class="description">Tests for the Relationships controller actions. <br /> <code>spec/controllers/relationships_controller_spec.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_1885f0f9e3df7eea4bd5831873c3141b9e101537">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=require%20'spec_helper'%0A%0Adescribe%20RelationshipsController%20do%0A%0A%20%20describe%20%22access%20control%22%20do%0A%20%20%0A%20%20%20%20it%20%22should%20require%20signin%20for%20create%22%20do%0A%20%20%20%20%20%20post%20:create%0A%20%20%20%20%20%20response.should%20redirect_to(signin_path)%0A%20%20%20%20end%0A%0A%20%20%20%20it%20%22should%20require%20signin%20for%20destroy%22%20do%0A%20%20%20%20%20%20delete%20:destroy,%20:id%20=%3E%201%0A%20%20%20%20%20%20response.should%20redirect_to(signin_path)%0A%20%20%20%20end%0A%20%20end%0A%0A%20%20describe%20%22POST%20'create'%22%20do%0A%0A%20%20%20%20before(:each)%20do%0A%20%20%20%20%20%20@user%20=%20test_sign_in(Factory(:user))%0A%20%20%20%20%20%20@followed%20=%20Factory(:user,%20:email%20=%3E%20Factory.next(:email))%0A%20%20%20%20end%0A%0A%20%20%20%20it%20%22should%20create%20a%20relationship%22%20do%0A%20%20%20%20%20%20lambda%20do%0A%20%20%20%20%20%20%20%20post%20:create,%20:relationship%20=%3E%20%7B%20:followed_id%20=%3E%20@followed%20%7D%0A%20%20%20%20%20%20%20%20response.should%20be_redirect%0A%20%20%20%20%20%20end.should%20change(Relationship,%20:count).by(1)%0A%20%20%20%20end%0A%20%20end%0A%0A%20%20describe%20%22DELETE%20'destroy'%22%20do%0A%0A%20%20%20%20before(:each)%20do%0A%20%20%20%20%20%20@user%20=%20test_sign_in(Factory(:user))%0A%20%20%20%20%20%20@followed%20=%20Factory(:user,%20:email%20=%3E%20Factory.next(:email))%0A%20%20%20%20%20%20@user.follow!(@followed)%0A%20%20%20%20%20%20@relationship%20=%20@user.relationships.find_by_followed_id(@followed)%0A%20%20%20%20end%0A%0A%20%20%20%20it%20%22should%20destroy%20a%20relationship%22%20do%0A%20%20%20%20%20%20lambda%20do%0A%20%20%20%20%20%20%20%20delete%20:destroy,%20:id%20=%3E%20@relationship%0A%20%20%20%20%20%20%20%20response.should%20be_redirect%0A%20%20%20%20%20%20end.should%20change(Relationship,%20:count).by(%2D1)%0A%20%20%20%20end%0A%20%20end%0Aend%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=require%20'spec_helper'%0A%0Adescribe%20RelationshipsController%20do%0A%0A%20%20describe%20%22access%20control%22%20do%0A%20%20%0A%20%20%20%20it%20%22should%20require%20signin%20for%20create%22%20do%0A%20%20%20%20%20%20post%20:create%0A%20%20%20%20%20%20response.should%20redirect_to(signin_path)%0A%20%20%20%20end%0A%0A%20%20%20%20it%20%22should%20require%20signin%20for%20destroy%22%20do%0A%20%20%20%20%20%20delete%20:destroy,%20:id%20=%3E%201%0A%20%20%20%20%20%20response.should%20redirect_to(signin_path)%0A%20%20%20%20end%0A%20%20end%0A%0A%20%20describe%20%22POST%20'create'%22%20do%0A%0A%20%20%20%20before(:each)%20do%0A%20%20%20%20%20%20@user%20=%20test_sign_in(Factory(:user))%0A%20%20%20%20%20%20@followed%20=%20Factory(:user,%20:email%20=%3E%20Factory.next(:email))%0A%20%20%20%20end%0A%0A%20%20%20%20it%20%22should%20create%20a%20relationship%22%20do%0A%20%20%20%20%20%20lambda%20do%0A%20%20%20%20%20%20%20%20post%20:create,%20:relationship%20=%3E%20%7B%20:followed_id%20=%3E%20@followed%20%7D%0A%20%20%20%20%20%20%20%20response.should%20be_redirect%0A%20%20%20%20%20%20end.should%20change(Relationship,%20:count).by(1)%0A%20%20%20%20end%0A%20%20end%0A%0A%20%20describe%20%22DELETE%20'destroy'%22%20do%0A%0A%20%20%20%20before(:each)%20do%0A%20%20%20%20%20%20@user%20=%20test_sign_in(Factory(:user))%0A%20%20%20%20%20%20@followed%20=%20Factory(:user,%20:email%20=%3E%20Factory.next(:email))%0A%20%20%20%20%20%20@user.follow!(@followed)%0A%20%20%20%20%20%20@relationship%20=%20@user.relationships.find_by_followed_id(@followed)%0A%20%20%20%20end%0A%0A%20%20%20%20it%20%22should%20destroy%20a%20relationship%22%20do%0A%20%20%20%20%20%20lambda%20do%0A%20%20%20%20%20%20%20%20delete%20:destroy,%20:id%20=%3E%20@relationship%0A%20%20%20%20%20%20%20%20response.should%20be_redirect%0A%20%20%20%20%20%20end.should%20change(Relationship,%20:count).by(%2D1)%0A%20%20%20%20end%0A%20%20end%0Aend%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">&#39;spec_helper&#39;</span>

<span class="n">describe</span> <span class="no">RelationshipsController</span> <span class="k">do</span>

  <span class="n">describe</span> <span class="s2">&quot;access control&quot;</span> <span class="k">do</span>

    <span class="n">it</span> <span class="s2">&quot;should require signin for create&quot;</span> <span class="k">do</span>
      <span class="n">post</span> <span class="ss">:create</span>
      <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">signin_path</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should require signin for destroy&quot;</span> <span class="k">do</span>
      <span class="n">delete</span> <span class="ss">:destroy</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="mi">1</span>
      <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">redirect_to</span><span class="p">(</span><span class="n">signin_path</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;POST &#39;create&#39;&quot;</span> <span class="k">do</span>

    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="n">test_sign_in</span><span class="p">(</span><span class="no">Factory</span><span class="p">(</span><span class="ss">:user</span><span class="p">))</span>
      <span class="vi">@followed</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:user</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="no">Factory</span><span class="o">.</span><span class="n">next</span><span class="p">(</span><span class="ss">:email</span><span class="p">))</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should create a relationship&quot;</span> <span class="k">do</span>
      <span class="nb">lambda</span> <span class="k">do</span>
        <span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:relationship</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:followed_id</span> <span class="o">=&gt;</span> <span class="vi">@followed</span> <span class="p">}</span>
        <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">be_redirect</span>
      <span class="k">end</span><span class="o">.</span><span class="n">should</span> <span class="n">change</span><span class="p">(</span><span class="no">Relationship</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;DELETE &#39;destroy&#39;&quot;</span> <span class="k">do</span>

    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="vi">@user</span> <span class="o">=</span> <span class="n">test_sign_in</span><span class="p">(</span><span class="no">Factory</span><span class="p">(</span><span class="ss">:user</span><span class="p">))</span>
      <span class="vi">@followed</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:user</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="no">Factory</span><span class="o">.</span><span class="n">next</span><span class="p">(</span><span class="ss">:email</span><span class="p">))</span>
      <span class="vi">@user</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="vi">@followed</span><span class="p">)</span>
      <span class="vi">@relationship</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">relationships</span><span class="o">.</span><span class="n">find_by_followed_id</span><span class="p">(</span><span class="vi">@followed</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should destroy a relationship&quot;</span> <span class="k">do</span>
      <span class="nb">lambda</span> <span class="k">do</span>
        <span class="n">delete</span> <span class="ss">:destroy</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="vi">@relationship</span>
        <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">be_redirect</span>
      <span class="k">end</span><span class="o">.</span><span class="n">should</span> <span class="n">change</span><span class="p">(</span><span class="no">Relationship</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Note here how</p>

<div class="code"><div class="highlight"><pre><span class="ss">:relationship</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:followed_id</span> <span class="o">=&gt;</span> <span class="vi">@followed</span> <span class="p">}</span>
</pre></div>
</div>


<p>simulates the submission of the form with hidden field given by</p>

<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">hidden_field</span> <span class="ss">:followed_id</span> <span class="cp">%&gt;</span>
</pre></div>
</div>


<p>The controller code needed to get these tests to pass is remarkably concise: we just retrieve the user followed or to be followed, and then follow or unfollow the user using the relevant utility method. The full implementation appears in <a class="ref" href="following-users#code:relationships_controller">extrait&nbsp;12.32</a>.</p>

<div class="label" id="code:relationships_controller"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 12.32.</span> <span class="description">The Relationships controller. <br /> <code>app/controllers/relationships_controller.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_2dcd6c6fdcbcc9bb8e38c21d589741a4b21cb282">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=class%20RelationshipsController%20%3C%20ApplicationController%0A%20%20before_filter%20:authenticate%0A%0A%20%20def%20create%0A%20%20%20%20@user%20=%20User.find(params[:relationship][:followed_id])%0A%20%20%20%20current_user.follow!(@user)%0A%20%20%20%20redirect_to%20@user%0A%20%20end%0A%0A%20%20def%20destroy%0A%20%20%20%20@user%20=%20Relationship.find(params[:id]).followed%0A%20%20%20%20current_user.unfollow!(@user)%0A%20%20%20%20redirect_to%20@user%0A%20%20end%0Aend%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=class%20RelationshipsController%20%3C%20ApplicationController%0A%20%20before_filter%20:authenticate%0A%0A%20%20def%20create%0A%20%20%20%20@user%20=%20User.find(params[:relationship][:followed_id])%0A%20%20%20%20current_user.follow!(@user)%0A%20%20%20%20redirect_to%20@user%0A%20%20end%0A%0A%20%20def%20destroy%0A%20%20%20%20@user%20=%20Relationship.find(params[:id]).followed%0A%20%20%20%20current_user.unfollow!(@user)%0A%20%20%20%20redirect_to%20@user%0A%20%20end%0Aend%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">RelationshipsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:authenticate</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:relationship</span><span class="o">][</span><span class="ss">:followed_id</span><span class="o">]</span><span class="p">)</span>
    <span class="n">current_user</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="n">redirect_to</span> <span class="vi">@user</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">Relationship</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">followed</span>
    <span class="n">current_user</span><span class="o">.</span><span class="n">unfollow!</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="n">redirect_to</span> <span class="vi">@user</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>With that, the core follow/unfollow functionality is complete, and any user can follow (or unfollow) any other user.</p>

<div class="label" id="sec:a_working_follow_button_with_ajax"></div>


<h3><a id="sec:12.2.5" href="following-users#sec:a_working_follow_button_with_ajax" class="heading"><span class="number">12.2.5</span> A working follow button with Ajax</a></h3>


<p>Although our user following implementation is complete as it stands, we have one bit of polish left to add before starting work on the status feed. You may have noticed in <a class="ref" href="following-users#sec:a_working_follow_button_the_standard_way">section&nbsp;12.2.4</a> that both the <code>create</code> and <code>destroy</code> actions in the Relationships controller simply redirect <em>back</em> to the original profile. In other words, a user starts on a profile page, follows the user, and is immediately redirected back to the original page. It is reasonable to ask why the user needs to leave that page at all.</p>

<p>This is exactly the problem solved by <em>Ajax</em>, which allows web pages to send requests asynchronously to the server without leaving the page.<sup class="footnote" id="fnref:12.13"><a href="#fn:12.13">13</a></sup> Because the practice of adding Ajax to web forms is quite common, Rails makes Ajax easy to implement. Indeed, updating the follow/unfollow form partials is trivial: just change</p>

<div class="code"><div class="highlight"><pre><span class="n">form_for</span>
</pre></div>
</div>


<p>to</p>

<div class="code"><div class="highlight"><pre><span class="n">form_for</span> <span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="n">,</span> <span class="ss">:remote</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</pre></div>
</div>


<p>and Rails <a href="http://catb.org/jargon/html/A/automagically.html">automagically</a> uses Ajax.<sup class="footnote" id="fnref:12.14"><a href="#fn:12.14">14</a></sup> The updated partials appear in <a class="ref" href="following-users#code:follow_form_ajax">extrait&nbsp;12.33</a> and <a class="ref" href="following-users#code:unfollow_form_ajax">extrait&nbsp;12.34</a>.</p>

<div class="label" id="code:follow_form_ajax"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 12.33.</span> <span class="description">A form for following a user using Ajax. <br /> <code>app/views/users/_follow.html.erb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_a0ddba8dbb1d23a7a7e4a7cd894da91696883bee">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=%3C%25=%20form_for%20current_user.relationships.build(:followed_id%20=%3E%20@user.id),%0A%20%20%20%20%20%20%20%20%20%20%20%20%20:remote%20=%3E%20true%20do%20%7Cf%7C%20%25%3E%0A%20%20%3Cdiv%3E%3C%25=%20f.hidden_field%20:followed_id%20%25%3E%3C/div%3E%0A%20%20%3Cdiv%20class=%22actions%22%3E%3C%25=%20f.submit%20%22Follow%22%20%25%3E%3C/div%3E%0A%3C%25%20end%20%25%3E%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=%3C%25=%20form_for%20current_user.relationships.build(:followed_id%20=%3E%20@user.id),%0A%20%20%20%20%20%20%20%20%20%20%20%20%20:remote%20=%3E%20true%20do%20%7Cf%7C%20%25%3E%0A%20%20%3Cdiv%3E%3C%25=%20f.hidden_field%20:followed_id%20%25%3E%3C/div%3E%0A%20%20%3Cdiv%20class=%22actions%22%3E%3C%25=%20f.submit%20%22Follow%22%20%25%3E%3C/div%3E%0A%3C%25%20end%20%25%3E%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">form_for</span> <span class="n">current_user</span><span class="o">.</span><span class="n">relationships</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="ss">:followed_id</span> <span class="o">=&gt;</span> <span class="vi">@user</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
             <span class="ss">:remote</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div&gt;</span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">hidden_field</span> <span class="ss">:followed_id</span> <span class="cp">%&gt;</span><span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;actions&quot;</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">&quot;Follow&quot;</span> <span class="cp">%&gt;</span><span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>




<div class="label" id="code:unfollow_form_ajax"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 12.34.</span> <span class="description">A form for unfollowing a user using Ajax. <br /> <code>app/views/users/_unfollow.html.erb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_617e62898466f0263dc80f0ff70a9e1d30500f10">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=%3C%25=%20form_for%20current_user.relationships.find_by_followed_id(@user),%0A%20%20%20%20%20%20%20%20%20%20%20%20%20:html%20=%3E%20%7B%20:method%20=%3E%20:delete%20%7D,%0A%20%20%20%20%20%20%20%20%20%20%20%20%20:remote%20=%3E%20true%20do%20%7Cf%7C%20%25%3E%0A%20%20%3Cdiv%20class=%22actions%22%3E%3C%25=%20f.submit%20%22Unfollow%22%20%25%3E%3C/div%3E%0A%3C%25%20end%20%25%3E%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=%3C%25=%20form_for%20current_user.relationships.find_by_followed_id(@user),%0A%20%20%20%20%20%20%20%20%20%20%20%20%20:html%20=%3E%20%7B%20:method%20=%3E%20:delete%20%7D,%0A%20%20%20%20%20%20%20%20%20%20%20%20%20:remote%20=%3E%20true%20do%20%7Cf%7C%20%25%3E%0A%20%20%3Cdiv%20class=%22actions%22%3E%3C%25=%20f.submit%20%22Unfollow%22%20%25%3E%3C/div%3E%0A%3C%25%20end%20%25%3E%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="cp">&lt;%=</span> <span class="n">form_for</span> <span class="n">current_user</span><span class="o">.</span><span class="n">relationships</span><span class="o">.</span><span class="n">find_by_followed_id</span><span class="p">(</span><span class="vi">@user</span><span class="p">),</span>
             <span class="ss">:html</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:method</span> <span class="o">=&gt;</span> <span class="ss">:delete</span> <span class="p">},</span>
             <span class="ss">:remote</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;actions&quot;</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">f</span><span class="o">.</span><span class="n">submit</span> <span class="s2">&quot;Unfollow&quot;</span> <span class="cp">%&gt;</span><span class="nt">&lt;/div&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</pre></div>
</div></div>


<p>The actual HTML generated by this ERb isn&rsquo;t particularly relevant, but you might be curious, so here&rsquo;s a peek:</p>

<div class="code"><div class="highlight"><pre><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">&quot;/relationships/117&quot;</span> <span class="na">class=</span><span class="s">&quot;edit_relationship&quot;</span> <span class="na">data-remote=</span><span class="s">&quot;true&quot;</span>
      <span class="na">id=</span><span class="s">&quot;edit_relationship_117&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>
  .
  .
  .
<span class="nt">&lt;/form&gt;</span>
</pre></div>
</div>


<p>This sets the variable <code>data-remote="true"</code> inside the form tag, which tells Rails to allow the form to be handled by JavaScript. By using a simple HTML property instead of inserting the full JavaScript code (as in previous versions of Rails), Rails&nbsp;3 follows the philosophy of <a href="http://railscasts.com/episodes/205-unobtrusive-javascript"><em>unobtrusive JavaScript</em></a>.</p>

<p>Having updated the form, we now need to arrange for the Relationships controller to respond to Ajax requests. We&rsquo;ll start with a couple simple tests. Testing Ajax is quite tricky, and doing it thoroughly is a large subject in its own right, but we can get started with the code in <a class="ref" href="following-users#code:relationships_controller_spec_ajax">extrait&nbsp;12.35</a>. This uses the <code>xhr</code> method (for &ldquo;XmlHttpRequest&rdquo;) to issue an Ajax request; compare to the <code>get</code>, <code>post</code>, <code>put</code>, and <code>delete</code> methods used in previous tests. We then verify that the <code>create</code> and <code>destroy</code> actions do the correct things when hit with an Ajax request. (To write more thorough test suites for Ajax-heavy applications, take a look at <a href="http://seleniumhq.org/">Selenium</a> and <a href="http://watir.com/">Watir</a>.)</p>

<div class="label" id="code:relationships_controller_spec_ajax"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 12.35.</span> <span class="description">Tests for the Relationships controller responses to Ajax requests. <br /> <code>spec/controllers/relationships_controller_spec.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_96f9a59326e96fb63f8b3dba3bc4f3c3c994cc16">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=describe%20RelationshipsController%20do%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20describe%20%22POST%20'create'%22%20do%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20%20%20it%20%22should%20create%20a%20relationship%20using%20Ajax%22%20do%0A%20%20%20%20%20%20lambda%20do%0A%20%20%20%20%20%20%20%20xhr%20:post,%20:create,%20:relationship%20=%3E%20%7B%20:followed_id%20=%3E%20@followed%20%7D%0A%20%20%20%20%20%20%20%20response.should%20be_success%0A%20%20%20%20%20%20end.should%20change(Relationship,%20:count).by(1)%0A%20%20%20%20end%0A%20%20end%0A%20%20%0A%20%20describe%20%22DELETE%20'destroy'%22%20do%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20%20%20it%20%22should%20destroy%20a%20relationship%20using%20Ajax%22%20do%0A%20%20%20%20%20%20lambda%20do%0A%20%20%20%20%20%20%20%20xhr%20:delete,%20:destroy,%20:id%20=%3E%20@relationship%0A%20%20%20%20%20%20%20%20response.should%20be_success%0A%20%20%20%20%20%20end.should%20change(Relationship,%20:count).by(%2D1)%0A%20%20%20%20end%0A%20%20end%0Aend%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=describe%20RelationshipsController%20do%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20describe%20%22POST%20'create'%22%20do%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20%20%20it%20%22should%20create%20a%20relationship%20using%20Ajax%22%20do%0A%20%20%20%20%20%20lambda%20do%0A%20%20%20%20%20%20%20%20xhr%20:post,%20:create,%20:relationship%20=%3E%20%7B%20:followed_id%20=%3E%20@followed%20%7D%0A%20%20%20%20%20%20%20%20response.should%20be_success%0A%20%20%20%20%20%20end.should%20change(Relationship,%20:count).by(1)%0A%20%20%20%20end%0A%20%20end%0A%20%20%0A%20%20describe%20%22DELETE%20'destroy'%22%20do%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20%20%20it%20%22should%20destroy%20a%20relationship%20using%20Ajax%22%20do%0A%20%20%20%20%20%20lambda%20do%0A%20%20%20%20%20%20%20%20xhr%20:delete,%20:destroy,%20:id%20=%3E%20@relationship%0A%20%20%20%20%20%20%20%20response.should%20be_success%0A%20%20%20%20%20%20end.should%20change(Relationship,%20:count).by(%2D1)%0A%20%20%20%20end%0A%20%20end%0Aend%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="no">RelationshipsController</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;POST &#39;create&#39;&quot;</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">it</span> <span class="s2">&quot;should create a relationship using Ajax&quot;</span> <span class="k">do</span>
      <span class="nb">lambda</span> <span class="k">do</span>
        <span class="n">xhr</span> <span class="ss">:post</span><span class="p">,</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:relationship</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:followed_id</span> <span class="o">=&gt;</span> <span class="vi">@followed</span> <span class="p">}</span>
        <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">be_success</span>
      <span class="k">end</span><span class="o">.</span><span class="n">should</span> <span class="n">change</span><span class="p">(</span><span class="no">Relationship</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s2">&quot;DELETE &#39;destroy&#39;&quot;</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">it</span> <span class="s2">&quot;should destroy a relationship using Ajax&quot;</span> <span class="k">do</span>
      <span class="nb">lambda</span> <span class="k">do</span>
        <span class="n">xhr</span> <span class="ss">:delete</span><span class="p">,</span> <span class="ss">:destroy</span><span class="p">,</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="vi">@relationship</span>
        <span class="n">response</span><span class="o">.</span><span class="n">should</span> <span class="n">be_success</span>
      <span class="k">end</span><span class="o">.</span><span class="n">should</span> <span class="n">change</span><span class="p">(</span><span class="no">Relationship</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>As implied by the tests, the application code uses the same <code>create</code> and <code>delete</code> actions to respond to the Ajax requests that it uses to respond to ordinary <tt>POST</tt> and <tt>DELETE</tt> HTTP requests. All we need to do is respond to a normal HTTP request with a redirect (as in <a class="ref" href="following-users#sec:a_working_follow_button_the_standard_way">section&nbsp;12.2.4</a>) and respond to an Ajax request with JavaScript.<sup class="footnote" id="fnref:12.15"><a href="#fn:12.15">15</a></sup> The controller code appears as in <a class="ref" href="following-users#code:relationships_controller_ajax">extrait&nbsp;12.36</a>. (See <a class="ref" href="following-users#sec:following_exercises">section&nbsp;12.5</a> for an exercise showing an even more compact way to accomplish the same thing.)</p>

<div class="label" id="code:relationships_controller_ajax"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 12.36.</span> <span class="description">Responding to Ajax requests in the Relationships controller. <br /> <code>app/controllers/relationships_controller.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_e3c348380b2c7b15ea0cda655bb665bbce4368d7">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=class%20RelationshipsController%20%3C%20ApplicationController%0A%20%20before_filter%20:authenticate%0A%0A%20%20def%20create%0A%20%20%20%20@user%20=%20User.find(params[:relationship][:followed_id])%0A%20%20%20%20current_user.follow!(@user)%0A%20%20%20%20respond_to%20do%20%7Cformat%7C%0A%20%20%20%20%20%20format.html%20%7B%20redirect_to%20@user%20%7D%0A%20%20%20%20%20%20format.js%0A%20%20%20%20end%0A%20%20end%0A%0A%20%20def%20destroy%0A%20%20%20%20@user%20=%20Relationship.find(params[:id]).followed%0A%20%20%20%20current_user.unfollow!(@user)%0A%20%20%20%20respond_to%20do%20%7Cformat%7C%0A%20%20%20%20%20%20format.html%20%7B%20redirect_to%20@user%20%7D%0A%20%20%20%20%20%20format.js%0A%20%20%20%20end%0A%20%20end%0Aend%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=class%20RelationshipsController%20%3C%20ApplicationController%0A%20%20before_filter%20:authenticate%0A%0A%20%20def%20create%0A%20%20%20%20@user%20=%20User.find(params[:relationship][:followed_id])%0A%20%20%20%20current_user.follow!(@user)%0A%20%20%20%20respond_to%20do%20%7Cformat%7C%0A%20%20%20%20%20%20format.html%20%7B%20redirect_to%20@user%20%7D%0A%20%20%20%20%20%20format.js%0A%20%20%20%20end%0A%20%20end%0A%0A%20%20def%20destroy%0A%20%20%20%20@user%20=%20Relationship.find(params[:id]).followed%0A%20%20%20%20current_user.unfollow!(@user)%0A%20%20%20%20respond_to%20do%20%7Cformat%7C%0A%20%20%20%20%20%20format.html%20%7B%20redirect_to%20@user%20%7D%0A%20%20%20%20%20%20format.js%0A%20%20%20%20end%0A%20%20end%0Aend%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">RelationshipsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:authenticate</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:relationship</span><span class="o">][</span><span class="ss">:followed_id</span><span class="o">]</span><span class="p">)</span>
    <span class="n">current_user</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
      <span class="nb">format</span><span class="o">.</span><span class="n">html</span> <span class="p">{</span> <span class="n">redirect_to</span> <span class="vi">@user</span> <span class="p">}</span>
      <span class="nb">format</span><span class="o">.</span><span class="n">js</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">Relationship</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">followed</span>
    <span class="n">current_user</span><span class="o">.</span><span class="n">unfollow!</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
      <span class="nb">format</span><span class="o">.</span><span class="n">html</span> <span class="p">{</span> <span class="n">redirect_to</span> <span class="vi">@user</span> <span class="p">}</span>
      <span class="nb">format</span><span class="o">.</span><span class="n">js</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>This code uses <code>respond_to</code> to take the appropriate action depending on the kind of request.<sup class="footnote" id="fnref:12.16"><a href="#fn:12.16">16</a></sup> The syntax is potentially confusing, and it&rsquo;s important to understand that in</p>

<div class="code"><div class="highlight"><pre><span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
  <span class="nb">format</span><span class="o">.</span><span class="n">html</span> <span class="p">{</span> <span class="n">redirect_to</span> <span class="vi">@user</span> <span class="p">}</span>
  <span class="nb">format</span><span class="o">.</span><span class="n">js</span>
<span class="k">end</span>
</pre></div>
</div>


<p>only <em>one</em> of the lines gets executed (based on the nature of the request).</p>

<p>In the case of an Ajax request, Rails automatically calls a <em>JavaScript Embedded Ruby</em> (<code>.js.erb</code>) file with the same name as the action, i.e., <code>create.js.erb</code> or <code>destroy.js.erb</code>. As you might guess, the files allow us to mix JavaScript and Embedded Ruby to perform actions on the current page. It is these files that we need to create and edit in order to update the user profile page upon being followed or unfollowed.</p>

<p>Inside a JS-ERb file, Rails automatically provides the Prototype JavaScript helpers to manipulate the page using the <a href="http://www.w3.org/DOM/">Document Object Model (DOM)</a>. Prototype provides a large number of methods for manipulating the DOM, but here we will need only two. First, we will need to know about the Prototype dollar-sign syntax to access a DOM element based in its unique CSS&nbsp;id. For example, to manipulate the <code>follow_form</code> element, we will use the syntax</p>

<div class="code"><div class="highlight"><pre><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;follow_form&quot;</span><span class="p">)</span>
</pre></div>
</div>


<p>(Recall from <a class="ref" href="following-users#code:follow_form_partial">extrait&nbsp;12.23</a> that this is a <code>div</code> that wraps the form, not the form itself.) The second method we&rsquo;ll need is <code>update</code>, which updates the HTML inside the relevant element with the contents of its argument. For example, to replace the entire follow form with the string <code>"foobar"</code>, we would write</p>

<div class="code"><div class="highlight"><pre><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;follow_form&quot;</span><span class="p">).</span><span class="nx">update</span><span class="p">(</span><span class="s2">&quot;foobar&quot;</span><span class="p">)</span>
</pre></div>
</div>


<p>Unlike plain JavaScript files, JS-ERb files also allow the use of Embedded Ruby, which we apply in the <code>create.js.erb</code> file to update the follow form with the <code>unfollow</code> partial (which is what should show after a successful following) and update the follower count. The result is shown in <a class="ref" href="following-users#code:create_js_erb">extrait&nbsp;12.37</a>.</p>

<div class="label" id="code:create_js_erb"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 12.37.</span> <span class="description">The JavaScript Embedded Ruby to create a following relationship. <br /> <code>app/views/relationships/create.js.erb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_662cd766d507f9e9031ba8afa0923b50b5668b9f">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=$(%22follow_form%22).update(%22%3C%25=%20escape_javascript(render('users/unfollow'))%20%25%3E%22)%0A$(%22followers%22).update('%3C%25=%20%22%23%7B@user.followers.count%7D%20followers%22%20%25%3E')%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=$(%22follow_form%22).update(%22%3C%25=%20escape_javascript(render('users/unfollow'))%20%25%3E%22)%0A$(%22followers%22).update('%3C%25=%20%22%23%7B@user.followers.count%7D%20followers%22%20%25%3E')%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;follow_form&quot;</span><span class="p">).</span><span class="nx">update</span><span class="p">(</span><span class="s2">&quot;&lt;%= escape_javascript(render(&#39;users/unfollow&#39;)) %&gt;&quot;</span><span class="p">)</span>
<span class="nx">$</span><span class="p">(</span><span class="s2">&quot;followers&quot;</span><span class="p">).</span><span class="nx">update</span><span class="p">(</span><span class="s1">&#39;&lt;%= &quot;#{@user.followers.count} followers&quot; %&gt;&#39;</span><span class="p">)</span>
</pre></div>
</div></div>


<p>The <code>destroy.js.erb</code> file is analogous (<a class="ref" href="following-users#code:destroy_js_erb">extrait&nbsp;12.38</a>). Note that, as in <a class="ref" href="following-users#code:create_js_erb">extrait&nbsp;12.37</a>, we must use the <code>escape_javascript</code> to escape out the result when inserting HTML.</p>

<div class="label" id="code:destroy_js_erb"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 12.38.</span> <span class="description">The Ruby JavaScript (RJS) to destroy a following relationship. <br /> <code>app/views/relationships/destroy.js.erb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_7536cc1afeb987659f52621aa1bf6d6c7ad08e68">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=$(%22follow_form%22).update(%22%3C%25=%20escape_javascript(render('users/follow'))%20%25%3E%22)%0A$(%22followers%22).update('%3C%25=%20%22%23%7B@user.followers.count%7D%20followers%22%20%25%3E')%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=$(%22follow_form%22).update(%22%3C%25=%20escape_javascript(render('users/follow'))%20%25%3E%22)%0A$(%22followers%22).update('%3C%25=%20%22%23%7B@user.followers.count%7D%20followers%22%20%25%3E')%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;follow_form&quot;</span><span class="p">).</span><span class="nx">update</span><span class="p">(</span><span class="s2">&quot;&lt;%= escape_javascript(render(&#39;users/follow&#39;)) %&gt;&quot;</span><span class="p">)</span>
<span class="nx">$</span><span class="p">(</span><span class="s2">&quot;followers&quot;</span><span class="p">).</span><span class="nx">update</span><span class="p">(</span><span class="s1">&#39;&lt;%= &quot;#{@user.followers.count} followers&quot; %&gt;&#39;</span><span class="p">)</span>
</pre></div>
</div></div>


<p>With that, you should navigate to a user profile page and verify that you can follow and unfollow without a page refresh.</p>

<p>Using Ajax in Rails is a large and fast-moving subject, so we&rsquo;ve only been able to scratch the surface here, but (as with the rest of the material in this tutorial) our treatment gives you a good foundation for more advanced resources. It&rsquo;s especially worth noting that, in addition to Prototype, the JavaScript framework <a href="http://jquery.com/">jQuery</a> has gotten a lot of traction in the Rails community. Implementing the Ajax functions from this section using jQuery is left as an exercise; see <a class="ref" href="following-users#sec:following_exercises">section&nbsp;12.5</a>.</p>

<div class="label" id="sec:the_status_feed"></div>


<h2><a id="sec:12.3" href="following-users#sec:the_status_feed" class="heading"><span class="number">12.3</span> The status feed</a></h2>


<p>We come now to the pinnacle of our sample application: the status feed. Appropriately, this section contains some of the most advanced material in the entire tutorial. Making the status feed involves assembling an array of the microposts from the users being followed by the current user, along with the current user&rsquo;s own microposts. To accomplish this feat, we will need some fairly advanced Rails, Ruby, and even SQL programming techniques.</p>

<p>Because of the heavy lifting ahead, it&rsquo;s especially important to have a sense of where we&rsquo;re going. A mockup of the final user status feed, which builds on the proto-feed from <a class="ref" href="user-microposts#sec:a_proto_feed">section&nbsp;11.3.3</a>, appears in <a class="ref" href="following-users#fig:home_page_feed_mockup">illustration&nbsp;12.18</a>.</p>

<div class="label" id="fig:home_page_feed_mockup"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/home_page_feed_mockup.png" alt="home_page_feed_mockup" /></span></div><div class="caption"><span class="header">Illustration 12.18: </span><span class="description">A mockup of a user&rsquo;s Home page with a status feed.&nbsp;<a href="http://railstutorial.org/images/figures/home_page_feed_mockup-full.png">(taille normale)</a></span></div></div>




<div class="label" id="sec:motivation_and_strategy"></div>


<h3><a id="sec:12.3.1" href="following-users#sec:motivation_and_strategy" class="heading"><span class="number">12.3.1</span> Motivation and strategy</a></h3>


<p>The basic idea behind the feed is simple. <a class="ref" href="following-users#fig:user_feed">illustration&nbsp;12.19</a> shows a sample <code>microposts</code> database table and the resulting feed. The purpose of a feed is to pull out the microposts whose user ids correspond to the users being followed by the current user (and the current user itself), as indicated by the arrows in the diagram.</p>

<div class="label" id="fig:user_feed"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/user_feed.png" alt="user_feed" /></span></div><div class="caption"><span class="header">Illustration 12.19: </span><span class="description">The feed for a user (id 1) following users 2, 7, 8, and 10.</span></div></div>


<p>Since we need a way to find all the microposts from users followed by a given user, we&rsquo;ll plan on implementing a method called <code>from_users_followed_by</code>, which we will use as follows:</p>

<div class="code"><div class="highlight"><pre><span class="no">Micropost</span><span class="o">.</span><span class="n">from_users_followed_by</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</pre></div>
</div>


<p>Although we don&rsquo;t yet know how to implement it, we can already write tests for <code>from_users_followed_by</code>, as seen in <a class="ref" href="following-users#code:from_users_followed_by_tests">extrait&nbsp;12.39</a>.</p>

<div class="label" id="code:from_users_followed_by_tests"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 12.39.</span> <span class="description">Tests for <code>Micropost.from_users_followed_by</code>. <br /> <code>spec/models/micropost_spec.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_db9b2649f901e7e13ae0112defbe74ddcdc99abf">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=describe%20Micropost%20do%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20describe%20%22from_users_followed_by%22%20do%0A%0A%20%20%20%20before(:each)%20do%0A%20%20%20%20%20%20@other_user%20=%20Factory(:user,%20:email%20=%3E%20Factory.next(:email))%0A%20%20%20%20%20%20@third_user%20=%20Factory(:user,%20:email%20=%3E%20Factory.next(:email))%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20@user_post%20%20=%20@user.microposts.create!(:content%20=%3E%20%22foo%22)%0A%20%20%20%20%20%20@other_post%20=%20@other_user.microposts.create!(:content%20=%3E%20%22bar%22)%0A%20%20%20%20%20%20@third_post%20=%20@third_user.microposts.create!(:content%20=%3E%20%22baz%22)%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20@user.follow!(@other_user)%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20it%20%22should%20have%20a%20from_users_followed_by%20class%20method%22%20do%0A%20%20%20%20%20%20Micropost.should%20respond_to(:from_users_followed_by)%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20it%20%22should%20include%20the%20followed%20user's%20microposts%22%20do%0A%20%20%20%20%20%20Micropost.from_users_followed_by(@user).should%20include(@other_post)%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20it%20%22should%20include%20the%20user's%20own%20microposts%22%20do%0A%20%20%20%20%20%20Micropost.from_users_followed_by(@user).should%20include(@user_post)%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20it%20%22should%20not%20include%20an%20unfollowed%20user's%20microposts%22%20do%0A%20%20%20%20%20%20Micropost.from_users_followed_by(@user).should_not%20include(@third_post)%0A%20%20%20%20end%0A%20%20end%0Aend%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=describe%20Micropost%20do%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20describe%20%22from_users_followed_by%22%20do%0A%0A%20%20%20%20before(:each)%20do%0A%20%20%20%20%20%20@other_user%20=%20Factory(:user,%20:email%20=%3E%20Factory.next(:email))%0A%20%20%20%20%20%20@third_user%20=%20Factory(:user,%20:email%20=%3E%20Factory.next(:email))%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20@user_post%20%20=%20@user.microposts.create!(:content%20=%3E%20%22foo%22)%0A%20%20%20%20%20%20@other_post%20=%20@other_user.microposts.create!(:content%20=%3E%20%22bar%22)%0A%20%20%20%20%20%20@third_post%20=%20@third_user.microposts.create!(:content%20=%3E%20%22baz%22)%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20@user.follow!(@other_user)%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20it%20%22should%20have%20a%20from_users_followed_by%20class%20method%22%20do%0A%20%20%20%20%20%20Micropost.should%20respond_to(:from_users_followed_by)%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20it%20%22should%20include%20the%20followed%20user's%20microposts%22%20do%0A%20%20%20%20%20%20Micropost.from_users_followed_by(@user).should%20include(@other_post)%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20it%20%22should%20include%20the%20user's%20own%20microposts%22%20do%0A%20%20%20%20%20%20Micropost.from_users_followed_by(@user).should%20include(@user_post)%0A%20%20%20%20end%0A%20%20%20%20%0A%20%20%20%20it%20%22should%20not%20include%20an%20unfollowed%20user's%20microposts%22%20do%0A%20%20%20%20%20%20Micropost.from_users_followed_by(@user).should_not%20include(@third_post)%0A%20%20%20%20end%0A%20%20end%0Aend%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="no">Micropost</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;from_users_followed_by&quot;</span> <span class="k">do</span>

    <span class="n">before</span><span class="p">(</span><span class="ss">:each</span><span class="p">)</span> <span class="k">do</span>
      <span class="vi">@other_user</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:user</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="no">Factory</span><span class="o">.</span><span class="n">next</span><span class="p">(</span><span class="ss">:email</span><span class="p">))</span>
      <span class="vi">@third_user</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:user</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="no">Factory</span><span class="o">.</span><span class="n">next</span><span class="p">(</span><span class="ss">:email</span><span class="p">))</span>

      <span class="vi">@user_post</span>  <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">:content</span> <span class="o">=&gt;</span> <span class="s2">&quot;foo&quot;</span><span class="p">)</span>
      <span class="vi">@other_post</span> <span class="o">=</span> <span class="vi">@other_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">:content</span> <span class="o">=&gt;</span> <span class="s2">&quot;bar&quot;</span><span class="p">)</span>
      <span class="vi">@third_post</span> <span class="o">=</span> <span class="vi">@third_user</span><span class="o">.</span><span class="n">microposts</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">:content</span> <span class="o">=&gt;</span> <span class="s2">&quot;baz&quot;</span><span class="p">)</span>

      <span class="vi">@user</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="vi">@other_user</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should have a from_users_followed_by class method&quot;</span> <span class="k">do</span>
      <span class="no">Micropost</span><span class="o">.</span><span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:from_users_followed_by</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should include the followed user&#39;s microposts&quot;</span> <span class="k">do</span>
      <span class="no">Micropost</span><span class="o">.</span><span class="n">from_users_followed_by</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="kp">include</span><span class="p">(</span><span class="vi">@other_post</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should include the user&#39;s own microposts&quot;</span> <span class="k">do</span>
      <span class="no">Micropost</span><span class="o">.</span><span class="n">from_users_followed_by</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span><span class="o">.</span><span class="n">should</span> <span class="kp">include</span><span class="p">(</span><span class="vi">@user_post</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">it</span> <span class="s2">&quot;should not include an unfollowed user&#39;s microposts&quot;</span> <span class="k">do</span>
      <span class="no">Micropost</span><span class="o">.</span><span class="n">from_users_followed_by</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span><span class="o">.</span><span class="n">should_not</span> <span class="kp">include</span><span class="p">(</span><span class="vi">@third_post</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>The key here is building the associations in the <code>before(:each)</code> block and then checking all three requirements: microposts for followed users and the user itself are included, but a post from an <em>unfollowed</em> user is not.</p>

<p>The feed itself lives in the User model (<a class="ref" href="user-microposts#sec:a_proto_feed">section&nbsp;11.3.3</a>), so we should add an additional test to the User model specs from <a class="ref" href="user-microposts#code:feed_specs">extrait&nbsp;11.31</a>, as shown in <a class="ref" href="following-users#code:full_feed_specs">extrait&nbsp;12.40</a>. (Note that we&rsquo;ve switched here from using <code>include?</code>, as seen in <a class="ref" href="user-microposts#code:feed_specs">extrait&nbsp;11.31</a>, to the more compact <code>include</code> convention introduced in <a class="ref" href="following-users#code:utility_method_tests">extrait&nbsp;12.12</a>.)</p>

<div class="label" id="code:full_feed_specs"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 12.40.</span> <span class="description">The final tests for the status feed. <br /> <code>spec/models/user_spec.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_4902cf250e368a25fce3fb295558e30356946842">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=describe%20User%20do%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20describe%20%22micropost%20associations%22%20do%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20%20%20describe%20%22status%20feed%22%20do%0A%0A%20%20%20%20%20%20it%20%22should%20have%20a%20feed%22%20do%0A%20%20%20%20%20%20%20%20@user.should%20respond_to(:feed)%0A%20%20%20%20%20%20end%0A%0A%20%20%20%20%20%20it%20%22should%20include%20the%20user's%20microposts%22%20do%0A%20%20%20%20%20%20%20%20@user.feed.should%20include(@mp1)%0A%20%20%20%20%20%20%20%20@user.feed.should%20include(@mp2)%0A%20%20%20%20%20%20end%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20it%20%22should%20not%20include%20a%20different%20user's%20microposts%22%20do%0A%20%20%20%20%20%20%20%20mp3%20=%20Factory(:micropost,%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:user%20=%3E%20Factory(:user,%20:email%20=%3E%20Factory.next(:email)))%0A%20%20%20%20%20%20%20%20@user.feed.should_not%20include(mp3)%0A%20%20%20%20%20%20end%0A%0A%20%20%20%20%20%20it%20%22should%20include%20the%20microposts%20of%20followed%20users%22%20do%0A%20%20%20%20%20%20%20%20followed%20=%20Factory(:user,%20:email%20=%3E%20Factory.next(:email))%0A%20%20%20%20%20%20%20%20mp3%20=%20Factory(:micropost,%20:user%20=%3E%20followed)%0A%20%20%20%20%20%20%20%20@user.follow!(followed)%0A%20%20%20%20%20%20%20%20@user.feed.should%20include(mp3)%0A%20%20%20%20%20%20end%0A%20%20%20%20end%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20end%0Aend%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=describe%20User%20do%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20describe%20%22micropost%20associations%22%20do%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20%20%20describe%20%22status%20feed%22%20do%0A%0A%20%20%20%20%20%20it%20%22should%20have%20a%20feed%22%20do%0A%20%20%20%20%20%20%20%20@user.should%20respond_to(:feed)%0A%20%20%20%20%20%20end%0A%0A%20%20%20%20%20%20it%20%22should%20include%20the%20user's%20microposts%22%20do%0A%20%20%20%20%20%20%20%20@user.feed.should%20include(@mp1)%0A%20%20%20%20%20%20%20%20@user.feed.should%20include(@mp2)%0A%20%20%20%20%20%20end%0A%20%20%20%20%20%20%0A%20%20%20%20%20%20it%20%22should%20not%20include%20a%20different%20user's%20microposts%22%20do%0A%20%20%20%20%20%20%20%20mp3%20=%20Factory(:micropost,%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20:user%20=%3E%20Factory(:user,%20:email%20=%3E%20Factory.next(:email)))%0A%20%20%20%20%20%20%20%20@user.feed.should_not%20include(mp3)%0A%20%20%20%20%20%20end%0A%0A%20%20%20%20%20%20it%20%22should%20include%20the%20microposts%20of%20followed%20users%22%20do%0A%20%20%20%20%20%20%20%20followed%20=%20Factory(:user,%20:email%20=%3E%20Factory.next(:email))%0A%20%20%20%20%20%20%20%20mp3%20=%20Factory(:micropost,%20:user%20=%3E%20followed)%0A%20%20%20%20%20%20%20%20@user.follow!(followed)%0A%20%20%20%20%20%20%20%20@user.feed.should%20include(mp3)%0A%20%20%20%20%20%20end%0A%20%20%20%20end%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20%20%20.%0A%20%20end%0Aend%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="n">describe</span> <span class="no">User</span> <span class="k">do</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">describe</span> <span class="s2">&quot;micropost associations&quot;</span> <span class="k">do</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="n">describe</span> <span class="s2">&quot;status feed&quot;</span> <span class="k">do</span>

      <span class="n">it</span> <span class="s2">&quot;should have a feed&quot;</span> <span class="k">do</span>
        <span class="vi">@user</span><span class="o">.</span><span class="n">should</span> <span class="n">respond_to</span><span class="p">(</span><span class="ss">:feed</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should include the user&#39;s microposts&quot;</span> <span class="k">do</span>
        <span class="vi">@user</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">should</span> <span class="kp">include</span><span class="p">(</span><span class="vi">@mp1</span><span class="p">)</span>
        <span class="vi">@user</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">should</span> <span class="kp">include</span><span class="p">(</span><span class="vi">@mp2</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should not include a different user&#39;s microposts&quot;</span> <span class="k">do</span>
        <span class="n">mp3</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span>
                      <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:user</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="no">Factory</span><span class="o">.</span><span class="n">next</span><span class="p">(</span><span class="ss">:email</span><span class="p">)))</span>
        <span class="vi">@user</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">should_not</span> <span class="kp">include</span><span class="p">(</span><span class="n">mp3</span><span class="p">)</span>
      <span class="k">end</span>

      <span class="n">it</span> <span class="s2">&quot;should include the microposts of followed users&quot;</span> <span class="k">do</span>
        <span class="n">followed</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:user</span><span class="p">,</span> <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="no">Factory</span><span class="o">.</span><span class="n">next</span><span class="p">(</span><span class="ss">:email</span><span class="p">))</span>
        <span class="n">mp3</span> <span class="o">=</span> <span class="no">Factory</span><span class="p">(</span><span class="ss">:micropost</span><span class="p">,</span> <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="n">followed</span><span class="p">)</span>
        <span class="vi">@user</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="n">followed</span><span class="p">)</span>
        <span class="vi">@user</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">should</span> <span class="kp">include</span><span class="p">(</span><span class="n">mp3</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="o">.</span>
    <span class="o">.</span>
    <span class="o">.</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Implementing the feed will be easy; we will simply defer to <code>Micropost.from_users_followed_by</code>, as shown in <a class="ref" href="following-users#code:user_feed">extrait&nbsp;12.41</a>.</p>

<div class="label" id="code:user_feed"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 12.41.</span> <span class="description">Adding the completed feed to the User model. <br /> <code>app/models/user.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_27b878ebbe0e68452b4cae653d997ce22ef5ef46">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=class%20User%20%3C%20ActiveRecord::Base%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20def%20feed%0A%20%20%20%20Micropost.from_users_followed_by(self)%0A%20%20end%0A%20%20.%0A%20%20.%0A%20%20.%0Aend%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=class%20User%20%3C%20ActiveRecord::Base%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20def%20feed%0A%20%20%20%20Micropost.from_users_followed_by(self)%0A%20%20end%0A%20%20.%0A%20%20.%0A%20%20.%0Aend%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">feed</span>
    <span class="no">Micropost</span><span class="o">.</span><span class="n">from_users_followed_by</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="sec:a_first_feed_implementation"></div>


<h3><a id="sec:12.3.2" href="following-users#sec:a_first_feed_implementation" class="heading"><span class="number">12.3.2</span> A first feed implementation</a></h3>


<p>Now it&rsquo;s time to implement <code>Micropost.from_users_followed_by</code>, which for simplicity we&rsquo;ll just refer to as &ldquo;the feed&rdquo;. Since the final result is rather intricate, we&rsquo;ll build up to the final feed implementation by introducing one piece at a time.</p>

<p>The first step is to think of the kind of query we&rsquo;ll need. What we want to do is select from the <code>microposts</code> table all the microposts with ids corresponding to the users being followed by a given user (or the user itself). We might write this schematically as follows:</p>

<div class="code"><div class="highlight"><pre><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">microposts</span>
<span class="k">WHERE</span> <span class="n">user_id</span> <span class="k">IN</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">list</span> <span class="k">of</span> <span class="n">ids</span><span class="o">&gt;</span><span class="p">)</span> <span class="k">OR</span> <span class="n">user_id</span> <span class="o">=</span> <span class="o">&lt;</span><span class="k">user</span> <span class="n">id</span><span class="o">&gt;</span>
</pre></div>
</div>


<p>In writing this code, we&rsquo;ve guessed that SQL supports an <code>IN</code> keyword that allows us to test for set inclusion. (Happily, it does.)</p>

<p>Recall from the proto-feed in <a class="ref" href="user-microposts#sec:a_proto_feed">section&nbsp;11.3.3</a> that Active Record uses the <code>where</code> method to accomplish the kind of select shown above, as illustrated in <a class="ref" href="user-microposts#code:proto_status_feed">extrait&nbsp;11.32</a>. There, our select was very simple; we just picked out all the microposts with user id corresponding to the current user:</p>

<div class="code"><div class="highlight"><pre><span class="no">Micropost</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;user_id = ?&quot;</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
</pre></div>
</div>


<p>Here, we expect it to be more complicated, something like</p>

<div class="code"><div class="highlight"><pre><span class="n">where</span><span class="p">(</span><span class="s2">&quot;user_id in (</span><span class="si">#{</span><span class="n">followed_ids</span><span class="si">}</span><span class="s2">) OR user_id = ?&quot;</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
</pre></div>
</div>


<p>(Here we&rsquo;ve used the Rails convention of <code>user</code> instead of <code>user.id</code> in the condition; Rails automatically uses the&nbsp;<code>id</code>. We&rsquo;ve also omitted the leading <code>Micropost.</code> since we expect this method to live in the Micropost model itself.)</p>

<p>We see from these conditions that we&rsquo;ll need an array of ids that a given user is following (or something equivalent). One way to do this is to use Ruby&rsquo;s <code>map</code> method, available on any &ldquo;enumerable&rdquo; object, i.e., any object (such as an Array or a Hash) that consists of a collection of elements.<sup class="footnote" id="fnref:12.17"><a href="#fn:12.17">17</a></sup> We saw an example of this method in <a class="ref" href="rails-flavored-ruby#sec:blocks">section&nbsp;4.3.2</a>; it works like this:</p>

<div class="code"><div class="highlight"><pre><span class="go">$ rails console</span>
<span class="gp">&gt;&gt; </span><span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="o">].</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span> <span class="n">i</span><span class="o">.</span><span class="n">to_s</span> <span class="p">}</span>
<span class="go">=&gt; [&quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;]</span>
</pre></div>
</div>


<p>Situations like the one illustrated above, where the same method (e.g., <code>to_s</code>) gets called on each element, are common enough that there&rsquo;s a shorthand notation using an <em>ampersand</em>&nbsp;<code>&amp;</code> and a symbol corresponding to the method:<sup class="footnote" id="fnref:12.18"><a href="#fn:12.18">18</a></sup></p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="o">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="o">].</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:to_s</span><span class="p">)</span>
<span class="go">=&gt; [&quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;]</span>
</pre></div>
</div>


<p>We can use this notation to construct the necessary array of followed user ids by calling&nbsp;<code>id</code> on each element in <code>user.following</code>. For example, for the first user in the database this array appears as follows:</p>

<div class="code"><div class="highlight"><pre><span class="gp">&gt;&gt; </span><span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">following</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:id</span><span class="p">)</span>
<span class="go">=&gt; [4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23,</span>
<span class="go">24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42,</span>
<span class="go">43, 44, 45, 46, 47, 48, 49, 50, 51]</span>
</pre></div>
</div>


<p>At this point, you might guess that code like</p>

<div class="code"><div class="highlight"><pre><span class="no">Micropost</span><span class="o">.</span><span class="n">from_users_followed_by</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</pre></div>
</div>


<p>will involve a class method in the <code>Micropost</code> class (a construction last seen in the <code>User</code> class in <a class="ref" href="modeling-and-viewing-users-two#code:authenticate_method">section&nbsp;7.12</a>). A proposed implementation along these lines appears in <a class="ref" href="following-users#code:from_users_followed_by_first_cut">extrait&nbsp;12.42</a>.</p>

<div class="label" id="code:from_users_followed_by_first_cut"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 12.42.</span> <span class="description">A first cut at the <code>from_users_followed_by</code> method. <br /> <code>app/models/micropost.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_12ea71737a3f09edb7dd3877b22aed693d06aef8">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=class%20Micropost%20%3C%20ActiveRecord::Base%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20def%20self.from_users_followed_by(user)%0A%20%20%20%20followed_ids%20=%20user.following.map(%26:id).join(%22,%20%22)%0A%20%20%20%20where(%22user_id%20IN%20(%23%7Bfollowed_ids%7D)%20OR%20user_id%20=%20?%22,%20user)%0A%20%20end%0Aend%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=class%20Micropost%20%3C%20ActiveRecord::Base%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20def%20self.from_users_followed_by(user)%0A%20%20%20%20followed_ids%20=%20user.following.map(%26:id).join(%22,%20%22)%0A%20%20%20%20where(%22user_id%20IN%20(%23%7Bfollowed_ids%7D)%20OR%20user_id%20=%20?%22,%20user)%0A%20%20end%0Aend%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">from_users_followed_by</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="n">followed_ids</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">following</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:id</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">)</span>
    <span class="n">where</span><span class="p">(</span><span class="s2">&quot;user_id IN (</span><span class="si">#{</span><span class="n">followed_ids</span><span class="si">}</span><span class="s2">) OR user_id = ?&quot;</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Although the discussion leading up to <a class="ref" href="following-users#code:from_users_followed_by_first_cut">extrait&nbsp;12.42</a> was couched in hypothetical terms, it actually works! In fact, it might be good enough for most practical purposes. But it&rsquo;s not the final implementation; see if you can make a guess about why not before moving on to the next section. (<em>Hint:</em> What if a user is following 5000 other users?)</p>

<div class="label" id="sec:scopes_subselects_and_a_lambda"></div>


<h3><a id="sec:12.3.3" href="following-users#sec:scopes_subselects_and_a_lambda" class="heading"><span class="number">12.3.3</span> Scopes, subselects, and a lambda</a></h3>


<p>As hinted at in the last section, the feed implementation in <a class="ref" href="following-users#sec:a_first_feed_implementation">section&nbsp;12.3.2</a> doesn&rsquo;t scale well when the number of microposts in the feed is large, as would likely happen if a user were following, say, 5000 other users. In this section, we&rsquo;ll reimplement the status feed in a way that scales better with the number of followed users.</p>

<p>There are a couple of problems with the code in <a class="ref" href="following-users#sec:a_first_feed_implementation">section&nbsp;12.3.2</a>. First, the expression</p>

<div class="code"><div class="highlight"><pre><span class="n">followed_ids</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">following</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:id</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">)</span>
</pre></div>
</div>


<p>pulls <em>all</em> the followed users into memory, and creates an array the full length of the following list. Since the condition in <a class="ref" href="following-users#code:from_users_followed_by_first_cut">extrait&nbsp;12.42</a> actually just checks inclusion in a set, there must be a more efficient way to do this, and indeed SQL is optimized for just such set operations. Second, the method in <a class="ref" href="following-users#code:from_users_followed_by_first_cut">extrait&nbsp;12.42</a> always pulls out <em>all</em> the microposts and sticks them into a Ruby array. Although these microposts are paginated in the view (<a class="ref" href="user-microposts#code:feed_instance_variable">extrait&nbsp;11.33</a>), the array is still full-sized.<sup class="footnote" id="fnref:12.19"><a href="#fn:12.19">19</a></sup> What we really want is honest pagination that only pulls out 30 elements at a time.</p>

<p>The solution to both problems involves converting the feed from a class method to a <em>scope</em>, which is a Rails method for restricting database selects based on certain conditions. For example, to arrange for a method to select all the administrative users in our application, we could add a scope to the User model as follows:</p>

<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">scope</span> <span class="ss">:admin</span><span class="p">,</span> <span class="n">where</span><span class="p">(</span><span class="ss">:admin</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div>


<p>As a result of this scope, the code</p>

<div class="code"><div class="highlight"><pre><span class="no">User</span><span class="o">.</span><span class="n">admin</span>
</pre></div>
</div>


<p>would return an array of all the site admins.</p>

<p>The main reason scopes are better than plain class methods is that they can be <em>chained</em> with other methods, so that, for example,</p>

<div class="code"><div class="highlight"><pre><span class="no">User</span><span class="o">.</span><span class="n">admin</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">:page</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>


<p>actually paginates the admins in the database; if (for some odd reason) the site has 100 administrators, the code above will still only pull out the first 30.</p>

<p>The scope for the feed is a bit more complex than the one illustrated above: it needs an <em>argument</em>, namely, the user whose feed we need to generate. We can do this with an <em>anonymous function</em>, or <code>lambda</code> (discussed in <a class="ref" href="sign-up#sec:failed_signup">section&nbsp;8.4.2</a>), as shown in <a class="ref" href="following-users#code:from_users_followed_by_second_cut">extrait&nbsp;12.43</a>.<sup class="footnote" id="fnref:12.20"><a href="#fn:12.20">20</a></sup></p>

<div class="label" id="code:from_users_followed_by_second_cut"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 12.43.</span> <span class="description">Improving <code>from_users_followed_by</code>. <br /> <code>app/models/micropost.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_c12245c6ec61b8f306cd65d3373a9673b7c6a8f2">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=class%20Micropost%20%3C%20ActiveRecord::Base%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20default_scope%20:order%20=%3E%20'microposts.created_at%20DESC'%0A%0A%20%20%23%20Return%20microposts%20from%20the%20users%20being%20followed%20by%20the%20given%20user.%0A%20%20scope%20:from_users_followed_by,%20lambda%20%7B%20%7Cuser%7C%20followed_by(user)%20%7D%0A%0A%20%20private%0A%0A%20%20%20%20%23%20Return%20an%20SQL%20condition%20for%20users%20followed%20by%20the%20given%20user.%0A%20%20%20%20%23%20We%20include%20the%20user's%20own%20id%20as%20well.%0A%20%20%20%20def%20self.followed_by(user)%0A%20%20%20%20%20%20followed_ids%20=%20user.following.map(%26:id).join(%22,%20%22)%0A%20%20%20%20%20%20where(%22user_id%20IN%20(%23%7Bfollowed_ids%7D)%20OR%20user_id%20=%20:user_id%22,%0A%20%20%20%20%20%20%20%20%20%20%20%20%7B%20:user_id%20=%3E%20user%20%7D)%0A%20%20%20%20end%0Aend%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=class%20Micropost%20%3C%20ActiveRecord::Base%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20default_scope%20:order%20=%3E%20'microposts.created_at%20DESC'%0A%0A%20%20%23%20Return%20microposts%20from%20the%20users%20being%20followed%20by%20the%20given%20user.%0A%20%20scope%20:from_users_followed_by,%20lambda%20%7B%20%7Cuser%7C%20followed_by(user)%20%7D%0A%0A%20%20private%0A%0A%20%20%20%20%23%20Return%20an%20SQL%20condition%20for%20users%20followed%20by%20the%20given%20user.%0A%20%20%20%20%23%20We%20include%20the%20user's%20own%20id%20as%20well.%0A%20%20%20%20def%20self.followed_by(user)%0A%20%20%20%20%20%20followed_ids%20=%20user.following.map(%26:id).join(%22,%20%22)%0A%20%20%20%20%20%20where(%22user_id%20IN%20(%23%7Bfollowed_ids%7D)%20OR%20user_id%20=%20:user_id%22,%0A%20%20%20%20%20%20%20%20%20%20%20%20%7B%20:user_id%20=%3E%20user%20%7D)%0A%20%20%20%20end%0Aend%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">default_scope</span> <span class="ss">:order</span> <span class="o">=&gt;</span> <span class="s1">&#39;microposts.created_at DESC&#39;</span>

  <span class="c1"># Return microposts from the users being followed by the given user.</span>
  <span class="n">scope</span> <span class="ss">:from_users_followed_by</span><span class="p">,</span> <span class="nb">lambda</span> <span class="p">{</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="n">followed_by</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>

  <span class="kp">private</span>

    <span class="c1"># Return an SQL condition for users followed by the given user.</span>
    <span class="c1"># We include the user&#39;s own id as well.</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">followed_by</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
      <span class="n">followed_ids</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">following</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:id</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">)</span>
      <span class="n">where</span><span class="p">(</span><span class="s2">&quot;user_id IN (</span><span class="si">#{</span><span class="n">followed_ids</span><span class="si">}</span><span class="s2">) OR user_id = :user_id&quot;</span><span class="p">,</span>
            <span class="p">{</span> <span class="ss">:user_id</span> <span class="o">=&gt;</span> <span class="n">user</span> <span class="p">})</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>Since the conditions on the <code>from_users_followed_by</code> scope are rather long, we have defined an auxiliary function to handle it:</p>

<div class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">followed_by</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
  <span class="n">followed_ids</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">following</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:id</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">)</span>
  <span class="n">where</span><span class="p">(</span><span class="s2">&quot;user_id IN (</span><span class="si">#{</span><span class="n">followed_ids</span><span class="si">}</span><span class="s2">) OR user_id = :user_id&quot;</span><span class="p">,</span>
        <span class="p">{</span> <span class="ss">:user_id</span> <span class="o">=&gt;</span> <span class="n">user</span> <span class="p">})</span>
<span class="k">end</span>
</pre></div>
</div>


<p>As preparation for the next step, we have replaced</p>

<div class="code"><div class="highlight"><pre><span class="n">where</span><span class="p">(</span><span class="s2">&quot;... OR user_id = ?&quot;</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>
</pre></div>
</div>


<p>with the equivalent</p>

<div class="code"><div class="highlight"><pre><span class="n">where</span><span class="p">(</span><span class="s2">&quot;... OR user_id = :user_id&quot;</span><span class="p">,</span> <span class="p">{</span> <span class="ss">:user_id</span> <span class="o">=&gt;</span> <span class="n">user</span> <span class="p">})</span>
</pre></div>
</div>


<p>The question mark syntax is fine, but when we want the <em>same</em> variable inserted in more than one place, the second syntax, using a hash, is more convenient.</p>

<div class="label" id="sidebar:percent_paren"></div>


<div class="sidebar"><span class="title"><span class="header">Box 12.1.</span><span class="description">Percent paren</span></span>
<p>The code in this section uses the Ruby percent-parentheses construction, as in</p>

<pre class="verbatim">  %(SELECT followed_id FROM relationships
    WHERE follower_id = :user_id)</pre>


<p>You can think of <code>%()</code> as equivalent to double quotes, but capable of making multiline strings. (If you need a way to produce a multiline string without leading whitespace, do a Google search for &ldquo;<a href="http://www.google.com/q=ruby+here+document">ruby here document</a>&rdquo;.) Since <code>%()</code> supports string interpolation, it is particularly useful when you need to put double quotes in a string and interpolate at the same time. For example, the code</p>

<pre class="verbatim">  &gt;&gt; foo = &quot;bar&quot;
  &gt;&gt; puts %(The variable &quot;foo&quot; is equal to &quot;#{foo}&quot;.)</pre>


<p>produces</p>

<pre class="verbatim">  The variable &quot;foo&quot; is equal to &quot;bar&quot;.</pre>


<p>To get the same output with double-quoted strings, you would need to escape the internal double quotes with backslashes, as in</p>

<pre class="verbatim">  &gt;&gt; &quot;The variable \&quot;foo\&quot; is equal to \&quot;#{foo}\&quot;.&quot;</pre>


<p>In this case, the <code>%()</code> syntax is more convenient since is gets you the same result without the explicit escaping.</p>
</div>


<p>The above discussion implies that we will be adding a <em>second</em> occurrence of <code>user_id</code> in the SQL query, and indeed this is the case. We can replace the Ruby code</p>

<div class="code"><div class="highlight"><pre><span class="n">followed_ids</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">following</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:id</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="p">)</span>
</pre></div>
</div>


<p>with the SQL snippet</p>

<div class="code"><div class="highlight"><pre><span class="n">followed_ids</span> <span class="o">=</span> <span class="sx">%(SELECT followed_id FROM relationships</span>
<span class="sx">                 WHERE follower_id = :user_id)</span>
</pre></div>
</div>


<p>(See <a class="ref" href="following-users#sidebar:percent_paren">Box&nbsp;12.1</a> for an explanation of the <code>%()</code> syntax.) This code contains an SQL <em>subselect</em>, and internally the entire select for user&nbsp;1 would look something like this:</p>

<div class="code"><div class="highlight"><pre><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">microposts</span>
<span class="k">WHERE</span> <span class="n">user_id</span> <span class="k">IN</span> <span class="p">(</span><span class="k">SELECT</span> <span class="n">followed_id</span> <span class="k">FROM</span> <span class="n">relationships</span>
                  <span class="k">WHERE</span> <span class="n">follower_id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
      <span class="k">OR</span> <span class="n">user_id</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>
</div>


<p>This subselect arranges for all the set logic to be pushed into the database, which is more efficient.<sup class="footnote" id="fnref:12.21"><a href="#fn:12.21">21</a></sup></p>

<p>With this foundation, we are ready for the final feed implementation, as seen in <a class="ref" href="following-users#code:from_users_followed_by_final">extrait&nbsp;12.44</a>.</p>

<div class="label" id="code:from_users_followed_by_final"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 12.44.</span> <span class="description">The final implementation of <code>from_users_followed_by</code>. <br /> <code>app/models/micropost.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_178c3e137b3db85ca52b460d2b4aff523321ad42">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=class%20Micropost%20%3C%20ActiveRecord::Base%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20default_scope%20:order%20=%3E%20'microposts.created_at%20DESC'%0A%0A%20%20%23%20Return%20microposts%20from%20the%20users%20being%20followed%20by%20the%20given%20user.%0A%20%20scope%20:from_users_followed_by,%20lambda%20%7B%20%7Cuser%7C%20followed_by(user)%20%7D%0A%0A%20%20private%0A%0A%20%20%20%20%23%20Return%20an%20SQL%20condition%20for%20users%20followed%20by%20the%20given%20user.%0A%20%20%20%20%23%20We%20include%20the%20user's%20own%20id%20as%20well.%0A%20%20%20%20def%20self.followed_by(user)%0A%20%20%20%20%20%20followed_ids%20=%20%25(SELECT%20followed_id%20FROM%20relationships%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20WHERE%20follower_id%20=%20:user_id)%0A%20%20%20%20%20%20where(%22user_id%20IN%20(%23%7Bfollowed_ids%7D)%20OR%20user_id%20=%20:user_id%22,%0A%20%20%20%20%20%20%20%20%20%20%20%20%7B%20:user_id%20=%3E%20user%20%7D)%0A%20%20%20%20end%0Aend%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=class%20Micropost%20%3C%20ActiveRecord::Base%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20default_scope%20:order%20=%3E%20'microposts.created_at%20DESC'%0A%0A%20%20%23%20Return%20microposts%20from%20the%20users%20being%20followed%20by%20the%20given%20user.%0A%20%20scope%20:from_users_followed_by,%20lambda%20%7B%20%7Cuser%7C%20followed_by(user)%20%7D%0A%0A%20%20private%0A%0A%20%20%20%20%23%20Return%20an%20SQL%20condition%20for%20users%20followed%20by%20the%20given%20user.%0A%20%20%20%20%23%20We%20include%20the%20user's%20own%20id%20as%20well.%0A%20%20%20%20def%20self.followed_by(user)%0A%20%20%20%20%20%20followed_ids%20=%20%25(SELECT%20followed_id%20FROM%20relationships%0A%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20WHERE%20follower_id%20=%20:user_id)%0A%20%20%20%20%20%20where(%22user_id%20IN%20(%23%7Bfollowed_ids%7D)%20OR%20user_id%20=%20:user_id%22,%0A%20%20%20%20%20%20%20%20%20%20%20%20%7B%20:user_id%20=%3E%20user%20%7D)%0A%20%20%20%20end%0Aend%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Micropost</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="n">default_scope</span> <span class="ss">:order</span> <span class="o">=&gt;</span> <span class="s1">&#39;microposts.created_at DESC&#39;</span>

  <span class="c1"># Return microposts from the users being followed by the given user.</span>
  <span class="n">scope</span> <span class="ss">:from_users_followed_by</span><span class="p">,</span> <span class="nb">lambda</span> <span class="p">{</span> <span class="o">|</span><span class="n">user</span><span class="o">|</span> <span class="n">followed_by</span><span class="p">(</span><span class="n">user</span><span class="p">)</span> <span class="p">}</span>

  <span class="kp">private</span>

    <span class="c1"># Return an SQL condition for users followed by the given user.</span>
    <span class="c1"># We include the user&#39;s own id as well.</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">followed_by</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
      <span class="n">followed_ids</span> <span class="o">=</span> <span class="sx">%(SELECT followed_id FROM relationships</span>
<span class="sx">                       WHERE follower_id = :user_id)</span>
      <span class="n">where</span><span class="p">(</span><span class="s2">&quot;user_id IN (</span><span class="si">#{</span><span class="n">followed_ids</span><span class="si">}</span><span class="s2">) OR user_id = :user_id&quot;</span><span class="p">,</span>
            <span class="p">{</span> <span class="ss">:user_id</span> <span class="o">=&gt;</span> <span class="n">user</span> <span class="p">})</span>
    <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>


<p>This code has a formidable combination of Rails, Ruby, and SQL, but it does the job, and does it well.<sup class="footnote" id="fnref:12.22"><a href="#fn:12.22">22</a></sup></p>

<div class="label" id="sec:the_new_status_feed"></div>


<h3><a id="sec:12.3.4" href="following-users#sec:the_new_status_feed" class="heading"><span class="number">12.3.4</span> The new status feed</a></h3>


<p>With the code in <a class="ref" href="following-users#code:from_users_followed_by_final">extrait&nbsp;12.44</a>, our status feed is complete. As a reminder, the code for the Home page appears in <a class="ref" href="following-users#code:real_feed_instance_variable">extrait&nbsp;12.45</a>; this code creates a paginated feed of the relevant microposts for use in the view, as seen in <a class="ref" href="following-users#fig:home_page_with_feed">illustration&nbsp;12.20</a>.<sup class="footnote" id="fnref:12.23"><a href="#fn:12.23">23</a></sup> Note that the <code>paginate</code> method actually reaches all the way into the Micropost model method in <a class="ref" href="following-users#code:from_users_followed_by_final">extrait&nbsp;12.44</a>, arranging to pull out only&nbsp;30 microposts at a time from the database.<sup class="footnote" id="fnref:12.24"><a href="#fn:12.24">24</a></sup></p>

<div class="label" id="code:real_feed_instance_variable"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 12.45.</span> <span class="description">The <code>home</code> action with a paginated feed. <br /> <code>app/controllers/pages_controller.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_8d1bdabf45b53697c1faa48c0397eeebabea250c">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=class%20PagesController%20%3C%20ApplicationController%0A%0A%20%20def%20home%0A%20%20%20%20@title%20=%20%22Home%22%0A%20%20%20%20if%20signed_in?%0A%20%20%20%20%20%20@micropost%20=%20Micropost.new%0A%20%20%20%20%20%20@feed_items%20=%20current_user.feed.paginate(:page%20=%3E%20params[:page])%0A%20%20%20%20end%0A%20%20end%0A%20%20.%0A%20%20.%0A%20%20.%0Aend%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=class%20PagesController%20%3C%20ApplicationController%0A%0A%20%20def%20home%0A%20%20%20%20@title%20=%20%22Home%22%0A%20%20%20%20if%20signed_in?%0A%20%20%20%20%20%20@micropost%20=%20Micropost.new%0A%20%20%20%20%20%20@feed_items%20=%20current_user.feed.paginate(:page%20=%3E%20params[:page])%0A%20%20%20%20end%0A%20%20end%0A%20%20.%0A%20%20.%0A%20%20.%0Aend%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">PagesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">home</span>
    <span class="vi">@title</span> <span class="o">=</span> <span class="s2">&quot;Home&quot;</span>
    <span class="k">if</span> <span class="n">signed_in?</span>
      <span class="vi">@micropost</span> <span class="o">=</span> <span class="no">Micropost</span><span class="o">.</span><span class="n">new</span>
      <span class="vi">@feed_items</span> <span class="o">=</span> <span class="n">current_user</span><span class="o">.</span><span class="n">feed</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">:page</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="fig:home_page_with_feed"></div>


<div class="figure"><div class="center"><span class="graphic"><img src="/images/figures/home_page_with_feed.png" alt="home_page_with_feed" /></span></div><div class="caption"><span class="header">Illustration 12.20: </span><span class="description">The Home page with a working status feed.&nbsp;<a href="http://railstutorial.org/images/figures/home_page_with_feed-full.png">(taille normale)</a></span></div></div>




<div class="label" id="sec:following_conclusion"></div>


<h2><a id="sec:12.4" href="following-users#sec:following_conclusion" class="heading"><span class="number">12.4</span> Conclusion</a></h2>


<p>With the addition of the status feed, we&rsquo;ve finished the core sample application for <em>Ruby on Rails Tutorial</em>. This application includes examples of all the major features of Rails, including models, views, controllers, templates, partials, filters, validations, callbacks, <code>has_many</code>/<code>belongs_to</code> and <code>has_many :through</code> associations, security, testing, and deployment. Despite this impressive list, there is still much to learn about Rails. As a first step in this process, this section contains some suggested extensions to the core application, as well as suggestions for further learning.</p>

<p>Before moving on to tackle any of the application extensions, it&rsquo;s a good idea to merge in your changes and deploy the application:</p>

<div class="code"><div class="highlight"><pre><span class="gp">$</span> git add .
<span class="gp">$</span> git commit -m <span class="s2">&quot;Added user following&quot;</span>
<span class="gp">$</span> git checkout master
<span class="gp">$</span> git merge following-users
<span class="gp">$</span> git push heroku
<span class="gp">$</span> heroku rake db:migrate
</pre></div>
</div>


<p></p>

<div class="label" id="sec:extensions_to_the_sample_application"></div>


<h3><a id="sec:12.4.1" href="following-users#sec:extensions_to_the_sample_application" class="heading"><span class="number">12.4.1</span> Extensions to the sample application</a></h3>


<p>The proposed extensions in this section are mostly inspired either by general features common to web applications, such as password reminders and email confirmation, or features specific to our type of sample application, such as search, replies, and messaging. Implementing one or more of these application extensions will help you make the transition from following a tutorial to writing original applications of your own.</p>

<p>Don&rsquo;t be surprised if it&rsquo;s tough going at first; the blank slate of a new feature can be quite intimidating. To help get you started, I can give two pieces of general advice. First, before adding any feature to a Rails application, take a look at the <a href="http://railscasts.com/episodes/archive">Railscasts archive</a> to see if Ryan Bates has already covered the subject.<sup class="footnote" id="fnref:12.25"><a href="#fn:12.25">25</a></sup> If he has, watching the relevant Railscast first will often save you a ton of time. Second, always do extensive Google searches on your proposed feature to find relevant blog posts and tutorials. Web application development is hard, and it helps to learn from the experience (and mistakes) of others.</p>

<p>Many of the following features are quite challenging, and I have given some hints about the tools you might need to implement them. Even with hints, they are <em>much</em> more difficult than the book&rsquo;s end-of-chapter exercises, so don&rsquo;t be discouraged if you can&rsquo;t solve them without considerable effort. Due to time constraints, I am not available for one-on-one assistance, but if there is sufficient interest I might release standalone article/screencast bundles on some of these extensions in the future; go to the main Rails Tutorial website at <a href="http://railstutorial.org/">http://www.railstutorial.org/</a> and subscribe to the news feed to get the latest updates.</p>

<div class="label" id="sec:replies"></div>


<h4><a id="sec:12.4.1.1" href="following-users#sec:replies" class="heading">Replies</a></h4>


<p>Twitter allows users to make &ldquo;@replies&rdquo;, which are microposts whose first characters are the user&rsquo;s login preceded by the <tt>@</tt>&nbsp;sign. These posts only appear in the feed of the user in question or users following that user. Implement a simplified version of this, restricting @replies to appear only in the feeds of the recipient and the sender. This might involve adding an <code>in_reply_to</code> column in the <code>microposts</code> table and an extra <code>including_replies</code> scope to the Micropost model.</p>

<p>Since our application lacks unique user logins, you will also have to decide on a way to represent users. One option is to use a combination of the id and the name, such as <code>@1-michael-hartl</code>. Another is to <em>add</em> a unique username to the signup process and then use it in @replies.</p>

<div class="label" id="sec:messaging"></div>


<h4><a id="sec:12.4.1.2" href="following-users#sec:messaging" class="heading">Messaging</a></h4>


<p>Twitter supports direct (private) messaging by prefixing a micropost with the letter&nbsp;&ldquo;d&rdquo;. Implement this feature for the sample application. The solution will probably involve a Message model and a regular expression match on new microposts.</p>

<div class="label" id="sec:follower_notifications"></div>


<h4><a id="sec:12.4.1.3" href="following-users#sec:follower_notifications" class="heading">Follower notifications</a></h4>


<p>Implement a feature to send each user an email notification when they gain a new follower. Then make the notification optional, so that users can opt out if desired.</p>

<p>Among other things, adding this feature requires learning how to send mail with Rails. There is a <a href="http://railscasts.com/episodes/61-sending-email">Railscast on sending email</a> to get you started. Beware that the main Rails library for sending email, Action Mailer, has gotten a major overhaul in Rails&nbsp;3, as seen in the <a href="http://railscasts.com/episodes/206-action-mailer-in-rails-3">Railscast on Action Mailer in Rails&nbsp;3</a>.</p>

<div class="label" id="sec:password_reminders"></div>


<h4><a id="sec:12.4.1.4" href="following-users#sec:password_reminders" class="heading">Password reminders</a></h4>


<p>Currently, if our application&rsquo;s users forget their passwords, they have no way to retrieve them. Because of the one-way secure password hashing in <a class="ref" href="modeling-and-viewing-users-two#top">Chapter&nbsp;7</a>, our application can&rsquo;t email the user&rsquo;s password, but it can send a link to a reset form. Introduce a <code>PasswordReminders</code> resource to implement this feature. For each reset, you should create a unique token and email it to the user. Visiting a URL with the token should then allow them to reset their password to a value of their choice.</p>

<div class="label" id="sec:signup_confirmation"></div>


<h4><a id="sec:12.4.1.5" href="following-users#sec:signup_confirmation" class="heading">Signup confirmation</a></h4>


<p>Apart from an email regular expression, the sample application currently has no way to verify the validity of a user&rsquo;s email address. Add an email address verification step to confirm a user&rsquo;s signup. The new feature should create users in an inactive state, email the user an activation URL, and then change the user to an active state when the URL gets hit. You might want to read up on <a href="http://www.google.com/search?q=state+machines+in+rails">state machines in Rails</a> to help you with the inactive/active transition.</p>

<div class="label" id="sec:rss_feed"></div>


<h4><a id="sec:12.4.1.6" href="following-users#sec:rss_feed" class="heading">RSS feed</a></h4>


<p>For each user, implement an RSS feed for their microposts. Then implement an RSS feed for their status feed, optionally restricting access to that feed using an authentication scheme. The <a href="http://railscasts.com/episodes/87-generating-rss-feeds">Railscast on generating RSS feeds</a> will help get you started.</p>

<div class="label" id="sec:rest_api"></div>


<h4><a id="sec:12.4.1.7" href="following-users#sec:rest_api" class="heading">REST API</a></h4>


<p>Many web sites expose an Application Programmer Interface (API) so that third-party applications can get, post, put, and delete the application&rsquo;s resources. Implement such a REST API for the sample application. The solution will involve adding <code>respond_to</code> blocks (<a class="ref" href="following-users#sec:a_working_follow_button_with_ajax">section&nbsp;12.2.5</a>) to many of the application&rsquo;s controller actions; these should respond to requests for XML. Be careful about security; the API should only be accessible to authorized users.</p>

<div class="label" id="sec:search"></div>


<h4><a id="sec:12.4.1.8" href="following-users#sec:search" class="heading">Search</a></h4>


<p>Currently, there is no way for users to find each other than paging through the user index or viewing the feeds of other users. Implement a search feature to remedy this. Then add another search feature for microposts. The <a href="http://railscasts.com/episodes/37-simple-search-form">Railscast on simple search forms</a> will help get you started. If you deploy using a shared host or a dedicated server, I suggest using <a href="http://freelancing-god.github.com/ts/en/">Thinking Sphinx</a> (following the <a href="http://railscasts.com/episodes/120-thinking-sphinx">Railscast on Thinking Sphinx</a>). If you deploy on Heroku, you should follow the <a href="http://docs.heroku.com/full-text-search">Heroku full text search</a> instructions.</p>

<div class="label" id="sec:guide_to_further_resources"></div>


<h3><a id="sec:12.4.2" href="following-users#sec:guide_to_further_resources" class="heading"><span class="number">12.4.2</span> Guide to further resources</a></h3>


<p>There are a wealth of Rails resources in stores and on the web&mdash;indeed, the supply is so rich that it can be overwhelming, and it can be hard to know where to start. By now you <em>know</em> where to start&mdash;with this book, of course. And if you&rsquo;ve gotten this far, you&rsquo;re ready for almost anything else out there. Here are some suggestions:</p>

<ul>
<li><a href="http://railstutorial.org/screencasts"><em>Ruby on Rails Tutorial</em> screencasts</a>: I have prepared a full-length screencast course based on this book. In addition to covering all the material in the book, the screencasts are be filled with tips, tricks, and the kind of see-how-it&rsquo;s-done demos that are hard to capture in print. They are available on the <a href="http://railstutorial.org/">Ruby on Rails Tutorial website</a>, through <a href="http://my.safaribooksonline.com/">Safari Books Online</a>, and through <a href="http://www.informit.com/index.aspx">InformIT</a>.</li>

<li><a href="http://railscasts.com/">Railscasts</a>: It&rsquo;s hard to overemphasize what a great resource the Railscasts are. I suggest starting by visiting the <a href="http://railscasts.com/episodes/archive">Railscasts episode archive</a> and clicking on subjects that catch your eye.</li>

<li><a href="http://railslab.newrelic.com/scaling-rails">Scaling Rails</a>: One topic we&rsquo;ve hardly covered in the <em>Ruby on Rails Tutorial</em> book is performance, optimization, and scaling. Luckily, most sites will never run into serious scaling issues, and using anything beyond plain Rails is probably premature optimization. If you do run into performance issues, the <a href="http://railslab.newrelic.com/scaling-rails">Scaling Rails</a> series from Gregg Pollack of <a href="http://envylabs.com/">Envy Labs</a> is a great place to start. I also recommend investigating the site monitoring applications <a href="http://scoutapp.com/">Scout</a> and <a href="http://www.newrelic.com/">New Relic</a>.<sup class="footnote" id="fnref:12.26"><a href="#fn:12.26">26</a></sup> And, as you might suspect by now, there are Railscasts on many scaling subjects, including profiling, caching, and background jobs.</li>

<li>Ruby and Rails books: As mentioned in <a class="ref" href="beginning#top">Chapter&nbsp;1</a>, I recommend <a href="http://www.amazon.com/gp/product/1430223634?ie=UTF8&amp;tag=httpwwwrailst-20&amp;linkCode=as2&amp;camp=1789&amp;creative=9325&amp;creativeASIN=1430223634"><em>Beginning Ruby</em></a> by Peter Cooper, <a href="http://www.amazon.com/gp/product/1933988657?ie=UTF8&amp;tag=httpwwwrailst-20&amp;linkCode=as2&amp;camp=1789&amp;creative=9325&amp;creativeASIN=1933988657"><em>The Well-Grounded Rubyist</em></a> by David&nbsp;A. Black, and <a href="http://www.amazon.com/gp/product/B000P28V8Q?ie=UTF8&amp;tag=httpwwwrailst-20&amp;linkCode=as2&amp;camp=1789&amp;creative=9325&amp;creativeASIN=B000P28V8Q"><em>The Ruby Way</em></a> by Hal Fulton for further Ruby learning, and <a href="http://www.amazon.com/gp/product/0321601661?ie=UTF8&amp;tag=httpwwwrailst-20&amp;linkCode=as2&amp;camp=1789&amp;creative=390957&amp;creativeASIN=0321601661"><em>The Rails&nbsp;3 Way</em></a> by Obie Fernandez for more about Rails.</li>

<li><a href="http://peepcode.com/">PeepCode</a>: I mentioned several commercial screencasters in <a class="ref" href="beginning#top">Chapter&nbsp;1</a>, but the only one I have extensive experience with is PeepCode. The screencasts at PeepCode are consistently high-quality, and I warmly recommend them.</li>

</ul>




<div class="label" id="sec:following_exercises"></div>


<h2><a id="sec:12.5" href="following-users#sec:following_exercises" class="heading"><span class="number">12.5</span> Exercises</a></h2>




<ol>
<li>Add tests for <code>dependent :destroy</code> in the Relationship model (<a class="ref" href="following-users#code:user_relationships_association">extrait&nbsp;12.5</a> and <a class="ref" href="following-users#code:user_reverse_relationships">extrait&nbsp;12.17</a>) by following the example in <a class="ref" href="user-microposts#code:micropost_dependency_test">extrait&nbsp;11.11</a>.</li>
<li>The <code>respond_to</code> method seen in <a class="ref" href="following-users#code:relationships_controller_ajax">extrait&nbsp;12.36</a> can actually be hoisted out of the actions into the Relationships controller itself, and the <code>respond_to</code> blocks can be replaced with a Rails method called <code>respond_with</code>. Prove that the resulting code, shown in <a class="ref" href="following-users#code:compact_respond_to">extrait&nbsp;12.46</a>, is correct by verifying that the test suite still passes. (For details on this method, do a Google search on &ldquo;rails respond_with&rdquo;.)</li>
<li>The <code>following</code> and <code>followers</code> actions in <a class="ref" href="following-users#code:following_followers_actions">extrait&nbsp;12.29</a> still have considerable duplication. Verify that the <code>show_follow</code> method in <a class="ref" href="following-users#code:following_followers_actions_refactored">extrait&nbsp;12.47</a> eliminates this duplication. (See if you can infer what the <code>send</code> method does, as in, e.g., <code>@user.send(:following)</code>.)</li>
<li>Refactor <a class="ref" href="following-users#code:show_follow_view">extrait&nbsp;12.30</a> by adding partials for the code common to the following/followers pages, the Home page, and the user show page.</li>
<li>Following the model in <a class="ref" href="following-users#code:stats_view_test">extrait&nbsp;12.20</a>, write tests for the stats on the profile page.</li>
<li>Write an integration test for following and unfollowing a user.</li>
<li>Rewrite the Ajax methods from <a class="ref" href="following-users#sec:a_working_follow_button_with_ajax">section&nbsp;12.2.5</a> using <a href="http://jquery.com/">jQuery</a> in place of Prototype. <em>Hint:</em> You might want to read the jQuery section of  <a href="http://lindsaar.net/2010/5/9/Getting-Rails-3-Edge-with-jQuery-RSpec-and-Cucumber-using-RVM">Mikel Lindsaar&rsquo;s blog post about jQuery, RSpec, and Rails&nbsp;3</a>.</li>
</ol>




<div class="label" id="code:compact_respond_to"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 12.46.</span> <span class="description">A compact refactoring of <a class="ref" href="following-users#code:relationships_controller_ajax">extrait&nbsp;12.36</a>.</span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_b7763f334828a2c00ccb7b7529383a9d624e8ef7">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=class%20RelationshipsController%20%3C%20ApplicationController%0A%20%20before_filter%20:authenticate%0A%20%20%0A%20%20respond_to%20:html,%20:js%0A%0A%20%20def%20create%0A%20%20%20%20@user%20=%20User.find(params[:relationship][:followed_id])%0A%20%20%20%20current_user.follow!(@user)%0A%20%20%20%20respond_with%20@user%0A%20%20end%0A%0A%20%20def%20destroy%0A%20%20%20%20@user%20=%20Relationship.find(params[:id]).followed%0A%20%20%20%20current_user.unfollow!(@user)%0A%20%20%20%20respond_with%20@user%0A%20%20end%0Aend%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=class%20RelationshipsController%20%3C%20ApplicationController%0A%20%20before_filter%20:authenticate%0A%20%20%0A%20%20respond_to%20:html,%20:js%0A%0A%20%20def%20create%0A%20%20%20%20@user%20=%20User.find(params[:relationship][:followed_id])%0A%20%20%20%20current_user.follow!(@user)%0A%20%20%20%20respond_with%20@user%0A%20%20end%0A%0A%20%20def%20destroy%0A%20%20%20%20@user%20=%20Relationship.find(params[:id]).followed%0A%20%20%20%20current_user.unfollow!(@user)%0A%20%20%20%20respond_with%20@user%0A%20%20end%0Aend%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">RelationshipsController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="n">before_filter</span> <span class="ss">:authenticate</span>

  <span class="n">respond_to</span> <span class="ss">:html</span><span class="p">,</span> <span class="ss">:js</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:relationship</span><span class="o">][</span><span class="ss">:followed_id</span><span class="o">]</span><span class="p">)</span>
    <span class="n">current_user</span><span class="o">.</span><span class="n">follow!</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="n">respond_with</span> <span class="vi">@user</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">destroy</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">Relationship</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">followed</span>
    <span class="n">current_user</span><span class="o">.</span><span class="n">unfollow!</span><span class="p">(</span><span class="vi">@user</span><span class="p">)</span>
    <span class="n">respond_with</span> <span class="vi">@user</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div></div>




<div class="label" id="code:following_followers_actions_refactored"></div>


<div class="codelisting">
<div class="listing"><span class="header">Extrait 12.47.</span> <span class="description">Refactored <code>following</code> and <code>followers</code> actions. <br /> <code>app/controllers/users_controller.rb</code></span>       <object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000"
              width="110"
              height="14"
              id="clippy_5da024334c5ed7016b270f424bbceb2a8b6230ea">
      <param name="movie" value="/flash/clippy.swf"/>
      <param name="allowScriptAccess" value="always" />
      <param name="quality" value="high" />
      <param name="scale" value="noscale" />
      <param name="FlashVars" value="text=class%20UsersController%20%3C%20ApplicationController%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20def%20following%0A%20%20%20%20show_follow(:following)%0A%20%20end%0A%0A%20%20def%20followers%0A%20%20%20%20show_follow(:followers)%0A%20%20end%0A%20%20%0A%20%20def%20show_follow(action)%0A%20%20%20%20@title%20=%20action.to_s.capitalize%0A%20%20%20%20@user%20=%20User.find(params[:id])%0A%20%20%20%20@users%20=%20@user.send(action).paginate(:page%20=%3E%20params[:page])%0A%20%20%20%20render%20'show_follow'%0A%20%20end%0A%20%20.%0A%20%20.%0A%20%20.%0Aend%0A" />
      <param name="bgcolor" value="#ffffff" />
      <embed src="/flash/clippy.swf"
             width="110"
             height="14"
             name="clippy"
             quality="high"
             allowScriptAccess="always"
             type="application/x-shockwave-flash"
             pluginspage="http://www.macromedia.com/go/getflashplayer"
             FlashVars="text=class%20UsersController%20%3C%20ApplicationController%0A%20%20.%0A%20%20.%0A%20%20.%0A%20%20def%20following%0A%20%20%20%20show_follow(:following)%0A%20%20end%0A%0A%20%20def%20followers%0A%20%20%20%20show_follow(:followers)%0A%20%20end%0A%20%20%0A%20%20def%20show_follow(action)%0A%20%20%20%20@title%20=%20action.to_s.capitalize%0A%20%20%20%20@user%20=%20User.find(params[:id])%0A%20%20%20%20@users%20=%20@user.send(action).paginate(:page%20=%3E%20params[:page])%0A%20%20%20%20render%20'show_follow'%0A%20%20end%0A%20%20.%0A%20%20.%0A%20%20.%0Aend%0A"
             bgcolor="#ffffff"
      />
      </object>
</div>
<div class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="k">def</span> <span class="nf">following</span>
    <span class="n">show_follow</span><span class="p">(</span><span class="ss">:following</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">followers</span>
    <span class="n">show_follow</span><span class="p">(</span><span class="ss">:followers</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">show_follow</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
    <span class="vi">@title</span> <span class="o">=</span> <span class="n">action</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">capitalize</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
    <span class="vi">@users</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">action</span><span class="p">)</span><span class="o">.</span><span class="n">paginate</span><span class="p">(</span><span class="ss">:page</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="ss">:page</span><span class="o">]</span><span class="p">)</span>
    <span class="n">render</span> <span class="s1">&#39;show_follow&#39;</span>
  <span class="k">end</span>
  <span class="o">.</span>
  <span class="o">.</span>
  <span class="o">.</span>
<span class="k">end</span>
</pre></div>
</div></div>


<div class="navigation">  <a class="prev_page" href="user-microposts#top">
    &laquo;&nbsp;<span class="number">Chapter 11</span> User microposts
  </a>
</div><div class="footnotes">
<ol>
<li id="fn:12.1">The photographs in the mockup tour are from <a href="http://www.flickr.com/photos/john_lustig/2518452221/">http://www.flickr.com/photos/john_lustig/2518452221/</a> and <a href="http://www.flickr.com/photos/30775272@N05/2884963755/">http://www.flickr.com/photos/30775272@N05/2884963755/</a>.&nbsp;<a class="arrow" href="#fnref:12.1">&uarr;</a></li>
<li id="fn:12.2">For simplicity, <a class="ref" href="following-users#fig:naive_user_has_many_following">illustration&nbsp;12.6</a> suppresses the <code>following</code> table&rsquo;s&nbsp;<code>id</code> column.&nbsp;<a class="arrow" href="#fnref:12.2">&uarr;</a></li>
<li id="fn:12.3">Unfortunately, Rails uses <code>connection</code> for a database connection, so introducing a Connection model leads to some rather subtle bugs. (I learned this the hard way when developing <a href="http://www.insoshi.com/">Insoshi</a>.)&nbsp;<a class="arrow" href="#fnref:12.3">&uarr;</a></li>
<li id="fn:12.4">Indeed, this construction is so characteristic of Rails that well-knows Rails programmer Josh Susser used it as the <a href="http://blog.hasmanythrough.com/">name of his geek blog</a>.&nbsp;<a class="arrow" href="#fnref:12.4">&uarr;</a></li>
<li id="fn:12.5">Technically, Rails uses the <code>underscore</code> method to convert the class name to an id. For example, <code>"FooBar".underscore</code> is <code>foo_bar</code>, so the foreign key for a <code>FooBar</code> object would be <code>foo_bar_id</code>. (Incidentally, the inverse of <code>underscore</code> is <code>camelize</code>, which converts <code>camel_case</code> to <code>CamelCase</code>.)&nbsp;<a class="arrow" href="#fnref:12.5">&uarr;</a></li>
<li id="fn:12.6">If you&rsquo;ve noticed that <code>followed_id</code> also identifies a user, and are concerned about the asymmetric treatment of followed and follower, you&rsquo;re ahead of the game. We&rsquo;ll deal with this issue in <a class="ref" href="following-users#sec:followers">section&nbsp;12.1.5</a>.&nbsp;<a class="arrow" href="#fnref:12.6">&uarr;</a></li>
<li id="fn:12.7">Cette méthode <code>follow!</code> devrait toujours fonctionner, donc (en suivant le modèle de <code>create!</code> et <code>save!</code>) nous indiquons avec l'exclamation qu'une exception (une erreur) sera déclenchée en cas d'échec.&nbsp;<a class="arrow" href="#fnref:12.7">&uarr;</a></li>
<li id="fn:12.8">Une fois que vous aurez une grande expérience de la modélisation d'un domaine particulier, vous pourrez souvent deviner de telle méthode utilitaires à l'avance, et même quand vous ne pourrez pas vous trouvez souvent de vous-même que les écrire rend les tests plus clairs. Dans le cas présent, cependant, c'est OK si vous ne les aviez pas anticipées. Le développement de logiciel est souvent un processus itératif &mdash;&nbsp;vous écrivez du code jusqu'à ce qu'il s'enlaidisse, et alors vous le restructurez&nbsp;&mdash; mais pour la brièveté la présentation du tutoriel est un peu simplifié.&nbsp;<a class="arrow" href="#fnref:12.8">&uarr;</a></li>
<li id="fn:12.9">La méthode <code>authenticate_with_salt</code> est incluse simplement en vous orientant à l'intérieur du fichier du modèle User.&nbsp;<a class="arrow" href="#fnref:12.9">&uarr;</a></li>
<li id="fn:12.10">La méthode <code>unfollow!</code> ne provoque pas d'erreur à l'échec &mdash;&nbsp;en fait, je ne sais même pas comment Rails indique un échec de destruction&nbsp;&mdash; mais nous utilisons un point d'exclamation pour maintenant la symétrie <code>follow!</code>/<code>unfollow!</code>.&nbsp;<a class="arrow" href="#fnref:12.10">&uarr;</a></li>
<li id="fn:12.11">Vous pouvez avoir noté que quelquefois nous accédons à <code>id</code> explicitement, comme dans <code>followed.id</code> et d'autrefois nous utilisons juste <code>followed</code>. J'ai honte d'admettre que mon algorithme habituel pour dire quand savoir lequel utiliser consiste simplement à voir si ça marche sans <code>id</code> et alors de l'ajouter si ça ne fonctionne pas.&nbsp;<a class="arrow" href="#fnref:12.11">&uarr;</a></li>
<li id="fn:12.12">Everything in <a class="ref" href="following-users#code:following_followers_tests">extrait&nbsp;12.28</a> has been covered elsewhere in this tutorial, so this is a good exercise in reading code.&nbsp;<a class="arrow" href="#fnref:12.12">&uarr;</a></li>
<li id="fn:12.13">Because it is nominally an acronym for <em>asynchronous JavaScript and XML</em>, Ajax is sometimes misspelled &ldquo;AJAX&rdquo;, even though the <a href="http://www.adaptivepath.com/ideas/essays/archives/000385.php">original Ajax article</a> spells it as &ldquo;Ajax&rdquo; throughout.&nbsp;<a class="arrow" href="#fnref:12.13">&uarr;</a></li>
<li id="fn:12.14">This only works if JavaScript is enabled in the browser, but it degrades gracefully, working exactly as in <a class="ref" href="following-users#sec:a_working_follow_button_the_standard_way">section&nbsp;12.2.4</a> if JavaScript is disabled.&nbsp;<a class="arrow" href="#fnref:12.14">&uarr;</a></li>
<li id="fn:12.15">At this point you will have to include the default <a href="http://www.prototypejs.org/">Prototype JavaScript Library</a> into your Rails application as in <a class="ref" href="updating-showing-and-deleting-users#code:adding_default_javascript">extrait&nbsp;10.39</a> if you have not done so already.&nbsp;<a class="arrow" href="#fnref:12.15">&uarr;</a></li>
<li id="fn:12.16">There is no relationship between this <code>respond_to</code> and the <code>respond_to</code> used in the RSpec examples.&nbsp;<a class="arrow" href="#fnref:12.16">&uarr;</a></li>
<li id="fn:12.17">The main requirement is that enumerable objects must implement an <code>each</code> method to iterate through the collection.&nbsp;<a class="arrow" href="#fnref:12.17">&uarr;</a></li>
<li id="fn:12.18">This notation actually started as an extension Rails made to the core Ruby language; it was so useful that it has now been incorporated into Ruby itself. How cool is that?&nbsp;<a class="arrow" href="#fnref:12.18">&uarr;</a></li>
<li id="fn:12.19">Calling <code>paginate</code> on an <code>Array</code> object converts it into a <code>WillPaginate::Collection</code> object, but that doesn&rsquo;t help us much since the entire array has already been created in memory.&nbsp;<a class="arrow" href="#fnref:12.19">&uarr;</a></li>
<li id="fn:12.20">A function bundled with a piece of data (a user, in this case) is known as a <em>closure</em>, which we encountered briefly in the discussion of blocks in <a class="ref" href="rails-flavored-ruby#sec:blocks">section&nbsp;4.3.2</a>.&nbsp;<a class="arrow" href="#fnref:12.20">&uarr;</a></li>
<li id="fn:12.21">For a more advanced way to create the necessary subselect, see the blog post <a href="http://pivotallabs.com/users/jsusser/blog/articles/567-hacking-a-subselect-in-activerecord">&ldquo;Hacking a subselect in ActiveRecord&rdquo;.</a>&nbsp;<a class="arrow" href="#fnref:12.21">&uarr;</a></li>
<li id="fn:12.22">Of course, even the subselect won&rsquo;t scale forever. For bigger sites, you would probably need to generate the feed asynchronously using a background job. Such scaling subtleties are beyond the scope of this tutorial, but the <a href="http://railslab.newrelic.com/scaling-rails">Scaling Rails</a> screencasts are a good place to start.&nbsp;<a class="arrow" href="#fnref:12.22">&uarr;</a></li>
<li id="fn:12.23">In order make a prettier feed for <a class="ref" href="following-users#fig:home_page_with_feed">illustration&nbsp;12.20</a>, I&rsquo;ve added a few extra microposts by hand using the Rails console.&nbsp;<a class="arrow" href="#fnref:12.23">&uarr;</a></li>
<li id="fn:12.24">You can verify this by examining the SQL statements in the development server log file. (The <a href="http://railstutorial.org/screencasts">Rails Tutorial screencasts</a> will cover such subtleties in more depth.)&nbsp;<a class="arrow" href="#fnref:12.24">&uarr;</a></li>
<li id="fn:12.25">My only reservation about Railscasts is that they often omit the tests. This is probably necessary to keep the episodes nice and short, but you could get the wrong idea about the importance of tests. Once you&rsquo;ve watched the relevant Railscast to get a basic idea of how to proceed, I suggest writing the new feature using test-driven development.&nbsp;<a class="arrow" href="#fnref:12.25">&uarr;</a></li>
<li id="fn:12.26">In addition to being a clever phrase&mdash;<em>new relic</em> being a contradiction in terms&mdash;New Relic is also an anagram for the name of the company&rsquo;s founder, Lew Cirne.&nbsp;<a class="arrow" href="#fnref:12.26">&uarr;</a></li>
</ol>
</div>

